<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Produzione EXTRA • General Copper</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
:root {
  --bg0:#05060a; --bg1:#070b12;
  --panel:rgba(10,14,24,.92);
  --line:rgba(120,255,255,.25);
  --text:#eaf7ff;
  --muted:rgba(200,230,255,.75);

  --accent:#ff9a3d;
  --accent2:#ff2bd6;

  --green:#2bff88;
  --yellow:#ffe66d;
  --red:#ff4d6d;
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto}
body{
  background:
    radial-gradient(1200px 900px at 10% 10%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 60%),
    radial-gradient(1200px 900px at 85% 15%, color-mix(in srgb, var(--accent2) 14%, transparent), transparent 60%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
}
body:before{
  content:"";
  position:fixed; inset:0;
  background:repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,.015),
    rgba(255,255,255,.015) 1px,
    transparent 1px,
    transparent 6px
  );
  pointer-events:none;
}

.wrap{padding:12px;display:flex;flex-direction:column;gap:12px}

.card{
  background:var(--panel);
  border:1px solid color-mix(in srgb, var(--accent) 28%, var(--line));
  border-radius:18px;
  padding:14px;
  box-shadow:0 0 30px rgba(0,0,0,.5),0 0 36px color-mix(in srgb, var(--accent) 22%, transparent);
}

.header{position:relative;overflow:hidden}
.header:before{
  content:""; position:absolute; inset:-2px;
  background:linear-gradient(90deg,
    transparent,
    color-mix(in srgb, var(--accent) 35%, transparent),
    color-mix(in srgb, var(--accent2) 25%, transparent),
    transparent);
  filter:blur(10px);
  opacity:.55;
  transform:translateX(-60%);
  animation:sweep 6.8s linear infinite;
}
@keyframes sweep{0%{transform:translateX(-60%)}100%{transform:translateX(60%)}}

.title{font-size:26px;font-weight:950;letter-spacing:1px;text-transform:uppercase;position:relative}
.brand{margin-top:4px;font-size:13px;font-weight:850;color:var(--muted);position:relative}

.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;position:relative}
.chip{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  font-size:11px;font-weight:950;letter-spacing:.8px;text-transform:uppercase;
}
.dot{width:9px;height:9px;border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 0 6px color-mix(in srgb, var(--accent) 20%, transparent);
  animation:pulse 1.6s ease-in-out infinite;
}
@keyframes pulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.45)}}

.infoGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}

.big{font-size:34px;font-weight:950;line-height:1; font-variant-numeric:tabular-nums}
.label{font-size:11px;font-weight:850;color:var(--muted);margin-top:4px;text-transform:capitalize}

.weather{font-size:30px;font-weight:950}
.weatherDesc{font-size:14px;font-weight:850;color:var(--muted)}

table{width:100%;border-collapse:collapse;margin-top:6px}
th{text-align:left;font-size:11px;font-weight:950;color:var(--muted);padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.12)}
td{padding:10px 6px;font-size:15px;font-weight:850;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
.prod{font-weight:950}
.fmt{color:rgba(200,230,255,.75);font-size:12px;font-weight:800;margin-top:2px}

.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:950;letter-spacing:.5px;text-transform:uppercase}
.todo{background:color-mix(in srgb, var(--accent) 18%, transparent);color:var(--accent)}
.done{background:rgba(43,255,136,.15);color:var(--green)}
.warn{background:rgba(255,230,109,.18);color:var(--yellow)}
.err{background:rgba(255,77,109,.18);color:var(--red)}

.footer{font-size:10px;color:rgba(200,230,255,.45);text-align:right}
</style>

<script>
if(sessionStorage.getItem("admin_auth")!=="ok") {
  location.href="../login/";
}
</script>
</head>

<body>
<div class="wrap">

  <div class="card header">
    <div class="title">PRODUZIONE EXTRA</div>
    <div class="brand">General Copper • Live</div>
    <div class="chips">
      <span class="chip"><span class="dot"></span>online</span>
      <span class="chip">agg. 20s</span>
      <span class="chip">build 20251217-004427</span>
    </div>
  </div>

  <div class="infoGrid">
    <div class="card">
      <div class="big" id="timeIT">--:--</div>
      <div class="label" id="dateIT">—</div>
    </div>

    <div class="card">
      <div class="weather" id="temp">--°</div>
      <div class="weatherDesc" id="wdesc">Caricamento meteo…</div>
    </div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:46%">Prodotto</th>
          <th style="width:16%">Q.tà</th>
          <th style="width:22%">Formato</th>
          <th style="width:16%">Stato</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4">Caricamento dati…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">General Copper • EXTRA • build 20251217-004427</div>

</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBSnjrkW_1nOXTTUkS9ljOEABwUdSxg28pS94LAEDAdXrqVJ3NwJGXKkueFFIlGED-0NFMjofMRPt/pub?output=csv";
const REFRESH = 20000;

function tickClock(){
  const n = new Date();
  document.getElementById("timeIT").textContent =
    new Intl.DateTimeFormat("it-IT",{hour:"2-digit",minute:"2-digit"}).format(n);
  document.getElementById("dateIT").textContent =
    new Intl.DateTimeFormat("it-IT",{weekday:"long",day:"2-digit",month:"long"}).format(n);
}

function parseCSV(text){
  text = text.replace(/\r/g,"");
  const rows = [];
  let cur="", row=[], inQ=false;
  for(let i=0;i<text.length;i++) {
    const ch=text[i];
    if(ch === '"') {
      if(inQ && text[i+1] === '"') { cur+='"'; i++; }
      else inQ=!inQ;
    } else if(ch === ',' && !inQ) {
      row.push(cur); cur="";
    } else if(ch === '\n' && !inQ) {
      row.push(cur); rows.push(row); row=[]; cur="";
    } else {
      cur+=ch;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

function esc(s){return String(s??"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]))}

function statusClass(s){
  const t=(s||"").toLowerCase();
  if(!t) return "todo";
  if(t.includes("ok")||t.includes("fatt")||t.includes("done")||t.includes("compl")) return "done";
  if(t.includes("att")||t.includes("wait")||t.includes("hold")) return "warn";
  if(t.includes("err")||t.includes("stop")||t.includes("blocc")) return "err";
  if(t.includes("da")) return "todo";
  return "todo";
}

async function loadCSV(){
  const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("CSV HTTP " + res.status);
  const text = await res.text();
  const rows = parseCSV(text).filter(r => r.some(v => (v||"").trim() !== ""));
  const body = document.getElementById("tbody");
  body.innerHTML="";

  if(rows.length <= 1) {
    body.innerHTML = "<tr><td colspan='4'>Nessun dato.</td></tr>";
    return;
  }

  for(const r of rows.slice(1)) {
    const prodotto = (r[0]||"").trim();
    if(!prodotto) continue;

    const qty = (r[1]||"").trim();
    const formato = (r[3]||"").trim();
    const stato = (r[4]||"").trim();

    const cls = statusClass(stato);
    body.innerHTML += `
      <tr>
        <td><div class="prod">${esc(prodotto)}</div></td>
        <td>${esc(qty)}</td>
        <td><div class="fmt">${esc(formato)}</div></td>
        <td><span class="badge ${cls}">${esc(stato || "DA PRODURRE")}</span></td>
      </tr>`;
  }
}

const WCODE = {
  0:"Sereno", 1:"Preval. sereno", 2:"Parz. nuvoloso", 3:"Nuvoloso",
  45:"Nebbia", 48:"Brina/nebbia",
  51:"Pioviggine", 53:"Pioviggine", 55:"Pioviggine",
  61:"Pioggia", 63:"Pioggia", 65:"Pioggia forte",
  71:"Neve", 73:"Neve", 75:"Neve forte",
  80:"Rovesci", 81:"Rovesci", 82:"Rovesci forti",
  95:"Temporale", 96:"Temporale", 99:"Temporale"
};
function wdesc(code){ return WCODE[code] || ("Meteo " + code); }

async function loadWeather(){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=45.1895&longitude=11.2139&current=temperature_2m,weather_code&timezone=Europe/Rome&t=${Date.now()}`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("Meteo HTTP " + res.status);
  const j = await res.json();
  document.getElementById("temp").textContent = (j.current?.temperature_2m ?? "--") + "°";
  document.getElementById("wdesc").textContent = "Cerea (VR) • " + wdesc(j.current?.weather_code);
}

tickClock();
setInterval(tickClock, 1000);

loadCSV().catch(()=>{ document.getElementById("tbody").innerHTML="<tr><td colspan='4'>Errore lettura sheet.</td></tr>"; });
setInterval(()=>loadCSV().catch(()=>{}), REFRESH);

loadWeather().catch(()=>{ document.getElementById("wdesc").textContent="Meteo non disponibile"; });
setInterval(()=>loadWeather().catch(()=>{}), 600000);
</script>
</body>
</html>
