<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tabellone Produzione Live • Mobile</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg0:#05060a; --bg1:#070b12;
      --panel: rgba(10,14,24,.86);
      --line: rgba(120,255,255,.22);
      --text:#eaf7ff;
      --neonCyan:#35f2ff; --neonMag:#ff2bd6; --neonYel:#ffe66d;
      --todo:#35f2ff; --done:#2bff88;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      background:
        radial-gradient(1100px 900px at 10% 10%, rgba(53,242,255,.10), transparent 55%),
        radial-gradient(1100px 900px at 85% 15%, rgba(255,43,214,.08), transparent 55%),
        radial-gradient(900px 700px at 70% 90%, rgba(255,230,109,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow:auto;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(to bottom,
        rgba(255,255,255,.016), rgba(255,255,255,.016) 1px,
        transparent 1px, transparent 7px);
      opacity:.16; pointer-events:none; mix-blend-mode:overlay;
      z-index:1;
    }

    .wrap{min-height:100%;display:flex;flex-direction:column;padding:12px;gap:12px;position:relative;z-index:2;}
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow:
        0 0 0 1px rgba(53,242,255,0.10),
        0 14px 34px rgba(0,0,0,0.50),
        0 0 46px rgba(53,242,255,0.05),
        0 0 56px rgba(255,43,214,0.03);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }

    .top{display:flex;flex-direction:column;gap:12px}
    .titleCard{padding:14px 14px 12px; position:relative; overflow:hidden}
    .titleCard:before{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(53,242,255,0.00), rgba(53,242,255,0.18), rgba(255,43,214,0.14), rgba(53,242,255,0.00));
      filter: blur(9px); opacity:0.52; transform: translate3d(-60%,0,0);
      animation: sweep 7.2s linear infinite; pointer-events:none; z-index:0; will-change: transform;
    }
    @keyframes sweep{0%{transform: translate3d(-60%,0,0)}100%{transform: translate3d(60%,0,0)}}

    .title{margin:0;font-size:28px;font-weight:950;letter-spacing:1px;text-transform:uppercase;position:relative;z-index:1;}
    .sub{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;position:relative;z-index:1;}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);font-weight:900;letter-spacing:0.6px;text-transform:uppercase;font-size:12px;}
    .chip.live{border-color:rgba(53,242,255,0.24);box-shadow:0 0 16px rgba(53,242,255,0.10)}
    .liveDot{width:9px;height:9px;border-radius:999px;background:var(--neonCyan);
      box-shadow:0 0 0 6px rgba(53,242,255,0.12),0 0 18px rgba(53,242,255,0.18);
      animation:livePulse 1.6s ease-in-out infinite;}
    @keyframes livePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5)}}

    .infoRow{display:grid;grid-template-columns:1fr;gap:12px}
    .weatherCard{padding:12px}
    .wTitle{font-size:12px;font-weight:950;letter-spacing:1px;text-transform:uppercase;color:rgba(200,230,255,.78);display:flex;align-items:center;gap:8px}
    .wPulse{width:9px;height:9px;border-radius:999px;background:var(--neonMag);box-shadow:0 0 0 6px rgba(255,43,214,0.10);animation:livePulse 1.8s ease-in-out infinite;}
    .wMain{display:flex;align-items:flex-end;gap:12px;margin-top:8px}
    .wTemp{font-size:54px;font-weight:950;line-height:1;}
    .wDesc{font-size:16px;font-weight:900;color:rgba(200,230,255,.80);line-height:1.15}
    .wMeta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;color:rgba(200,230,255,.72);font-size:12px;font-weight:850}
    .wPill{border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);border-radius:999px;padding:6px 10px;}

    .clockCard{padding:12px}
    .dateBig{margin:0;font-size:14px;font-weight:950;letter-spacing:.5px;text-transform:capitalize;color:rgba(200,230,255,.80)}
    .times{display:grid;grid-template-columns:92px 1fr;gap:8px 10px;align-items:baseline;margin-top:10px;font-variant-numeric:tabular-nums}
    .timeLabel{text-align:right;font-size:12px;font-weight:900;color:rgba(200,230,255,0.72);letter-spacing:1px;text-transform:uppercase}
    .timeVal{font-size:34px;font-weight:950;line-height:1; text-shadow:0 0 18px rgba(255,43,214,0.10),0 0 14px rgba(53,242,255,0.08);}


    .listCard{padding:12px}
    .listHead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .listTitle{font-size:13px;font-weight:950;letter-spacing:1px;text-transform:uppercase;color:rgba(200,230,255,.78)}
    .hint{font-size:12px;color:rgba(200,230,255,.55);font-weight:800}

    .items{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(120,255,255,.14);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,0.03);
    }
    .pname{font-size:18px;font-weight:950;line-height:1.15;margin:0 0 8px;}
    .metaRow{display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .qblock{display:flex;flex-direction:column;gap:4px}
    .qlab{font-size:11px;color:rgba(200,230,255,.60);font-weight:850;letter-spacing:.6px;text-transform:uppercase}
    .qval{font-size:22px;font-weight:950;}
    .fval{font-size:13px;color:rgba(200,230,255,.78);font-weight:850;}
    .badge{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);font-size:13px;font-weight:950;text-transform:uppercase;letter-spacing:0.7px;box-shadow:0 0 16px rgba(53,242,255,0.06);}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--todo);box-shadow:0 0 0 5px rgba(53,242,255,.12);}
    .badge.todo{border-color:rgba(53,242,255,.26)}
    .badge.done{border-color:rgba(43,255,136,.28)}
    .badge.done .dot{background:var(--done);box-shadow:0 0 0 5px rgba(43,255,136,.12)}
    .blink{animation:softPulse 2.0s ease-in-out infinite}
    @keyframes softPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.14)}}

    .debug{margin-top:10px;color:rgba(200,230,255,0.55);font-size:11px;letter-spacing:0.4px;user-select:none;}

    @media (min-width: 430px){
      .infoRow{grid-template-columns:1fr 1fr;}
    }
    @media (min-width: 768px){
      .wrap{max-width:900px;margin:0 auto;}
      .title{font-size:34px}
      .timeVal{font-size:44px}
      .wTemp{font-size:62px}
      .pname{font-size:20px}
      .qval{font-size:26px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="card titleCard">
        <p class="title">TABELLONE PRODUZIONE LIVE</p>
        <div class="sub">
          <span class="chip live"><span class="liveDot"></span>LIVE</span>
          <span class="chip">Mobile</span>
          <span class="chip">Agg.: 20s</span>
          <span class="chip">v20251216-234305</span>
        </div>
      </div>

      <div class="infoRow">
        <div class="card weatherCard">
          <div class="wTitle"><span class="wPulse"></span>METEO • Concamarise (VR)</div>
          <div class="wMain">
            <div class="wTemp" id="wTemp">--°</div>
            <div>
              <div class="wDesc" id="wDesc">Carico…</div>
              <div class="hint" id="wUpdated">—</div>
            </div>
          </div>
          <div class="wMeta">
            <div class="wPill">Vento <span id="wWind">—</span> km/h</div>
            <div class="wPill">Pioggia <span id="wRain">—</span>% (1h)</div>
          </div>
        </div>

        <div class="card clockCard">
          <p class="dateBig" id="dateLine">----</p>
          <div class="times">
            <div class="timeLabel">ITALIA</div><div class="timeVal" id="timeIT">--:--</div>
            <div class="timeLabel">中国</div><div class="timeVal" id="timeCN">--:--</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card listCard">
      <div class="listHead">
        <div class="listTitle">Produzione</div>
        <div class="hint">Scorri ↓</div>
      </div>
      <div class="items" id="items"></div>
      <div class="debug" id="debug"></div>
    </div>
  </div>

<script>
  const REFRESH_MS = 20000;
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbRcMc9ZdrJ0o7jCJZfyCeGuGD3pgxurwbxO6NO_2kizrkg0czCQYR3g0YmUyWffgyBkmBdNe9fiB/pub?output=csv";

  const WX_LAT = 45.2153;
  const WX_LON = 11.1462;
  const WX_TZ  = "Europe/Rome";
  const WX_REFRESH_MS = 10 * 60 * 1000;

  let inFlight = false;
  let lastHash = "";
  const debugEl = document.getElementById("debug");

  function dbg(msg){ debugEl.textContent = msg; }

  function tickClock(){
    const now = new Date();
    document.getElementById("timeIT").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("timeCN").textContent =
      new Intl.DateTimeFormat("zh-CN",{timeZone:"Asia/Shanghai",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("dateLine").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(now);
  }

  function parseCSV(text){
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;

    for(let i=0;i<text.length;i++) {
      const ch = text[i];
      if(ch === '"') {
        if(inQ && text[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ) {
        row.push(cur); cur="";
      } else if(ch === "\n" && !inQ) {
        row.push(cur); rows.push(row);
        row = []; cur="";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    rows.push(row);
    return rows;
  }

  async function loadJobsCSV(){
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status + " leggendo CSV");
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(v => (v||"").trim() !== ""));
    if(rows.length <= 1) return [];

    const header = rows[0].map(x => (x||"").trim().toLowerCase());
    const idx = {
      product: header.indexOf("product") !== -1 ? header.indexOf("product") : 0,
      qty: header.indexOf("qty") !== -1 ? header.indexOf("qty") : 1,
      unit: header.indexOf("unit") !== -1 ? header.indexOf("unit") : 2,
      format: header.indexOf("format") !== -1 ? header.indexOf("format") : 3,
      status: header.indexOf("status") !== -1 ? header.indexOf("status") : 4,
    };

    const jobs = [];
    for(let i=1;i<rows.length;i++) {
      const r = rows[i];
      const job = {
        product: (r[idx.product] ?? "").trim(),
        qty: (r[idx.qty] ?? "").trim(),
        unit: (r[idx.unit] ?? "").trim(),
        format: (r[idx.format] ?? "").trim(),
        status: (r[idx.status] ?? "").trim(),
      };
      if(!(job.product || job.qty || job.format || job.status)) continue;
      jobs.push(job);
    }
    return jobs;
  }

  function stableHash(jobs){
    return jobs.map(j => [j.product,j.qty,j.unit,j.format,j.status].join("|")).join("§");
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c]));
  }

  function renderItems(jobs){
    const box = document.getElementById("items");
    box.innerHTML = "";
    if(!jobs.length){
      box.innerHTML = `<div class="item"><p class="pname">Nessun dato</p><div class="metaRow"><div class="qblock"><div class="qlab">Quantità</div><div class="qval">—</div><div class="fval">—</div></div><span class="badge todo blink"><span class="dot"></span>Controlla Sheet</span></div></div>`;
      return;
    }
    for(const job of jobs){
      const st = (job.status || "").toUpperCase();
      const isTodo = st.includes("DA");
      const badgeCls = isTodo ? "badge todo blink" : "badge done";
      const qtyLine = (`${job.qty} ${job.unit}`).trim();
      const fmtLine = (job.format || "").trim();
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <p class="pname">${escapeHtml(job.product)}</p>
        <div class="metaRow">
          <div class="qblock">
            <div class="qlab">Quantità</div>
            <div class="qval">${escapeHtml(qtyLine)}</div>
            <div class="fval">${escapeHtml(fmtLine)}</div>
          </div>
          <span class="${badgeCls}"><span class="dot"></span>${escapeHtml(job.status || "")}</span>
        </div>
      `;
      box.appendChild(el);
    }
  }

  async function refreshJobs(){
    if(inFlight) return;
    inFlight = true;
    try {
      dbg("Carico dati…");
      const jobs = await loadJobsCSV();
      const h = stableHash(jobs);
      if(h !== lastHash){ lastHash = h; renderItems(jobs); }
      dbg("OK • " + new Date().toLocaleTimeString("it-IT"));
    } catch(e) {
      renderItems([{product:"Errore lettura sheet", qty:"—", unit:"", format:(e && e.message ? e.message : String(e)), status:"DA PRODURRE"}]);
      dbg("ERRORE • " + (e && e.message ? e.message : String(e)));
    } finally {
      inFlight = false;
    }
  }

  const WCODE = {
    0:"Sereno", 1:"Preval. sereno", 2:"Parz. nuvoloso", 3:"Nuvoloso",
    45:"Nebbia", 48:"Brina/nebbia",
    51:"Pioviggine", 53:"Pioviggine", 55:"Pioviggine",
    61:"Pioggia", 63:"Pioggia", 65:"Pioggia forte",
    71:"Neve", 73:"Neve", 75:"Neve forte",
    80:"Rovesci", 81:"Rovesci", 82:"Rovesci forti",
    95:"Temporale", 96:"Temporale", 99:"Temporale"
  };
  function wdesc(code){ return WCODE[code] || ("Meteo " + code); }

  async function refreshWeather(){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code,wind_speed_10m&hourly=precipitation_probability&timezone=${encodeURIComponent(WX_TZ)}&t=${Date.now()}`;
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Meteo HTTP " + res.status);
    const j = await res.json();

    const temp = j?.current?.temperature_2m;
    const code = j?.current?.weather_code;
    const wind = j?.current?.wind_speed_10m;

    let p = null;
    const times = j?.hourly?.time || [];
    const probs = j?.hourly?.precipitation_probability || [];
    if(times.length && probs.length){
      const nowIso = new Date().toISOString().slice(0,13);
      let idx = times.findIndex(t => t.startsWith(nowIso));
      if(idx < 0) idx = 0;
      p = probs[idx];
    }

    document.getElementById("wTemp").textContent = (temp ?? "--") + "°";
    document.getElementById("wDesc").textContent = wdesc(code);
    document.getElementById("wWind").textContent = (wind ?? "—");
    document.getElementById("wRain").textContent = (p ?? "—");
    document.getElementById("wUpdated").textContent = "Agg. " + new Date().toLocaleTimeString("it-IT");
  }

  tickClock();
  setInterval(tickClock, 1000);

  refreshJobs();
  setInterval(refreshJobs, REFRESH_MS);

  refreshWeather().catch(()=>{ document.getElementById("wDesc").textContent="Meteo non disponibile"; });
  setInterval(() => refreshWeather().catch(()=>{}), WX_REFRESH_MS);
</script>
</body>
</html>
