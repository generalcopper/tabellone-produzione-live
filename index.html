<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabellone Produzione Live</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg0:#05060a; --bg1:#070b12;
      --panel: rgba(10,14,24,.82);
      --line: rgba(120,255,255,.22);
      --text:#eaf7ff;
      --neonCyan:#35f2ff; --neonMag:#ff2bd6; --neonYel:#ffe66d;
      --todo:#35f2ff; --done:#2bff88;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      background:
        radial-gradient(1400px 1100px at 10% 10%, rgba(53,242,255,.10), transparent 55%),
        radial-gradient(1400px 1100px at 85% 15%, rgba(255,43,214,.08), transparent 55%),
        radial-gradient(1200px 900px at 70% 90%, rgba(255,230,109,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(to bottom,
        rgba(255,255,255,.016), rgba(255,255,255,.016) 1px,
        transparent 1px, transparent 7px);
      opacity:.18; pointer-events:none; mix-blend-mode:overlay;
      z-index:1;
    }
    .wrap{height:100%;display:flex;flex-direction:column;padding:18px;gap:14px;position:relative;z-index:2;}
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow:
        0 0 0 1px rgba(53,242,255,0.10),
        0 14px 34px rgba(0,0,0,0.50),
        0 0 46px rgba(53,242,255,0.05),
        0 0 56px rgba(255,43,214,0.03);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }
    .top{display:flex;gap:12px}

    .titleCard{flex:1;position:relative;isolation:isolate;min-width:520px;padding:0;}
    .titlePad{padding:16px 18px; position:relative; z-index:2;}
    .titleCard:before{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(53,242,255,0.00), rgba(53,242,255,0.20), rgba(255,43,214,0.16), rgba(53,242,255,0.00));
      filter: blur(9px); opacity:0.52; transform: translate3d(-60%,0,0);
      animation: sweep 6.5s linear infinite; pointer-events:none; z-index:0; will-change: transform;
    }
    @keyframes sweep{0%{transform: translate3d(-60%,0,0)}100%{transform: translate3d(60%,0,0)}}
    .titleGrid{
      position:absolute; inset:0;
      background: linear-gradient(to right, rgba(53,242,255,0.10) 1px, transparent 1px),
                  linear-gradient(to bottom, rgba(255,43,214,0.08) 1px, transparent 1px);
      background-size:120px 120px; opacity:0.16; mix-blend-mode: screen;
      transform: translate3d(0,0,0); animation: gridPan 10s linear infinite;
      pointer-events:none; z-index:1; will-change: transform;
    }
    @keyframes gridPan{0%{transform: translate3d(0,0,0)}100%{transform: translate3d(240px,240px,0)}}

    .title{margin:0;font-size:42px;font-weight:950;letter-spacing:1.2px;text-transform:uppercase;text-shadow:0 0 24px rgba(53,242,255,0.16);position:relative;z-index:3;}
    .subtitle{margin-top:8px;color:rgba(200,230,255,.72);font-size:18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;position:relative;z-index:3;}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);font-weight:900;letter-spacing:0.7px;text-transform:uppercase;font-size:14px;}
    .chip.live{border-color:rgba(53,242,255,0.24);box-shadow:0 0 16px rgba(53,242,255,0.10)}
    .liveDot{width:10px;height:10px;border-radius:999px;background:var(--neonCyan);box-shadow:0 0 0 6px rgba(53,242,255,0.12),0 0 18px rgba(53,242,255,0.22);animation:livePulse 1.6s ease-in-out infinite;}
    @keyframes livePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5)}}

    .clockCard{width:620px;padding:16px;display:flex;flex-direction:column;gap:10px;align-items:flex-end;flex:0 0 auto;}
    .dateBig{font-size:30px;font-weight:950;margin:0;letter-spacing:0.6px;text-transform:capitalize}
    .timeGrid{display:grid;grid-template-columns:120px 1fr;gap:10px 14px;align-items:baseline;font-variant-numeric:tabular-nums;width:100%}
    .timeLabel{text-align:right;font-size:18px;font-weight:900;color:rgba(200,230,255,0.72);letter-spacing:1px;text-transform:uppercase}
    .timeVal{font-size:72px;font-weight:950;line-height:.95;text-shadow:0 0 24px rgba(255,43,214,0.12),0 0 20px rgba(53,242,255,0.10);}

    .board{flex:1;display:flex;flex-direction:column;min-height:0;}
    .header,.row{display:grid;grid-template-columns:2.4fr 520px 360px;align-items:center;gap:16px;padding:0 18px;}
    .header{height:64px;border-bottom:1px solid rgba(120,255,255,.16);font-size:16px;font-weight:900;text-transform:uppercase;color:rgba(200,230,255,.78);background:rgba(255,255,255,0.03);flex:0 0 auto;}
    .rows{flex:1 1 auto;min-height:0;overflow:auto;}
    .row{height:96px;border-bottom:1px solid rgba(120,255,255,.11);position:relative;flex:0 0 auto;}
    .row:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(53,242,255,0.05),transparent);opacity:0;animation:sweepRow 12s linear infinite;pointer-events:none;will-change:opacity,transform;}
    @keyframes sweepRow{0%{opacity:0;transform:translate3d(-25%,0,0)}5%{opacity:0.14}12%{opacity:0}100%{opacity:0;transform:translate3d(25%,0,0)}}

    .product{font-size:44px;font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 18px rgba(53,242,255,0.10);}
    .qtyFmt{justify-self:end;display:flex;align-items:baseline;gap:18px;font-variant-numeric:tabular-nums;white-space:nowrap;}
    .qty{font-size:44px;font-weight:950;text-shadow:0 0 16px rgba(255,230,109,0.09)}
    .fmt{font-size:26px;color:rgba(200,230,255,.74);font-weight:850;letter-spacing:0.4px}
    .statusWrap{justify-self:end;display:flex;align-items:center;gap:14px;white-space:nowrap}
    .badge{display:inline-flex;align-items:center;gap:12px;padding:14px 18px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);font-size:24px;font-weight:950;text-transform:uppercase;letter-spacing:0.8px;box-shadow:0 0 20px rgba(53,242,255,0.07);}
    .dot{width:14px;height:14px;border-radius:999px;background:var(--todo);box-shadow:0 0 0 6px rgba(53,242,255,.14);}
    .badge.todo{border-color:rgba(53,242,255,.26)}
    .badge.todo .dot{background:var(--todo)}
    .badge.done{border-color:rgba(43,255,136,.28)}
    .badge.done .dot{background:var(--done);box-shadow:0 0 0 6px rgba(43,255,136,.14)}
    .blink{animation:softPulse 2.0s ease-in-out infinite}
    @keyframes softPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.18)}}

    .debug{position:fixed;left:12px;bottom:10px;z-index:3;color:rgba(200,230,255,0.55);font-size:12px;letter-spacing:0.4px;user-select:none;max-width:85vw;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card top" style="padding:0">
      <div class="titleCard">
        <div class="titleGrid"></div>
        <div class="titlePad">
          <p class="title">TABELLONE PRODUZIONE LIVE</p>
          <div class="subtitle">
            <span class="chip live"><span class="liveDot"></span>LIVE</span>
            <span class="chip">Aggiornamento: 20s</span>
          </div>
        </div>
      </div>

      <div class="clockCard">
        <p class="dateBig" id="dateLine">----</p>
        <div class="timeGrid">
          <div class="timeLabel">ITALIA</div><div class="timeVal" id="timeIT">--:--</div>
          <div class="timeLabel">中国</div><div class="timeVal" id="timeCN">--:--</div>
        </div>
      </div>
    </div>

    <div class="card board">
      <div class="header">
        <div>Prodotto</div>
        <div style="justify-self:end">Quantità / formato</div>
        <div style="justify-self:end">Stato</div>
      </div>
      <div class="rows" id="rows"></div>
    </div>
  </div>

  <div class="debug" id="debug"></div>

<script>
  const REFRESH_MS = 20000;
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbRcMc9ZdrJ0o7jCJZfyCeGuGD3pgxurwbxO6NO_2kizrkg0czCQYR3g0YmUyWffgyBkmBdNe9fiB/pub?output=csv";

  let refreshTimer = null;
  let inFlight = false;
  let lastHash = "";
  const rowNodes = new Map();

  const debugEl = document.getElementById("debug");
  function dbg(msg){ debugEl.textContent = msg; }

  function stableHash(jobs){
    return jobs.map(j => [j.product,j.qty,j.unit,j.format,j.status].join("|")).join("§");
  }

  function tickClock(){
    const now = new Date();
    document.getElementById("timeIT").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("timeCN").textContent =
      new Intl.DateTimeFormat("zh-CN",{timeZone:"Asia/Shanghai",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("dateLine").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(now);
  }

  function parseCSV(text){
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;

    for(let i=0;i<text.length;i++) {
      const ch = text[i];
      if(ch === '"') {
        if(inQ && text[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ) {
        row.push(cur); cur="";
      } else if(ch === "\n" && !inQ) {
        row.push(cur); rows.push(row);
        row = []; cur="";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    rows.push(row);
    return rows;
  }

  async function loadJobsCSV(){
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status + " leggendo CSV");
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(v => (v||"").trim() !== ""));
    if(rows.length <= 1) return [];

    const header = rows[0].map(x => (x||"").trim().toLowerCase());
    const idx = {
      product: header.indexOf("product") !== -1 ? header.indexOf("product") : 0,
      qty: header.indexOf("qty") !== -1 ? header.indexOf("qty") : 1,
      unit: header.indexOf("unit") !== -1 ? header.indexOf("unit") : 2,
      format: header.indexOf("format") !== -1 ? header.indexOf("format") : 3,
      status: header.indexOf("status") !== -1 ? header.indexOf("status") : 4,
    };

    const jobs = [];
    for(let i=1;i<rows.length;i++) {
      const r = rows[i];
      const job = {
        product: (r[idx.product] ?? "").trim(),
        qty: (r[idx.qty] ?? "").trim(),
        unit: (r[idx.unit] ?? "").trim(),
        format: (r[idx.format] ?? "").trim(),
        status: (r[idx.status] ?? "").trim(),
      };
      if(!(job.product || job.qty || job.format || job.status)) continue;
      jobs.push(job);
    }
    return jobs;
  }

  function ensureRowEl(){
    const el = document.createElement("div");
    el.className = "row";
    el.innerHTML = `
      <div class="product"></div>
      <div class="qtyFmt">
        <div class="qty"></div>
        <div class="fmt"></div>
      </div>
      <div class="statusWrap">
        <span class="badge"><span class="dot"></span><span class="st"></span></span>
      </div>
    `;
    return el;
  }

  function updateRowEl(el, job){
    el.querySelector(".product").textContent = job.product;
    el.querySelector(".qty").textContent = `${job.qty} ${job.unit}`.trim();
    el.querySelector(".fmt").textContent = job.format;

    const badge = el.querySelector(".badge");
    const stSpan = el.querySelector(".st");
    const st = (job.status || "").toUpperCase();
    const isTodo = st.includes("DA");

    badge.classList.toggle("todo", isTodo);
    badge.classList.toggle("done", !isTodo);
    badge.classList.toggle("blink", isTodo);
    stSpan.textContent = job.status || "";
  }

  function makeKey(job, idx){ return `${job.product}::${job.format}::${idx}`; }

  function renderSoft(jobs){
    const rows = document.getElementById("rows");
    const seen = new Set();

    jobs.forEach((job, idx) => {
      const key = makeKey(job, idx);
      seen.add(key);

      let el = rowNodes.get(key);
      if(!el) {
        el = ensureRowEl();
        rowNodes.set(key, el);
        rows.appendChild(el);
      } else {
        const cur = rows.children[idx];
        if(cur !== el) rows.insertBefore(el, cur || null);
      }
      updateRowEl(el, job);
    });

    for(const [key, el] of rowNodes.entries()) {
      if(!seen.has(key)) {
        el.remove();
        rowNodes.delete(key);
      }
    }

    if(jobs.length === 0) {
      rows.innerHTML = "";
      rowNodes.clear();
      const el = ensureRowEl();
      updateRowEl(el, {product:"Nessun dato", qty:"—", unit:"", format:"—", status:"CONTROLLA SHEET"});
      el.querySelector(".badge").classList.add("todo","blink");
      rows.appendChild(el);
    }
  }

  async function refresh(){
    if(inFlight) return;
    inFlight = true;
    try {
      dbg("Carico dati…");
      const jobs = await loadJobsCSV();
      const h = stableHash(jobs);
      if(h !== lastHash) {
        lastHash = h;
        renderSoft(jobs);
      }
      dbg("OK • aggiornato " + new Date().toLocaleTimeString("it-IT"));
    } catch(e) {
      renderSoft([{product:"Errore lettura sheet", qty:"—", unit:"", format:(e && e.message ? e.message : String(e)), status:"DA PRODURRE"}]);
      dbg("ERRORE • " + (e && e.message ? e.message : String(e)));
    } finally {
      inFlight = false;
    }
  }

  function start(){
    if(refreshTimer) clearInterval(refreshTimer);
    tickClock();
    setInterval(tickClock, 1000);
    refresh();
    refreshTimer = setInterval(refresh, REFRESH_MS);
  }

  start();
</script>
</body>
</html>
