<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LINEA LIQUIDI AUTOMATICA</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg0:#05060a; --bg1:#070b12;
      --panel: rgba(10,14,24,.82);
      --line: rgba(120,255,255,.22);
      --text:#eaf7ff;
      --neonCyan:#35f2ff; --neonMag:#ff2bd6; --neonYel:#ffe66d;
      --todo:#35f2ff; --done:#2bff88;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      background:
        radial-gradient(1400px 1100px at 10% 10%, rgba(53,242,255,.10), transparent 55%),
        radial-gradient(1400px 1100px at 85% 15%, rgba(255,43,214,.08), transparent 55%),
        radial-gradient(1200px 900px at 70% 90%, rgba(255,230,109,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(to bottom,
        rgba(255,255,255,.016), rgba(255,255,255,.016) 1px,
        transparent 1px, transparent 7px);
      opacity:.18; pointer-events:none; mix-blend-mode:overlay;
      z-index:1;
    }
    .wrap{height:100%;display:flex;flex-direction:column;padding:18px;gap:14px;position:relative;z-index:2;}
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow:
        0 0 0 1px rgba(53,242,255,0.10),
        0 14px 34px rgba(0,0,0,0.50),
        0 0 46px rgba(53,242,255,0.05),
        0 0 56px rgba(255,43,214,0.03);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }
    .top{display:flex;gap:12px}

    .titleCard{flex:1;position:relative;isolation:isolate;min-width:520px;padding:0;}
    .titlePad{padding:18px 20px; position:relative; z-index:2;}
    .titleCard:before{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(53,242,255,0.00), rgba(53,242,255,0.20), rgba(255,43,214,0.16), rgba(53,242,255,0.00));
      filter: blur(9px); opacity:0.52; transform: translate3d(-60%,0,0);
      animation: sweep 6.5s linear infinite; pointer-events:none; z-index:0; will-change: transform;
    }
    @keyframes sweep{0%{transform: translate3d(-60%,0,0)}100%{transform: translate3d(60%,0,0)}}
    .titleGrid{
      position:absolute; inset:0;
      background: linear-gradient(to right, rgba(53,242,255,0.10) 1px, transparent 1px),
                  linear-gradient(to bottom, rgba(255,43,214,0.08) 1px, transparent 1px);
      background-size:120px 120px; opacity:0.16; mix-blend-mode: screen;
      transform: translate3d(0,0,0); animation: gridPan 10s linear infinite;
      pointer-events:none; z-index:1; will-change: transform;
    }
    @keyframes gridPan{0%{transform: translate3d(0,0,0)}100%{transform: translate3d(240px,240px,0)}}

    .title{margin:0;font-size:64px;font-weight:950;letter-spacing:1.2px;text-transform:uppercase;text-shadow:0 0 26px rgba(53,242,255,0.16);position:relative;z-index:3;}
    .subtitle{margin-top:10px;color:rgba(200,230,255,.72);font-size:18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;position:relative;z-index:3;}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);font-weight:900;letter-spacing:0.7px;text-transform:uppercase;font-size:14px;}
    .chip.live{border-color:rgba(53,242,255,0.24);box-shadow:0 0 16px rgba(53,242,255,0.10)}
    .liveDot{width:10px;height:10px;border-radius:999px;background:var(--neonCyan);
      box-shadow:0 0 0 6px rgba(53,242,255,0.12),0 0 18px rgba(53,242,255,0.22);
      animation:livePulse 1.6s ease-in-out infinite;}
    @keyframes livePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5)}}

    .clockCard{width:560px;padding:16px;display:flex;flex-direction:column;gap:10px;align-items:flex-end;flex:0 0 auto;}
    .dateBig{font-size:34px;font-weight:950;margin:0;letter-spacing:0.6px;text-transform:capitalize}
    .timeGrid{display:grid;grid-template-columns:120px 1fr;gap:10px 14px;align-items:baseline;font-variant-numeric:tabular-nums;width:100%}
    .timeLabel{text-align:right;font-size:18px;font-weight:900;color:rgba(200,230,255,0.72);letter-spacing:1px;text-transform:uppercase}
    .timeVal{font-size:96px;font-weight:950;line-height:.95;
      text-shadow:0 0 24px rgba(255,43,214,0.12),0 0 20px rgba(53,242,255,0.10);}

    .weatherCard{width:520px;padding:16px;display:flex;flex-direction:column;gap:10px;align-items:flex-start;flex:0 0 auto;}
    .wTitle{font-size:18px;font-weight:950;letter-spacing:1px;text-transform:uppercase;color:rgba(200,230,255,.78);display:flex;align-items:center;gap:10px}
    .wPulse{width:10px;height:10px;border-radius:999px;background:var(--neonMag);box-shadow:0 0 0 6px rgba(255,43,214,0.10);animation:livePulse 1.8s ease-in-out infinite;}
    .wMain{display:flex;align-items:flex-end;gap:16px;width:100%;}
    .wTemp{font-size:92px;font-weight:950;line-height:.95;text-shadow:0 0 18px rgba(255,230,109,0.10);}
    .wDesc{font-size:28px;font-weight:900;color:rgba(200,230,255,.78);line-height:1.1}
    .wMeta{display:flex;gap:14px;flex-wrap:wrap;color:rgba(200,230,255,.72);font-size:18px;font-weight:850}
    .wPill{border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);border-radius:999px;padding:8px 12px;}
    .wSmall{font-size:14px;color:rgba(200,230,255,.55);font-weight:850;letter-spacing:0.4px}

    .board{flex:1;display:flex;flex-direction:column;min-height:0;}
    .header,.row{display:grid;grid-template-columns:2.4fr 520px 360px;align-items:center;gap:16px;padding:0 18px;}
    .header{height:70px;border-bottom:1px solid rgba(120,255,255,.16);font-size:18px;font-weight:900;text-transform:uppercase;color:rgba(200,230,255,.78);background:rgba(255,255,255,0.03);flex:0 0 auto;}
    .rows{flex:1 1 auto;min-height:0;overflow:auto;}
    .row{height:112px;border-bottom:1px solid rgba(120,255,255,.11);position:relative;flex:0 0 auto;}
    .product{font-size:64px;font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 18px rgba(53,242,255,0.10);}
    .qtyFmt{justify-self:end;display:flex;align-items:baseline;gap:18px;font-variant-numeric:tabular-nums;white-space:nowrap;}
    .qty{font-size:60px;font-weight:950;text-shadow:0 0 16px rgba(255,230,109,0.09)}
    .fmt{font-size:36px;color:rgba(200,230,255,.74);font-weight:850;letter-spacing:0.4px}
    .statusWrap{justify-self:end;display:flex;align-items:center;gap:14px;white-space:nowrap}
    .badge{display:inline-flex;align-items:center;gap:12px;padding:16px 20px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);font-size:34px;font-weight:950;text-transform:uppercase;letter-spacing:0.8px;box-shadow:0 0 20px rgba(53,242,255,0.07);}
    
/* --- testo badge: wrapper + scorrimento solo per "IN PRODUZIONE" --- */
.stWrap{
  position:relative;
  overflow:hidden;
  display:block;
  max-width: 320px;
}
.st{display:inline-block;white-space:nowrap;}
.badge.wip .st{
  will-change: transform;
  animation: marqueeX 5.2s linear infinite;
}
@keyframes marqueeX{
  0%{transform: translateX(110%);}
  100%{transform: translateX(-110%);}
}
@media (prefers-reduced-motion: reduce){
  .badge.wip .st{ animation:none; }
}
.dot{width:16px;height:16px;border-radius:999px;background:var(--todo);box-shadow:0 0 0 6px rgba(53,242,255,.14);}
    .badge.todo{border-color:rgba(53,242,255,.26)}
    .badge.todo .dot{background:var(--todo)}
    .badge.done{border-color:rgba(43,255,136,.28)}
    .badge.done .dot{background:var(--done);box-shadow:0 0 0 6px rgba(43,255,136,.14)}
    .blink{animation:softPulse 2.0s ease-in-out infinite}
    @keyframes softPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.18)}}

    .debug{position:fixed;left:12px;bottom:10px;z-index:3;color:rgba(200,230,255,0.55);font-size:12px;letter-spacing:0.4px;user-select:none;max-width:85vw;}
  
    /* --- azioni produzione (locale) --- */
    .badge.btn{
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .12s ease;
    }
    .badge.btn:active{ transform: scale(0.98); filter: brightness(1.06); }

    .producedCard{
      margin-top: 14px;
      padding: 14px;
    }
    .prodHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .prodTitle{
      font-weight:900;
      letter-spacing:.3px;
      font-size: 16px;
    }
    .prodHint{
      font-size: 12px;
      opacity:.75;
    }
    .prodList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 180px;
      overflow:auto;
      padding-right: 4px;
    }
    .prodEmpty{
      opacity:.65;
      font-size: 13px;
      padding: 10px 12px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
    }
    .prodItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
    }
    .prodText{
      font-size: 13px;
      line-height:1.25;
      opacity:.95;
    }
    .prodQty{
      font-weight:900;
      margin-left:6px;
    }
    .undoBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: inherit;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .undoBtn:active{ transform: scale(0.99); }

    
/* --- mobile layout --- */
@media (max-width: 820px){
  .wrap{ padding: 10px; }
  .card.top{ padding: 14px 14px; }
  .top h1{ font-size: 22px; }
  .meta{ flex-wrap: wrap; gap: 8px; }
  .chip{ font-size: 12px; padding: 8px 10px; }
  .board{ border-radius: 18px; }
  .header{ display:none; }
  .rows{ padding: 6px 0; }
  .row{
    display:block;
    height:auto;
    padding: 14px 14px;
    gap: 10px;
  }
  .product{
    font-size: 28px;
    white-space: normal;
    line-height: 1.05;
    margin-bottom: 8px;
  }
  .qtyFmt{
    justify-self: unset;
    display:flex;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 10px;
  }
  .qty{ font-size: 30px; }
  .fmt{ font-size: 16px; }
  .statusWrap{
    justify-self: unset;
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
  }
  .badge{
    font-size: 12px;
    padding: 10px 12px;
    border-radius: 999px;
  }
  .dot{ width: 12px; height: 12px; box-shadow: 0 0 0 4px rgba(53,242,255,.14); }
  .badge.done .dot{ box-shadow: 0 0 0 4px rgba(43,255,136,.18); }
  .badge.wip .dot{ box-shadow: 0 0 0 4px rgba(255,189,67,.18); }

  /* completati box */
  .prodList{ max-height: 220px; }
  .prodItem{ gap: 8px; }
  .undoBtn{ padding: 8px 10px; font-size: 12px; }
}

/* --- modal --- */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      z-index: 9999;
    }
    .modal.show{ display:flex; }
    .modalBox{
      width:min(520px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,12,20,.92);
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      padding: 18px;
    }
    .modalTitle{
      font-weight: 1000;
      font-size: 22px;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .modalSub{
      opacity:.75;
      margin-bottom: 14px;
      font-size: 13px;
    }
    .modalInput{
      width:100%;
      font-size: 22px;
      font-weight: 900;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: inherit;
      outline: none;
    }
    .modalInput:focus{ border-color: rgba(120,180,255,.55); }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 14px;
    }
    .btnGhost, .btnOk{
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: inherit;
    }
    .btnOk{
      border-color: rgba(120,180,255,.45);
      background: rgba(120,180,255,.18);
    }

/* ===== MOBILE COMPACT ===== */
@media (max-width: 640px) {

  html {
    font-size: 14px;
  }

  .wrap {
    padding: 8px;
  }

  .card {
    margin: 8px 0;
  }

  table td, table th {
    padding: 6px 8px;
    font-size: 13px;
  }

  .badge, .btn {
    font-size: 12px;
    padding: 5px 8px;
  }

  .title {
    font-size: 18px;
  }

  .subtitle {
    font-size: 12px;
  }
    /* ===== COMPACT HEADER (solo mobile) ===== */

  .card.top {
    padding: 8px !important;
  }

  .titleCard {
    padding: 6px 8px !important;
  }

  .titlePad {
    padding: 0 !important;
  }

  .title {
    font-size: 16px !important;
    margin: 0 0 6px 0 !important;
    line-height: 1.15;
  }

  .subtitle {
    gap: 6px !important;
    flex-wrap: wrap;
  }

  .chip {
    font-size: 11px !important;
    padding: 4px 8px !important;
  }
}
  @keyframes pulseDot {
  0%   { transform: scale(1);   opacity: 0.7; }
  50%  { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1);   opacity: 0.7; }
}

.wip .dot {
  background-color: #ffb000;
  box-shadow: 0 0 10px rgba(0, 255, 136, 1);
  animation: pulseDot 1.2s infinite ease-in-out;
}
  /* --- BOOT / AVVIO (overlay 0-100%) --- */
.bootOverlay{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background: radial-gradient(1200px 900px at 20% 20%, rgba(53,242,255,.10), transparent 55%),
              radial-gradient(1200px 900px at 80% 25%, rgba(255,43,214,.10), transparent 55%),
              linear-gradient(180deg, rgba(3,4,8,.96), rgba(6,10,18,.96));
  z-index: 10000;
  transition: opacity .45s ease, transform .45s ease;
  opacity:1;
  transform: translate3d(0,0,0);
  pointer-events: auto;
}
.bootOverlay.hide{
  opacity:0;
  transform: translate3d(0,-10px,0);
  pointer-events:none;
}
.bootBox{
  width:min(860px, 92vw);
  border-radius: 26px;
  border: 1px solid rgba(120,255,255,.22);
  background: rgba(10,14,24,.78);
  box-shadow:
    0 0 0 1px rgba(53,242,255,0.10),
    0 18px 70px rgba(0,0,0,0.65),
    0 0 70px rgba(53,242,255,0.07),
    0 0 90px rgba(255,43,214,0.05);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  padding: 26px 26px 22px;
  position:relative;
  overflow:hidden;
}
.bootBox:before{
  content:"";
  position:absolute; inset:-2px;
  background: linear-gradient(90deg, rgba(53,242,255,0.00), rgba(53,242,255,0.18), rgba(255,43,214,0.14), rgba(53,242,255,0.00));
  filter: blur(10px);
  opacity:0.55;
  transform: translate3d(-60%,0,0);
  animation: bootSweep 5.5s linear infinite;
  pointer-events:none;
}
@keyframes bootSweep{0%{transform: translate3d(-60%,0,0)}100%{transform: translate3d(60%,0,0)}}
.bootTitle{
  font-weight: 1000;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  font-size: 28px;
  margin: 0 0 10px 0;
  text-shadow: 0 0 24px rgba(53,242,255,0.16);
  position:relative; z-index:1;
}
.bootMsg{
  position:relative; z-index:1;
  font-size: 18px;
  font-weight: 850;
  color: rgba(200,230,255,.78);
  margin: 0 0 16px 0;
  letter-spacing: .3px;
}
.bootBar{
  position:relative; z-index:1;
  height: 22px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.05);
  overflow:hidden;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
}
.bootFill{
  height: 100%;
  width: 0%;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(53,242,255,.85), rgba(255,43,214,.75), rgba(255,230,109,.75));
  box-shadow: 0 0 22px rgba(53,242,255,0.18);
  position:relative;
  transition: width .14s linear;
}
.bootFill:after{
  content:"";
  position:absolute; inset:0;
  background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.35), rgba(255,255,255,0.0));
  transform: translateX(-60%);
  animation: bootScan 1.2s linear infinite;
  mix-blend-mode: overlay;
  opacity: .7;
}
@keyframes bootScan{0%{transform: translateX(-60%)}100%{transform: translateX(160%)}}
.bootPct{
  position:relative; z-index:1;
  margin-top: 12px;
  font-size: 54px;
  font-weight: 1000;
  letter-spacing: 1px;
  font-variant-numeric: tabular-nums;
  text-align: right;
  text-shadow: 0 0 24px rgba(255,43,214,0.10), 0 0 18px rgba(53,242,255,0.10);
}
@media (max-width: 820px){
  .bootTitle{ font-size: 20px; }
  .bootMsg{ font-size: 14px; }
  .bootPct{ font-size: 38px; }
  .bootBar{ height: 18px; }
}
  
/* ===== CAMERA BOX (solo mobile) ===== */
#mobileCamCard{ display:none; margin:14px 0; overflow:hidden; }
#mobileCamCard .titleCard{ padding:14px 16px; }
#mobileCamCard .title{ letter-spacing:.08em; font-weight:900; }
.camViewport{
  position:relative;
  width:100%;
  aspect-ratio: 16 / 9;
  background: rgba(0,0,0,.35);
  border-top: 1px solid rgba(255,255,255,.10);
}
.camFrame, .camImg{
  position:absolute; inset:0;
  width:100%; height:100%;
  border:0;
  display:none;
}
.camPlaceholder{
  position:absolute; inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:14px;
  font-weight:800;
  opacity:.85;
}
@media (max-width: 900px){
  #mobileCamCard{ display:block; }
}

</style>
</head>

<body>

<!-- BOOT OVERLAY -->
<div id="bootOverlay" class="bootOverlay" aria-hidden="false">
  <div class="bootBox">
    <div class="bootTitle">AVVIO SISTEMA</div>
    <div class="bootMsg" id="bootMsg">Inizializzazione…</div>
    <div class="bootBar"><div class="bootFill" id="bootFill"></div></div>
    <div class="bootPct" id="bootPct">0%</div>
  </div>
</div>

</div>

<div class="wrap">
    <div class="card top" style="padding:0">
      <div class="titleCard">
        <div class="titleGrid"></div>
        <div class="titlePad">
          <p class="title">LINEA LIQUIDI AUTOMATICA</p>
          <div class="subtitle">
            <span class="chip live"><span class="liveDot"></span>LIVE</span>
            <span class="chip">Aggiornamento: 60s</span>
            <span class="chip">Versione: 2025-12-16 22:52:19 UTC</span>
          </div>
        </div>
      </div>

      <div class="card weatherCard">
        <div class="wTitle"><span class="wPulse"></span>METEO • Concamarise (VR)</div>
        <div class="wMain">
          <div class="wTemp" id="wTemp">--°</div>
          <div>
            <div class="wDesc" id="wDesc">Carico…</div>
            <div class="wSmall" id="wUpdated">—</div>
          </div>
        </div>
        <div class="wMeta">
          <div class="wPill">Vento <span id="wWind">—</span> km/h</div>
          <div class="wPill">Pioggia <span id="wRain">—</span>% (1h)</div>
        </div>
        <div class="wSmall">Auto-update meteo: 10 min</div>
      </div>

      <div class="card clockCard">
        <p class="dateBig" id="dateLine">----</p>
        <div class="timeGrid">
          <div class="timeLabel">ITALIA</div><div class="timeVal" id="timeIT">--:--</div>
          <div class="timeLabel">中国</div><div class="timeVal" id="timeCN">--:--</div>
        </div>
      </div>
    </div>

    <div class="card board">
      <div class="header">
        <div>Prodotto</div>
        <div style="justify-self:end">Quantità / formato</div>
        <div style="justify-self:end">Stato</div>
      </div>
      <div class="rows" id="rows"></div>
    </div>

    <div class="card producedCard" id="producedCard">
      <div class="prodHead">
        <div class="prodTitle">Completati (cloud)</div>
        <div class="prodHint">Sincronizzato su tutti i dispositivi</div>
      </div>
      <div class="prodList" id="producedList">
        <div class="prodEmpty" id="producedEmpty">Nessuna riga completata.</div>
      </div>
    </div>


    <!-- CAMERA (solo mobile) -->
<div id="mobileCamCard" class="card" aria-label="Telecamera impianto">
  <div class="titleCard">
    <div class="title">TELECAMERA IMPIANTO</div>
  </div>
  <div class="camViewport">
    <div id="camPlaceholder" class="camPlaceholder">Nessun feed configurato (inserisci l’URL della telecamera)</div>
    <iframe id="camFrame" class="camFrame" allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    <img id="camImg" class="camImg" alt="Telecamera impianto" />
  </div>
</div>

  <!-- Modal quantità prodotta -->
  <div class="modal" id="qtyModal" aria-hidden="true">
    <div class="modalBox" role="dialog" aria-modal="true" aria-labelledby="qtyTitle">
      <div class="modalTitle" id="qtyTitle">Quanti pezzi hai prodotto?</div>
      <div class="modalSub" id="qtyModalSub">—</div>
      <input class="modalInput" id="qtyInput" inputmode="numeric" pattern="[0-9]*" placeholder="Es. 120" />
      <div class="modalActions">
        <button class="btnGhost" id="qtyCancel">Annulla</button>
        <button class="btnOk" id="qtyOk">OK</button>
      </div>
    </div>
  </div>

  <div class="debug" id="debug"></div>

<script type="module">
  // ===== Firebase (Cloud Firestore) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // ===== ElevenLabs TTS (voce alta qualità) =====
  // NOTE: per usare ElevenLabs serve una API key. Per sicurezza, l'ideale è NON metterla nel client pubblico:
  // usa un proxy (Cloud Function / server) se il file diventa accessibile dall'esterno.
  // Qui lasciamo una configurazione semplice (ok per rete interna/kiosk).
  const ELEVENLABS_API_KEY  = "sk_ac50f19d8de7f171a14cd8fdc50c12ce4f95342a8c753422"; // <-- incolla qui la tua API key ElevenLabs
  const ELEVENLABS_VOICE_ID = "Xb7hH8MSUJpSbSDYk0k2"; // <-- cambia con la tua voce (Voice ID)

  // Modello consigliato per latenza bassa (docs): eleven_flash_v2_5
  const ELEVENLABS_MODEL_ID = "eleven_flash_v2_5";

// ===== BOOT BAR (0-100%) =====
// Non tocca cloud/sheet/firebase: è solo overlay UI.
const Boot = (() => {
  const overlay = () => document.getElementById("bootOverlay");
  const fill = () => document.getElementById("bootFill");
  const pct = () => document.getElementById("bootPct");
  const msg = () => document.getElementById("bootMsg");

  const steps = [
    "Avvio interfaccia…",
    "Sincronizzazione pannelli…",
    "Lettura dati produzione…",
    "Connessione cloud…",
    "Caricamento meteo…",
    "Stabilizzazione…"
  ];

  let v = 0;
  let t0 = 0;
  let raf = 0;
  let done = false;

  const marks = { jobs:false, cloud:false, weather:false };
  const minShowMs = 900;      // evita flash
  const hardTimeoutMs = 9000; // fallback in caso rete ballerina

  function setMsg(s){
    const el = msg();
    if(el) el.textContent = s;
  }

  function setV(n){
    v = Math.max(0, Math.min(100, n));
    const f = fill();
    const p = pct();
    if(f) f.style.width = v.toFixed(1) + "%";
    if(p) p.textContent = Math.floor(v) + "%";
  }

  function start(){
    t0 = performance.now();
    setV(0);
    setMsg(steps[0]);
    tick();
    // fallback: se qualcosa resta appeso, comunque chiudi
    setTimeout(() => finish(), hardTimeoutMs);
  }

  function tick(){
    if(done) return;

    const elapsed = performance.now() - t0;

    // progress "credibile": veloce fino a ~72%, poi rallenta e aspetta i marks
    const targetSoft =
      elapsed < 800  ? 35 :
      elapsed < 1500 ? 55 :
      elapsed < 2500 ? 72 :
      85;

    // step message
    const si = Math.min(steps.length - 1, Math.floor((elapsed / 650)));
    setMsg(steps[si]);

    // porta v verso targetSoft
    if(v < targetSoft){
      const delta = (elapsed < 1500) ? (Math.random() * 2.8 + 1.2) : (Math.random() * 1.4 + 0.4);
      setV(Math.min(targetSoft, v + delta));
    }

    // se tutte le parti base sono pronte, vai a 100
    const allReady = marks.jobs && marks.cloud && marks.weather;
    if(allReady){
      // dopo un minimo di tempo, completa
      if(elapsed >= minShowMs){
        const jump = Math.random() * 6 + 10;
        setV(Math.min(100, v + jump));
        if(v >= 99.2){
          setV(100);
          finish();
          return;
        }
      }
    }

    raf = requestAnimationFrame(tick);
  }

  function mark(which){
    if(which in marks) marks[which] = true;
  }

  function finish(){
    if(done) return;
    done = true;
    try{ cancelAnimationFrame(raf); }catch(_){}
    setV(100);
    setMsg("Pronto.");
    const el = overlay();
    if(!el) return;
    // lascia vedere 100% un attimo, poi nascondi
    setTimeout(() => {
      el.classList.add("hide");
      el.setAttribute("aria-hidden", "true");
    }, 260);
    setTimeout(() => {
      try{ el.remove(); }catch(_){}
    }, 900);
  }

  return { start, mark, finish };
})();

  Boot.start();

  // ===== CAMERA (solo mobile) =====
  // Incolla qui l’URL della tua telecamera/stream.
  // Esempi:
  //  - MJPEG: http://192.168.1.50:8080/video
  //  - Pagina web/iframe: https://...
  // Se lasci vuoto, resta il placeholder.
  const CAMERA_URL = "";

  function initCameraMobile(){
    try{
      const isMobile = window.matchMedia && window.matchMedia("(max-width: 900px)").matches;
      if(!isMobile) return;

      const url = (CAMERA_URL || "").trim();
      const ph = document.getElementById("camPlaceholder");
      const frame = document.getElementById("camFrame");
      const img = document.getElementById("camImg");
      if(!ph || !frame || !img) return;

      if(!url){
        ph.style.display = "flex";
        frame.style.display = "none";
        img.style.display = "none";
        return;
      }

      const isMjpeg = /\/video(\b|\?)|\.mjpg(\b|\?)|mjpeg/i.test(url);
      ph.style.display = "none";

      if(isMjpeg){
        img.src = url;
        img.style.display = "block";
        frame.style.display = "none";
      }else{
        frame.src = url;
        frame.style.display = "block";
        img.style.display = "none";
      }
    }catch(e){
      console.log("Camera init error:", e);
    }
  }

  initCameraMobile();

  // ===== Device identity + mobile exclusion =====
  const DEVICE_ID = (() => {
    try{
      const k = "tabellone_device_id";
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto?.randomUUID ? crypto.randomUUID() : ("dev_" + Math.random().toString(16).slice(2)));
        localStorage.setItem(k, v);
      }
      return v;
    }catch(_){
      return "dev_" + Math.random().toString(16).slice(2);
    }
  })();

  const IS_MOBILE = (() => {
    try{
      const ua = navigator.userAgent || "";
      const uaMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);
      const small = window.matchMedia && window.matchMedia("(max-width: 820px)").matches;
      return uaMobile || !!small;
    }catch(_){
      return false;
    }
  })();

  // Per evitare "riproduzioni" al primo caricamento
  const PLAYED_ANNOUNCEMENTS = new Set();

  let _ttsAudio = null;
  let _ttsAbort = null;
  let _ttsLastUrl = null;

  let _ttsRetryCount = 0;
  const _TTS_MAX_RETRY = 3;

  async function primeAudio(){
    // "Scalda" l'audio: se l'autoplay è consentito dal browser kiosk,
    // ElevenLabs partirà anche senza click dell'operatore.
    try{
      if(!_ttsAudio) _ttsAudio = new Audio();
      _ttsAudio.preload = "auto";
      _ttsAudio.volume = 0.0001; // quasi muto
      // wav vuoto (silenzio) per priming
      _ttsAudio.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=";
      await _ttsAudio.play();
      _ttsAudio.pause();
      _ttsAudio.currentTime = 0;
      _ttsAudio.volume = 1;
      console.log("Audio primed (autoplay ok).");
    }catch(e){
      console.log("Prime audio blocked:", e);
    }
  }

  function scheduleTTSRetry(msg){
    if(_ttsRetryCount >= _TTS_MAX_RETRY) return;
    _ttsRetryCount++;
    setTimeout(() => speak(msg), 900);
  }

  function stopTTS(){
    try{
      if(_ttsAbort) _ttsAbort.abort();
    }catch(_){}
    _ttsAbort = null;

    if(_ttsAudio){
      try{ _ttsAudio.pause(); _ttsAudio.currentTime = 0; }catch(_){}
    }
    if(_ttsLastUrl){
      try{ URL.revokeObjectURL(_ttsLastUrl); }catch(_){}
      _ttsLastUrl = null;
    }
  }

  async function speak(text){
    const msg = String(text || "").trim();
    if(!msg) return;

    // Se non hai messo la key, fallback su voce browser (più “semplice”)
    if(!ELEVENLABS_API_KEY){
      try{
        if("speechSynthesis" in window){
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(msg);
          u.lang = "it-IT";
          u.rate = 0.88;
          u.pitch = 0.90;
          window.speechSynthesis.speak(u);
        }
      }catch(_){}
      return;
    }

    stopTTS();
    _ttsAbort = new AbortController();

    try{
      const url = `https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(ELEVENLABS_VOICE_ID)}`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "xi-api-key": ELEVENLABS_API_KEY,
          "Content-Type": "application/json",
          "Accept": "audio/mpeg"
        },
        body: JSON.stringify({
          text: msg,
          model_id: ELEVENLABS_MODEL_ID,
          voice_settings: {
            stability: 0.62,
            similarity_boost: 0.82,
            style: 0.20,
            speed: 0.85,
            use_speaker_boost: true
          }
        }),
        signal: _ttsAbort.signal
      });

      if(!res.ok) throw new Error("ElevenLabs HTTP " + res.status);

      const buf = await res.arrayBuffer();
      const blob = new Blob([buf], { type: "audio/mpeg" });

      if(!_ttsAudio) _ttsAudio = new Audio();
      _ttsAudio.preload = "auto";
      _ttsAudio.volume = 1;

      _ttsLastUrl = URL.createObjectURL(blob);
      _ttsAudio.src = _ttsLastUrl;

      // Autoplay: in genere ok dopo un click (es: tasto OK / Annulla)
      await _ttsAudio.play();
    }catch(e){
      // Se il browser blocca l'autoplay (kiosk senza gesture), NON ripiegare sulla voce normale:
      // meglio ritentare (se autoplay è consentito, dopo il priming partirà).
      console.log("TTS error:", e);

      const errName = (e && e.name) ? String(e.name) : "";
      const errMsg  = (e && e.message) ? String(e.message) : "";

      const autoplayBlocked =
        /NotAllowedError/i.test(errName) ||
        /not allowed|gesture|autoplay/i.test(errMsg);

      if(autoplayBlocked){
        scheduleTTSRetry(msg);
        return;
      }

      // Se invece è un errore di rete/API, fallback sulla voce browser (meglio che niente)
      try{
        if("speechSynthesis" in window){
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(msg);
          u.lang = "it-IT";
          window.speechSynthesis.speak(u);
        }
      }catch(_){}
    }
  }

  const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // Ogni giorno ha la sua "stanza" (così si resetta automaticamente a mezzanotte)
  const TODAY = new Intl.DateTimeFormat("sv-SE",{timeZone:"Europe/Rome"}).format(new Date()); // YYYY-MM-DD (Italia)
  const producedCol = collection(db, "producedDays", TODAY, "items");

  // Doc id sicuro (niente "/")
  const keyToDocId = (key) => encodeURIComponent(key);

  // Stato cloud: key -> { qty, label, ts }
  const producedCloud = new Map();

  function markProducedCloud(key, qty, label, announce){
    const id = keyToDocId(key);
    const payload = {
      key, qty, label,
      ts: serverTimestamp()
    };

    // Annuncio (TTS) sincronizzato tra device (evita mobile via client-side)
    if(announce && announce.text){
      payload.announceText = String(announce.text);
      payload.announceBy = announce.by || DEVICE_ID;
      payload.announceClientMs = announce.clientMs || Date.now();
    }

    return setDoc(doc(producedCol, id), payload, { merge: true });
  }

  function unmarkProducedCloud(key){
    const id = keyToDocId(key);
    return deleteDoc(doc(producedCol, id));
  }

  // Render lista "completati" dal cloud
  function renderProducedFromCloud(){
    const list = document.getElementById("producedList");
    const empty = document.getElementById("producedEmpty");
    if(!list) return;

    list.innerHTML = "";
    if(!producedCloud.size){
      if(empty) empty.style.display = "";
      list.appendChild(empty);
      return;
    }
    if(empty) empty.style.display = "none";

    // ordina: più recenti in alto (ts può essere null appena scritto)
    const items = [...producedCloud.entries()].map(([key,v])=>({key,...v}));
    items.sort((a,b)=>{
      const ta = a.ts?.toMillis?.() ?? 0;
      const tb = b.ts?.toMillis?.() ?? 0;
      return tb - ta;
    });

    for(const it of items){
      const item = document.createElement("div");
      item.className = "prodItem";
      item.innerHTML = `
        <div class="prodText">${escapeHtml(it.label || it.key)} • <span class="prodQty">${escapeHtml(String(it.qty))}</span></div>
        <button class="undoBtn" type="button">Annulla</button>
      `;
      item.querySelector(".undoBtn")?.addEventListener("click", () => {
        const ok = window.confirm("Sicuro che vuoi annullare?");
        if(!ok) return;
        if(!IS_MOBILE) speak(`Annullato. ${it.label || it.key}.`);
        unmarkProducedCloud(it.key).catch(()=>{});
      });
      list.appendChild(item);
    }
  }

  function initFirestoreRealtime(){
    // Listener realtime: ogni device vede subito gli update
    let firstSnap = true;

    onSnapshot(producedCol, (snap) => {
      // 1) Gestione ANNUNCI (solo dopo il primo snapshot, per evitare autoplay "all'avvio")
      if(firstSnap){
        // segna come già visti gli annunci esistenti
        snap.forEach(d => {
          const v = d.data() || {};
          if(v?.announceClientMs){
            PLAYED_ANNOUNCEMENTS.add(d.id + "@" + v.announceClientMs);
          }
        });
        firstSnap = false;
        try{ Boot.mark('cloud'); }catch(_){}
      }else{
        try{
          for(const ch of snap.docChanges()){
            if(ch.type !== "added" && ch.type !== "modified") continue;
            const v = ch.doc.data() || {};
            if(!v?.announceText) continue;

            const token = ch.doc.id + "@" + (v.announceClientMs || "");
            if(PLAYED_ANNOUNCEMENTS.has(token)) continue;

            // Non far parlare i device mobile
            if(IS_MOBILE) { PLAYED_ANNOUNCEMENTS.add(token); continue; }

            // Evita doppia riproduzione sul device che ha cliccato OK
            if(v.announceBy && v.announceBy === DEVICE_ID) { PLAYED_ANNOUNCEMENTS.add(token); continue; }

            PLAYED_ANNOUNCEMENTS.add(token);
            speak(v.announceText);
          }
        }catch(e){
          console.log("announce handler error:", e);
        }
      }

      // 2) Stato cloud (completati) + render lista
      producedCloud.clear();
      snap.forEach(d => {
        const v = d.data() || {};
        if(v?.key) producedCloud.set(v.key, v);
      });
      renderProducedFromCloud();

      // Se ho già le righe renderizzate, aggiorna visibilità e "IN PRODUZIONE" senza aspettare il refresh CSV
      applyForcedStatuses();
});
  }

  // ===== App tabellone (CSV + UI) =====
  const REFRESH_MS = 60000;

  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbRcMc9ZdrJ0o7jCJZfyCeGuGD3pgxurwbxO6NO_2kizrkg0czCQYR3g0YmUyWffgyBkmBdNe9fiB/pub?output=csv";

  const WX_LAT = 45.2153;
  const WX_LON = 11.1462;
  const WX_TZ  = "Europe/Rome";
  const WX_REFRESH_MS = 10 * 60 * 1000; // 10 minuti

  let inFlight = false;
  let lastHash = "";
  let lastJobs = [];
  const rowNodes = new Map();

  // avvia sync realtime con Firestore
  initFirestoreRealtime();

  // --- produzione CLOUD (sincronizzata) ---
let pendingKey = null;

function showModalForRow(rowEl){
  const key = rowEl.dataset.key;
  if(!key) return;

  // blocca doppio inserimento
  if(producedCloud.has(key)) return;

  pendingKey = key;
  const sub = document.getElementById("qtyModalSub");
  const input = document.getElementById("qtyInput");
  const modal = document.getElementById("qtyModal");

  sub.textContent = (rowEl.dataset.label || "Riga selezionata");
  input.value = "";
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");

  setTimeout(()=>{ input.focus(); input.select(); }, 40);
}

function closeModal(){
  const modal = document.getElementById("qtyModal");
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
  pendingKey = null;
}

async function confirmProduced(){
  if(!pendingKey) return;
  const input = document.getElementById("qtyInput");
  const qtyRaw = (input.value || "").trim().replace(",", ".");
  const qty = Number(qtyRaw);

  if(!Number.isFinite(qty) || qty <= 0){
    input.focus();
    input.select();
    return;
  }

  const rowEl = rowNodes.get(pendingKey);
  if(!rowEl){ closeModal(); return; }

  const label = rowEl.dataset.label || "Riga prodotta";

  // Scrive su Firestore: tutti i device aggiornano in tempo reale
  try{
    // TTS: messaggio "industriale" (più lento)
// Prossimo prodotto = prima riga non completata (escluso quello appena completato)
let nextLabel = "";
try{
  for(let i=0;i<lastJobs.length;i++){
    const k = makeKey(lastJobs[i], i);
    if(k === pendingKey) continue;
    if(producedCloud.has(k)) continue;
    nextLabel = (`${lastJobs[i].product} • ${lastJobs[i].format}`).replace(/\s+/g,' ').trim();
    if(nextLabel) break;
  }
}catch(_){}

const msg = nextLabel
  ? `Operazione completata. Registrati ${qty} pezzi: ${label}. Prossimo prodotto in coda: ${nextLabel}. Buon lavoro.`
  : `Operazione completata. Registrati ${qty} pezzi: ${label}. Buon lavoro.`;

// Scrive su Firestore + include annuncio per gli altri device
await markProducedCloud(pendingKey, qty, label, {
  text: msg,
  by: DEVICE_ID,
  clientMs: Date.now()
});

// UI immediata sul device corrente (senza aspettare snapshot/refresh)
try{
  producedCloud.set(pendingKey, { key: pendingKey, qty, label, ts: null });
  renderProducedFromCloud();
  applyForcedStatuses();
}catch(_){}

// Sul device corrente: riproduci solo se NON mobile
if(!IS_MOBILE) speak(msg);
  }catch(e){
    console.log("Firestore write error:", e);
  }finally{
    closeModal();
  }
}
// utility: escaping sicuro per HTML
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }


  const debugEl = document.getElementById("debug");

  // --- bind modal buttons ---
  const qtyCancelBtn = document.getElementById("qtyCancel");
  const qtyOkBtn = document.getElementById("qtyOk");
  const qtyModal = document.getElementById("qtyModal");
  const qtyInput = document.getElementById("qtyInput");

  qtyCancelBtn?.addEventListener("click", closeModal);
  qtyOkBtn?.addEventListener("click", confirmProduced);

  qtyModal?.addEventListener("click", (e) => {
    if(e.target === qtyModal) closeModal();
  });

  qtyInput?.addEventListener("keydown", (e) => {
    if(e.key === "Enter") confirmProduced();
    if(e.key === "Escape") closeModal();
  });

  function dbg(msg){ debugEl.textContent = msg + "   |   BUILD: 2025-12-16 22:52:19 UTC"; }

  function stableHash(jobs){
    return jobs.map(j => [j.product,j.qty,j.unit,j.format,j.status].join("|")).join("§");
  }

  function tickClock(){
    const now = new Date();
    document.getElementById("timeIT").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("timeCN").textContent =
      new Intl.DateTimeFormat("zh-CN",{timeZone:"Asia/Shanghai",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("dateLine").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(now);
  }

  function parseCSV(text){
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;

    for(let i=0;i<text.length;i++) {
      const ch = text[i];
      if(ch === '"') {
        if(inQ && text[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ) {
        row.push(cur); cur="";
      } else if(ch === "\n" && !inQ) {
        row.push(cur); rows.push(row);
        row = []; cur="";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    rows.push(row);
    return rows;
  }

  async function loadJobsCSV(){
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status + " leggendo CSV");
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(v => (v||"").trim() !== ""));
    if(rows.length <= 1) return [];

    const header = rows[0].map(x => (x||"").trim().toLowerCase());
    const idx = {
      product: header.indexOf("product") !== -1 ? header.indexOf("product") : 0,
      qty: header.indexOf("qty") !== -1 ? header.indexOf("qty") : 1,
      unit: header.indexOf("unit") !== -1 ? header.indexOf("unit") : 2,
      format: header.indexOf("format") !== -1 ? header.indexOf("format") : 3,
      status: header.indexOf("status") !== -1 ? header.indexOf("status") : 4,
    };

    const jobs = [];
    for(let i=1;i<rows.length;i++) {
      const r = rows[i];
      const job = {
        product: (r[idx.product] ?? "").trim(),
        qty: (r[idx.qty] ?? "").trim(),
        unit: (r[idx.unit] ?? "").trim(),
        format: (r[idx.format] ?? "").trim(),
        status: (r[idx.status] ?? "").trim(),
      };
      if(!(job.product || job.qty || job.format || job.status)) continue;
      jobs.push(job);
    }
    return jobs;
  }

  function ensureRowEl(){
    const el = document.createElement("div");
    el.className = "row";
    el.innerHTML = `
      <div class="product"></div>
      <div class="qtyFmt">
        <div class="qty"></div>
        <div class="fmt"></div>
      </div>
      <div class="statusWrap">
        <span class="badge">
          <span class="dot"></span>
          <span class="stWrap"><span class="st"></span></span>
        </span>
      </div>
    `;
    return el;
  }

  function updateRowEl(el, job){
    el.querySelector(".product").textContent = job.product;
    el.querySelector(".qty").textContent = `${job.qty} ${job.unit}`.trim();
    el.querySelector(".fmt").textContent = job.format;

    const badge = el.querySelector(".badge");
    const stSpan = el.querySelector(".st");
    const st = (job.status || "").toUpperCase();
    const isTodo = st.includes("DA") || st.includes("IN PRODUZIONE");
    const isWip  = st.includes("IN PRODUZIONE");

    badge.classList.toggle("todo", isTodo);
    badge.classList.toggle("done", !isTodo);
    badge.classList.toggle("blink", isTodo);
    badge.classList.toggle("wip", isWip);
    stSpan.textContent = job.status || "";

  // "DA PRODURRE" diventa un tasto: inserisci quantità prodotta e nascondi la riga (locale)
badge.classList.toggle("btn", isTodo || st.includes("IN PRODUZIONE"));
badge.onclick = null;

if (isTodo || st.includes("IN PRODUZIONE")) {
  badge.title = "Segna come completato";
  badge.onclick = () => showModalForRow(el);
} else {
  badge.title = "";
}
  }

  function makeKey(job, idx){ return `${job.product}::${job.format}::${idx}`; }

  // Applica lo stato "IN PRODUZIONE" alla prima riga NON completata, senza aspettare il refresh del CSV.
  // (Serve quando segni completato X: Y deve diventare subito "IN PRODUZIONE".)
  function applyForcedStatuses(){
    if(!lastJobs || !lastJobs.length) return;

    // prima riga attiva = prima NON presente nei completati cloud
    let firstActiveIdx = -1;
    for(let i=0;i<lastJobs.length;i++){
      const k = makeKey(lastJobs[i], i);
      if(!producedCloud.has(k)) { firstActiveIdx = i; break; }
    }

    for(let i=0;i<lastJobs.length;i++){
      const k = makeKey(lastJobs[i], i);
      const el = rowNodes.get(k);
      if(!el) continue;

      el.dataset.key = k;
      el.dataset.label = (`${lastJobs[i].product} • ${lastJobs[i].format}`).replace(/\s+/g,' ').trim();

      if(producedCloud.has(k)){
        el.style.display = "none";
        continue;
      }
      el.style.display = "";

      const forcedStatus = (i === firstActiveIdx) ? "IN PRODUZIONE" : "DA PRODURRE";
      updateRowEl(el, { ...lastJobs[i], status: forcedStatus });
    }
  }

  function renderSoft(jobs){
    const rows = document.getElementById("rows");
    const seen = new Set();

    // La riga "IN PRODUZIONE" deve essere sempre la prima VISIBILE (non già completata)
    let firstActiveIdx = -1;
    for(let i=0;i<jobs.length;i++){
      const k = makeKey(jobs[i], i);
      if(!producedCloud.has(k)) { firstActiveIdx = i; break; }
    }

    jobs.forEach((job, idx) => {
      const key = makeKey(job, idx);
      seen.add(key);

      let el = rowNodes.get(key);
      if(!el) {
        el = ensureRowEl();
        rowNodes.set(key, el);
        rows.appendChild(el);
      } else {
        const cur = rows.children[idx];
        if(cur !== el) rows.insertBefore(el, cur || null);
      }

      // dataset per azioni locali
      el.dataset.key = key;
      el.dataset.label = (`${job.product} • ${job.format}`).replace(/\s+/g,' ').trim();

      // se già marcata come completata localmente, resta nascosta anche dopo refresh
      if(producedCloud.has(key)) {
        el.style.display = "none";
      } else {
        el.style.display = "";
      }
      // FORZA STATO TASTO: la prima riga VISIBILE = IN PRODUZIONE, tutte le altre = DA PRODURRE
      const forcedStatus = (idx === firstActiveIdx) ? "IN PRODUZIONE" : "DA PRODURRE";
      updateRowEl(el, { ...job, status: forcedStatus });
    });

    for(const [key, el] of rowNodes.entries()) {
      if(!seen.has(key)) {
        el.remove();
        rowNodes.delete(key);
      }
    }

    if(jobs.length === 0) {
      rows.innerHTML = "";
      rowNodes.clear();
      const el = ensureRowEl();
      updateRowEl(el, {product:"Nessun dato", qty:"—", unit:"", format:"—", status:"CONTROLLA SHEET"});
      el.querySelector(".badge").classList.add("todo","blink");
      rows.appendChild(el);
    }
  }

  async function refreshJobs(){
    if(inFlight) return;
    inFlight = true;
    try {
      dbg("Carico dati…");
      const jobs = await loadJobsCSV();
      lastJobs = jobs;
      const h = stableHash(jobs);
      if(h !== lastHash) { lastHash = h; renderSoft(jobs); }
      dbg("OK • aggiornato " + new Date().toLocaleTimeString("it-IT"));
    } catch(e) {
      renderSoft([{product:"Errore lettura sheet", qty:"—", unit:"", format:(e && e.message ? e.message : String(e)), status:"DA PRODURRE"}]);
      dbg("ERRORE • " + (e && e.message ? e.message : String(e)));
    } finally {
      inFlight = false;
      try{ Boot.mark('jobs'); }catch(_){}
    }
  }

  const WCODE = {
    0:"Sereno", 1:"Preval. sereno", 2:"Parz. nuvoloso", 3:"Nuvoloso",
    45:"Nebbia", 48:"Brina/nebbia",
    51:"Pioviggine", 53:"Pioviggine", 55:"Pioviggine",
    61:"Pioggia", 63:"Pioggia", 65:"Pioggia forte",
    71:"Neve", 73:"Neve", 75:"Neve forte",
    80:"Rovesci", 81:"Rovesci", 82:"Rovesci forti",
    95:"Temporale", 96:"Temporale", 99:"Temporale"
  };
  function wdesc(code){ return WCODE[code] || ("Meteo " + code); }

  async function refreshWeather(){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code,wind_speed_10m&hourly=precipitation_probability&timezone=${encodeURIComponent(WX_TZ)}&t=${Date.now()}`;
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Meteo HTTP " + res.status);
    const j = await res.json();

    const temp = j?.current?.temperature_2m;
    const code = j?.current?.weather_code;
    const wind = j?.current?.wind_speed_10m;

    let p = null;
    const times = j?.hourly?.time || [];
    const probs = j?.hourly?.precipitation_probability || [];
    if(times.length && probs.length){
      const nowIso = new Date().toISOString().slice(0,13);
      let idx = times.findIndex(t => t.startsWith(nowIso));
      if(idx < 0) idx = 0;
      p = probs[idx];
    }

    document.getElementById("wTemp").textContent = (temp ?? "--") + "°";
    document.getElementById("wDesc").textContent = wdesc(code);
    document.getElementById("wWind").textContent = (wind ?? "—");
    document.getElementById("wRain").textContent = (p ?? "—");
    document.getElementById("wUpdated").textContent = "Agg. " + new Date().toLocaleTimeString("it-IT");

    try{ Boot.mark("weather"); }catch(_){}
  }

  primeAudio();

  tickClock();
  setInterval(tickClock, 1000);

  refreshJobs();
  setInterval(refreshJobs, REFRESH_MS);

  refreshWeather().catch(()=>{ document.getElementById("wDesc").textContent="Meteo non disponibile"; });
  setInterval(() => refreshWeather().catch(()=>{}), WX_REFRESH_MS);
</script>
</body>
</html>
