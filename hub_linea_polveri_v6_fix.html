<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <title>HUB LINEA POLVERI</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg0:#ffffff;
      --bg1:#ffffff;
      --panel: #ffffff;
      --panel2: #ffffff;
      --line: rgba(0,0,0,.08);
      --text:#0b0b0f;
      --muted: rgba(0,0,0,.55);
      --accent:#007aff;
      --ok:#34c759;
      --warn:#ff9500;
      --danger:#ff3b30;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --r: 18px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg0);
      overflow-x:hidden;
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
    }
    /* blocca scroll/swipe sotto i popup */
    body.noScroll{
      position: fixed;
      left: 0; right: 0;
      width: 100%;
      overflow: hidden;
      overscroll-behavior: none;
    }
    .wrap{ max-width: 1320px; margin: 0 auto; padding: 14px 14px 26px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: #fff;
      box-shadow: var(--shadow);
            position: sticky; top: 10px; z-index: 5;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .t{ font-size: 15px; letter-spacing:.8px; font-weight: 800; text-transform: uppercase; }
    .brand .s{ font-size: 12px; color: var(--muted); }
    .statusRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--warn); box-shadow: 0 0 0 3px rgba(255,214,109,.14); }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(77,255,179,.14); }
    .dot.bad{ background: var(--danger); box-shadow: 0 0 0 3px rgba(255,77,109,.14); }
    .mono{ font-family: var(--mono); }
    .metaNum{ font-family: var(--sans); font-variant-numeric: tabular-nums; font-feature-settings: "tnum"; letter-spacing: .2px; }
    .btn{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(122,215,255,.38); background: rgba(255,255,255,.085); }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn.primary{ background: var(--accent); border-color: rgba(0,0,0,.08); color: #fff; }
    .btn.ghost{ background: rgba(0,0,0,.16); }
    .btn.danger{ background: rgba(255,77,109,.12); border-color: rgba(255,77,109,.22); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 3fr 1.25fr;
      gap: 12px;
      align-items:start;
    }
    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 140px;
    }
    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(122,215,255,.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
    }
    .cardHead .h{ font-weight: 900; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    .cardHead .sub{ margin-top:3px; font-size: 12px; color: var(--muted); line-height: 1.25; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding: 10px 14px 12px; border-bottom: 1px solid rgba(122,215,255,.10); background: rgba(255,255,255,.03); }
    .tab{ padding: 9px 12px; border-radius: 999px; border:1px solid rgba(122,215,255,.18); background: rgba(0,0,0,.14); font-weight:800; font-size: 12px; cursor:pointer; color: var(--muted); }
    .tab.on{ background: rgba(122,215,255,.18); color: var(--text); border-color: rgba(122,215,255,.34); }
    .list{ padding: 10px 12px 14px; max-height: 62vh; overflow:auto; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 14px 12px;
      border-bottom: 1px solid rgba(0,0,0,.08);
      background: transparent;
      margin: 0;
    }
    .row:hover{ background: rgba(0,0,0,.03); }
    .row .l{ min-width: 0; flex: 1; }
    .row .t{ font-weight: 900; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row .m{ font-size: 12px; color: var(--muted); margin-top:3px; display:flex; gap:10px; flex-wrap:wrap; }

    /* Meta line (no pill boxes) */
    .metaLine{ font-size: 12px; color: var(--muted); margin-top: 5px; line-height: 1.25; }
    .metaLine .sep{ opacity:.6; padding: 0 6px; }
    .metaLink{ appearance:none; border:0; background:transparent; padding:0; margin:0; color: var(--accent); font-weight: 800; cursor:pointer; }
    .metaLink:hover{ text-decoration: underline; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border: 0;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      color: rgba(0,0,0,.75);
      background: rgba(0,0,0,.06);
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(77,255,179,.22); background: rgba(77,255,179,.10); color: rgba(234,247,255,.92); }
    .badge.warn{ border-color: rgba(255,214,109,.22); background: rgba(255,214,109,.10); color: rgba(234,247,255,.92); }
    .badge.danger{ border-color: rgba(255,77,109,.22); background: rgba(255,77,109,.10); color: rgba(234,247,255,.92); }
    .rightCol{ display:flex; flex-direction:column; gap: 12px; }
    .smallList{ padding: 10px 12px 14px; max-height: 30vh; overflow:auto; }
    .smallRow{ padding: 10px 10px; border: 1px solid rgba(122,215,255,.12); border-radius: var(--r2); background: rgba(255,255,255,.05); margin-bottom: 10px; }
    .smallRow .t{ font-weight: 900; font-size: 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .smallRow .m{ margin-top:4px; font-size: 12px; color: var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .empty{ opacity:.65; font-size: 12px; padding: 8px 2px; }
    .summary{
      padding: 12px 14px 14px;
      display:flex; flex-direction:column; gap: 10px;
    }
    .summaryGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi{ border:1px solid rgba(122,215,255,.14); background: rgba(255,255,255,.05); border-radius: var(--r2); padding: 10px 10px; }
    .kpi .k{ font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing:.6px; }
    .kpi .v{ margin-top:4px; font-weight: 950; font-size: 16px; }
    .kpi .v.small{ font-size: 13px; font-weight: 850; }
    .footBtns{ display:flex; gap: 8px; flex-wrap:wrap; }
    .muted{ color: var(--muted); }

    /* Modal */
    .modal{ position: fixed; inset: 0; display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50; background: rgba(0,0,0,.35); }
    .modal.show{ display:flex; }
    .box{ width: min(980px, 100%); max-height: 86vh; overflow:hidden; border-radius: 18px; border:1px solid rgba(0,0,0,.10); background: #fff; box-shadow: 0 20px 80px rgba(0,0,0,.18); }
    .boxHead{ padding: 14px 14px; border-bottom: 1px solid rgba(122,215,255,.16); display:flex; justify-content:space-between; gap: 10px; align-items:flex-start; }
    .boxHead .h{ font-weight: 950; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    .boxHead .s{ margin-top:3px; font-size: 12px; color: var(--muted); }
    .boxBody{ padding: 12px 12px 14px; overflow:auto; max-height: calc(86vh - 112px); }

    /* IA full-screen sheet */
    #iaModal{ padding: 0; }
    #iaModal .sheet{
      width: 100%; height: 100%;
      background: #fff;
      border-radius: 0;
      overflow: hidden;
      display:flex; flex-direction:column;
      box-shadow: none;
      border: 0;
    }
    #iaModal .sheetHead{
      padding: 14px 14px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
    }
    #iaModal .sheetHead .h{ font-weight: 950; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    #iaModal .sheetHead .sub{ margin-top:3px; font-size: 12px; color: var(--muted); }
    #iaModal .iaBody{ flex: 1; overflow:auto; -webkit-overflow-scrolling: touch; }
    #iaModal .iaBar{ background: rgba(255,255,255,.92); backdrop-filter: blur(12px); }
    #iaModal input[type="text"]{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      outline: none;
      font-size: 15px;
    }
    #iaModal .iaInputRow{ display:flex; gap:10px; align-items:center; }
    #iaModal .iaInputRow .btn{ white-space:nowrap; }
    .lineRow{
      display:grid;
      grid-template-columns: 34px 1.1fr .55fr .55fr .55fr;
      gap: 10px;
      padding: 10px 10px;
      border:1px solid rgba(122,215,255,.12);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      margin-bottom: 10px;
      align-items:center;
    }
    .chk{ display:flex; justify-content:center; }
    .lineMain{ min-width:0; }
    .lineMain .t{ font-weight: 900; font-size: 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lineMain .m{ margin-top:4px; font-size: 12px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
    .col{ font-family: var(--mono); font-size: 12px; color: rgba(0,0,0,.70); }
    .boxActions{ display:flex; justify-content:space-between; gap: 10px; padding: 12px 12px calc(14px + env(safe-area-inset-bottom)); border-top: 1px solid rgba(122,215,255,.16); align-items:center; background:#fff; }
    .sigChk{ display:flex; gap: 8px; align-items:center; font-weight: 800; font-size: 12px; }
    .canvas{
      width:100%; height: 180px;
      border-radius: 16px;
      border: 1px solid rgba(122,215,255,.20);
      background: #ffffff;
      touch-action: none;
    }

    /* Mobile */
    @media (max-width: 900px){
      .wrap{ padding: 12px 12px 24px; }
      .grid{ grid-template-columns: 1fr; }
      .list{ max-height: none; }
      .smallList{ max-height: none; }
      .summaryGrid{ grid-template-columns: 1fr; }
      .lineRow{ grid-template-columns: 34px 1fr; }
      .col{ grid-column: 2; }
      .row .m{ gap:8px; }
      .topbar{ position: static; top: auto; }
      #mobileSummaryCard{ display:block; }
    }
    @media (min-width: 901px){
      #mobileSummaryCard{ display:none; }
    }
  
    .btn.accent{ background: var(--accent); border-color: rgba(0,0,0,.10); color: #fff; }
    .btn.ok{ border-color: rgba(77,255,179,.55); background: rgba(77,255,179,.16); color: var(--text); }
    .btn.big{ padding:14px 14px; font-size:15px; line-height:1.15; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ padding:8px 10px; border-radius: 999px; border:1px solid var(--line); background: rgba(255,255,255,.04); cursor:pointer; user-select:none; }
    .chip.on{ border-color: rgba(122,215,255,.7); background: rgba(122,215,255,.16); }
    .iaBody{ padding: 14px; }
    .iaQ{ font-size: 15px; font-weight: 700; margin-bottom: 10px; }
    .iaBtns{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 520px){ .iaBtns{ grid-template-columns: 1fr; } }
    .pickList .row{ cursor: default; }
    .iaBar{ position: sticky; bottom: 0; margin-top: 12px; padding-top: 10px; border-top:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px; background: rgba(255,255,255,.92); backdrop-filter: blur(10px); }
    .iaBar .actions{ display:flex; gap:8px; }

    /* IA full-screen sheet */
    #iaModal{ padding:0; }
    #iaModal .sheet{ width:100%; height:100%; background:#fff; border-radius:0; overflow:hidden; border:0; box-shadow:none; display:flex; flex-direction:column; }
    #iaModal .sheetHead{ padding: 14px 14px; border-bottom: 1px solid var(--line); display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; }
    #iaModal .sheetHead .h{ font-weight: 950; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    #iaModal .sheetHead .sub{ margin-top:3px; font-size: 12px; color: var(--muted); line-height: 1.25; }
    #iaModal .iaBody{ flex: 1; overflow:auto; padding: 14px; }
    .iaInputRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .iaInput{ flex: 1; min-width: 220px; padding: 12px 12px; border-radius: 14px; border: 1px solid var(--line); font-size: 14px; }
    @media (max-width: 900px){
      .wrap{ padding: 10px 10px 18px; }
      .topbar{ flex-direction: column; align-items: flex-start; gap: 10px; }
      .brand .t{ font-size: 18px; letter-spacing: .6px; }
      .statusRow{ width: 100%; flex-wrap: wrap; gap: 8px; }
      .pill{ font-size: 13px; }
      .btn{ font-size: 14px; padding: 10px 12px; }
      input, select, textarea{ font-size: 16px !important; }
      .grid{ grid-template-columns: 1fr; gap: 12px; }
      .rightCol{ display: contents; } /* stack */
      #ordersCard{ order: 1; }
      #doneCard{ order: 2; }
      #summaryCard{ order: 3; }
      #mobileSummaryCard{ order: 4; }
      #btnIA2{ display:none !important; }
      .tabs{ overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .tab{ flex: 0 0 auto; font-size: 14px; padding: 10px 12px; }
      .card{ border-radius: 18px; }
      .h{ font-size: 18px; }
      .sub{ font-size: 13px; }
      .summaryGrid{ grid-template-columns: 1fr 1fr; gap: 10px; }
      .kpi .v{ font-size: 20px; }
      #mobileSummaryCard .summaryGrid{ grid-template-columns: 1fr 1fr; }
      #mobileSummaryCard .h{ font-size: 17px; }
      #mobileSummaryCard .sub{ font-size: 14px; }
    }

  
    .clickable{ cursor: pointer; }
    .sec{ margin-top: 10px; }
    .secHead{ margin: 12px 0 6px; font-size: 11px; letter-spacing: .14em; color: var(--muted); }
    .check{ display:flex; align-items:center; margin-right:10px; }
    .check input{ width:18px; height:18px; }
    .check span{ display:none; }

  
    /* --- Mobile iPhone: più grande e leggibile --- */
    @media (max-width: 520px){
      body{ font-size: 16px; }
      .wrap{ padding: 10px 10px 90px; }
      .card{ border-radius: 18px; }
      .tabs{ gap: 8px; }
      .tab{ padding: 10px 12px; font-size: 14px; }
      .row{ padding: 14px 12px; }
      .row .t{ font-size: 16px; }
      .row .m{ font-size: 13px; }
      .badge{ font-size: 12px; padding: 6px 8px; }
      .fabbar{ padding: 10px; }
      .btn{ padding: 12px 12px; font-size: 14px; }
      .kpi .v{ font-size: 28px; }
    }


    /* === CONTRAST (nero su bianco) + touch === */
    .pill{ background:#fff; color:#000; border-color: rgba(0,0,0,.18); }
    .pill .mono{ color:#000; }
    .btn{ background:#fff; color:#000; border-color: rgba(0,0,0,.18); }
    .btn:hover{ background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.28); }
    .btn.ghost{ background:#fff; }
    .tab{ background:#fff; color:#000; border:1px solid rgba(0,0,0,.14); }
    .tab.on{ background: rgba(0,122,255,.10); border-color: rgba(0,122,255,.30); }
    .chip{ background:#fff; color:#000; border-color: rgba(0,0,0,.14); }
    .badge{ background: #f2f3f5; color:#000; border:1px solid rgba(0,0,0,.12); }
    .badge.ok{ background: #d7fbe3; color:#000; border:1px solid rgba(0,0,0,.12); }
    .badge.warn{ background: #fff2c7; color:#000; border:1px solid rgba(0,0,0,.12); }
    .badge.danger{ background: #ffd7d7; color:#000; border:1px solid rgba(0,0,0,.12); }
    .metaLine, .row .m{ color: rgba(0,0,0,.72); }
    .col{ color: rgba(0,0,0,.80); }

    /* Riquadri secondari sempre pieni (no trasparenze) */
    .smallRow{ background:#fff; border-color: rgba(0,0,0,.10); }
    .kpi{ background:#fff; border-color: rgba(0,0,0,.10); }
    .tabs{ background:#fff; }

    /* Mobile: dettagli più grandi */
    @media (max-width: 900px){
      .row .m{ font-size: 14px; }
      .metaLine{ font-size: 14px; }
      .col{ font-size: 14px; }
      .lineMain .t{ font-size: 14px; }
    }
    @media (max-width: 520px){
      .row .m{ font-size: 14px; }
      .metaLine{ font-size: 14px; }
      .col{ font-size: 15px; }
      .lineMain .t{ font-size: 15px; }
    }

    /* Blocca scroll/swap sotto ai popup */
    body.modalLock{ overflow:hidden; position: fixed; width: 100%; }
    .modal{ overscroll-behavior: contain; }
    
    /* bring card to foreground (mobile feedback) */
    .card.bringFront{ position: relative; z-index: 6; box-shadow: 0 20px 60px rgba(0,0,0,.15); transform: translateZ(0); }

    /* Signature quantity box */
    .sigQtyBox{ display:none; /* spostato in Quantità Modal */
       margin: 10px 0 12px; padding: 12px; border: 1px solid rgba(0,0,0,.25); border-radius: 12px; background: #fff; }
    .sigQtyBox .qtyRow{ padding: 10px 10px; border: 1px solid rgba(0,0,0,.12); border-radius: 12px; margin-top: 8px; }
    .sigQtyBox .qtyRow .t{ font-weight: 900; font-size: 14px; color: #000; }
    .sigQtyBox .qtyRow .m{ margin-top: 4px; font-size: 12px; color: rgba(0,0,0,.72); }
    .sigQtyBox .qtyRow .q{ display:flex; gap:10px; align-items:center; margin-top: 8px; }
    .sigQtyBox input.qtyInput{ width: 160px; padding: 10px 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,.2); font-weight: 900; color:#000; background:#fff; }

    /* IA sub-rows (righe) */
    .iaSubRows{ margin: 8px 0 14px 44px; border-left: 2px solid rgba(0,0,0,.15); padding-left: 10px; }
    .iaLine{ padding: 10px 10px; border: 1px solid rgba(0,0,0,.12); border-radius: 12px; margin-top: 8px; background:#fff; }
    .iaLine .t{ font-weight: 900; color:#000; font-size: 13px; }
    .iaLine .metaLine{ color: rgba(0,0,0,.72); font-size: 12px; margin-top: 4px; }
    .miniBtn{ display:inline-flex; align-items:center; justify-content:center; padding: 6px 10px; border-radius: 10px; border:1px solid rgba(0,0,0,.25); background:#fff; color:#000; font-weight: 900; font-size: 12px; cursor:pointer; }

    /* === FULL SCREEN POPUP (tutti i popup) === */
    .modal.full .box{
      background:#fff;
      color:#000;
      width: 100vw !important;
      height: 100vh !important;
      max-width: 100vw !important;
      max-height: 100vh !important;
      border-radius: 0 !important;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .modal.full .boxBody{ max-height: calc(100vh - 130px) !important; }

    /* Taglia grande (mobile first) */
    .sizeBig{
      margin-top: 6px;
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .2px;
      color:#000;
    }
    @media (max-width: 520px){
      .sizeBig{ font-size: 18px; }
      .lineMain .t{ font-size: 17px !important; }
      .metaLine{ font-size: 15px !important; }
      .col{ font-size: 15px !important; }
    }

    /* Riga parzialmente completata (giallo attenzione) */
    .lineRow.partial{
      background: rgba(255, 193, 7, .22) !important;
      border-color: rgba(255, 193, 7, .55) !important;
    }
    .warnBadge{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,193,7,.25);
      border: 1px solid rgba(255,193,7,.55);
      font-weight: 950;
      color:#000;
    }

    /* Bottoni riga */
    .rowBtns{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      min-width: 160px;
    }
    .miniBtn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.20);
      background:#fff;
      font-weight: 950;
      color:#000;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .miniBtn:active{ transform: scale(.98); }

    /* Quantità modal */
    .qtyBox{
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
    }
    .qtyRow{
      padding: 12px;
      border: 1px solid rgba(0,0,0,.14);
      border-radius: 14px;
      margin-top: 10px;
      background:#fff;
    }
    .qtyRow .t{ font-weight: 950; font-size: 16px; color:#000; }
    .qtyRow .m{ margin-top:6px; font-size: 14px; color: rgba(0,0,0,.78); display:flex; gap:10px; flex-wrap:wrap; }
    .qtyRow .q{ display:flex; gap:12px; align-items:center; margin-top:10px; }
    input.qtyInput{
      width: 180px;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.22);
      font-weight: 950;
      font-size: 18px;
      color:#000;
      background:#fff;
    }
    @media (max-width: 520px){
      input.qtyInput{ width: 220px; font-size: 18px; }
    }

    /* Problemi box (prima della firma) */
    .problemsBox{
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
      margin-bottom: 12px;
    }
    .problemsLbl{ font-weight: 950; margin-bottom: 8px; color:#000; }
    .problemsTa{
      width: 100%;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      font-size: 16px; /* evita zoom iOS */
      color:#000;
      background:#fff;
    }

    /* Completati: togli trasparenze */
    .smallRow{ background:#fff !important; border-color: rgba(0,0,0,.18) !important; }
    .smallRow .t, .smallRow .m{ color:#000 !important; }
    .smallRow .m{ opacity: .85; }

    /* Fatturato admin: contrasto netto */
    #revBody .kpi, #revBody .row, #revBody table, #revBody th, #revBody td{ color:#000 !important; background:#fff; }
    #revBody .kpi{ border: 1px solid rgba(0,0,0,.16) !important; }
    #revBody .kpi .lbl{ color: rgba(0,0,0,.72) !important; }
    #revBody .kpi .v{ color:#000 !important; }

    /* Call button (always visible) */
    .callMatteo{
      position: fixed;
      right: 14px;
      bottom: calc(14px + env(safe-area-inset-bottom));
      z-index: 60;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 14px;
      border-radius: 999px;
      background: #000;
      color: #fff;
      font-weight: 900;
      letter-spacing: .2px;
      text-decoration: none;
      box-shadow: 0 18px 50px rgba(0,0,0,.22);
      touch-action: manipulation;
      user-select: none;
    }
    .callMatteo:active{ transform: scale(.98); }
    body.modalOpen .callMatteo{ display:none !important; }





    /* Filters button bar */
    .filtersBar{ display:flex; gap:10px; align-items:center; margin: 10px 0 6px; }
    .filtersBar .btn{ flex: 0 0 auto; }
    @media (max-width: 860px){
      .filtersBar{ margin: 12px 0 8px; }
      .filtersBar .btn{ padding: 12px 14px; font-size: 15px; }
    }

    /* Customer modal: ordine completo (solo una volta) */
    .docPickRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding: 6px 0 2px; }
    .docPick{
      flex: 1;
      min-width: 160px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      background:#fff;
      font-weight: 850;
      color:#000;
    }
    .docPick:focus{ outline: none; border-color: rgba(0,122,255,.45); box-shadow: 0 0 0 3px rgba(0,122,255,.12); }
    .docPickSec{ padding: 0 2px 10px; border-bottom: 1px solid rgba(0,0,0,.10); margin-bottom: 12px; }

    /* Fatturato teaser (sfocato) */
    #revTeaserCard .summary{ padding-top: 6px; }
    .revBlur{
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.04);
      padding: 14px 14px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
    }
    .revBlur::after{
      content:"";
      position:absolute; inset:0;
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .revBlurInner{
      position: relative;
      z-index: 1;
      filter: blur(1.2px);
    }
    .revBlurTitle{ font-weight: 950; letter-spacing:.3px; }
    .revBlurSub{ margin-top:6px; color: rgba(0,0,0,.65); font-weight: 800; font-size: 12px; }

</style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="t">Hub linea polveri</div>
        <div class="s">Gestione ordini + produzione • iPhone + Desktop</div>
      </div>
      <div class="statusRow">
        <div class="pill"><span class="dot" id="driveDot"></span><span id="driveTxt">Sistema: —</span></div>
        <div class="pill mono" id="clockTxt">—:—</div>
        <div class="pill" id="wxTxt">Meteo: —</div>
        <button class="btn primary" id="btnSync" type="button">Aggiorna ordini</button>
        <button class="btn accent" id="btnIA" type="button">IA intelligente</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="ordersCard">
        <div class="cardHead">
          <div>
            <div class="h">Ordini (XML)</div>
            <div class="sub" id="ordersSub">In attesa sync…</div>
          </div>
          <div class="actions">
            <button class="btn ghost" id="btnHelp" type="button">Info</button>
          </div>
        </div>

        
        <div class="filtersBar">
          <button class="btn primary" id="btnClienti" type="button">Clienti</button>
          <button class="btn ghost" id="btnFilters" type="button">Filtri</button>
        </div>

        <div class="tabs" id="tabsBar" role="tablist" aria-label="Viste" style="display:none;">
          <button class="tab" data-view="article" type="button">Per articolo</button>
          <button class="tab on" data-view="customer" type="button">Clienti</button>
          <button class="tab" data-view="size" type="button">Per formato</button>
          <button class="tab" data-view="product" type="button">Per prodotto</button>
          <button class="tab" data-view="other" type="button">Art. non pertinenti</button>
        </div>

        <div class="list" id="ordersList">
          <div class="empty">In attesa ordini…</div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card" id="doneCard">
          <div class="cardHead">
            <div>
              <div class="h">Completati</div>
              <div class="sub" id="doneSub">Sync cloud…</div>
            </div>
            <div class="actions">
              <button class="btn ghost" id="btnBackup" type="button">Backup PDF</button>
              <button class="btn danger" id="btnUndo" type="button">Annulla ultimo</button>
              <button class="btn danger" id="btnUndoAll" type="button">Annulla tutti</button>
            </div>
          </div>
          <div class="smallList" id="doneList">
            <div class="empty">Nessun completato.</div>
          </div>
        </div>

        <div class="card" id="summaryCard">
          <div class="cardHead">
            <div>
              <div class="h">Riepilogo produzione</div>
              <div class="sub"></div>
            </div>
          </div>
          <div class="summary">
            <div class="summaryGrid">
              <div class="kpi">
                <div class="k">Kg totali (polveri)</div>
                <div class="v" id="kpiKg">—</div>
              </div>
              <div class="kpi">
                <div class="k">Giorni stimati</div>
                <div class="v" id="kpiDays">—</div>
              </div>
              <div class="kpi">
                <div class="k">Rame</div>
                <div class="v small" id="kpiRame">—</div>
              </div>
              <div class="kpi">
                <div class="k">Zolfo</div>
                <div class="v small" id="kpiZolfo">—</div>
              </div>
              <div class="kpi">
                <div class="k">Caolino</div>
                <div class="v small" id="kpiCaolino">—</div>
              </div>
              <div class="kpi">
                <div class="k">Altro</div>
                <div class="v small" id="kpiAltro">—</div>
              </div>
            </div>
            <div class="footBtns">
              <button class="btn primary" id="btnRevenue" type="button" style="display:none;">Fatturato (admin)</button>
              <button class="btn accent" id="btnIA2" type="button">IA intelligente</button>
            </div>
            <div class="muted" style="font-size:12px;line-height:1.35;">
              I “giorni” sono calcolati sui kg totali ancora da completare (solo polveri), a 4000 kg/giorno.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile-only summary card at very bottom (always visible) -->
    <div class="card" id="mobileSummaryCard" style="margin-top:12px;">
      <div class="cardHead">
        <div>
          <div class="h">Per completare tutti gli ordini</div>
          <div class="sub" id="mobileSummaryTxt">ci vogliono — giorni</div>
        </div>
      </div>
      <div class="summary">
        <div class="summaryGrid">
          <div class="kpi"><div class="k">Rame</div><div class="v small" id="mRame">—</div></div>
          <div class="kpi"><div class="k">Zolfo</div><div class="v small" id="mZolfo">—</div></div>
          <div class="kpi"><div class="k">Caolino</div><div class="v small" id="mCaolino">—</div></div>
          <div class="kpi"><div class="k">Totale</div><div class="v small" id="mTotKg">—</div></div>
        </div>
      </div>
    </div>
  </div>


    <!-- Fatturato teaser (admin, sfocato) -->
    <div class="card" id="revTeaserCard" style="margin-top:12px;">
      <div class="cardHead">
        <div>
          <div class="h">Fatturato</div>
          <div class="sub">Area admin • tocca per sbloccare</div>
        </div>
      </div>
      <div class="summary">
        <div class="revBlur" id="revTeaser" role="button" tabindex="0" aria-label="Apri fatturato (admin)">
          <div class="revBlurInner">
            <div class="revBlurTitle">FATTURATO BLOCCATO</div>
            <div class="revBlurSub">Tocca qui → password → dettagli</div>
          </div>
        </div>
      </div>
    </div>

  <!-- Modal: righe cliente -->
  <div class="modal full" id="custModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="boxHead">
        <div>
          <div class="h" id="custTitle">Cliente</div>
          <div class="s" id="custSub">—</div>
        </div>
        <button class="btn ghost" id="custClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody" id="custBody"></div>
      <div class="boxActions">
        <div class="muted" style="font-size:12px;">Spunta le righe completate → firma → conferma</div>
        <div class="actions">
          <button class="btn ghost" id="custCancel" type="button">Annulla</button>
          <button class="btn primary" id="custConfirm" type="button" disabled>Conferma completati</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: firma -->
  <div class="modal full" id="sigModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" style="width:min(760px,100%);">
      <div class="boxHead">
        <div>
          <div class="h">Firma operatore</div>
          <div class="s" id="sigSub">—</div>
        </div>
        <button class="btn ghost" id="sigClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody">
        <label class="sigChk">
          <input type="checkbox" id="sigYes" />
          Dichiari di aver prodotto come si deve?
        </label>
        <div class="sigQtyBox" id="sigQtyBox"></div>

        <div style="height:10px;"></div>
        <canvas class="canvas" id="sigCanvas"></canvas>
        <div style="height:10px;"></div>
        <div class="actions" style="justify-content:flex-end;">
          <button class="btn ghost" id="sigClear" type="button">Pulisci</button>
        </div>
      </div>
      <div class="boxActions">
        <div class="muted" style="font-size:12px;">Obbligatorio: spunta + firma.</div>
        <div class="actions">
          <button class="btn ghost" id="sigCancel" type="button">Annulla</button>
          <button class="btn primary" id="sigOk" type="button">Salva completati</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: fatturato -->
  <div class="modal full" id="revModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" style="width:min(760px,100%);">
      <div class="boxHead">
        <div>
          <div class="h">Fatturato ordini (admin)</div>
          <div class="s">Totale per cliente • imponibile + IVA • dai Document in XML</div>
        </div>
        <button class="btn ghost" id="revClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody" id="revBody"></div>
    </div>
  </div>


  <!-- Modal: dettagli prodotto -->
  <div class="modal full" id="prodModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" style="width:min(820px,100%);">
      <div class="boxHead">
        <div>
          <div class="h" id="prodTitle">Dettagli prodotto</div>
          <div class="s" id="prodSub">Clienti + kg</div>
        </div>
        <button class="btn ghost" id="prodClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody" id="prodBody"></div>
    </div>
  </div>

  
  <!-- Quantità Modal (full screen) -->
  <div class="modal full" id="qtyModal" aria-hidden="true">
    <div class="box">
      <div class="boxHead">
        <div>
          <div class="boxTitle" id="qtyTitle">Quantità prodotta</div>
          <div class="boxSub" id="qtySub">Inserisci i kg prodotti per ogni riga selezionata.</div>
        </div>
        <button class="x" id="qtyClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="boxBody" id="qtyBody"></div>
      <div class="boxActions">
        <div class="muted">Suggerimento: puoi fare produzioni parziali.</div>
        <div style="display:flex; gap:10px;">
          <button class="btn" id="qtyBack">Indietro</button>
          <button class="btn primary" id="qtyNext" disabled>Conferma e firma</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Documento completo Modal (solo su richiesta) -->
  <div class="modal full" id="docModal" aria-hidden="true">
    <div class="box">
      <div class="boxHead">
        <div>
          <div class="boxTitle" id="docTitle">Ordine completo</div>
          <div class="boxSub" id="docSub"></div>
        </div>
        <button class="x" id="docClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="boxBody" id="docBody"></div>
      <div class="boxActions">
        <button class="btn primary" id="docOk">Chiudi</button>
      </div>
    </div>
  </div>

<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ===== Config sorgente ordini (XML) =====
    // Incolla qui la tua API key (API abilitata). La cartella deve essere almeno "Chiunque con link: Visualizza"
    const XML_PROXY_CFG = {
      proxyUrl: "https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",
      cacheKey: "EASYFATT_XML_CACHE_V1"
    };
    const ADMIN_PW = "12345"; // TODO: cambia quando vuoi

    // ===== Ordini manuali (foglio ordini) =====
    // Incolla qui l'URL CSV "pubblicato sul web" del tuo foglio ordini (solo 2 colonne: Nome prodotto, Quantità).
    // Esempio: https://docs.google.com/spreadsheets/d/ID/gviz/tq?tqx=out:csv&sheet=Foglio1
    const MANUAL_SHEET_CSV_URL = "";
    const MANUAL_POLL_MS = 120000;

    // ===== Master prodotti (da file ODS interno) =====
    // code => [powder(0/1), packKg|null, materialId]  materialId: 0=rame 1=zolfo 2=caolino 3=altro
    const PRODUCT_MASTER = {"00323":[1,1.0,3],"00325":[1,0.5,3],"510g":[1,10.0,0],"505g":[0,5.0,0],"tri1000":[0,1000.0,0],"00032":[0,1.0,3],"00033":[0,5.0,3],"1224":[0,0.5,0],"803":[0,1.0,0],"611":[0,10.0,0],"801":[0,5.0,0],"POLTI131":[1,1.0,0],"POLTI135":[1,5.0,0],"242":[1,1.0,0],"241":[1,5.0,0],"8001":[0,1.0,0],"8002":[0,10.0,0],"8000":[0,5.0,0],"840":[0,10.0,0],"841":[0,5.0,0],"843":[0,1.0,0],"1168":[0,10.0,0],"1166":[0,1.0,0],"1167":[0,5.0,0],"cuport1":[0,null,0],"cuport5":[0,null,0],"1172":[0,10.0,0],"1170":[0,1.0,0],"1171":[0,5.0,0],"00038":[0,1.0,3],"282":[0,20.0,0],"281":[1,5.0,0],"272":[1,1.0,0],"271":[1,5.0,0],"813":[0,1.0,0],"00626":[0,10.0,0],"2103":[0,5.0,0],"1165":[0,10.0,3],"1163":[0,1.0,3],"1164":[0,5.0,3],"851":[1,5.0,0],"852":[1,1.0,0],"861":[1,5.0,0],"862":[1,1.0,0],"261":[1,5.0,0],"262":[1,1.0,0],"1040":[1,1.0,0],"1045":[1,5.0,0],"251":[1,5.0,0],"252":[1,1.0,0],"823":[0,1.0,0],"822":[0,10.0,0],"821":[0,5.0,0],"00595":[1,5.0,1],"00618":[1,1.0,1],"00187":[0,10.0,0],"00329":[0,25.0,3],"tri1":[0,null,0],"tri5":[0,5.0,0],"tri0":[0,10.0,0],"00869":[0,10.0,0],"00805":[0,1.0,0],"00806":[0,5.0,0],"ZEORAME1":[1,1.0,0],"1051":[1,5.0,0],"511":[0,1.0,1],"510":[0,10.0,1],"512":[0,5.0,1],"1047":[0,1.0,1],"1044":[0,10.0,1],"1046":[0,5.0,1],"1042":[1,1.0,1],"1043":[1,5.0,1],"213":[1,1.0,1],"00731":[1,10.0,1],"211":[1,5.0,1],"899":[0,25.0,1],"602":[0,1.0,1],"600":[0,10.0,1],"601":[0,5.0,1],"1034":[1,1.0,2],"1035":[1,5.0,2],"benton1":[1,1.0,3],"00130":[0,25.0,3],"cao1":[1,1.0,2],"cao20":[0,20.0,2],"cao25":[0,25.0,2],"cao6":[1,6.0,2],"00624":[0,1.0,2],"00125":[0,5.0,2],"car1":[1,1.0,3],"C125":[0,25.0,3],"1195":[0,1.0,3],"1196":[0,5.0,3],"silgel1":[0,1.0,3],"SILGEL6":[0,6.0,3],"01139":[0,20.0,3],"zeo1":[1,1.0,3],"Zeo10":[1,10.0,3],"zeo5":[1,5.0,3],"zeo6":[1,6.0,3],"1183":[1,0.5,3],"acflowgel":[1,0.5,3],"ACQFLOW":[1,1.0,3],"1039":[0,1.0,3],"aqsolida10":[0,10.0,3],"aqsolida5":[0,5.0,3],"1108":[0,null,3],"1001FL":[0,1.0,3],"1010FEL":[0,10.0,3],"calcfl25":[0,10.0,3],"1005FL":[0,5.0,3],"101":[1,6.0,3],"1109":[0,null,3],"1235":[0,25.0,3],"00180":[0,1.0,3],"00181":[0,null,3],"00855":[0,null,3],"00857":[0,null,3],"00856":[0,null,3],"00188":[0,null,3],"00190":[0,null,3],"00189":[0,null,3],"00852":[0,null,3],"00854":[0,null,3],"00853":[0,null,3],"00858":[0,null,3],"00860":[0,null,3],"00859":[0,null,3],"1099":[0,null,3],"1101":[0,null,3],"1100":[0,null,3],"1048":[0,null,3],"ARA050":[0,null,3],"ARA5":[0,null,3],"coco1":[0,null,3],"coco10":[0,null,3],"coco5":[0,null,3],"00324":[0,null,3],"combi750":[0,null,3],"509spray":[0,null,1],"diat1":[0,1.0,3],"diat05":[0,0.5,3],"diat10":[1,10.0,3],"diat5":[1,5.0,3],"1031":[0,null,3],"1030":[0,null,3],"1032":[0,null,3],"ORTI75":[0,null,3],"1122":[0,1.0,3],"1123":[0,5.0,3],"1125":[1,null,0],"1124":[1,null,0],"On101":[0,null,3],"On100":[0,null,3],"on125":[0,null,3],"On105":[0,null,3],"olis1":[0,null,3],"olis10":[0,null,3],"olis5":[0,null,3],"1020":[0,null,3],"102010":[0,null,3],"10205":[0,null,3],"01093":[0,null,3],"1130":[0,1.0,3],"1131":[0,5.0,3],"ZINC1":[0,1.0,0],"ZINC5":[0,5.0,0],"00717":[1,5.0,3],"00718":[1,1.0,3],"00719":[0,1.0,3],"00721":[0,10.0,3],"00720":[0,5.0,3],"mag01":[0,1.0,3],"1022":[0,25.0,3],"mag01 5":[0,5.0,3],"MANZIN1":[0,1.0,3],"MANZIN5":[0,5.0,3],"ferro5":[1,5.0,3],"ferro25":[0,25.0,3],"144600":[0,25.0,3],"01099":[1,10.0,3],"1173":[1,1.0,3],"1175":[1,10.0,3],"1174":[1,5.0,3],"00088":[0,null,3],"00776":[0,null,3],"00780":[0,null,3],"00779":[0,null,3],"00782":[0,null,3],"00781":[0,null,0],"00784":[0,null,0],"00783":[0,null,3],"00778":[0,null,3],"00777":[0,null,3],"1118":[1,1.0,3],"1119":[1,5.0,3],"1120":[0,1.0,3],"1121":[0,5.0,3],"1178":[0,null,3],"1180":[0,null,3],"1179":[0,null,3],"1126":[0,null,3],"1200":[0,null,3],"1127":[0,null,3],"1159":[0,null,3],"1161":[0,null,3],"1160":[0,null,3],"1129":[0,5.7,3],"1128":[0,11.4,3],"1026":[0,22.8,3],"1028":[0,5.7,3],"mast1":[0,1.0,0],"Mast250":[1,0.25,0],"mast500":[0,0.5,0],"mast5":[0,5.0,0],"ACI1fla":[0,1.0,3],"ge1old":[0,1.2,3],"gra1old":[0,1.2,3],"AGR1fla":[0,1.0,3],"GER1fla":[0,1.0,3],"ORC1fla":[0,1.0,3],"GRA1fla":[0,1.0,3],"VER1fla":[0,1.0,3],"ROS1fla":[0,1.0,3],"UNI1fla":[0,1.0,3],"ECONUTRI10":[0,10.0,3],"ECONUTRI25":[0,25.0,3],"ECONUTRI5":[0,5.0,3],"1189":[0,1.0,3],"1191":[0,10.0,3],"1192":[0,25.0,3],"1190":[0,5.0,3],"00929":[0,10.0,3],"00861":[0,1.1,3],"npk25":[0,25.0,3],"npk05":[0,5.0,3],"AMIN1":[0,1.0,3],"amin25":[0,25.0,3],"00247":[0,null,3],"00236":[0,1.0,3],"00238":[0,null,3],"00231":[0,1.0,1],"00248":[0,null,1],"00239":[0,null,1],"00240":[0,null,3],"00249":[0,null,3],"00233":[0,1.0,3],"00241":[0,null,0],"00250":[0,null,0],"00232":[0,1.0,0],"00251":[0,null,3],"00242":[0,null,3],"00234":[0,1.0,3],"00186":[0,5.0,0],"00237":[0,1.0,0],"00243":[0,null,0],"00253":[0,null,0],"00230":[0,1.0,3],"00244":[0,null,3],"00321":[0,null,3],"00229":[0,1.0,3],"00245":[0,null,0],"00246":[0,null,1],"00327":[0,null,1],"00235":[0,1.0,1],"00274":[0,5.0,1],"1182":[1,1.0,3],"00694":[0,null,3],"00168":[0,null,3],"00694stiro":[0,null,3],"01138":[0,1.0,3],"drygel100":[0,null,3],"1105":[0,11.4,3],"1107":[0,22.8,3],"1106":[0,5.8,3],"00701":[0,null,3],"00724":[0,null,3],"00702":[0,null,3],"1025":[0,1.16,3],"1103":[0,11.4,3],"1104":[0,22.8,3],"1102":[0,5.8,3],"00628":[0,null,3],"00640":[0,null,3],"00667":[0,null,3],"00706":[0,null,3],"00704":[0,null,3],"00707":[0,null,3],"00786":[0,null,3],"00792":[0,null,3],"00705":[0,null,3],"1093":[0,1.0,0],"1095":[0,10.0,0],"1096":[0,25.0,0],"1094":[0,5.0,0],"1089":[0,1.0,0],"1091":[0,10.0,0],"1092":[0,25.0,0],"1090":[0,5.0,0],"MAGIC1":[0,null,3],"01040":[0,null,3],"01039":[0,null,3],"nano1":[0,null,3],"1227":[1,1.0,0],"plumber1":[0,1.0,3],"1049":[0,1.0,3],"1084":[0,1.0,3],"1086":[0,10.0,3],"1087":[0,25.0,3],"1085":[0,5.0,3],"1088":[0,1.0,3],"1184":[0,null,3],"1187":[0,null,3],"1186":[0,null,3],"1185":[0,null,3],"1057":[0,1.0,3],"1059":[0,10.0,3],"1061":[0,25.0,3],"1060":[0,5.0,3],"1063":[0,1.0,3],"1067":[0,10.0,3],"1068":[0,25.0,3],"1065":[0,5.0,3],"1069":[0,1.0,3],"1071":[0,10.0,3],"1072":[0,25.0,3],"1070":[0,5.0,3],"1074":[0,1.0,3],"1076":[0,10.0,3],"1077":[0,25.0,3],"1075":[0,5.0,3],"1062":[0,1.0,3],"1064":[0,1.0,3],"1073":[0,1.0,3],"1078":[0,1.0,3],"1079":[0,1.0,3],"1083":[0,1.0,3],"1081":[0,10.0,3],"1082":[0,25.0,3],"1080":[0,5.0,3],"01057":[0,null,3],"01058":[0,null,3],"01067":[0,null,3],"01068":[0,null,3],"01063":[0,null,3],"01064":[0,null,3],"1053":[0,null,3],"01062":[0,null,3],"1054":[0,null,3],"01060":[0,null,3],"01065":[0,null,3],"01066":[0,null,3],"01054":[0,null,3],"01055":[0,null,3],"01056":[0,null,3],"01051":[0,null,3],"01052":[0,null,3],"01073":[0,null,3],"1055":[0,null,3],"01069":[0,null,3],"01070":[0,null,3],"01071":[0,null,3],"1142":[0,null,3],"1141":[0,null,3],"1143":[0,null,3],"1140":[0,null,3],"1152":[0,null,3],"1155":[0,null,3],"1154":[0,null,3],"1153":[0,null,3],"1150":[0,null,3],"1149":[0,null,3],"1148":[0,null,3],"1151":[0,null,3],"1132":[0,null,3],"1134":[0,null,3],"1135":[0,null,3],"1133":[0,null,3],"1136":[0,null,3],"1138":[0,null,3],"1139":[0,null,3],"1137":[0,null,3],"1146":[0,null,3],"1144":[0,null,3],"1147":[0,null,3],"1145":[0,null,3],"1156":[0,null,3],"1157":[0,null,3],"1158":[0,null,3],"citric25":[0,null,3],"fosfo1":[0,10.0,3],"00629":[0,10.0,3],"alcol99":[0,null,3],"ksepsotop25":[1,null,3],"01078":[0,10.0,3],"00893":[0,5.0,3],"154366080940":[0,null,3],"095215":[0,25.0,0],"SODA25":[0,25.0,3],"123290":[0,25.0,0],"polti250":[0,null,0],"CALMAG250":[0,null,3],"citrus250":[0,null,3],"combi250":[0,null,3],"cupro250ml":[0,null,1],"ortic250":[0,null,3],"equi250":[0,null,3],"idro250":[0,null,0],"leci250":[0,null,3],"on1020":[0,null,3],"olis250":[0,null,3],"ossi250":[0,null,0],"1001250":[0,null,3],"zol250":[0,null,1],"121217":[0,5.0,3],"15915":[0,5.0,3],"5614":[0,4.0,3],"4810":[0,4.0,3],"AGRICOM03799":[1,1.0,3],"AGRICOM03798":[1,5.0,3],"00878 ALBINI":[1,4.0,3],"00811ALBINI":[0,1.0,1],"1233albini":[0,5.0,1],"512albini":[0,5.0,1],"on101albini":[0,null,3],"on10025albini":[0,null,3],"on1005albini":[0,null,3],"CONCIA17 ALBINI":[1,1.0,0],"262ALBINI":[1,1.0,0],"261ALBINI":[1,5.0,0],"251ALBINI":[1,5.0,0],"252ALBINI":[1,1.0,0],"823ALBINI":[0,1.0,0],"242ALBINI":[1,1.0,0],"241ALBINI":[1,5.0,0],"511ALBINI":[0,1.0,1],"1234albini":[0,5.0,1],"1020albini":[0,null,3],"1001albini":[0,null,3],"1005albini":[0,null,3],"841albini":[0,5.0,0],"602ALBINI":[0,1.0,1],"geco-1182":[1,1.0,3],"geco-watma-1kg":[0,1.0,3],"geco- bt-kg1":[1,1.0,2],"geco-bt-kg5":[1,5.0,2],"geco-bicsod-1kg":[1,1.0,3],"geco-bordopol-1kg":[1,1.0,3],"bordopol-5kg":[1,5.0,3],"GECO-CONACID-1L":[0,1.0,3],"GECO-CONSIPPIGER-1L":[0,1.0,3],"GECO-CONSIPPGRA-1L":[0,1.0,3],"GECO-CONSIPPIVER-1L":[0,1.0,3],"GECO-COMUNIV-1L":[0,1.0,3],"razo-1kg":[0,1.0,1],"1117b4green":[0,null,3],"GECO-JP-1":[0,null,3],"mast1b4green":[0,1.0,0],"mast500b4green":[0,0.5,0],"mast5b4green":[0,5.0,0],"RAMEGEL1B4GREEN":[0,1.0,0],"RAMEGEL10B4GREEN":[0,10.0,0],"geco-neem1":[0,null,3],"neem01b4green":[0,null,3],"geco-ram30-1kg":[1,1.0,0],"geco-ram50-1kg":[1,1.0,0],"1112b4green":[0,null,0],"1111b4green":[0,null,3],"1113b4green":[0,null,3],"geco-bluzol-1kg":[1,1.0,1],"geco-bluzol5kg":[1,5.0,1],"zolfo01b4green":[0,null,1],"geco-zolflo-5kg":[0,5.0,1],"lavorazionetrimix5kg":[0,5.0,3],"lavorazionetrimix":[0,1.0,3],"GCALOLUSC":[0,5.0,3],"GZEOPLUSCUSA05":[1,5.0,3],"GTRIMIXSA05":[0,5.0,3],"GZEMSA01":[1,1.0,3],"GZEUSSA05":[0,5.0,3],"VN-EPBH-N5SC":[0,null,3],"UN-R4L0-2J4U":[1,0.5,3],"TB-UQV4-J229":[1,1.0,3],"90-BUGV-9XNC":[1,1.0,3],"TS-Z31O-Q0AA":[0,null,3],"sapmolbionee250":[0,null,3],"6I-RIJ2-FLPB":[0,null,3],"R7-D0AU-G28C":[1,1.0,1],"XI-WPSS-E9MZ":[0,null,3],"23-nl0d-sq07":[0,null,3],"FD-G0RP-UUYN":[0,null,3],"B0-N6VF-4C18":[0,null,3],"MD-AWQD-IMOF":[0,1.0,3],"HP-U2C7-NMVK":[1,1.0,1],"LR-5JMZ-ECR1":[0,1.0,3],"FG-VR5X-K8I1":[0,1.0,3],"M1-YJ9P-6CRV":[0,null,3],"2B-FU36-GXM3":[0,null,3],"neem1bionee":[0,null,3],"neem250bionee":[0,null,3],"neem10bionee":[0,null,3],"neem5bionee":[0,null,3],"cao1bionee":[1,1.0,2],"7R-QVTB-49NO":[1,4.0,2],"OP-G57B-5V02":[0,null,2],"Y4-WEVJ-VE1V":[0,null,3],"M4-UPIS-H9Q0":[0,null,3],"1D-29LJ-REF3":[1,1.0,1],"IN-T5UW-9BB4":[0,null,3],"5T-Y81M-023M":[0,null,3],"25-LVX7-GRY9":[0,null,3],"AX-3WUC-KGC7":[0,null,3],"00198":[0,null,3],"silgil1bionee":[0,1.0,3],"VV-YGSO-3HAL":[0,null,3],"96-G01P-94FF":[0,null,3],"bicapo1":[1,1.0,3],"KT-3XFZ-RAAQ":[1,0.5,3],"C0-NNHD-T31E":[0,null,3],"00199":[0,null,3],"ZI-MGDD-3WAF":[0,null,3],"JG-1K37-5IXV":[0,null,3],"UI-6XF3-ES4F":[0,null,3],"53-VAKM-MU1U":[0,null,3],"GH-VJGM-TCFW":[0,null,3],"4T-TMEG-GLCW":[0,null,3],"3O-AAY2-XF29":[0,1.0,3],"241bionee":[1,1.0,0],"Q6-KWH6-OWUL":[1,5.0,0],"CM-YOFG-OA0D":[1,1.0,0],"PG-4RVI-Z05K":[0,null,1],"ZM-KSHT-EMV9":[0,null,1],"GN-K419-DQG5":[0,null,3],"PK-09P3-PCTR":[0,null,3],"sap1bionee":[0,null,3],"sap10bionee":[0,null,3],"sap5bionee":[0,null,3],"LZ-2CLC-H0ZJ":[0,null,3],"VY-KSHT-EMV9":[0,null,3],"8C-YNJ9-GQGP":[1,1.0,3],"1Z-RJ37-3HVX":[1,1.0,3],"W8-FJTZ-4UL5":[1,1.0,0],"3S-XH6Q-NPSD":[0,null,3],"DP-VZEN-LA6G":[0,null,3],"zeo1bionee":[1,1.0,3],"60-EQYE-77SK":[1,5.0,3],"QW-GVAU-79HG":[0,null,3],"OU-RKUT-8LKK":[1,0.7,3],"7Q-S6V1-LCUI":[0,null,1],"COMBICONCENTRATOBULK":[0,null,3],"NEEMBULK":[0,null,3],"URINESPRAYBULK":[0,null,3],"00256campag":[0,null,3],"00178campag":[0,12.6,3],"00254CAMPAG":[0,1.0,3],"242CHEMIFARM":[1,1.0,3],"241CHEMIFARM":[1,5.0,3],"cao6chemifarm":[1,6.0,2],"511CHEMIFARM":[0,1.0,1],"512chemifarm":[0,5.0,1],"rametekchemifarm1":[1,1.0,1],"rametekchemifarm5":[1,5.0,1],"282CHEMIFARM":[0,20.0,0],"281CHEMIFARM":[1,5.0,0],"272CHEMIFARM":[1,1.0,0],"271CHEMIFARM":[1,5.0,0],"00184chemifarm":[0,1.0,0],"261CHEMIFARM":[1,5.0,0],"262CHEMIFARM":[1,1.0,0],"821CHEMIFARM":[0,10.0,0],"251CHEMIFARM":[1,5.0,3],"252CHEMIFARM":[0,1.0,3],"251 N CHEMIFARM":[1,5.0,3],"803CHEMIFARM":[0,1.0,0],"613CHEMIFARM":[0,5.0,0],"tri1chemifarm":[0,null,0],"tri5chemifarm":[0,5.0,0],"00128CHEMIFARM":[1,6.0,3],"zeo6chemifarm":[1,6.0,3],"213CHEMIFARM":[1,1.0,1],"602CHEMIFARM":[0,1.0,1],"601CHEMIFARM":[0,5.0,1],"840cubo":[0,1000.0,0],"00951":[0,1000.0,1],"1021":[0,10.0,1],"00952":[0,25.0,1],"00839":[0,5.0,1],"1019":[1,null,1],"BIOMIL1":[0,1.0,3],"01008":[0,10.0,3],"00844":[0,5.0,3],"01049":[0,5.0,1],"511m.p&r":[0,1.0,1],"00899negozio":[0,null,1],"co1343":[0,null,1],"511N":[0,1.0,1],"01791":[0,null,1],"01156":[0,null,3],"cupro25tdbiotech":[0,25.0,1],"00656":[0,10.0,3],"1254":[0,25.0,1],"2102":[0,10.0,0],"00840":[0,null,3],"00834":[0,5.0,3],"12151":[0,10.0,3],"1214":[0,10.0,3],"154391888463":[0,10.0,0],"00100":[0,1.0,0],"154391903618":[0,10.0,0],"821N":[0,5.0,0],"ossi1000":[0,1000.0,0],"00657":[0,5.0,3],"00747":[0,10.0,0],"154215426748":[1,10.0,0],"01010":[0,10.0,1],"00810":[0,10.0,3],"01140":[0,null,1],"00845":[0,10.0,3],"01009":[0,10.0,3],"TRIBASICFLOW1":[0,1.0,3],"153220653999":[1,5.0,0],"154378811762":[0,10.0,1],"01127":[0,5.0,1],"3001":[0,1.0,1],"00954":[0,10.0,1],"00655":[0,10.0,3],"01800":[0,null,1],"000":[0,1000.0,1],"1114":[0,1.0,1],"1000":[0,1000.0,1],"00652":[0,10.0,1],"01174":[0,null,1],"01173":[0,10.0,1],"01198":[0,null,1],"01199":[0,null,1],"153730700493":[0,null,3],"154342437525":[1,2.0,0],"241angelucci":[1,5.0,0],"153902743103":[0,1.0,3],"01162":[0,500.0,3],"100":[1,5.0,3],"HO-3UU7-QQFU":[1,5.0,3],"00841":[1,8.0,3],"117":[0,500.0,3],"carboram1kg":[1,5.0,0],"COPPERZOLPLUS1":[1,1.0,1],"CRYSTALFER25P":[0,25.0,3],"SOLFER05P":[1,5.0,3],"00835":[0,null,3],"00746":[1,5.0,3],"00811":[1,1.0,1],"00812":[1,5.0,1],"00596":[1,1.0,1],"286":[1,5.0,0],"292":[1,1.0,1],"1017":[1,1.0,1],"59510":[1,10.0,1],"01185":[1,1.0,1],"153906707694":[1,1.0,1],"154213874021":[1,10.0,1],"00909":[1,5.0,1],"00907":[1,10.0,1],"0822445844158":[1,0.5,0],"280":[1,10.0,0],"0822445844156":[1,0.5,0],"272angelucci":[1,1.0,0],"00616":[1,5.0,0],"271angelucci":[1,5.0,0],"01031":[1,1.0,0],"0822445844146":[1,0.5,0],"153220651258":[1,10.0,0],"0822445844278":[1,0.5,0],"261S":[1,5.0,0],"261TECNOBELL":[1,5.0,0],"00591":[1,5.0,0],"262S":[1,1.0,0],"1240":[1,1.0,0],"262TECNOBELL":[1,1.0,0],"262agriappia":[1,1.0,0],"262n":[1,1.0,0],"1041stevar":[1,1.0,0],"1041":[1,10.0,0],"1045N":[1,5.0,0],"154342432628":[1,1.0,0],"153220651261":[1,1.0,0],"154213646494":[1,10.0,0],"154213861639":[1,5.0,0],"0822445844266":[1,0.5,0],"00592":[1,0.5,0],"154213652570":[0,20.0,0],"00911":[1,5.0,0],"00931":[1,5.0,0],"250":[1,10.0,0],"251S":[1,5.0,0],"251m.p&r":[1,5.0,0],"251NS":[1,5.0,0],"251N":[1,5.0,0],"251BLU":[1,5.0,0],"ramu50-5kg":[1,5.0,0],"252m.p&r":[1,1.0,0],"252agriappia":[1,1.0,0],"252marocco":[1,1.0,0],"ramu50-1k":[1,1.0,0],"252N":[1,1.0,0],"PTVOXYBLU":[1,null,0],"PTVOXYTEC":[1,null,0],"oxi5005kg":[1,5.0,0],"01180":[1,1.0,0],"154213866066":[1,10.0,0],"4Y-IDX9-Y6TO":[1,10.0,0],"00904":[0,20.0,0],"0822445844256":[1,0.5,0],"241BIGBAG":[0,500.0,0],"00589":[1,1.0,0],"242AGRINET":[1,1.0,0],"242 agriappia":[1,1.0,0],"242albania":[1,1.0,0],"240":[1,10.0,0],"241S":[1,5.0,0],"241AGRINET":[1,5.0,0],"00590":[1,5.0,0],"241albania":[1,5.0,0],"242N":[1,1.0,0],"241N":[1,5.0,0],"261tecno":[1,5.0,0],"01076":[1,1.0,3],"074508":[0,25.0,3],"ramesol25kgnegozio":[0,25.0,0],"00588":[1,10.0,0],"01214":[0,1000.0,0],"154386628912":[1,10.0,3],"SPECIAL405":[1,5.0,0],"00679":[1,5.0,0],"262TECNO":[1,1.0,0],"990":[1,10.0,3],"251wpoxy":[1,5.0,0],"B3-TCYD-AZUD":[1,1.0,1],"M80033":[0,900.0,1],"01087":[0,25.0,1],"00745":[0,25.0,1],"00744":[0,25.0,1],"M90019":[0,25.0,1],"154345207717":[1,10.0,3],"6B-OAS0-YXLZ":[1,6.0,3],"00625":[0,1.0,3],"PK28-21SAC25":[0,25.0,3],"BVP1SA":[0,25.0,3],"00639":[0,1.0,3],"00638":[0,5.0,3],"154277659535":[0,25.0,3],"00621":[0,1.0,3],"00623":[0,1.0,3],"00622":[0,10.0,3],"00738":[1,10.0,2],"00757GIORDANO":[0,25.0,2],"113":[1,5.0,2],"01216":[1,6.0,2],"POWERCBB":[1,null,2],"154633391460":[1,1.0,2],"PW-WLQ0-CWPX":[0,12.0,2],"153676949626":[0,12.0,2],"kaolin25eb":[0,25.0,2],"154024115268":[0,null,2],"00127":[0,10.0,2],"1024":[0,25.0,2],"00735":[0,1.0,2],"PK8-11":[0,800.0,2],"PK8-11SAC25":[0,25.0,2],"GGRESA01":[1,1.0,2],"GPOWSA01":[1,1.0,2],"PK56-12BB":[0,1000.0,3],"PK69-12SAC25":[0,25.0,3],"00265":[0,1000.0,3],"00126":[0,10.0,3],"00264":[0,25.0,3],"citricibc":[0,1000.0,3],"00225":[0,5.0,3],"00968":[0,25.0,3],"01088":[1,5.0,3],"1204":[0,20.0,3],"sapone25":[0,null,3],"01188":[0,null,3],"sc73-12":[0,25.0,3],"zeo15":[0,15.0,3],"ZEM70MFSA15":[0,15.0,3],"ZEM70MFSA20":[0,20.0,3],"01028":[0,25.0,3],"ZEP7036EFSA":[0,20.0,3],"ZZAGRIPBB1000T":[0,1000.0,3],"ZEOLITE":[1,10.0,3],"01160":[0,15.0,3],"GZEMSA10/B":[1,10.0,3],"00762":[0,null,3],"00766":[0,null,3],"00764":[0,null,3],"00767":[0,null,3],"00765":[0,null,3],"00763":[0,null,3],"00790":[0,null,3],"1052":[0,null,3],"1029":[0,null,3],"01061":[0,null,3],"01059":[0,null,3],"00802":[0,null,3],"8100":[0,null,3],"00712":[0,null,3],"00648":[0,null,3],"00654":[0,null,3],"01053":[0,null,3],"00146":[0,1.35,3],"00836":[0,null,3],"00837":[0,null,3],"00736":[0,null,3],"00692":[0,null,3],"00737":[0,null,3],"00693":[0,null,3],"00700":[0,null,3],"01037":[0,null,3],"00677":[0,null,3],"01038":[0,null,3],"00709":[0,null,3],"01041":[0,null,3],"00877":[0,5.0,3],"00630":[0,null,3],"00641":[0,null,3],"00653":[0,null,3],"00637":[0,null,3],"00645":[0,null,3],"00754":[0,null,3],"00753":[0,null,3],"00867":[0,null,3],"00703":[0,null,3],"01015":[0,null,3],"00793":[0,null,3],"00642":[0,null,3],"00643":[0,null,3],"soda1":[0,1.0,0],"soda5":[0,5.0,0],"01074":[0,null,3],"154354511438":[0,10.0,3],"00614":[0,null,3],"0822542272010":[0,null,3],"01126":[0,null,3],"0822542272011":[0,null,3],"01036":[0,null,3],"00147":[0,1.35,3],"00156":[0,null,3],"01035":[0,null,3],"82764589244":[0,null,3],"00152":[0,1.0,3],"8125352125":[0,null,3],"00151":[0,1.0,3],"00150":[0,1.35,3],"85892245812":[0,null,3],"CM029":[0,null,3],"8019":[0,null,3],"VFL0006":[0,null,3],"01072":[0,null,3],"1236":[1,1.0,3],"00713":[0,null,3],"B/V-OXY05":[0,null,3],"B/V-OXY05 BIS":[0,null,3],"00769":[0,null,3],"00749":[0,null,3],"00768":[0,null,3],"00750":[0,null,3],"00936":[0,1.12,3],"00748":[0,1.35,3],"00155":[0,1.0,3],"00154":[0,1.0,3],"1050":[0,1.0,3],"00149":[0,1.0,3],"00153":[0,1.0,3],"89654587866":[0,null,3],"templatedewa":[0,20.0,3],"extremedewa":[0,null,3],"confde150":[0,null,3],"confde100":[0,null,3],"confde200":[0,null,3],"confde500":[0,null,3],"confdetan20":[0,null,3],"spray500dewa":[0,null,3],"hdndewa":[0,null,3],"00033ecodago":[0,5.0,3],"01850ecodago":[1,5.0,1],"271ecodago":[1,5.0,0],"251ecodago":[1,5.0,0],"821ecodago":[0,null,0],"241ecodago":[1,5.0,0],"211ecodago":[1,5.0,1],"EQUI011":[0,null,3],"EQUI012":[0,null,3],"EQUI019":[0,null,3],"EQUI020":[0,null,3],"EQUI006":[0,null,3],"EQUI005":[0,null,3],"EQUI003":[0,null,3],"EQUI004":[0,null,3],"EQUI007":[0,null,3],"EQUI008":[0,null,3],"EQUI017":[0,null,3],"EQUI018":[0,null,3],"EQUI009":[0,null,3],"EQUI010":[0,null,3],"EQUI013":[0,null,3],"EQUI014":[0,null,3],"EQUI015":[0,null,3],"EQUI016":[0,null,3],"EQUI001":[0,null,3],"EQUI002":[0,null,3],"00855genetti":[0,null,3],"hydrocare300":[0,0.3,0],"CuCare350":[0,0.35,0],"1229":[0,6.75,0],"00261":[0,null,3],"00328":[0,null,3],"00263":[0,null,3],"hydrocare30010":[0,0.3,0],"1230":[0,0.3,0],"hydrocup300":[0,12.6,3],"hydro46":[1,5.0,3],"hydrocare460wp":[1,5.0,3],"01109":[1,5.0,3],"ramegel1genetti":[0,null,3],"ramegel5genetti":[0,null,3],"00181genetti":[0,null,3],"neemgenetti":[0,null,3],"1231":[0,0.35,0],"1232":[0,0.35,0],"oxi300":[0,null,3],"00615":[0,null,3],"01082":[0,null,3],"oxi500":[1,5.0,3],"00260":[0,null,3],"00262":[0,null,3],"readyplus":[0,null,3],"GVAPOLFLO500":[0,null,3],"GVACAOFLOW05":[0,null,2],"GVACAOFLOW1":[0,1.0,2],"GVACAO1":[1,1.0,2],"GVACAO5":[1,5.0,2],"GVACAO200":[1,0.2,2],"1116":[0,null,3],"GVACIBOOST01":[0,null,3],"coco01":[0,null,3],"GVACOMBI01":[0,null,3],"GVACOMBISPRAY750":[0,null,3],"cupro01":[0,null,1],"GVACUPRO01":[0,null,1],"1181":[0,null,3],"GVAEXPO100":[0,null,3],"GVAEXPO1000":[0,null,3],"1117":[0,null,3],"GVAORTI01":[0,null,3],"GVAGREENGRA1":[0,null,3],"idros01":[0,null,0],"GVAIDROSS01":[0,null,0],"1115":[0,null,3],"00865":[0,null,3],"GVASCHIUM01":[0,null,3],"GVAPENNA01":[0,null,3],"GVAFANGO01":[0,null,3],"GVACAFFE01":[0,null,3],"GVAGRASSO01":[0,null,3],"GVAOLIO01":[0,null,0],"GVAMETALLI01":[0,null,0],"GVATESSUTI01":[0,null,3],"GVAGELATO01":[0,null,3],"GVATRUGGINE01":[0,null,3],"00868":[0,null,3],"GVACOLPLUS01":[0,null,3],"GVASPEEDCOL1":[0,null,3],"1193":[0,null,3],"GVAGIRASOLE01":[0,null,3],"GVANEEM+SAP1":[0,null,3],"GVANEEM+SAP5":[0,null,3],"GVANEEM1":[0,null,3],"neem01":[0,null,3],"GVANEEM01":[0,null,3],"olis01":[0,null,3],"GVASOIA01":[0,null,3],"ossi01":[0,null,0],"GVAOSSI01":[0,null,0],"1112":[0,null,0],"GVAPOLTI01":[0,null,0],"1111":[0,null,3],"GVASAPPOT01":[0,null,3],"GVASEMPREVERDE05":[0,null,3],"1113":[0,null,3],"GVAFERRO01":[0,null,3],"solpo01":[0,null,3],"GVAPOTASSIO01":[0,null,3],"GVAZE30PRO":[1,null,1],"GVAZE301":[1,1.0,1],"GVAZE305":[1,5.0,1],"GVAZEONEEM1":[0,1.0,3],"GVAZEONEEMPRO075":[0,null,3],"GVAZEOFLOW05":[0,null,3],"GVAZEO200":[1,0.2,3],"zolfo01":[0,null,1],"GVAZOLFO01":[0,null,1],"1248":[0,null,3],"1249":[0,null,3],"1250":[0,25.0,3],"1213":[0,null,3],"1221":[0,25.0,3],"1212":[0,null,3],"1220":[0,25.0,3],"1238":[0,null,3],"1211":[0,null,3],"1217":[0,25.0,3],"1210":[0,null,3],"1219":[0,25.0,3],"1207":[0,null,3],"1215":[0,25.0,3],"1209":[0,null,3],"1218":[0,25.0,3],"1208":[0,null,3],"1216":[0,25.0,3],"1206":[0,null,3],"1255":[0,20.0,1],"00883":[0,null,3],"BANCALE":[0,null,3],"EPAL":[0,null,3],"BBTEFJ":[0,null,3],"BIG BAG":[0,null,3],"05020072":[0,null,3],"153981985194":[0,null,3],"BU-D60L-4PV1":[0,null,3],"CONAIFER":[0,null,3],"CONAILEGNO":[0,null,3],"CONAIPLA":[0,null,3],"10 SECONDA":[0,null,3],"01VENDITA CIST":[0,null,3],"C40":[0,null,3],"30047930":[0,null,3],"FILM ESTENSIBILE":[0,null,3],"FILM45327012C":[0,null,3],"03078150X180":[0,null,3],"9900000006341":[0,null,3],"T10":[0,null,3],"SA1906":[1,null,3],"SA1922":[1,null,3],"00018":[0,null,3],"PEBI48S02":[0,1.0,3],"PEBI48S05":[1,null,1],"01114":[0,1.0,3],"PEBI48S06":[0,null,3],"PEBI83S01":[0,null,3],"2EA036/0":[1,1.0,2],"2EA006/0":[1,1.0,0],"2EA008/0":[0,1.0,0],"2EA005/0":[1,1.0,1],"2EA022/0":[0,null,3],"2EA096/0":[1,1.0,0],"2EA095/0":[0,1.0,3],"2211130.1":[0,null,3],"2214498":[0,null,3],"2211131.1":[0,null,3],"1839":[0,null,3],"1889":[0,null,3],"1789":[0,null,3],"1815":[0,null,3],"1861":[0,null,3],"54300007":[0,null,3],"54400015":[0,0.002,3],"SMIPA1783":[0,null,3],"1783":[0,null,3],"1887":[0,null,3],"1835":[0,null,3],"1813":[0,null,3],"1860":[0,null,3],"EP300001860500600000":[0,0.001,3],"FBL1000UN00501102532":[0,0.11,3],"FBL1000UN00501102520":[0,0.11,3],"1162":[0,null,3],"01016":[0,null,3],"00698":[0,null,3],"00698+TAPPO":[0,null,3],"00722":[0,null,3],"RM100R":[0,null,3],"53380021":[0,0.018,3],"53520010":[0,null,3],"3A1102XX06":[0,null,3],"01017":[0,null,3],"01033":[0,null,3],"57130001":[0,0.001,3],"B05":[0,null,3],"T5UN0000000502502527":[0,0.005,3],"T10UN000000404502529":[0,0.01,3],"61330001":[0,null,3],"00029":[0,null,3],"61120002":[0,null,3],"PACK05UNBIA":[0,0.25,3],"IP42700005":[0,null,3],"05020069":[0,null,3],"05020059":[0,0.021,3],"TAP":[0,null,3],"TAP 2":[0,null,3],"1430000SG2":[0,null,3],"1577N000P7":[0,null,3],"290124":[0,null,3],"BERICAP":[0,0.015,3],"CB24410/10":[0,null,3],"00699":[0,null,3],"05020067":[0,null,3],"DMVDOS1":[0,null,3],"05020010":[0,null,3],"61210024":[0,null,3],"61270009":[0,null,3],"61120003":[0,null,3],"61310019":[0,0.006,3],"61330056":[0,null,3],"61330057":[0,null,3],"61210068":[0,0.27,3],"TRIGGER":[0,null,3],"GREENWOOD":[0,null,3],"TOPTRIG/05":[0,null,3],"S63570010":[0,20.0,3],"S63570008":[0,null,3],"S63570004":[0,null,3],"14562/0":[0,null,3],"01077":[0,null,3],"2908":[0,null,3],"S63570002":[0,null,3],"1243":[0,20.0,3],"S63570011":[0,null,3],"01192":[0,null,3],"12272":[0,null,3],"12272/0":[0,null,3],"13148/0":[0,null,3],"S00560021":[0,null,3],"0056.001":[0,null,3],"S00560012":[0,null,3],"S00560002":[0,null,3],"S00560001":[0,null,3],"0056.002":[0,null,3],"1244":[0,20.0,3],"S00560008":[0,null,3],"0056.008":[0,null,3],"0056.003":[0,null,3],"01193":[0,null,3],"S00560007":[0,null,3],"0056.007":[0,null,3],"0056.005":[0,null,3],"S00560006":[0,null,3],"01191":[0,null,3],"0056.006":[0,null,3],"1245":[0,null,3],"2907":[0,null,3],"3613":[0,null,3],"242LAMBERTI":[1,1.0,0],"101LAMBERTI":[1,5.0,3],"CALMAGLAMBERTI":[0,null,3],"1031LAMBERTI":[0,null,3],"MAST1LAMBERTI":[1,1.0,0],"MAST250LAMBERTI":[1,0.25,0],"MAST500LAMBERTI":[1,0.5,0],"00852LAMBERTI":[0,null,3],"ON101LAMBERTI":[0,null,3],"ON1020LAMBERTI":[0,null,3],"262LAMBERTI":[1,1.0,0],"252LAMBERTI":[1,1.0,0],"1020LAMBERTI":[0,null,3],"FERRO5LAMBERTI":[1,5.0,3],"213LAMBERTI":[1,1.0,1],"153710153144":[0,null,3],"A/ABET":[0,null,3],"A/ABET 3":[0,null,3],"A/ABET 2":[0,null,3],"acram5":[0,5.0,0],"104910":[0,null,3],"GM-W360-8378":[0,null,3],"AGRICOM03648":[0,0.15,3],"AGRICOM03649":[0,1.5,3],"AGRICOM03650":[0,0.15,3],"AGRICOM03696":[0,1.0,3],"AGRICOM03695":[0,1.0,3],"87-3SFD-Z7FB":[0,1.0,3],"AGRICOM03088":[1,1.0,3],"AGRICOM03087":[1,1.0,3],"R3-K8Z7-5YFN":[1,1.0,3],"AGRICOM02753":[0,1.0,3],"AGRICOM03674":[0,1.5,3],"AGRICOM03678":[0,1.5,3],"AGRICOM03591":[0,1.5,3],"AGRICOM03676":[0,5.0,3],"AGRICOM03705":[0,null,3],"AGRICOM03348":[0,1.0,3],"AGRICOM03350":[0,1.0,3],"AGRICOM03354":[0,1.0,3],"AGRICOM03017":[0,null,3],"AGRICOM03022":[0,null,3],"AGRICOM03021":[0,null,3],"RP-K9X9-E2PR":[0,null,3],"AGRICOM03346":[0,null,3],"AGRICOM03015":[0,null,3],"DI-E1G7-1XYE":[0,null,3],"AGRICOM03020":[0,null,3],"XF-HNBD-E59O":[0,null,3],"AGRICOM03016":[0,null,3],"AGRICOM03349":[0,1.0,3],"AGRICOM03351":[0,1.0,3],"154343657048":[0,1.0,3],"8I-0YI4-4ESW":[0,null,3],"AGRICOM03375":[0,null,3],"AGRICOM03706":[0,null,3],"AGRICOM01712":[0,3.0,3],"8L-TBW5-HWXK":[0,null,3],"AGRICOM03707":[0,null,3],"AGRICOM01715":[0,null,3],"BG-AA0P-DZUZ":[0,null,3],"AGRICOM03708":[0,null,3],"AGRICOM01717":[0,null,3],"AGRICOM01718":[0,null,3],"AGRICOM01719":[0,3.0,3],"AGRICOM03709":[0,null,3],"AGRICOM01721":[0,null,3],"AGRICOM03382":[0,null,3],"AGRICOM03378":[0,3.0,3],"JZ-T0UX-6ZX1":[0,null,3],"CG-TC1V-TB51":[0,null,3],"XQ-AC3W-HWJZ":[0,null,3],"AGRICOM01723":[0,null,3],"AGRICOM01722":[0,0.2,3],"AGRICOM03372":[0,null,3],"AGRICOM03373":[0,null,3],"AGRICOM03374":[0,null,3],"Z5-EXTN-239T":[0,null,3],"AGRICOM03370":[0,null,3],"4H-VO4U-QCAC":[0,null,3],"UW-KEZ3-0TZ8":[0,1.0,3],"AGRICOM03083":[0,null,3],"AGRICOM03082":[0,null,3],"AGRICOM01725":[0,null,3],"AGRICOM01726":[0,null,3],"AGRICOM03381":[0,null,3],"AGRICOM03084":[0,null,3],"AGRICOM03675":[0,null,3],"AGRICOM03677":[1,1.0,1],"AGRICOM03352":[1,1.0,3],"AGRICOM03023":[0,null,3],"N8-6I32-8EKQ":[0,null,3],"90111":[0,null,3],"90113":[0,null,3],"A/ANT":[0,null,3],"A/ANT 2":[0,null,3],"6213":[0,null,3],"8777":[0,null,3],"KV-3EDV-EYMF":[0,1.5,3],"3773":[0,15.0,3],"VERDEFERRONEGOZIO5KG":[0,5.0,3],"CS0ZORBGFAST00101I":[0,null,3],"3767":[0,15.0,3],"154343716993":[0,null,3],"3766":[0,5.0,3],"3202":[0,null,3],"3201":[0,null,3],"154343703447":[0,null,3],"TS-BN4J-MM4U":[0,5.0,3],"6231":[0,null,3],"6227":[0,null,3],"WJ-J96T-G8MD":[0,null,3],"6246":[0,null,3],"6242":[0,null,3],"6232":[0,null,3],"NU-I324-5XDN":[0,null,3],"CL-H32X-UQL1":[0,null,3],"HI-ZJWJ-X526":[0,null,3],"6228":[0,null,3],"6101":[0,null,3],"6216":[0,null,3],"SQ-CNQJ-7DJR":[0,null,3],"KA008":[0,1.0,3],"30240":[0,null,3],"30250":[0,null,3],"154342302448":[0,null,3],"30094":[0,null,3],"'0024":[0,null,3],"CS0ZORBSOBAS00101P":[0,null,3],"CS0ZORBGFBEN00101I":[0,null,3],"230077":[0,20.0,3],"BEN":[0,null,3],"BEU":[0,null,3],"CS0ZORBSOBIE00501P":[0,null,3],"CS0ZORBSOBAR00701P":[0,null,3],"CS0ZORBSOBIE01001P":[0,null,3],"3114":[0,1.0,3],"8040":[0,null,3],"104575":[0,1.5,3],"104567":[0,1.53,3],"3070":[0,null,3],"3103":[0,null,3],"3102":[0,null,3],"32022":[0,null,3],"CE0NOBCOMBROO07XX0":[0,null,3],"103970":[0,null,3],"103955":[0,null,3],"DM-KS2C-L6TQ":[0,1.0,3],"31892":[0,null,3],"31895":[0,null,3],"A/CALL 2":[0,null,3],"A/CALL":[0,null,3],"A/CALO":[0,null,3],"CAMA":[0,null,3],"CAMA1":[0,null,3],"A/CAM":[0,null,3],"A/CAME":[0,null,3],"58785":[0,null,3],"CS0ZORBSOCAR00301P":[0,null,3],"CS0ZORBSOCAR00101P":[0,null,3],"CASSSETTINA":[0,null,3],"CASSETTINA2":[0,null,3],"CS0ZORBSOCVF00101P":[0,null,3],"CS0ZORBSOCVB00101P":[0,null,3],"CS0ZORBSOCVC00901P":[0,null,3],"A/CAV":[0,null,3],"CS0ZORBSOCVV00801P":[0,null,3],"1041S-25":[0,null,3],"CS0ZORBSOCET10201P":[0,null,3],"CS0ZORBSOCET00201P":[0,null,3],"VU-26AH-WVTI":[0,null,3],"A/CIC V14":[0,null,3],"A/CIC V18":[0,null,3],"CIC":[0,null,3],"CIC1":[0,null,3],"CS0ZORBSOCIC00801P":[0,null,3],"CS0ZORBSOCIC10301P":[0,null,3],"CS0ZORBSOCIC00301P":[0,null,3],"CS0ZORBSOMST00101P":[0,null,3],"CS0ZORBSOCIC02901P":[0,null,3],"CS0ZORBSOCIC04001P":[0,null,3],"CS0ZORBSOCIC02701P":[0,null,3],"CS0ZORBSOCIC20301P":[0,null,3],"CS0ZORBSOCIC01001P":[0,null,3],"CS0ZORBSOCIC01201P":[0,null,3],"CS0ZORBSOCIC01401P":[0,null,3],"CS0ZORBSOCIC00101P":[0,null,3],"30720":[0,null,3],"0T-EEJA-7BPA":[0,null,3],"30730":[0,null,3],"30735":[0,null,3],"19006":[0,null,3],"19008":[0,null,3],"19012":[0,null,3],"19019":[0,null,3],"CIPR":[0,null,3],"COD.10":[0,null,3],"COD.10/A":[0,null,3],"COD.11":[0,null,3],"COD.2/A":[0,null,3],"COD.4":[0,null,3],"COD.6":[0,null,3],"COD.7":[0,null,3],"COD.8":[0,null,3],"COD.9":[0,null,3],"COD.9/A":[0,null,3],"14579":[0,null,3],"14574":[0,null,3],"00217":[0,null,3],"31890":[0,null,3],"31904":[0,null,3],"CON":[0,null,3],"CON1":[0,null,3],"A/COMP 3":[0,null,3],"A/COMP 4":[0,null,3],"A/COMP":[0,null,3],"A/COMP 2":[0,null,3],"M7-2S5N-BCGQ":[0,1.0,3],"154078587411":[0,null,3],"CONI":[0,null,3],"CONI 1":[0,null,3],"CONI 2":[0,null,3],"A/CON":[0,null,3],"A/CON 3":[0,null,3],"A/CON 2":[0,null,3],"132928":[0,null,3],"8850":[0,null,3],"8851":[0,null,3],"A/CON 4":[0,null,3],"7167":[0,null,3],"boro01":[0,null,3],"CS0ZORPRADIC0010NP":[0,null,3],"6027":[0,null,3],"A/DRA 2":[0,null,3],"A/DRA":[0,null,3],"E10":[0,null,3],"E9":[0,null,3],"22-UUEK-JMWG":[0,null,3],"E14":[0,null,3],"E15":[0,null,3],"E13":[0,null,3],"A/CON 5":[0,null,3],"A/ERI":[0,null,3],"A/ERI 2":[0,null,3],"01168":[0,0.5,3],"ESPOSITOREROSSO":[0,null,3],"AGRICOM03303":[0,null,3],"EUP":[0,null,3],"EUP1":[0,null,3],"A/EVO":[0,null,3],"A/EVO 2":[0,null,3],"A/EVO 3":[0,null,3],"110384":[0,null,3],"CS0ZORLEGFAN0030TB":[0,null,3],"CS0ZORLEGFAN0030YB":[0,null,3],"CS0ZORLEGFAN3030TB":[0,null,3],"CS0ZORLEGFAN3030YB":[0,null,3],"CS0ZORLEGFAN3031CB":[0,null,3],"CSTZORLEGFAN0280TB":[0,null,3],"CS0ZORLEGFAN3140TB":[0,null,3],"CS0ZORLEGFAN0190TB":[0,null,3],"CS0ZORLEGFAN1030TB":[0,null,3],"CS0ZORLEGFAN0350TB":[0,null,3],"CS0ZORLEGFAR0040TB":[0,null,3],"80SBL531":[0,1.0,3],"59FAV970-S":[0,1.2,3],"00921":[0,6.0,3],"6996":[0,1.0,3],"80SBL535":[0,1.0,3],"8010":[0,null,3],"29-SY3G-RWAZ":[0,null,3],"3772":[0,15.0,3],"3761":[0,5.0,3],"3204":[0,null,3],"3762":[0,5.0,3],"3760":[0,5.0,3],"A/FIC":[0,null,3],"FICG":[0,null,3],"FICRO":[1,null,3],"FICRO1":[1,null,3],"133930":[0,null,3],"CS0ZORBSOFIN00901P":[0,null,3],"30200":[0,null,3],"31202":[0,null,3],"32202":[0,null,3],"31183":[0,null,3],"00452":[0,null,3],"31002":[0,null,3],"31000":[0,null,3],"30311":[0,null,3],"62013":[0,null,3],"62012":[0,null,3],"62011":[0,null,3],"00937":[0,null,3],"419062":[0,10.0,3],"419060":[0,2.0,3],"419064":[0,20.0,3],"419066":[0,40.0,3],"419068":[0,null,3],"154098634240":[0,null,3],"88390":[0,null,3],"88450":[0,null,3],"88240":[0,null,3],"88350":[0,null,3],"8828":[0,null,3],"8813":[0,null,3],"8814":[0,null,3],"8815":[0,null,3],"INT8003":[1,1.0,3],"154354600808":[0,1.53,3],"CS0ZORBGFGCH00101I":[0,null,3],"GAU":[0,null,3],"3062":[0,null,3],"A/BUL":[0,null,3],"CS0ZORBGFGIG00101I":[0,null,3],"110358":[0,null,3],"CS0ZORPRAGRG0010NP":[0,null,3],"A/GUZ":[0,null,3],"A/HELLE":[0,null,3],"A/IBE":[0,null,3],"A/IBE 2":[0,null,3],"A/ILE":[0,null,3],"A/ILE 2":[0,null,3],"IMB/IMB.100":[0,null,3],"IMB/IMB.180":[0,null,3],"CS0ZORBSOENS00501P":[0,null,3],"79-A":[0,1.0,3],"79-D":[0,1.0,3],"BAY5":[0,null,3],"A/KAL 2":[0,null,3],"a/kal 3":[0,null,3],"A/KAL":[0,null,3],"KAL":[0,null,3],"kall":[0,null,3],"kal1":[0,null,3],"70202":[0,null,3],"133684":[0,null,3],"133633":[0,null,3],"154226533264":[0,25.0,3],"548/00":[0,null,3],"548/01":[0,null,3],"548/02":[0,null,3],"8852":[0,null,3],"CS0ZORBSOLAT30901P":[0,null,3],"CS0ZORBSOLAT31501P":[0,null,3],"CS0ZORBSOLAT01201P":[0,null,3],"CS0ZORBSOLAT30201P":[0,null,3],"CS0ZORBSOLAT11201P":[0,null,3],"CS0ZORBSOLAT00101P":[0,null,3],"CS0ZORBSOLAT01001P":[0,null,3],"CS0ZORBSOLAT11101P":[0,null,3],"CS0ZORBSOLAT00801P":[0,null,3],"1205":[0,1000.0,3],"3222":[0,2.5,3],"3052":[0,null,3],"RN-571W-XNW4":[0,1.0,3],"HC-D4DH-OX9H":[0,1.5,3],"3105":[0,null,3],"4819":[0,null,3],"8023":[0,null,3],"00258":[0,null,3],"8018":[0,null,3],"TF-E2WZ-XNSN":[0,null,3],"8028":[0,null,3],"V204975-717500-02":[0,25.0,3],"00809":[0,null,3],"00808":[0,null,3],"00348":[0,null,3],"CS0ZORBGFMAR00601I":[0,null,3],"CS0ZORBGFMAR00101I":[0,null,3],"00941":[0,5.0,0],"Y7-ELN1-HZZT":[1,null,0],"154387201026":[1,1.0,0],"01000":[0,5.0,0],"ZC-F6RP-9NRU":[0,null,3],"8014":[0,null,3],"111067":[0,null,3],"110707":[0,null,3],"CS0ZORPRAMIX0031KS":[0,null,3],"CS0ZORBGFMFA00101I":[0,null,3],"CS0ZORBGFMFG00101I":[0,null,3],"CS0ZORPRAMIX0081CB":[0,null,3],"CS0ZORPRAMIX0161CB":[0,null,3],"CS0ZORPRAMIX0161KS":[0,null,3],"CS0ZORPRATNA0010NP":[0,null,3],"00455":[0,null,3],"CS0ZORPRATNA0010YL":[0,null,3],"CS0ZORBSOMST00201P":[0,null,3],"110366":[0,1.0,3],"CS0HORPRAMIX0190RB":[0,null,3],"A/NAN 2":[0,null,3],"A/NAN":[0,null,3],"00857tan":[0,null,3],"00864":[0,null,3],"A/BUL 2":[0,null,3],"6211":[0,null,3],"RF-C5VJ-ZFNI":[0,null,3],"2G-7S3N-9HYZ":[0,null,3],"6250":[0,null,3],"AD-28DH-PWH9":[0,null,3],"6206":[0,null,3],"6217":[0,null,3],"6172":[0,null,3],"6252":[0,null,3],"14076500":[0,null,3],"0W-2KQQ-6ZFY":[0,null,3],"8030":[0,null,3],"80SBL503":[0,1.0,3],"00252":[0,1.0,3],"NEO35001":[0,null,3],"lino1":[0,null,3],"LINO01":[0,null,3],"01830":[0,null,3],"00039":[0,null,3],"00040":[0,null,3],"7148":[0,null,3],"7147":[0,null,3],"7157":[0,null,3],"BJ-HM2R-Y4XF":[0,null,3],"19185":[0,null,3],"19180":[0,null,3],"WB-6455-TATS":[0,null,3],"3768":[0,5.0,3],"3203":[0,null,3],"3042":[0,null,3],"111433":[0,0.028,3],"00926":[0,0.028,3],"PGR":[0,null,3],"PGR1":[0,null,3],"PGR2":[0,null,3],"EY-PH9C-P2IN":[0,null,3],"TJ-BKYC-GHRJ":[0,null,3],"10003":[0,null,3],"CS0ZORBSOPEP40401P":[0,null,3],"AGR12":[0,null,3],"PHA":[0,null,3],"A/PHA":[0,null,3],"PIAV":[0,null,3],"5R-NT9A-PUIV":[0,null,3],"3037":[0,null,3],"A/PIE":[0,null,3],"TZAEX064":[0,null,3],"80SBL503-S":[0,5.0,3],"513313":[0,9.0,3],"CE0NOBPLALATSTRXX0":[0,null,3],"CE0ZORPLA000STRXX0":[0,null,3],"A/POI V14":[0,null,3],"A/POI V16":[0,null,3],"CS0ZORBSOPOM00201P":[0,null,3],"CS0ZORBSOPOM02401P":[0,null,3],"34014":[0,null,3],"34018":[0,null,3],"34035":[0,null,3],"34016":[0,null,3],"34013":[0,null,3],"POT":[0,null,3],"CS0HORPRAMIX0020RB":[0,null,3],"CS0TNXPRAMIX0401CW":[0,null,3],"112085":[0,null,3],"CS0ZORBSOPRE00201P":[0,null,3],"CS0ZORBSOPRE00101P":[0,null,3],"6239":[0,null,3],"6240":[0,null,3],"CS0ZORBSORAP00201P":[0,null,3],"2K-R1RV-0FUO":[0,null,3],"CS0ZORBSORAV00101P":[0,null,3],"CS0ZORBSORAV00401P":[0,null,3],"CS0ZORBSORAV02401P":[0,null,3],"8022":[0,null,3],"CE0NOBCOMRIP001XX0":[0,null,3],"7164":[0,null,3],"RR-HC8W-N6BX":[0,null,3],"01117":[0,null,3],"ROS":[0,null,3],"3107":[0,null,3],"3067":[0,null,3],"CS0ZORBSORUC00101P":[0,null,3],"CS0ZORBSORUC00201P":[0,null,3],"A/SAN":[0,null,3],"01012R55330":[0,null,3],"50621":[0,null,3],"810029":[0,null,3],"810036":[0,null,3],"'0010":[0,null,3],"SKI":[0,null,3],"A/SKI":[0,null,3],"8024":[0,null,3],"8032":[1,null,0],"8034":[1,null,0],"3116":[0,null,3],"3112":[0,null,3],"3130":[0,null,3],"3104":[0,null,3],"20301":[0,null,3],"20300":[0,null,3],"20302":[0,null,3],"20303":[0,null,3],"20110":[0,null,3],"20311":[0,null,3],"20310":[0,null,3],"20312":[0,null,3],"20313":[0,null,3],"20112":[0,null,3],"20102":[0,null,3],"21120":[0,null,3],"20320":[0,null,3],"20322":[0,null,3],"20323":[0,null,3],"20104":[0,null,3],"21122":[0,null,3],"20330":[0,null,3],"20332":[0,null,3],"20333":[0,null,3],"20113":[0,null,3],"21124":[0,null,3],"20340":[0,null,3],"20342":[0,null,3],"20343":[0,null,3],"20108":[0,null,3],"20350":[0,null,3],"20109":[0,null,3],"20111":[0,null,3],"20183":[0,null,3],"SPA":[0,null,3],"A/SPA":[0,null,3],"A/SPA 3":[0,null,3],"A/SPA 2":[0,null,3],"45-MUGZ-PY32":[0,null,3],"CS0ZORBSOSPI00201P":[0,null,3],"CS0ZORBSOSPI00401P":[0,null,3],"6219":[0,null,3],"STEL":[0,null,3],"STEA":[0,null,3],"STE14":[0,null,3],"STE16":[0,null,3],"STE16 BIS":[0,null,3],"110550":[0,null,3],"110708":[0,null,3],"'0036":[0,null,3],"CE0NOBCOMSUP005XX0":[0,null,3],"'0025":[0,null,3],"CE0NOBEXPMET005XX0":[0,null,3],"CE0NOBCOMSUP001XX0":[0,null,3],"CE0NOBCOMSUP002XX0":[0,null,3],"01166":[0,null,3],"8739":[0,4.0,3],"8038":[0,null,3],"SUPERASSORBEN20":[0,20.0,3],"00725":[0,null,3],"01120":[0,null,3],"01121":[0,null,3],"421418":[0,null,3],"421416":[0,null,3],"XQ-5WYC-P84C":[0,null,3],"N8-LG5H-OY5G":[0,null,3],"UZ-N0ES-PL8L":[0,null,3],"10256":[0,null,3],"10255":[0,null,3],"10271A":[0,null,3],"10270A":[0,null,3],"XZ-QNNT-AJAM":[0,null,3],"10250A":[0,null,3],"8830":[0,null,3],"TDM":[0,null,3],"AD-W8ZV-1XJ2":[0,1.0,3],"TRY":[0,null,3],"FTTUPV329160":[0,null,3],"3032":[0,null,3],"CS0ZORBSOVAL00501P":[0,null,3],"31990":[0,null,3],"0Q-GIEA-9SNX":[0,null,3],"SY-STLZ-VE4M":[0,null,3],"30092":[0,null,3],"31301":[0,null,3],"31300":[0,null,3],"31302":[0,null,3],"31303":[0,null,3],"31311":[0,null,3],"31310":[0,null,3],"31312":[0,null,3],"31313":[0,null,3],"31321":[0,null,3],"31320":[0,null,3],"31322":[0,null,3],"31323":[0,null,3],"VK-FXW4-NSUP":[0,null,3],"31330":[0,null,3],"31332":[0,null,3],"ZM-PGZD-UB6C":[0,null,3],"31341":[0,null,3],"31340":[0,null,3],"31342":[0,null,3],"DY-YPUB-17Y8":[0,null,3],"31350":[0,null,3],"154342304051":[0,null,3],"VER":[0,null,3],"VERTYPLUS/KG1":[0,1.0,3],"8026":[0,null,3],"VC012X01":[0,1.0,3],"112618":[0,3.0,3],"ZAM":[0,null,3],"A/ZAM":[0,null,3],"1R-12FY-RMBQ":[0,1.53,3],"420050":[0,null,3],"154354726713":[0,null,3],"7Q-904N-H0J5":[0,null,3],"5D-3EOZ-INWI":[0,null,3],"154099836437":[0,null,3],"154354566075":[0,null,3],"69-OUEJ-G5LL":[0,null,3],"418206":[0,null,3],"W1-BD9Q-Q5NT":[0,null,3],"SQ-WC0I-E0QX":[0,null,3],"320135":[0,null,3],"154024122137":[0,null,3],"01124":[0,null,3],"UK-WZ4I-HT1E":[0,null,3],"421472":[0,null,3],"1F-BMYC-8UUN":[0,null,3],"93-XPW2-61DV":[1,null,0],"106369":[0,null,3],"421505":[0,null,3],"421650":[0,null,3],"106913":[0,null,3],"5C-XWN6-M44Z":[0,null,3],"306535":[0,null,3],"418204":[0,null,3],"2I-YHOF-AWRL":[0,null,3],"5F-I5GN-6BGE":[0,null,3],"ZS-Q7CL-SMGT":[0,null,3],"106371":[0,null,3],"01195":[0,null,3],"01122":[0,null,3],"01123":[0,null,3],"7M-BLB8-SJQG":[0,null,3],"6L-HDLE-07SR":[0,null,3],"AGR14":[0,null,3],"421325":[0,null,3],"zeocont05":[1,0.5,3],"zeous1kg":[0,20.0,3],"zeous5kg":[1,5.0,3],"CS0ZORBGFZGA00101I":[0,null,3],"154098813944":[0,1.0,3],"CS0ZORBGFZUO00101I":[0,null,3],"CS0ZORBSOZUC01201P":[0,null,3],"CS0ZORBSOZUC01701P":[0,null,3],"5027492":[0,null,3],"5027493":[0,null,3],"5027491":[0,null,3],"5027494":[0,null,3],"5039139":[0,null,3],"5037228":[0,null,3],"5037673":[0,null,3],"00866":[0,null,3],"00634":[0,null,3],"5028131":[0,null,3],"OC0552131908":[1,5.0,0],"OC0551221908":[0,500.0,0],"OC0544071908":[1,1.0,0],"OC0542131908":[1,5.0,0],"ARA050opengreen":[0,null,3],"ARA5opengreen":[0,null,3],"00185OPEN":[0,1.0,0],"00186OPEN":[0,5.0,0],"00176open":[1,5.0,3],"00133open":[0,25.0,3],"on101open":[0,1.0,3],"on105open":[0,5.0,3],"OLIS1OPEN":[0,null,3],"OPEN30BIG":[1,500.0,0],"261OPEN":[1,5.0,0],"262OPEN":[1,1.0,0],"OPEN30KOLLANTBIG":[1,500.0,0],"OPEN50BIG":[1,500.0,0],"251OPEN":[1,5.0,0],"252OPEN":[1,1.0,0],"823open":[0,1.0,0],"821open":[0,5.0,0],"OC0564071908":[0,1.0,3],"OC0562131908":[0,5.0,3],"POLTI31OPEN":[1,1.0,0],"POLTI35OPEN":[1,5.0,0],"242OPEN":[1,1.0,0],"241OPEN":[1,5.0,0],"00160open":[0,500.0,1],"213open":[1,1.0,1],"153955641941":[0,null,3],"00944":[0,25.0,3],"citric20":[0,null,3],"0637913232565":[1,0.5,3],"Asd":[0,1.0,3],"1194":[0,5.0,3],"CHGUWW364957":[0,null,3],"010111310":[0,null,3],"89900":[0,null,3],"01011":[0,5.0,3],"CS220100":[0,null,3],"01197":[0,1.32,3],"01196":[0,13.2,3],"calcebarattoni":[0,null,3],"1246":[1,null,3],"00173":[0,1.0,3],"PK2-24BB":[0,1000.0,3],"01837":[0,null,3],"2002":[0,1000.0,3],"ZZCONAI":[0,null,3],"81741":[0,null,3],"UA46/BB":[0,500.0,3],"01184":[0,null,3],"assemblaggio bx24cristanini":[1,0.07,3],"CONAI/P":[0,null,3],"CONAI/P ETICHETTE":[0,null,3],"CONAIB2":[0,null,3],"CONAIC":[0,null,3],"00635":[0,null,3],"00843":[0,1.0,3],"00871":[0,1000.0,3],"00870":[0,10.0,3],"00842":[0,5.0,3],"1257":[0,1000.0,1],"01838":[0,null,1],"840GREENFILL":[0,10.0,0],"1226":[0,1000.0,3],"00266":[0,25.0,3],"01834":[0,null,3],"00788":[0,null,3],"FXTIZM339126":[0,null,3],"FAT":[0,null,3],"62260007":[0,0.042,3],"010126738007":[0,null,3],"62220064":[0,0.12,3],"NOVA1002721000150000":[0,0.015,3],"FLACONE 2 LITRI":[0,null,3],"potash10":[0,null,3],"1198":[0,1200.0,3],"BB00037":[0,500.0,3],"62220024":[0,0.1,3],"62220051":[0,0.12,3],"01003AJ":[0,null,3],"GRAFICAETICHETTE":[0,null,3],"IMPIANTO STAMPA":[0,null,3],"LAVORAZIONE":[0,null,3],"00953":[0,25.0,3],"lavorazionezeus5":[0,5.0,3],"001385 0":[0,null,3],"036635 0":[0,null,3],"MKVIIC0000Z13BXP":[0,null,3],"01075":[0,null,3],"1197":[0,null,3],"01194":[0,null,3],"154389287039":[0,null,3],"154389358312":[0,null,1],"On101eucalipto":[0,null,3],"01115":[0,null,3],"00270":[0,null,3],"00221":[0,null,3],"154600339454":[0,null,3],"dognazzi":[0,920.0,3],"olis25":[0,25.0,3],"154396919791":[0,null,3],"oliosoia1000":[0,null,3],"OSZCRIZ":[0,null,3],"217":[1,1.0,0],"216":[1,null,0],"153220651255":[1,2.0,0],"concia30":[1,1.0,0],"OXITON":[0,1000.0,0],"00918":[1,10.0,0],"OXITONVERDE":[0,1000.0,0],"AGRICOM03593":[1,5.0,0],"PK56-15BB":[1,null,3],"01129":[1,null,3],"ZDGP1":[0,null,3],"01161":[0,null,3],"R15GENERALI":[0,null,3],"00610":[0,15.0,3],"00167":[0,10.0,3],"012417CO":[0,null,3],"012619CO":[1,null,3],"SAEDCM398510":[0,null,3],"00632":[0,null,3],"900.903":[0,null,3],"AGRICOM03595":[0,5.0,3],"242agriappia":[1,1.0,0],"0444":[1,null,0],"091890":[1,null,3],"0347":[0,null,3],"1247":[1,null,3],"BX24cristanini":[0,null,3],"bx30lavorazione":[0,null,3],"00222":[0,null,1],"240044":[0,null,3],"PV-06K9-FOO2":[0,null,3],"024/10":[0,null,3],"04109WSB":[0,null,3],"0411490X120GIALL":[1,null,3],"154512856707":[0,1.0,3],"154600337577":[0,null,3],"00220":[0,null,3],"1199":[0,null,3],"00063":[0,null,3],"1237":[0,null,3],"00320":[0,1000.0,3],"PK18-19BB":[0,500.0,3],"SODA LIQUIDA":[0,null,3],"123400":[0,null,3],"124650CO":[0,null,3],"S7-ZQL3-Z8XR":[1,10.0,0],"1027":[0,25.0,0],"SOLUZIONE NITRATO DI RAME":[0,null,3],"TRASPORTO":[0,null,3],"00789":[0,null,3],"9AFF004T.PMM3508":[0,null,3],"141100":[0,null,3],"zeocont1":[1,1.0,3],"zeocont025":[1,0.25,3],"zeocont5":[1,5.0,3],"M80G10":[1,10.0,1],"898":[1,10.0,1],"01818":[1,10.0,1],"895562852782":[1,5.0,1],"01170":[0,1000.0,1],"01169":[0,1000.0,1],"8050":[1,0.5,1],"154555399239":[0,null,3],"COSTBB1000":[0,1000.0,3],"114":[0,12.0,2],"ggrebB500":[0,500.0,2],"1225":[0,1000.0,3],"00267":[0,25.0,3],"ACI1":[0,1.0,3],"AGR1":[0,1.0,3],"GER1":[0,1.0,3],"ORC1":[0,1.0,3],"GRA1":[0,1.0,3],"VER1":[0,1.0,3],"ROS1":[0,1.0,3],"UNI1":[0,1.0,3],"154226591193":[1,5.0,3],"00891":[0,null,3],"00846":[0,1.0,3],"vco1333":[0,null,3],"00849":[0,null,3],"154342452314":[0,null,3],"speedcolplusibc":[0,1000.0,3],"00851":[0,null,3],"00850":[0,null,3],"00847":[0,5.0,3],"umetibc":[0,1000.0,3],"01840":[1,10.0,0],"525g":[0,25.0,0],"515g":[1,5.0,0],"525n":[0,25.0,0],"515n":[0,5.0,0],"510n":[1,10.0,0],"GZEMBB700":[0,700.0,3],"ZZAGRIPBB1250T":[0,1250.0,3],"8045":[1,0.1,1],"8041":[0,null,1],"123610":[1,null,0],"038750":[0,25.0,3],"154365013261":[0,25.0,3],"001206CO":[0,25.0,3],"00831":[0,null,3],"cit5020":[0,null,3],"ACIDOCITRICO":[0,null,3],"ACICITAN":[0,25.0,3],"004200":[0,null,3],"003710":[0,null,3],"0029":[0,null,3],"0029 deimos":[0,null,3],"154215900390":[0,null,3],"008400CO":[0,null,3],"009400":[0,null,3],"latticibc":[0,1000.0,3],"ACILAT80-CUBOP":[0,null,3],"acisol66":[0,null,3],"014700CO":[0,null,3],"DS/ACQDEM.05":[0,5.0,3],"017600CO":[0,5.0,3],"00145":[1,1.0,3],"AR1000KG":[0,1000.0,0],"01165":[0,1000.0,0],"1962aequacp":[0,null,3],"alcool 94":[0,null,3],"alcool 96":[0,null,3],"00892":[0,5.0,3],"alcool 99":[0,null,3],"00697":[0,null,3],"alcisomek":[0,null,3],"pk7-19":[0,800.0,3],"158632-BGPA000020KG0":[0,20.0,3],"199383-DRPL000200KG0":[0,200.0,3],"01190":[0,5.0,0],"034165":[0,null,3],"PK 7-20":[1,null,3],"035800":[1,null,3],"BORDEC":[0,25.0,3],"1023":[0,null,3],"0056.009":[0,null,3],"1962BLUER":[0,null,3],"154215793231":[0,null,3],"PK8-22BB":[0,null,3],"120530":[0,50.0,3],"DS/DNDNE.25":[0,null,3],"DS/DNDNP.25":[0,null,3],"01014":[0,null,3],"E.GL.84":[0,null,3],"epsotopnegozio":[1,null,3],"154187078758":[1,null,3],"V204975-717500-13":[0,25.0,3],"33021090":[0,null,3],"01079":[0,5.0,3],"1188":[0,null,3],"glicer":[0,null,3],"zcubon":[0,null,3],"00741":[0,1000.0,3],"00740":[0,5.0,3],"SOIPOSOL1000B919":[0,null,3],"154593965277":[0,25.0,0],"01047":[0,25.0,3],"154226564107":[0,25.0,0],"limoneessenza":[0,null,3],"0072S":[0,1.0,3],"01104":[1,null,0],"1962BLU":[0,null,3],"1962BLU25W070":[0,null,3],"OL.ES.53":[0,null,3],"OL. ES. 53":[0,null,3],"olio82":[0,null,3],"osferbig":[0,500.0,3],"PK53-12SAC25":[0,25.0,3],"085340":[0,null,3],"154354106510":[0,25.0,0],"097645":[0,null,3],"BF00121":[0,25.0,3],"1962resuma":[0,null,3],"PK18-19":[0,500.0,3],"00888":[0,10.0,0],"KAUSTIK":[0,25.0,3],"0488":[0,null,3],"SODSCAIM":[0,null,3],"sodcau30":[0,null,3],"124400CO":[1,null,0],"4125":[1,null,0],"125300CO":[0,1000.0,3],"IPOSOD15":[0,null,3],"SODSOLFA":[0,25.0,3],"SOMAGNAL10000914":[0,null,3],"00872":[0,25.0,0],"SOZINCEP10000914":[1,null,3],"SOLZIN":[0,25.0,3],"6220":[0,null,3],"00708":[0,null,3],"155639- BGPA000025KG0":[0,null,3],"UREA":[0,null,3],"SP40002":[0,5.0,3],"GZEMBB600":[0,600.0,3],"ZOLFO80BB":[0,900.0,1],"zolfo99":[0,25.0,1],"PK5-22BB":[0,1000.0,1],"00055":[0,1000.0,1],"2001":[0,1000.0,1],"R105":[0,1.2,3],"R104":[0,1.2,3],"R107":[0,1.2,3],"R103":[0,1.2,3],"R102":[0,1.2,3],"R100":[0,1.0,3],"R106":[0,1.2,3],"R101":[0,1.0,3],"R110":[0,null,3],"GDO1001":[0,1.0,3],"GDO1002":[0,1.0,3],"GDO1003":[0,1.0,3],"00096SANGIORGIO":[0,null,3],"00098SANGIORGIO":[0,10.0,3],"00099":[0,25.0,3],"00097SANGIORGIO":[0,6.0,3],"00128SANGIORGIO":[0,null,3],"00119SANGIORGIO":[0,null,3],"00121SANGIORGIO":[0,null,3],"00120SANGIORGIO":[0,null,3],"00115SANGIORGIO":[0,10.0,3],"00114SANGIORGIO":[0,5.0,3],"00113SANGIORGIO":[0,1.0,3],"00103SANGIORGIO":[0,1.0,3],"00104SANGIORGIO":[0,5.0,3],"00209SANGIORGIO":[0,1.0,0],"00210SANGIORGIO":[0,5.0,0],"00095SANGIORGIO":[0,10.0,3],"00093SANGIORGIO":[0,1.0,3],"00094SANGIORGIO":[0,6.0,3],"00105SANGIORGIO":[0,1.0,3],"00106SANGIORGIO":[0,null,3],"00110SANGIORGIO":[0,1.26,3],"00112SANGIORGIO":[0,12.6,3],"00166sangiorgio":[0,null,3],"00111SANGIORGIO":[0,null,3],"00116SANGIORGIO":[0,null,3],"00118SANGIORGIO":[0,null,3],"00117SANGIORGIO":[0,null,3],"00122SANGIORGIO":[0,null,3],"00124SANGIORGIO":[0,null,3],"00123SANGIORGIO":[0,null,3],"00107SANGIORGIO":[0,1.0,3],"00109SANGIORGIO":[0,13.5,3],"00129":[0,27.0,3],"00108SANGIORGIO":[0,6.0,3],"00214SANGIORGIO":[1,1.0,1],"00215SANGIORGIO":[1,5.0,1],"00099SANGIORGIO":[0,1.0,3],"00102SANGIORGIO":[0,10.0,3],"00101SANGIORGIO":[0,5.0,3],"00318SDD":[1,null,0],"242SDD":[1,1.0,0],"00319SDD":[0,null,3],"262SDD":[1,1.0,0],"00271serbios":[1,10.0,0],"261Nserbios":[1,5.0,0],"262nserbios":[1,1.0,0],"261serbios":[1,5.0,0],"262serbios":[1,1.0,0],"252serbios":[1,1.0,0],"251NSERBIOS":[1,5.0,0],"251SERBIOS":[1,5.0,0],"242serbios":[1,1.0,0],"241serbios":[1,5.0,0],"SECURZOLFOFLOW5":[0,5.0,1],"SECURZOLFOFLOW1":[0,1.0,1],"50Serbios":[1,5.0,0],"213serbios":[1,1.0,1],"cao6spitelli":[1,6.0,2],"511spitelli":[0,1.0,1],"01209spitelli":[0,1.0,3],"01211spitelli":[0,5.0,3],"813spitelli":[0,1.0,0],"2103spitelli":[0,5.0,0],"npk101spitelli":[0,null,3],"00861spitelli":[0,1.1,3],"262spitelli":[1,1.0,0],"252spitelli":[1,1.0,0],"823spitelli":[0,1.0,0],"01213spitelli":[0,5.0,0],"242spitelli":[1,1.0,0],"01212spitelli":[1,5.0,0],"843spitelli":[0,1.0,0],"841spitelli":[0,5.0,0],"213spitelli":[1,1.0,1],"602spitelli":[0,1.0,1],"114VIRI":[1,1.0,2],"ca5viri":[1,5.0,2],"00624VIRI":[0,1.0,2],"01095VIRI":[0,null,3],"00279viri":[0,null,1],"511viridia":[0,1.0,1],"00618VIRI":[1,1.0,1],"00618VIRI 500":[1,0.5,1],"diat1viri":[0,1.0,3],"diat05viri":[0,0.5,3],"EQUI005viri":[0,null,3],"ortic200viri":[0,null,3],"1031viri":[0,null,3],"equi200viri":[0,null,3],"1126viri":[0,null,3],"leci200viri":[0,null,3],"leci250viri":[0,null,3],"MAST250viri":[1,0.25,0],"MAST500viri":[1,0.5,0],"1201VIRI":[0,null,3],"on101viri":[0,null,3],"on1020viri":[0,null,3],"on10025viri":[0,null,3],"on1005viri":[0,null,3],"no261Sviridia":[1,5.0,0],"261VIRI":[1,5.0,0],"263VIRI":[1,0.5,0],"262VIRI":[1,1.0,0],"no251Sviridia":[1,5.0,0],"251VIRI":[1,5.0,0],"253VIRI":[1,0.5,0],"252viri":[1,1.0,0],"823VIRI":[0,1.0,0],"01090viri":[0,null,0],"243VIRI":[1,0.5,0],"242VIRI":[1,1.0,0],"no241Sviridia":[1,5.0,0],"241VIRI":[1,5.0,0],"01091viri":[0,null,0],"1020viri":[0,null,3],"1001viri":[0,null,3],"1005viri":[0,null,3],"01094viri":[0,1.0,3],"1319viri":[0,null,3],"01092viri":[1,1.0,3],"zeo5viri":[1,5.0,3],"213VIRI":[1,1.0,1],"603VIRI":[0,1.0,1],"01089viri":[0,null,1],"01057yesforlife":[0,null,3],"01067yesforlife":[0,null,3],"1057yesforlife":[0,1.0,3],"1063yesforlife":[0,1.0,3],"1073yesforlife":[0,1.0,3],"1078yesforlife":[0,1.0,3],"1079yesforlife":[0,1.0,3],"1083yesforlife":[0,1.0,3],"01063yesforlife":[0,null,3],"01065yesforlife":[0,null,3],"01055yesforlife":[0,null,3],"01051yesforlife":[0,null,3],"01073yesforlife":[0,null,3],"1055yesforlife":[0,null,3],"01069yesforlife":[0,null,3],"plumber1yesforlife":[0,1.0,3],"1049yesforlife":[0,1.0,3],"1084yesforlife":[0,1.0,3],"1088yesforlife":[0,1.0,3]};
    const MAT_NAMES = ["rame","zolfo","caolino","altro"];


    const XML_POLL_MS = 120000;

    // ===== Firebase (solo per Completati) =====
    const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== UI refs =====
    const $ = (id) => document.getElementById(id);
    const driveDot = $("driveDot");
    const driveTxt = $("driveTxt");
    const ordersSub = $("ordersSub");
    const ordersList = $("ordersList");
    const doneSub = $("doneSub");
    const doneList = $("doneList");
    const kpiKg = $("kpiKg");
    const kpiDays = $("kpiDays");
    const kpiRame = $("kpiRame");
    const kpiZolfo = $("kpiZolfo");
    const kpiCaolino = $("kpiCaolino");
    const kpiAltro = $("kpiAltro");
    const mobileSummaryTxt = $("mobileSummaryTxt");
    const mRame = $("mRame");
    const mZolfo = $("mZolfo");
    const mCaolino = $("mCaolino");
    const mTotKg = $("mTotKg");
    function focusCard(id){
      const el = document.getElementById(id);
      if(!el) return;
      document.querySelectorAll(".card").forEach(c=>c.classList.remove("bringFront"));
      el.classList.add("bringFront");
      try{ el.scrollIntoView({behavior:"smooth", block:"start"}); }catch(_){}
      setTimeout(()=>{ el.classList.remove("bringFront"); }, 900);
    }


    // ===== Scroll lock (blocca swipe sotto i popup) =====
    let __scrollLockY = 0;
    function lockBodyScroll(){
      __scrollLockY = window.scrollY || document.documentElement.scrollTop || 0;
      document.body.dataset.scrollLockY = String(__scrollLockY);
      document.body.classList.add("noScroll");
      document.body.classList.add("modalOpen");
      document.body.style.top = `-${__scrollLockY}px`;
    }
    function unlockBodyScroll(){
      const y = parseInt(document.body.dataset.scrollLockY || "0", 10) || 0;
      document.body.classList.remove("noScroll");
      document.body.classList.remove("modalOpen");
      document.body.style.top = "";
      delete document.body.dataset.scrollLockY;
      window.scrollTo(0, y);
    }

    // ===== Clock + Meteo (Cerea, VR) =====
    const WX_LAT = 45.2153;
    const WX_LON = 11.1462;
    function pad2(n){ return String(n).padStart(2,"0"); }

    function makeLotStamp(ts=Date.now()){
      const d = new Date(ts);
      const yy = String(d.getFullYear()).slice(2);
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `LOT${yy}${mm}${dd}${hh}${mi}${ss}`;
    }

    function tickClock(){
      const d = new Date();
      $("clockTxt").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    setInterval(tickClock, 250); tickClock();

    async function refreshWeather(){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code,wind_speed_10m&timezone=Europe%2FRome`;
        const r = await fetch(url, { cache:"no-store" });
        const j = await r.json();
        const t = j?.current?.temperature_2m;
        const w = j?.current?.wind_speed_10m;
        $("wxTxt").textContent = (t!=null && w!=null) ? `Cerea: ${Math.round(t)}°C • vento ${Math.round(w)} km/h` : "Meteo: —";
      }catch(_){
        $("wxTxt").textContent = "Meteo: —";
      }
    }
    refreshWeather();
    setInterval(refreshWeather, 10*60*1000);

    // ===== State =====
    let _view = "customer"; // customer | material | size | other
    let _rawDocs = [];       // parsed docs
    let _powderLines = [];   // flattened powder lines
    let _otherLines = [];    // flattened non-powder
    let _manualLines = [];   // manual sheet lines (powder-like)
    let _doneMap = new Map(); // lineKey => doc
    let _selectTitle = "";
    let _selectLines = [];
    let _selectedKeys = new Set();
    let _pendingBatch = null;
    let _articleGroupsMap = new Map();

    // ===== Helpers =====
    function setDriveState(ok, msg){
      driveDot.classList.toggle("ok", !!ok);
      driveDot.classList.toggle("bad", !ok && msg && msg.includes("Errore"));
      driveTxt.textContent = msg || (ok ? "Sistema: OK" : "Sistema: —");
    }

    function safeText(n){ return (n && (n.textContent||"").trim()) || ""; }

    function buildLineKey(docNumber, customer, code, desc, qty, um){
      const base = `${docNumber}|${customer}|${code}|${desc}|${qty}|${um}`;
      let h=0;
      for(let i=0;i<base.length;i++){ h=((h<<5)-h)+base.charCodeAt(i); h|=0; }
      return "x_" + Math.abs(h).toString(36);
    }

    function norm(s){ return String(s||"").toLowerCase(); }

    function masterInfo(code){
      const k = String(code||"").trim();
      return (k && PRODUCT_MASTER[k]) ? PRODUCT_MASTER[k] : null;
    }

    function detectPackKg(desc, code=""){
      const mi = masterInfo(code);
      if(mi && mi[1]!=null) return mi[1];

      const s = norm(desc).replace(/,/g,".");
      let m = s.match(/(\d+(?:\.\d+)?)\s*kg\b/);
      if(m) return parseFloat(m[1]);
      m = s.match(/\bkg\s*(\d+(?:\.\d+)?)\b/);
      if(m) return parseFloat(m[1]);
      m = s.match(/(\d+(?:\.\d+)?)\s*(?:gr|g)\b/);
      if(m) return parseFloat(m[1]) / 1000;
      return null;
    }

    function isPowderLine(code, desc, um){
      const mi = masterInfo(code);
      if(mi) return !!mi[0];

      const s = norm(desc);
      const u = norm(um);

      // sempre NON pertinenti
      if(/\b(mastice)\b/.test(s)) return false;

      // non pertinenti (liquidi / contenitori)
      if(/\b(secchio|tanica|flacone|bottiglia|spray|trigger|pompa|nebul)\b/.test(s)) return false;
      if(/\b\d+(?:[\.,]\d+)?\s*(ml|l|lt)\b/.test(s)) return false;
      if(u === "l" || u === "lt" || u === "ml") return false;

      const packKg = detectPackKg(desc, code);
      const isBigBag = /\bbig\s*bag\b/.test(s) || /\bbig\b/.test(norm(code));
      // regola: oltre 10 kg NON pertinente, salvo big bag
      if(packKg != null && packKg > 10.0001 && !isBigBag) return false;
      if(isBigBag && packKg != null && packKg >= 100) return true;

      // pertinente se sacco/sacchetto <=10kg
      if(/\b(sacco|sacchetto|busta|bustina|barattolo)\b/.test(s)) return true;

      // unità peso
      if(u === "kg" || u === "g") return true;
      if(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/.test(s)) return true;

      // parole chiave polveri
      if(/\b(ossicloruro|poltiglia|caolino|zeolite|zolfo|rame|bicarbonato|solfato|idrossido|tribasico|diatomite)\b/.test(s)) return true;

      return false;
    }

    function materialOf(desc, code=""){
      const mi = masterInfo(code);
      if(mi) return MAT_NAMES[mi[2]] || "altro";

      const s = norm(desc);
      const c = norm(code);
      const has = (re) => re.test(s) || re.test(c);

      if(has(/\brame\b/) || has(/\bcopper\b/) || has(/\bcupr/) || has(/\bossicloruro\b/) || has(/\bidrossido\b/) || has(/\btribasico\b/) || (s.includes("poltiglia") && s.includes("rame")) || s.includes("bordolese")) return "rame";
      if(has(/\bzolfo\b/) || has(/\bsulfur\b/) || has(/\bzolf/)) return "zolfo";
      if(has(/\bcaolino\b/) || has(/\bkaolin\b/) || has(/\bcaol/)) return "caolino";
      return "altro";
    }

    function sizeLabel(packKg){
      if(packKg == null) return "—";
      const v = (Math.round(packKg*100)/100);
      const str = (String(v).includes(".") ? String(v).replace(".",",") : String(v));
      return (v >= 400 ? `Big bag ${str} kg` : `${str} kg`);
    }

    function computeLineKg(line){
      const qty = parseFloat(String(line.qty||"0").replace(",","."));
      const u = norm(line.um);
      const pack = line.packKg;
      if(Number.isNaN(qty)) return 0;
      // se l'unità è già KG (venduto al kg) NON moltiplicare per la taglia
      if(u === "kg") return qty;
      if(u === "g") return qty/1000;
      // fallback: se la qty è in pezzi e abbiamo una taglia in kg
      if(pack != null) return qty * pack;
      return 0;
    }

    // ===== UI helpers =====
    const _DROP_TOKENS = [
      "CONCIME INORGANICO",
      "CONSENTITO IN AGRICOLTURA BIOLOGICA",
      "CONSENTITO IN AGRICOLTURA BIOLOGICA.",
      "CONSENTITO IN AGRICOLTURA BIOLOGICA ",
      "CONCIME",
      "BIOLOGICA"
    ];

    function cleanTitle(desc){
      let s = String(desc||"").trim();
      if(!s) return "—";
      // taglia tutto dopo il separatore (XML usa spesso "|")
      s = s.split("|")[0].trim();
      // elimina code ADR/UN a fine descrizione (es: "MERCE ADR UN 3077 CL9 PG III")
      s = s.replace(/\bMERCE\s+ADR\b.*$/ig," ").replace(/\bUN\s*\d{3,4}\b\s*(CL\s*\d+)?\s*(PG\s*[IVX]+)?\b.*$/ig," ");
      // normalizza separatori
      s = s.replace(/\s*-\s*/g, " ").replace(/\s+/g, " ").trim();
      // ripulisci diciture ricorrenti
      for(const t of _DROP_TOKENS){
        s = s.replace(new RegExp(`\\b${t.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')}\\b`,"ig"), " ");
      }
      // formati confezione (alcuni esempi tipici)
      s = s
        .replace(/\bSACCO\s*KG\s*([0-9]+(?:[\.,][0-9]+)?)\b/ig, (m,v)=>`sacco ${v.replace('.',',')} kg`)
        .replace(/\bSACCHETTO\s*KG\s*([0-9]+(?:[\.,][0-9]+)?)\b/ig, (m,v)=>`sacchetto ${v.replace('.',',')} kg`)
        .replace(/\bBIG\s*BAG\s*([0-9]+(?:[\.,][0-9]+)?)\s*KG\b/ig, (m,v)=>`big bag ${v.replace('.',',')} kg`)
        .replace(/\bBIG\s*BAG\b/ig, "big bag")
        .replace(/\bSCATOLA\s*KG\s*([0-9]+(?:[\.,][0-9]+)?)\s*X\s*([0-9]+)\s*PZ\b/ig, (m,kg,pz)=>`scatola ${kg.replace('.',',')} kg x ${pz} pz`)
        .replace(/\bBARATTOLO\s*([0-9]+)\s*GR\b/ig, (m,g)=>`barattolo ${g} gr`);
      s = s.replace(/\bX\s*\d+\s*PZ\b/ig," ").replace(/\bX\s*\d+\b/ig," ").replace(/\s+/g," ").trim();
      // Cuprozolfo: unifica 20/40 pz
      if(/\bcuprozolfo\b/i.test(s) && /rame\s*tek/i.test(s)) return "Cuprozolfo rame tek";
      // capitalizza solo la prima lettera (stile pulito)
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function isValidOrderLine(l){
      const code = String(l?.code||"").trim();
      const desc = String(l?.description||"").trim();
      if(!code) return false;
      if(desc.startsWith("**")) return false;
      if(code.startsWith("**")) return false;
      if(/\bnota\b/i.test(desc) || /\bnote\b/i.test(desc)) return false;
      return true;
    }

    
    function stripSizeTokens(s){
      return norm(s)
        .replace(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/g, "")
        .replace(/\b(sacco|sacchi|sacchetto|sacchetti|granulare|polvere)\b/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function canonicalProductKey(desc, code=""){
      const c = norm(code);
      if(c && c.length >= 3) return c; // se c'è un codice usalo come chiave
      const base = stripSizeTokens(desc);
      // fallback: prime 4 parole
      const parts = base.split(" ").filter(Boolean);
      return parts.slice(0,4).join(" ");
    }

    // ===== Per prodotto (unifica sinonimi) =====
    function productFamilyKey(desc){
      const s = norm(desc);
      // diatomite (Assè)
      if(/\bdiatomite\b/.test(s)) return "diatomite asse";

      // ossicloruro 30/50 (SEcur e varianti)
      if(/\b(secur)\b/.test(s) && /\b30\b/.test(s)) return "ossicloruro di rame 30";
      if(/\bossicloruro\b/.test(s) && /\b30\b/.test(s)) return "ossicloruro di rame 30";
      if(/\b(secur)\b/.test(s) && /\b50\b/.test(s)) return "ossicloruro di rame 50";
      if(/\bossicloruro\b/.test(s) && /\b50\b/.test(s)) return "ossicloruro di rame 50";

      // poltiglia (SEcur poltiglia / poltiglia di rame = stesso prodotto)
      if(/\bpoltiglia\b/.test(s)) return "poltiglia di rame";

      // fallback: togli taglia e usa descrizione pulita
      return stripSizeTokens(cleanTitle(desc)).toLowerCase();
    }
    function productFamilyLabel(key){
      const k = norm(key);
      if(k === "diatomite asse") return "Diatomite (Assè)";
      if(k === "poltiglia di rame") return "Poltiglia di rame";
      if(k === "ossicloruro di rame 30") return "Ossicloruro di rame 30%";
      if(k === "ossicloruro di rame 50") return "Ossicloruro di rame 50%";
      // default: Capitalizza solo prima lettera
      return (key||"").charAt(0).toUpperCase() + String(key||"").slice(1);
    }

    // ===== Quantità rimanente (supporto produzione parziale) =====
    let _lineIndex = new Map();
    function getDoneProducedQty(lineKey){
      const d = _doneMap.get(lineKey);
      if(!d) return 0;
      // nuovo schema
      const v = (d.producedQtyTotal != null) ? d.producedQtyTotal
              : (d.producedQty != null) ? d.producedQty
              : (d.qtyProduced != null) ? d.qtyProduced
              : (d.qty != null) ? d.qty : 0; // legacy: qty = prodotto (completo)
      const n = parseFloat(String(v).replace(",","."));
      return Number.isFinite(n) ? n : 0;
    }
    function remainingQty(line){
      const ordered = parseFloat(String(line.qty||"0").replace(",","."));
      if(!Number.isFinite(ordered)) return 0;
      const produced = getDoneProducedQty(line.lineKey);
      return Math.max(0, ordered - produced);
    }
    function computeLineKgForQty(line, qty){
      const q = parseFloat(String(qty||"0").replace(",","."));
      const u = norm(line.um);
      const pack = line.packKg;
      if(Number.isNaN(q)) return 0;
      // se l'unità è già KG (venduto al kg) NON moltiplicare per la taglia
      if(u === "kg") return q;
      if(u === "g") return q/1000;
      if(pack != null) return q * pack;
      return 0;
    }
    function computeRemainingKg(line){
      return computeLineKgForQty(line, remainingQty(line));
    }

    function groupProducts(lines){
      // raggruppa per prodotto+taglia (perché la macchina lavora per formati)
      const map = new Map();
      for(const l of lines){
        const keyBase = canonicalProductKey(l.description, l.code);
        const size = sizeLabel(l.packKg);
        const k = keyBase + "||" + size;
        const firstLabel = cleanTitle(l.description);
        const g = map.get(k) || { key:k, base:keyBase, label:firstLabel, code:l.code, size, material:l.material, kg:0, qty:0, lines:[] };
        g.kg += computeRemainingKg(l);
        g.qty += (Number.isFinite(l.qtyNum) ? l.qtyNum : 0);
        g.lines.push(l);
        // label: preferisci la più corta (dopo pulizia)
        const cand = cleanTitle(l.description);
        if(cand.length < (g.label||"").length) g.label = cand;
        if(!g.code && l.code) g.code = l.code;
        map.set(k, g);
      }
      const arr = Array.from(map.values());
      arr.sort((a,b)=> (b.kg-a.kg) || a.label.localeCompare(b.label));
      return arr;
    }

function euro(n){
      if(n == null || Number.isNaN(n)) return "—";
      return new Intl.NumberFormat("it-IT", { style:"currency", currency:"EUR" }).format(n);
    }

    
    // ===== foglio ordini (ordini manuali) =====
    function parseCsvLine(line, delim){
      const out = [];
      let cur = "", inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        } else if(ch === delim && !inQ){
          out.push(cur.trim()); cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur.trim());
      return out;
    }

    function parseCSV(text){
      const rawLines = String(text||"").split(/\r?\n/).filter(l=>l.trim()!=="");
      if(rawLines.length === 0) return [];
      const first = rawLines[0];
      const delim = (first.split(";").length > first.split(",").length) ? ";" : ",";
      const rows = rawLines.map(l=>parseCsvLine(l, delim));
      return rows;
    }

    async function fetchManualLines(){
      if(!MANUAL_SHEET_CSV_URL) return [];
      const r = await fetch(MANUAL_SHEET_CSV_URL, { cache:"no-store" });
      if(!r.ok) throw new Error(`Manuali HTTP ${r.status}`);
      const txt = await r.text();
      const rows = parseCSV(txt);
      if(rows.length === 0) return [];

      // header? se la prima riga contiene "nome" o "prodotto" la salto
      const start = (/nome|prodotto/i.test(rows[0][0]||"") && /quant/i.test((rows[0][1]||""))) ? 1 : 0;

      const out = [];
      for(let i=start;i<rows.length;i++){
        const name = (rows[i][0]||"").trim();
        const qraw = (rows[i][1]||"").trim();
        if(!name || !qraw) continue;

        const qtyNum = (()=>{ const x = String(qraw||"0").replace(/\./g,"").replace(",","."); const v = parseFloat(x); return Number.isFinite(v)?v:0; })();
        if(qtyNum <= 0) continue;

        const um = "kg";
        const code = ""; // manuali non hanno codice
        const packKg = detectPackKg(name, code);
        const powder = isPowderLine(code, name, um);
        if(!powder) continue;

        const mat = materialOf(name, code);
        const qty = String(qtyNum).replace(".",",");

        const lineKey = buildLineKey("MANUAL", "Ordini manuali", code, name, qty, um);
        out.push({
          lineKey,
          customer: "Ordini manuali",
          docNumber: "MANUAL",
          docDate: "",
          docConclusion: "",
          code,
          description: name,
          qty,
          qtyNum,
          um,
          powder: true,
          material: mat,
          packKg
        });
      }
      return out;
    }


// ===== Parse XML =====
    function parseEasyfattXml(xmlText){
      const outDocs = [];
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, "text/xml");
      const docs = Array.from(doc.getElementsByTagName("Document"));
      for(const d of docs){
        const customer = safeText(d.getElementsByTagName("CustomerName")[0]) || "Cliente";
        const number = safeText(d.getElementsByTagName("Number")[0]) || "";
        const date = safeText(d.getElementsByTagName("Date")[0]) || "";


        const conclusion = (() => {
          const direct = (
            safeText(d.getElementsByTagName("ExpectedConclusion")[0]) ||
            safeText(d.getElementsByTagName("ExpectedDeliveryDate")[0]) ||
            safeText(d.getElementsByTagName("DeliveryDate")[0]) ||
            safeText(d.getElementsByTagName("DueDate")[0]) ||
            safeText(d.getElementsByTagName("EndDate")[0]) ||
            safeText(d.getElementsByTagName("DataConsegna")[0]) ||
            safeText(d.getElementsByTagName("DataConsegnaPrevista")[0]) ||
            safeText(d.getElementsByTagName("DataFine")[0]) ||
            ""
          );
          if(direct) return direct;
          const nodes = Array.from(d.getElementsByTagName("*"));
          for(const n of nodes){
            const tag = (n.tagName||"").toLowerCase();
            if(/consegna|conclusion|delivery|scadenza|fine|previst|due/.test(tag)){
              const v = safeText(n);
              if(v && /(\d{4}-\d{2}-\d{2})|(\d{2}\/\d{2}\/\d{4})/.test(v)) return v;
            }
          }
          return "";
        })();

        const getNum = (...tags) => {
          for(const t of tags){
            const v = safeText(d.getElementsByTagName(t)[0]);
            if(v) {
              const n = parseFloat(v.replace(",","."));
              if(!Number.isNaN(n)) return n;
            }
          }
          return null;
        };
        const imponibile = getNum("TotalNet", "TotalImponibile", "NetAmount", "TaxableAmount");
        const iva = getNum("TotalVat", "VatAmount", "VATAmount", "TaxAmount");
        const totale = getNum("Total", "TotalGross", "GrossAmount", "TotalAmount");

        const rows = Array.from(d.getElementsByTagName("Row"));
        const lines = [];
        for(const r of rows){
          const code = (
            safeText(r.getElementsByTagName("Code")[0]) ||
            safeText(r.getElementsByTagName("ItemCode")[0]) ||
            safeText(r.getElementsByTagName("ArticleCode")[0]) ||
            safeText(r.getElementsByTagName("Codice")[0]) ||
            ""
          );
          const desc = safeText(r.getElementsByTagName("Description")[0]) || code || "Riga";
          const qty  = safeText(r.getElementsByTagName("Qty")[0]) || "0";
          const qtyNum = (()=>{ const x = String(qty||"0").replace(/\./g,"").replace(",","."); const v = parseFloat(x); return Number.isFinite(v)?v:0; })();
          const um   = safeText(r.getElementsByTagName("Um")[0]) || "";
          const packKg = detectPackKg(desc, code);
          const powder = isPowderLine(code, desc, um);
          const mat = powder ? materialOf(desc, code) : "altro";
          const lineKey = buildLineKey(number, customer, code, desc, qty, um);
          lines.push({ lineKey, customer, docNumber:number, docDate:date, docConclusion:conclusion, code, description:desc, qty, qtyNum, um, powder, material:mat, packKg });
        }

        outDocs.push({
          customer, number, date, conclusion,
          imponibile, iva,
          totale: (totale != null ? totale : (imponibile !=null && iva!=null ? (imponibile + iva) : null)),
          lines
        });
      }
      return outDocs;
    }

    // ===== Drive fetch =====
    async function driveListTargetFile(){ throw new Error("API disattivata: usa proxy"); }

    async function driveFetchFileContent(){ throw new Error("API disattivata: usa proxy"); }

    async function syncFromDrive() {
      $("btnSync").disabled = true;
      try {
        setDriveState(false, "Sistema: sync…");

        const res = await fetch(XML_PROXY_CFG.proxyUrl, { cache: "no-store" });
        if(!res.ok) throw new Error(`Proxy HTTP ${res.status}`);
        const j = await res.json();
        if(j && j.ok === false) throw new Error(j.error || "Proxy: errore");
        const xmlText = j?.xml;
        if(!xmlText || typeof xmlText !== "string") throw new Error("Proxy: XML mancante");

        localStorage.setItem(XML_PROXY_CFG.cacheKey, JSON.stringify({ t: Date.now(), xml: xmlText, modifiedTime: j?.modifiedTime || null }));

        _rawDocs = parseEasyfattXml(xmlText);

        const allLines = _rawDocs.flatMap(d => d.lines.map(l => ({...l})));
        _powderLines = allLines.filter(x => x.powder);
        _otherLines  = allLines.filter(x => !x.powder);

        _lineIndex = new Map(allLines.map(l=>[l.lineKey,l]));

        // ordini manuali (foglio ordini)
        try{
          _manualLines = await fetchManualLines();
        }catch(e){
          console.log("manual sheet:", e);
          _manualLines = [];
        }
        if(_manualLines.length){
          _powderLines = _powderLines.concat(_manualLines);
        }

        _lineIndex = new Map(_powderLines.concat(_otherLines).map(l=>[l.lineKey,l]));


        setDriveState(true, "Sistema: OK");
        const mod = j?.modifiedTime ? new Date(j.modifiedTime).toLocaleString("it-IT") : new Date().toLocaleString("it-IT");
        ordersSub.textContent = `Aggiornato: ${mod} • Polveri: ${_powderLines.length} righe (manuali: ${_manualLines.length}) • Non pertinenti: ${_otherLines.length} righe`;
        renderAll();
      } catch(e) {
        console.log(e);
        // fallback cache
        let cached=null;
        try { cached = JSON.parse(localStorage.getItem(XML_PROXY_CFG.cacheKey) || "null"); } catch(_ ){}
        if(cached?.xml) {
          try {
            _rawDocs = parseEasyfattXml(cached.xml);
            const allLines = _rawDocs.flatMap(d => d.lines.map(l => ({...l})));
            _powderLines = allLines.filter(x => x.powder);
            _otherLines  = allLines.filter(x => !x.powder);
            _manualLines = [];

            setDriveState(false, "Sistema: Offline (cache)");
            const mod = cached.modifiedTime ? new Date(cached.modifiedTime).toLocaleString("it-IT") : (cached.t ? new Date(cached.t).toLocaleString("it-IT") : "");
            ordersSub.textContent = `Offline: uso cache (${mod}) • Polveri: ${_powderLines.length} righe (manuali: ${_manualLines.length})`;
            renderAll();
            return;
          } catch(_ ){}
        }
        setDriveState(false, "Sistema: Errore");
        ordersSub.textContent = (e?.message || String(e));
        ordersList.innerHTML = `<div class="empty">Errore sync: ${(e?.message || e)}<br><br>Controlla che la WebApp Apps Script sia pubblicata come “Chiunque”.</div>`;
      } finally {
        $("btnSync").disabled = false;
      }
    }

    $("btnSync").addEventListener("click", (e) => { e.preventDefault(); syncFromDrive(); });

    // Autosync
    setTimeout(syncFromDrive, 450);
    setInterval(syncFromDrive, XML_POLL_MS);

    // ===== Firestore completati =====
    function dayKey(d=new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    const DONE_COLL = () => collection(db, "powderOrdersDone", dayKey(), "items");

    function lineDone(lineKey) {
      const l = _lineIndex.get(lineKey);
      if(!l) return _doneMap.has(lineKey);
      const produced = getDoneProducedQty(lineKey);
      const ordered = parseFloat(String(l.qty||"0").replace(",", "."));
      if(!Number.isFinite(ordered)) return _doneMap.has(lineKey);
      return produced >= (ordered - 1e-9);
    }

    
    // ===== Desktop avviso completamento (beep + voce) =====
    const _notify = {
      init: false,
      lastDoneAt: new Map(),
      queue: [],
      busy: false,
      audioCtx: null,
      unlocked: false,
      voice: null
    };

    function isDesktopNotify(){
      try{
        return window.innerWidth >= 900 && window.matchMedia && window.matchMedia("(pointer:fine)").matches;
      }catch(e){
        return window.innerWidth >= 900;
      }
    }

    function unlockAudio(){
      if(_notify.unlocked) return;
      _notify.unlocked = true;
      try{
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if(Ctx){
          _notify.audioCtx = new Ctx();
          if(_notify.audioCtx.state === "suspended") _notify.audioCtx.resume().catch(()=>{});
        }
      }catch(e){}
      // cache voice (prefer Google Italian)
      try{
        const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
        _notify.voice = pickGoogleItVoice(voices);
      }catch(e){}
    }
    window.addEventListener("pointerdown", unlockAudio, { once:true, passive:true });
    window.addEventListener("keydown", unlockAudio, { once:true });

    function pickGoogleItVoice(voices){
      if(!voices || !voices.length) return null;
      const it = voices.filter(v => (v.lang||"").toLowerCase().startsWith("it"));
      const g  = it.find(v => /google/i.test(v.name||"")) || it[0];
      return g || null;
    }
    if(window.speechSynthesis){
      window.speechSynthesis.onvoiceschanged = () => {
        try{ _notify.voice = pickGoogleItVoice(speechSynthesis.getVoices()); }catch(e){}
      };
    }

    function playBeep(){
      if(!_notify.audioCtx) return;
      try{
        const ctx = _notify.audioCtx;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.07;
        o.connect(g); g.connect(ctx.destination);
        const t = ctx.currentTime;
        o.start(t);
        o.stop(t + 0.12);
      }catch(e){}
    }

    function speakIt(text){
      if(!window.speechSynthesis) return;
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "it-IT";
        if(_notify.voice) u.voice = _notify.voice;
        u.rate = 1.02;
        u.pitch = 1.0;
        u.onend = () => { _notify.busy = false; notifyNext(); };
        u.onerror = () => { _notify.busy = false; notifyNext(); };
        speechSynthesis.speak(u);
      }catch(e){
        _notify.busy = false;
        notifyNext();
      }
    }

    function notifyNext(){
      if(_notify.busy) return;
      const it = _notify.queue.shift();
      if(!it) return;

      _notify.busy = true;

      // beep subito, poi voce
      playBeep();
      const prod = cleanTitle(it.description || "riga");
      const cust = (it.customer || "").trim();
      const ordN = (it.docNumber || "").trim();

      const u = ((it.um || "KG") + "").toUpperCase();
      const q = (u === "KG")
        ? (Number.isFinite(it.producedKgLast) ? it.producedKgLast : (Number(it.producedKgLast)||0))
        : (Number.isFinite(it.producedQtyLast) ? it.producedQtyLast : (Number(it.producedQtyLast)||0));

      const qTxt = (Number.isFinite(q) ? (Math.round(q*100)/100) : q) + " " + u;

      const msg = `Completato: ${prod}. ${cust ? "Cliente " + cust + ". " : ""}${ordN ? "N. ordine " + ordN + ". " : ""}Quantità prodotta ${qTxt}.`;
      setTimeout(()=>{ speakIt(msg); }, 220);
    }

    function enqueueNotify(doneObj){
      if(!isDesktopNotify()) return;
      _notify.queue.push(doneObj);
      notifyNext();
    }

function initDoneRealtime() {
      try {
        onSnapshot(DONE_COLL(), (snap) => {
          // Avviso desktop (beep + voce) quando qualcuno completa da qualunque dispositivo
          try{
            if(_notify.init){
              snap.docChanges().forEach((ch)=>{
                const id = ch.doc.id;
                const v  = ch.doc.data() || {};
                if(ch.type === "removed"){ _notify.lastDoneAt.delete(id); return; }
                const ts = Number(v.doneAt || v.completedAtClientMs || 0);
                const prev = _notify.lastDoneAt.get(id) || 0;
                if(ts && ts > prev){
                  _notify.lastDoneAt.set(id, ts);
                  enqueueNotify(v);
                }
              });
            } else {
              // prima snapshot: non annunciare, solo inizializzare
              snap.forEach((d)=>{
                const v = d.data() || {};
                const ts = Number(v.doneAt || v.completedAtClientMs || 0);
                if(ts) _notify.lastDoneAt.set(d.id, ts);
              });
              _notify.init = true;
            }
          }catch(e){}

          _doneMap.clear();
          snap.forEach((d) => {
            const v = d.data() || {};
            _doneMap.set(d.id, v);
          });

renderDone();
          renderAll();
        }, (err) => {
          console.log("done snapshot err:", err);
          doneSub.textContent = "Cloud: errore";
        });
        doneSub.textContent = "Cloud: OK";
      } catch(e) {
        console.log(e);
        doneSub.textContent = "Cloud: non inizializzato";
      }
    }
    initDoneRealtime();

    // ===== Rendering =====
    function fmtQty(line) {
      const q = String(line.qty||"0");
      return `${q} ${line.um||""}`.trim();
    }

    function fmtDateIT(s){
      const t = String(s||"").trim();
      if(!t) return "";
      const m = t.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})$/);
      if(m) return `${m[3]}/${m[2]}/${m[1]}`;
      const m2 = t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(m2) return t;
      const d = new Date(t);
      if(!Number.isNaN(d.getTime())) return d.toLocaleDateString("it-IT");
      return t;
    }

    function renderAll(){
      renderOrders();
      renderSummary();
    }

    function renderOrders(){
      const powderPending = _powderLines.filter(l => !lineDone(l.lineKey) && isValidOrderLine(l));
      const otherPending  = _otherLines.filter(l => !lineDone(l.lineKey) && isValidOrderLine(l));

      if(_view === "article"){
        const groups = groupProducts(powderPending);
        _articleGroupsMap = new Map(groups.map(g=>[g.key,g]));
        ordersSub.textContent = `${groups.length} articoli (polveri)`;

        if(groups.length === 0){
          ordersList.innerHTML = '<div class="empty">Nessun ordine polveri in coda.</div>';
          return;
        }

        ordersList.innerHTML = `
          <div class="row" style="margin-bottom:10px;">
            <div class="l">
              <div class="t">Totali per articolo</div>
              <div class="metaLine">${groups.length} prodotti<span class="sep">•</span>${powderPending.length} righe</div>
            </div>
            <div class="actions">
              <button class="btn primary" id="btnPickAll" type="button">Produci / Completa</button>
            </div>
          </div>
          ${groups.slice(0,150).map(g=>{
            const kg = Math.round(g.kg*10)/10;
            return `
              <div class="row clickable" data-g="${encodeURIComponent(g.key)}">
                <div class="l">
                  <div class="t">${g.label}</div>
                  <div class="metaLine">
                    <span class="mono">${(g.code||"—")}</span>
                    <span class="sep">•</span>
                    ${g.size||"—"}
                    <span class="sep">•</span>
                    ${(g.material||"altro")}
                    <span class="sep">•</span>
                    <span class="mono">${kg} kg</span>
                    <span class="sep">•</span>
                    <span class="mono">${g.lines.length} righe</span>
                  </div>
                </div>
                <div class="mono" style="color:var(--muted); font-weight:900;">›</div>
              </div>
            `;
          }).join("")}
        `;

        setTimeout(()=>{
          const b = $("btnPickAll");
          if(b) b.onclick = ()=> openGroupModal("Seleziona prodotti (tutte le taglie)", groups);
          ordersList.querySelectorAll('.row[data-g]').forEach(r=>{
            r.addEventListener('click', ()=>{
              const k = decodeURIComponent(r.getAttribute('data-g')||'');
              const g = _articleGroupsMap.get(k);
              if(g) openProductDetail(g);
            });
          });
        },0);
        return;
      }

      if(_view === "customer"){
        const by = new Map();
        for(const l of powderPending){
          const cust = l.customer || "Cliente";
          const arr = by.get(cust) || [];
          arr.push(l);
          by.set(cust, arr);
        }
        const customers = Array.from(by.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        if(customers.length === 0){
          ordersList.innerHTML = '<div class="empty">Nessun ordine polveri in coda.</div>';
          return;
        }
        ordersSub.textContent = `${customers.length} clienti (polveri)`;
        ordersList.innerHTML = customers.map(([cust, lines])=>{
          const kg = Math.round(lines.reduce((s,l)=>s+computeLineKg(l),0)*10)/10;
          const docs = new Set(lines.map(x=>x.docNumber).filter(Boolean)).size;
          return `
            <div class="row clickable" data-cust="${encodeURIComponent(cust)}">
              <div class="l">
                <div class="t">${cust}</div>
                <div class="metaLine">${lines.length} righe<span class="sep">•</span>${docs} doc<span class="sep">•</span><span class="mono">${kg} kg</span></div>
              </div>
              <div class="mono" style="color:var(--muted); font-weight:900;">›</div>
            </div>
          `;
        }).join("");
        ordersList.querySelectorAll('[data-cust]').forEach(r=>{
          r.addEventListener('click', ()=>{
            const cust = decodeURIComponent(r.getAttribute('data-cust')||"");
            openCustomerModal(cust, { mode: "powder" });
          });
        });
        return;
      }

      if(_view === "product"){
        const by = new Map();
        for(const l of powderPending){
          const k = productFamilyKey(l.description);
          const arr = by.get(k) || [];
          arr.push(l);
          by.set(k, arr);
        }
        const rows = Array.from(by.entries()).map(([k, lines])=>{
          const kg = Math.round(lines.reduce((s,l)=>s+computeRemainingKg(l),0)*10)/10;
          const customers = new Set(lines.map(x=>x.customer)).size;
          return { key:k, label: productFamilyLabel(k), lines, kg, customers };
        }).sort((a,b)=> (b.kg-a.kg) || a.label.localeCompare(b.label));

        ordersSub.textContent = `${rows.length} prodotti`;
        ordersList.innerHTML = rows.map(r=>{
          return `
            <div class="row clickable" data-prod="${r.key}">
              <div class="l">
                <div class="t">${r.label}</div>
                <div class="metaLine">${r.lines.length} righe<span class="sep">•</span>${r.customers} clienti<span class="sep">•</span><span class="mono">${r.kg} kg</span></div>
              </div>
              <div class="mono" style="color:var(--muted); font-weight:900;">›</div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun dato.</div>';

        setTimeout(()=>{
          ordersList.querySelectorAll('[data-prod]').forEach(el=>{
            el.addEventListener('click', ()=>{
              const k = el.getAttribute('data-prod') || '';
              const lines = (by.get(k) || []);
              const groups = groupProducts(lines);
              openGroupModal(`Seleziona prodotti • ${productFamilyLabel(k)}`, groups);
              // highlight terzo riquadro (mobile)
              focusCard("summaryCard");
            });
          });
        },0);
        return;
      }

      if(_view === "size"){
        const by = new Map();
        for(const l of powderPending){
          const key = sizeLabel(l.packKg);
          const arr = by.get(key) || [];
          arr.push(l);
          by.set(key, arr);
        }
        const keys = Array.from(by.keys()).sort((a,b)=>{
          const na = parseFloat(a.replace(",","."));
          const nb = parseFloat(b.replace(",","."));
          if(!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
          return a.localeCompare(b);
        });
        ordersSub.textContent = `${keys.length} taglie`;
        ordersList.innerHTML = keys.map(k=>{
          const lines = by.get(k) || [];
          const kg = Math.round(lines.reduce((s,l)=>s+computeLineKg(l),0)*10)/10;
          return `
            <div class="row clickable" data-size="${encodeURIComponent(k)}">
              <div class="l">
                <div class="t">${k}</div>
                <div class="metaLine">${lines.length} righe<span class="sep">•</span><span class="mono">${kg} kg</span></div>
              </div>
              <div class="mono" style="color:var(--muted); font-weight:900;">›</div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun dato.</div>';

        setTimeout(()=>{
          ordersList.querySelectorAll('[data-size]').forEach(el=>{
            el.addEventListener('click', ()=>{
              const sz = decodeURIComponent(el.getAttribute('data-size') || "");
              const groups = groupProducts(powderPending.filter(l=> sizeLabel(l.packKg)===sz ));
              openGroupModal(`Seleziona prodotti • ${sz}`, groups);
            });
          });
        },0);
        return;
      }

      if(_view === "other"){
        const by = new Map();
        for(const l of otherPending){
          const cust = l.customer || "Cliente";
          const arr = by.get(cust) || [];
          arr.push(l);
          by.set(cust, arr);
        }
        const customers = Array.from(by.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        ordersSub.textContent = `${customers.length} clienti (non pertinenti)`;
        ordersList.innerHTML = customers.map(([cust, lines])=>{
          return `
            <div class="row clickable" data-cust_other="${encodeURIComponent(cust)}">
              <div class="l">
                <div class="t">${cust}</div>
                <div class="metaLine"><span class="mono">${lines.length}</span> righe non pertinenti</div>
              </div>
              <div class="mono" style="color:var(--muted); font-weight:900;">›</div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun articolo non pertinente.</div>';

        ordersList.querySelectorAll('[data-cust_other]').forEach(r=>{
          r.addEventListener('click', ()=>{
            const cust = decodeURIComponent(r.getAttribute('data-cust_other')||"");
            openCustomerModal(cust, { mode: "other" });
          });
        });
      }
    }

    function renderSummary(){
      const powderPending = _powderLines.filter(l => !lineDone(l.lineKey) && isValidOrderLine(l));
      const totals = { rame:0, zolfo:0, caolino:0, altro:0, tot:0 };
      for(const l of powderPending) {
        const kg = computeRemainingKg(l);
        totals.tot += kg;
        totals[l.material] = (totals[l.material]||0) + kg;
      }
      const kgTot = Math.round(totals.tot*10)/10;
      const days = (kgTot>0) ? Math.ceil(kgTot / 4000) : 0;

      kpiKg.textContent = kgTot ? `${kgTot} kg` : "0 kg";
      kpiDays.textContent = `${days ? days : 0} giorni`;
      kpiRame.textContent = `${Math.round(totals.rame*10)/10} kg`;
      kpiZolfo.textContent = `${Math.round(totals.zolfo*10)/10} kg`;
      kpiCaolino.textContent = `${Math.round(totals.caolino*10)/10} kg`;
      kpiAltro.textContent = `${Math.round(totals.altro*10)/10} kg`;

      mobileSummaryTxt.textContent = `ci vogliono ${days ? days : 0} giorni`;
      mRame.textContent = `${Math.round(totals.rame*10)/10} kg`;
      mZolfo.textContent = `${Math.round(totals.zolfo*10)/10} kg`;
      mCaolino.textContent = `${Math.round(totals.caolino*10)/10} kg`;
      mTotKg.textContent = `${kgTot} kg`;
    }

    function renderDone(){
      const items = Array.from(_doneMap.entries()).map(([k,v]) => ({k, v}));
      if(items.length === 0) {
        doneList.innerHTML = '<div class="empty">Nessun completato.</div>';
        return;
      }
      items.sort((a,b)=>(b.v?.completedAtClientMs||0)-(a.v?.completedAtClientMs||0));
      doneList.innerHTML = items.slice(0,40).map(({k,v}) => {
        const when = v.completedAtClientMs ? new Date(v.completedAtClientMs).toLocaleString("it-IT") : "";
        const ordQty = (v.orderedQty!=null ? v.orderedQty : (v.qty||0));
        const prodQty = (v.producedQtyTotal!=null ? v.producedQtyTotal : (v.qty||0));
        const kgVal = (v.producedKgTotal!=null ? v.producedKgTotal : (v.kg!=null ? v.kg : null));
        const kgTxt = (kgVal!=null ? (Math.round(kgVal*10)/10)+" kg" : "—");
        const prob = String((v.problems || v.problemsLast || "")).trim();
        const isPartial = (parseFloat(String(prodQty).replace(",", ".")) < parseFloat(String(ordQty).replace(",", ".")) - 1e-9);

        return `
          <div class="smallRow">
            <div class="t">${(v.customer || "Cliente")} • ${cleanTitle(v.description || "")}</div>
            <div class="m">
              <span class="badge ok">${(v.code||"—")}</span>
              <span class="badge warn mono">${kgTxt}</span>
              <span class="badge mono">Ord: ${Math.round(parseFloat(String(ordQty).replace(",", "."))*100)/100} ${(v.um||"")}</span>
              <span class="badge ${isPartial ? "warn":"ok"}">Prod: ${Math.round(parseFloat(String(prodQty).replace(",", "."))*100)/100} ${(v.um||"")}</span>
              ${isPartial ? `<span class="badge warn">PARZIALE</span>` : ``}
              <span class="badge mono">${(v.lot||"LOT—")}</span>
              <span class="badge">${when}</span>
            </div>
            ${prob ? `<div class="m" style="margin-top:8px;"><span class="badge warn">Problemi</span><span style="font-weight:900;">${prob.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</span></div>` : ``}
          </div>
        `;
      }).join("");
    }


    // ===== Dettagli prodotto (per articolo) =====
    function openProductDetail(group){
      const title = `${group.label || "Prodotto"} • ${group.size || "—"}`;
      $("prodTitle").textContent = title;

      const lines = (group.lines || []).filter(l => !lineDone(l.lineKey));
      const totalKg = lines.reduce((s,l)=>s+computeLineKg(l),0);
      $("prodSub").textContent = `${lines.length} righe • ${Math.round(totalKg*10)/10} kg • MP: ${(group.material||"altro")}`;

      const byCust = new Map();
      for(const l of lines){
        const k = l.customer || "Cliente";
        const v = byCust.get(k) || { customer:k, kg:0, docs:new Set(), concl:new Set() };
        v.kg += computeLineKg(l);
        if(l.docNumber) v.docs.add(l.docNumber);
        if(l.docConclusion) v.concl.add(l.docConclusion);
        byCust.set(k, v);
      }
      const arr = Array.from(byCust.values()).sort((a,b)=> b.kg-a.kg || a.customer.localeCompare(b.customer));

      const body = $("prodBody");
      if(arr.length===0){
        body.innerHTML = '<div class="empty">Nessuna riga.</div>';
      }else{
        body.innerHTML = arr.map(v=>{
          const concl = (v.concl.size===1) ? Array.from(v.concl)[0] : (v.concl.size>1 ? "varie" : "");
          return `
            <div class="row clickable" data-prod-cust="${encodeURIComponent(v.customer)}">
              <div class="l">
                <div class="t">${v.customer}</div>
                <div class="metaLine">
                  <span class="mono">${v.docs.size} doc</span>
                  ${concl ? `<span class="sep">•</span>Conclusione: ${concl}` : ""}
                  <span class="sep">•</span>Apri ordine cliente
                </div>
              </div>
              <div class="mono" style="font-weight:900; color:var(--text);">${Math.round(v.kg*10)/10} kg</div>
            </div>
          `;
        }).join("");
      }

      const m = $("prodModal");
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");

      // click cliente -> apri lista completa cliente (polveri + non pertinenti)
      setTimeout(()=>{
        body.querySelectorAll('[data-prod-cust]').forEach(r=>{
          r.addEventListener('click', ()=>{
            const cust = decodeURIComponent(r.getAttribute('data-prod-cust')||"");
            // non chiudiamo la modale: l'operatore decide
            openCustomerModal(cust, { mode:"all" });
          });
        });
      },0);
    }
    $("prodClose").addEventListener("click", ()=>{
      const m = $("prodModal");
      unlockBodyScroll();
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    });


    // ===== Tabs =====
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("on"));
        t.classList.add("on");
        _view = t.getAttribute("data-view");
        renderOrders();
      });
    function setView(v){
      const t = document.querySelector(`.tab[data-view="${v}"]`);
      if(!t) return;
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("on"));
      t.classList.add("on");
      _view = v;
      renderOrders();
    }

    function openFilters(){
      const m = $("filtersModal");
      if(!m) return;
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    function closeFilters(){
      const m = $("filtersModal");
      if(!m) return;
      unlockBodyScroll();
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }

    // Buttons: Clienti + Filtri
    $("btnClienti")?.addEventListener("click", ()=> setView("customer"));
    $("btnFilters")?.addEventListener("click", openFilters);
    $("filtersClose")?.addEventListener("click", closeFilters);
    document.querySelectorAll("[data-viewpick]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const v = b.getAttribute("data-viewpick");
        setView(v);
        closeFilters();
      });
    });

    });

    // ===== Customer modal =====
    function openCustomerModal(customer, opts){
      // compat: vecchia firma openCustomerModal(cust, true/false)
      let mode = "powder";
      if(typeof opts === "boolean") mode = opts ? "other" : "powder";
      else if(opts && typeof opts === "object" && opts.mode) mode = opts.mode;

      const showPowder = (mode === "powder" || mode === "all");
      const showOther  = (mode === "other"  || mode === "all");

      _selectTitle = customer;
      _selectedKeys = new Set();

      const powderLines = showPowder
        ? _powderLines.filter(l => l.customer===customer && !lineDone(l.lineKey) && isValidOrderLine(l))
        : [];
      const otherLines = showOther
        ? _otherLines.filter(l => l.customer===customer && !lineDone(l.lineKey) && isValidOrderLine(l))
        : [];

      const sortLines = (a,b)=>{
        const na = cleanTitle(a.description||"");
        const nb = cleanTitle(b.description||"");
        if(na!==nb) return na.localeCompare(nb, "it", {sensitivity:"base"});
        const pa = Number.isFinite(a.packKg) ? a.packKg : 1e9;
        const pb = Number.isFinite(b.packKg) ? b.packKg : 1e9;
        if(pa!==pb) return pa - pb;
        const da = String(a.docNumber||"");
        const db = String(b.docNumber||"");
        if(da!==db) return da.localeCompare(db, "it", {numeric:true, sensitivity:"base"});
        const ca = String(a.code||"");
        const cb = String(b.code||"");
        return ca.localeCompare(cb, "it", {numeric:true, sensitivity:"base"});
      };
      powderLines.sort(sortLines);
      otherLines.sort(sortLines);

      // selezione/firma SOLO per polveri
      _selectLines = powderLines;

      $("custTitle").textContent = (mode === "other")
        ? `Cliente • ${customer} (non pertinenti)`
        : (mode === "all")
          ? `Cliente • ${customer} (tutto)`
          : customer;

      const subParts = [];
      if(showPowder) subParts.push(`${powderLines.length} righe polveri`);
      if(showOther)  subParts.push(`${otherLines.length} non pertinenti`);
      $("custSub").textContent = subParts.join(" • ") || "Nessuna riga";

      const modal = $("custModal");
      const hint = modal.querySelector('.boxActions .muted');
      const confirmBtn = $("custConfirm");
      const cancelBtn = $("custCancel");

      confirmBtn.style.display = (showPowder ? "" : "none");
      cancelBtn.textContent = (showPowder ? "Annulla" : "Chiudi");
      hint.textContent = showPowder ? "Spunta le righe completate → firma → conferma" : "Solo visualizzazione";

      const body = $("custBody");
      const sections = [];

      // Ordine completo: mostra solo una volta (in alto), non su ogni riga
      const _docs = Array.from(new Set([...(powderLines||[]), ...(otherLines||[])].map(l=>String(l?.docNumber||"").trim()).filter(Boolean).filter(d=>d!=="MANUAL")));
      _docs.sort((a,b)=>a.localeCompare(b, "it", {numeric:true, sensitivity:"base"}));
      if(_docs.length){
        const opt = _docs.map(d=>`<option value="${d}">${d}</option>`).join("");
        sections.push(`
          <div class="docPickSec">
            <div class="secHead">ORDINE COMPLETO</div>
            <div class="docPickRow">
              <select class="docPick" id="custDocPick">${opt}</select>
              <button class="btn primary" id="custDocBtn" type="button">Vedi ordine completo</button>
            </div>
          </div>
        `);
      }


      if(showPowder){
        if(powderLines.length===0){
          sections.push('<div class="empty">Nessuna riga polveri.</div>');
        } else {
          sections.push('<div class="sec"><div class="secHead">POLVERI</div>');
          sections.push(powderLines.map(l=>{
            const kg = Math.round(computeLineKg(l)*10)/10;
            const size = sizeLabel(l.packKg);
            const desc = cleanTitle(l.description);
            const doc = `${l.docNumber || "DOC"}${l.docDate ? " • " + fmtDateIT(l.docDate) : ""}`;
            return `
              <div class="lineRow ${(()=>{
                const ord = parseFloat(String(l.qty||"0").replace(",","."));
                const prod = getDoneProducedQty(l.lineKey);
                return (Number.isFinite(ord) && prod>0 && prod < (ord-1e-9)) ? "partial" : "";
              })()}" data-k="${l.lineKey}" data-doc="${l.docNumber||""}">
                <div class="chk"><input type="checkbox" /></div>
                <div class="lineMain">
                  <div class="t">${desc}</div>
                  <div class="sizeBig">${size}</div>
                  <div class="metaLine">
                    <span class="metaNum">Cod: ${l.code || "—"}</span>
                    <span class="sep">•</span><span class="metaNum">${doc}</span>
                    ${l.docConclusion ? `<span class="sep">•</span>Conclusione: ${l.docConclusion}` : ""}
                    <span class="sep">•</span><span class="mono">${kg} kg</span>
                    <span class="sep">•</span><span class="mono">MP: ${l.material}</span>
                    ${(()=>{
                      const ord = parseFloat(String(l.qty||"0").replace(",","."));
                      const prod = getDoneProducedQty(l.lineKey);
                      const rem = (Number.isFinite(ord)? Math.max(0,ord-prod) : 0);
                      const u = (l.um||"").toUpperCase();
                      return (prod>0 && rem>0) ? `<span class="sep">•</span><span class="warnBadge">ATTENZIONE: non completo (${Math.round(rem*100)/100} ${u} da fare)</span>` : ``;
                    })()}
                  </div>
                </div>
                <div class="col"><b>Quantità:</b> ${fmtQty(l)}</div>
              </div>
            `;
          }).join(""));
          sections.push('</div>');
        }
      }

      if(showOther){
        if(otherLines.length===0){
          sections.push('<div class="empty">Nessuna riga non pertinente.</div>');
        } else {
          sections.push('<div class="sec"><div class="secHead">NON PERTINENTI</div>');
          sections.push(otherLines.map(l=>{
            const desc = cleanTitle(l.description);
            const doc = `${l.docNumber || "DOC"}${l.docDate ? " • " + fmtDateIT(l.docDate) : ""}`;
            return `
              <div class="lineRow" style="opacity:.92;" data-k-other="${l.lineKey}">
                <div class="chk"></div>
                <div class="lineMain">
                  <div class="t">${desc}</div>
                  <div class="metaLine">
                    <span class="metaNum">Cod: ${l.code || "—"}</span>
                    <span class="sep">•</span><span class="metaNum">${doc}</span>
                  </div>
                </div>
                <div class="col">Quantità: ${fmtQty(l)}</div>
                <div class="col"></div>
                <div class="col"></div>
              </div>
            `;
          }).join(""));
          sections.push('</div>');
        }
      }

      body.innerHTML = sections.join("");

      // ordine completo (in alto)
      const _docBtn = $("custDocBtn");
      const _docPick = $("custDocPick");
      if(_docBtn && _docPick){
        const go = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); openDocModal(customer, _docPick.value); };
        _docBtn.addEventListener("click", go);
      }

      // bind checkbox solo polveri
      if(showPowder){
        body.querySelectorAll('.lineRow[data-k]').forEach(r=>{
          const k = r.getAttribute('data-k');
          const cb = r.querySelector('input[type=checkbox]');
          const sync = ()=>{
            if(cb.checked) _selectedKeys.add(k);
            else _selectedKeys.delete(k);
            confirmBtn.disabled = _selectedKeys.size===0;
          };
          cb.addEventListener('change', sync);
          // bottoni riga (solo su richiesta: ordine completo)
          // tap/click su tutta la riga (più facile su mobile)
          r.addEventListener('click', (ev)=>{
            if(ev.target && ev.target.closest && (ev.target.closest('input[type=checkbox]') || ev.target.closest('.viewDoc'))) return;
            cb.checked = !cb.checked;
            sync();
          });
        });
      }

      confirmBtn.disabled = true;
      lockBodyScroll();
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }


    let _groupModalMap = new Map(); // groupId -> lineKeys[]

    function openGroupModal(title, groups){
      _selectTitle = title || "Selezione";
      _selectedKeys = new Set();
      _groupModalMap = new Map();

      // flatten lines for signature save lookup
      const flat = [];
      const seen = new Set();
      for(const g of groups){
        const id = g.key;
        const keys = g.lines.map(x=>x.lineKey);
        _groupModalMap.set(id, keys);
        for(const l of g.lines){
          if(seen.has(l.lineKey)) continue;
          seen.add(l.lineKey);
          flat.push(l);
        }
      }
      _selectLines = flat;

      $("custTitle").textContent = title || "Selezione prodotti";
      $("custSub").textContent = `${groups.length} prodotti • spunta e conferma`;

      const body = $("custBody");
      if(groups.length===0){
        body.innerHTML = '<div class="empty">Nessun prodotto.</div>';
      } else {
        // raggruppa per materia prima (solo estetica)
        const byMat = new Map();
        for(const g of groups){
          const m = g.material || "altro";
          const arr = byMat.get(m) || [];
          arr.push(g);
          byMat.set(m, arr);
        }
        const mats = Array.from(byMat.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        body.innerHTML = mats.map(([mat, arr])=>{
          arr.sort((a,b)=> (b.kg-a.kg) || a.label.localeCompare(b.label));
          return `
            <div class="sec">
              <div class="secHead">${mat.toUpperCase()}</div>
              ${arr.map(g=>{
                const kg = Math.round(g.kg*10)/10;
                return `
                  <div class="row lineRow" data-group="${g.key}">
                    <label class="check">
                      <input type="checkbox">
                      <span></span>
                    </label>
                    <div class="l">
                      <div class="t">${g.label}</div>
                      <div class="metaLine">
                        <span class="mono">${g.code||"—"}</span>
                        <span class="sep">•</span>${g.size||"—"}
                        <span class="sep">•</span><span class="mono">${kg} kg</span>
                        <span class="sep">•</span><span class="mono">${g.lines.length} righe</span>
                      </div>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          `;
        }).join("");
      }

      body.querySelectorAll(".lineRow").forEach(r=>{
        const gid = r.getAttribute("data-group");
        const cb = r.querySelector("input[type=checkbox]");
        const sync = ()=>{
          const keys = _groupModalMap.get(gid) || [];
          if(cb.checked) keys.forEach(k=>_selectedKeys.add(k));
          else keys.forEach(k=>_selectedKeys.delete(k));
          $("custConfirm").disabled = _selectedKeys.size===0;
        };
        // click/tap su tutta la riga
        r.addEventListener("click", (ev)=>{
          if(ev.target && ev.target.closest && ev.target.closest('input[type=checkbox]')) return;
          cb.checked = !cb.checked;
          sync();
        });
        cb.addEventListener("change", ()=>{ sync(); });
      });

      $("custConfirm").disabled = true;
      const m = $("custModal");
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }


    function closeCustomerModal(){
      const m = $("custModal");
      unlockBodyScroll();
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      _selectTitle = "";
      _selectLines = [];
      _selectedKeys = new Set();
    }

    $("custClose").addEventListener("click", (e)=>{ e.preventDefault(); closeCustomerModal(); });
    $("custCancel").addEventListener("click", (e)=>{ e.preventDefault(); closeCustomerModal(); });
    $("custModal").addEventListener("click", (e)=>{ if(e.target === $("custModal")) closeCustomerModal(); });

    $("custConfirm").addEventListener("click", (e)=>{
      e.preventDefault();
      if(!_selectLines || _selectLines.length===0 || _selectedKeys.size===0) return;
      _pendingBatch = {
        title: _selectTitle,
        selectedKeys: Array.from(_selectedKeys),
        lines: _selectLines
      };
      openQtyModal(`${_selectTitle || "Selezione"} • ${_selectedKeys.size} righe`);
    });

    // ===== Signature =====
    const SIG = { drawing:false, lastX:0, lastY:0, dirty:false };
    function resizeCanvas(){
      const c = $("sigCanvas");
      const rect = c.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
      c.width = Math.floor(rect.width * dpr);
      c.height = Math.floor(rect.height * dpr);
      const ctx = c.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth = 2.2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000000";
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,rect.width,rect.height);
    }
    function clearCanvas(){
      const c = $("sigCanvas");
      const ctx = c.getContext("2d");
      const rect = c.getBoundingClientRect();
      ctx.clearRect(0,0,rect.width,rect.height);
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,rect.width,rect.height);
      SIG.dirty = false;
    }
    function pos(ev){
      const c = $("sigCanvas");
      const r = c.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }
    function wireCanvas(){
      const c = $("sigCanvas");
      const ctx = c.getContext("2d");
      c.addEventListener("pointerdown", (ev)=>{
        ev.preventDefault();
        try{ c.setPointerCapture(ev.pointerId); }catch(_){}
        const p = pos(ev);
        SIG.drawing = true;
        SIG.lastX = p.x; SIG.lastY = p.y;
      });
      c.addEventListener("pointermove", (ev)=>{
        if(!SIG.drawing) return;
        ev.preventDefault();
        const p = pos(ev);
        ctx.beginPath();
        ctx.moveTo(SIG.lastX, SIG.lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        SIG.lastX = p.x; SIG.lastY = p.y;
        SIG.dirty = true;
      });
      function end(ev){ SIG.drawing=false; try{ c.releasePointerCapture(ev.pointerId); }catch(_ ){} }
      c.addEventListener("pointerup", end);
      c.addEventListener("pointercancel", end);
    }
    wireCanvas();
    window.addEventListener("resize", ()=>{ try{ resizeCanvas(); clearCanvas(); }catch(_ ){} });

    function openSigModal(sub){
      $("sigSub").textContent = sub || "—";
      $("sigYes").checked = false;
      if($("sigProblems")) $("sigProblems").value = "";
      const m = $("sigModal");
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
      requestAnimationFrame(()=>{ resizeCanvas(); clearCanvas(); })
    }

    function closeQtyModal(){
      const m = $("qtyModal");
      if(!m) return;
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      unlockBodyScroll();
    }

    function openQtyModal(sub){
      $("qtySub").textContent = sub || "—";
      // nascondi modal cliente
      const cm = $("custModal");
      if(cm){ cm.classList.remove("show"); cm.setAttribute("aria-hidden","true"); }

      const batch = _pendingBatch || {};
      const keys = batch.selectedKeys || [];
      const lines = (batch.lines || []).filter(it => keys.includes(it.lineKey));
      // Costruisci UI
      const body = $("qtyBody");
      const producedMap = {};
      body.innerHTML = `
        <div class="qtyBox">
          ${lines.map(it=>{
            const ordered = parseFloat(String(it.qty||"0").replace(",","."));
            const producedSoFar = getDoneProducedQty(it.lineKey);
            const remaining = Math.max(0, (Number.isFinite(ordered)? ordered : 0) - producedSoFar);
            const u = (it.um||"").toUpperCase();
            const doc = it.docNumber || "—";
            const cust = it.customer || batch.title || "—";
            const size = sizeLabel(it.packKg);
            const title = cleanTitle(it.description||"");
            return `
              <div class="qtyRow" data-k="${it.lineKey}">
                <div class="t">${title}</div>
                <div class="sizeBig">${size}</div>
                <div class="m">
                  <span><b>Cliente:</b> ${cust}</span>
                  <span><b>N. ordine:</b> ${doc}</span>
                  <span><b>Quantità:</b> ${Math.round((Number.isFinite(ordered)?ordered:0)*100)/100} ${u}</span>
                  <span><b>Già prodotto:</b> ${Math.round(producedSoFar*100)/100} ${u}</span>
                  <span><b>Da fare:</b> ${Math.round(remaining*100)/100} ${u}</span>
                </div>
                <div class="q">
                  <input class="qtyInput" inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false"
                         placeholder="Kg prodotti ora…" value="${remaining>0 ? (Math.round(remaining*100)/100) : ""}" />
                  <span class="badge mono">${u}</span>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      // attiva bottone se c'è almeno una qty > 0
      const nextBtn = $("qtyNext");
      const sync = ()=>{
        let any = false;
        body.querySelectorAll(".qtyRow").forEach(r=>{
          const k = r.getAttribute("data-k");
          const inp = r.querySelector("input.qtyInput");
          const v = inp ? parseFloat(String(inp.value||"0").replace(",", ".")) : 0;
          const num = Number.isFinite(v) ? v : 0;
          producedMap[k] = num;
          if(num > 0) any = true;
        });
        nextBtn.disabled = !any;
        batch.producedNowMap = producedMap;
      };
      body.querySelectorAll("input.qtyInput").forEach(inp=>{
        inp.addEventListener("input", sync);
        inp.addEventListener("change", sync);
      });
      sync();

      const m = $("qtyModal");
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }

    function closeDocModal(){
      const m = $("docModal");
      if(!m) return;
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      // non sblocchiamo lo scroll se siamo dentro un altro modal (custModal)
    }

    function openDocModal(customer, docNumber){
      const docN = String(docNumber||"").trim();
      if(!docN){
        alert("Documento non disponibile per questa riga.");
        return;
      }
      $("docTitle").textContent = "Ordine completo";
      $("docSub").textContent = `Cliente: ${customer || "—"} • N. ordine: ${docN}`;

      const all = _powderLines.concat(_otherLines).filter(l =>
        (l.customer===customer) && String(l.docNumber||"")===docN && isValidOrderLine(l)
      );
      all.sort((a,b)=> cleanTitle(a.description).localeCompare(cleanTitle(b.description)));

      $("docBody").innerHTML = all.length ? `
        <div class="qtyBox">
          ${all.map(l=>{
            const size = sizeLabel(l.packKg);
            const desc = cleanTitle(l.description);
            const um = (l.um||"").toUpperCase();
            return `
              <div class="qtyRow">
                <div class="t">${desc}</div>
                <div class="sizeBig">${size}</div>
                <div class="m">
                  <span class="badge ok">Cod: ${l.code||"—"}</span>
                  <span class="badge mono">Quantità: ${Math.round(parseFloat(String(l.qty||0).replace(",", "."))*100)/100} ${um}</span>
                  <span class="badge mono">${(l.material||"altro")}</span>
                  ${l.powder?`<span class="badge ok">PERTINENTE</span>`:`<span class="badge warn">NON PERTINENTE</span>`}
                </div>
              </div>
            `;
          }).join("")}
        </div>
      ` : `<div class="empty">Nessuna riga trovata per questo ordine.</div>`;

      const m = $("docModal");
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }

    $("qtyClose").addEventListener("click", ()=>closeQtyModal());
    $("qtyBack").addEventListener("click", ()=>{
      closeQtyModal();
      // torna al modal cliente
      const m = $("custModal");
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    });
    $("qtyNext").addEventListener("click", ()=>{
      const batch = _pendingBatch || {};
      // passa alla firma
      closeQtyModal();
      openSigModal(`${batch.title || "Selezione"} • Firma`);
    });

    $("docClose").addEventListener("click", ()=>{ closeDocModal(); });
    $("docOk").addEventListener("click", ()=>{ closeDocModal(); });


    function renderSigQtyBox(){
      const box = $("sigQtyBox");
      if(!box) return;
      const batch = _pendingBatch;
      const lines = batch?.lines || [];
      if(lines.length===0){ box.innerHTML = ""; return; }

      box.innerHTML = `
        <div class="muted" style="color:#000; font-weight:900; letter-spacing:.2px;">Quantità (ordinata vs prodotta ora)</div>
        ${lines.map(it=>{
          const ordered = parseFloat(String(it.qty||"0").replace(",","."));
          const producedSoFar = getDoneProducedQty(it.lineKey);
          const remaining = Math.max(0, (Number.isFinite(ordered)? ordered : 0) - producedSoFar);
          const u = (it.um||"").toUpperCase();
          return `
            <div class="qtyRow" data-k="${it.lineKey}">
              <div class="t">${cleanTitle(it.description||"")}</div>
              <div class="m">Quantità: <b>${Number.isFinite(ordered)? ordered:0}</b> ${u} • Già prodotto: <b>${Math.round(producedSoFar*100)/100}</b> ${u} • Da fare: <b>${Math.round(remaining*100)/100}</b> ${u}</div>
              <div class="q">
                <span style="font-weight:900; color:#000;">Prodotto ora</span>
                <input class="qtyInput" type="number" inputmode="decimal" min="0" step="0.01" value="${Math.round(remaining*100)/100}">
              </div>
            </div>
          `;
        }).join("")}
      `;
    }
    function closeSigModal(){
      const m = $("sigModal");
      unlockBodyScroll();
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      _pendingBatch = null;
    }

    $("sigClose").addEventListener("click",(e)=>{ e.preventDefault(); closeSigModal(); });
    $("sigCancel").addEventListener("click",(e)=>{ e.preventDefault(); closeSigModal(); });
    $("sigModal").addEventListener("click",(e)=>{ if(e.target === $("sigModal")) closeSigModal(); });
    $("sigClear").addEventListener("click",(e)=>{ e.preventDefault(); clearCanvas(); });

    $("sigOk").addEventListener("click", async (e)=>{
          e.preventDefault();
          if(!_pendingBatch) { closeSigModal(); return; }
          if(!$("sigYes").checked) return;
          if(!SIG.dirty) return;

          let sigDataUrl = "";
          try { sigDataUrl = $("sigCanvas").toDataURL("image/jpeg", 0.75); }
          catch(_) { try { sigDataUrl = $("sigCanvas").toDataURL(); } catch(__){} }

          const batch = _pendingBatch;
          const keys = batch.selectedKeys || [];
          const lines = batch.lines || [];
          const now = Date.now();
          const lot = makeLotStamp(now);

          // quantità prodotta (supporto parziale): prima da batch, poi sovrascrive con i valori UI
          const producedNowMap = new Map();
          const raw = batch.producedNowMap || {};
          Object.entries(raw).forEach(([k,v])=>{
            const num = parseFloat(String(v||"0").replace(",", "."));
            producedNowMap.set(k, Number.isFinite(num) ? num : 0);
          });

          const box = $("sigQtyBox");
          if(box){
            box.querySelectorAll(".qtyRow").forEach(r=>{
              const k = r.getAttribute("data-k") || "";
              const inp = r.querySelector("input.qtyInput");
              const v = inp ? parseFloat(String(inp.value||"0").replace(",", ".")) : 0;
              producedNowMap.set(k, Number.isFinite(v) ? v : 0);
            });
          }

          const problemsText = String($("sigProblems")?.value || "").trim();

          try {
            for(const k of keys) {
              const it = lines.find(x=>x.lineKey===k);
              if(!it) continue;

              const orderedQty = parseFloat(String(it.qty||"0").replace(",","."));
              const prevDoc = _doneMap.get(k) || {};
              const prevProduced = getDoneProducedQty(k);

              const orderedKg = computeLineKgForQty(it, orderedQty);
              let producedNow = producedNowMap.has(k) ? producedNowMap.get(k) : 0;
              producedNow = parseFloat(String(producedNow||"0").replace(",","."));
              if(!Number.isFinite(producedNow)) producedNow = 0;

              const remaining = Math.max(0, (Number.isFinite(orderedQty)? orderedQty : 0) - prevProduced);
              if(producedNow > remaining) producedNow = remaining;
              if(producedNow <= 0) continue;

              let producedQtyTotal = prevProduced + producedNow;

              let prevKgTotal = (prevDoc.producedKgTotal != null) ? prevDoc.producedKgTotal
                             : (prevDoc.producedKg != null) ? prevDoc.producedKg
                             : (prevDoc.kg != null) ? prevDoc.kg : 0; // legacy
              prevKgTotal = parseFloat(String(prevKgTotal||"0").replace(",","."));
              if(!Number.isFinite(prevKgTotal)) prevKgTotal = 0;

              const producedKgNow = computeLineKgForQty(it, producedNow);
              let producedKgTotal = prevKgTotal + producedKgNow;

              // se chiude l'ordine, allinea a ordinato
              if(Number.isFinite(orderedQty) && producedQtyTotal >= (orderedQty - 1e-9)){
                producedQtyTotal = orderedQty;
                producedKgTotal = orderedKg;
              }

              const prevPartials = Array.isArray(prevDoc.partials) ? prevDoc.partials.slice(0) : [];
              prevPartials.push({ at: now, qty: producedNow, kg: producedKgNow, lot });
              if(prevPartials.length > 25) prevPartials.splice(0, prevPartials.length-25);

              await setDoc(doc(DONE_COLL(), k), {
                lineKey: k,
                customer: it.customer,
                docNumber: it.docNumber || "",
                docDate: it.docDate || "",
                code: it.code || "",
                description: it.description,

                // compat + nuovi campi
                um: it.um,
                qty: orderedQty,              // qty ordinata (legacy field)
                orderedQuantità: orderedQty,
                producedQtyTotal: producedQtyTotal,
                producedQtyLast: producedNow,

                kg: producedKgTotal,          // kg prodotti totali (legacy field)
                orderedKg: orderedKg,
                producedKgTotal: producedKgTotal,
                producedKgLast: producedKgNow,

                docConclusion: it.docConclusion || "",
                lot: lot,
                packKg: it.packKg ?? null,
                material: it.material || "altro",

                problems: (problemsText || prevDoc.problems || ""),
                problemsLast: (problemsText || ""),

                signatureDataUrl: sigDataUrl,
                completedAtClientMs: now,
                doneAt: now,
                partials: prevPartials
              }, { merge:true });
            }
          } catch(err) {
            alert("Errore salvataggio cloud: " + (err?.message || err));
            return;
          }

          closeSigModal();
          closeCustomerModal();
          setTimeout(()=>{ renderAll(); }, 120);
        });

    // ===== Undo admin =====
    $("btnUndo").addEventListener("click", async (e)=>{
      e.preventDefault();
      const pwd = prompt("Password admin:");
      if(pwd !== "12345") return;

      const items = Array.from(_doneMap.entries()).map(([k,v]) => ({k, v}));
      items.sort((a,b)=>(b.v?.completedAtClientMs||0)-(a.v?.completedAtClientMs||0));
      const last = items[0];
      if(!last) return;
      if(!confirm(`Annullare l'ultimo completato?\n${last.v.customer} • ${last.v.description}`)) return;
      try {
        await deleteDoc(doc(DONE_COLL(), last.k));
      } catch(err) {
        alert("Errore annullo: " + (err?.message || err));
      }
    });

    
    // ===== Backup PDF (share iPhone) =====
    async function buildBackupPdf(){
      const items = Array.from(_doneMap.entries()).map(([k,v])=>({id:k,...(v||{})}));
      items.sort((a,b)=>(a.doneAt||0)-(b.doneAt||0));
      if(items.length===0){ alert("Nessun completato."); return; }

      const { jsPDF } = (window.jspdf||{});
      if(!jsPDF){ alert("Libreria PDF non disponibile (jspdf)."); return; }

      // Landscape per avere colonne leggibili
      const doc = new jsPDF({ unit:"pt", format:"a4", orientation:"landscape" });
      const W = doc.internal.pageSize.getWidth();
      const H = doc.internal.pageSize.getHeight();
      const margin = 34;

      const today = new Date().toLocaleString("it-IT");
      doc.setFont("helvetica","bold"); doc.setFontSize(14);
      doc.text("LINEA POLVERI • RIEPILOGO PRODUZIONE", margin, margin);
      doc.setFont("helvetica","normal"); doc.setFontSize(10);
      doc.text(`Generato: ${today} • Righe: ${items.length}`, margin, margin+16);

      const cols = [
        {k:"customer",  lbl:"Cliente",   w:90},
        {k:"docNumber", lbl:"N. ordine",    w:60},
        {k:"product",   lbl:"Prodotto",  w:230},
        {k:"size",      lbl:"Formato",   w:85},
        {k:"ordered",   lbl:"Quantità",  w:70},
        {k:"produced",  lbl:"Prodotto",  w:70},
        {k:"lot",       lbl:"Lotto",     w:85},
        {k:"date",      lbl:"Data/Ora",  w:110},
        {k:"problems",  lbl:"Problemi",  w:210},
      ];

      const tableX = margin;
      let y = margin + 34;
      const rowH = 22;

      const newPage = ()=>{
        doc.addPage();
        y = margin;
        doc.setFont("helvetica","bold"); doc.setFontSize(12);
        doc.text("LINEA POLVERI • RIEPILOGO PRODUZIONE (continua)", margin, margin);
        y = margin + 20;
        drawHeader();
      };

      const drawHeader = ()=>{
        doc.setFont("helvetica","bold"); doc.setFontSize(10);
        let x = tableX;
        cols.forEach(c=>{
          doc.setFillColor(240,240,240);
          doc.rect(x, y, c.w, rowH, "F");
          doc.setDrawColor(0);
          doc.rect(x, y, c.w, rowH);
          doc.text(c.lbl, x+6, y+14);
          x += c.w;
        });
        y += rowH;
      };

      const drawRow = (row, isWarn)=>{
        doc.setFont("helvetica","normal"); doc.setFontSize(9);
        let x = tableX;
        cols.forEach(c=>{
          const txt = String(row[c.k] ?? "");
          if(isWarn){
            doc.setFillColor(255, 248, 225); // giallino
            doc.rect(x, y, c.w, rowH, "F");
          }
          doc.setDrawColor(0);
          doc.rect(x, y, c.w, rowH);
          // testo (truncate)
          const maxChars = Math.max(5, Math.floor(c.w/5.5));
          const t = (txt.length>maxChars) ? (txt.slice(0,maxChars-1)+"…") : txt;
          doc.text(t, x+6, y+14);
          x += c.w;
        });
        y += rowH;
      };

      drawHeader();

      for(const it of items){
        if(y + rowH + margin > H) newPage();

        const ordQty = (it.orderedQty!=null ? it.orderedQty : (it.qty||0));
        const prodQty = (it.producedQtyTotal!=null ? it.producedQtyTotal : 0);
        const um = (it.um||"").toUpperCase();
        const ordN = parseFloat(String(ordQty).replace(",", "."));
        const prodN = parseFloat(String(prodQty).replace(",", "."));
        const isWarn = (Number.isFinite(ordN) && Number.isFinite(prodN)) ? (prodN < ordN - 1e-9) : false;

        const row = {
          customer: it.customer || "—",
          docNumber: it.docNumber || "—",
          product: cleanTitle(it.description || ""),
          size: sizeLabel(it.packKg),
          ordered: `${Math.round(ordN*100)/100} ${um}`,
          produced: `${Math.round(prodN*100)/100} ${um}${isWarn ? " ⚠" : ""}`,
          lot: it.lot || "—",
          date: it.completedAtClientMs ? new Date(it.completedAtClientMs).toLocaleString("it-IT") : "",
          problems: (it.problems || it.problemsLast || "").trim()
        };
        drawRow(row, isWarn);
      }

      // Firma (ultima disponibile)
      const lastWithSig = [...items].reverse().find(x=>x.signatureDataUrl);
      if(lastWithSig && lastWithSig.signatureDataUrl){
        if(y + 110 + margin > H) newPage();
        doc.setFont("helvetica","bold"); doc.setFontSize(11);
        doc.text("Firma operatore (ultima registrata)", margin, y+20);
        try{
          const sigUrl = lastWithSig.signatureDataUrl;
          const fmt = (typeof sigUrl === "string" && sigUrl.startsWith("data:image/jpeg")) ? "JPEG" : "PNG";
          doc.addImage(sigUrl, fmt, margin, y+30, 220, 70);
        } catch(e){}
      }

      const blob = doc.output("blob");
      const fname = `backup_linea_polveri_${new Date().toISOString().slice(0,10)}.pdf`;
      const file = new File([blob], fname, { type:"application/pdf" });

      const canShareFiles = !!(navigator.share && navigator.canShare && navigator.canShare({ files:[file] }));
      if(canShareFiles){
        await navigator.share({ files:[file], title:"Backup produzione", text:"Backup produzione linea polveri" });
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = fname;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }
    }

    $("btnBackup")?.addEventListener("click", (e)=>{
      e.preventDefault();
      buildBackupPdf().catch(err=>alert("Errore PDF: " + (err?.message||err)));
    });

    // ===== Undo all (admin) =====
    $("btnUndoAll")?.addEventListener("click", async (e)=>{
      e.preventDefault();
      const pw = prompt("Password admin per annullare TUTTI i completati:") || "";
      if(pw !== ADMIN_PW){ alert("Password errata."); return; }
      const n = _doneMap.size;
      if(n===0){ alert("Nessun completato."); return; }
      if(!confirm(`Confermi annullo di ${n} completati?`)) return;

      try{
        for(const k of Array.from(_doneMap.keys())){
          await deleteDoc(doc(DONE_COLL(), k));
        }
      }catch(err){
        alert("Errore annullo tutti: " + (err?.message||err));
      }
    });

    // ===== IA intelligente (ETICHETTE) =====
    const _ia = { label:null, selected:new Set(), map:new Map(), groups:[], labels:[] };

    // Label / etichette (AI mode)
    const LABEL_SUFFIX_BLACKLIST = new Set([
      "big","bb","bigbag","b4green","green",
      "kg","pz","lt","l"
    ]);
    const LABEL_ALIASES = { viri:"viridia", nserbios:"serbios", nserbio:"serbios", serbio:"serbios", spitellialga:"spitelli", spitelli:"spitelli" };
    const CUSTOMER_LABEL_RULES = [
      { re: /\bSPITELLI\s+ALGA\b/i, label: "spitelli" },
      { re: /\bSPITELLI\b/i, label: "spitelli" },
      { re: /GOSPOARSTWO\s+SADOWNICZE\s+PAWEL/i, label: "pawel" },
      { re: /\bGIORDANO\s+LUCIANO\b/i, label: "generalcopper" },
      { re: /\bF\.?\s*LLI\s+MORONI\b/i, label: "generalcopper" },
      { re: /\bGENERAL\s+COPPER\b/i, label: "generalcopper" }
    ];
    function extractLabelFromLine(line){
      const fromCode = extractLabelFromCode(line?.code);
      if(fromCode) return fromCode;
      const cust = String(line?.customer||"");
      for(const r of CUSTOMER_LABEL_RULES){
        if(r.re.test(cust)) return r.label;
      }
      return "";
    }
    function prettyLabel(k){
      const s = norm(k);
      if(s==="generalcopper") return "General Copper";
      if(s==="pawel") return "PAWEL (PL)";
      if(s==="viridia") return "Viridia";
      if(s==="spitelli") return "Spitelli Alga";
      return (k||"").toUpperCase();
    }

    function extractLabelFromCode(code){
      const s = String(code||"").trim();
      const m = s.match(/([A-Za-z]{3,})$/);
      if(!m) return "";
      const raw = norm(m[1]).replace(/\s+/g,'');
      const ali = LABEL_ALIASES[raw];
      const lab = ali || raw;
      if(LABEL_SUFFIX_BLACKLIST.has(lab)) return "";
      return lab;
    }
    function levenshtein(a,b){
      a = norm(a); b = norm(b);
      const n = a.length, m = b.length;
      if(!n) return m; if(!m) return n;
      const dp = new Array(m+1);
      for(let j=0;j<=m;j++) dp[j]=j;
      for(let i=1;i<=n;i++){
        let prev = dp[0];
        dp[0]=i;
        for(let j=1;j<=m;j++){
          const tmp = dp[j];
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[j] = Math.min(dp[j]+1, dp[j-1]+1, prev+cost);
          prev = tmp;
        }
      }
      return dp[m];
    }
    function bestLabelMatch(q, labels){
      const s = norm(q).replace(/\s+/g,'');
      if(!s) return null;
      let best = null;
      let bestScore = Infinity;
      for(const l of labels){
        if(!l) continue;
        if(l===s) return l;
        if(l.includes(s) || s.includes(l)) return l;
        const d = levenshtein(s, l);
        if(d < bestScore){ bestScore = d; best = l; }
      }
      // soglia: stringhe corte tollerano poco
      if(best==null) return null;
      const thr = s.length<=4 ? 1 : (s.length<=7 ? 2 : 3);
      return bestScore<=thr ? best : null;
    }

    function getAvailableLabels(){
      const set = new Set();
      const lines = _powderLines.filter(l => !lineDone(l.lineKey) && isValidOrderLine(l));
      for(const l of lines){
        const lab = extractLabelFromLine(l);
        if(lab) set.add(lab);
      }
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function openIa(){
      const m = $("iaModal");
      if(!m) return;
      _ia.label = null;
      _ia.selected = new Set();
      _ia.map = new Map();
      _ia.groups = [];
      _ia.labels = getAvailableLabels();
      $("iaStep0").style.display = "";
      $("iaStep1").style.display = "none";
      $("iaLabelInput").value = "";
      renderIaLabelChips(_ia.labels);
      $("iaSelInfo").textContent = "0 selezionati";
      $("iaConfirm").disabled = true;
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    function closeIa(){
      const m = $("iaModal");
      if(!m) return;
      unlockBodyScroll();
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }

    function renderIaLabelChips(labels){
      const wrap = $("iaLabelChips");
      const no = $("iaNoLabels");
      if(!wrap || !no) return;
      if(!labels || labels.length===0){
        wrap.innerHTML = "";
        no.style.display = "";
        return;
      }
      no.style.display = "none";
      wrap.innerHTML = labels.map(l=>`<div class="chip" data-l="${l}">${prettyLabel(l)}</div>`).join("");
      wrap.querySelectorAll('.chip').forEach(c=>{
        c.addEventListener('click', ()=> chooseIaLabel(c.getAttribute('data-l')));
      });
    }

    function chooseIaLabel(label){
      const l = norm(label);
      if(!l) return;
      _ia.label = l;
      $("iaChosen").textContent = `Ordini etichetta: ${prettyLabel(l)}`;
      $("iaStep0").style.display = "none";
      $("iaStep1").style.display = "";
      renderIaListForLabel();
    }

    function renderIaListForLabel(){
      const list = $("iaList");
      _ia.selected = new Set();
      _ia.map = new Map();

      const pending = _powderLines.filter(l => !lineDone(l.lineKey) && isValidOrderLine(l));
      const filtered = pending.filter(l => {
        const lab = extractLabelFromLine(l);
        if(!lab) return false;
        if(lab === _ia.label) return true;
        // fallback: contiene testo
        return norm(l.code).includes(_ia.label);
      });

      const groups = groupProducts(filtered);
      _ia.groups = groups;

      if(groups.length===0){
        list.innerHTML = '<div class="empty">Nessun articolo polveri trovato per questa etichetta.</div>';
        $("iaConfirm").disabled = true;
        $("iaSelInfo").textContent = "0 selezionati";
        return;
      }

      const byMat = new Map();
      for(const g of groups){
        const m = g.material || "altro";
        const arr = byMat.get(m) || [];
        arr.push(g);
        byMat.set(m, arr);
      }
      const mats = Array.from(byMat.entries()).sort((a,b)=>a[0].localeCompare(b[0]));

      list.innerHTML = mats.map(([mat, arr])=>{
        arr.sort((a,b)=> (b.kg-a.kg) || a.label.localeCompare(b.label));
        return `
          <div class="sec">
            <div class="secHead">${mat.toUpperCase()}</div>
            ${arr.map(g=>{
              const kg = Math.round(g.kg*10)/10;
              const custs = Array.from(new Set((g.lines||[]).map(x=>x.customer).filter(Boolean)));
              const who = custs.length===0 ? "—" : (custs.length===1 ? custs[0] : (custs[0] + " +" + (custs.length-1)));
              _ia.map.set(g.key, g.lines.map(x=>x.lineKey));
              return `
                <div class="row iaRow" data-g="${g.key}">
                  <label class="check">
                    <input type="checkbox">
                    <span></span>
                  </label>
                  <div class="l">
                    <div class="t">${g.label}</div>
                    <div class="metaLine">
                      <span class="mono">${g.code||"—"}</span>
                      <span class="sep">•</span><span class="mono">${who}</span>
                      <span class="sep">•</span>${g.size||"—"}
                      <span class="sep">•</span><span class="mono">${kg} kg</span>
                      <span class="sep">•</span><span class="mono">${g.lines.length} righe</span>
                      ${g.lines.length>1 ? `<span class="sep">•</span><span class="miniBtn" data-toggle="${g.key}">Righe</span>` : ``}
                    </div>
                    ${g.lines.length>1 ? `
                      <div class="iaSubRows" data-sub="${g.key}" style="display:none;">
                        ${g.lines.map(ln=>{
                          const ord = parseFloat(String(ln.qty||"0").replace(",","."));
                          const prod = getDoneProducedQty(ln.lineKey);
                          const rem = Math.max(0, (Number.isFinite(ord)?ord:0) - prod);
                          const u = (ln.um||"").toUpperCase();
                          return `
                            <div class="iaLine" data-line="${ln.lineKey}">
                              <div class="t">${cleanTitle(ln.description||"")}</div>
                              <div class="metaLine"><span class="mono">${ln.customer||"—"}</span><span class="sep">•</span><span class="mono">N. ordine: ${ln.docNumber||"—"}</span></div>
                              <div class="metaLine"><span class="mono">${ln.code||"—"}</span><span class="sep">•</span>${ln.customer||"Cliente"}<span class="sep">•</span>Ord: <span class="mono">${Number.isFinite(ord)?ord:0} ${u}</span><span class="sep">•</span>Da fare: <span class="mono">${Math.round(rem*100)/100} ${u}</span></div>
                              <div style="margin-top:8px; display:flex; justify-content:flex-end;">
                                <span class="miniBtn" data-produce="${ln.lineKey}">Produci riga</span>
                              </div>
                            </div>
                          `;
                        }).join("")}
                      </div>
                    `: ``}
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }).join("");

      list.querySelectorAll(".iaRow input[type=checkbox]").forEach(cb=>{
        cb.addEventListener("change", ()=>{
          const gid = cb.closest(".iaRow")?.getAttribute("data-g") || "";
          const keys = _ia.map.get(gid) || [];
          if(cb.checked) keys.forEach(k=>_ia.selected.add(k));
          else keys.forEach(k=>_ia.selected.delete(k));
          $("iaConfirm").disabled = _ia.selected.size===0;
          $("iaSelInfo").textContent = `${_ia.selected.size} selezionati`;
        });
      
      
      // Selezione facile: clic su tutta la riga (non solo sul flag)
      list.querySelectorAll(".iaRow").forEach(row=>{
        row.addEventListener("click",(ev)=>{
          if(ev.target && ev.target.closest && (ev.target.closest('input') || ev.target.closest('button') || ev.target.closest('[data-toggle]') || ev.target.closest('[data-produce]'))) return;
          const cb = row.querySelector('input[type=checkbox]');
          if(!cb) return;
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        });
      });

// Toggle righe + produzione per riga
      list.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          const gid = btn.getAttribute("data-toggle") || "";
          const sub = list.querySelector(`[data-sub="${gid}"]`);
          if(!sub) return;
          const isOpen = sub.style.display !== "none";
          sub.style.display = isOpen ? "none" : "block";
        });
      });
      list.querySelectorAll("[data-produce]").forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          const k = btn.getAttribute("data-produce") || "";
          const ln = _powderLines.find(x=>x.lineKey===k);
          if(!ln) return;
          _pendingBatch = { title: `IA • ${prettyLabel(_ia.label)} • Riga`, selectedKeys:[k], lines:[ln] };
          closeIa();
          openSigModal(`${_pendingBatch.title} • 1 riga`);
        });
      });
      list.querySelectorAll(".iaLine").forEach(row=>{
        row.addEventListener("click", (ev)=>{
          // click su riga = produci riga
          const k = row.getAttribute("data-line") || "";
          const ln = _powderLines.find(x=>x.lineKey===k);
          if(!ln) return;
          _pendingBatch = { title: `IA • ${prettyLabel(_ia.label)} • Riga`, selectedKeys:[k], lines:[ln] };
          closeIa();
          openSigModal(`${_pendingBatch.title} • 1 riga`);
        });
      });
});

      $("iaConfirm").disabled = true;
      $("iaSelInfo").textContent = "0 selezionati";
    }

    function iaFindFromInput(){
      const raw = String($("iaLabelInput").value||"").trim();
      if(!_ia.labels || _ia.labels.length===0){
        renderIaLabelChips([]);
        return;
      }
      if(!raw){
        renderIaLabelChips(_ia.labels);
        return;
      }
      const parts = raw.split(/[,;\n\t ]+/).map(x=>x.trim()).filter(Boolean);
      const matches = new Set();
      for(const p of parts){
        const m = bestLabelMatch(p, _ia.labels);
        if(m) matches.add(m);
      }
      const arr = Array.from(matches);
      if(arr.length===1){
        chooseIaLabel(arr[0]);
      } else {
        renderIaLabelChips(arr);
        // se non trova nulla, mostra comunque tutte le etichette
        if(arr.length===0) renderIaLabelChips(_ia.labels);
      }
    }

    $("btnIA")?.addEventListener("click", (e)=>{ e.preventDefault(); openIa(); });
    $("btnIA2")?.addEventListener("click", (e)=>{ e.preventDefault(); openIa(); });
    $("iaClose")?.addEventListener("click", (e)=>{ e.preventDefault(); closeIa(); });
    $("iaModal")?.addEventListener("click", (e)=>{ if(e.target === $("iaModal")) closeIa(); });

    $("iaFind")?.addEventListener("click", (e)=>{ e.preventDefault(); iaFindFromInput(); });
    $("iaLabelInput")?.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); iaFindFromInput(); } });
    $("iaChange")?.addEventListener("click", ()=>{ $("iaStep0").style.display=""; $("iaStep1").style.display="none"; renderIaLabelChips(_ia.labels); });
    $("iaBack")?.addEventListener("click", ()=>{ $("iaStep0").style.display=""; $("iaStep1").style.display="none"; renderIaLabelChips(_ia.labels); });

    $("iaConfirm")?.addEventListener("click", (e)=>{
      e.preventDefault();
      if(_ia.selected.size===0) return;
      const selectedKeys = Array.from(_ia.selected);
      const selectedLines = _powderLines.filter(l=>selectedKeys.includes(l.lineKey));
      _pendingBatch = { title: `IA • ${(_ia.label||"").toUpperCase()}`, selectedKeys, lines:selectedLines };
      closeIa();
      openSigModal(`${_pendingBatch.title} • ${selectedKeys.length} righe`);
    });


    // ===== Revenue (admin) =====
    function computeRevenueByCustomer(){
      const map = new Map();
      for(const d of _rawDocs){
        const hasPowder = (d.lines||[]).some(l=>l.powder);
        if(!hasPowder) continue;
        const cust = d.customer || "Cliente";
        const gross = (d.totale != null) ? d.totale : ((d.imponibile!=null && d.iva!=null) ? (d.imponibile + d.iva) : null);
        const curr = map.get(cust) || { gross:0, known:true, docs:0 };
        if(gross == null) curr.known = false;
        else curr.gross += gross;
        curr.docs += 1;
        map.set(cust, curr);
      }
      return Array.from(map.entries()).map(([cust,v])=>({cust, ...v})).sort((a,b)=>a.cust.localeCompare(b.cust));
    }

    function openRevenueModal(){
      const m = $("revModal");
      const body = $("revBody");
      const rows = computeRevenueByCustomer();
      if(rows.length===0){
        body.innerHTML = '<div class="empty">Nessun documento con righe polveri.</div>';
      } else {
        const total = rows.filter(r=>r.known).reduce((s,r)=>s+r.gross,0);
        body.innerHTML = `
          <div class="row" style="margin-bottom:12px;">
            <div class="l">
              <div class="t">Totale fatturato (ordini polveri)</div>
              <div class="m"><span class="badge ok">${euro(total)}</span><span class="badge">${rows.length} clienti</span></div>
            </div>
          </div>
          ${rows.map(r=>`
            <div class="row">
              <div class="l">
                <div class="t">${r.cust}</div>
                <div class="m">
                  <span class="badge">${r.docs} doc</span>
                  <span class="badge warn">${r.known ? euro(r.gross) : "Totale non disponibile (mancano tag in XML)"}</span>
                </div>
              </div>
            </div>
          `).join("")}
        `;
      }
      lockBodyScroll();
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    function closeRevenueModal(){
      const m = $("revModal");
      unlockBodyScroll();
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }
    $("btnRevenue").addEventListener("click",(e)=>{
      e.preventDefault();
      const pwd = prompt("Password admin:");
      if(pwd !== "12345") return;
      openRevenueModal();
    });

    // teaser "Fatturato" (sfocato) in fondo
    const _revTeaser = $("revTeaser");
    if(_revTeaser){
      const go = (e)=>{ e.preventDefault(); e.stopPropagation(); $("btnRevenue").click(); };
      _revTeaser.addEventListener("click", go);
      _revTeaser.addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" ") go(e); });
    }
    $("revClose").addEventListener("click",(e)=>{ e.preventDefault(); closeRevenueModal(); });
    $("revModal").addEventListener("click",(e)=>{ if(e.target === $("revModal")) closeRevenueModal(); });

    // ===== Info =====
    $("btnHelp").addEventListener("click", (e)=>{
      e.preventDefault();
      alert(
        "Questo hub legge SOLO XML dalla cartella Drive (file Documenti.DefXml).\n\n" +
        "Viste:\n- Clienti: solo articoli in polvere\n- Per materia prima: tot kg rame/zolfo/caolino\n- Per formato: tot kg per 1kg/5kg/25kg ecc\n- Art. non pertinenti: tutto il resto\n\n" +
        "Per segnare completato: apri cliente → spunta righe → firma → salva."
      );
    });
  
</script>
  <!-- IA intelligente -->
  <div class="modal full" id="iaModal" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div class="h">IA intelligente</div>
          <div class="sub" id="iaSub">Dimmi le etichette disponibili: ti mostro gli ordini e ti porto in produzione.</div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="iaClose" type="button">Chiudi</button>
        </div>
      </div>

      <div class="iaBody">
        <div class="iaStep" id="iaStep0">
          <div class="iaQ">Che etichette hai?</div>
          <div class="iaInputRow">
            <input class="iaInput" id="iaLabelInput" type="text" placeholder="Es: Serbios, Viridia, Spitelli Alga" autocomplete="off" />
            <button class="btn primary" id="iaFind" type="button">Cerca</button>
          </div>
          <div class="muted" style="font-size:12px; margin-top:8px;">Scrivi anche male: riconosco lo stesso.</div>

          <div style="margin-top:12px;">
            <div class="secHead">Etichette trovate negli ordini</div>
            <div class="chips" id="iaLabelChips"></div>
            <div class="empty" id="iaNoLabels" style="display:none;">Nessuna etichetta trovata.</div>
          </div>
        </div>

        <div class="iaStep" id="iaStep1" style="display:none;">
          <div class="row" style="align-items:flex-start;">
            <div class="l">
              <div class="iaQ" id="iaChosen">Ordini etichetta: —</div>
              <div class="muted" id="iaSub2" style="font-size:12px;">Seleziona gli articoli pertinenti da produrre.</div>
            </div>
            <div class="actions">
              <button class="btn ghost" id="iaChange" type="button">Cambia etichetta</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="l" style="min-width:0;">
              <div class="iaQ">Articoli (polveri) per questa etichetta</div>
              <div class="list pickList" id="iaList"></div>
            </div>
          </div>

          <div class="iaBar">
            <div class="muted" id="iaSelInfo">0 selezionati</div>
            <div class="actions">
              <button class="btn ghost" id="iaBack" type="button">Indietro</button>
              <button class="btn ok" id="iaConfirm" type="button" disabled>Produci / Completa</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<a id="callMatteo" class="callMatteo" href="tel:+393516709334">📞 Matteo</a>

  <!-- Modal: Filtri -->
  <div class="modal full" id="filtersModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="boxHead">
        <div>
          <div class="h">Filtri</div>
          <div class="s">Seleziona la vista ordini</div>
        </div>
        <button class="btn ghost" id="filtersClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody">
        <div style="display:grid; gap:10px;">
          <button class="btn primary" data-viewpick="customer" type="button">Clienti</button>
          <button class="btn ghost" data-viewpick="article" type="button">Per articolo</button>
          <button class="btn ghost" data-viewpick="size" type="button">Per formato</button>
          <button class="btn ghost" data-viewpick="product" type="button">Per prodotto</button>
          <button class="btn ghost" data-viewpick="other" type="button">Art. non pertinenti</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
