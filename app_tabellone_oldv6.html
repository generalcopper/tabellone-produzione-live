<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LINEA LIQUIDI AUTOMATICA</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg0:#05060a; --bg1:#070b12;
      --panel: rgba(10,14,24,.82);
      --line: rgba(120,255,255,.22);
      --text:#eaf7ff;
      --neonCyan:#35f2ff; --neonMag:#ff2bd6; --neonYel:#ffe66d;
      --todo:#35f2ff; --done:#2bff88;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      background:
        radial-gradient(1400px 1100px at 10% 10%, rgba(53,242,255,.10), transparent 55%),
        radial-gradient(1400px 1100px at 85% 15%, rgba(255,43,214,.08), transparent 55%),
        radial-gradient(1200px 900px at 70% 90%, rgba(255,230,109,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(to bottom,
        rgba(255,255,255,.016), rgba(255,255,255,.016) 1px,
        transparent 1px, transparent 7px);
      opacity:.18; pointer-events:none; mix-blend-mode:overlay;
      z-index:1;
    }
    .wrap{height:100%;display:flex;flex-direction:column;padding:18px;gap:14px;position:relative;z-index:2;}
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow:
        0 0 0 1px rgba(53,242,255,0.10),
        0 14px 34px rgba(0,0,0,0.50),
        0 0 46px rgba(53,242,255,0.05),
        0 0 56px rgba(255,43,214,0.03);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }
    .top{display:flex;gap:12px}

    .titleCard{flex:1;position:relative;isolation:isolate;min-width:520px;padding:0;}
    .titlePad{padding:18px 20px; position:relative; z-index:2;}
    .titleCard:before{
      content:""; position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(53,242,255,0.00), rgba(53,242,255,0.20), rgba(255,43,214,0.16), rgba(53,242,255,0.00));
      filter: blur(9px); opacity:0.52; transform: translate3d(-60%,0,0);
      animation: sweep 6.5s linear infinite; pointer-events:none; z-index:0; will-change: transform;
    }
    @keyframes sweep{0%{transform: translate3d(-60%,0,0)}100%{transform: translate3d(60%,0,0)}}
    .titleGrid{
      position:absolute; inset:0;
      background: linear-gradient(to right, rgba(53,242,255,0.10) 1px, transparent 1px),
                  linear-gradient(to bottom, rgba(255,43,214,0.08) 1px, transparent 1px);
      background-size:120px 120px; opacity:0.16; mix-blend-mode: screen;
      transform: translate3d(0,0,0); animation: gridPan 10s linear infinite;
      pointer-events:none; z-index:1; will-change: transform;
    }
    @keyframes gridPan{0%{transform: translate3d(0,0,0)}100%{transform: translate3d(240px,240px,0)}}

    .title{margin:0;font-size:64px;font-weight:950;letter-spacing:1.2px;text-transform:uppercase;text-shadow:0 0 26px rgba(53,242,255,0.16);position:relative;z-index:3;}
    .subtitle{margin-top:10px;color:rgba(200,230,255,.72);font-size:18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;position:relative;z-index:3;}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);font-weight:900;letter-spacing:0.7px;text-transform:uppercase;font-size:14px;}
    .chip.live{border-color:rgba(53,242,255,0.24);box-shadow:0 0 16px rgba(53,242,255,0.10)}
    .liveDot{width:10px;height:10px;border-radius:999px;background:var(--neonCyan);
      box-shadow:0 0 0 6px rgba(53,242,255,0.12),0 0 18px rgba(53,242,255,0.22);
      animation:livePulse 1.6s ease-in-out infinite;}
    @keyframes livePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5)}}

    .clockCard{width:560px;padding:16px;display:flex;flex-direction:column;gap:10px;align-items:flex-end;flex:0 0 auto;}
    .dateBig{font-size:34px;font-weight:950;margin:0;letter-spacing:0.6px;text-transform:capitalize}
    .timeGrid{display:grid;grid-template-columns:120px 1fr;gap:10px 14px;align-items:baseline;font-variant-numeric:tabular-nums;width:100%}
    .timeLabel{text-align:right;font-size:18px;font-weight:900;color:rgba(200,230,255,0.72);letter-spacing:1px;text-transform:uppercase}
    .timeVal{font-size:96px;font-weight:950;line-height:.95;
      text-shadow:0 0 24px rgba(255,43,214,0.12),0 0 20px rgba(53,242,255,0.10);}

    .weatherCard{width:520px;padding:16px;display:flex;flex-direction:column;gap:10px;align-items:flex-start;flex:0 0 auto;}
    .wTitle{font-size:18px;font-weight:950;letter-spacing:1px;text-transform:uppercase;color:rgba(200,230,255,.78);display:flex;align-items:center;gap:10px}
    .wPulse{width:10px;height:10px;border-radius:999px;background:var(--neonMag);box-shadow:0 0 0 6px rgba(255,43,214,0.10);animation:livePulse 1.8s ease-in-out infinite;}
    .wMain{display:flex;align-items:flex-end;gap:16px;width:100%;}
    .wTemp{font-size:92px;font-weight:950;line-height:.95;text-shadow:0 0 18px rgba(255,230,109,0.10);}
    .wDesc{font-size:28px;font-weight:900;color:rgba(200,230,255,.78);line-height:1.1}
    .wMeta{display:flex;gap:14px;flex-wrap:wrap;color:rgba(200,230,255,.72);font-size:18px;font-weight:850}
    .wPill{border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);border-radius:999px;padding:8px 12px;}
    .wSmall{font-size:14px;color:rgba(200,230,255,.55);font-weight:850;letter-spacing:0.4px}

    .board{flex:1;display:flex;flex-direction:column;min-height:0;}
    .header,.row{display:grid;grid-template-columns:2.4fr 520px 360px;align-items:center;gap:16px;padding:0 18px;}
    .header{height:70px;border-bottom:1px solid rgba(120,255,255,.16);font-size:18px;font-weight:900;text-transform:uppercase;color:rgba(200,230,255,.78);background:rgba(255,255,255,0.03);flex:0 0 auto;}
    .rows{flex:1 1 auto;min-height:0;overflow:auto;}
    .row{height:112px;border-bottom:1px solid rgba(120,255,255,.11);position:relative;flex:0 0 auto;}
    .product{font-size:64px;font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 18px rgba(53,242,255,0.10);}
    .qtyFmt{justify-self:end;display:flex;align-items:baseline;gap:18px;font-variant-numeric:tabular-nums;white-space:nowrap;}
    .qty{font-size:60px;font-weight:950;text-shadow:0 0 16px rgba(255,230,109,0.09)}
    .fmt{font-size:36px;color:rgba(200,230,255,.74);font-weight:850;letter-spacing:0.4px}
    .statusWrap{justify-self:end;display:flex;align-items:center;gap:14px;white-space:nowrap}
    .badge{display:inline-flex;align-items:center;gap:12px;padding:16px 20px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);font-size:34px;font-weight:950;text-transform:uppercase;letter-spacing:0.8px;box-shadow:0 0 20px rgba(53,242,255,0.07);}
    .dot{width:16px;height:16px;border-radius:999px;background:var(--todo);box-shadow:0 0 0 6px rgba(53,242,255,.14);}
    .badge.todo{border-color:rgba(53,242,255,.26)}
    .badge.todo .dot{background:var(--todo)}
    .badge.done{border-color:rgba(43,255,136,.28)}
    .badge.done .dot{background:var(--done);box-shadow:0 0 0 6px rgba(43,255,136,.14)}
    .blink{animation:softPulse 2.0s ease-in-out infinite}
    @keyframes softPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.18)}}

    .debug{position:fixed;left:12px;bottom:10px;z-index:3;color:rgba(200,230,255,0.55);font-size:12px;letter-spacing:0.4px;user-select:none;max-width:85vw;}
  
    /* --- azioni produzione (locale) --- */
    .badge.btn{
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .12s ease;
    }
    .badge.btn:active{ transform: scale(0.98); filter: brightness(1.06); }

    .producedCard{
      margin-top: 14px;
      padding: 14px;
    }
    .prodHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .prodTitle{
      font-weight:900;
      letter-spacing:.3px;
      font-size: 16px;
    }
    .prodHint{
      font-size: 12px;
      opacity:.75;
    }
    .prodList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 180px;
      overflow:auto;
      padding-right: 4px;
    }
    .prodEmpty{
      opacity:.65;
      font-size: 13px;
      padding: 10px 12px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
    }
    .prodItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
    }
    .prodText{
      font-size: 13px;
      line-height:1.25;
      opacity:.95;
    }
    .prodQty{
      font-weight:900;
      margin-left:6px;
    }
    .undoBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: inherit;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .undoBtn:active{ transform: scale(0.99); }

    
/* --- mobile layout --- */
@media (max-width: 820px){
  .wrap{ padding: 10px; }
  .card.top{ padding: 14px 14px; }
  .top h1{ font-size: 22px; }
  .meta{ flex-wrap: wrap; gap: 8px; }
  .chip{ font-size: 12px; padding: 8px 10px; }
  .board{ border-radius: 18px; }
  .header{ display:none; }
  .rows{ padding: 6px 0; }
  .row{
    display:block;
    height:auto;
    padding: 14px 14px;
    gap: 10px;
  }
  .product{
    font-size: 28px;
    white-space: normal;
    line-height: 1.05;
    margin-bottom: 8px;
  }
  .qtyFmt{
    justify-self: unset;
    display:flex;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 10px;
  }
  .qty{ font-size: 30px; }
  .fmt{ font-size: 16px; }
  .statusWrap{
    justify-self: unset;
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
  }
  .badge{
    font-size: 12px;
    padding: 10px 12px;
    border-radius: 999px;
  }
  .dot{ width: 12px; height: 12px; box-shadow: 0 0 0 4px rgba(53,242,255,.14); }
  .badge.done .dot{ box-shadow: 0 0 0 4px rgba(43,255,136,.18); }
  .badge.wip .dot{ box-shadow: 0 0 0 4px rgba(255,189,67,.18); }

  /* completati box */
  .prodList{ max-height: 220px; }
  .prodItem{ gap: 8px; }
  .undoBtn{ padding: 8px 10px; font-size: 12px; }
}

/* --- modal --- */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(6px);
      z-index: 9999;
    }
    .modal.show{ display:flex; }
    .modalBox{
      width:min(520px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(10,12,20,.92);
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      padding: 18px;
    }
    .modalTitle{
      font-weight: 1000;
      font-size: 22px;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .modalSub{
      opacity:.75;
      margin-bottom: 14px;
      font-size: 13px;
    }
    .modalInput{
      width:100%;
      font-size: 22px;
      font-weight: 900;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: inherit;
      outline: none;
    }
    .modalInput:focus{ border-color: rgba(120,180,255,.55); }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top: 14px;
    }
    .btnGhost, .btnOk{
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: inherit;
    }
    .btnOk{
      border-color: rgba(120,180,255,.45);
      background: rgba(120,180,255,.18);
    }

/* ===== MOBILE COMPACT ===== */
@media (max-width: 640px) {

  html {
    font-size: 14px;
  }

  .wrap {
    padding: 8px;
  }

  .card {
    margin: 8px 0;
  }

  table td, table th {
    padding: 6px 8px;
    font-size: 13px;
  }

  .badge, .btn {
    font-size: 12px;
    padding: 5px 8px;
  }

  .title {
    font-size: 18px;
  }

  .subtitle {
    font-size: 12px;
  }
    /* ===== COMPACT HEADER (solo mobile) ===== */

  .card.top {
    padding: 8px !important;
  }

  .titleCard {
    padding: 6px 8px !important;
  }

  .titlePad {
    padding: 0 !important;
  }

  .title {
    font-size: 16px !important;
    margin: 0 0 6px 0 !important;
    line-height: 1.15;
  }

  .subtitle {
    gap: 6px !important;
    flex-wrap: wrap;
  }

  .chip {
    font-size: 11px !important;
    padding: 4px 8px !important;
  }
}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card top" style="padding:0">
      <div class="titleCard">
        <div class="titleGrid"></div>
        <div class="titlePad">
          <p class="title">LINEA LIQUIDI AUTOMATICA</p>
          <div class="subtitle">
            <span class="chip live"><span class="liveDot"></span>LIVE</span>
            <span class="chip">Aggiornamento: 60s</span>
            <span class="chip">Versione: 2025-12-16 22:52:19 UTC</span>
          </div>
        </div>
      </div>

      <div class="card weatherCard">
        <div class="wTitle"><span class="wPulse"></span>METEO • Concamarise (VR)</div>
        <div class="wMain">
          <div class="wTemp" id="wTemp">--°</div>
          <div>
            <div class="wDesc" id="wDesc">Carico…</div>
            <div class="wSmall" id="wUpdated">—</div>
          </div>
        </div>
        <div class="wMeta">
          <div class="wPill">Vento <span id="wWind">—</span> km/h</div>
          <div class="wPill">Pioggia <span id="wRain">—</span>% (1h)</div>
        </div>
        <div class="wSmall">Auto-update meteo: 10 min</div>
      </div>

      <div class="card clockCard">
        <p class="dateBig" id="dateLine">----</p>
        <div class="timeGrid">
          <div class="timeLabel">ITALIA</div><div class="timeVal" id="timeIT">--:--</div>
          <div class="timeLabel">中国</div><div class="timeVal" id="timeCN">--:--</div>
        </div>
      </div>
    </div>

    <div class="card board">
      <div class="header">
        <div>Prodotto</div>
        <div style="justify-self:end">Quantità / formato</div>
        <div style="justify-self:end">Stato</div>
      </div>
      <div class="rows" id="rows"></div>
    </div>

    <div class="card producedCard" id="producedCard">
      <div class="prodHead">
        <div class="prodTitle">Completati (cloud)</div>
        <div class="prodHint">Sincronizzato su tutti i dispositivi</div>
      </div>
      <div class="prodList" id="producedList">
        <div class="prodEmpty" id="producedEmpty">Nessuna riga completata.</div>
      </div>
    </div>
  </div>

  <!-- Modal quantità prodotta -->
  <div class="modal" id="qtyModal" aria-hidden="true">
    <div class="modalBox" role="dialog" aria-modal="true" aria-labelledby="qtyTitle">
      <div class="modalTitle" id="qtyTitle">Quanti pezzi hai prodotto?</div>
      <div class="modalSub" id="qtyModalSub">—</div>
      <input class="modalInput" id="qtyInput" inputmode="numeric" pattern="[0-9]*" placeholder="Es. 120" />
      <div class="modalActions">
        <button class="btnGhost" id="qtyCancel">Annulla</button>
        <button class="btnOk" id="qtyOk">OK</button>
      </div>
    </div>
  </div>

  <div class="debug" id="debug"></div>

<script type="module">
  // ===== Firebase (Cloud Firestore) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // Ogni giorno ha la sua "stanza" (così si resetta automaticamente a mezzanotte)
  const TODAY = new Intl.DateTimeFormat("sv-SE",{timeZone:"Europe/Rome"}).format(new Date()); // YYYY-MM-DD (Italia)
  const producedCol = collection(db, "producedDays", TODAY, "items");

  // Doc id sicuro (niente "/")
  const keyToDocId = (key) => encodeURIComponent(key);

  // Stato cloud: key -> { qty, label, ts }
  const producedCloud = new Map();

  function markProducedCloud(key, qty, label){
    const id = keyToDocId(key);
    return setDoc(doc(producedCol, id), {
      key, qty, label,
      ts: serverTimestamp()
    }, { merge: true });
  }

  function unmarkProducedCloud(key){
    const id = keyToDocId(key);
    return deleteDoc(doc(producedCol, id));
  }

  // Render lista "completati" dal cloud
  function renderProducedFromCloud(){
    const list = document.getElementById("producedList");
    const empty = document.getElementById("producedEmpty");
    if(!list) return;

    list.innerHTML = "";
    if(!producedCloud.size){
      if(empty) empty.style.display = "";
      list.appendChild(empty);
      return;
    }
    if(empty) empty.style.display = "none";

    // ordina: più recenti in alto (ts può essere null appena scritto)
    const items = [...producedCloud.entries()].map(([key,v])=>({key,...v}));
    items.sort((a,b)=>{
      const ta = a.ts?.toMillis?.() ?? 0;
      const tb = b.ts?.toMillis?.() ?? 0;
      return tb - ta;
    });

    for(const it of items){
      const item = document.createElement("div");
      item.className = "prodItem";
      item.innerHTML = `
        <div class="prodText">${escapeHtml(it.label || it.key)} • <span class="prodQty">${escapeHtml(String(it.qty))}</span></div>
        <button class="undoBtn" type="button">Annulla</button>
      `;
      item.querySelector(".undoBtn")?.addEventListener("click", () => {
        const ok = window.confirm("Sicuro che vuoi annullare?");
        if(!ok) return;
        unmarkProducedCloud(it.key).catch(()=>{});
      });
      list.appendChild(item);
    }
  }

  function initFirestoreRealtime(){
    // Listener realtime: ogni device vede subito gli update
    onSnapshot(producedCol, (snap) => {
      producedCloud.clear();
      snap.forEach(d => {
        const v = d.data() || {};
        if(v?.key) producedCloud.set(v.key, v);
      });
      renderProducedFromCloud();

      // Se ho già le righe renderizzate, aggiorna visibilità senza aspettare il refresh CSV
      for(const [key, el] of rowNodes.entries()){
        el.style.display = producedCloud.has(key) ? "none" : "";
      }
    });
  }

  // ===== App tabellone (CSV + UI) =====
  const REFRESH_MS = 60000;

  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbRcMc9ZdrJ0o7jCJZfyCeGuGD3pgxurwbxO6NO_2kizrkg0czCQYR3g0YmUyWffgyBkmBdNe9fiB/pub?output=csv";

  const WX_LAT = 45.2153;
  const WX_LON = 11.1462;
  const WX_TZ  = "Europe/Rome";
  const WX_REFRESH_MS = 10 * 60 * 1000; // 10 minuti

  let inFlight = false;
  let lastHash = "";
  const rowNodes = new Map();

  // avvia sync realtime con Firestore
  initFirestoreRealtime();

  // --- produzione CLOUD (sincronizzata) ---
let pendingKey = null;

function showModalForRow(rowEl){
  const key = rowEl.dataset.key;
  if(!key) return;

  // blocca doppio inserimento
  if(producedCloud.has(key)) return;

  pendingKey = key;
  const sub = document.getElementById("qtyModalSub");
  const input = document.getElementById("qtyInput");
  const modal = document.getElementById("qtyModal");

  sub.textContent = (rowEl.dataset.label || "Riga selezionata");
  input.value = "";
  modal.classList.add("show");
  modal.setAttribute("aria-hidden","false");

  setTimeout(()=>{ input.focus(); input.select(); }, 40);
}

function closeModal(){
  const modal = document.getElementById("qtyModal");
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden","true");
  pendingKey = null;
}

async function confirmProduced(){
  if(!pendingKey) return;
  const input = document.getElementById("qtyInput");
  const qtyRaw = (input.value || "").trim().replace(",", ".");
  const qty = Number(qtyRaw);

  if(!Number.isFinite(qty) || qty <= 0){
    input.focus();
    input.select();
    return;
  }

  const rowEl = rowNodes.get(pendingKey);
  if(!rowEl){ closeModal(); return; }

  const label = rowEl.dataset.label || "Riga prodotta";

  // Scrive su Firestore: tutti i device aggiornano in tempo reale
  try{
    await markProducedCloud(pendingKey, qty, label);
  }catch(e){
    console.log("Firestore write error:", e);
  }finally{
    closeModal();
  }
}
// utility: escaping sicuro per HTML
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }


  const debugEl = document.getElementById("debug");

  // --- bind modal buttons ---
  const qtyCancelBtn = document.getElementById("qtyCancel");
  const qtyOkBtn = document.getElementById("qtyOk");
  const qtyModal = document.getElementById("qtyModal");
  const qtyInput = document.getElementById("qtyInput");

  qtyCancelBtn?.addEventListener("click", closeModal);
  qtyOkBtn?.addEventListener("click", confirmProduced);

  qtyModal?.addEventListener("click", (e) => {
    if(e.target === qtyModal) closeModal();
  });

  qtyInput?.addEventListener("keydown", (e) => {
    if(e.key === "Enter") confirmProduced();
    if(e.key === "Escape") closeModal();
  });

  function dbg(msg){ debugEl.textContent = msg + "   |   BUILD: 2025-12-16 22:52:19 UTC"; }

  function stableHash(jobs){
    return jobs.map(j => [j.product,j.qty,j.unit,j.format,j.status].join("|")).join("§");
  }

  function tickClock(){
    const now = new Date();
    document.getElementById("timeIT").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("timeCN").textContent =
      new Intl.DateTimeFormat("zh-CN",{timeZone:"Asia/Shanghai",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("dateLine").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(now);
  }

  function parseCSV(text){
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;

    for(let i=0;i<text.length;i++) {
      const ch = text[i];
      if(ch === '"') {
        if(inQ && text[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ) {
        row.push(cur); cur="";
      } else if(ch === "\n" && !inQ) {
        row.push(cur); rows.push(row);
        row = []; cur="";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    rows.push(row);
    return rows;
  }

  async function loadJobsCSV(){
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status + " leggendo CSV");
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(v => (v||"").trim() !== ""));
    if(rows.length <= 1) return [];

    const header = rows[0].map(x => (x||"").trim().toLowerCase());
    const idx = {
      product: header.indexOf("product") !== -1 ? header.indexOf("product") : 0,
      qty: header.indexOf("qty") !== -1 ? header.indexOf("qty") : 1,
      unit: header.indexOf("unit") !== -1 ? header.indexOf("unit") : 2,
      format: header.indexOf("format") !== -1 ? header.indexOf("format") : 3,
      status: header.indexOf("status") !== -1 ? header.indexOf("status") : 4,
    };

    const jobs = [];
    for(let i=1;i<rows.length;i++) {
      const r = rows[i];
      const job = {
        product: (r[idx.product] ?? "").trim(),
        qty: (r[idx.qty] ?? "").trim(),
        unit: (r[idx.unit] ?? "").trim(),
        format: (r[idx.format] ?? "").trim(),
        status: (r[idx.status] ?? "").trim(),
      };
      if(!(job.product || job.qty || job.format || job.status)) continue;
      jobs.push(job);
    }
    return jobs;
  }

  function ensureRowEl(){
    const el = document.createElement("div");
    el.className = "row";
    el.innerHTML = `
      <div class="product"></div>
      <div class="qtyFmt">
        <div class="qty"></div>
        <div class="fmt"></div>
      </div>
      <div class="statusWrap">
        <span class="badge"><span class="dot"></span><span class="st"></span></span>
      </div>
    `;
    return el;
  }

  function updateRowEl(el, job){
    el.querySelector(".product").textContent = job.product;
    el.querySelector(".qty").textContent = `${job.qty} ${job.unit}`.trim();
    el.querySelector(".fmt").textContent = job.format;

    const badge = el.querySelector(".badge");
    const stSpan = el.querySelector(".st");
    const st = (job.status || "").toUpperCase();
    const isTodo = st.includes("DA") || st.includes("IN PRODUZIONE");

    badge.classList.toggle("todo", isTodo);
    badge.classList.toggle("done", !isTodo);
    badge.classList.toggle("blink", isTodo);
    stSpan.textContent = job.status || "";

  // "DA PRODURRE" diventa un tasto: inserisci quantità prodotta e nascondi la riga (locale)
badge.classList.toggle("btn", isTodo || st.includes("IN PRODUZIONE"));
badge.onclick = null;

if (isTodo || st.includes("IN PRODUZIONE")) {
  badge.title = "Segna come completato";
  badge.onclick = () => showModalForRow(el);
} else {
  badge.title = "";
}
  }

  function makeKey(job, idx){ return `${job.product}::${job.format}::${idx}`; }

  function renderSoft(jobs){
    const rows = document.getElementById("rows");
    const seen = new Set();

    // La riga "IN PRODUZIONE" deve essere sempre la prima VISIBILE (non già completata)
    let firstActiveIdx = -1;
    for(let i=0;i<jobs.length;i++){
      const k = makeKey(jobs[i], i);
      if(!producedCloud.has(k)) { firstActiveIdx = i; break; }
    }

    jobs.forEach((job, idx) => {
      const key = makeKey(job, idx);
      seen.add(key);

      let el = rowNodes.get(key);
      if(!el) {
        el = ensureRowEl();
        rowNodes.set(key, el);
        rows.appendChild(el);
      } else {
        const cur = rows.children[idx];
        if(cur !== el) rows.insertBefore(el, cur || null);
      }

      // dataset per azioni locali
      el.dataset.key = key;
      el.dataset.label = (`${job.product} • ${job.format}`).replace(/\s+/g,' ').trim();

      // se già marcata come completata localmente, resta nascosta anche dopo refresh
      if(producedCloud.has(key)) {
        el.style.display = "none";
      } else {
        el.style.display = "";
      }
      // FORZA STATO TASTO: la prima riga VISIBILE = IN PRODUZIONE, tutte le altre = DA PRODURRE
      const forcedStatus = (idx === firstActiveIdx) ? "IN PRODUZIONE" : "DA PRODURRE";
      updateRowEl(el, { ...job, status: forcedStatus });
    });

    for(const [key, el] of rowNodes.entries()) {
      if(!seen.has(key)) {
        el.remove();
        rowNodes.delete(key);
      }
    }

    if(jobs.length === 0) {
      rows.innerHTML = "";
      rowNodes.clear();
      const el = ensureRowEl();
      updateRowEl(el, {product:"Nessun dato", qty:"—", unit:"", format:"—", status:"CONTROLLA SHEET"});
      el.querySelector(".badge").classList.add("todo","blink");
      rows.appendChild(el);
    }
  }

  async function refreshJobs(){
    if(inFlight) return;
    inFlight = true;
    try {
      dbg("Carico dati…");
      const jobs = await loadJobsCSV();
      const h = stableHash(jobs);
      if(h !== lastHash) { lastHash = h; renderSoft(jobs); }
      dbg("OK • aggiornato " + new Date().toLocaleTimeString("it-IT"));
    } catch(e) {
      renderSoft([{product:"Errore lettura sheet", qty:"—", unit:"", format:(e && e.message ? e.message : String(e)), status:"DA PRODURRE"}]);
      dbg("ERRORE • " + (e && e.message ? e.message : String(e)));
    } finally {
      inFlight = false;
    }
  }

  const WCODE = {
    0:"Sereno", 1:"Preval. sereno", 2:"Parz. nuvoloso", 3:"Nuvoloso",
    45:"Nebbia", 48:"Brina/nebbia",
    51:"Pioviggine", 53:"Pioviggine", 55:"Pioviggine",
    61:"Pioggia", 63:"Pioggia", 65:"Pioggia forte",
    71:"Neve", 73:"Neve", 75:"Neve forte",
    80:"Rovesci", 81:"Rovesci", 82:"Rovesci forti",
    95:"Temporale", 96:"Temporale", 99:"Temporale"
  };
  function wdesc(code){ return WCODE[code] || ("Meteo " + code); }

  async function refreshWeather(){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code,wind_speed_10m&hourly=precipitation_probability&timezone=${encodeURIComponent(WX_TZ)}&t=${Date.now()}`;
    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("Meteo HTTP " + res.status);
    const j = await res.json();

    const temp = j?.current?.temperature_2m;
    const code = j?.current?.weather_code;
    const wind = j?.current?.wind_speed_10m;

    let p = null;
    const times = j?.hourly?.time || [];
    const probs = j?.hourly?.precipitation_probability || [];
    if(times.length && probs.length){
      const nowIso = new Date().toISOString().slice(0,13);
      let idx = times.findIndex(t => t.startsWith(nowIso));
      if(idx < 0) idx = 0;
      p = probs[idx];
    }

    document.getElementById("wTemp").textContent = (temp ?? "--") + "°";
    document.getElementById("wDesc").textContent = wdesc(code);
    document.getElementById("wWind").textContent = (wind ?? "—");
    document.getElementById("wRain").textContent = (p ?? "—");
    document.getElementById("wUpdated").textContent = "Agg. " + new Date().toLocaleTimeString("it-IT");
  }

  tickClock();
  setInterval(tickClock, 1000);

  refreshJobs();
  setInterval(refreshJobs, REFRESH_MS);

  refreshWeather().catch(()=>{ document.getElementById("wDesc").textContent="Meteo non disponibile"; });
  setInterval(() => refreshWeather().catch(()=>{}), WX_REFRESH_MS);
</script>
  <script>
  // FORCE FULL PAGE RELOAD (KIOSK SAFE) ogni 5 minuti
  setInterval(() => {
    const url = new URL(window.location.href);
    url.searchParams.set("_kiosk", Date.now()); // bypass cache
    window.location.replace(url.toString());
  }, 5 * 60 * 1000);
</script>
</body>
</html>
