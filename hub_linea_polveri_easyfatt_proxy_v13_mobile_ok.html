<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HUB LINEA POLVERI — EasyFatt XML</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg0:#06101d;
      --bg1:#0a1a2e;
      --panel: rgba(10, 26, 46, .72);
      --panel2: rgba(255,255,255,.06);
      --line: rgba(122, 215, 255, .20);
      --text:#eaf7ff;
      --muted: rgba(234,247,255,.72);
      --accent:#7ad7ff;
      --ok:#4dffb3;
      --warn:#ffd66d;
      --danger:#ff4d6d;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --r: 16px;
      --r2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 900px at 15% 12%, rgba(122,215,255,.12), transparent 55%),
        radial-gradient(900px 800px at 85% 18%, rgba(255,214,109,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{ max-width: 1320px; margin: 0 auto; padding: 14px 14px 26px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: sticky; top: 10px; z-index: 5;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .t{ font-size: 15px; letter-spacing:.8px; font-weight: 800; text-transform: uppercase; }
    .brand .s{ font-size: 12px; color: var(--muted); }
    .statusRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--warn); box-shadow: 0 0 0 3px rgba(255,214,109,.14); }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(77,255,179,.14); }
    .dot.bad{ background: var(--danger); box-shadow: 0 0 0 3px rgba(255,77,109,.14); }
    .mono{ font-family: var(--mono); }
    .btn{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(122,215,255,.38); background: rgba(255,255,255,.085); }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn.primary{ background: rgba(122,215,255,.16); }
    .btn.ghost{ background: rgba(0,0,0,.16); }
    .btn.danger{ background: rgba(255,77,109,.12); border-color: rgba(255,77,109,.22); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 3fr 1.25fr;
      gap: 12px;
      align-items:start;
    }
    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      min-height: 140px;
    }
    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(122,215,255,.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
    }
    .cardHead .h{ font-weight: 900; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    .cardHead .sub{ margin-top:3px; font-size: 12px; color: var(--muted); line-height: 1.25; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding: 10px 14px 12px; border-bottom: 1px solid rgba(122,215,255,.10); background: rgba(255,255,255,.03); }
    .tab{ padding: 9px 12px; border-radius: 999px; border:1px solid rgba(122,215,255,.18); background: rgba(0,0,0,.14); font-weight:800; font-size: 12px; cursor:pointer; color: var(--muted); }
    .tab.on{ background: rgba(122,215,255,.18); color: var(--text); border-color: rgba(122,215,255,.34); }
    .list{ padding: 10px 12px 14px; max-height: 62vh; overflow:auto; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 12px 12px;
      border: 1px solid rgba(122,215,255,.12);
      border-radius: var(--r2);
      background: rgba(255,255,255,.05);
      margin-bottom: 10px;
    }
    .row:hover{ border-color: rgba(122,215,255,.24); background: rgba(255,255,255,.07); }
    .row .l{ min-width: 0; flex: 1; }
    .row .t{ font-weight: 900; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row .m{ font-size: 12px; color: var(--muted); margin-top:3px; display:flex; gap:10px; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 6px 8px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(0,0,0,.16);
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(77,255,179,.22); background: rgba(77,255,179,.10); color: rgba(234,247,255,.92); }
    .badge.warn{ border-color: rgba(255,214,109,.22); background: rgba(255,214,109,.10); color: rgba(234,247,255,.92); }
    .badge.danger{ border-color: rgba(255,77,109,.22); background: rgba(255,77,109,.10); color: rgba(234,247,255,.92); }
    .rightCol{ display:flex; flex-direction:column; gap: 12px; }
    .smallList{ padding: 10px 12px 14px; max-height: 30vh; overflow:auto; }
    .smallRow{ padding: 10px 10px; border: 1px solid rgba(122,215,255,.12); border-radius: var(--r2); background: rgba(255,255,255,.05); margin-bottom: 10px; }
    .smallRow .t{ font-weight: 900; font-size: 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .smallRow .m{ margin-top:4px; font-size: 12px; color: var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .empty{ opacity:.65; font-size: 12px; padding: 8px 2px; }
    .summary{
      padding: 12px 14px 14px;
      display:flex; flex-direction:column; gap: 10px;
    }
    .summaryGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi{ border:1px solid rgba(122,215,255,.14); background: rgba(255,255,255,.05); border-radius: var(--r2); padding: 10px 10px; }
    .kpi .k{ font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing:.6px; }
    .kpi .v{ margin-top:4px; font-weight: 950; font-size: 16px; }
    .kpi .v.small{ font-size: 13px; font-weight: 850; }
    .footBtns{ display:flex; gap: 8px; flex-wrap:wrap; }
    .muted{ color: var(--muted); }

    /* Modal */
    .modal{ position: fixed; inset: 0; display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50; background: rgba(0,0,0,.62); }
    .modal.show{ display:flex; }
    .box{ width: min(980px, 100%); max-height: 86vh; overflow:hidden; border-radius: 18px; border:1px solid rgba(122,215,255,.22); background: rgba(7,18,32,.92); box-shadow: 0 20px 80px rgba(0,0,0,.55); }
    .boxHead{ padding: 14px 14px; border-bottom: 1px solid rgba(122,215,255,.16); display:flex; justify-content:space-between; gap: 10px; align-items:flex-start; }
    .boxHead .h{ font-weight: 950; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    .boxHead .s{ margin-top:3px; font-size: 12px; color: var(--muted); }
    .boxBody{ padding: 12px 12px 14px; overflow:auto; max-height: calc(86vh - 112px); }
    .lineRow{
      display:grid;
      grid-template-columns: 34px 1.1fr .55fr .55fr .55fr;
      gap: 10px;
      padding: 10px 10px;
      border:1px solid rgba(122,215,255,.12);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      margin-bottom: 10px;
      align-items:center;
    }
    .chk{ display:flex; justify-content:center; }
    .lineMain{ min-width:0; }
    .lineMain .t{ font-weight: 900; font-size: 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lineMain .m{ margin-top:4px; font-size: 12px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
    .col{ font-family: var(--mono); font-size: 12px; color: rgba(234,247,255,.92); }
    .boxActions{ display:flex; justify-content:space-between; gap: 10px; padding: 12px 12px 14px; border-top: 1px solid rgba(122,215,255,.16); align-items:center; }
    .sigChk{ display:flex; gap: 8px; align-items:center; font-weight: 800; font-size: 12px; }
    .canvas{
      width:100%; height: 180px;
      border-radius: 16px;
      border: 1px solid rgba(122,215,255,.20);
      background: rgba(255,255,255,.03);
      touch-action: none;
    }

    /* Mobile */
    @media (max-width: 900px){
      .wrap{ padding: 12px 12px 24px; }
      .grid{ grid-template-columns: 1fr; }
      .list{ max-height: none; }
      .smallList{ max-height: none; }
      .summaryGrid{ grid-template-columns: 1fr; }
      .lineRow{ grid-template-columns: 34px 1fr; }
      .col{ grid-column: 2; }
      .row .m{ gap:8px; }
      .topbar{ position: sticky; top: 10px; }
      #mobileSummaryCard{ display:block; }
    }
    @media (min-width: 901px){
      #mobileSummaryCard{ display:none; }
    }
  
    .btn.accent{ border-color: rgba(122,215,255,.55); background: rgba(122,215,255,.16); color: var(--text); }
    .btn.ok{ border-color: rgba(77,255,179,.55); background: rgba(77,255,179,.16); color: var(--text); }
    .btn.big{ padding:14px 14px; font-size:15px; line-height:1.15; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ padding:8px 10px; border-radius: 999px; border:1px solid var(--line); background: rgba(255,255,255,.04); cursor:pointer; user-select:none; }
    .chip.on{ border-color: rgba(122,215,255,.7); background: rgba(122,215,255,.16); }
    .iaBody{ padding: 14px; }
    .iaQ{ font-size: 15px; font-weight: 700; margin-bottom: 10px; }
    .iaBtns{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .pickList .row{ cursor: default; }
    .iaBar{ position: sticky; bottom: 0; margin-top: 12px; padding-top: 10px; border-top:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px; background: rgba(6,16,29,.92); backdrop-filter: blur(10px); }
    .iaBar .actions{ display:flex; gap:8px; }
    @media (max-width: 900px){
      .wrap{ padding: 10px 10px 18px; }
      .topbar{ flex-direction: column; align-items: flex-start; gap: 10px; }
      .statusRow{ width: 100%; flex-wrap: wrap; gap: 8px; }
      .pill{ font-size: 13px; }
      .btn{ font-size: 14px; padding: 10px 12px; }
      .grid{ grid-template-columns: 1fr; gap: 12px; }
      .rightCol{ display: contents; } /* stack */
      #summaryCard{ order: 1; }
      #ordersCard{ order: 2; }
      #doneCard{ order: 3; }
      #mobileSummaryCard{ order: 4; }
      .tabs{ overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .tab{ flex: 0 0 auto; font-size: 14px; padding: 10px 12px; }
      .card{ border-radius: 18px; }
      .h{ font-size: 18px; }
      .sub{ font-size: 13px; }
      .summaryGrid{ grid-template-columns: 1fr 1fr; gap: 10px; }
      .kpi .v{ font-size: 20px; }
      #mobileSummaryCard .summaryGrid{ grid-template-columns: 1fr 1fr; }
      #mobileSummaryCard .h{ font-size: 17px; }
      #mobileSummaryCard .sub{ font-size: 14px; }
    }

  
    .clickable{ cursor: pointer; }
    .sec{ margin-top: 10px; }
    .secHead{ margin: 12px 0 6px; font-size: 11px; letter-spacing: .14em; color: rgba(234,247,255,.65); }
    .check{ display:flex; align-items:center; margin-right:10px; }
    .check input{ width:18px; height:18px; }
    .check span{ display:none; }

  
    /* --- Mobile iPhone: più grande e leggibile --- */
    @media (max-width: 520px){
      body{ font-size: 16px; }
      .wrap{ padding: 10px 10px 90px; }
      .card{ border-radius: 18px; }
      .tabs{ gap: 8px; }
      .tab{ padding: 10px 12px; font-size: 14px; }
      .row{ padding: 14px 12px; }
      .row .t{ font-size: 16px; }
      .row .m{ font-size: 13px; }
      .badge{ font-size: 12px; padding: 6px 8px; }
      .fabbar{ padding: 10px; }
      .btn{ padding: 12px 12px; font-size: 14px; }
      .kpi .v{ font-size: 28px; }
    }

</style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="t">Hub linea polveri</div>
        <div class="s">AutoSync EasyFatt XML da Google Drive • no Google Sheet • iPhone + Desktop</div>
      </div>
      <div class="statusRow">
        <div class="pill"><span class="dot" id="driveDot"></span><span id="driveTxt">Drive: —</span></div>
        <div class="pill mono" id="clockTxt">—:—</div>
        <div class="pill" id="wxTxt">Meteo: —</div>
        <button class="btn primary" id="btnSync" type="button">Sync Drive</button>
        <button class="btn accent" id="btnIA" type="button">IA intelligente</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="ordersCard">
        <div class="cardHead">
          <div>
            <div class="h">Ordini EasyFatt XML</div>
            <div class="sub" id="ordersSub">In attesa sync…</div>
          </div>
          <div class="actions">
            <button class="btn ghost" id="btnHelp" type="button">Info</button>
          </div>
        </div>

        
        <div class="tabs" role="tablist" aria-label="Viste">
          <button class="tab on" data-view="article" type="button">Per articolo</button>
          <button class="tab" data-view="customer" type="button">Per cliente</button>
          <button class="tab" data-view="size" type="button">Per taglia</button>
          <button class="tab" data-view="material" type="button">Per materia prima</button>
          <button class="tab" data-view="other" type="button">Art. non pertinenti</button>
        </div>

        <div class="list" id="ordersList">
          <div class="empty">In attesa ordini…</div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card" id="doneCard">
          <div class="cardHead">
            <div>
              <div class="h">Completati</div>
              <div class="sub" id="doneSub">Sync cloud…</div>
            </div>
            <div class="actions">
              <button class="btn ghost" id="btnBackup" type="button">Backup PDF</button>
              <button class="btn danger" id="btnUndo" type="button">Annulla ultimo</button>
              <button class="btn danger" id="btnUndoAll" type="button">Annulla tutti</button>
            </div>
          </div>
          <div class="smallList" id="doneList">
            <div class="empty">Nessun completato.</div>
          </div>
        </div>

        <div class="card" id="summaryCard">
          <div class="cardHead">
            <div>
              <div class="h">Riepilogo produzione</div>
              <div class="sub">Stima: 500 kg/ora • 8 ore/giorno</div>
            </div>
          </div>
          <div class="summary">
            <div class="summaryGrid">
              <div class="kpi">
                <div class="k">Kg totali (polveri)</div>
                <div class="v" id="kpiKg">—</div>
              </div>
              <div class="kpi">
                <div class="k">Giorni stimati</div>
                <div class="v" id="kpiDays">—</div>
              </div>
              <div class="kpi">
                <div class="k">Rame</div>
                <div class="v small" id="kpiRame">—</div>
              </div>
              <div class="kpi">
                <div class="k">Zolfo</div>
                <div class="v small" id="kpiZolfo">—</div>
              </div>
              <div class="kpi">
                <div class="k">Caolino</div>
                <div class="v small" id="kpiCaolino">—</div>
              </div>
              <div class="kpi">
                <div class="k">Altro</div>
                <div class="v small" id="kpiAltro">—</div>
              </div>
            </div>
            <div class="footBtns">
              <button class="btn primary" id="btnRevenue" type="button">Fatturato (admin)</button>
              <button class="btn accent" id="btnIA2" type="button">IA intelligente</button>
            </div>
            <div class="muted" style="font-size:12px;line-height:1.35;">
              I “giorni” sono calcolati sui kg totali ancora da completare (solo polveri), a 4000 kg/giorno.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile-only summary card at very bottom (always visible) -->
    <div class="card" id="mobileSummaryCard" style="margin-top:12px;">
      <div class="cardHead">
        <div>
          <div class="h">Per completare tutti gli ordini</div>
          <div class="sub" id="mobileSummaryTxt">ci vogliono — giorni</div>
        </div>
      </div>
      <div class="summary">
        <div class="summaryGrid">
          <div class="kpi"><div class="k">Rame</div><div class="v small" id="mRame">—</div></div>
          <div class="kpi"><div class="k">Zolfo</div><div class="v small" id="mZolfo">—</div></div>
          <div class="kpi"><div class="k">Caolino</div><div class="v small" id="mCaolino">—</div></div>
          <div class="kpi"><div class="k">Totale</div><div class="v small" id="mTotKg">—</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: righe cliente -->
  <div class="modal" id="custModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="boxHead">
        <div>
          <div class="h" id="custTitle">Cliente</div>
          <div class="s" id="custSub">—</div>
        </div>
        <button class="btn ghost" id="custClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody" id="custBody"></div>
      <div class="boxActions">
        <div class="muted" style="font-size:12px;">Spunta le righe completate → firma → conferma</div>
        <div class="actions">
          <button class="btn ghost" id="custCancel" type="button">Annulla</button>
          <button class="btn primary" id="custConfirm" type="button" disabled>Conferma completati</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: firma -->
  <div class="modal" id="sigModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" style="width:min(760px,100%);">
      <div class="boxHead">
        <div>
          <div class="h">Firma operatore</div>
          <div class="s" id="sigSub">—</div>
        </div>
        <button class="btn ghost" id="sigClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody">
        <label class="sigChk">
          <input type="checkbox" id="sigYes" />
          Dichiari di aver prodotto come si deve?
        </label>
        <div style="height:10px;"></div>
        <canvas class="canvas" id="sigCanvas"></canvas>
        <div style="height:10px;"></div>
        <div class="actions" style="justify-content:flex-end;">
          <button class="btn ghost" id="sigClear" type="button">Pulisci</button>
        </div>
      </div>
      <div class="boxActions">
        <div class="muted" style="font-size:12px;">Obbligatorio: spunta + firma.</div>
        <div class="actions">
          <button class="btn ghost" id="sigCancel" type="button">Annulla</button>
          <button class="btn primary" id="sigOk" type="button">Salva completati</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: fatturato -->
  <div class="modal" id="revModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" style="width:min(760px,100%);">
      <div class="boxHead">
        <div>
          <div class="h">Fatturato ordini (admin)</div>
          <div class="s">Totale per cliente • imponibile + IVA • dai Document in XML</div>
        </div>
        <button class="btn ghost" id="revClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody" id="revBody"></div>
    </div>
  </div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ===== Config Google Drive (EasyFatt XML) =====
    // Incolla qui la tua API key (Drive API abilitata). La cartella deve essere almeno "Chiunque con link: Visualizza"
    const XML_PROXY_CFG = {
      proxyUrl: "https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",
      cacheKey: "EASYFATT_XML_CACHE_V1"
    };
    const ADMIN_PW = "12345"; // TODO: cambia quando vuoi

    const XML_POLL_MS = 120000;

    // ===== Firebase (solo per Completati) =====
    const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== UI refs =====
    const $ = (id) => document.getElementById(id);
    const driveDot = $("driveDot");
    const driveTxt = $("driveTxt");
    const ordersSub = $("ordersSub");
    const ordersList = $("ordersList");
    const doneSub = $("doneSub");
    const doneList = $("doneList");
    const kpiKg = $("kpiKg");
    const kpiDays = $("kpiDays");
    const kpiRame = $("kpiRame");
    const kpiZolfo = $("kpiZolfo");
    const kpiCaolino = $("kpiCaolino");
    const kpiAltro = $("kpiAltro");
    const mobileSummaryTxt = $("mobileSummaryTxt");
    const mRame = $("mRame");
    const mZolfo = $("mZolfo");
    const mCaolino = $("mCaolino");
    const mTotKg = $("mTotKg");

    // ===== Clock + Meteo (Cerea, VR) =====
    const WX_LAT = 45.2153;
    const WX_LON = 11.1462;
    function pad2(n){ return String(n).padStart(2,"0"); }

    function makeLotStamp(ts=Date.now()){
      const d = new Date(ts);
      const yy = String(d.getFullYear()).slice(2);
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `LOT${yy}${mm}${dd}${hh}${mi}${ss}`;
    }

    function tickClock(){
      const d = new Date();
      $("clockTxt").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    setInterval(tickClock, 250); tickClock();

    async function refreshWeather(){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code,wind_speed_10m&timezone=Europe%2FRome`;
        const r = await fetch(url, { cache:"no-store" });
        const j = await r.json();
        const t = j?.current?.temperature_2m;
        const w = j?.current?.wind_speed_10m;
        $("wxTxt").textContent = (t!=null && w!=null) ? `Cerea: ${Math.round(t)}°C • vento ${Math.round(w)} km/h` : "Meteo: —";
      }catch(_){
        $("wxTxt").textContent = "Meteo: —";
      }
    }
    refreshWeather();
    setInterval(refreshWeather, 10*60*1000);

    // ===== State =====
    let _view = "article"; // customer | material | size | other
    let _rawDocs = [];       // parsed docs
    let _powderLines = [];   // flattened powder lines
    let _otherLines = [];    // flattened non-powder
    let _doneMap = new Map(); // lineKey => doc
    let _selectTitle = "";
    let _selectLines = [];
    let _selectedKeys = new Set();
    let _pendingBatch = null;

    // ===== Helpers =====
    function setDriveState(ok, msg){
      driveDot.classList.toggle("ok", !!ok);
      driveDot.classList.toggle("bad", !ok && msg && msg.includes("Errore"));
      driveTxt.textContent = msg || (ok ? "Drive: OK" : "Drive: —");
    }

    function safeText(n){ return (n && (n.textContent||"").trim()) || ""; }

    function buildLineKey(docNumber, customer, code, desc, qty, um){
      const base = `${docNumber}|${customer}|${code}|${desc}|${qty}|${um}`;
      let h=0;
      for(let i=0;i<base.length;i++){ h=((h<<5)-h)+base.charCodeAt(i); h|=0; }
      return "x_" + Math.abs(h).toString(36);
    }

    function norm(s){ return String(s||"").toLowerCase(); }

    function detectPackKg(desc){
      const s = norm(desc).replace(/,/g,".");
      let m = s.match(/(\d+(?:\.\d+)?)\s*kg\b/);
      if(m) return parseFloat(m[1]);
      m = s.match(/(\d+(?:\.\d+)?)\s*g\b/);
      if(m) return parseFloat(m[1]) / 1000;
      return null;
    }

    function isPowderLine(code, desc, um){
      const s = norm(desc);
      const u = norm(um);
      if(s.includes("ml") || s.includes("litro") || s.includes(" l") || s.includes("lt")) return false;
      if(u === "l" || u === "lt" || u === "ml") return false;
      if(u === "kg" || u === "g") return true;
      if(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/i.test(desc)) return true;
      if(s.includes("polvere") || s.includes("sacco") || s.includes("granulare")) return true;
      if(s.includes("poltiglia")) return true; // es. Poltiglia di rame (polvere)
      const c = norm(code);
      if(c.includes("kg") || c.includes("sac")) return true;
      return false;
    }

    function materialOf(desc, code=""){
      const s = norm(desc);
      const c = norm(code);

      const has = (re) => re.test(s) || re.test(c);

      // rame / composti rameici
      if(has(/\brame\b/) || has(/\bcopper\b/) || has(/\bcupr/) || has(/\bossicloruro\b/) || has(/\bidrossido\b/) || (s.includes("poltiglia") && s.includes("rame")) || s.includes("bordolese")) return "rame";

      // zolfo
      if(has(/\bzolfo\b/) || has(/\bsulfur\b/) || has(/\bsulphur\b/) || has(/\bzolf/)) return "zolfo";

      // caolino
      if(has(/\bcaolino\b/) || has(/\bkaolin\b/) || has(/\bcaol/)) return "caolino";

      // zeolite (eventuale)
      if(has(/\bzeolite\b/) || has(/\bzeolit/)) return "zeolite";

      return "altro";
    }

    function sizeLabel(packKg){
      if(packKg == null) return "—";
      const v = (Math.round(packKg*100)/100);
      const str = (String(v).includes(".") ? String(v).replace(".",",") : String(v));
      return `${str} kg`;
    }

    function computeLineKg(line){
      const qty = parseFloat(String(line.qty||"0").replace(",","."));
      const u = norm(line.um);
      const pack = line.packKg;
      if(Number.isNaN(qty)) return 0;
      if(pack != null) return qty * pack;
      if(u === "kg") return qty;
      if(u === "g") return qty/1000;
      return 0;
    }

    
    function stripSizeTokens(s){
      return norm(s)
        .replace(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/g, "")
        .replace(/\b(sacco|sacchi|sacchetto|sacchetti|granulare|polvere)\b/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function canonicalProductKey(desc, code=""){
      const c = norm(code);
      if(c && c.length >= 3) return c; // se c'è un codice usalo come chiave
      const base = stripSizeTokens(desc);
      // fallback: prime 4 parole
      const parts = base.split(" ").filter(Boolean);
      return parts.slice(0,4).join(" ");
    }

    function groupProducts(lines){
      // raggruppa per prodotto+taglia (perché la macchina lavora per formati)
      const map = new Map();
      for(const l of lines){
        const keyBase = canonicalProductKey(l.description, l.code);
        const size = sizeLabel(l.packKg);
        const k = keyBase + "||" + size;
        const g = map.get(k) || { key:k, base:keyBase, label:l.description, code:l.code, size, material:l.material, kg:0, qty:0, lines:[] };
        g.kg += computeLineKg(l);
        g.qty += (Number.isFinite(l.qtyNum) ? l.qtyNum : 0);
        g.lines.push(l);
        // label: preferisci la più “pulita”
        if((l.description||"").length < (g.label||"").length) g.label = l.description;
        map.set(k, g);
      }
      const arr = Array.from(map.values());
      arr.sort((a,b)=> (b.kg-a.kg) || a.label.localeCompare(b.label));
      return arr;
    }

function euro(n){
      if(n == null || Number.isNaN(n)) return "—";
      return new Intl.NumberFormat("it-IT", { style:"currency", currency:"EUR" }).format(n);
    }

    // ===== Parse EasyFatt XML =====
    function parseEasyfattXml(xmlText){
      const outDocs = [];
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, "text/xml");
      const docs = Array.from(doc.getElementsByTagName("Document"));
      for(const d of docs){
        const customer = safeText(d.getElementsByTagName("CustomerName")[0]) || "Cliente";
        const number = safeText(d.getElementsByTagName("Number")[0]) || "";
        const date = safeText(d.getElementsByTagName("Date")[0]) || "";


        const conclusion = (() => {
          const direct = (
            safeText(d.getElementsByTagName("ExpectedConclusion")[0]) ||
            safeText(d.getElementsByTagName("ExpectedDeliveryDate")[0]) ||
            safeText(d.getElementsByTagName("DeliveryDate")[0]) ||
            safeText(d.getElementsByTagName("DueDate")[0]) ||
            safeText(d.getElementsByTagName("EndDate")[0]) ||
            safeText(d.getElementsByTagName("DataConsegna")[0]) ||
            safeText(d.getElementsByTagName("DataConsegnaPrevista")[0]) ||
            safeText(d.getElementsByTagName("DataFine")[0]) ||
            ""
          );
          if(direct) return direct;
          const nodes = Array.from(d.getElementsByTagName("*"));
          for(const n of nodes){
            const tag = (n.tagName||"").toLowerCase();
            if(/consegna|conclusion|delivery|scadenza|fine|previst|due/.test(tag)){
              const v = safeText(n);
              if(v && /(\d{4}-\d{2}-\d{2})|(\d{2}\/\d{2}\/\d{4})/.test(v)) return v;
            }
          }
          return "";
        })();

        const getNum = (...tags) => {
          for(const t of tags){
            const v = safeText(d.getElementsByTagName(t)[0]);
            if(v) {
              const n = parseFloat(v.replace(",","."));
              if(!Number.isNaN(n)) return n;
            }
          }
          return null;
        };
        const imponibile = getNum("TotalNet", "TotalImponibile", "NetAmount", "TaxableAmount");
        const iva = getNum("TotalVat", "VatAmount", "VATAmount", "TaxAmount");
        const totale = getNum("Total", "TotalGross", "GrossAmount", "TotalAmount");

        const rows = Array.from(d.getElementsByTagName("Row"));
        const lines = [];
        for(const r of rows){
          const code = (
            safeText(r.getElementsByTagName("Code")[0]) ||
            safeText(r.getElementsByTagName("ItemCode")[0]) ||
            safeText(r.getElementsByTagName("ArticleCode")[0]) ||
            safeText(r.getElementsByTagName("Codice")[0]) ||
            ""
          );
          const desc = safeText(r.getElementsByTagName("Description")[0]) || code || "Riga";
          const qty  = safeText(r.getElementsByTagName("Qty")[0]) || "0";
          const qtyNum = (()=>{ const x = String(qty||"0").replace(/\./g,"").replace(",","."); const v = parseFloat(x); return Number.isFinite(v)?v:0; })();
          const um   = safeText(r.getElementsByTagName("Um")[0]) || "";
          const packKg = detectPackKg(desc);
          const powder = isPowderLine(code, desc, um);
          const mat = powder ? materialOf(desc, code) : "altro";
          const lineKey = buildLineKey(number, customer, code, desc, qty, um);
          lines.push({ lineKey, customer, docNumber:number, docDate:date, docConclusion:conclusion, code, description:desc, qty, qtyNum, um, powder, material:mat, packKg });
        }

        outDocs.push({
          customer, number, date, conclusion,
          imponibile, iva,
          totale: (totale != null ? totale : (imponibile !=null && iva!=null ? (imponibile + iva) : null)),
          lines
        });
      }
      return outDocs;
    }

    // ===== Drive fetch =====
    async function driveListTargetFile(){ throw new Error("Drive API disattivata: usa proxy"); }

    async function driveFetchFileContent(){ throw new Error("Drive API disattivata: usa proxy"); }

    async async function syncFromDrive() {
      $("btnSync").disabled = true;
      try {
        setDriveState(false, "Drive: sync…");

        const res = await fetch(XML_PROXY_CFG.proxyUrl, { cache: "no-store" });
        if(!res.ok) throw new Error(`Proxy HTTP ${res.status}`);
        const j = await res.json();
        if(j && j.ok === false) throw new Error(j.error || "Proxy: errore");
        const xmlText = j?.xml;
        if(!xmlText || typeof xmlText !== "string") throw new Error("Proxy: XML mancante");

        localStorage.setItem(XML_PROXY_CFG.cacheKey, JSON.stringify({ t: Date.now(), xml: xmlText, modifiedTime: j?.modifiedTime || null }));

        _rawDocs = parseEasyfattXml(xmlText);

        const allLines = _rawDocs.flatMap(d => d.lines.map(l => ({...l})));
        _powderLines = allLines.filter(x => x.powder);
        _otherLines  = allLines.filter(x => !x.powder);

        setDriveState(true, "Drive: OK");
        const mod = j?.modifiedTime ? new Date(j.modifiedTime).toLocaleString("it-IT") : new Date().toLocaleString("it-IT");
        ordersSub.textContent = `Aggiornato: ${mod} • Polveri: ${_powderLines.length} righe • Non pertinenti: ${_otherLines.length} righe`;
        renderAll();
      } catch(e) {
        console.log(e);
        // fallback cache
        let cached=null;
        try { cached = JSON.parse(localStorage.getItem(XML_PROXY_CFG.cacheKey) || "null"); } catch(_ ){}
        if(cached?.xml) {
          try {
            _rawDocs = parseEasyfattXml(cached.xml);
            const allLines = _rawDocs.flatMap(d => d.lines.map(l => ({...l})));
            _powderLines = allLines.filter(x => x.powder);
            _otherLines  = allLines.filter(x => !x.powder);
            setDriveState(false, "Drive: Offline (cache)");
            const mod = cached.modifiedTime ? new Date(cached.modifiedTime).toLocaleString("it-IT") : (cached.t ? new Date(cached.t).toLocaleString("it-IT") : "");
            ordersSub.textContent = `Offline: uso cache (${mod}) • Polveri: ${_powderLines.length} righe`;
            renderAll();
            return;
          } catch(_ ){}
        }
        setDriveState(false, "Drive: Errore");
        ordersSub.textContent = (e?.message || String(e));
        ordersList.innerHTML = `<div class="empty">Errore sync: ${(e?.message || e)}<br><br>Controlla che la WebApp Apps Script sia pubblicata come “Chiunque”.</div>`;
      } finally {
        $("btnSync").disabled = false;
      }
    }

    $("btnSync").addEventListener("click", (e) => { e.preventDefault(); syncFromDrive(); });

    // Autosync
    setTimeout(syncFromDrive, 450);
    setInterval(syncFromDrive, XML_POLL_MS);

    // ===== Firestore completati =====
    function dayKey(d=new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    const DONE_COLL = () => collection(db, "powderOrdersDone", dayKey(), "items");

    function lineDone(lineKey) { return _doneMap.has(lineKey); }

    function initDoneRealtime() {
      try {
        onSnapshot(DONE_COLL(), (snap) => {
          _doneMap.clear();
          snap.forEach((d) => {
            const v = d.data() || {};
            _doneMap.set(d.id, v);
          });
          renderDone();
          renderAll();
        }, (err) => {
          console.log("done snapshot err:", err);
          doneSub.textContent = "Cloud: errore";
        });
        doneSub.textContent = "Cloud: OK";
      } catch(e) {
        console.log(e);
        doneSub.textContent = "Cloud: non inizializzato";
      }
    }
    initDoneRealtime();

    // ===== Rendering =====
    function fmtQty(line) {
      const q = String(line.qty||"0");
      return `${q} ${line.um||""}`.trim();
    }

    function renderAll(){
      renderOrders();
      renderSummary();
    }

    function renderOrders(){
      const powderPending = _powderLines.filter(l => !lineDone(l.lineKey));
      const otherPending = _otherLines.filter(l => !lineDone(l.lineKey));


      if(_view === "article") {
        const groups = groupProducts(powderPending);
        ordersSub.textContent = `${groups.length} articoli (polveri)`;
        if(groups.length === 0){
          ordersList.innerHTML = '<div class="empty">Nessun ordine polveri in coda.</div>';
          return;
        }
        ordersList.innerHTML = `
          <div class="row" style="margin-bottom:10px;">
            <div class="l">
              <div class="t">Totali per articolo</div>
              <div class="m">
                <span class="badge ok">${groups.length} prodotti</span>
                <span class="badge">${powderPending.length} righe</span>
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" id="btnPickAll" type="button">Seleziona e completa</button>
            </div>
          </div>
          ${groups.slice(0,120).map(g=>{
            const kg = Math.round(g.kg*10)/10;
            return `
              <div class="row">
                <div class="l">
                  <div class="t">${g.label}</div>
                  <div class="m">
                    <span class="badge ok">${g.code||"—"}</span>
                    <span class="badge">${g.size||"—"}</span>
                    <span class="badge">${(g.material||"altro")}</span>
                    <span class="badge warn mono">${kg} kg</span>
                    <span class="badge mono">${g.lines.length} righe</span>
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        `;
        // wire action
        setTimeout(()=>{
          const b = $("btnPickAll");
          if(b) b.onclick = ()=>{
            openGroupModal("Seleziona prodotti (tutte le taglie)", groups);
          };
        },0);
        return;
      }

      if(_view === "customer") {
        const by = new Map();
        for(const l of powderPending) {
          const arr = by.get(l.customer) || [];
          arr.push(l);
          by.set(l.customer, arr);
        }
        const customers = Array.from(by.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        if(customers.length === 0) {
          ordersList.innerHTML = '<div class="empty">Nessun ordine polveri in coda.</div>';
          return;
        }
        ordersList.innerHTML = customers.map(([cust, lines]) => {
          const kg = lines.reduce((s,l)=>s+computeLineKg(l),0);
          const docs = new Set(lines.map(x=>x.docNumber).filter(Boolean)).size;
          const concSet = new Set(lines.map(x=>x.docConclusion).filter(Boolean));
          const concl = (concSet.size===1) ? Array.from(concSet)[0] : (concSet.size>1 ? "varie" : "");
          return `
            <div class="row" data-cust="${encodeURIComponent(cust)}">
              <div class="l">
                <div class="t">${cust}</div>
                <div class="m">
                  <span class="badge ok">${lines.length} righe</span>
                  <span class="badge">${docs} doc</span>
                  ${concl ? `<span class="badge">Conclusione: ${concl}</span>` : ""}
                  <span class="badge warn mono">${Math.round(kg*10)/10} kg</span>
                </div>
              </div>
              <div class="badge">Apri</div>
            </div>
          `;
        }).join("");
        ordersList.querySelectorAll(".row").forEach(r => {
          r.addEventListener("click", () => {
            const cust = decodeURIComponent(r.getAttribute("data-cust") || "");
            openCustomerModal(cust, false);
          });
        });
      } else if(_view === "material") {
        const mats = ["rame","zolfo","caolino","altro"];
        const rows = mats.map(m => {
          const lines = powderPending.filter(l => l.material===m);
          const kg = lines.reduce((s,l)=>s+computeLineKg(l),0);
          const customers = new Set(lines.map(x=>x.customer)).size;
          return { m, lines, kg, customers };
        });
        ordersList.innerHTML = rows.map(r => {
          const label = r.m.charAt(0).toUpperCase() + r.m.slice(1);
          return `
            <div class="row clickable" data-size="${k}">
              <div class="l">
                <div class="t">${label}</div>
                <div class="m">
                  <span class="badge ok">${r.lines.length} righe</span>
                  <span class="badge">${r.customers} clienti</span>
                  <span class="badge warn mono">${Math.round(r.kg*10)/10} kg</span>
                </div>
              </div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun dato.</div>';
      } else
        // apri selezione per materia prima
        setTimeout(()=>{
          ordersList.querySelectorAll('[data-mat]').forEach(el=>{
            el.addEventListener('click', ()=>{
              const m = el.getAttribute('data-mat') || '';
              const groups = groupProducts(powderPending.filter(l=>l.material===m));
              openGroupModal(`Seleziona prodotti • ${m}`, groups);
            });
          });
        },0);
 if(_view === "size") {
        const by = new Map();
        for(const l of powderPending) {
          const key = sizeLabel(l.packKg);
          const arr = by.get(key) || [];
          arr.push(l);
          by.set(key, arr);
        }
        const keys = Array.from(by.keys()).sort((a,b)=> {
          const na = parseFloat(a.replace(",",".")); const nb = parseFloat(b.replace(",","."));
          if(!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
          return a.localeCompare(b);
        });
        ordersList.innerHTML = keys.map(k => {
          const lines = by.get(k) || [];
          const kg = lines.reduce((s,l)=>s+computeLineKg(l),0);
          return `
            <div class="row">
              <div class="l">
                <div class="t">${k}</div>
                <div class="m">
                  <span class="badge ok">${lines.length} righe</span>
                  <span class="badge warn mono">${Math.round(kg*10)/10} kg</span>
                </div>
              </div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun dato.</div>';
        setTimeout(()=>{
          ordersList.querySelectorAll('[data-size]').forEach(el=>{
            el.addEventListener('click', ()=>{
              const sz = el.getAttribute('data-size') || "";
              const groups = groupProducts(powderPending.filter(l=> sizeLabel(l.packKg)===sz ));
              openGroupModal(`Seleziona prodotti • ${sz}`, groups);
            });
          });
        },0);
      } else if(_view === "other") {
        const by = new Map();
        for(const l of otherPending) {
          const arr = by.get(l.customer) || [];
          arr.push(l);
          by.set(l.customer, arr);
        }
        const customers = Array.from(by.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        ordersList.innerHTML = customers.map(([cust, lines]) => {
          return `
            <div class="row" data-cust_other="${encodeURIComponent(cust)}">
              <div class="l">
                <div class="t">${cust}</div>
                <div class="m">
                  <span class="badge danger">${lines.length} righe non pertinenti</span>
                </div>
              </div>
              <div class="badge">Apri</div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun articolo non pertinente.</div>';
        ordersList.querySelectorAll(".row").forEach(r => {
          r.addEventListener("click", () => {
            const cust = decodeURIComponent(r.getAttribute("data-cust_other") || "");
            openCustomerModal(cust, true);
          });
        });
      }
    }

    function renderSummary(){
      const powderPending = _powderLines.filter(l => !lineDone(l.lineKey));
      const totals = { rame:0, zolfo:0, caolino:0, altro:0, tot:0 };
      for(const l of powderPending) {
        const kg = computeLineKg(l);
        totals.tot += kg;
        totals[l.material] = (totals[l.material]||0) + kg;
      }
      const kgTot = Math.round(totals.tot*10)/10;
      const days = (kgTot>0) ? Math.ceil(kgTot / 4000) : 0;

      kpiKg.textContent = kgTot ? `${kgTot} kg` : "0 kg";
      kpiDays.textContent = `${days ? days : 0} giorni`;
      kpiRame.textContent = `${Math.round(totals.rame*10)/10} kg`;
      kpiZolfo.textContent = `${Math.round(totals.zolfo*10)/10} kg`;
      kpiCaolino.textContent = `${Math.round(totals.caolino*10)/10} kg`;
      kpiAltro.textContent = `${Math.round(totals.altro*10)/10} kg`;

      mobileSummaryTxt.textContent = `ci vogliono ${days ? days : 0} giorni`;
      mRame.textContent = `${Math.round(totals.rame*10)/10} kg`;
      mZolfo.textContent = `${Math.round(totals.zolfo*10)/10} kg`;
      mCaolino.textContent = `${Math.round(totals.caolino*10)/10} kg`;
      mTotKg.textContent = `${kgTot} kg`;
    }

    function renderDone(){
      const items = Array.from(_doneMap.entries()).map(([k,v]) => ({k, v}));
      if(items.length === 0) {
        doneList.innerHTML = '<div class="empty">Nessun completato.</div>';
        return;
      }
      items.sort((a,b)=>(b.v?.completedAtClientMs||0)-(a.v?.completedAtClientMs||0));
      doneList.innerHTML = items.slice(0,40).map(({k,v}) => {
        const when = v.completedAtClientMs ? new Date(v.completedAtClientMs).toLocaleString("it-IT") : "";
        return `
          <div class="smallRow">
            <div class="t">${(v.customer || "Cliente")} • ${(v.description || "")}</div>
            <div class="m">
              <span class="badge ok">${(v.code||"—")}</span>
              <span class="badge warn mono">${(v.kg!=null? (Math.round(v.kg*10)/10)+" kg":"—")}</span>
              <span class="badge mono">${(v.qty||"0")} ${(v.um||"")}</span>
              <span class="badge mono">${(v.lot||"LOT—")}</span>
              <span class="badge">${when}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    // ===== Tabs =====
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("on"));
        t.classList.add("on");
        _view = t.getAttribute("data-view");
        renderOrders();
      });
    });

    // ===== Customer modal =====
    function openCustomerModal(customer, other){
      _selectTitle = customer;
      _selectedKeys = new Set();
      $("custTitle").textContent = other ? `Non pertinenti • ${customer}` : customer;

      const lines = (other ? _otherLines : _powderLines).filter(l => l.customer===customer && !lineDone(l.lineKey));
      lines.sort((a,b)=> (a.docNumber||"").localeCompare(b.docNumber||"") || (a.description||"").localeCompare(b.description||""));
      _selectLines = lines;

      $("custSub").textContent = other
        ? `${lines.length} righe non pertinenti`
        : `${lines.length} righe polveri • spunta i completati`;

      const body = $("custBody");
      if(lines.length===0){
        body.innerHTML = '<div class="empty">Nessuna riga.</div>';
      } else {
        body.innerHTML = lines.map(l => {
          const kg = Math.round(computeLineKg(l)*10)/10;
          const size = sizeLabel(l.packKg);
          return `
            <div class="lineRow" data-k="${l.lineKey}">
              <div class="chk"><input type="checkbox" /></div>
              <div class="lineMain">
                <div class="t">${l.description}</div>
                <div class="m">
                  <span class="badge mono">COD: ${l.code || "—"}</span>
                  <span class="badge mono">${l.docNumber || "DOC"}${l.docDate ? " • " + l.docDate : ""}</span>
                  ${l.docConclusion ? `<span class="badge">Conclusione: ${l.docConclusion}</span>` : ""}
                  <span class="badge warn mono">${kg} kg</span>
                </div>
              </div>
              <div class="col">Qty: ${fmtQty(l)}</div>
              <div class="col">Taglia: ${size}</div>
              <div class="col">MP: ${l.material}</div>
            </div>
          `;
        }).join("");
      }

      body.querySelectorAll(".lineRow").forEach(r => {
        const k = r.getAttribute("data-k");
        const cb = r.querySelector("input[type=checkbox]");
        cb.addEventListener("change", () => {
          if(cb.checked) _selectedKeys.add(k);
          else _selectedKeys.delete(k);
          $("custConfirm").disabled = _selectedKeys.size===0;
        });
      });

      $("custConfirm").disabled = true;
      const m = $("custModal");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }


    let _groupModalMap = new Map(); // groupId -> lineKeys[]

    function openGroupModal(title, groups){
      _selectTitle = title || "Selezione";
      _selectedKeys = new Set();
      _groupModalMap = new Map();

      // flatten lines for signature save lookup
      const flat = [];
      const seen = new Set();
      for(const g of groups){
        const id = g.key;
        const keys = g.lines.map(x=>x.lineKey);
        _groupModalMap.set(id, keys);
        for(const l of g.lines){
          if(seen.has(l.lineKey)) continue;
          seen.add(l.lineKey);
          flat.push(l);
        }
      }
      _selectLines = flat;

      $("custTitle").textContent = title || "Selezione prodotti";
      $("custSub").textContent = `${groups.length} prodotti • spunta e conferma`;

      const body = $("custBody");
      if(groups.length===0){
        body.innerHTML = '<div class="empty">Nessun prodotto.</div>';
      } else {
        // raggruppa per materia prima (solo estetica)
        const byMat = new Map();
        for(const g of groups){
          const m = g.material || "altro";
          const arr = byMat.get(m) || [];
          arr.push(g);
          byMat.set(m, arr);
        }
        const mats = Array.from(byMat.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        body.innerHTML = mats.map(([mat, arr])=>{
          arr.sort((a,b)=> (b.kg-a.kg) || a.label.localeCompare(b.label));
          return `
            <div class="sec">
              <div class="secHead">${mat.toUpperCase()}</div>
              ${arr.map(g=>{
                const kg = Math.round(g.kg*10)/10;
                return `
                  <div class="row lineRow" data-group="${g.key}">
                    <label class="check">
                      <input type="checkbox">
                      <span></span>
                    </label>
                    <div class="l">
                      <div class="t">${g.label}</div>
                      <div class="m">
                        <span class="badge ok">${g.code||"—"}</span>
                        <span class="badge">${g.size||"—"}</span>
                        <span class="badge warn mono">${kg} kg</span>
                        <span class="badge mono">${g.lines.length} righe</span>
                      </div>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          `;
        }).join("");
      }

      body.querySelectorAll(".lineRow").forEach(r=>{
        const gid = r.getAttribute("data-group");
        const cb = r.querySelector("input[type=checkbox]");
        cb.addEventListener("change", ()=>{
          const keys = _groupModalMap.get(gid) || [];
          if(cb.checked) keys.forEach(k=>_selectedKeys.add(k));
          else keys.forEach(k=>_selectedKeys.delete(k));
          $("custConfirm").disabled = _selectedKeys.size===0;
        });
      });

      $("custConfirm").disabled = true;
      const m = $("custModal");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }


    function closeCustomerModal(){
      const m = $("custModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      _selectTitle = "";
      _selectLines = [];
      _selectedKeys = new Set();
    }

    $("custClose").addEventListener("click", (e)=>{ e.preventDefault(); closeCustomerModal(); });
    $("custCancel").addEventListener("click", (e)=>{ e.preventDefault(); closeCustomerModal(); });
    $("custModal").addEventListener("click", (e)=>{ if(e.target === $("custModal")) closeCustomerModal(); });

    $("custConfirm").addEventListener("click", (e)=>{
      e.preventDefault();
      if(!_selectLines || _selectLines.length===0 || _selectedKeys.size===0) return;
      _pendingBatch = {
        title: _selectTitle,
        selectedKeys: Array.from(_selectedKeys),
        lines: _selectLines
      };
      openSigModal(`${_selectTitle || "Selezione"} • ${_selectedKeys.size} righe`);
    });

    // ===== Signature =====
    const SIG = { drawing:false, lastX:0, lastY:0, dirty:false };
    function resizeCanvas(){
      const c = $("sigCanvas");
      const rect = c.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
      c.width = Math.floor(rect.width * dpr);
      c.height = Math.floor(rect.height * dpr);
      const ctx = c.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth = 2.2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "rgba(234,247,255,.95)";
      ctx.fillStyle = "rgba(255,255,255,.02)";
      ctx.fillRect(0,0,rect.width,rect.height);
    }
    function clearCanvas(){
      const c = $("sigCanvas");
      const ctx = c.getContext("2d");
      const rect = c.getBoundingClientRect();
      ctx.clearRect(0,0,rect.width,rect.height);
      ctx.fillStyle = "rgba(255,255,255,.02)";
      ctx.fillRect(0,0,rect.width,rect.height);
      SIG.dirty = false;
    }
    function pos(ev){
      const c = $("sigCanvas");
      const r = c.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }
    function wireCanvas(){
      const c = $("sigCanvas");
      const ctx = c.getContext("2d");
      c.addEventListener("pointerdown", (ev)=>{
        ev.preventDefault();
        try{ c.setPointerCapture(ev.pointerId); }catch(_){}
        const p = pos(ev);
        SIG.drawing = true;
        SIG.lastX = p.x; SIG.lastY = p.y;
      });
      c.addEventListener("pointermove", (ev)=>{
        if(!SIG.drawing) return;
        ev.preventDefault();
        const p = pos(ev);
        ctx.beginPath();
        ctx.moveTo(SIG.lastX, SIG.lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        SIG.lastX = p.x; SIG.lastY = p.y;
        SIG.dirty = true;
      });
      function end(ev){ SIG.drawing=false; try{ c.releasePointerCapture(ev.pointerId); }catch(_ ){} }
      c.addEventListener("pointerup", end);
      c.addEventListener("pointercancel", end);
    }
    wireCanvas();
    window.addEventListener("resize", ()=>{ try{ resizeCanvas(); clearCanvas(); }catch(_ ){} });

    function openSigModal(sub){
      $("sigSub").textContent = sub || "—";
      $("sigYes").checked = false;
      const m = $("sigModal");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
      requestAnimationFrame(()=>{ resizeCanvas(); clearCanvas(); });
    }
    function closeSigModal(){
      const m = $("sigModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      _pendingBatch = null;
    }

    $("sigClose").addEventListener("click",(e)=>{ e.preventDefault(); closeSigModal(); });
    $("sigCancel").addEventListener("click",(e)=>{ e.preventDefault(); closeSigModal(); });
    $("sigModal").addEventListener("click",(e)=>{ if(e.target === $("sigModal")) closeSigModal(); });
    $("sigClear").addEventListener("click",(e)=>{ e.preventDefault(); clearCanvas(); });

    $("sigOk").addEventListener("click", async (e)=>{
      e.preventDefault();
      if(!_pendingBatch) { closeSigModal(); return; }
      if(!$("sigYes").checked) return;
      if(!SIG.dirty) return;

      let sigDataUrl = "";
      try { sigDataUrl = $("sigCanvas").toDataURL("image/jpeg", 0.75); }
      catch(_) { try { sigDataUrl = $("sigCanvas").toDataURL(); } catch(__){} }

      const batch = _pendingBatch;
      const keys = batch.selectedKeys || [];
      const lines = batch.lines || [];
      const now = Date.now();
      const lot = makeLotStamp(now);

      try {
        for(const k of keys) {
          const it = lines.find(x=>x.lineKey===k);
          if(!it) continue;
          await setDoc(doc(DONE_COLL(), k), {
            lineKey: k,
            customer: it.customer,
            docNumber: it.docNumber || "",
            docDate: it.docDate || "",
            code: it.code || "",
            description: it.description,
            qty: it.qty,
            um: it.um,
            docConclusion: it.docConclusion || "",
            lot: lot,
            kg: computeLineKg(it),
            packKg: it.packKg ?? null,
            material: it.material || "altro",
            signatureDataUrl: sigDataUrl,
            completedAtClientMs: now
          }, { merge:true });
        }
      } catch(err) {
        alert("Errore salvataggio cloud: " + (err?.message || err));
        return;
      }

      closeSigModal();
      closeCustomerModal();
      setTimeout(()=>{ renderAll(); }, 120);
    });

    // ===== Undo admin =====
    $("btnUndo").addEventListener("click", async (e)=>{
      e.preventDefault();
      const pwd = prompt("Password admin:");
      if(pwd !== "12345") return;

      const items = Array.from(_doneMap.entries()).map(([k,v]) => ({k, v}));
      items.sort((a,b)=>(b.v?.completedAtClientMs||0)-(a.v?.completedAtClientMs||0));
      const last = items[0];
      if(!last) return;
      if(!confirm(`Annullare l'ultimo completato?\n${last.v.customer} • ${last.v.description}`)) return;
      try {
        await deleteDoc(doc(DONE_COLL(), last.k));
      } catch(err) {
        alert("Errore annullo: " + (err?.message || err));
      }
    });

    
    // ===== Backup PDF (share iPhone) =====
    async function buildBackupPdf(){
      const items = Array.from(_doneMap.entries()).map(([k,v])=>({id:k,...v}));
      items.sort((a,b)=>(a.doneAt||0)-(b.doneAt||0));
      if(items.length===0){ alert("Nessun completato."); return; }

      const { jsPDF } = (window.jspdf||{});
      if(!jsPDF){ alert("Libreria PDF non disponibile (jspdf)."); return; }

      const doc = new jsPDF({ unit:"pt", format:"a4" });
      const W = doc.internal.pageSize.getWidth();
      const H = doc.internal.pageSize.getHeight();
      const margin = 34;
      let y = margin;

      const today = new Date().toLocaleDateString("it-IT");
      doc.setFont("helvetica","bold"); doc.setFontSize(14);
      doc.text("LINEA POLVERI • BACKUP COMPLETATI", margin, y); y += 18;
      doc.setFont("helvetica","normal"); doc.setFontSize(10);
      doc.text(`Generato: ${today} • Totale righe: ${items.length}`, margin, y); y += 16;
      doc.line(margin, y, W-margin, y); y += 14;

      function newPage(){
        doc.addPage();
        y = margin;
      }

      for(const it of items){
        const ts = it.doneAt ? new Date(it.doneAt).toLocaleString("it-IT") : "";
        const kg = (it.kg!=null) ? (Math.round(it.kg*10)/10+" kg") : "—";
        const header = `${it.description||""}`;
        const meta1 = `Cliente: ${it.customer||"—"} • Cod: ${it.code||"—"} • Taglia: ${sizeLabel(it.packKg)} • Kg: ${kg}`;
        const meta2 = `Qty: ${(it.qty||"0")} ${(it.um||"")} • Lotto: ${it.lot||"LOT—"} • Completato: ${ts}`;

        doc.setFont("helvetica","bold"); doc.setFontSize(11);
        const linesH = doc.splitTextToSize(header, W-2*margin);
        if(y + linesH.length*14 > H-margin) newPage();
        doc.text(linesH, margin, y); y += linesH.length*14;

        doc.setFont("helvetica","normal"); doc.setFontSize(9);
        const l1 = doc.splitTextToSize(meta1, W-2*margin);
        if(y + l1.length*12 > H-margin) newPage();
        doc.text(l1, margin, y); y += l1.length*12;

        const l2 = doc.splitTextToSize(meta2, W-2*margin);
        if(y + l2.length*12 > H-margin) newPage();
        doc.text(l2, margin, y); y += l2.length*12;

        y += 10;
        doc.setDrawColor(80);
        doc.line(margin, y, W-margin, y); y += 12;
      }

      const blob = doc.output("blob");
      const file = new File([blob], `backup_completati_${Date.now()}.pdf`, { type:"application/pdf" });

      if(navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({ files:[file], title:"Backup completati", text:"Backup completati linea polveri" });
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = file.name;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }
    }

    $("btnBackup")?.addEventListener("click", (e)=>{
      e.preventDefault();
      buildBackupPdf().catch(err=>alert("Errore PDF: " + (err?.message||err)));
    });

    // ===== Undo all (admin) =====
    $("btnUndoAll")?.addEventListener("click", async (e)=>{
      e.preventDefault();
      const pw = prompt("Password admin per annullare TUTTI i completati:") || "";
      if(pw !== ADMIN_PW){ alert("Password errata."); return; }
      const n = _doneMap.size;
      if(n===0){ alert("Nessun completato."); return; }
      if(!confirm(`Confermi annullo di ${n} completati?`)) return;

      try{
        for(const k of Array.from(_doneMap.keys())){
          await deleteDoc(doc(DONE_COLL(), k));
        }
      }catch(err){
        alert("Errore annullo tutti: " + (err?.message||err));
      }
    });

    // ===== IA intelligente =====
    const _ia = { machine:null, size:null, selected:new Set(), map:new Map(), groups:[] };

    function openIa(){
      const m = $("iaModal");
      if(!m) return;
      _ia.machine = null;
      _ia.size = null;
      _ia.selected = new Set();
      _ia.map = new Map();
      _ia.groups = [];
      $("iaStep0").style.display = "";
      $("iaStep1").style.display = "none";
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    function closeIa(){
      const m = $("iaModal");
      if(!m) return;
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }

    function machineEligible(sizeLbl, packKg){
      const v = Number(packKg||0);
      if(_ia.machine==="small") return v>0 && v<=1.01;
      if(_ia.machine==="big") return v>=4.99;
      return false;
    }

    function renderIaSizes(){
      const chipWrap = $("iaSizes");
      const list = $("iaList");
      chipWrap.innerHTML = "";
      list.innerHTML = "";

      const candidates = _powderLines.filter(l=>machineEligible(sizeLabel(l.packKg), l.packKg));
      const sizes = Array.from(new Set(candidates.map(l=>sizeLabel(l.packKg)).filter(x=>x && x!=="—")));
      sizes.sort((a,b)=>a.localeCompare(b));

      if(!sizes.length){
        chipWrap.innerHTML = '<div class="empty">Nessuna taglia compatibile trovata.</div>';
        return;
      }

      if(!_ia.size || !sizes.includes(_ia.size)) _ia.size = sizes[0];

      chipWrap.innerHTML = sizes.map(s=>`<div class="chip ${s===_ia.size?'on':''}" data-s="${s}">${s}</div>`).join("");
      chipWrap.querySelectorAll(".chip").forEach(c=>{
        c.addEventListener("click", ()=>{
          _ia.size = c.getAttribute("data-s");
          renderIaList();
          renderIaSizes();
        });
      });

      renderIaList();
    }

    function renderIaList(){
      const list = $("iaList");
      _ia.selected = new Set();
      _ia.map = new Map();

      const filtered = _powderLines.filter(l=>machineEligible(sizeLabel(l.packKg), l.packKg) && sizeLabel(l.packKg)===_ia.size);
      const groups = groupProducts(filtered);
      _ia.groups = groups;

      if(groups.length===0){
        list.innerHTML = '<div class="empty">Nessun prodotto in questa taglia.</div>';
        $("iaConfirm").disabled = true;
        $("iaSelInfo").textContent = "0 selezionati";
        return;
      }

      // render per materia prima
      const byMat = new Map();
      for(const g of groups){
        const m = g.material || "altro";
        const arr = byMat.get(m) || [];
        arr.push(g);
        byMat.set(m, arr);
      }
      const mats = Array.from(byMat.entries()).sort((a,b)=>a[0].localeCompare(b[0]));

      list.innerHTML = mats.map(([mat, arr])=>{
        arr.sort((a,b)=> (b.kg-a.kg) || a.label.localeCompare(b.label));
        return `
          <div class="sec">
            <div class="secHead">${mat.toUpperCase()}</div>
            ${arr.map(g=>{
              const kg = Math.round(g.kg*10)/10;
              _ia.map.set(g.key, g.lines.map(x=>x.lineKey));
              return `
                <div class="row iaRow" data-g="${g.key}">
                  <label class="check">
                    <input type="checkbox">
                    <span></span>
                  </label>
                  <div class="l">
                    <div class="t">${g.label}</div>
                    <div class="m">
                      <span class="badge ok">${g.code||"—"}</span>
                      <span class="badge">${g.size||"—"}</span>
                      <span class="badge warn mono">${kg} kg</span>
                      <span class="badge mono">${g.lines.length} righe</span>
                    </div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }).join("");

      list.querySelectorAll(".iaRow input[type=checkbox]").forEach(cb=>{
        cb.addEventListener("change", ()=>{
          const gid = cb.closest(".iaRow")?.getAttribute("data-g") || "";
          const keys = _ia.map.get(gid) || [];
          if(cb.checked) keys.forEach(k=>_ia.selected.add(k));
          else keys.forEach(k=>_ia.selected.delete(k));
          $("iaConfirm").disabled = _ia.selected.size===0;
          $("iaSelInfo").textContent = `${_ia.selected.size} selezionati`;
        });
      });

      $("iaConfirm").disabled = true;
      $("iaSelInfo").textContent = "0 selezionati";
    }

    $("btnIA")?.addEventListener("click", (e)=>{ e.preventDefault(); openIa(); });
    $("btnIA2")?.addEventListener("click", (e)=>{ e.preventDefault(); openIa(); });
    $("iaClose")?.addEventListener("click", (e)=>{ e.preventDefault(); closeIa(); });
    $("iaModal")?.addEventListener("click", (e)=>{ if(e.target === $("iaModal")) closeIa(); });

    $("iaSmall")?.addEventListener("click", ()=>{
      _ia.machine = "small";
      $("iaStep0").style.display = "none";
      $("iaStep1").style.display = "";
      renderIaSizes();
    });
    $("iaBig")?.addEventListener("click", ()=>{
      _ia.machine = "big";
      $("iaStep0").style.display = "none";
      $("iaStep1").style.display = "";
      renderIaSizes();
    });
    $("iaBack")?.addEventListener("click", ()=>{
      _ia.machine = null;
      _ia.size = null;
      _ia.selected = new Set();
      $("iaStep0").style.display = "";
      $("iaStep1").style.display = "none";
    });
    $("iaConfirm")?.addEventListener("click", (e)=>{
      e.preventDefault();
      if(_ia.selected.size===0) return;
      // prepara batch e passa dalla firma (come sempre)
      const selectedKeys = Array.from(_ia.selected);
      const selectedLines = _powderLines.filter(l=>selectedKeys.includes(l.lineKey));
      _pendingBatch = { title: `IA • ${_ia.machine==="small" ? "piccoli" : "grandi"} • ${_ia.size}`, selectedKeys, lines:selectedLines };
      closeIa();
      openSigModal(`${_pendingBatch.title} • ${selectedKeys.length} righe`);
    });


    // ===== Revenue (admin) =====
    function computeRevenueByCustomer(){
      const map = new Map();
      for(const d of _rawDocs){
        const hasPowder = (d.lines||[]).some(l=>l.powder);
        if(!hasPowder) continue;
        const cust = d.customer || "Cliente";
        const gross = (d.totale != null) ? d.totale : ((d.imponibile!=null && d.iva!=null) ? (d.imponibile + d.iva) : null);
        const curr = map.get(cust) || { gross:0, known:true, docs:0 };
        if(gross == null) curr.known = false;
        else curr.gross += gross;
        curr.docs += 1;
        map.set(cust, curr);
      }
      return Array.from(map.entries()).map(([cust,v])=>({cust, ...v})).sort((a,b)=>a.cust.localeCompare(b.cust));
    }

    function openRevenueModal(){
      const m = $("revModal");
      const body = $("revBody");
      const rows = computeRevenueByCustomer();
      if(rows.length===0){
        body.innerHTML = '<div class="empty">Nessun documento con righe polveri.</div>';
      } else {
        const total = rows.filter(r=>r.known).reduce((s,r)=>s+r.gross,0);
        body.innerHTML = `
          <div class="row" style="margin-bottom:12px;">
            <div class="l">
              <div class="t">Totale fatturato (ordini polveri)</div>
              <div class="m"><span class="badge ok">${euro(total)}</span><span class="badge">${rows.length} clienti</span></div>
            </div>
          </div>
          ${rows.map(r=>`
            <div class="row">
              <div class="l">
                <div class="t">${r.cust}</div>
                <div class="m">
                  <span class="badge">${r.docs} doc</span>
                  <span class="badge warn">${r.known ? euro(r.gross) : "Totale non disponibile (mancano tag in XML)"}</span>
                </div>
              </div>
            </div>
          `).join("")}
        `;
      }
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    function closeRevenueModal(){
      const m = $("revModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }
    $("btnRevenue").addEventListener("click",(e)=>{
      e.preventDefault();
      const pwd = prompt("Password admin:");
      if(pwd !== "12345") return;
      openRevenueModal();
    });
    $("revClose").addEventListener("click",(e)=>{ e.preventDefault(); closeRevenueModal(); });
    $("revModal").addEventListener("click",(e)=>{ if(e.target === $("revModal")) closeRevenueModal(); });

    // ===== Info =====
    $("btnHelp").addEventListener("click", (e)=>{
      e.preventDefault();
      alert(
        "Questo hub legge SOLO EasyFatt XML dalla cartella Drive (file Documenti.DefXml).\n\n" +
        "Viste:\n- Per cliente: solo articoli in polvere\n- Per materia prima: tot kg rame/zolfo/caolino\n- Per taglia: tot kg per 1kg/5kg/25kg ecc\n- Art. non pertinenti: tutto il resto\n\n" +
        "Per segnare completato: apri cliente → spunta righe → firma → salva."
      );
    });
  
</script>
  <!-- IA intelligente -->
  <div class="modal" id="iaModal" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div class="h">IA intelligente</div>
          <div class="sub" id="iaSub">Scegli la macchina e seleziona cosa completare.</div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="iaClose" type="button">Chiudi</button>
        </div>
      </div>

      <div class="iaBody">
        <div class="iaStep" id="iaStep0">
          <div class="iaQ">Ciao 👋 con quale macchina procedi?</div>
          <div class="iaBtns">
            <button class="btn primary big" id="iaSmall" type="button">Macchina piccoli formati<br><span class="muted">0,5 kg • 1 kg</span></button>
            <button class="btn primary big" id="iaBig" type="button">Macchina grandi formati<br><span class="muted">5 kg • 10 kg</span></button>
          </div>
        </div>

        <div class="iaStep" id="iaStep1" style="display:none;">
          <div class="row">
            <div class="iaQ">Seleziona la taglia da produrre</div>
            <div class="chips" id="iaSizes"></div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="iaQ">Lista articoli (solo polveri), divisi per materia prima</div>
            <div class="list pickList" id="iaList"></div>
          </div>

          <div class="iaBar">
            <div class="muted" id="iaSelInfo">0 selezionati</div>
            <div class="actions">
              <button class="btn ghost" id="iaBack" type="button">Indietro</button>
              <button class="btn ok" id="iaConfirm" type="button" disabled>Completato</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
