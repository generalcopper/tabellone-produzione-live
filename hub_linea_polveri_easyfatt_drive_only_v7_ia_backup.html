<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HUB LINEA POLVERI — EasyFatt XML</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg0:#06101d;
      --bg1:#0a1a2e;
      --panel: rgba(10, 26, 46, .72);
      --panel2: rgba(255,255,255,.06);
      --line: rgba(122, 215, 255, .20);
      --text:#eaf7ff;
      --muted: rgba(234,247,255,.72);
      --accent:#7ad7ff;
      --ok:#4dffb3;
      --warn:#ffd66d;
      --danger:#ff4d6d;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --r: 16px;
      --r2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 900px at 15% 12%, rgba(122,215,255,.12), transparent 55%),
        radial-gradient(900px 800px at 85% 18%, rgba(255,214,109,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{ max-width: 1320px; margin: 0 auto; padding: 14px 14px 26px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: sticky; top: 10px; z-index: 5;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .t{ font-size: 15px; letter-spacing:.8px; font-weight: 800; text-transform: uppercase; }
    .brand .s{ font-size: 12px; color: var(--muted); }
    .statusRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--warn); box-shadow: 0 0 0 3px rgba(255,214,109,.14); }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(77,255,179,.14); }
    .dot.bad{ background: var(--danger); box-shadow: 0 0 0 3px rgba(255,77,109,.14); }
    .mono{ font-family: var(--mono); }
    .btn{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(122,215,255,.38); background: rgba(255,255,255,.085); }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn.primary{ background: rgba(122,215,255,.16); }
    .btn.ghost{ background: rgba(0,0,0,.16); }
    .btn.danger{ background: rgba(255,77,109,.12); border-color: rgba(255,77,109,.22); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 3fr 1.25fr;
      gap: 12px;
      align-items:start;
    }
    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      min-height: 140px;
    }
    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(122,215,255,.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
    }
    .cardHead .h{ font-weight: 900; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    .cardHead .sub{ margin-top:3px; font-size: 12px; color: var(--muted); line-height: 1.25; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; padding: 10px 14px 12px; border-bottom: 1px solid rgba(122,215,255,.10); background: rgba(255,255,255,.03); }
    .tab{ padding: 9px 12px; border-radius: 999px; border:1px solid rgba(122,215,255,.18); background: rgba(0,0,0,.14); font-weight:800; font-size: 12px; cursor:pointer; color: var(--muted); }
    .tab.on{ background: rgba(122,215,255,.18); color: var(--text); border-color: rgba(122,215,255,.34); }
    .list{ padding: 10px 12px 14px; max-height: 62vh; overflow:auto; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 12px 12px;
      border: 1px solid rgba(122,215,255,.12);
      border-radius: var(--r2);
      background: rgba(255,255,255,.05);
      margin-bottom: 10px;
    }
    .row:hover{ border-color: rgba(122,215,255,.24); background: rgba(255,255,255,.07); }
    .row .l{ min-width: 0; flex: 1; }
    .row .t{ font-weight: 900; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row .m{ font-size: 12px; color: var(--muted); margin-top:3px; display:flex; gap:10px; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 6px 8px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(0,0,0,.16);
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(77,255,179,.22); background: rgba(77,255,179,.10); color: rgba(234,247,255,.92); }
    .badge.warn{ border-color: rgba(255,214,109,.22); background: rgba(255,214,109,.10); color: rgba(234,247,255,.92); }
    .badge.danger{ border-color: rgba(255,77,109,.22); background: rgba(255,77,109,.10); color: rgba(234,247,255,.92); }
    .rightCol{ display:flex; flex-direction:column; gap: 12px; }
    .smallList{ padding: 10px 12px 14px; max-height: 30vh; overflow:auto; }
    .smallRow{ padding: 10px 10px; border: 1px solid rgba(122,215,255,.12); border-radius: var(--r2); background: rgba(255,255,255,.05); margin-bottom: 10px; }
    .smallRow .t{ font-weight: 900; font-size: 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .smallRow .m{ margin-top:4px; font-size: 12px; color: var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .empty{ opacity:.65; font-size: 12px; padding: 8px 2px; }
    .summary{
      padding: 12px 14px 14px;
      display:flex; flex-direction:column; gap: 10px;
    }
    .summaryGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi{ border:1px solid rgba(122,215,255,.14); background: rgba(255,255,255,.05); border-radius: var(--r2); padding: 10px 10px; }
    .kpi .k{ font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing:.6px; }
    .kpi .v{ margin-top:4px; font-weight: 950; font-size: 16px; }
    .kpi .v.small{ font-size: 13px; font-weight: 850; }
    .footBtns{ display:flex; gap: 8px; flex-wrap:wrap; }
    .muted{ color: var(--muted); }

    /* Modal */
    .modal{ position: fixed; inset: 0; display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50; background: rgba(0,0,0,.62); }
    .modal.show{ display:flex; }
    .box{ width: min(980px, 100%); max-height: 86vh; overflow:hidden; border-radius: 18px; border:1px solid rgba(122,215,255,.22); background: rgba(7,18,32,.92); box-shadow: 0 20px 80px rgba(0,0,0,.55); }
    .boxHead{ padding: 14px 14px; border-bottom: 1px solid rgba(122,215,255,.16); display:flex; justify-content:space-between; gap: 10px; align-items:flex-start; }
    .boxHead .h{ font-weight: 950; letter-spacing:.7px; text-transform: uppercase; font-size: 13px; }
    .boxHead .s{ margin-top:3px; font-size: 12px; color: var(--muted); }
    .boxBody{ padding: 12px 12px 14px; overflow:auto; max-height: calc(86vh - 112px); }
    .lineRow{
      display:grid;
      grid-template-columns: 34px 1.1fr .55fr .55fr .55fr;
      gap: 10px;
      padding: 10px 10px;
      border:1px solid rgba(122,215,255,.12);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      margin-bottom: 10px;
      align-items:center;
    }
    .chk{ display:flex; justify-content:center; }
    .lineMain{ min-width:0; }
    .lineMain .t{ font-weight: 900; font-size: 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lineMain .m{ margin-top:4px; font-size: 12px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
    .col{ font-family: var(--mono); font-size: 12px; color: rgba(234,247,255,.92); }
    .boxActions{ display:flex; justify-content:space-between; gap: 10px; padding: 12px 12px 14px; border-top: 1px solid rgba(122,215,255,.16); align-items:center; }
    .sigChk{ display:flex; gap: 8px; align-items:center; font-weight: 800; font-size: 12px; }
    .canvas{
      width:100%; height: 180px;
      border-radius: 16px;
      border: 1px solid rgba(122,215,255,.20);
      background: rgba(255,255,255,.03);
      touch-action: none;
    }

    /* Mobile */
    @media (max-width: 900px){

      .wrap{ padding: 12px 12px 24px; }
      .grid{ grid-template-columns: 1fr; }
      .list{ max-height: none; }
      .smallList{ max-height: none; }
      .summaryGrid{ grid-template-columns: 1fr; }
      .lineRow{ grid-template-columns: 34px 1fr; }
      .col{ grid-column: 2; }
      .row .m{ gap:8px; }
      .topbar{ position: sticky; top: 10px; }
      #mobileSummaryCard{ display:block; }
      body{ font-size: 16px; }
      .topbar{ flex-direction: column; align-items: stretch; gap: 10px; padding: 12px; }
      .statusRow{ justify-content: space-between; width:100%; flex-wrap:wrap; }
      .brand .t{ font-size: 16px; }
      .brand .s{ font-size: 12px; }
      .pill{ padding: 10px 12px; font-size: 13px; } .statusRow .pill{ flex: 1 1 auto; }
      .btn{ padding: 12px 12px; font-size: 13px; border-radius: 14px; }
      .tabs{ padding: 10px 12px 12px; gap: 10px; }
      .tab{ padding: 12px 14px; font-size: 13px; }
      .row{ padding: 14px 12px; }
      .row .t{ font-size: 14px; }
      .badge{ font-size: 13px; padding: 7px 10px; }
      .list{ padding: 12px; }
      .cardHead .h{ font-size: 14px; }
      .cardHead .sub{ font-size: 13px; }
      #mobileSummaryCard .cardHead .h{ font-size: 14px; }
      #mobileSummaryTxt{ font-size: 15px; font-weight: 900; }

    }
    @media (min-width: 901px){
      #mobileSummaryCard{ display:none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="t">Hub linea polveri</div>
        <div class="s">AutoSync EasyFatt XML da Google Drive • no Google Sheet • iPhone + Desktop</div>
      </div>
      <div class="statusRow">
        <div class="pill"><span class="dot" id="driveDot"></span><span id="driveTxt">Drive: —</span></div>
        <div class="pill mono" id="clockTxt">—:—</div>
        <div class="pill" id="wxTxt">Meteo: —</div>
        <button class="btn" id="btnIA" type="button">IA intelligente</button>
        <button class="btn primary" id="btnSync" type="button">Sync Drive</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="ordersCard">
        <div class="cardHead">
          <div>
            <div class="h">Ordini EasyFatt XML</div>
            <div class="sub" id="ordersSub">In attesa sync…</div>
          </div>
          <div class="actions">
            <button class="btn ghost" id="btnHelp" type="button">Info</button>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Viste">
          <button class="tab on" data-view="customer" type="button">Per cliente</button>
          <button class="tab" data-view="material" type="button">Per materia prima</button>
          <button class="tab" data-view="size" type="button">Per taglia</button>
          <button class="tab" data-view="other" type="button">Art. non pertinenti</button>
        </div>

        <div class="list" id="ordersList">
          <div class="empty">In attesa ordini…</div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card" id="doneCard">
          <div class="cardHead">
            <div>
              <div class="h">Completati</div>
              <div class="sub" id="doneSub">Sync cloud…</div>
            </div>
            <div class="actions">
              <button class="btn ghost" id="btnBackup" type="button">Scarica backup</button>
              <button class="btn danger" id="btnUndo" type="button">Annulla ultimo</button>
              <button class="btn danger" id="btnUndoAll" type="button">Annulla tutti</button>
            </div>
          </div>
          <div class="smallList" id="doneList">
            <div class="empty">Nessun completato.</div>
          </div>
        </div>

        <div class="card" id="summaryCard">
          <div class="cardHead">
            <div>
              <div class="h">Riepilogo produzione</div>
              <div class="sub">Stima: 500 kg/ora • 8 ore/giorno</div>
            </div>
          </div>
          <div class="summary">
            <div class="summaryGrid">
              <div class="kpi">
                <div class="k">Kg totali (polveri)</div>
                <div class="v" id="kpiKg">—</div>
              </div>
              <div class="kpi">
                <div class="k">Giorni stimati</div>
                <div class="v" id="kpiDays">—</div>
              </div>
              <div class="kpi">
                <div class="k">Rame</div>
                <div class="v small" id="kpiRame">—</div>
              </div>
              <div class="kpi">
                <div class="k">Zolfo</div>
                <div class="v small" id="kpiZolfo">—</div>
              </div>
              <div class="kpi">
                <div class="k">Caolino</div>
                <div class="v small" id="kpiCaolino">—</div>
              </div>
              <div class="kpi">
                <div class="k">Altro</div>
                <div class="v small" id="kpiAltro">—</div>
              </div>
            </div>
            <div class="footBtns">
              <button class="btn primary" id="btnRevenue" type="button">Fatturato (admin)</button>
            </div>
            <div class="muted" style="font-size:12px;line-height:1.35;">
              I “giorni” sono calcolati sui kg totali ancora da completare (solo polveri), a 4000 kg/giorno.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile-only summary card at very bottom (always visible) -->
    <div class="card" id="mobileSummaryCard" style="margin-top:12px;">
      <div class="cardHead">
        <div>
          <div class="h">Per completare tutti gli ordini</div>
          <div class="sub" id="mobileSummaryTxt">ci vogliono — giorni</div>
        </div>
      </div>
      <div class="summary">
        <div class="summaryGrid">
          <div class="kpi"><div class="k">Rame</div><div class="v small" id="mRame">—</div></div>
          <div class="kpi"><div class="k">Zolfo</div><div class="v small" id="mZolfo">—</div></div>
          <div class="kpi"><div class="k">Caolino</div><div class="v small" id="mCaolino">—</div></div>
          <div class="kpi"><div class="k">Totale</div><div class="v small" id="mTotKg">—</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: righe cliente -->
  <div class="modal" id="custModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true">
      <div class="boxHead">
        <div>
          <div class="h" id="custTitle">Cliente</div>
          <div class="s" id="custSub">—</div>
        </div>
        <button class="btn ghost" id="custClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody" id="custBody"></div>
      <div class="boxActions">
        <div class="muted" style="font-size:12px;">Spunta le righe completate → firma → conferma</div>
        <div class="actions">
          <button class="btn ghost" id="custCancel" type="button">Annulla</button>
          <button class="btn primary" id="custConfirm" type="button" disabled>Conferma completati</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: firma -->
  <div class="modal" id="sigModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" style="width:min(760px,100%);">
      <div class="boxHead">
        <div>
          <div class="h">Firma operatore</div>
          <div class="s" id="sigSub">—</div>
        </div>
        <button class="btn ghost" id="sigClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody">
        <label class="sigChk">
          <input type="checkbox" id="sigYes" />
          Dichiari di aver prodotto come si deve?
        </label>
        <div style="height:10px;"></div>
        <canvas class="canvas" id="sigCanvas"></canvas>
        <div style="height:10px;"></div>
        <div class="actions" style="justify-content:flex-end;">
          <button class="btn ghost" id="sigClear" type="button">Pulisci</button>
        </div>
      </div>
      <div class="boxActions">
        <div class="muted" style="font-size:12px;">Obbligatorio: spunta + firma.</div>
        <div class="actions">
          <button class="btn ghost" id="sigCancel" type="button">Annulla</button>
          <button class="btn primary" id="sigOk" type="button">Salva completati</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: fatturato -->
  <div class="modal" id="revModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" style="width:min(760px,100%);">
      <div class="boxHead">
        <div>
          <div class="h">Fatturato ordini (admin)</div>
          <div class="s">Totale per cliente • imponibile + IVA • dai Document in XML</div>
        </div>
        <button class="btn ghost" id="revClose" type="button">Chiudi</button>
      </div>
      <div class="boxBody" id="revBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ===== Config Google Drive (EasyFatt XML) =====
    // Incolla qui la tua API key (Drive API abilitata). La cartella deve essere almeno "Chiunque con link: Visualizza"
    const XML_DRIVE_CFG = {
      folderId: "1Yy3i_buHx9zyMevozKk8NFny4ac44gGV",
      fileName: "Documenti.DefXml",
      apiKey: "AIzaSyC-zEBXOiw5LAEZ27ZgJ5uxZNVTZOumtuQ"
    };
    const XML_POLL_MS = 20000;

    // ===== Firebase (solo per Completati) =====
    const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== UI refs =====
    const $ = (id) => document.getElementById(id);
    const driveDot = $("driveDot");
    const driveTxt = $("driveTxt");
    const ordersSub = $("ordersSub");
    const ordersList = $("ordersList");
    const doneSub = $("doneSub");
    const doneList = $("doneList");
    const kpiKg = $("kpiKg");
    const kpiDays = $("kpiDays");
    const kpiRame = $("kpiRame");
    const kpiZolfo = $("kpiZolfo");
    const kpiCaolino = $("kpiCaolino");
    const kpiAltro = $("kpiAltro");
    const mobileSummaryTxt = $("mobileSummaryTxt");
    const mRame = $("mRame");
    const mZolfo = $("mZolfo");
    const mCaolino = $("mCaolino");
    const mTotKg = $("mTotKg");

    // ===== Clock + Meteo (Cerea, VR) =====
    const WX_LAT = 45.2153;
    const WX_LON = 11.1462;
    function pad2(n){ return String(n).padStart(2,"0"); }
    function tickClock(){
      const d = new Date();
      $("clockTxt").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    setInterval(tickClock, 250); tickClock();

    async function refreshWeather(){
      try{
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${WX_LAT}&longitude=${WX_LON}&current=temperature_2m,weather_code,wind_speed_10m&timezone=Europe%2FRome`;
        const r = await fetch(url, { cache:"no-store" });
        const j = await r.json();
        const t = j?.current?.temperature_2m;
        const w = j?.current?.wind_speed_10m;
        $("wxTxt").textContent = (t!=null && w!=null) ? `Cerea: ${Math.round(t)}°C • vento ${Math.round(w)} km/h` : "Meteo: —";
      }catch(_){
        $("wxTxt").textContent = "Meteo: —";
      }
    }
    refreshWeather();
    setInterval(refreshWeather, 10*60*1000);

    // ===== State =====
    let _view = "customer"; // customer | material | size | other
    let _rawDocs = [];       // parsed docs
    let _powderLines = [];   // flattened powder lines
    let _otherLines = [];    // flattened non-powder
    let _doneMap = new Map(); // lineKey => doc
    let _openCustomer = null;
    let _selectedKeys = new Set();
    let _pendingBatch = null;

    // ===== Helpers =====
    function setDriveState(ok, msg){
      driveDot.classList.toggle("ok", !!ok);
      driveDot.classList.toggle("bad", !ok && msg && msg.includes("Errore"));
      driveTxt.textContent = msg || (ok ? "Drive: OK" : "Drive: —");
    }

    function safeText(n){ return (n && (n.textContent||"").trim()) || ""; }

    function buildLineKey(docNumber, customer, code, desc, qty, um){
      const base = `${docNumber}|${customer}|${code}|${desc}|${qty}|${um}`;
      let h=0;
      for(let i=0;i<base.length;i++){ h=((h<<5)-h)+base.charCodeAt(i); h|=0; }
      return "x_" + Math.abs(h).toString(36);
    }

    function norm(s){ return String(s||"").toLowerCase(); }

    function detectPackKg(desc, code){
      const s0 = norm(desc).replace(/,/g,".");
      const c0 = norm(code||"").replace(/,/g,".");
      const scan = (s) => {
        let m = s.match(/(\d+(?:\.\d+)?)\s*kg\b/);
        if(m) return parseFloat(m[1]);
        m = s.match(/(\d+(?:\.\d+)?)\s*g\b/);
        if(m) return parseFloat(m[1]) / 1000;
        // Formati stile "500gr" o "1kg"
        m = s.match(/\b(\d+(?:\.\d+)?)\s*(kg|gr|g)\b/);
        if(m){
          const v = parseFloat(m[1]);
          if(m[2]==="kg") return v;
          return v/1000;
        }
        return null;
      };
      return scan(s0) ?? scan(c0);
    }

    function isPowderLine(code, desc, um){
      const s = norm(desc);
      const u = norm(um);
      const c = norm(code);

      // esclusioni "non pertinenti"
      if(s.includes("secchio")) return false;
      if(s.includes("tanica")) return false;
      if(s.includes("flacone")) return false;
      if(s.includes("spray")) return false;
      if(s.includes("bottiglia")) return false;

      // liquidi
      if(s.includes("ml") || s.includes("litro") || s.includes(" l") || s.includes("lt")) return false;
      if(u === "l" || u === "lt" || u === "ml") return false;

      // unità
      if(u === "kg" || u === "g") return true;

      // descrizione/codice con peso
      if(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/i.test(desc)) return true;
      if(/\b\d+(?:[\.,]\d+)?\s*(kg|gr|g)\b/i.test(code)) return true;

      // parole chiave polveri
      if(s.includes("polvere") || s.includes("sacco") || s.includes("sacchetto") || s.includes("granulare")) return true;

      // fallback: codici tipici sacchi
      if(c.includes("kg") || c.includes("sac") || c.includes("sacco")) return true;

      return false;
    }

    function materialOf(desc, code=""){
      const s = norm(desc);
      const c = norm(code);

      // rame (sinonimi tipici)
      if(/\brame\b/.test(s) || s.includes("copper") || s.includes("ossicloruro") || s.includes("poltiglia bordolese") ||
         s.includes("solfato di rame") || s.includes("idrossido") || s.includes("cupro") || s.includes("cupr") ||
         /\bcu\b/.test(s) || /\bcu\b/.test(c) || c.includes("cupr") || c.includes("cupro")) return "rame";

      // zolfo
      if(/\bzolfo\b/.test(s) || s.includes("sulfur") || s.includes("sulf") || s.includes("zolf") || c.includes("zolf") || c.includes("sulf")) return "zolfo";

      // caolino
      if(/\bcaolino\b/.test(s) || s.includes("kaolin") || c.includes("kaol")) return "caolino";

      return "altro";
    }

    function sizeLabel(packKg){
      if(packKg == null) return "—";
      const v = (Math.round(packKg*100)/100);
      const str = (String(v).includes(".") ? String(v).replace(".",",") : String(v));
      return `${str} kg`;
    }

    function computeLineKg(line){
      const qty = parseFloat(String(line.qty||"0").replace(",","."));
      const u = norm(line.um);
      const pack = line.packKg;
      if(Number.isNaN(qty)) return 0;
      if(pack != null) return qty * pack;
      if(u === "kg") return qty;
      if(u === "g") return qty/1000;
      return 0;
    }

    function euro(n){
      if(n == null || Number.isNaN(n)) return "—";
      return new Intl.NumberFormat("it-IT", { style:"currency", currency:"EUR" }).format(n);
    }

    // ===== Parse EasyFatt XML =====
    function parseEasyfattXml(xmlText){
      const outDocs = [];
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, "text/xml");
      const docs = Array.from(doc.getElementsByTagName("Document"));
      for(const d of docs){
        const customer = safeText(d.getElementsByTagName("CustomerName")[0]) || "Cliente";
        const number = safeText(d.getElementsByTagName("Number")[0]) || "";
        const date = safeText(d.getElementsByTagName("Date")[0]) || "";
        const conclusion = (
          safeText(d.getElementsByTagName("ExpectedConclusion")[0]) ||
          safeText(d.getElementsByTagName("ExpectedDeliveryDate")[0]) ||
          safeText(d.getElementsByTagName("DeliveryDate")[0]) ||
          safeText(d.getElementsByTagName("DueDate")[0]) ||
          safeText(d.getElementsByTagName("EndDate")[0]) ||
          safeText(d.getElementsByTagName("DataConsegna")[0]) ||
          safeText(d.getElementsByTagName("DataFine")[0]) ||
          ""
        );

        const getNum = (...tags) => {
          for(const t of tags){
            const v = safeText(d.getElementsByTagName(t)[0]);
            if(v) {
              const n = parseFloat(v.replace(",","."));
              if(!Number.isNaN(n)) return n;
            }
          }
          return null;
        };
        const imponibile = getNum("TotalNet", "TotalImponibile", "NetAmount", "TaxableAmount");
        const iva = getNum("TotalVat", "VatAmount", "VATAmount", "TaxAmount");
        const totale = getNum("Total", "TotalGross", "GrossAmount", "TotalAmount");

        const rows = Array.from(d.getElementsByTagName("Row"));
        const lines = [];
        for(const r of rows){
          const code = safeText(r.getElementsByTagName("Code")[0]) || "";
          const desc = safeText(r.getElementsByTagName("Description")[0]) || code || "Riga";
          const qty  = safeText(r.getElementsByTagName("Qty")[0]) || "0";
          const um   = safeText(r.getElementsByTagName("Um")[0]) || "";
          const packKg = detectPackKg(desc, code);
          const powder = isPowderLine(code, desc, um);
          const mat = powder ? materialOf(desc, code) : "altro";
          const lineKey = buildLineKey(number, customer, code, desc, qty, um);
          lines.push({ lineKey, customer, docNumber:number, docDate:date, docConclusion: conclusion, code, description:desc, qty, um, powder, material:mat, packKg });
        }

        outDocs.push({
          customer, number, date, conclusion,
          imponibile, iva,
          totale: (totale != null ? totale : (imponibile !=null && iva!=null ? (imponibile + iva) : null)),
          lines
        });
      }
      return outDocs;
    }

    // ===== Drive fetch =====
    async function driveListTargetFile() {
      const q = encodeURIComponent(`'${XML_DRIVE_CFG.folderId}' in parents and name='${XML_DRIVE_CFG.fileName}' and trashed=false`);
      const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime,size)&key=${XML_DRIVE_CFG.apiKey}`;
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) throw new Error(`Drive list HTTP ${r.status}`);
      const j = await r.json();
      const f = (j.files||[])[0];
      if(!f) throw new Error("File non trovato in cartella");
      return f;
    }

    async function driveFetchFileContent(fileId) {
      const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=${XML_DRIVE_CFG.apiKey}`;
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) throw new Error(`Drive media HTTP ${r.status}`);
      return await r.text();
    }

    async function syncFromDrive() {
      if(!XML_DRIVE_CFG.apiKey || XML_DRIVE_CFG.apiKey.includes("INCOLLA")) {
        setDriveState(false, "Drive: manca API key");
        ordersSub.textContent = "Incolla la Drive API key nel file (XML_DRIVE_CFG.apiKey).";
        return;
      }
      $("btnSync").disabled = true;
      try {
        setDriveState(false, "Drive: sync…");
        const f = await driveListTargetFile();
        const xmlText = await driveFetchFileContent(f.id);
        _rawDocs = parseEasyfattXml(xmlText);

        const allLines = _rawDocs.flatMap(d => d.lines.map(l => ({...l})));
        _powderLines = allLines.filter(x => x.powder);
        _otherLines  = allLines.filter(x => !x.powder);

        setDriveState(true, "Drive: OK");
        const mod = f.modifiedTime ? new Date(f.modifiedTime).toLocaleString("it-IT") : new Date().toLocaleString("it-IT");
        ordersSub.textContent = `Aggiornato: ${mod} • Polveri: ${_powderLines.length} righe • Non pertinenti: ${_otherLines.length} righe`;
        renderAll();
      } catch(e) {
        console.log(e);
        setDriveState(false, "Drive: Errore");
        ordersSub.textContent = (e?.message || String(e));
        ordersList.innerHTML = `<div class="empty">Errore Drive: ${(e?.message || e)}<br><br>
        Nota: con sola API key la cartella/file devono essere pubblici (Chiunque con link: Visualizza).</div>`;
      } finally {
        $("btnSync").disabled = false;
      }
    }

    $("btnSync").addEventListener("click", (e) => { e.preventDefault(); syncFromDrive(); });

    // Autosync
    setTimeout(syncFromDrive, 450);
    setInterval(syncFromDrive, XML_POLL_MS);

    // ===== Firestore completati =====
    function dayKey(d=new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    const DONE_COLL = () => collection(db, "powderOrdersDone", dayKey(), "items");

    function lineDone(lineKey) { return _doneMap.has(lineKey); }

    function initDoneRealtime() {
      try {
        onSnapshot(DONE_COLL(), (snap) => {
          _doneMap.clear();
          snap.forEach((d) => {
            const v = d.data() || {};
            _doneMap.set(d.id, v);
          });
          renderDone();
          renderAll();
        }, (err) => {
          console.log("done snapshot err:", err);
          doneSub.textContent = "Cloud: errore";
        });
        doneSub.textContent = "Cloud: OK";
      } catch(e) {
        console.log(e);
        doneSub.textContent = "Cloud: non inizializzato";
      }
    }
    initDoneRealtime();

    // ===== Rendering =====
    function fmtQty(line) {
      const q = String(line.qty||"0");
      return `${q} ${line.um||""}`.trim();
    }

    function renderAll(){
      renderOrders();
      renderSummary();
    }

    function renderOrders(){
      const powderPending = _powderLines.filter(l => !lineDone(l.lineKey));
      const otherPending = _otherLines.filter(l => !lineDone(l.lineKey));

      if(_view === "customer") {
        const by = new Map();
        for(const l of powderPending) {
          const arr = by.get(l.customer) || [];
          arr.push(l);
          by.set(l.customer, arr);
        }
        const customers = Array.from(by.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        if(customers.length === 0) {
          ordersList.innerHTML = '<div class="empty">Nessun ordine polveri in coda.</div>';
          return;
        }
        ordersList.innerHTML = customers.map(([cust, lines]) => {
          const kg = lines.reduce((s,l)=>s+computeLineKg(l),0);
          const docs = new Set(lines.map(x=>x.docNumber).filter(Boolean)).size;
          return `
            <div class="row" data-cust="${encodeURIComponent(cust)}">
              <div class="l">
                <div class="t">${cust}</div>
                <div class="m">
                  <span class="badge ok">${lines.length} righe</span>
                  <span class="badge">${docs} doc</span>
                  ${(function(){ const c=(lines.map(x=>x.docConclusion).filter(Boolean)[0]||""); return c ? '<span class="badge">Conclusione: '+c+'</span>' : ''; })()}
                  <span class="badge warn mono">${Math.round(kg*10)/10} kg</span>
                </div>
              </div>
              <div class="badge">Apri</div>
            </div>
          `;
        }).join("");
        ordersList.querySelectorAll(".row").forEach(r => {
          r.addEventListener("click", () => {
            const cust = decodeURIComponent(r.getAttribute("data-cust") || "");
            openCustomerModal(cust, false);
          });
        });
      } else if(_view === "material") {
        const mats = ["rame","zolfo","caolino","altro"];
        const rows = mats.map(m => {
          const lines = powderPending.filter(l => l.material===m);
          const kg = lines.reduce((s,l)=>s+computeLineKg(l),0);
          const customers = new Set(lines.map(x=>x.customer)).size;
          return { m, lines, kg, customers };
        });
        ordersList.innerHTML = rows.map(r => {
          const label = r.m.charAt(0).toUpperCase() + r.m.slice(1);
          return `
            <div class="row">
              <div class="l">
                <div class="t">${label}</div>
                <div class="m">
                  <span class="badge ok">${r.lines.length} righe</span>
                  <span class="badge">${r.customers} clienti</span>
                  <span class="badge warn mono">${Math.round(r.kg*10)/10} kg</span>
                </div>
              </div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun dato.</div>';
      } else if(_view === "size") {
        const by = new Map();
        for(const l of powderPending) {
          const key = sizeLabel(l.packKg);
          const arr = by.get(key) || [];
          arr.push(l);
          by.set(key, arr);
        }
        const keys = Array.from(by.keys()).sort((a,b)=> {
          const na = parseFloat(a.replace(",",".")); const nb = parseFloat(b.replace(",","."));
          if(!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
          return a.localeCompare(b);
        });
        ordersList.innerHTML = keys.map(k => {
          const lines = by.get(k) || [];
          const kg = lines.reduce((s,l)=>s+computeLineKg(l),0);
          return `
            <div class="row">
              <div class="l">
                <div class="t">${k}</div>
                <div class="m">
                  <span class="badge ok">${lines.length} righe</span>
                  <span class="badge warn mono">${Math.round(kg*10)/10} kg</span>
                </div>
              </div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun dato.</div>';
      } else if(_view === "other") {
        const by = new Map();
        for(const l of otherPending) {
          const arr = by.get(l.customer) || [];
          arr.push(l);
          by.set(l.customer, arr);
        }
        const customers = Array.from(by.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        ordersList.innerHTML = customers.map(([cust, lines]) => {
          return `
            <div class="row" data-cust_other="${encodeURIComponent(cust)}">
              <div class="l">
                <div class="t">${cust}</div>
                <div class="m">
                  <span class="badge danger">${lines.length} righe non pertinenti</span>
                </div>
              </div>
              <div class="badge">Apri</div>
            </div>
          `;
        }).join("") || '<div class="empty">Nessun articolo non pertinente.</div>';
        ordersList.querySelectorAll(".row").forEach(r => {
          r.addEventListener("click", () => {
            const cust = decodeURIComponent(r.getAttribute("data-cust_other") || "");
            openCustomerModal(cust, true);
          });
        });
      }
    }

    function renderSummary(){
      const powderPending = _powderLines.filter(l => !lineDone(l.lineKey));
      const totals = { rame:0, zolfo:0, caolino:0, altro:0, tot:0 };
      for(const l of powderPending) {
        const kg = computeLineKg(l);
        totals.tot += kg;
        totals[l.material] = (totals[l.material]||0) + kg;
      }
      const kgTot = Math.round(totals.tot*10)/10;
      const days = (kgTot>0) ? Math.ceil(kgTot / 4000) : 0;

      kpiKg.textContent = kgTot ? `${kgTot} kg` : "0 kg";
      kpiDays.textContent = `${days ? days : 0} giorni`;
      kpiRame.textContent = `${Math.round(totals.rame*10)/10} kg`;
      kpiZolfo.textContent = `${Math.round(totals.zolfo*10)/10} kg`;
      kpiCaolino.textContent = `${Math.round(totals.caolino*10)/10} kg`;
      kpiAltro.textContent = `${Math.round(totals.altro*10)/10} kg`;

      mobileSummaryTxt.textContent = `ci vogliono ${days ? days : 0} giorni`;
      mRame.textContent = `${Math.round(totals.rame*10)/10} kg`;
      mZolfo.textContent = `${Math.round(totals.zolfo*10)/10} kg`;
      mCaolino.textContent = `${Math.round(totals.caolino*10)/10} kg`;
      mTotKg.textContent = `${kgTot} kg`;
    }

    function renderDone(){
      const items = Array.from(_doneMap.entries()).map(([k,v]) => ({k, v}));
      if(items.length === 0) {
        doneList.innerHTML = '<div class="empty">Nessun completato.</div>';
        return;
      }
      items.sort((a,b)=>(b.v?.completedAtClientMs||0)-(a.v?.completedAtClientMs||0));
      doneList.innerHTML = items.slice(0,40).map(({k,v}) => {
        const when = v.completedAtClientMs ? new Date(v.completedAtClientMs).toLocaleString("it-IT") : "";
        return `
          <div class="smallRow">
            <div class="t">${(v.customer || "Cliente")} • ${(v.description || "")}</div>
            <div class="m">
              <span class="badge ok">${(v.code||"—")}</span>
              <span class="badge mono">${(v.qty||"0")} ${(v.um||"")}</span>
              <span class="badge">${when}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    // ===== Tabs =====
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("on"));
        t.classList.add("on");
        _view = t.getAttribute("data-view");
        renderOrders();
      });
    });

    // ===== Customer modal =====
    function openCustomerModal(customer, other){
      _openCustomer = customer;
      _selectedKeys = new Set();
      $("custTitle").textContent = other ? `Non pertinenti • ${customer}` : customer;

      const lines = (other ? _otherLines : _powderLines).filter(l => l.customer===customer && !lineDone(l.lineKey));
      lines.sort((a,b)=> (a.docNumber||"").localeCompare(b.docNumber||"") || (a.description||"").localeCompare(b.description||""));

      $("custSub").textContent = other
        ? `${lines.length} righe non pertinenti`
        : `${lines.length} righe polveri • spunta i completati`;

      const body = $("custBody");
      if(lines.length===0){
        body.innerHTML = '<div class="empty">Nessuna riga.</div>';
      } else {
        body.innerHTML = lines.map(l => {
          const kg = Math.round(computeLineKg(l)*10)/10;
          const size = sizeLabel(l.packKg);
          return `
            <div class="lineRow" data-k="${l.lineKey}">
              <div class="chk"><input type="checkbox" /></div>
              <div class="lineMain">
                <div class="t">${l.description}</div>
                <div class="m">
                  <span class="badge mono">COD: ${l.code || "—"}</span>
                  <span class="badge mono">${l.docNumber || "DOC"}${l.docDate ? " • " + l.docDate : ""}</span>
                  <span class="badge">${l.docConclusion ? "Conclusione: " + l.docConclusion : "Conclusione: —"}</span>
                  <span class="badge warn mono">${kg} kg</span>
                </div>
              </div>
              <div class="col">Qty: ${fmtQty(l)}</div>
              <div class="col">Taglia: ${size}</div>
              <div class="col">MP: ${l.material}</div>
            </div>
          `;
        }).join("");
      }

      body.querySelectorAll(".lineRow").forEach(r => {
        const k = r.getAttribute("data-k");
        const cb = r.querySelector("input[type=checkbox]");
        cb.addEventListener("change", () => {
          if(cb.checked) _selectedKeys.add(k);
          else _selectedKeys.delete(k);
          $("custConfirm").disabled = _selectedKeys.size===0;
        });
      });

      $("custConfirm").disabled = true;
      const m = $("custModal");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }

    function closeCustomerModal(){
      const m = $("custModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      _openCustomer = null;
      _selectedKeys = new Set();
    }

    $("custClose").addEventListener("click", (e)=>{ e.preventDefault(); closeCustomerModal(); });
    $("custCancel").addEventListener("click", (e)=>{ e.preventDefault(); closeCustomerModal(); });
    $("custModal").addEventListener("click", (e)=>{ if(e.target === $("custModal")) closeCustomerModal(); });

    $("custConfirm").addEventListener("click", (e)=>{
      e.preventDefault();
      if(!_openCustomer || _selectedKeys.size===0) return;
      const cust = _openCustomer;
      const lines = _powderLines.filter(l => l.customer===cust);
      _pendingBatch = {
        customer: cust,
        selectedKeys: Array.from(_selectedKeys),
        lines
      };
      openSigModal(`${cust} • ${_selectedKeys.size} righe completate`);
    });


    // ===== IA intelligente (wizard macchina -> taglia -> selezione) =====
    let _iaStep = 0;     // 0=choose machine, 1=choose size, 2=choose items
    let _iaMachine = null; // "small" | "big"
    let _iaSizeKey = null; // numeric packKg key string
    let _iaGroupMap = new Map(); // groupId -> { keys:[], label }
    let _iaSelectedGroups = new Set(); // groupId

    function iaOpen(){
      _iaStep = 0;
      _iaMachine = null;
      _iaSizeKey = null;
      _iaGroupMap.clear();
      _iaSelectedGroups.clear();
      renderIa();
      const m = $("iaModal");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    function iaClose(){
      const m = $("iaModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }
    function iaPendingPowders(){
      return _powderLines.filter(l => !lineDone(l.lineKey));
    }
    function machineMatchesLine(machine, l){
      const pk = (l.packKg==null) ? null : Number(l.packKg);
      if(pk==null) return false;
      if(machine === "small") return pk <= 2;     // 0.5 / 1 / 2 kg
      if(machine === "big")   return pk >= 2.5;   // 5 / 10 kg (e oltre)
      return false;
    }
    function canonProduct(desc){
      let s = norm(desc);
      s = s.replace(/,/g,".");
      s = s.replace(/\b\d+(?:\.\d+)?\s*(kg|gr|g)\b/g, " ");
      s = s.replace(/\b(sacco|sacchi|sacchetto|busta|bag|secchio|fusto|confezione|conf\.)\b/g, " ");
      s = s.replace(/\s+/g," ").trim();
      return s || norm(desc);
    }
    function titleCase(s){
      return String(s||"").split(" ").map(w => w ? (w[0].toUpperCase()+w.slice(1)) : "").join(" ");
    }
    function packKey(pk){
      if(pk==null) return "null";
      return String(Math.round(Number(pk)*1000)/1000);
    }

    function iaSizesForMachine(machine){
      const lines = iaPendingPowders().filter(l => machineMatchesLine(machine, l));
      const by = new Map(); // packKey -> { pk, lines }
      for(const l of lines){
        const k = packKey(l.packKg);
        const obj = by.get(k) || { pk: Number(l.packKg), lines: [] };
        obj.lines.push(l);
        by.set(k, obj);
      }
      return Array.from(by.values()).sort((a,b)=>a.pk-b.pk);
    }

    function iaBuildGroups(machine, sizeKey){
      const lines = iaPendingPowders().filter(l => machineMatchesLine(machine, l) && packKey(l.packKg)===sizeKey);
      const groups = new Map(); // gid -> { name, material, keys[], packs, kg, customers:Set, codes:Set }
      for(const l of lines){
        const name = canonProduct(l.description);
        const gid = `${l.material}::${name}`;
        const qty = parseFloat(String(l.qty||"0").replace(",","."));
        const packs = Number.isNaN(qty) ? 0 : qty;
        const kg = (l.packKg!=null) ? packs*Number(l.packKg) : computeLineKg(l);
        const g = groups.get(gid) || { name, material:l.material, keys:[], packs:0, kg:0, customers:new Set(), codes:new Set(), sample:l.description };
        g.keys.push(l.lineKey);
        g.packs += packs;
        g.kg += kg;
        g.customers.add(l.customer||"Cliente");
        if(l.code) g.codes.add(l.code);
        groups.set(gid, g);
      }
      return Array.from(groups.entries()).map(([gid,g])=>({ gid, ...g }))
        .sort((a,b)=> (a.material.localeCompare(b.material) || a.name.localeCompare(b.name)));
    }

    function renderIa(){
      const title = $("iaTitle");
      const sub = $("iaSub");
      const body = $("iaBody");
      const back = $("iaBack");
      const confirm = $("iaConfirm");

      confirm.disabled = true;
      back.disabled = false;

      if(_iaStep === 0){
        title.textContent = "IA intelligente";
        sub.textContent = "Ciao, con quale macchina procedi?";
        back.disabled = true;

        const pending = iaPendingPowders();
        const smallCount = pending.filter(l => machineMatchesLine("small", l)).length;
        const bigCount = pending.filter(l => machineMatchesLine("big", l)).length;

        body.innerHTML = `
          <div class="row" style="cursor:default;">
            <div class="l">
              <div class="t">Seleziona macchina</div>
              <div class="m"><span class="badge">Filtra solo articoli in polvere</span></div>
            </div>
          </div>

          <div class="row" id="iaSmall" style="cursor:pointer;">
            <div class="l">
              <div class="t">Macchina formati piccoli (0,5–1 kg)</div>
              <div class="m">
                <span class="badge ok">${smallCount} righe</span>
                <span class="badge">Taglie ≤ 2 kg</span>
              </div>
            </div>
            <div class="badge">Apri</div>
          </div>

          <div class="row" id="iaBig" style="cursor:pointer;">
            <div class="l">
              <div class="t">Macchina formati grandi (5–10 kg)</div>
              <div class="m">
                <span class="badge ok">${bigCount} righe</span>
                <span class="badge">Taglie ≥ 2,5 kg</span>
              </div>
            </div>
            <div class="badge">Apri</div>
          </div>
        `;
        $("iaSmall")?.addEventListener("click", ()=>{ _iaMachine="small"; _iaStep=1; renderIa(); });
        $("iaBig")?.addEventListener("click", ()=>{ _iaMachine="big"; _iaStep=1; renderIa(); });
        return;
      }

      if(_iaStep === 1){
        title.textContent = _iaMachine === "small" ? "Macchina piccoli formati" : "Macchina grandi formati";
        sub.textContent = "Scegli la taglia (solo polveri).";
        const sizes = iaSizesForMachine(_iaMachine);

        if(sizes.length === 0){
          body.innerHTML = `<div class="empty">Nessun articolo compatibile per questa macchina.</div>`;
          return;
        }

        body.innerHTML = sizes.map(o => {
          const pk = o.pk;
          const lab = sizeLabel(pk);
          const kg = Math.round(o.lines.reduce((s,l)=>s+computeLineKg(l),0)*10)/10;
          return `
            <div class="row iaSizeRow" data-k="${packKey(pk)}" style="cursor:pointer;">
              <div class="l">
                <div class="t">Prodotto da ${lab}</div>
                <div class="m">
                  <span class="badge ok">${o.lines.length} righe</span>
                  <span class="badge warn mono">${kg} kg</span>
                </div>
              </div>
              <div class="badge">Apri</div>
            </div>
          `;
        }).join("");

        body.querySelectorAll(".iaSizeRow").forEach(el=>{
          el.addEventListener("click", ()=>{
            _iaSizeKey = el.getAttribute("data-k");
            _iaStep = 2;
            renderIa();
          });
        });
        return;
      }

      if(_iaStep === 2){
        const pk = Number(_iaSizeKey);
        title.textContent = `Lista ${sizeLabel(pk)}`;
        sub.textContent = "Seleziona uno o più prodotti (raggruppati per materia prima).";

        const groups = iaBuildGroups(_iaMachine, _iaSizeKey);
        if(groups.length === 0){
          body.innerHTML = `<div class="empty">Nessun articolo in coda per questa taglia.</div>`;
          return;
        }

        // build sections by material
        const mats = ["rame","zolfo","caolino","altro"];
        _iaGroupMap.clear();

        body.innerHTML = mats.map(mat=>{
          const rows = groups.filter(g=>g.material===mat);
          if(rows.length===0) return "";
          const head = mat.charAt(0).toUpperCase()+mat.slice(1);
          return `
            <div class="row" style="cursor:default;">
              <div class="l">
                <div class="t">${head}</div>
                <div class="m"><span class="badge">${rows.length} prodotti</span></div>
              </div>
            </div>
            ${rows.map(g=>{
              _iaGroupMap.set(g.gid, { keys: g.keys, label: g.sample });
              const packs = Math.round(g.packs*100)/100;
              const kg = Math.round(g.kg*10)/10;
              const clienti = g.customers.size;
              return `
                <div class="lineRow" data-g="${g.gid}">
                  <div class="chk"><input type="checkbox" /></div>
                  <div class="lineMain">
                    <div class="t">${titleCase(g.sample)}</div>
                    <div class="m">
                      <span class="badge ok">${packs} pz</span>
                      <span class="badge warn mono">${kg} kg</span>
                      <span class="badge">${clienti} clienti</span>
                    </div>
                  </div>
                  <div class="col">Taglia: ${sizeLabel(pk)}</div>
                  <div class="col">MP: ${g.material}</div>
                </div>
              `;
            }).join("")}
          `;
        }).join("");

        // bind checks
        body.querySelectorAll(".lineRow").forEach(r=>{
          const gid = r.getAttribute("data-g");
          const cb = r.querySelector("input[type=checkbox]");
          cb.addEventListener("change", ()=>{
            if(cb.checked) _iaSelectedGroups.add(gid);
            else _iaSelectedGroups.delete(gid);

            const has = _iaSelectedGroups.size>0;
            $("iaConfirm").disabled = !has;
          });
        });

        $("iaConfirm").disabled = true;
        confirm.disabled = true; // will be controlled by handlers above
        return;
      }
    }

    $("btnIA").addEventListener("click", (e)=>{ e.preventDefault(); iaOpen(); });
    $("iaClose").addEventListener("click", (e)=>{ e.preventDefault(); iaClose(); });
    $("iaModal").addEventListener("click", (e)=>{ if(e.target === $("iaModal")) iaClose(); });
    $("iaBack").addEventListener("click", (e)=>{
      e.preventDefault();
      if(_iaStep===2){ _iaStep=1; _iaSelectedGroups.clear(); _iaGroupMap.clear(); renderIa(); return; }
      if(_iaStep===1){ _iaStep=0; _iaMachine=null; renderIa(); return; }
    });

    $("iaConfirm").addEventListener("click", (e)=>{
      e.preventDefault();
      const sel = Array.from(_iaSelectedGroups);
      if(sel.length===0) return;

      // collect all underlying lineKeys
      const keys = [];
      const uniq = new Set();
      for(const gid of sel){
        const g = _iaGroupMap.get(gid);
        if(!g) continue;
        for(const k of g.keys){
          if(uniq.has(k)) continue;
          uniq.add(k);
          keys.push(k);
        }
      }
      if(keys.length===0) return;

      // prepare batch and go to signature
      _pendingBatch = { selectedKeys: keys, lines: iaPendingPowders() };
      openSigModal(`${keys.length} righe completate • ${sizeLabel(Number(_iaSizeKey))}`);
    });


    // ===== Signature =====
    const SIG = { drawing:false, lastX:0, lastY:0, dirty:false };
    function resizeCanvas(){
      const c = $("sigCanvas");
      const rect = c.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
      c.width = Math.floor(rect.width * dpr);
      c.height = Math.floor(rect.height * dpr);
      const ctx = c.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth = 2.2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "rgba(234,247,255,.95)";
      ctx.fillStyle = "rgba(255,255,255,.02)";
      ctx.fillRect(0,0,rect.width,rect.height);
    }
    function clearCanvas(){
      const c = $("sigCanvas");
      const ctx = c.getContext("2d");
      const rect = c.getBoundingClientRect();
      ctx.clearRect(0,0,rect.width,rect.height);
      ctx.fillStyle = "rgba(255,255,255,.02)";
      ctx.fillRect(0,0,rect.width,rect.height);
      SIG.dirty = false;
    }
    function pos(ev){
      const c = $("sigCanvas");
      const r = c.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }
    function wireCanvas(){
      const c = $("sigCanvas");
      const ctx = c.getContext("2d");
      c.addEventListener("pointerdown", (ev)=>{
        ev.preventDefault();
        try{ c.setPointerCapture(ev.pointerId); }catch(_){}
        const p = pos(ev);
        SIG.drawing = true;
        SIG.lastX = p.x; SIG.lastY = p.y;
      });
      c.addEventListener("pointermove", (ev)=>{
        if(!SIG.drawing) return;
        ev.preventDefault();
        const p = pos(ev);
        ctx.beginPath();
        ctx.moveTo(SIG.lastX, SIG.lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        SIG.lastX = p.x; SIG.lastY = p.y;
        SIG.dirty = true;
      });
      function end(ev){ SIG.drawing=false; try{ c.releasePointerCapture(ev.pointerId); }catch(_ ){} }
      c.addEventListener("pointerup", end);
      c.addEventListener("pointercancel", end);
    }
    wireCanvas();
    window.addEventListener("resize", ()=>{ try{ resizeCanvas(); clearCanvas(); }catch(_ ){} });

    function openSigModal(sub){
      $("sigSub").textContent = sub || "—";
      $("sigYes").checked = false;
      const m = $("sigModal");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
      requestAnimationFrame(()=>{ resizeCanvas(); clearCanvas(); });
    }
    function closeSigModal(){
      const m = $("sigModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      _pendingBatch = null;
    }

    $("sigClose").addEventListener("click",(e)=>{ e.preventDefault(); closeSigModal(); });
    $("sigCancel").addEventListener("click",(e)=>{ e.preventDefault(); closeSigModal(); });
    $("sigModal").addEventListener("click",(e)=>{ if(e.target === $("sigModal")) closeSigModal(); });
    $("sigClear").addEventListener("click",(e)=>{ e.preventDefault(); clearCanvas(); });

    $("sigOk").addEventListener("click", async (e)=>{
      e.preventDefault();
      if(!_pendingBatch) { closeSigModal(); return; }
      if(!$("sigYes").checked) return;
      if(!SIG.dirty) return;

      let sigDataUrl = "";
      try { sigDataUrl = $("sigCanvas").toDataURL("image/jpeg", 0.75); }
      catch(_) { try { sigDataUrl = $("sigCanvas").toDataURL(); } catch(__){} }

      const batch = _pendingBatch;
      const keys = batch.selectedKeys || [];
      const lines = batch.lines || [];
      const now = Date.now();

      try {
        for(const k of keys) {
          const it = lines.find(x=>x.lineKey===k);
          if(!it) continue;
          await setDoc(doc(DONE_COLL(), k), {
            lineKey: k,
            customer: it.customer,
            docNumber: it.docNumber || "",
            docDate: it.docDate || "",
            code: it.code || "",
            description: it.description,
            qty: it.qty,
            um: it.um,
            packKg: it.packKg ?? null,
            material: it.material || "altro",
            signatureDataUrl: sigDataUrl,
            completedAtClientMs: now
          }, { merge:true });
        }
      } catch(err) {
        alert("Errore salvataggio cloud: " + (err?.message || err));
        return;
      }

      closeSigModal();
      closeCustomerModal();
      try{ iaClose(); }catch(_){}
      setTimeout(()=>{ renderAll(); }, 120);
    });

    // ===== Undo admin =====
    $("btnUndo").addEventListener("click", async (e)=>{
      e.preventDefault();
      const pwd = prompt("Password admin:");
      if(pwd !== "12345") return;

      const items = Array.from(_doneMap.entries()).map(([k,v]) => ({k, v}));
      items.sort((a,b)=>(b.v?.completedAtClientMs||0)-(a.v?.completedAtClientMs||0));
      const last = items[0];
      if(!last) return;
      if(!confirm(`Annullare l'ultimo completato?\n${last.v.customer} • ${last.v.description}`)) return;
      try {
        await deleteDoc(doc(DONE_COLL(), last.k));
      } catch(err) {
        alert("Errore annullo: " + (err?.message || err));
      }
    });

    // ===== Undo all (admin) =====
    $("btnUndoAll").addEventListener("click", async (e)=>{
      e.preventDefault();
      const pwd = prompt("Password admin:");
      if(pwd !== "12345") return;

      const keys = Array.from(_doneMap.keys());
      if(keys.length===0) return;
      if(!confirm(`Annullare TUTTI i completati di oggi?\nTotale: ${keys.length}`)) return;

      try{
        for(const k of keys){
          await deleteDoc(doc(DONE_COLL(), k));
        }
      }catch(err){
        alert("Errore annullo tutti: " + (err?.message || err));
      }
    });

    // ===== Backup PDF (share sheet su iPhone) =====
    function lottoFromMs(ms){
      const d = new Date(ms || Date.now());
      const yy = String(d.getFullYear()).slice(-2);
      const mo = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `LOT${yy}${mo}${da}${hh}${mi}${ss}`;
    }

    async function exportDonePdf(){
      const items = Array.from(_doneMap.entries()).map(([k,v]) => ({k, v}));
      if(items.length===0){ alert("Nessun completato."); return; }
      items.sort((a,b)=>(a.v?.description||"").localeCompare(b.v?.description||""));

      const { jsPDF } = (window.jspdf || {});
      if(!jsPDF){ alert("jsPDF non disponibile (rete?)."); return; }

      const pdf = new jsPDF({ unit:"pt", format:"a4" });
      const W = pdf.internal.pageSize.getWidth();
      const H = pdf.internal.pageSize.getHeight();
      let x = 40, y = 48, lh = 14;

      const now = new Date().toLocaleString("it-IT");
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(14);
      pdf.text("LINEA POLVERI — BACKUP COMPLETATI", x, y);
      y += 18;
      pdf.setFont("helvetica","normal");
      pdf.setFontSize(10);
      pdf.text(`Data export: ${now}`, x, y);
      y += 18;

      pdf.setFontSize(10);
      for(const {v} of items){
        const when = v.completedAtClientMs ? new Date(v.completedAtClientMs).toLocaleString("it-IT") : "";
        const lotto = lottoFromMs(v.completedAtClientMs || Date.now());
        const qty = `${v.qty||"0"} ${(v.um||"")}`.trim();
        const line1 = `${v.description||""} — ${qty} — ${Math.round(((v.packKg!=null)? (parseFloat(String(v.qty||"0").replace(",", "."))*(v.packKg||0)) : 0)*10)/10} kg`;
        const line2 = `${v.customer||"Cliente"} • DOC ${v.docNumber||""} • ${when} • ${lotto} • COD ${v.code||"—"}`;

        const wrap = (txt, maxW) => {
          const words = String(txt||"").split(" ");
          const lines = [];
          let cur = "";
          for(const w of words){
            const t = (cur? (cur+" "+w):w);
            if(pdf.getTextWidth(t) > maxW){
              if(cur) lines.push(cur);
              cur = w;
            } else cur = t;
          }
          if(cur) lines.push(cur);
          return lines;
        };

        const l1 = wrap(line1, W-80);
        const l2 = wrap(line2, W-80);

        const need = (l1.length+l2.length)*lh + 10;
        if(y + need > H-50){ pdf.addPage(); y = 48; }

        pdf.setFont("helvetica","bold");
        for(const ln of l1){ pdf.text(ln, x, y); y += lh; }
        pdf.setFont("helvetica","normal");
        for(const ln of l2){ pdf.text(ln, x, y); y += lh; }
        y += 8;
      }

      // signature (ultima disponibile)
      const lastSig = items.map(it=>it.v.signatureDataUrl).filter(Boolean)[0];
      if(lastSig){
        if(y + 140 > H-50){ pdf.addPage(); y = 48; }
        pdf.setFont("helvetica","bold"); pdf.text("Firma (ultima)", x, y); y += 10;
        try{ pdf.addImage(lastSig, "JPEG", x, y+8, 220, 110); }catch(_){}
      }

      const blob = pdf.output("blob");
      const filename = `backup_completati_${dayKey()}.pdf`;

      // Share sheet iOS se supportato
      try{
        const file = new File([blob], filename, { type: "application/pdf" });
        if(navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ files:[file], title:"Backup completati", text:"Backup completati linea polveri" });
          return;
        }
      }catch(_){}

      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
      setTimeout(()=>URL.revokeObjectURL(url), 60_000);
    }

    $("btnBackup").addEventListener("click", async (e)=>{ e.preventDefault(); await exportDonePdf(); });

    // ===== Revenue (admin) =====
    function computeRevenueByCustomer(){
      const map = new Map();
      for(const d of _rawDocs){
        const hasPowder = (d.lines||[]).some(l=>l.powder);
        if(!hasPowder) continue;
        const cust = d.customer || "Cliente";
        const gross = (d.totale != null) ? d.totale : ((d.imponibile!=null && d.iva!=null) ? (d.imponibile + d.iva) : null);
        const curr = map.get(cust) || { gross:0, known:true, docs:0 };
        if(gross == null) curr.known = false;
        else curr.gross += gross;
        curr.docs += 1;
        map.set(cust, curr);
      }
      return Array.from(map.entries()).map(([cust,v])=>({cust, ...v})).sort((a,b)=>a.cust.localeCompare(b.cust));
    }

    function openRevenueModal(){
      const m = $("revModal");
      const body = $("revBody");
      const rows = computeRevenueByCustomer();
      if(rows.length===0){
        body.innerHTML = '<div class="empty">Nessun documento con righe polveri.</div>';
      } else {
        const total = rows.filter(r=>r.known).reduce((s,r)=>s+r.gross,0);
        body.innerHTML = `
          <div class="row" style="margin-bottom:12px;">
            <div class="l">
              <div class="t">Totale fatturato (ordini polveri)</div>
              <div class="m"><span class="badge ok">${euro(total)}</span><span class="badge">${rows.length} clienti</span></div>
            </div>
          </div>
          ${rows.map(r=>`
            <div class="row">
              <div class="l">
                <div class="t">${r.cust}</div>
                <div class="m">
                  <span class="badge">${r.docs} doc</span>
                  <span class="badge warn">${r.known ? euro(r.gross) : "Totale non disponibile (mancano tag in XML)"}</span>
                </div>
              </div>
            </div>
          `).join("")}
        `;
      }
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
    }
    function closeRevenueModal(){
      const m = $("revModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }
    $("btnRevenue").addEventListener("click",(e)=>{
      e.preventDefault();
      const pwd = prompt("Password admin:");
      if(pwd !== "12345") return;
      openRevenueModal();
    });
    $("revClose").addEventListener("click",(e)=>{ e.preventDefault(); closeRevenueModal(); });
    $("revModal").addEventListener("click",(e)=>{ if(e.target === $("revModal")) closeRevenueModal(); });

    // ===== Info =====
    $("btnHelp").addEventListener("click", (e)=>{
      e.preventDefault();
      alert(
        "Questo hub legge SOLO EasyFatt XML dalla cartella Drive (file Documenti.DefXml).\n\n" +
        "Viste:\n- Per cliente: solo articoli in polvere\n- Per materia prima: tot kg rame/zolfo/caolino\n- Per taglia: tot kg per 1kg/5kg/25kg ecc\n- Art. non pertinenti: tutto il resto\n\n" +
        "Per segnare completato: apri cliente → spunta righe → firma → salva."
      );
    });
  </script>
</body>
</html>
