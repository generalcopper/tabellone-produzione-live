<!doctype html>
<html lang="it" translate="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="google" content="notranslate"/>
  <meta http-equiv="Content-Language" content="it"/>
  <meta name="color-scheme" content="light"/>
  <!-- // UI-FIX: anticache --><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <!-- // UI-FIX: anticache --><meta http-equiv="Pragma" content="no-cache" />
  <!-- // UI-FIX: anticache --><meta http-equiv="Expires" content="0" />
  <title>Hub Linea Polveri</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2716%27 fill=%27%232e7bff%27/%3E%3Cpath d=%27M22 43c0-11 8-20 20-20h2v6h-2c-8 0-14 6-14 14v2h-6v-2z%27 fill=%27white%27/%3E%3Cpath d=%27M40 33a6 6 0 1 1 0-12h2v6h-2a0 0 0 0 0 0 0 0 0 0 0 0 0 6z%27 fill=%27white%27 opacity=%270.9%27/%3E%3C/svg%3E">
  <style>
    :root {
      --bg: #e9ecf3;
      --bg2: #f7f8fb;
      --card: rgba(255,255,255,0.9);
      --card2: rgba(255,255,255,0.94);
      --stroke: rgba(12,22,52,.10);
      --text: rgba(12,16,26,.90);
      --muted: rgba(12,16,26,.62);
      --accent:#0a84ff;
      --good:#34c759;
      --warn:#ff9f0a;
      --bad:#ff3b30;
      --shadow: 0 18px 44px rgba(15,23,42,.16);
      --radius: 20px;
      --radius2: 24px;
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
      --banner-offset: 0px;
      --hdrH: 72px;
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Avenir Next", Avenir, "Helvetica Neue", Helvetica, Arial, sans-serif;
      background:
        radial-gradient(900px 900px at 20% 18%, rgba(10,132,255,.14), transparent),
        radial-gradient(1100px 1100px at 82% 12%, rgba(52,199,89,.10), transparent),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color: var(--text);
      overflow-y: auto;
      overflow-x: hidden;
      max-width: 100vw;
    }

    .wrap {
      max-width: 1360px;
      width: min(96vw, 1360px);
      margin: 0 auto;
      padding: calc(14px + var(--safe-top) + var(--banner-offset)) 16px calc(26px + var(--safe-bot));
    }

    header.headerRow {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: calc(6px + var(--safe-top) * 0.3) 0 8px;
      margin-bottom: 12px;
      min-height: 72px;
      flex-wrap: nowrap;
      width:100%;
      min-width:0;
    }

    .headerRow .actions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      flex:0 0 auto;
      min-width:0;
      width:auto;
    }
    .brand { display:flex; align-items:center; gap:12px; min-width:0; flex:1 1 auto; }
    .brandLogo {
      width: 80px; height: 80px;
      border-radius: 0 !important;
      flex: 0 0 auto;
      display:block;
      object-fit: contain;
      background: transparent;
      transform: translateY(-4px);
    }
    .titleWrap{ display:flex; flex-direction:column; gap:4px; justify-content:center; min-width:0; flex:1 1 auto; }
    .title {
      font-size: 40px;
      line-height: 0.85;
      font-weight: 800;
      letter-spacing: -0.02em;
      text-transform: none;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      word-break: break-word;
      min-width:0;
    }
    .title .titleLine{
      display:block;
      line-height:1.05;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title .titleLine.accent{ color: #0a84ff; }
    .subtitle {
      margin-top: 2px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    .mobileWelcomeWrap{
      display:none;
      gap:8px;
      margin-top: 6px;
      width:100%;
      max-width: 100%;
    }
    .mobileWelcome{
      font-size: 13px;
      line-height: 1.4;
      color: var(--muted);
      font-weight: 700;
      background: rgba(0,0,0,.03);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    }
    .mobileWelcome .highlight{ color: var(--text); font-weight: 800; }
    .mobileWelcome .kpi{ color: var(--text); font-weight: 900; }
    .mobileStatsLink{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      align-self:flex-start;
      border:none;
      border-radius: 999px;
      padding: 10px 14px;
      background: rgba(10,132,255,.12);
      color: #0a84ff;
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .01em;
      box-shadow: 0 10px 18px rgba(10,132,255,.16);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .16s ease;
    }
    .mobileStatsLink:active{ transform: translateY(1px); box-shadow: 0 8px 16px rgba(10,132,255,.14); }
    .mobileStatsLink:focus-visible{ outline:2px solid rgba(10,132,255,.28); outline-offset:2px; }
    @media (max-width: 820px){
      body.role-operator #desktopSummaryCard,
      body.role-operator .adminPanel,
      body.role-operator #notifAdminBox,
      body.role-operator .adminOnly,
      body.role-operator [data-tab="admin"],
      body.role-operator .tab-admin{
        display:none !important;
      }
    }
    @media (max-width: 820px){
      body.role-admin .adminMobileHeader{ display:flex; }
      body.role-admin .adminMobileStack{ gap:14px; }
      body.role-admin #mobileSendCard{
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      body.role-admin #mobileSendCard .mobileSendShell{
        display:flex;
        flex-direction:column;
        gap:12px;
      }
      body.role-admin #mobileSendCard .mobileSendTopbar{
        flex-direction:column;
        align-items:flex-start;
        gap:10px;
      }
      body.role-admin #mobileSendCard .mobileSendToolbar{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      body.role-admin #mobileSendCard .mobileSendToolbarBtns{
        width:100%;
        justify-content:stretch;
        gap:8px;
      }
      body.role-admin #mobileSendCard .mobileSendToolbarBtns .btn{
        width:100%;
      }
      body.role-admin #mobileSendCard .microActions{
        justify-content:flex-start;
      }
      body.role-admin #mobileSendCard .mobileSendBody,
      body.role-admin #mobileSendCard .mobileSendListPane{
        max-height: none;
      }
    }
    @media (max-width: 720px){
      header.headerRow { gap:10px; padding-top: calc(6px + var(--safe-top)); min-height: 64px; }
      .title { flex-direction:column; align-items:flex-start; text-align:left; width:auto; }
      .titleWrap{ width:auto; text-align:left; align-items:flex-start; }
      .subtitle{ text-align:left; }
      .statusRow { gap:6px; }
    }
    @media (max-width: 640px){
      header.headerRow{
        display:flex;
        align-items:center;
        justify-content:space-between;
        flex-wrap: nowrap;
        gap: 10px;
        padding: calc(8px + var(--safe-top) * 0.5) 0 8px;
        min-height: 56px;
        width:100%;
      }
      .wrap{
        padding: calc(12px + var(--safe-top)) 14px calc(22px + var(--safe-bot));
      }
      .brand {
        gap:10px;
        min-width: 0;
        flex: 1 1 auto;
        align-items:center;
      }
      .brandLogo {
        width:48px;
        height:48px;
        border-radius:0 !important;
        transform: none;
        object-fit: contain;
        flex: 0 0 auto;
      }
      .titleWrap{
        min-width:0;
        overflow:hidden;
        gap: 2px;
      }
      .title{
        font-size: 32px;
        line-height: 0.95;
      }
      .title .titleLine{ overflow-wrap: anywhere; }
      .subtitle{ display:none; }
      .statusRow {
        flex: 0 0 auto;
        display:flex;
        align-items:center;
        justify-content:flex-end;
        flex-wrap: nowrap;
        gap:8px;
        padding: 0;
        min-width: 0;
        width:auto;
      }
      .mobileWelcomeWrap{ display:flex; flex-direction:column; }
      .statusRow .pill,
      .statusRow .pillQuiet,
      .statusRow #pillPush,
      .statusRow #pillSync,
      .statusRow #pillOnline,
      #headerTicker,
      .headerTicker,
      .headerMarquee,
      .refreshText{
        display:none !important;
      }
      .kv{ grid-template-columns: 1fr; }
      .row2{ grid-template-columns: 1fr; }
      .deskRowOpsSend{ display:block; }
      #completedCard .bd,
      #statsProdCard .bd{ max-height:none; overflow:visible; }
      #btnHeaderRefresh.iconBtn{
        width:44px;
        height:44px;
        min-width:44px;
        min-height:44px;
        border-radius: 14px;
      }
    }

    /* iPad */
    @media (min-width: 641px) and (max-width: 1024px){
      .wrap{
        padding: calc(14px + var(--safe-top) + var(--banner-offset)) 18px calc(24px + var(--safe-bot));
      }
      header.headerRow{
        gap: 14px;
        min-height: 68px;
        align-items:center;
      }
      .brandLogo{ width: 72px; height: 72px; transform: translateY(-2px); }
      .title{ font-size: 38px; line-height: 0.9; }
      .subtitle{ font-size: 13px; line-height: 1.2; }
      .mobileWelcomeWrap{ display:flex; flex-direction:column; }
      .statusRow{ gap: 8px; }
      #headerTicker,
      .headerTicker,
      .headerMarquee{ display:none !important; }
      .deskRowOpsSend{ display:block; }
      .kv{ grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    }

    /* Desktop */
    @media (min-width: 1025px){
      .wrap{
        padding: calc(14px + var(--safe-top) + var(--banner-offset)) 18px calc(26px + var(--safe-bot));
      }
      header.headerRow{
        gap: 14px;
        min-height: 74px;
      }
      #completedCard .bd,
      #statsProdCard .bd{
        max-height: none;
        overflow: visible;
      }
    }
    @media (min-width: 1025px){
      body.desktopAsMobile .wrap{
        max-width: 820px;
        margin: 0 auto;
        padding-left: 16px;
        padding-right: 16px;
        display: block;
      }
      body.desktopAsMobile .headerRow{
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
      body.desktopAsMobile .grid,
      body.desktopAsMobile .homeWrapOrMainContainer{
        display: flex !important;
        flex-direction: column;
        gap: 12px;
      }
      body.desktopAsMobile .grid > *,
      body.desktopAsMobile .homeWrapOrMainContainer > *,
      body.desktopAsMobile .sideStack > *,
      body.desktopAsMobile .deskRowOpsSend > *{
        width: 100%;
        max-width: 100%;
      }
      body.desktopAsMobile .sideStack{
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }
      body.desktopAsMobile .deskRowOpsSend{
        display: flex !important;
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }
      body.desktopAsMobile .row2{
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      body.desktopAsMobile .homeWrapOrMainContainer,
      body.desktopAsMobile .grid{
        align-items: stretch;
      }
      body.desktopAsMobile .homeWrapOrMainContainer > *{
        flex: 0 0 auto;
      }
      body.desktopAsMobile.adminDeskLayout .homeWrapOrMainContainer{
        display: flex !important;
        grid-template-columns: none;
      }
    }

    .statusRow {
      display:flex;
      flex-wrap:nowrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      width:auto;
      flex: 0 0 auto;
      min-width: 0;
      padding: 2px 0;
      min-height:44px;
    }
    .pill {
      padding: 7px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
      flex: 0 1 auto;
      min-width:0;
    }
    .pill span:last-child{ overflow:hidden; text-overflow:ellipsis; }
    .iconBtn{
      position: relative;
      width: 36px;
      height: 36px;
      min-width: 36px;
      min-height: 36px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.86);
      font-size: 18px;
      font-weight: 900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .14s cubic-bezier(.22,.61,.36,1), opacity .14s ease, box-shadow .16s ease;
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
    }
    .iconBtn:active{ transform: scale(.98); opacity:.92; box-shadow: 0 8px 16px rgba(0,0,0,.06); }
    .iconBtn:focus-visible{ outline:2px solid rgba(10,132,255,.25); outline-offset:2px; }
    .iconBtn .icon{ display:inline-flex; align-items:center; justify-content:center; line-height:1; }
    .iconBtn.isSpinning .icon{ animation: spin .85s ease-in-out; }
    .iconBtn .errBadge{
      position: absolute;
      top: -6px;
      right: -6px;
      padding: 4px 6px;
      border-radius: 12px;
      background: #ff3b30;
      color: #fff;
      font-size: 10px;
      font-weight: 900;
      box-shadow: 0 6px 14px rgba(255,59,48,.32);
      display:none;
      white-space: nowrap;
    }
    .iconBtn.hasError .errBadge{ display:inline-flex; }
    @media (max-width: 720px){
      .iconBtn{ width: 44px; height: 44px; min-width:44px; min-height:44px; }
    }
    @media (prefers-reduced-motion: reduce){
      .iconBtn{ transition: none; }
      .iconBtn.isSpinning .icon{ animation:none; }
    }
  .pillBadge{
      display:none;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      background: var(--bad);
      color: #fff;
      font-weight: 900;
      font-size: 11px;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    .dot {
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
    }
    .dot.ok { background: var(--good); }
    .dot.warn { background: var(--warn); }
    .dot.bad { background: var(--bad); }
    .pillQuiet{
      background: rgba(0,0,0,.04);
      border-color: rgba(0,0,0,.08);
      color: var(--muted);
      padding: 6px 9px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .grid > *{ min-width:0; }

    .homeWrapOrMainContainer{ width:100%; }

    .desktopShell{
      display:grid;
      grid-template-columns: 1fr;
      align-items:start;
      gap: 16px;
    }

    .desktopCol{
      display:flex;
      flex-direction:column;
      gap:16px;
      min-width:0;
    }

    /* Assicura che "Ordini conclusi" e "Gestione magazzino" restino nello stesso flow con spaziatura coerente */
    .mainCol{
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:stretch;
    }
    .mainCol > #completedCard,
    .mainCol > #warehouseCard{
      position: relative;
      display:flex;
      flex-direction:column;
      min-width:0;
      z-index: auto;
    }
    .mainCol > #warehouseCard{ margin-top: 8px; }
    @media (min-width: 900px){
      .mainCol{ gap:16px; }
      .mainCol > #warehouseCard{ margin-top: 10px; }
    }

    @media (min-width: 900px){
      .desktopShell{
        grid-template-columns: minmax(520px, 1fr) minmax(440px, 0.9fr);
        gap: 18px;
      }
    }

    @media (min-width: 1025px){
      .title { font-size: 46px; }
      #opsCard,
      #warehouseCard{
        min-height: clamp(360px, 52vh, 640px);
        display:flex;
        flex-direction:column;
      }
      #warehouseCard .bd{
        flex:1;
      }
    }

    @media (min-width: 1025px){
      body.adminDeskLayout .homeWrapOrMainContainer {
        display:grid;
        grid-template-columns: minmax(560px, 44%) 1fr;
        gap: 14px;
        align-items:start;
      }
      body.adminDeskLayout .homeWrapOrMainContainer > *{ min-width:0; }
      body.adminDeskLayout #mobileSendCard{
        display:flex;
        flex-direction:column;
      }
      body.adminDeskLayout #mobileSendList{
        flex:1;
        min-height:0;
        overflow-y:auto;
      }
    }
    @media (min-width: 1025px){
      body.adminDeskLayout #mobileSendCard{
        position: relative;
        z-index: 2;
        box-shadow: 0 18px 40px rgba(0,0,0,.12);
        border: 1px solid rgba(10,132,255,.12);
      }
    }
    @media (min-width: 1025px){
      body.adminDeskLayout #statsProdCard{
        position: relative;
        z-index: 1;
        opacity: 0.96;
        box-shadow: 0 12px 28px rgba(0,0,0,.08);
        max-height: clamp(320px, 48vh, 540px);
        display:flex;
        flex-direction:column;
      }
      body.adminDeskLayout #statsProdCard .bd{
        max-height: clamp(260px, 42vh, 480px);
      }
    }

    @media (min-width: 1025px){
      body.adminDeskLayout #warehouseCard{
        display:flex;
        flex-direction:column;
        min-height:0;
        max-height: 52vh;
      }
      body.adminDeskLayout #warehouseCard .hd{
        flex: 0 0 auto;
      }
      body.adminDeskLayout #warehouseCard .bd{
        display:flex;
        flex-direction:column;
        flex: 1 1 auto;
        min-height:0;
      }
      body.adminDeskLayout #warehouseBody{
        flex: 1 1 auto;
        min-height:0;
        overflow-y:auto;
        overscroll-behavior: contain;
      }
    }

    .card {
      border: 1px solid rgba(255,255,255,.8);
      background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
      backdrop-filter: blur(18px);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      box-sizing: border-box;
      min-width: 0;
    }
    /* Gestione magazzino: evita clipping e aumenta l'area utile */
    #warehouseCard{ overflow: visible; }
    #warehouseCard .bd{ overflow: visible; padding-bottom: 16px; }
    #warehouseBody{
      min-height: 280px;
      max-height: calc(100vh - 240px);
      overflow-x: visible;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .card .hd {
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(12,22,52,.06);
      min-width: 0;
    }
    .card .hd h2 {
      margin:0;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .02em;
      color: rgba(0,0,0,.88);
      text-transform: uppercase;
    }
    .card .bd {
      padding: 14px;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .heroCard .hd{
      padding: 18px 18px 12px;
      border-bottom: none;
      align-items:flex-start;
    }
    .heroCard .bd{
      padding: 4px 18px 18px;
      gap:14px;
    }
    .introCard{
      padding: 18px;
    }
    .introTop{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .introTop .introTitle{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.01em;
      color: rgba(12,16,26,.92);
    }
    .introTop .introLead{
      font-size: 14px;
      color: var(--muted);
      font-weight: 700;
    }
    .eyebrow{
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 900;
      font-size: 12px;
      color: rgba(12,16,26,.6);
    }
    .summaryGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .summaryTile{
      border: 1px solid rgba(12,22,52,.06);
      background: linear-gradient(145deg, rgba(255,255,255,.9), rgba(255,255,255,.82));
      border-radius: 16px;
      padding: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .summaryTile .t{
      font-weight: 900;
      letter-spacing: .01em;
      color: rgba(12,16,26,.74);
    }
    .summaryValue{
      font-size: 26px;
      font-weight: 900;
      letter-spacing: -0.01em;
      color: rgba(12,16,26,.92);
    }
    .summaryActions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 4px 0;
    }

    .primaryBtn {
      width:100%;
      border: none;
      border-radius: 20px;
      padding: 18px 18px;
      background: linear-gradient(180deg, rgba(46,123,255,1), rgba(18,105,245,.9));
      color: white;
      font-weight: 900;
      font-size: 19px;
      letter-spacing: .02em;
      box-shadow: 0 18px 36px rgba(46,123,255,.28);
      cursor:pointer;
      min-height: 56px;
      transition: transform .15s cubic-bezier(.22,.61,.36,1), box-shadow .18s ease, filter .18s ease;
    }
    .primaryBtn:active { transform: translateY(1.5px) scale(.995); box-shadow: 0 12px 22px rgba(46,123,255,.2); }
    .primaryBtn:focus-visible{ outline: 2px solid rgba(46,123,255,.35); outline-offset: 2px; }
    .warnBanner{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(255,149,0,.12);
      border:1px solid rgba(255,149,0,.28);
      transition: opacity .18s ease, transform .2s cubic-bezier(.22,.61,.36,1);
    }
    .warnBanner .icon{ font-size:20px; line-height:1; }
    .warnBanner .txt{ flex:1; min-width:0; }
    .warnBanner .txt .t{ font-weight: 900; color: rgba(0,0,0,.88); }
    .warnBanner .txt .s{ margin-top:2px; font-size:12px; color: rgba(0,0,0,.62); }
    .alertBanner{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.04);
      font-weight: 900;
      letter-spacing: .01em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
      transition: opacity .2s ease, transform .2s cubic-bezier(.22,.61,.36,1);
    }
    .alertBanner .label{ flex:1; min-width:0; word-break: break-word; }
    .alertBanner .hint{ font-size: 12px; color: rgba(0,0,0,.7); font-weight:800; }
    /* CODEX: banner sacchetto bianco */
    .whiteBagBanner{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:14px;
      flex-wrap:wrap;
      width:100%;
      padding:16px 16px;
      margin: 0;
      border-radius:18px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.35);
      color:#1c1c1e;
      font-weight: 900;
      letter-spacing: .01em;
      box-shadow: inset 0 1px 0 rgba(0,0,0,.04), 0 12px 26px rgba(0,0,0,.06);
      line-height: 1.25;
      pointer-events: auto; /* CODEX: il banner resta cliccabile per la selezione */
      word-break: break-word;
    }
    .whiteBagBanner .icon{ font-size:22px; }
    .whiteBagBanner .txt{ display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; }
    .whiteBagBanner .txt .t{ font-size:15px; letter-spacing:.02em; }
    .whiteBagBanner .txt .s{ font-size:13px; font-weight:800; opacity:.9; }
    .fadeCard{ opacity:0; transform: translateY(6px); }
    .fadeCard.show{ opacity:1; transform: translateY(0); }
    .planMessage{
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
      margin-bottom: 10px;
    }
    .planMessage .headline{ font-weight: 950; letter-spacing:.01em; }
    .planMessage ul{ margin: 10px 0 0 18px; color: var(--muted); font-weight:800; padding-left: 12px; }
    .planMessage li{ margin-bottom: 6px; }
    .miniBtn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,149,0,.88);
      color:white;
      font-weight: 900;
      letter-spacing:.01em;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(255,149,0,.22);
      white-space:nowrap;
    }
    .miniBtn:active{ transform: translateY(1px); }


    .row2 {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap:10px;
      min-width:0;
    }
    .btn {
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.88);
      padding: 14px 12px;
      border-radius: 16px;
      font-weight: 800;
      cursor:pointer;
      min-height: 44px;
    }
    .btn:hover { background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.12); }
    .btn:active { transform: translateY(1px); background: rgba(0,0,0,.08); border-color: rgba(0,0,0,.14); }
    .btn.good { background: rgba(32,201,151,.16); border-color: rgba(32,201,151,.35); }
    .btn.good:hover { background: rgba(32,201,151,.18); border-color: rgba(32,201,151,.38); }
    .btn.good:active { background: rgba(32,201,151,.20); border-color: rgba(32,201,151,.40); }
    .btn.isBusy{ pointer-events:none; opacity:.82; cursor:default; }
    .btn.isBusy .btnLabel{ display:inline-flex; align-items:center; justify-content:center; gap:10px; }
    .btn.isBusy .miniSpinner{
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,.14);
      border-top-color: rgba(0,0,0,.7);
      animation: spin .75s linear infinite;
      display:inline-block;
    }
    .btn.bad { background: rgba(255,77,79,.14); border-color: rgba(255,77,79,.35); }
    .btn.bad:hover { background: rgba(255,77,79,.16); border-color: rgba(255,77,79,.38); }
    .btn.bad:active { background: rgba(255,77,79,.18); border-color: rgba(255,77,79,.40); }
    .btn.ghost { background: transparent; border-color: var(--stroke); }
    .btn.ghost:hover { background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.10); }
    .btn.ghost:active { background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.12); }

    .bigStrip {
      border-radius: 18px;
      padding: 14px 14px;
      border: 1px solid rgba(12,128,60,.72);
      background: linear-gradient(120deg, #0f9f45, #0c8b3b 55%, #0a7331);
      position: relative;
      overflow:hidden;
      cursor:pointer;
      color: white;
      box-shadow: 0 18px 38px rgba(12,128,60,.36);
      transition: transform .12s ease, box-shadow .18s ease;
    }
    #prodStrip {
      background: rgba(24, 207, 23, 0.40);
      border-color: rgba(50, 232, 48, 0.65);
      border-width: 1.5px;
      box-shadow: 0 8px 20px rgba(24, 207, 23, 0.10);
      color: white;
    }
    .bigStrip:active{ transform: translateY(1px); box-shadow: 0 12px 24px rgba(12,128,60,.28); }
    .bigStrip .label {
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .06em;
      opacity:1;
    }
    .bigStrip .marquee {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
      padding-bottom: 2px;
    }
    .bigStrip .marquee span {
      display:inline-block;
      padding-left: 100%;
      animation: marquee 16s linear infinite;
    }
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .bigStrip .meta {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.94);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    @media (max-width: 640px) {
      #prodStrip {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-areas:
          "label count"
          "marquee marquee"
          "hint hint";
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 12px;
        gap: 6px 10px;
        overflow: hidden;
        border-radius: 18px;
        align-items: center;
        touch-action: manipulation;
      }
      #prodStrip .label {
        grid-area: label;
        margin: 0;
        min-width: 0;
        line-height: 1.2;
      }
      #prodStrip .marquee {
        grid-area: marquee;
        min-width: 0;
        max-width: 100%;
        width: 100%;
        margin-top: 0;
        overflow: hidden;
        white-space: nowrap;
        mask-image: linear-gradient(90deg, transparent 0%, rgba(0,0,0,.4) 3%, rgba(0,0,0,1) 12%, rgba(0,0,0,1) 88%, rgba(0,0,0,.4) 97%, transparent 100%);
        -webkit-mask-image: linear-gradient(90deg, transparent 0%, rgba(0,0,0,.4) 3%, rgba(0,0,0,1) 12%, rgba(0,0,0,1) 88%, rgba(0,0,0,.4) 97%, transparent 100%);
      }
      #prodStrip .marquee span {
        padding-left: 50%;
        min-width: 100%;
        will-change: transform;
      }
      #prodStrip .meta {
        grid-area: count;
        display: contents;
        margin-top: 0;
        gap: 0;
      }
      #prodStrip .metaCount {
        grid-area: count;
        justify-self: end;
        min-width: 0;
        line-height: 1.3;
      }
      #prodStrip .metaHint {
        grid-area: hint;
        min-width: 0;
        line-height: 1.3;
        opacity: .92;
      }
    }

    .kv {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      min-width:0;
    }
    .k {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .k .t { font-size: 12px; color: var(--muted); font-weight:700; }
    .k .v { margin-top: 4px; font-size: 18px; font-weight: 900; }

    .list {
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .item {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 12px;
      overflow-wrap:anywhere;
      min-width: 0;
    }
    .item .top {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .item .name {
      font-weight: 900;
      font-size: 16px;
      line-height:1.1;
      word-break:break-word;
    }
    .item .sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      word-break: break-word;
    }
    .notifList{ display:flex; flex-direction:column; gap:8px; }
    .notifItem{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
    }
    .notifItem.unread{ border-color: rgba(46,123,255,.38); box-shadow: 0 8px 18px rgba(46,123,255,.12); }
    .notifTitle{ font-weight: 950; font-size: 14px; letter-spacing:.01em; }
    .notifBody{ margin-top:6px; color: var(--muted); font-weight:800; font-size:13px; }
    .notifMeta{ margin-top:8px; font-size:11px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
    .notifEmpty{ color: var(--muted); font-weight:800; }
    .badge {
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      max-width:100%;
      min-width:0;
    }
    .pressCard{
      cursor:pointer;
      transition: transform .16s cubic-bezier(.18,.69,.25,1), box-shadow .18s ease, background .18s ease, opacity .18s ease;
      will-change: transform, opacity;
    }
    .pressCard:hover{ box-shadow: 0 14px 30px rgba(0,0,0,.12); }
    .pressCard:active{
      transform: scale(.99);
      box-shadow: 0 12px 32px rgba(0,0,0,.14);
    }
    .rowPress{
      cursor:pointer;
      transition: background .14s ease, transform .14s ease, box-shadow .16s ease;
    }
    .rowPress:hover{ background: rgba(0,0,0,.03); }
    .rowPress:active{ transform: translateY(1px); box-shadow: 0 10px 20px rgba(0,0,0,.08); }
    .ellipsis{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .rowsScroll{
      max-height: clamp(260px, 45vh, 560px);
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding-right: 2px;
    }
    @media (max-width: 899px){
      .rowsScroll{
        max-height: none;
      }
    }
    .rowsScroll::-webkit-scrollbar{ width: 10px; }
    .rowsScroll::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.12); border-radius: 999px; }
    .rowsScroll::-webkit-scrollbar-track{ background: transparent; }
    @media (prefers-reduced-motion: reduce){
      .rowPress{ transition: none; }
      .rowsScroll{ scroll-behavior: auto; }
    }
    .selectableLine{
      position: relative;
      overflow:hidden;
    }
    .selectableLine::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(46,123,255,.08), rgba(46,123,255,.04));
      opacity:0;
      transition: opacity .16s ease, transform .16s ease;
      z-index:0;
    }
    .selectableLine.selected{
      border-color: rgba(46,123,255,.35);
      box-shadow: 0 14px 30px rgba(46,123,255,.14);
      background: rgba(46,123,255,.08);
    }
    .selectableLine.selected::after{
      opacity:1;
    }
    .selectableLine .top,
    .selectableLine .whiteBagBanner{ position:relative; z-index:1; }
    .magGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 1180px){
      .magGrid{ grid-template-columns: 0.85fr 1.15fr; align-items:start; }
    }
    .magBox{
      border:1px solid rgba(0,0,0,.10);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.02);
    }
    .magTitle{
      font-weight: 900;
      font-size: 15px;
      margin: 0 0 8px;
      letter-spacing: .02em;
    }
    .magList{ display:flex; flex-direction:column; gap:8px; }
    .magRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.05);
    }
    .magRow .l{ font-weight:900; font-size:13px; color:rgba(0,0,0,.9); flex:1; min-width:0; }
    .magRow .s{ color:var(--muted); font-size:12px; margin-top:4px; }
    .magRow .v{ font-weight:1000; letter-spacing:.01em; white-space:nowrap; }
    .magPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      font-size:12px;
      font-weight:900;
      color:rgba(0,0,0,.82);
    }
    .magBadge{ background: rgba(0,0,0,.06); border-radius:12px; padding:3px 8px; font-size:11px; font-weight:900; }
    .magFilterBar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      margin: 2px 0 10px;
    }
    .magFilterField{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
      flex:1 1 180px;
    }
    .magFilterLabel{
      font-size:11px;
      font-weight:900;
      color: var(--muted);
      letter-spacing:.06em;
      text-transform: uppercase;
    }
    .magFilterInput{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: #fff;
      font-weight: 850;
      color: rgba(0,0,0,.86);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }
    .magFilterInput:focus-visible{ outline:2px solid rgba(10,132,255,.25); outline-offset:2px; }
    .magFilterActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
      min-width:0;
      flex-wrap:wrap;
    }
    .magResultBadge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(0,0,0,.05);
      border:1px solid var(--stroke);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .magFilterChips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 2px;
    }
    .magChip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(10,132,255,.10);
      border:1px solid rgba(10,132,255,.28);
      color: rgba(0,0,0,.88);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .magChip .x{
      font-weight:1000;
      opacity:.8;
      line-height:1;
    }
    @media (max-width: 1180px){
      .magFilterBar{ flex-direction:column; align-items:stretch; }
      .magFilterActions{ justify-content:flex-start; }
      .magFilterField{ flex:1 1 auto; }
    }
    .signaturePad{ touch-action: none; background:#fff; }
    .whOverview{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }
    .whKpiRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 4px 0 6px;
    }
    .whKpi{
      border:1px solid rgba(0,0,0,.08);
      background:linear-gradient(135deg, rgba(10,132,255,.08), rgba(10,132,255,.02));
      color: rgba(0,0,0,.86);
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .whKpi .v{ font-size:15px; letter-spacing:.01em; }
    .whOverviewRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 12px 24px rgba(0,0,0,.05);
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      width:100%;
      text-align:left;
    }
    .whOverviewRow:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(0,0,0,.08);
      border-color: rgba(10,132,255,.18);
    }
    .whOverviewRow:active{ transform: translateY(0); box-shadow: 0 10px 22px rgba(0,0,0,.07); }
    .whOverviewName{ font-weight:1000; font-size:14px; letter-spacing:.01em; color:rgba(0,0,0,.9); }
    .whOverviewSub{ font-size:12px; color:var(--muted); margin-top:4px; }
    .whOverviewVal{ font-weight:1000; font-size:15px; white-space:nowrap; }
    .whOverviewAll{
      background:none;
      border:none;
      color: var(--accent);
      font-weight:900;
      font-size:13px;
      padding:6px 6px 0;
      cursor:pointer;
      align-self:flex-start;
      text-decoration:underline;
    }
    #whDetails{ margin-top:12px; }
    .modal{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 99999;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(12px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s cubic-bezier(.22,.61,.36,1);
    }
    .modal.show{ opacity:1; pointer-events:auto; }
    .modal.hidden{ display:none; }
    .modalCard{
      background: rgba(255,255,255,.94);
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 26px 60px rgba(0,0,0,.18);
      width: min(820px, 100%);
      max-height: 80vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(8px);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 16px 12px;
      gap:12px;
      border-bottom:1px solid rgba(0,0,0,.05);
      background: rgba(255,255,255,.94);
      position:sticky;
      top:0;
      z-index:2;
    }
    .modalTitle{ font-size:15px; font-weight:1000; letter-spacing:.01em; }
    .modalSub{ font-size:12px; color:var(--muted); margin-top:4px; }
    .modalClose{
      border:none;
      background: rgba(0,0,0,.06);
      border-radius: 12px;
      width:36px; height:36px;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
    }
    .modalBody{
      padding: 14px 16px 18px;
      overflow:auto;
    }
    .whModalSection{
      margin-bottom:12px;
      padding:12px;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      background:#fff;
    }
    .whModalSection .tit{
      font-weight:900;
      font-size:13px;
      margin:0 0 8px;
      color: rgba(0,0,0,.88);
    }
    .whModalRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 6px;
      border-radius:10px;
      border:1px dashed rgba(0,0,0,.05);
      background: rgba(0,0,0,.02);
      margin-top:6px;
    }
    .whModalRow:first-of-type{ margin-top:0; }
    .whModalName{ font-weight:900; font-size:13px; color:rgba(0,0,0,.92); }
    .whModalSub{ font-size:12px; color:var(--muted); margin-top:4px; }
    .whModalVal{ font-weight:1000; white-space:nowrap; }
    @media (min-width:1025px){
      body.desktopV2 #warehouseCard #whDetails{ display:none !important; }
    }

    .blur {
      filter: blur(10px);
      opacity: .85;
      transition: filter .12s ease, opacity .12s ease;
    }
    .blur.reveal {
      filter: blur(0px);
      opacity: 1;
    }

    /* Modals */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      padding-bottom: calc(14px + var(--safe-bot));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .18s cubic-bezier(.22,.61,.36,1), visibility 0s linear .18s;
    }
    .overlay.show { opacity:1; visibility:visible; pointer-events:auto; transition-delay: 0s; }
    .sheet {
      width: min(980px, 100%);
      max-width: 100vw;
      max-height: 88vh;
      background: #ffffff;
      border: 1px solid var(--stroke);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-sizing: border-box;
      transform: translateY(10px) scale(.995);
      opacity: 0;
      transition: transform .22s cubic-bezier(.22,.61,.36,1), opacity .2s ease;
    }
    .overlay.show .sheet{
      transform: translateY(0) scale(1);
      opacity:1;
    }
    @media (prefers-reduced-motion: reduce){
      .overlay{ transition:none; }
      .sheet{ transition:none; transform:none !important; }
      .pressCard, .warnBanner, .alertBanner{ transition:none; }
    }
    .sheet .shd {
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
    }
    .sheet .shd .h {
      font-weight: 1000;
      letter-spacing: .02em;
      font-size: 14px;
      text-transform: uppercase;
      opacity: .9;
    }
    .sheet .shd .titleCol{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
      min-width:0;
      flex:1;
    }
    .selCounter{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(46,123,255,.38);
      background: rgba(46,123,255,.14);
      color:#0a3a7d;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .selCounter strong{ font-size:13px; }
    .sheet .shd .x {
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.86);
      font-size: 18px;
      font-weight: 900;
      cursor:pointer;
    }
    .sheet .sbd {
      padding: 14px;
      overflow:auto;
    }
    @media (max-width: 720px){
      .sheet{border-radius: 18px; max-height: 90vh;}
      .sheet .sbd{padding-bottom: calc(18px + var(--safe-bot));}
    }
    .stepTitle {
      font-size: 18px;
      font-weight: 950;
      margin: 0 0 10px;
    }
    .muted {
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .radioRow {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .radio {
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.03);
      cursor:pointer;
      font-weight: 900;
    }
    .radio:hover { background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.12); }
    .radio:active { background: rgba(0,0,0,.08); border-color: rgba(0,0,0,.14); }
    .radio input { accent-color: var(--accent); width:18px; height:18px; }
    .divider {
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bot));
      z-index: 10050;
      width: min(520px, calc(100% - 24px - env(safe-area-inset-left) - env(safe-area-inset-right)));
      max-width: calc(100% - 24px - env(safe-area-inset-left) - env(safe-area-inset-right));
      border: 1px solid var(--stroke);
      background: #ffffff;
      color: rgba(0,0,0,.90);
      border-radius: 18px;
      padding: 12px 14px;
      padding-left: max(14px, env(safe-area-inset-left));
      padding-right: max(14px, env(safe-area-inset-right));
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      display:none;
    }
    .toast.show { display:block; }
    .toast .tt { font-weight: 950; }
    .toast .tb { margin-top: 6px; color: var(--muted); font-weight: 700; font-size: 13px; }
    #toastTitle {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Startup legal screen */
    #startup {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
      background: radial-gradient(1000px 700px at 50% -20%, rgba(46,123,255,.35), rgba(46,123,255,0) 55%),
                  linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.45));
      backdrop-filter: blur(14px);
    }
    .startupCard {
      width: min(780px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .startupCard .a {
      padding: 18px 18px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: rgba(0,0,0,.90);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .startupCard .b {
      padding: 18px;
      color: rgba(0,0,0,.88);
      font-weight: 750;
      line-height: 1.35;
    }
    .bootBar {
      height: 10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 14px;
    }
    .bootBar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(46,123,255,1), rgba(32,201,151,1));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .bootMsg {
      margin-top: 10px;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }

    /* Prevent accidental iOS text zoom */
    input, textarea, select, button { font-size: 16px; }

    textarea {
      width:100%;
      min-height: 120px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.90);
      padding: 12px;
      font-weight: 700;
      resize: vertical;
    }
  
    /* Auth gate */
    #authGate{
      position: fixed;
      inset: 0;
      z-index: 10020;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
    }
    #authGate.show{ display:flex; }
    .authCard{
      width: min(720px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 24px 70px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .authLoader{
      position: fixed;
      top: calc(12px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10010;
      display: none;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.88);
      color: #ffffff;
      font-weight: 800;
      letter-spacing: -0.01em;
      box-shadow: 0 16px 44px rgba(0,0,0,.24);
      pointer-events: none;
    }
    .authLoader .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #34c759;
      box-shadow: 0 0 0 0 rgba(52,199,89,.4);
      animation: pulse 1.6s infinite;
    }
    .authLoader.show{ display:flex; }
    .authCard .ah{
      padding: 16px 16px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .authCard .ab{
      padding: 16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(0,0,0,.62);
      text-transform: uppercase;
      letter-spacing:.06em;
    }
    .field input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.02);
      font-size: 16px;
      font-weight: 800;
      outline: none;
    }
    .authRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .linkBtn{
      border:none;
      background: transparent;
      color: var(--accent);
      font-weight: 900;
      cursor:pointer;
      padding: 0;
    }
    body.noscroll{ overflow:hidden; }

  
    /* Completed orders */
    .completedItem{ cursor:pointer; }
    .completedItem:hover{ background: rgba(0,0,0,.05); }
    .completedMeta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; color: var(--muted); font-size:12px; }
    .kv{ font-variant-numeric: tabular-nums; }


  /* --- Push pill --- */
  .pillBtn{cursor:pointer;border:none}
  .pillBtn:active{transform:scale(.98)}
  .pillBtn:focus{outline:2px solid rgba(255,255,255,.18); outline-offset:2px}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(52,199,89,.35);}70%{box-shadow:0 0 0 10px rgba(52,199,89,0);}100%{box-shadow:0 0 0 0 rgba(52,199,89,0);}}

  /* Top system banners */
  .topBanner{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 80;
    display:none;
    align-items:center;
    gap:10px;
    padding: calc(10px + var(--safe-top)) 14px 12px;
    background: linear-gradient(180deg, rgba(255, 59, 48, .18), rgba(255, 59, 48, .08));
    border-bottom: 1px solid rgba(255,59,48,.28);
    box-shadow: 0 16px 30px rgba(0,0,0,.18);
  }
  .topBanner.show{ display:flex; }
  .topBanner .icon{ font-size: 20px; }
  .topBanner .body{ flex:1; min-width:0; }
  .topBanner .title{ font-weight: 900; font-size: 16px; }
  .topBanner .sub{ font-size: 13px; color: var(--muted); font-weight: 800; }
  .topBanner .closeBtn{
    border:none;
    border-radius: 14px;
    padding: 10px 12px;
    background: rgba(0,0,0,.06);
    font-weight: 900;
    cursor:pointer;
  }
  .chunkyList{ content-visibility: auto; contain-intrinsic-size: 800px 2000px; }
  @media (max-width: 640px){
    .hideOnMobile{ display:none !important; }
  }
  .adminMobileHeader{
    display:none;
    flex-direction:column;
    gap:2px;
    padding: 4px 2px 0;
  }
  .adminMobileHeader .adminMobileTitle{
    font-weight: 900;
    font-size: 18px;
    letter-spacing: -.01em;
  }
  .adminMobileHeader .adminMobileSub{
    font-size: 13px;
    color: var(--muted);
    font-weight: 800;
  }
  .adminMobileStack{
    display:flex;
    flex-direction:column;
    gap:16px;
    width:100%;
  }
    /* Invio ordini a mobile (admin) */
    .mobileAssignInfo{
      display:none;
      margin: 6px 0 12px;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,.82);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.82));
      box-shadow: 0 12px 26px rgba(15,23,42,.14);
      font-weight: 800;
      color: rgba(12,16,26,.82);
    }
    .adminPanel{
      border: 1px solid rgba(255,255,255,.78);
      border-radius: 20px;
      padding: 16px;
      background: linear-gradient(165deg, rgba(255,255,255,.96), rgba(247,249,252,.9));
      box-shadow: 0 16px 36px rgba(15,23,42,.15);
      margin-top: 0;
      min-width:0;
      backdrop-filter: blur(18px);
    }
    .adminPanel .panelHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      min-width:0;
      flex-wrap:wrap;
    }
    .adminPanel .panelTitle{
      font-weight: 900;
      letter-spacing:.02em;
      text-transform: uppercase;
      font-size: 13px;
    }
    .adminPanel .panelSub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-top:4px;
      min-width:0;
    }
    .adminPanel .statusBadge{
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.76);
      white-space: nowrap;
      min-width: 120px;
      text-align:center;
    }
    .adminPanel .statusBadge.live{ color: #0b5d2a; border-color: rgba(52,199,89,.4); background: rgba(52,199,89,.10); }
    .adminPanel .statusBadge.error{ color: #8a1f1a; border-color: rgba(255,59,48,.4); background: rgba(255,59,48,.14); }
    .adminList{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 6px 0 2px;
      min-width:0;
    }
    .adminSearch{
      width:100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: #fff;
      font-weight: 800;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.8);
    }
    .mobileSendRow{
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 14px;
      padding: 12px 12px;
      background: #fff;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease;
      min-width:0;
    }
    .mobileSendRow:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.06); }
    .mobileSendRow:active{ transform: translateY(0); opacity:.9; }
    .mobileSendRow.selected{
      border-color: rgba(10,132,255,.35);
      background: linear-gradient(180deg, rgba(10,132,255,.08), rgba(10,132,255,.03));
      box-shadow: 0 12px 24px rgba(10,132,255,.12);
    }
    .mobileSendRow .info{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .mobileSendRow .info .name{ font-weight: 900; }
    .mobileSendRow .info .meta{ font-size: 12px; color: var(--muted); font-weight:800; }
    .mobileSendToggle{
      position: relative;
      width: 48px;
      height: 28px;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      box-shadow: inset 0 1px 3px rgba(0,0,0,.14);
      transition: background .18s ease;
      flex: 0 0 auto;
    }
    .mobileSendToggle .knob{
      position:absolute;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      top:3px; left:3px;
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
      transition: transform .2s cubic-bezier(.22,.61,.36,1), background .18s ease;
    }
    .mobileSendRow.selected .mobileSendToggle{ background: linear-gradient(90deg, #0a84ff, #34c759); }
    .mobileSendRow.selected .mobileSendToggle .knob{ transform: translateX(20px); background: #fff; }
    .saveBadge{
      border:1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 900;
      background: rgba(0,0,0,.02);
      color: rgba(0,0,0,.78);
    }
    .saveBadge.live{ color:#0b5d2a; border-color: rgba(52,199,89,.35); background: rgba(52,199,89,.10); }
    .saveBadge.error{ color:#8a1f1a; border-color: rgba(255,59,48,.35); background: rgba(255,59,48,.14); }
    .mobileAssignInfo{
      display:none;
      margin: 6px 0 12px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 12px;
      background: rgba(0,0,0,.03);
      font-weight: 850;
      color: rgba(0,0,0,.72);
      font-size: 13px;
    }
    .switch{
      position: relative;
      display: inline-block;
      width: 46px;
      height: 26px;
    }
    .switch input{ display:none; }
    .switch .slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background: rgba(0,0,0,.12);
      border-radius: 999px;
      transition: .2s;
      box-shadow: inset 0 1px 3px rgba(0,0,0,.16);
    }
    .switch .slider:before{
      position:absolute;
      content:"";
      height:20px;
      width:20px;
      left:3px;
      top:3px;
      background:white;
      border-radius: 50%;
      box-shadow: 0 1px 4px rgba(0,0,0,.18);
      transition: .2s;
    }
    .switch input:checked + .slider{
      background: linear-gradient(90deg, #0a84ff, #34c759);
    }
    .switch input:checked + .slider:before{
      transform: translateX(20px);
    }
    @media (min-width: 1025px){
      body.adminDeskLayout #mobileSendCard{
        margin-top: 0;
        padding: 0;
        overflow: hidden;
        min-height: 0;
        max-height: calc(100vh - 110px);
        display:flex;
        flex-direction:column;
      }
      body.adminDeskLayout .mobileSendShell{
        display:flex;
        flex-direction:column;
        flex: 1 1 auto;
        min-height: 0;
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      }
      body.adminDeskLayout .mobileSendTopbar{
        position: sticky;
        top: 0;
        z-index: 2;
        flex: 0 0 auto;
        padding: 16px 18px 14px;
        border-bottom: 1px solid rgba(0,0,0,.05);
        background: rgba(255,255,255,.9);
        backdrop-filter: blur(18px);
      }
      body.adminDeskLayout .mobileSendHeader{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:16px;
        min-width:0;
        flex-wrap:wrap;
      }
      body.adminDeskLayout .mobileSendTitleCol{
        min-width:0;
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      body.adminDeskLayout .mobileStatsLine{
        display:flex;
        align-items:center;
        flex-wrap:wrap;
        gap:6px;
        font-size: 13px;
        color: var(--muted);
        font-weight: 800;
        font-variant-numeric: tabular-nums;
        letter-spacing: .01em;
        cursor: default;
      }
      body.adminDeskLayout .mobileStatsLine b{
        color: rgba(0,0,0,.90);
        font-weight: 900;
      }
      body.adminDeskLayout .mobileStatsLine .statSep{
        opacity: .6;
      }
      body.adminDeskLayout .mobileSendSubline{
        display:flex;
        gap:8px;
        align-items:center;
        flex-wrap:wrap;
      }
      body.adminDeskLayout .mobileSendStatus{
        display:flex;
        gap:10px;
        align-items:flex-start;
        flex-wrap:wrap;
        justify-content:flex-end;
        min-width:0;
      }
      body.adminDeskLayout .statusBadge{
        border-radius: 999px;
        padding: 7px 12px;
        border-color: rgba(0,0,0,.08);
        background: rgba(0,0,0,.03);
      }
      body.adminDeskLayout .saveBadge{
        border-radius: 999px;
        padding: 7px 12px;
        background: transparent;
        border-color: rgba(0,0,0,.06);
        font-weight: 850;
      }
      body.adminDeskLayout .mobileSendToolbar{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        margin-top: 12px;
        padding-top: 6px;
        border-top: 1px solid rgba(0,0,0,.04);
      }
      body.adminDeskLayout .mobileSendToolbar .adminSearch{
        flex:1 1 320px;
        min-width: 0;
      }
      body.adminDeskLayout .mobileSendToolbarBtns{
        display:flex;
        gap:8px;
        align-items:center;
        flex: 0 0 auto;
      }
      body.adminDeskLayout .btn.actionPrimary,
      body.adminDeskLayout .btn.actionGhost{
        border-radius: 12px;
        min-height: 42px;
        padding: 12px 16px;
        font-weight: 900;
        letter-spacing: .01em;
        box-shadow: none;
      }
      body.adminDeskLayout .btn.actionPrimary{
        background: #0a84ff;
        color: #fff;
        border-color: #0a84ff;
      }
      body.adminDeskLayout .btn.actionPrimary:hover{ background: #086fd4; border-color: #086fd4; }
      body.adminDeskLayout .btn.actionGhost{
        background: transparent;
        border-color: rgba(0,0,0,.14);
      }
      body.adminDeskLayout .btn.actionGhost:hover{ background: rgba(0,0,0,.04); }
      body.adminDeskLayout .microActions{
        display:flex;
        align-items:center;
        gap:6px;
        flex-wrap:wrap;
        margin-left: auto;
        color: var(--muted);
        font-weight: 800;
        font-size: 13px;
      }
      body.adminDeskLayout .microActions .textAction{
        border:none;
        background: transparent;
        padding: 6px 0;
        color: rgba(0,0,0,.72);
        font-weight: 850;
        cursor:pointer;
      }
      body.adminDeskLayout .microActions .textAction:hover{ color: rgba(0,0,0,.9); text-decoration: underline; }
      body.adminDeskLayout .adminList{
        max-height: none;
      }
      body.adminDeskLayout .mobileSendBody{
        display:flex;
        flex-direction:column;
        gap:10px;
        padding: 12px 18px 16px;
        flex:1;
        min-height:0;
        box-sizing:border-box;
      }
      body.adminDeskLayout .mobileSendListPane{
        display:flex;
        flex-direction:column;
        min-width:0;
        background: transparent;
        border-radius: 0;
        border: none;
        box-shadow: none;
        padding: 0;
        gap:12px;
        height:100%;
        min-height: 0;
      }
      body.adminDeskLayout .mobileSendListPane .listHead{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
        padding: 4px 0;
        border-bottom: 1px solid rgba(0,0,0,.05);
      }
      body.adminDeskLayout .mobileSendListPane .listHead .panelSub{
        margin:0;
      }
      body.adminDeskLayout .mobileSendListPane .adminList{
        flex:1 1 auto;
        min-height: 0;
        overflow-y:auto;
        overscroll-behavior: contain;
        padding: 2px 0 6px;
      }
      body.adminDeskLayout #mobileSendList{
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto !important;
        overscroll-behavior: contain;
        border-top: 1px solid rgba(0,0,0,.04);
        border-bottom: 1px solid rgba(0,0,0,.04);
      }
      body.adminDeskLayout .mobileSendRow{
        border: none;
        border-radius: 0;
        padding: 12px 4px;
        background: transparent;
        box-shadow: none;
        position: relative;
      }
      body.adminDeskLayout .mobileSendRow + .mobileSendRow{
        border-top: 1px solid rgba(0,0,0,.06);
      }
      body.adminDeskLayout .mobileSendRow:hover{
        background: rgba(0,0,0,.02);
        box-shadow: none;
        transform: none;
      }
      body.adminDeskLayout .mobileSendRow:active{
        transform: translateY(0);
        opacity: .95;
      }
      body.adminDeskLayout .mobileSendRow.selected{
        background: linear-gradient(180deg, rgba(10,132,255,.08), rgba(10,132,255,.03));
        border-top-color: rgba(10,132,255,.18);
        border-bottom: 1px solid rgba(10,132,255,.14);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      }
      body.adminDeskLayout .mobileSendRow .info .name{
        font-weight: 900;
        letter-spacing: -.01em;
      }
      body.adminDeskLayout .mobileSendRow .info .meta{
        color: rgba(0,0,0,.55);
      }
      body.adminDeskLayout .mobileSendToggle{
        box-shadow: inset 0 1px 2px rgba(0,0,0,.12);
      }
      body.adminDeskLayout .mobileSendListPane .panelSub{
        color: rgba(0,0,0,.6);
        font-weight: 850;
      }
    }

    /* Desktop: garantisce scroll lista invio ordini mobile */
    @media (min-width: 1025px){
      body.adminDeskLayout #mobileSendCard{
        display:flex;
        flex-direction:column;
        min-height:0;
        max-height: calc(100vh - 120px);
      }

      body.adminDeskLayout #mobileSendCard .mobileSendBody,
      body.adminDeskLayout #mobileSendCard .panelBody,
      body.adminDeskLayout #mobileSendCard .cardBody{
        min-height:0;
        flex: 1 1 auto;
        display:flex;
        flex-direction:column;
      }

      body.adminDeskLayout #mobileSendList{
        flex: 1 1 auto;
        min-height:0;
        overflow-y:auto !important;
        overflow-x:hidden !important;
        overscroll-behavior:contain;
        -webkit-overflow-scrolling:touch;
      }
    }

    /* ADMIN DESKTOP KIOSK */
    body.kioskAdmin{
      background: radial-gradient(1400px 1200px at 50% -10%, rgba(46,123,255,.08), rgba(46,123,255,0) 52%), linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    }
    body.kioskAdmin .wrap{
      max-width: 1820px;
      width: min(96vw, 1820px);
      padding: calc(12px + var(--safe-top) + var(--banner-offset)) 22px calc(28px + var(--safe-bot));
    }
    @media (min-aspect-ratio: 16/9){
      body.kioskAdmin .wrap{
        max-width: 1880px;
        padding-left: 26px;
        padding-right: 26px;
      }
    }
    body.kioskAdmin .headerRow{
      padding: calc(8px + var(--safe-top) * 0.25) 0 12px;
      margin-bottom: 10px;
      min-height: 68px;
      gap: 16px;
    }
    body.kioskAdmin .brand{ gap: 14px; }
    body.kioskAdmin .brandLogo{ width: 76px; height: 76px; transform: translateY(-2px); }
    body.kioskAdmin .title{ font-size: 44px; line-height: .9; }
    body.kioskAdmin .subtitle{ max-width: 780px; line-height: 1.3; }
    body.kioskAdmin .statusRow{ gap: 10px; padding: 0; }
    body.kioskAdmin .pill{ padding: 6px 10px; }
    body.kioskAdmin .iconBtn{ box-shadow: 0 10px 24px rgba(0,0,0,.08); }
    body.kioskAdmin .grid{
      grid-template-columns: minmax(420px, 540px) minmax(0, 1fr);
      gap: 16px;
      align-items: start;
    }
    @media (min-width: 1600px){
      body.kioskAdmin .grid{
        grid-template-columns: minmax(460px, 640px) minmax(0, 1fr);
      }
    }
    body.kioskAdmin .grid > *{ min-width: 0; }
    body.kioskAdmin #opsCard{ min-height: 620px; }
    body.kioskAdmin .card{
      border-radius: 20px;
      box-shadow: 0 14px 34px rgba(0,0,0,.10);
    }
    body.kioskAdmin .card .hd{
      padding: 16px 16px 12px;
    }
    body.kioskAdmin .card .bd{ padding: 16px; }
    body.kioskAdmin .primaryBtn{ padding: 20px 20px; }
    body.kioskAdmin .kv{ font-variant-numeric: tabular-nums; }
    body.kioskAdmin .k{ padding: 12px 14px; }
    body.kioskAdmin .k .t{ color: rgba(0,0,0,.58); }
    body.kioskAdmin .k .v{ font-variant-numeric: tabular-nums; letter-spacing: -0.01em; }
    body.kioskAdmin .badge,
    body.kioskAdmin .pill{ font-variant-numeric: tabular-nums; }
    body.kioskAdmin .list{ gap: 10px; }
    body.kioskAdmin .item{
      padding: 12px 14px;
      border-color: rgba(0,0,0,.08);
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
    }
    body.kioskAdmin .item .top{ align-items: center; }
    body.kioskAdmin .completedMeta{ gap: 10px; row-gap: 4px; }
    body.kioskAdmin #completedCard,
    body.kioskAdmin #statsProdCard{
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    body.kioskAdmin #completedCard .bd,
    body.kioskAdmin #statsProdCard .bd{
      max-height: none;
      overflow: visible;
    }
    body.kioskAdmin #completedCard .hd,
    body.kioskAdmin #statsProdCard .hd{
      position: sticky;
      top: 0;
      background: inherit;
      z-index: 2;
    }
    body.kioskAdmin #completedList,
    body.kioskAdmin #statsList{ min-width: 0; }
    body.kioskAdmin .row2{ gap: 12px; }
    @media (min-aspect-ratio: 16/9){
      body.kioskAdmin .headerRow{ margin-bottom: 8px; }
      body.kioskAdmin .grid{ gap: 18px; }
      body.kioskAdmin #completedCard .bd,
      body.kioskAdmin #statsProdCard .bd{ max-height: clamp(360px, 52vh, 620px); }
    }

    /* Desktop v2: layout + scroll containment */
    @media (min-width: 1025px){
      body.desktopV2 .wrap{
        width: 100%;
        max-width: 1920px;
        margin: 0 auto;
        padding: calc(14px + var(--safe-top) + var(--banner-offset)) 18px calc(26px + var(--safe-bot));
        box-sizing: border-box;
      }

      body.desktopV2 #mobileSendCard,
      body.desktopV2 #warehouseCard,
      body.desktopV2 #completedCard{
        display:flex;
        flex-direction:column;
        min-height:0;
      }

      body.desktopV2 #mobileSendCard .mobileSendBody,
      body.desktopV2 #mobileSendCard .mobileSendListPane,
      body.desktopV2 #warehouseCard .bd,
      body.desktopV2 #completedCard .bd{
        display:flex;
        flex-direction:column;
        flex: 1 1 auto;
        min-height:0;
      }

      body.desktopV2 #mobileSendList,
      body.desktopV2 #warehouseBody,
      body.desktopV2 #completedBody{
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
    }


    /* ===== DESKTOP polish (non tocca mobile) ===== */
    @media (min-width: 1025px){
      /* Desktop pi equilibrato (stile iPad a 2 colonne) */
      body.desktopV2 .desktopShell{
        grid-template-columns: minmax(560px, 1.05fr) minmax(460px, 0.95fr);
        gap: 14px;
      }

      /* Admin: rimuove la card di riepilogo (lascia spazio a Invio ordini) */
      body.adminDeskLayout #desktopSummaryCard{
        display:none !important;
      }

      /* Admin: "Invio ordini a mobile" con altezza corretta e scroll interno affidabile */
      body.adminDeskLayout #mobileSendCard{
        max-height: calc(100vh - var(--hdrH, 76px) - 18px) !important;
      }

      /* Statistiche: piccole e in secondo piano */
    body.adminDeskLayout #statsProdCard.miniCard{
      opacity: 0.90;
    }
    body.adminDeskLayout #statsProdCard.miniCard .hd{ padding: 10px 12px; }
    body.adminDeskLayout #statsProdCard.miniCard .bd{ padding: 10px 12px; }
    body.adminDeskLayout #statsProdCard.miniCard h2{ font-size: 16px; }
    body.adminDeskLayout #statsProdCard.miniCard .bd > .muted:first-child{ display:none; }
    body.adminDeskLayout #statsProdCard.miniCard #statsBody{ max-height: 200px !important; }

    /* Operator leaderboard */
    #operatorLeaderboard{ margin: 0 0 14px 0; }
    .opLbCard{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.94));
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.04);
    }
    .opLbHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .opLbTitle{ font-weight:900; font-size:15px; }
    .opLbMeta{ color: var(--muted); font-weight:800; font-size: 12px; }
    .opLbToggles{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .opLbToggleBtn{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.02);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: var(--muted);
      cursor:pointer;
      transition: all .14s ease;
    }
    .opLbToggleBtn.active{
      color: #0a84ff;
      background: rgba(10,132,255,.12);
      border-color: rgba(10,132,255,.28);
      box-shadow: 0 8px 20px rgba(10,132,255,.12);
    }
    .opLbToggleBtn:focus-visible{
      outline: 2px solid rgba(10,132,255,.32);
      outline-offset: 2px;
    }
    .opLbList{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .opLbRow{
      display:grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: var(--card2);
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }
    .opLbRank{
      min-width: 38px;
      height: 38px;
      border-radius: 12px;
      background: rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: var(--text);
    }
    .opLbName{ font-weight: 900; font-size: 14px; }
    .opLbSub{ color: var(--muted); font-size: 12px; font-weight: 800; }
    .opLbMetrics{
      display:flex;
      align-items:center;
      gap: 12px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .opLbMetric{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
      font-weight: 900;
    }
    .opLbMetric .lbl{ color: var(--muted); font-size: 12px; font-weight: 800; }
    .opLbMetric .val{ font-variant-numeric: tabular-nums; font-size: 15px; }
    .opLbRow.top1{ border-color: rgba(52,199,89,.26); background: linear-gradient(180deg, rgba(52,199,89,.12), rgba(52,199,89,.08)); }
    .opLbRow.top2{ border-color: rgba(10,132,255,.22); }
    .opLbRow.top3{ border-color: rgba(255,159,10,.22); }
    .opLbEmpty{
      padding: 8px;
      color: var(--muted);
      font-weight: 800;
    }
    @media (max-width: 800px){
      .opLbRow{
        grid-template-columns: auto 1fr;
        grid-template-areas:
          "rank name"
          "metrics metrics";
      }
      .opLbRank{ grid-area: rank; }
      .opLbName{ grid-area: name; }
      .opLbSub{ grid-column: 2 / -1; }
      .opLbMetrics{
        grid-area: metrics;
        justify-content:flex-start;
        gap: 16px;
        padding-left: 4px;
      }
      .opLbMetric{ align-items:flex-start; }
      .opLbMetric .val{ font-size: 14px; }
    }
    @media (max-width: 520px){
      .opLbRow{
        padding: 10px;
        border-radius: 12px;
      }
      .opLbCard{ padding: 10px; }
      .opLbToggleBtn{ padding: 7px 10px; }
      .opLbMetrics{ gap: 12px; }
    }
    }


    /* ===============================
       PATCH v2 (Desktop scroll + iPad header + Magazzino layout)
       - Desktop: scroll interno affidabile su "Invio ordini a mobile"
       - iPad: header meno "schiacciato"
       - Magazzino: solo panoramica in-card, dettagli via modale
       =============================== */

    @media (min-width: 1025px){
      /* Forza un'altezza definita al pannello, cos la lista interna pu scrollare */
      body.adminDeskLayout #mobileSendCard{
        height: calc(100vh - var(--hdrH, 74px) - 18px) !important;
        max-height: none !important;
      }
      body.adminDeskLayout #mobileSendCard .mobileSendShell{
        height: 100%;
        min-height: 0;
        display:flex;
        flex-direction:column;
      }
      body.adminDeskLayout #mobileSendCard .mobileSendTopbar{ flex: 0 0 auto; }
      body.adminDeskLayout #mobileSendCard .mobileSendBody{
        flex: 1 1 auto;
        min-height: 0;
      }
      body.adminDeskLayout #mobileSendCard .mobileSendListPane{
        flex: 1 1 auto;
        min-height: 0;
      }
      body.adminDeskLayout #mobileSendList{
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        scrollbar-gutter: stable;
      }

      /* Magazzino: impaginazione pi pulita (in-card overview) */
      #warehouseCard .magSimple{
        display:flex;
        flex-direction:column;
        gap:10px;
      }
      #warehouseCard .whCritRow{
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin: 2px 0 2px;
      }
      #warehouseCard .whKpiRow{
        display:grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap:10px;
        margin: 4px 0 4px;
      }
      #warehouseCard .whKpi{ min-width:0; }
      #warehouseCard .whActions{
        margin-top: 8px;
      }
    }

    /* iPad/tablet: header pi arioso (senza cambiare struttura) */
    @media (min-width: 768px) and (max-width: 1024px){
      header.headerRow{
        min-height: 76px;
        align-items:center;
      }
      .brandLogo{
        width: 64px;
        height: 64px;
        transform: none;
      }
      .title{
        line-height: 1.05;
      }
      .subtitle{
        line-height: 1.25;
      }
    }


/* ===============================
   PATCH v5 (Desktop): FIX sovrapposizioni + contenimento righe Statistiche
   - Ripristina colonne: mainCol a sinistra, sideCol a destra (annulla patch precedenti)
   - Elimina overflow "visible" e sticky aggressivi che fanno coprire le card
   - Forza scroll interno dentro Ordini conclusi e Statistiche (niente righe che escono)
   (Solo UI/CSS  NON tocca logiche Google/Firebase)
   =============================== */

@media (min-width: 900px){
  /* Ripristino struttura: 2 colonne con i due wrapper (no display:contents) */
  .desktopShell{ display:grid !important; }
  .desktopShell > .mainCol{ display:flex !important; grid-column:1 !important; grid-row:auto !important; }
  .desktopShell > .sideCol{ display:flex !important; grid-column:2 !important; grid-row:auto !important; }

  /* Annulla eventuali posizionamenti forzati su singole card */
  #opsCard, #completedCard, #warehouseCard, #statsProdCard{
    grid-column: auto !important;
    grid-row: auto !important;
  }

  /* Evita che una card "sbordi" sopra l'altra */
  #completedCard, #statsProdCard{
    position: relative !important;
    z-index: 0 !important;
    isolation: isolate;
    overflow: hidden !important;
    max-width: 100% !important;
  }

  /* Header NON deve coprire altre card (sticky solo dentro la card, z-index basso) */
  #completedCard .hd,
  #statsProdCard .hd{
    position: sticky !important;
    top: 0 !important;
    z-index: 1 !important;
    background: inherit !important;
  }

  /* IMPORTANTISSIMO: niente overflow visible nei body (causa righe che escono e overlay) */
  #completedCard .bd,
  #statsProdCard .bd{
    overflow: hidden !important;
    max-height: none !important;
    min-height: 0 !important;
  }

  /* Scroll interno: contiene le liste e impedisce che escano dal riquadro */
  #completedBody,
  #statsBody{
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    max-height: clamp(320px, 46vh, 620px) !important;
    min-height: 0 !important;
  }

  /* Contenimento orizzontale: nessun elemento pu "allargare" la card */
  #operatorLeaderboard,
  #statsList,
  #completedList{
    min-width: 0 !important;
    max-width: 100% !important;
  }
  #statsList .item,
  #completedList .item{
    max-width: 100% !important;
    overflow: hidden;
  }
  #statsList .item *,
  #completedList .item *{
    min-width: 0 !important;
  }
}

/* Override esplicito per modalit kioskAdmin (nel file c' overflow: visible) */
@media (min-width: 900px){
  body.kioskAdmin #completedCard .bd,
  body.kioskAdmin #statsProdCard .bd{
    overflow: hidden !important;
    max-height: none !important;
  }
  body.kioskAdmin #completedCard .hd,
  body.kioskAdmin #statsProdCard .hd{
    z-index: 1 !important;
  }
}


/* ===============================
   PATCH v6 (Desktop): Gestione magazzino NON deve uscire dalla card
   - Rimuove overflow: visible che fa "sbordare" le righe
   - Forza scroll interno nel body del magazzino
   (Solo UI/CSS  NON tocca logiche Google/Firebase)
   =============================== */
@media (min-width: 900px){
  #warehouseCard{
    overflow: hidden !important;
    position: relative;
    z-index: 0;
    display:flex;
    flex-direction:column;
    min-height:0;
    isolation: isolate;
  }
  #warehouseCard .bd{
    overflow: hidden !important;
    display:flex;
    flex-direction:column;
    flex: 1 1 auto;
    min-height:0;
    padding-bottom: 14px !important;
  }
  #warehouseBody{
    flex: 1 1 auto;
    min-height:0 !important;
    max-height: clamp(300px, 48vh, 720px) !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }

  /* Difesa extra: niente stringhe che allargano/sfondano */
  #warehouseBody, #warehouseBody *{
    max-width: 100%;
    min-width: 0;
  }
  #warehouseBody{
    word-break: break-word;
    overflow-wrap: anywhere;
  }
}

/* Override esplicito per modalit kioskAdmin/desktopV2 (nel file esiste overflow: visible) */
@media (min-width: 900px){
  body.kioskAdmin #warehouseCard,
  body.desktopV2 #warehouseCard{
    overflow: hidden !important;
  }
  body.kioskAdmin #warehouseCard .bd,
  body.desktopV2 #warehouseCard .bd{
    overflow: hidden !important;
  }
  body.kioskAdmin #warehouseBody,
  body.desktopV2 #warehouseBody{
    overflow-y: auto !important;
    overflow-x: hidden !important;
  }
}



/* PATCH: Operativit pi compatto su desktop (solo UI/CSS) */
@media (min-width: 1025px){
  /* stop alla min-height gigante */
  #opsCard{
    min-height: auto !important;
  }

  /* card pi bassa + scroll interno se il contenuto  tanto */
  #opsCard .bd{
    max-height: clamp(260px, 34vh, 460px) !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;

    /* un filo pi tight */
    padding: 4px 16px 14px !important;
    gap: 10px !important;
  }

  #opsCard .hd{
    padding: 14px 16px 10px !important;
  }

  /* mini-compact dei riquadrini interni (opzionale ma aiuta tanto) */
  #opsCard .kv{ gap: 8px !important; }
  #opsCard .k{
    padding: 8px 10px !important;
    border-radius: 14px !important;
  }
  #opsCard .k .v{ font-size: 16px !important; }

  /* bottone un pelo pi compatto */
  #opsCard .primaryBtn{
    padding: 12px 14px !important;
    font-size: 14px !important;
  }
}

</style>

  <link rel="manifest" href="/tabellone-produzione-live/manifest.webmanifest">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Hub Polveri">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
</head>
<body>
  <!-- Startup legal + boot -->
  <div id="startup">
    <div class="startupCard">
      <div class="a">Avviso aziendale</div>
      <div class="b">
        I dati visualizzati in questo sistema sono <b>riservati</b> e destinati esclusivamente alluso interno.<br/>
         vietata qualsiasi condivisione o diffusione non autorizzata al di fuori dellazienda.<br/>
        Eventuali violazioni potranno comportare <b>provvedimenti disciplinari</b> e <b>azioni legali</b> secondo quanto previsto dalle normative vigenti.
        <div class="bootBar"><div id="bootFill"></div></div>
        <div id="bootMsg" class="bootMsg">BOOT: inizializzazione</div>
      </div>
    </div>
  </div>

  <div id="authLoader" class="authLoader" role="status" aria-live="polite">
    <div class="dot" aria-hidden="true"></div>
    <div class="txt">Verifica accesso</div>
  </div>

  
  <!-- Auth gate -->
  <div id="authGate" role="dialog" aria-modal="true">
    <div class="authCard">
      <div class="ah">Accesso operatore</div>
      <div class="ab" id="authBody"></div>
    </div>
  </div>


  <!-- Banner annullamento -->
  <div id="cancelBanner" class="topBanner" role="status" aria-live="polite">
    <div class="icon"></div>
    <div class="body">
      <div class="title">Produzione annullata</div>
      <div class="sub" id="cancelBannerSub">Lordine  stato annullato.</div>
    </div>
    <button class="closeBtn" id="cancelBannerClose" type="button">Chiudi</button>
  </div>

  <div class="wrap">
    <header class="headerRow">
      <div class="brand">
        <img class="brandLogo" src="./logo%20general%20copper.png" alt="General Copper" decoding="async" loading="eager">
        <div class="titleWrap">
          <div class="title" aria-label="Hub linea polveri">
            <span class="titleLine">Hub Linea</span>
            <span class="titleLine accent">Polveri</span>
          </div>
          <div class="subtitle">Benvenuto operatore <b id="hdrUser"></b>, questo mese hai prodotto <span id="hdrMonthKg"></span> kg e hai concluso <span id="hdrMonthOrders"></span> ordini.</div>
          <div class="mobileWelcomeWrap" id="mobileWelcomeWrap">
            <div class="mobileWelcome" id="mobileWelcome">Benvenuto operatore <span class="highlight"></span>, questo mese hai prodotto <span class="kpi"></span> kg e hai concluso <span class="kpi"></span> ordini.</div>
            <button class="mobileStatsLink" id="btnMobileStats" type="button">Vai a statistiche</button>
          </div>
        </div>
      </div>
      <div class="statusRow actions">
        <div class="pill" id="pillOnline"><span class="dot" id="dotOnline"></span><span id="txtOnline">Stato: avvio</span></div>
        <div class="pill"><span class="dot ok"></span><span id="txtXmlTime">Ordini: in sincronizzazione</span></div>
        <div class="pill pillQuiet" id="pillSync" style="display:none;"><span class="dot warn" id="dotSync"></span><span id="txtSync">Aggiornamento</span></div>
      
        <button class="pill pillBtn" id="pillPush" type="button" title="Centro notifiche e push">
          <span class="dot" id="dotPush"></span>
          <span id="txtPush">Notifiche</span>
          <span class="pillBadge" id="pillPushBadge">0</span>
        </button>
        <button id="btnHeaderRefresh" class="iconBtn" type="button" aria-label="Aggiorna" title="Aggiorna">
          <span class="icon" aria-hidden="true"></span>
          <span class="errBadge" id="refreshErrBadge">Errore rete</span>
        </button>
      </div>
    </header>
    <div class="grid homeWrapOrMainContainer desktopShell">
      <div class="desktopCol mainCol">
        <div class="card heroCard" id="opsCard">
          <div class="hd">
            <h2>Operativit</h2>
            <div class="badge" id="badgeCounts"></div>
          </div>
          <div class="bd">
            <button class="primaryBtn" id="btnGoProd">VAI IN PRODUZIONE</button>

            <div style="height:12px"></div>

            <div id="partialBanner" class="warnBanner pressCard fadeCard" style="display:none;" role="button" tabindex="0" aria-label="Ordini parzialmente conclusi">
              <div class="icon"></div>
              <div class="txt">
                <div class="t" id="partialBannerTitle">Ci sono ordini parzialmente conclusi in corso</div>
                <div class="s" id="partialBannerSub">Apri per vedere solo gli ordini parziali e concludere.</div>
              </div>
              <div class="badge">Apri</div>
            </div>

            <div style="height:12px"></div>

            <div id="prodStrip" class="bigStrip" style="display:none;">
              <div class="label">Produzione in corso</div>
              <div class="marquee"><span id="prodMarquee"></span></div>
              <div class="meta">
                <div class="metaCount"><b id="prodCount">0</b> attivit attive</div>
                <div class="metaHint">Tap per dettagli e conclusione</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="kv">
              <div class="k">
                <div class="t">Righe polveri</div>
                <div class="v" id="kPowderLines"></div>
              </div>
              <div class="k">
                <div class="t">Kg totali</div>
                <div class="v" id="kPowderKg"></div>
                <div class="muted" id="kPowderMeta" style="margin-top:4px; font-size:12px;">Calcolato su 0 righe visibili</div> <!-- // UI-FIX: kg-totali -->
              </div>
              <div class="k">
                <div class="t">Bobine F480 (stima)</div>
                <div class="v" id="kBobineF480"></div>
                <div class="muted" id="kBobineF480Meta" style="margin-top:4px; font-size:12px;">Stima non disponibile</div>
              </div>
              <div class="k">
                <div class="t">Bobine F830 (stima)</div>
                <div class="v" id="kBobineF830"></div>
                <div class="muted" id="kBobineF830Meta" style="margin-top:4px; font-size:12px;">Stima non disponibile</div>
              </div>
            </div>

          </div>
        </div>

        <div class="card" id="completedCard">
          <div class="hd">
            <h2>Ordini conclusi</h2>
            <div class="badge" id="completedBadge">0</div>
          </div>
          <div class="bd">
            <div class="rowsScroll" id="completedBody">
              <div class="list" id="completedList"></div>
              <div class="muted" id="completedEmpty" style="display:none;">Nessuna produzione conclusa registrata.</div>
            </div>
          </div>
        </div>

        <div id="warehouseAnchor" style="display:none;" aria-hidden="true"></div>
        <div class="card" id="warehouseCard" style="display:none;">
          <div class="hd">
            <h2>Gestione magazzino</h2>
            <div class="badge" id="warehouseBadge"></div>
          </div>
          <div class="bd">
            <div id="warehouseBody"></div>
          </div>
        </div>
      </div>

      <div class="desktopCol sideCol">
        <div class="adminMobileHeader adminOnly" id="adminMobileHeader">
          <div class="eyebrow">Hub admin</div>
          <div class="adminMobileTitle">Strumenti amministratore</div>
          <div class="adminMobileSub">Parit contenuti desktop anche su mobile.</div>
        </div>
        <div class="adminMobileStack" id="adminMobileStack">
          <div class="card introCard adminOnly" id="desktopSummaryCard">
            <div class="introTop">
              <div class="eyebrow">Hub admin</div>
              <div class="introTitle">Panoramica operativa</div>
              <div class="introLead">Vista coerente con il layout mobile, dedicata agli amministratori.</div>
            </div>
            <div class="summaryGrid">
              <div class="summaryTile">
                <div class="t">Fatturato lordo</div>
                <div class="summaryValue blur" id="fatValue"> </div>
                <div class="muted" id="fatSubtitle">Visibile per gli amministratori su ogni dispositivo.</div>
              </div>
              <div class="summaryTile">
                <div class="t">Produzione mese</div>
                <div class="summaryValue"><span id="deskMonthKg"></span> kg</div>
                <div class="muted">Ordini conclusi: <span id="deskMonthOrders"></span></div>
              </div>
              <div class="summaryTile">
                <div class="t">Supporto rapido</div>
                <div class="summaryActions">
                  <button class="btn ghost" id="btnCallMatteo" style="width:100%;">Chiama Matteo</button>
                  <button class="btn ghost" id="btnOpenStats" style="width:100%;">Statistiche</button>
                </div>
                <div class="muted">Interventi, assistenza e apertura dashboard statistiche.</div>
              </div>
            </div>
          </div>

          <div class="mobileAssignInfo" id="mobileAllowInfo">Ordini assegnati: <span id="mobileAllowCount"></span><span id="mobileAllowMsg" style="margin-left:6px; color:var(--muted); font-weight:800;"></span></div>

          <div id="mobileSendAnchor" style="display:none;" aria-hidden="true"></div>
          <div id="mobileSendCard" class="adminPanel adminOnly" style="display:none;">
            <div class="mobileSendShell">
              <div class="mobileSendTopbar">
                <div class="mobileSendHeader">
                  <div class="mobileSendTitleCol">
                    <div class="panelTitle">Invio ordini a mobile</div>
                    <div class="mobileStatsLine" aria-live="polite">
                      <span class="statLabel">Totali:</span> <b id="mobileAllowTotal"></b>
                      <span class="statSep"></span>
                      <span class="statLabel">Inviati:</span> <b id="mobileAllowSent"></b>
                      <span class="statSep"></span>
                      <span class="statLabel">Match:</span> <b id="mobileAllowMatch"></b>
                    </div>
                    <div class="panelSub mobileSendSubline" id="mobileAllowUpdate">Aggiornato </div>
                    <div class="panelSub" id="mobileAllowUpdatedBy"></div>
                  </div>
                  <div class="mobileSendStatus">
                    <div class="statusBadge" id="mobileAllowStatus">Salvato</div>
                    <div class="saveBadge" id="mobileAllowFeedback">Stato: </div>
                    <div class="saveBadge" id="mobileAllowResetStatus">Pronto al reset</div>
                  </div>
                </div>
                <div class="mobileSendToolbar">
                  <input id="mobileAllowSearch" class="adminSearch" type="search" placeholder="Cerca cliente, prodotto, numero">
                  <div class="mobileSendToolbarBtns">
                    <button class="btn actionPrimary" id="btnSaveMobileAllow" type="button">Invia</button>
                    <button class="btn actionGhost" id="btnResetMobileAllow" type="button">Reset</button>
                  </div>
                  <div class="microActions">
                    <button class="textAction" id="btnAllowSelectAll" type="button">Seleziona filtrati</button>
                    <span class="statSep"></span>
                    <button class="textAction" id="btnAllowClear" type="button">Deseleziona filtrati</button>
                  </div>
                </div>
              </div>
              <div class="mobileSendBody">
                <div class="mobileSendListPane">
                  <div class="listHead">
                    <div class="panelSub">Clicca una riga per inviare o rimuovere dallapp mobile.</div>
                  </div>
                  <div class="adminList rowsScroll" id="mobileSendList"></div>
                </div>
              </div>
            </div>
          </div>

          <div id="statsCardAnchor" style="display:none;" aria-hidden="true"></div>
          <div id="statsProduzione" style="position:relative; top:-6px;" aria-hidden="true"></div>
          <div class="card adminOnly" miniCard id="statsProdCard">
            <div class="hd">
              <h2>Statistiche produzione</h2>
              <div class="badge" id="statsBadge"></div>
            </div>
            <div class="bd">
              <div class="muted">Classifica live (kg totali e velocit media) per gli amministratori.</div>
              <div style="height:10px"></div>
              <div class="rowsScroll" id="statsBody">
                <div id="operatorLeaderboard"></div>
                <div id="statsList" class="list"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" id="issueCard">
          <div class="hd">
            <h2>Segnala un problema</h2>
          </div>
          <div class="bd">
            <div class="muted">Macchina non funzionante, materiale assente, o anomalie: raccontalo qui. La segnalazione resta interna.</div>
            <div style="height:10px"></div>
            <textarea id="issueText" placeholder="Esempio: 'Macchina dosatrice non parte' oppure 'Prodotto non disponibile in magazzino'. Aggiungi ordine/cliente se utile"></textarea>
            <div style="height:10px"></div>
            <button class="btn good" id="btnSendIssue" style="width:100%;">Invia segnalazione</button>
          </div>
        </div>

        <div class="muted" style="text-align:center;"> General Copper SRL  Uso interno</div>
      </div>
    </div>
  </div>

  
  <!-- Warehouse detail modal -->
  <div id="whModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <div class="modalTitle" id="whModalTitle">Dettaglio magazzino</div>
          <div class="modalSub" id="whModalSub"></div>
        </div>
        <button class="modalClose" id="whModalClose" aria-label="Chiudi"></button>
      </div>
      <div class="modalBody" id="whModalBody"></div>
    </div>
  </div>

  <!-- Notifications modal -->
  <div id="notifModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="titleCol">
          <div class="h">Centro notifiche</div>
          <div class="muted" id="notifSub">Push, messaggi interni e registro.</div>
        </div>
        <button class="x" id="notifClose" aria-label="Chiudi"></button>
      </div>
      <div class="sbd" id="notifBody">
        <div class="stepTitle">Inbox</div>
        <div class="muted" id="notifStatus">Caricamento notifiche</div>
        <div style="height:8px"></div>
        <div id="notifUnavailable" class="alertBanner" style="display:none;">
          <div class="label">Centro notifiche non disponibile (permessi o connessione).</div>
          <div class="hint">Nessun blocco: lapp continua a funzionare.</div>
        </div>
        <div id="notifList" class="notifList"></div>
        <div class="notifEmpty" id="notifEmpty" style="display:none;">Nessuna notifica disponibile.</div>
        <div style="height:12px"></div>
        <div class="row2">
          <button class="btn ghost" id="btnNotifCompleted" style="width:100%;">Registro conclusi</button>
          <button class="btn" id="btnTogglePush" style="width:100%;">Gestisci push</button>
        </div>
        <div style="height:12px"></div>
        <div id="notifAdminBox" style="display:none;">
          <div class="stepTitle">Invia notifica (admin)</div>
          <div class="muted">Messaggio a tutti gli operatori linea polveri (push o inbox). Richiede permessi Firestore.</div>
          <div style="height:8px"></div>
          <input type="text" id="notifTitle" placeholder="Titolo (es. Aggiornamento impianto)" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); font-weight:900;"/>
          <div style="height:8px"></div>
          <textarea id="notifBodyInput" placeholder="Testo notifica" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); min-height:90px; font-weight:800;"></textarea>
          <div style="height:8px"></div>
          <button class="btn good" id="btnSendNotif" style="width:100%;">Invia a tutti</button>
          <div class="muted" id="notifAdminFeedback" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- History detail modal -->
  <div id="histModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div>
          <div class="h" id="histTitle">Dettaglio produzione</div>
          <div class="sub" id="histSub"></div>
        </div>
        <button class="x" id="histClose" aria-label="Chiudi"></button>
      </div>
      <div class="sbd" id="histBody"></div>
    </div>
  </div>

<!-- Toast overlay -->
  <div id="toast" class="toast">
    <div class="tt" id="toastTitle">Attenzione</div>
    <div class="tb" id="toastBody"></div>
  </div>

  <!-- Production modal -->
  <div id="prodModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="titleCol">
          <div class="h" id="prodModalTitle">Produzione</div>
          <div class="selCounter" id="selectionCounter" style="display:none;">0 righe selezionate</div>
        </div>
        <button class="x" id="prodModalClose" aria-label="Chiudi"></button>
      </div>
      <div class="sbd" id="prodModalBody"></div>
    </div>
  </div>

  <!-- Running productions modal -->
  <div id="runningModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Produzione in corso</div>
        <button class="x" id="runningClose" aria-label="Chiudi"></button>
      </div>
      <div class="sbd" id="runningBody"></div>
    </div>
  </div>

  <!-- Partial orders modal -->
  <div id="partialModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Ordini parzialmente conclusi</div>
        <button class="x" id="partialClose" aria-label="Chiudi"></button>
      </div>
      <div class="sbd" id="partialBody"></div>
    </div>
  </div>

  
  <!-- Signature modal -->
  <div id="signModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Conclusione  Firma</div>
        <button class="x" id="signClose" aria-label="Chiudi"></button>
      </div>
      <div class="sbd">
        <div class="stepTitle">Dichiarazione e firma</div>
        <div class="muted" id="signContext"></div>
        <div style="height:10px"></div>
        <div class="muted" style="font-weight:800;">
          Dichiarazione: <b>dichiaro</b> che la produzione  stata eseguita secondo le procedure aziendali e i controlli previsti.
        </div>
        <div style="height:10px"></div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="signCheck" type="checkbox" style="width:20px;height:20px; accent-color: var(--good);" />
          <label for="signCheck" style="font-weight:900;">Confermo la dichiarazione</label>
        </div>
        <div style="height:12px"></div>
        <div style="border:1px solid var(--stroke); border-radius:18px; overflow:hidden; background: rgba(0,0,0,.02);">
          <canvas id="signCanvas" class="signaturePad" style="width:100%; height:220px; display:block;"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="row2">
          <button class="btn" id="signClear">Pulisci firma</button>
          <button class="btn good" id="signOk">CONCLUDI</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Reason modal -->

<script type="module">
  // ===============================
  // CONFIG
  // ===============================
  const XML_PROXY_CFG = {
      proxyUrl: "https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",
      cacheKey: "EASYFATT_XML_CACHE_V1"
    };
  const ADMIN_PW = "12345";
  const FIREBASE_IMPORT_APP = "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  const FIREBASE_IMPORT_FS  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  const FIREBASE_IMPORT_AUTH = "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  const FIREBASE_IMPORT_MSG  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };
  // Web Push (FCM): incolla qui la *Public key* (VAPID) da Firebase Console  Project settings  Cloud Messaging  Web Push certificates
  const FCM_VAPID_KEY = "PASTE_PUBLIC_VAPID_KEY_HERE";
  const AUTH_TTL_MS = 7 * 24 * 60 * 60 * 1000;
  const LS_AUTH_OK = "hub_auth_ok_ts_v1";
  const LS_AUTH_EMAIL = "hub_auth_last_email_v1";
  const RESTORE_TIMEOUT_MS = 6000;

  // Email su segnalazione problemi (richiede Firebase Extension: firestore-send-email)
  const ISSUE_EMAIL_ENABLED = false; // metti true quando l'estensione  installata
  const ISSUE_EMAIL_TO = "matteo@generalcoppersrl.com";
  const FAT_VALUE_KEY = "FATTURATO_EUR_CACHE";
  const NOTIF_READ_KEY = "POLVERI_NOTIF_READ_V1";
  const NOTIF_COLLECTION = "powderNotifications";
  const NOTIF_LIMIT = 40;
  const ALLOW_PATH = { col: "hub_config", doc: "hub_linea_polveri_mobile_allowlist" };
  const ALLOW_DOC_PATH = `${ALLOW_PATH.col}/${ALLOW_PATH.doc}`;
  const MAG_FILTERS_KEY = "gc_magazzino_filters_v1";
  const OP_RANK_SORT_KEY = "gc_op_rank_sort_v1";


  const OPERATORS = ["Hassan","Ahmed","Muhammed","Mustapha","Youssef"];
  const NON_PERTINENT_CODES = new Set(["mast250viri","mast500viri","codmast250viri","codmast500viri"]);
  // CODEX: Distinta base magazzino (default per sacchi 5kg/1kg, valida per tutti i prodotti)
  const MAGAZZINO_DEFAULT_PACKS = {
    5: {
      prodottoKgPerBag: 5,
      bobine: { "Bobina blu f830": { perBag: 20, unit:"g" } },
      etichettePerBag: 1,
      scatole: { "Scatola americana | 20 kg": 0.25 },
      divisori: { "Divisorio Z": 0.25 },
      altri: {}
    },
    1: {
      prodottoKgPerBag: 1,
      bobine: { "Bobina blu f480": { perBag: 10, unit:"g" } },
      etichettePerBag: 1,
      scatole: { "Scatola americana | 20 kg": 0.05 },
      divisori: { "Divisorio Croce texo": 0.05 },
      altri: {}
    }
  };
  const MAGAZZINO_BOM = { // CODEX: Distinta base estendibile per calcolo magazzino (desktop)
    defaultByPackKg: MAGAZZINO_DEFAULT_PACKS, // CODEX: fallback per qualsiasi prodotto (match per formato sacco)
    byCode: {
      // Esempio: "CODICE": { packs: { 5: { prodottoKgPerBag:5, bobine:{ "tipo":{perBag:20, unit:"g"} }, etichettePerBag:1, scatole:{ "model":0.2 }, divisori:{ "tipo":0.1 }, altri:{ "nome":0.1 } } } }
    },
    byName: {
      // Nome normalizzato senza peso  packKg  componenti per singolo sacco/confezione
      "ossicloruro di rame 50%": { packs: MAGAZZINO_DEFAULT_PACKS }
    }
  };

  // UI-FIX: anticache
  try{
    if("serviceWorker" in navigator){
      navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())).catch(()=>{});
    }
  }catch(_e){}

  // ===============================
  // STATE
  // ===============================
  const state = {
    lastAuthErrorMsg: "",

    xmlModifiedTime: null,
    lastFetchAt: null,
    docs: [],
    fatturatoLordo: null, // CODEX: cache fatturato lordo lato client
    powderOrders: [],
    activeProductions: [],
    history: [],
    historyReady: false,
    globalStats: { ready:false, data:{ concludedCountTotal:0, concludedKgTotal:0, updatedAt:null, updatedBy:"" }, source:"init", error:"" },
    user: null,
    operator: null,
    selectedLines: new Map(), // CODEX: selezione multi-ordine persistente
    prodModalOpenedAt: 0,
    startedThisSession: false,
    prodModalTouched: false,
    firebase: {
      ok: false,
      db: null,
      api: null,
    },
    magFilters: loadMagazzinoFilters(),
    magazzinoOverview: [],
    magazzinoDetailLookup: new Map(),
    mobileAllowlist: { ready:false, keys:new Set(), updatedAt:null, updatedBy:"", allowAll:true, docExists:false, error:"", lastError:"", lastSyncTs:null, pendingRender:false },
    mobileAllowSelection: new Set(),
    mobileAllowDirty: false,
    mobileAllowSaveState: "idle",
    mobileAllowSearchTerm: "",
    mobileAllowReset: { confirm:false, status:"idle", lastError:"" },
    notifications: { inbox: [], ready:false, unavailable:false, error:"" },
    notifUnsub: null,
    push: { supported:false, permission:'default', token:'', enabled:false },
  };
  globalThis.__ALLOW_KEYS__ = (globalThis.__ALLOW_KEYS__ instanceof Set) ? globalThis.__ALLOW_KEYS__ : new Set();
  globalThis.__ALLOW_META__ = globalThis.__ALLOW_META__ || { updatedAt:null, updatedBy:"", lastError:"", lastSyncTs:null };
  globalThis.__ALLOWLIST_LISTEN_STARTED__ = Boolean(globalThis.__ALLOWLIST_LISTEN_STARTED__);
  globalThis.__ALLOWLIST_CACHE_CLEANED__ = Boolean(globalThis.__ALLOWLIST_CACHE_CLEANED__);
  globalThis.__ALLOW_LOADED__ = Boolean(globalThis.__ALLOW_LOADED__);
  globalThis.__CONCLUDE_INFLIGHT__ = (globalThis.__CONCLUDE_INFLIGHT__ instanceof Map) ? globalThis.__CONCLUDE_INFLIGHT__ : new Map();
  globalThis.__CONCLUDE_RECENT__ = (globalThis.__CONCLUDE_RECENT__ instanceof Map) ? globalThis.__CONCLUDE_RECENT__ : new Map();
  globalThis.__CONCLUDE_HANDLER_BOUND__ = Boolean(globalThis.__CONCLUDE_HANDLER_BOUND__);
  globalThis.__GLOBAL_STATS__ = (globalThis.__GLOBAL_STATS__ && typeof globalThis.__GLOBAL_STATS__==="object") ? globalThis.__GLOBAL_STATS__ : { concludedCountTotal:0, concludedKgTotal:0, updatedAt:null, updatedBy:"" };
  globalThis.__GLOBAL_STATS_READY__ = Boolean(globalThis.__GLOBAL_STATS_READY__);
  globalThis.__STATS_CLEAR_TS__ = Number(globalThis.__STATS_CLEAR_TS__||0);
  globalThis.__RESTORE_TIMER__ = globalThis.__RESTORE_TIMER__ || null;
  globalThis.__AUTH_LISTENER_BOUND__ = Boolean(globalThis.__AUTH_LISTENER_BOUND__);
  globalThis.__AUTH_RESUME_BOUND__ = Boolean(globalThis.__AUTH_RESUME_BOUND__);
  let authGateState = "unknown";
  let restoreExpireHandler = null;
  let __allOrdersCache = [];
  let __allOrdersKeySet = new Set();
  globalThis.__allowCommitted = (globalThis.__allowCommitted instanceof Set) ? globalThis.__allowCommitted : new Set(Array.from(globalThis.__ALLOW_KEYS__||[]));
  globalThis.__allowDraft = (globalThis.__allowDraft instanceof Set) ? globalThis.__allowDraft : new Set(globalThis.__allowCommitted);
  globalThis.__allowDraftDirty = Boolean(globalThis.__allowDraftDirty);
  const LEGACY_ALLOW_CACHE_KEYS = ["allowKeys","mobileAllowlist","hub_allowlist","mobileSendKeys","assignedOrders"];
  function cleanupLegacyAllowlistCaches(){
    if(globalThis.__ALLOWLIST_CACHE_CLEANED__) return;
    globalThis.__ALLOWLIST_CACHE_CLEANED__ = true;
    const stores = [];
    try{ if(typeof localStorage!=="undefined") stores.push(localStorage); }catch(_e){}
    try{ if(typeof sessionStorage!=="undefined") stores.push(sessionStorage); }catch(_e){}
    for(const store of stores){
      try{
        for(const k of LEGACY_ALLOW_CACHE_KEYS){
          store.removeItem(k);
        }
      }catch(_e){}
    }
  }
  cleanupLegacyAllowlistCaches();
  const GLOBAL_STATS_LOCAL_KEY = "hub_linea_polveri_global_stats_v1";
  const GLOBAL_STATS_PATH = { col: "hub_config", doc: "hub_linea_polveri_global_stats" };
  const STATS_CLEAR_TS_KEY = "hub_linea_polveri_stats_clear_ts";
  const PROD_HISTORY_RESET_KEY = "gc_prod_history_reset_ts_v1";
  const LEGACY_STATS_KEYS = [
    "powderProdHistory",
    "powderProdHistoryCache",
    "powderProdStats",
    "powderProdStats_v1",
    "powder_stats_cache",
    "powder_stats_history",
    "powder_stats_history_v1",
    "powder_history",
    "prod_history",
    "ordiniConclusi",
    "statsHistory",
    "statsHistoryCache",
    "hub_linea_polveri_history"
  ];
  const LEGACY_STATS_PREFIXES = [
    "powderStats_",
    "powderProdHistory_",
    "powderProdStats_",
    "hub_prod_stats_"
  ];

  // ===============================
  // UTILS
  // ===============================
  const $ = (id)=>document.getElementById(id);
  const loader = {
    indicator: $("pillSync"),
    indicatorText: $("txtSync"),
    indicatorDot: $("dotSync"),
    firstRenderDone: false,
    inError: false
  };
  let syncInFlight = false;
  let syncQueued = false;
  let syncRetryTimer = null;
  let syncBackoffMs = 0;
  let currentSyncPromise = null;

  function yieldFrame(){
    return new Promise((resolve)=>requestAnimationFrame(()=>resolve()));
  }
  async function appendChunked(listEl, items, renderFn, chunkSize=90){
    if(!listEl) return;
    listEl.innerHTML = "";
    const frag = document.createDocumentFragment();
    for(let i=0;i<(items?.length||0);i++){
      frag.appendChild(renderFn(items[i], i));
      const reachedChunk = (i+1) % chunkSize === 0;
      if(reachedChunk){
        listEl.appendChild(frag);
        await yieldFrame();
      }
    }
    listEl.appendChild(frag);
  }
  const emptyGlobalStats = ()=>({ concludedCountTotal:0, concludedKgTotal:0, updatedAt:null, updatedBy:"" });
  function readLocalGlobalStats(){
    try{
      if(typeof localStorage==="undefined") return null;
      const raw = localStorage.getItem(GLOBAL_STATS_LOCAL_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(parsed && typeof parsed==="object") return parsed;
    }catch(_e){}
    return null;
  }
  function persistLocalGlobalStats(stats){
    try{
      if(typeof localStorage==="undefined") return;
      localStorage.setItem(GLOBAL_STATS_LOCAL_KEY, JSON.stringify(stats));
    }catch(_e){}
  }
  function getGlobalStatsData(){
    if(!(globalThis.__GLOBAL_STATS__ && typeof globalThis.__GLOBAL_STATS__==="object")){
      globalThis.__GLOBAL_STATS__ = emptyGlobalStats();
    }
    if(!state.globalStats){
      state.globalStats = { ready:false, data: emptyGlobalStats(), source:"init", error:"" };
    }
    return globalThis.__GLOBAL_STATS__;
  }
  function applyGlobalStats(stats, source="local"){
    const merged = { ...emptyGlobalStats(), ...(stats||{}) };
    globalThis.__GLOBAL_STATS__ = merged;
    globalThis.__GLOBAL_STATS_READY__ = true;
    state.globalStats = { ...(state.globalStats||{}), data: merged, ready:true, source, error:"" };
    persistLocalGlobalStats(merged);
    return merged;
  }
  async function loadGlobalStats(){
    let stats = emptyGlobalStats();
    let source = "init";
    const local = readLocalGlobalStats();
    if(local){
      stats = { ...stats, ...local };
      source = "localstorage";
    }
    if(state.firebase?.ok){
      try{
        const fs = state.firebase.api;
        const db = state.firebase.db;
        const snap = await fs.getDoc(fs.doc(db, GLOBAL_STATS_PATH.col, GLOBAL_STATS_PATH.doc));
        if(snap.exists()){
          const data = snap.data() || {};
          stats = {
            ...stats,
            concludedCountTotal: Number(data.concludedCountTotal||0),
            concludedKgTotal: Number(data.concludedKgTotal||0),
            updatedAt: data.updatedAt || data.concludedAt || data.at || null,
            updatedBy: data.updatedBy || data.user || ""
          };
          source = "firestore";
        }
      }catch(err){
        console.warn("load global stats failed", err);
        state.globalStats = { ...(state.globalStats||{}), error: String(err?.message||err||"") };
      }
    }
    const applied = applyGlobalStats(stats, source);
    renderGlobalStatsSummary();
    return applied;
  }
  async function saveGlobalStats(stats){
    const merged = applyGlobalStats(stats, state.globalStats?.source || "local");
    if(state.firebase?.ok){
      try{
        const fs = state.firebase.api;
        const db = state.firebase.db;
        await fs.setDoc(fs.doc(db, GLOBAL_STATS_PATH.col, GLOBAL_STATS_PATH.doc), {
          concludedCountTotal: Number(merged.concludedCountTotal||0),
          concludedKgTotal: Number(merged.concludedKgTotal||0),
          updatedAt: fs.serverTimestamp(),
          updatedBy: state.user?.email || state.user?.fullName || ""
        }, { merge:true });
        state.globalStats = { ...(state.globalStats||{}), source:"firestore", error:"" };
      }catch(err){
        console.warn("persist global stats failed", err);
        state.globalStats = { ...(state.globalStats||{}), error: String(err?.message||err||"") };
      }
    }
    renderGlobalStatsSummary();
    return merged;
  }
  async function bumpGlobalStats(deltaCount=0, deltaKg=0){
    const cur = getGlobalStatsData();
    const next = {
      concludedCountTotal: Number(cur.concludedCountTotal||0) + Number(deltaCount||0),
      concludedKgTotal: Number(cur.concludedKgTotal||0) + Number(deltaKg||0),
      updatedAt: nowIso(),
      updatedBy: state.user?.email || state.user?.fullName || ""
    };
    return saveGlobalStats(next);
  }
  function getStatsClearTs(){
    const tryGet = (store, key=STATS_CLEAR_TS_KEY)=>{
      try{
        if(store && typeof store.getItem==="function"){
          const raw = store.getItem(key);
          if(raw!=null) return raw;
        }
      }catch(_e){}
      return null;
    };
    const raw = tryGet(localStorage) ?? tryGet(sessionStorage) ?? (globalThis.__STATS_CLEAR_TS__!=null ? String(globalThis.__STATS_CLEAR_TS__) : null);
    const resetRaw = tryGet(localStorage, PROD_HISTORY_RESET_KEY) ?? tryGet(sessionStorage, PROD_HISTORY_RESET_KEY);
    const ts = Math.max(parseInt(raw || "0", 10), parseInt(resetRaw || "0", 10));
    return Number.isFinite(ts) ? ts : 0;
  }
  function setStatsClearTs(ts){
    globalThis.__STATS_CLEAR_TS__ = ts;
    try{ localStorage?.setItem(STATS_CLEAR_TS_KEY, String(ts)); }catch(_e){}
    try{ sessionStorage?.setItem(STATS_CLEAR_TS_KEY, String(ts)); }catch(_e){}
    try{ localStorage?.setItem(PROD_HISTORY_RESET_KEY, String(ts)); }catch(_e){}
    try{ sessionStorage?.setItem(PROD_HISTORY_RESET_KEY, String(ts)); }catch(_e){}
  }
  function purgeLocalStatsStorage(){
    const keys = [GLOBAL_STATS_LOCAL_KEY, ...LEGACY_STATS_KEYS];
    const prefixes = ["hub_linea_polveri_global_stats_", "hub_linea_polveri_stats_", ...LEGACY_STATS_PREFIXES];
    const stores = [];
    try{ if(typeof localStorage!=="undefined") stores.push(localStorage); }catch(_e){}
    try{ if(typeof sessionStorage!=="undefined") stores.push(sessionStorage); }catch(_e){}
    let removed = 0;
    for(const store of stores){
      try{
        const toRemove = new Set();
        for(let i=0;i<store.length;i++){
          const k = store.key(i);
          if(!k) continue;
          if(k === PROD_HISTORY_RESET_KEY) continue;
          if(keys.includes(k) || prefixes.some(p=>k.startsWith(p))){
            toRemove.add(k);
          }
        }
        toRemove.forEach(k=>{ try{ store.removeItem(k); removed += 1; }catch(_e){} });
      }catch(_e){}
    }
    return { removedKeys: removed, stores: stores.length };
  }
  function getStatsHistoryEntries(){
    const hist = (state.history||[]).filter(x=>x && x.operator);
    const clearAfter = getStatsClearTs();
    if(!clearAfter) return hist;
    return hist.filter((x)=> tsFromId(x.id||x.at||0) > clearAfter);
  }
  function getStatsHistoryEntriesAll(){
    const hist = Array.isArray(state.history) ? state.history : [];
    const clearAfter = getStatsClearTs();
    if(!clearAfter) return hist;
    return hist.filter((x)=> tsFromId(x.id||x.at||0) > clearAfter);
  }
  function getCurrentMonthRange(){
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 1).getTime() - 1;
    return { start, end, label: "Questo mese" };
  }
  function readOpRankSort(){
    try{
      const raw = localStorage.getItem(OP_RANK_SORT_KEY);
      return raw === "kg" ? "kg" : "orders";
    }catch(_e){
      return "orders";
    }
  }
  function saveOpRankSort(mode){
    try{ localStorage.setItem(OP_RANK_SORT_KEY, mode); }catch(_e){}
  }
  function resolveEventTs(ev){
    const probes = [ev?.endedAt, ev?.startedAt, ev?.at];
    for(const raw of probes){
      if(!raw) continue;
      const dt = new Date(raw);
      if(Number.isFinite(dt.getTime())) return dt.getTime();
    }
    const fromId = tsFromId(ev?.id || ev?.at || 0);
    return Number.isFinite(fromId) ? fromId : null;
  }
  function cleanOperatorLabel(raw){
    if(raw==null) return "";
    let txt = String(raw||"").trim();
    if(!txt) return "";
    if(txt.includes("@")){
      const [beforeAt] = txt.split("@");
      if(beforeAt) txt = beforeAt.trim();
    }
    return txt.replace(/\s+/g, " ").trim();
  }
  function resolveOperatorLabel(ev){
    const candidates = [
      ev?.operator,
      ev?.operatorName,
      ev?.user,
      ev?.fullName,
      ev?.displayName,
      ev?.operatorEmail,
      ev?.email,
      ev?.uid,
      ev?.operatorUid
    ];
    for(const c of candidates){
      const cleaned = cleanOperatorLabel(c);
      if(cleaned) return cleaned;
    }
    return "Sconosciuto";
  }
  function computeOperatorLeaderboard(events, startTs, endTs){
    const start = Number(startTs) || 0;
    const end = Number(endTs) || 0;
    const map = new Map();
    for(const ev of (Array.isArray(events) ? events : [])){
      const ts = resolveEventTs(ev);
      if(ts==null) continue;
      if(start && ts < start) continue;
      if(end && ts > end) continue;
      const label = resolveOperatorLabel(ev);
      const cleaned = cleanOperatorLabel(label);
      const key = cleaned ? cleaned.toLowerCase() : "sconosciuto";
      const kgVal = Number(ev?.kg);
      const entry = map.get(key) || { operatorLabel: cleaned || "Sconosciuto", orders:0, kg:0, eventsCount:0 };
      entry.orders += 1;
      entry.eventsCount += 1;
      if(Number.isFinite(kgVal)) entry.kg += kgVal;
      map.set(key, entry);
    }
    return Array.from(map.values()).map(it=>({ ...it, kg: Number(it.kg)||0, orders: Number(it.orders)||0, eventsCount: Number(it.eventsCount)||0 }));
  }
  function clearProdStatsHistoryHard(){
    const ts = Date.now();
    setStatsClearTs(ts);
    const { removedKeys, stores } = purgeLocalStatsStorage();
    state.history = [];
    state.historyReady = true;
    const empty = emptyGlobalStats();
    applyGlobalStats(empty, "cleared");
    renderGlobalStatsSummary();
    renderStats();
    try{ renderHeaderKpis(); }catch(_e){}
    try{ renderCompletedSection(); }catch(_e){}
    const fb = document.getElementById("statsClearFeedback");
    if(fb) fb.textContent = "Dati storici eliminati";
    try{ console.info(`[stats-reset] cleared history caches: ${removedKeys} key(s) across ${stores} storage(s) @${ts}`); }catch(_e){}
    showToast("Dati storici eliminati", "Statistiche azzerate su questo dispositivo.");
  }

  function showLoader(statusText="Aggiornamento", opts={}){
    loader.inError = opts.kind === "error";
    const el = loader.indicator;
    if(!el) return;
    el.style.display = "flex";
    if(loader.indicatorText){
      loader.indicatorText.textContent = statusText || "Aggiornamento";
    }
    if(loader.indicatorDot){
      loader.indicatorDot.className = "dot";
      loader.indicatorDot.classList.add(loader.inError ? "bad" : "warn");
    }
  }
  function hideLoader(){
    const el = loader.indicator;
    if(el) el.style.display = "none";
    loader.inError = false;
  }
  function markFirstRenderDone(){
    loader.firstRenderDone = true;
    if(loader.inError) return;
    setTimeout(()=> hideLoader(), 140);
  }
  function showLoaderError(msg){
    loader.inError = true;
    showLoader(msg || "Connessione instabile. Riprovo", { kind:"error" });
  }
  function resetSyncBackoff(){
    syncBackoffMs = 0;
    if(syncRetryTimer){
      clearTimeout(syncRetryTimer);
      syncRetryTimer = null;
    }
  }
  function scheduleSyncRetry(){
    if(syncRetryTimer) return;
    syncBackoffMs = syncBackoffMs ? Math.min(syncBackoffMs * 2, 20000) : 2000;
    syncRetryTimer = setTimeout(()=>{
      syncRetryTimer = null;
      queuedSyncOrders(false, "retry");
    }, syncBackoffMs);
    showLoaderError("Connessione instabile. Riprovo");
  }

  function nowIso(){ return new Date().toISOString(); }
  function fmtTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function fmtDateTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,"0");
    const mo = String(dt.getMonth()+1).padStart(2,"0");
    const yy = dt.getFullYear();
    return `${dd}/${mo}/${yy} ${fmtTime(dt)}`;
  }
  function ensureSelectionState(){
    if(!(state.selectedLines instanceof Map)) state.selectedLines = new Map();
    return state.selectedLines;
  }
  function makeSelectionKey(order, line){
    const on = order?.orderNo || order?.number || "";
    const cust = order?.customer || "";
    const lk = line?.lineKey || line?.lineID || line?.id || "";
    return `${on}__${cust}__${lk}`;
  }
  function selectionCount(){
    return ensureSelectionState().size;
  }
  function updateSelectionCounter(){
    const counter = $("selectionCounter");
    if(!counter) return;
    const n = selectionCount();
    if(n>0){
      counter.style.display = "inline-flex";
      counter.innerHTML = `<strong>${n}</strong> righe selezionate`;
    } else {
      counter.style.display = "none";
    }
  }
  function clearSelectionForOrder(order){
    const sel = ensureSelectionState();
    const keys = Array.from(sel.keys());
    for(const k of keys){
      const v = sel.get(k);
      if(v && String(v.orderNo||v.number||"") === String(order?.orderNo||order?.number||"") && String(v.customer||"") === String(order?.customer||"")){
        sel.delete(k);
      }
    }
  }
  function pruneSelectionAgainstOrders(baseOrders){
    const sel = ensureSelectionState();
    if(!sel.size) return;
    const allowed = new Set();
    for(const o of (baseOrders||[])){
      for(const l of (o.lines||[])){
        if(!l || l.status==="active") continue;
        allowed.add(makeSelectionKey(o, l));
      }
    }
    for(const k of Array.from(sel.keys())){
      if(!allowed.has(k)) sel.delete(k);
    }
    updateSelectionCounter();
  }
  function selectedEntriesForOrder(order){
    const out = [];
    const on = String(order?.orderNo||order?.number||"");
    const cust = String(order?.customer||"");
    for(const v of ensureSelectionState().values()){
      if(String(v.orderNo||v.number||"")===on && String(v.customer||"")===cust) out.push(v);
    }
    return out;
  }
  function groupSelectionByOrder(){
    const groups = new Map();
    for(const v of ensureSelectionState().values()){
      const on = String(v.orderNo||v.number||"");
      const cust = String(v.customer||"");
      const key = `${on}__${cust}`;
      if(!groups.has(key)) groups.set(key, { orderNo:on, customer:cust, lines:[] });
      groups.get(key).lines.push(v);
    }
    return groups;
  }
  function norm(s){
    return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
  }
  function safeText(node){
    return (node && node.textContent ? node.textContent : "").trim();
  }
  function parseCurrencyValue(raw){
    if(Number.isFinite(raw)) return Number(raw);
    const strRaw = raw==null ? "" : String(raw).trim();
    if(!strRaw) return null;
    const compact = strRaw.replace(/\s+/g,"");
    const itPattern = /^-?\d{1,3}(?:\.\d{3})*(?:,\d+)?$/;
    const commaDecimal = /^-?\d+(?:,\d+)?$/;
    let normalized = compact;
    if(itPattern.test(compact) || commaDecimal.test(compact)){
      normalized = compact.replace(/\./g,"").replace(",", ".");
    } else {
      normalized = compact.replace(/,/g,"");
    }
    const n = Number(normalized);
    return Number.isFinite(n) ? n : null;
  }
  function parseItNumber(raw){ // UI-FIX: kg-totali
    const s = (raw==null ? "" : String(raw)).replace(/\./g,"").replace(",",".").replace(/\s+/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function formatKg(value){
    return Number.isFinite(value) ? Math.round(value).toLocaleString("it-IT") : null;
  }
  function setHomeKgTotali(valueKg){
    const el = $("kPowderKg");
    if(!el) return;
    const formatted = formatKg(valueKg);
    el.textContent = formatted!=null ? `${formatted} kg` : "";
  }
  function formatQtyWithKg(qty, um="kg"){
    const qtyTxt = `${qty ?? 0}`;
    const hasKg = /\bkg\b/i.test(um||"");
    const cleanUm = (um||"").trim();
    if(hasKg) return `${qtyTxt} kg`;
    return cleanUm ? `${qtyTxt} ${cleanUm}  kg` : `${qtyTxt} kg`;
  }
  async function copyKeyToClipboard(text){
    if(!text) return;
    try{
      await navigator.clipboard.writeText(text);
      showToast("Key copiata", "StableKey copiata negli appunti.");
    }catch(_e){
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("Key copiata", "StableKey copiata.");
      }catch(_){}
    }
  }
  function isMobile(){
    const mq = typeof window !== "undefined" && window.matchMedia ? window.matchMedia("(max-width: 640px)") : { matches:false };
    const ua = (navigator.userAgent || navigator.vendor || "").toLowerCase();
    const uaMobile = /\b(android|iphone|ipad|ipod|mobile|iemobile|opera mini)\b/.test(ua);
    const legacyWidth = typeof window !== "undefined" ? (window.innerWidth <= 900) : false;
    return Boolean((mq && mq.matches) || uaMobile || legacyWidth);
  }
  function applyRoleClasses(){
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    document.body.classList.toggle("role-admin", isAdmin);
    document.body.classList.toggle("role-operator", !isAdmin);
  }
  const ADMIN_ANCHOR_TOKENS = ["admin", "mobilesendcard", "desktopsummarycard", "notifadminbox"];
  function guardAdminAccessOnMobile(){
    if(!isMobile()) return;
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    if(isAdmin) return;
    const hash = (typeof location !== "undefined" ? (location.hash||"") : "").toLowerCase();
    if(!hash) return;
    const shouldGuard = ADMIN_ANCHOR_TOKENS.some(tok=> hash.includes(tok));
    if(!shouldGuard) return;
    showToast("Sezione disponibile solo per admin", "Sezione disponibile solo per admin");
    try{ history.replaceState(null, document.title, location.pathname + location.search); }catch(_e){}
    try{
      const home = document.querySelector(".wrap") || document.body;
      if(home && typeof home.scrollIntoView==="function"){
        home.scrollIntoView({ behavior:"smooth", block:"start" });
      } else {
        window.scrollTo({ top:0, behavior:"smooth" });
      }
    }catch(_e){
      try{ window.scrollTo({ top:0, behavior:"smooth" }); }catch(_e2){}
    }
  }
  let adminHashGuardBound = false;
  function bindAdminHashGuard(){
    if(adminHashGuardBound) return;
    window.addEventListener("hashchange", guardAdminAccessOnMobile);
    adminHashGuardBound = true;
  }
  function debounce(fn, wait=150){
    let t = null;
    return (...args)=>{
      clearTimeout(t);
      t = setTimeout(()=> fn(...args), wait);
    };
  }
  function setHdrH(){
    const h = document.querySelector("header") || document.querySelector(".header") || null;
    const px = h ? h.getBoundingClientRect().height : 64;
    document.documentElement.style.setProperty("--hdrH", `${px}px`);
  }
  globalThis.__MOBILE_AUDIO__ = globalThis.__MOBILE_AUDIO__ || { unlocked:false, ctx:null, lastBeepAt:0, toastShown:false };
  globalThis.__MOBILE_EVENTS__ = globalThis.__MOBILE_EVENTS__ || { prevPartialCount:null, prevProdKey:null, prevAlertKey:null };
  function unlockMobileAudio(){
    if(!isMobile()) return;
    const s = globalThis.__MOBILE_AUDIO__;
    if(s.unlocked) return;
    try{
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return;
      s.ctx = s.ctx || new AC();
      if(s.ctx.state === "suspended") s.ctx.resume();
      s.unlocked = true;
    }catch(e){}
  }
  window.addEventListener("pointerdown", unlockMobileAudio, { once:true, passive:true });
  window.addEventListener("touchstart", unlockMobileAudio, { once:true, passive:true });
  function mobileChime(kind){
    if(!isMobile()) return;
    const s = globalThis.__MOBILE_AUDIO__;
    const now = Date.now();
    if(now - s.lastBeepAt < 6500) return;
    s.lastBeepAt = now;

    if(navigator.vibrate) navigator.vibrate(kind==="partial" ? [40,40,60] : [30,30,30]);

    if(!s.unlocked || !s.ctx){
      if(!s.toastShown){
        s.toastShown = true;
        showToast("Audio attivo dopo il primo tap", "Tocca una volta per abilitare il trillo.", 2000);
        setTimeout(()=>{ s.toastShown = false; }, 4000);
      }
      return;
    }
    try{
      const ctx = s.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      const t0 = ctx.currentTime;
      const A = 0.0001;

      g.gain.setValueAtTime(A, t0);
      g.gain.exponentialRampToValueAtTime(0.18, t0+0.02);
      g.gain.exponentialRampToValueAtTime(A, t0+0.18);

      o.frequency.setValueAtTime(kind==="partial" ? 880 : 740, t0);
      if(kind==="partial"){
        g.gain.setValueAtTime(A, t0+0.20);
        g.gain.exponentialRampToValueAtTime(0.16, t0+0.22);
        g.gain.exponentialRampToValueAtTime(A, t0+0.36);
      }

      o.connect(g); g.connect(ctx.destination);
      o.start(t0);
      o.stop(t0 + (kind==="partial" ? 0.40 : 0.20));
    }catch(e){}
  }
  function checkMobileEvents({ partialCount=0, prodKey=null, alertKey=null }={}){
    if(!isMobile()) return;
    const snap = globalThis.__MOBILE_EVENTS__;
    if(snap.prevPartialCount !== null && partialCount > snap.prevPartialCount){
      mobileChime("partial");
    }
    snap.prevPartialCount = partialCount;

    if(prodKey){
      if(snap.prevProdKey !== null && prodKey !== snap.prevProdKey){
        mobileChime("event");
      }
      snap.prevProdKey = prodKey;
    } else {
      snap.prevProdKey = prodKey;
    }

    if(alertKey){
      if(snap.prevAlertKey !== null && alertKey !== snap.prevAlertKey){
        mobileChime("event");
      }
      snap.prevAlertKey = alertKey;
    } else {
      snap.prevAlertKey = alertKey;
    }
  }
  function isKioskViewport(){
    const wide = typeof window !== "undefined" ? (window.innerWidth >= 1200) : false;
    const aspectOk = kioskAspectMq ? kioskAspectMq.matches : false;
    return Boolean(wide || aspectOk);
  }
  function prioritizeMobileSendCard(){
    const card = $("mobileSendCard");
    const anchor = $("mobileSendAnchor");
    const stack = card?.parentElement;
    if(!card || !anchor || !stack) return;
    const shouldPrioritize = Boolean(state.user && state.user.isAdmin && !isMobile() && typeof window !== "undefined" && window.innerWidth >= 1025);
    if(shouldPrioritize){
      const firstEl = stack.firstElementChild;
      if(firstEl !== card){
        stack.insertBefore(card, firstEl || null);
      }
    } else {
      const anchorParent = anchor.parentElement;
      if(anchorParent && card.previousElementSibling !== anchor){
        anchorParent.insertBefore(card, anchor.nextElementSibling);
      }
    }
  }
  function relocateWarehouseCard(){
    const card = $("warehouseCard");
    const anchor = $("warehouseAnchor");
    const opsCard = $("opsCard");
    const grid = opsCard?.parentElement;
    if(!card || !anchor || !opsCard || !grid) return;
    const wantsDesktopPlacement = document.body.classList.contains("adminDeskLayout") && !isMobile() && (typeof window !== "undefined" ? window.innerWidth >= 1025 : false);
    if(wantsDesktopPlacement){
      const ref = opsCard.nextSibling;
      if(card.parentElement !== grid || card.previousElementSibling !== opsCard){
        grid.insertBefore(card, ref);
      }
    } else {
      const anchorParent = anchor.parentElement;
      if(anchorParent && card.parentElement !== anchorParent){
        anchorParent.insertBefore(card, anchor.nextElementSibling);
      }
    }
  }
  function updateAdminDesktopLayout(){
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    const isDesktopWidth = typeof window !== "undefined" ? window.innerWidth >= 1025 : false;
    if(!isAdmin || isMobile() || !isDesktopWidth){
      document.body.classList.remove("adminDeskLayout");
      prioritizeMobileSendCard();
      relocateWarehouseCard();
      return;
    }
    document.body.classList.add("adminDeskLayout");
    prioritizeMobileSendCard();
    relocateWarehouseCard();
  }
  function updateDesktopStackClass(){
    // Desktop usa il layout a due colonne (stile iPad). Evita lo stacking "desktopAsMobile".
    document.body.classList.remove("desktopAsMobile");
  }
  const scheduleDesktopStackUpdate = (()=>{
    let t = null;
    return ()=>{
      clearTimeout(t);
      t = setTimeout(()=> updateDesktopStackClass(), 150);
    };
  })();
  function updateKioskAdminMode(){
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    const enable = Boolean(isAdmin && !isMobile() && isKioskViewport());
    document.body.classList.toggle("kioskAdmin", enable);
    updateAdminDesktopLayout();
  }
  function updateDesktopV2Class(){
    const isDesktop = !isMobile() && window.innerWidth >= 1025;
    document.body.classList.toggle("desktopV2", isDesktop);
  }
  const handleDesktopResize = debounce(()=>{
    setHdrH();
    updateDesktopV2Class();
  }, 150);
  function djb2HashBase36(str){
    let h = 5381;
    for(let i=0;i<str.length;i++){
      h = ((h << 5) + h) + str.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h >>> 0).toString(36);
  }
  function stableNorm(val){
    const s = (val==null ? "" : String(val))
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g,"")
      .toLowerCase()
      .replace(/[^a-z0-9_.\-\s]/g," ")
      .replace(/\s+/g," ")
      .trim();
    return s;
  }
  function stableKey(order){
    if(!order) return "o_unknown";
    const explicit = order.orderNo || order.number || order.docNumber || order.id || order.orderId || order.numero;
    if(explicit){
      const cleaned = stableNorm(explicit);
      return `o_${djb2HashBase36(cleaned || String(explicit))}`;
    }
    const firstLine = Array.isArray(order.lines) && order.lines.length ? order.lines[0] : {};
    const customer = stableNorm(order.customer || order.cliente || "");
    const product = stableNorm(firstLine.desc || firstLine.code || "");
    const qtyLabel = stableNorm(`${firstLine.qty ?? ""} ${firstLine.um || firstLine.uom || ""}`);
    const dateLabel = stableNorm(order.conclusion || order.date || order.deliveryDate || "");
    const payload = [customer, product, qtyLabel, dateLabel].filter(Boolean).join("|") || "ordine";
    return `o_${djb2HashBase36(payload)}`;
  }
  function getOrderKey(order){
    if(!order) return "o_unknown";
    if(order.__k) return order.__k;
    const k = stableKey(order);
    try{
      Object.defineProperty(order, "__k", { value:k, writable:false, enumerable:false });
    }catch(_e){
      order.__k = k;
    }
    return k;
  }
  async function fetchWithTimeout(url, ms=15000, opts={}){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    try{
      return await fetch(url, { ...opts, signal: ctrl.signal });
    }finally{
      clearTimeout(t);
    }
  }
  function showToast(title, body, ms=3800){
    $("toastTitle").textContent = title;
    $("toastBody").textContent = body;
    $("toast").classList.add("show");
    setTimeout(()=>$("toast").classList.remove("show"), ms);
  }
  function setBannerOffset(px){
    document.documentElement.style.setProperty("--banner-offset", `${px || 0}px`);
  }
  // Banner annullamento: aggiorna offset per safe-area + padding contenuti
  function showCancelBanner(sub="Lordine  stato annullato."){
    const b = $("cancelBanner");
    const txt = $("cancelBannerSub");
    if(!b || !txt) return;
    txt.textContent = sub;
    b.classList.add("show");
    requestAnimationFrame(()=>{
      const h = b.getBoundingClientRect().height || 0;
      setBannerOffset(h);
    });
  }
  function hideCancelBanner(){
    const b = $("cancelBanner");
    if(!b) return;
    b.classList.remove("show");
    setBannerOffset(0);
  }

  // ===============================
  // BODY LOCK (no background scroll)
  // ===============================
  let _scrollY = 0;
  function lockBody(){
    _scrollY = window.scrollY || 0;
    document.body.classList.add("noscroll");
    document.body.style.top = `-${_scrollY}px`;
    document.body.style.position = "fixed";
    document.body.style.width = "100%";
  }
  function unlockBody(){
    document.body.classList.remove("noscroll");
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.width = "";
    window.scrollTo(0, _scrollY);
  }

  // ===============================
  // BOOT (smooth + fast)
  // ===============================
  const bootFill = $("bootFill");
  const bootMsg = $("bootMsg");
  let bootP = 0;
  function bootSet(p, msg){
    bootP = Math.max(bootP, Math.min(100, p));
    bootFill.style.width = bootP.toFixed(0)+"%";
    if(msg) bootMsg.textContent = msg;
  }
  async function boot(){
    if(globalThis.__BOOT_DONE__){
      const startup = $("startup");
      if(startup) startup.style.display = "none";
      return;
    }
    globalThis.__BOOT_DONE__ = true;
    // Boot super smooth: UI sempre pronta, sync in parallelo (mai blocco al 90%)
    bootSet(10, "AVVIO: inizializzazione interfaccia");
    await new Promise(r=>setTimeout(r, 220));

    bootSet(25, "DOWNLOAD: ordini in corso");
    const ordersPromise = queuedSyncOrders(true, "boot");

    bootSet(45, "SYNC: produzione in corso");
    const livePromise = initLiveSync();

    // Non restare appeso: dopo 3.2s entri comunque nellhub (sync continua)
    await Promise.race([ordersPromise, new Promise(r=>setTimeout(r, 3200))]);

    bootSet(80, "OTTIMIZZAZIONE: finalizzazione");
    await Promise.race([livePromise, new Promise(r=>setTimeout(r, 1200))]);

    bootSet(100, "OK: pronto");
    await new Promise(r=>setTimeout(r, 140));
    $("startup").style.display = "none";

    showToast(
      "Operativit",
      "Per avviare un ordine: VAI IN PRODUZIONE  scegli operatore  seleziona righe  INIZIA PRODUZIONE."
    );
  }

  // ===============================
  // XML -> Orders (snello)
  // ===============================
  function detectPackKg(desc){
    const s = norm(desc||"").replace(/,/g,".");
    if(!s) return null;
    const kgAhead = s.match(/(\d+(?:\.\d+)?)[x\-\s]*kg\b/);
    if(kgAhead){
      const v = parseFloat(kgAhead[1]);
      if(Number.isFinite(v) && v>0) return v;
    }
    const kgAfter = s.match(/\bkg[x\-\s]*(\d+(?:\.\d+)?)/);
    if(kgAfter){
      const v = parseFloat(kgAfter[1]);
      if(Number.isFinite(v) && v>0) return v;
    }
    const kgNear = s.match(/(\d+(?:\.\d+)?)[\s]*(?:kg|chilogrammi)\b/);
    if(kgNear){
      const v = parseFloat(kgNear[1]);
      if(Number.isFinite(v) && v>0) return v;
    }
    const gMatch = s.match(/(\d+(?:\.\d+)?)[x\-\s]*(?:gr|g|grammi)\b/);
    if(gMatch){
      const v = parseFloat(gMatch[1]);
      if(Number.isFinite(v) && v>0) return v/1000;
    }
    const packFromBag = s.match(/\b(sacchi|sacchetti|sacco|sacchetto)\s*(?:da\s*)?(\d+(?:\.\d+)?)/);
    if(packFromBag){
      const v = parseFloat(packFromBag[2]);
      if(Number.isFinite(v) && v>0) return v;
    }
    return null;
  }
  function resolveQtyKg(ctx={}){ // CODEX: sorgente di verit qty -> kg
    const qty = parseItNumber(ctx.qty ?? ctx.quantity);
    if(!Number.isFinite(qty) || qty<=0) return 0;

    const umCandidates = [ctx.um, ctx.uom, ctx.unitaMisura, ctx.unit, ctx.measure];
    const rawUm = umCandidates.find(u => u!=null && String(u).trim()!=="") || "";
    const upperUm = rawUm.toString().toUpperCase().replace(/\./g,"");
    const hasPieces = /\b(PZ|PZS|PCS?|PCE|PEZ|PEZZ[IO]?|NR|SAC|SACCO|SACCHI|SACCHETTO|SACCHETTI|SACCH)\b/.test(upperUm);
    const hasKg = /\bKG\b/.test(upperUm);
    const isKg = hasKg && !hasPieces;
    const isPieces = hasPieces;

    let packKg = ctx.packKg;
    if(!(Number.isFinite(packKg) && packKg>0)){
      const descTxt = ctx.desc || ctx.description || "";
      const detected = detectPackKg(descTxt);
      if(Number.isFinite(detected) && detected>0){
        packKg = detected;
      } else if(rawUm || descTxt){
        const combo = detectPackKg(`${descTxt} ${rawUm}`.trim());
        if(Number.isFinite(combo) && combo>0) packKg = combo;
      }
    }
    const packVal = Number(packKg);
    const hasPack = Number.isFinite(packVal) && packVal>0;

    if(isKg) return qty;
    if(isPieces){
      if(hasPack) return qty * packVal;
      return qty;
    }
    // Anti-inflazione: se ambiguo non moltiplicare
    return qty;
  }
  window.__resolveQtyKg = resolveQtyKg;
  window.__detectPackKg = detectPackKg;
  function detectAlertLine(desc){
    const rawText = desc || "";
    const t = (rawText||"").toUpperCase();
    if(t.includes("SACCHETTO BIANCO")){
      return { label: "SACCHETTO BIANCO", color: "white" };
    }
    const s = norm(rawText);
    if(!s) return null;
    if(!/\b(sacco|sacchetto|bobina)\b/.test(s)) return null;
    const colorMatch = s.match(/\b(blu|azzur\w+|ross\w+|bianc\w+|ner\w+|verd\w+|giall\w+)\b/);
    if(!colorMatch) return null;
    if(/\b(rame|zolfo|caolino|ossicloruro|poltiglia|zeolite)\b/.test(s)) return null;
    const rawColor = colorMatch[1];
    const color = rawColor.includes("azzur")||rawColor.includes("blu") ? "blue"
      : rawColor.includes("ross") ? "red"
      : rawColor.includes("bianc") ? "white"
      : rawColor.includes("ner") ? "black"
      : rawColor.includes("verd") ? "green"
      : rawColor.includes("giall") ? "yellow"
      : "other";
    return { label: (desc||"").trim() || "Avviso", color };
  }
  function machineHintFromLines(lines){
    const packs = [];
    for(const l of (lines||[])){
      if(l.alertInfo) continue;
      const direct = Number(l.packKg);
      const fallback = detectPackKg(l.desc || "");
      const val = Number.isFinite(direct) && direct>0 ? direct : (Number.isFinite(fallback) && fallback>0 ? fallback : null);
      if(val!=null) packs.push(val);
    }
    if(!packs.length) return "large";
    const maxPack = Math.max(...packs);
    if(maxPack >= 5) return "large";
    if(maxPack > 0) return "small";
    return "large";
  }
  function alertPalette(kind){
    switch(kind){
      case "blue": return { bg:"rgba(46,123,255,.12)", border:"rgba(46,123,255,.35)", color:"#0a3a7d" };
      case "red": return { bg:"rgba(255,59,48,.14)", border:"rgba(255,59,48,.4)", color:"#8a1f1a" };
      case "white": return { bg:"rgba(255,255,255,.92)", border:"rgba(255,255,255,.35)", color:"#1c1c1e", shadow:"0 1px 0 rgba(0,0,0,.04), 0 10px 22px rgba(0,0,0,.08)" };
      case "black": return { bg:"#1c1c1e", border:"rgba(0,0,0,.6)", color:"#f5f5f7" };
      case "green": return { bg:"rgba(52,199,89,.14)", border:"rgba(52,199,89,.38)", color:"#0b5d2a" };
      case "yellow": return { bg:"rgba(255,204,0,.18)", border:"rgba(255,204,0,.36)", color:"#5c3b00" };
      default: return { bg:"rgba(0,0,0,.05)", border:"rgba(0,0,0,.12)", color:"#1c1c1e" };
    }
  }
  // CODEX: helper locale per banner sacchetto bianco
  function isWhiteBagRow(row){
    if(!row || typeof row !== "object") return false;
    for(const v of Object.values(row)){
      if(typeof v !== "string") continue;
      const t = v.toUpperCase();
      if(t.includes("**")) return true;
      if(t.includes("SACCHETTO BIANCO")) return true;
    }
    return false;
  }
  function isNonProductionLine(row){
    return isWhiteBagRow(row);
  }
  const kioskAspectMq = (typeof window !== "undefined" && window.matchMedia) ? window.matchMedia("(min-aspect-ratio: 16/10)") : null;
  // CODEX: riposizionamento Statistiche su desktop (colonna sinistra)
  const statsDesktopMq = window.matchMedia("(min-width: 1024px)");
  function relocateStatsCard(){
    const statsCard = $("statsProdCard");
    const anchor = $("statsCardAnchor");
    const opsCard = $("opsCard");
    if(!statsCard || !anchor || !opsCard) return;
    const anchorParent = anchor.parentElement;
    if(anchorParent && statsCard.parentElement !== anchorParent){
      anchorParent.insertBefore(statsCard, anchor.nextElementSibling);
    }
  }
  relocateStatsCard();
  // CODEX: render helper per banner sacchetto bianco
  function renderWhiteBagBanner(opts={}){
    const { selectable=true, checked=false, badgeText="" } = opts;
    const badgeLabel = badgeText || (checked ? "" : "Seleziona");
    const badgeHtml = selectable ? `<div class="badge">${badgeLabel}</div>` : "";
    return `
      <div class="whiteBagBanner" role="note" aria-label=" SACCHETTO BIANCO  Devi usare il sacchetto bianco">
        <div class="icon"></div>
        <div class="txt">
          <div class="t">SACCHETTO BIANCO</div>
          <div class="s"> Devi usare il sacchetto bianco</div>
        </div>
        ${badgeHtml}
      </div>
    `;
  }

  function isPowderLine(code, desc, um){
    const c = norm(code).replace(/\s+/g,"");
    if(c && NON_PERTINENT_CODES.has(c)) return false;

    const s = norm(desc);
    const u = norm(um);

    if(/\b(mastice)\b/.test(s)) return false;
    if(/\b(secchio|tanica|flacone|bottiglia|spray|trigger|pompa|nebul|olio|shampoo|deterg|repel|bio)\b/.test(s)) return false;
    if(/\b\d+(?:[\.,]\d+)?\s*(ml|l|lt)\b/.test(s)) return false;
    if(u === "l" || u === "lt" || u === "ml") return false;

    const packKg = detectPackKg(desc);
    const isBigBag = /\b(big\s*bag|bigbag)\b/.test(s);
    if(packKg != null && packKg > 10.0001 && !isBigBag) return false;
    if(isBigBag && packKg != null && packKg >= 100) return true;

    if(/\b(sacco|sacchetto|busta|bustina|barattolo)\b/.test(s)) return true;
    if(u === "kg" || u === "g") return true;
    if(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/.test(s)) return true;

    if(/\b(ossicloruro|poltiglia|caolino|zeolite|zolfo|rame|solfato|idrossido|tribasico|diatomite|agroblumagic|corrobor)\b/.test(s)) return true;

    return false;
  }

  function materialOf(desc, code=""){
    const s = norm(desc);
    const c = norm(code);
    const has = (re) => re.test(s) || re.test(c);

    if(has(/\b(rame|copper|cupr|cu)\b/) || s.includes("bordolese") || s.includes("poltiglia")) return "rame";
    if(has(/\b(zolfo|sulfur|sulf)\b/)) return "zolfo";
    if(has(/\b(caolino|kaolin|caol)\b/)) return "caolino";
    if(has(/\b(zeolite|zeolit)\b/)) return "zeolite";
    if(has(/\b(diatomite|agroblumagic|corrobor)\b/)) return "corroborante";
    return "altro";
  }

  function cleanShort(desc){
    const s = (desc||"").toString();
    return s
      .replace(/\|\s*CONCIME.*$/i,"")
      .replace(/\|\s*CONSENTITO.*$/i,"")
      .replace(/\|\s*AMMESSO.*$/i,"")
      .replace(/\s{2,}/g," ")
      .trim();
  }
  function extractDocTotal(docNode){
    if(!docNode) return null;
    const tags = ["Total","TotalDoc","TotalDocument","TotalAmount","Amount","DocTotal","TotalWithTax","GrossTotal"];
    for(const tag of tags){
      const val = safeText(docNode.getElementsByTagName(tag)[0]);
      const num = parseCurrencyValue(val);
      if(num!=null) return num;
    }
    return null;
  }

  async function parseEasyfattXml(xmlText){
    const outDocs = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlText, "text/xml");
    const docs = Array.from(doc.getElementsByTagName("Document"));
    for(let di=0; di<docs.length; di++){
      const d = docs[di];
      const customer = safeText(d.getElementsByTagName("CustomerName")[0]) || "Cliente";
      const number = safeText(d.getElementsByTagName("Number")[0]) || "";
      const date = safeText(d.getElementsByTagName("Date")[0]) || "";
      let conclusion = safeText(d.getElementsByTagName("ExpectedConclusion")[0])
        || safeText(d.getElementsByTagName("ExpectedDeliveryDate")[0])
        || safeText(d.getElementsByTagName("DeliveryDate")[0])
        || "";
      const totalDoc = extractDocTotal(d);

      const lines = [];
      const rows = Array.from(d.getElementsByTagName("Row"));
      for(let i=0;i<rows.length;i++){
        if(i && i%90===0) await yieldFrame();
        const r = rows[i];
        const code = safeText(r.getElementsByTagName("Code")[0]) || "";
        const desc = safeText(r.getElementsByTagName("Description")[0]) || safeText(r.getElementsByTagName("Name")[0]) || "";
        const um = safeText(r.getElementsByTagName("UM")[0]) || safeText(r.getElementsByTagName("Unit")[0]) || "";
        let qty = safeText(r.getElementsByTagName("Qty")[0]) || safeText(r.getElementsByTagName("Quantity")[0]) || "0";
        qty = parseFloat(qty.replace(",","."));
        if(!Number.isFinite(qty)) qty = 0;

        const alertInfo = detectAlertLine(desc); // CODEX: banner operativi sacchi/bobine
        const powder = alertInfo ? false : isPowderLine(code, desc, um);
        const packKg = detectPackKg(desc);
        const material = powder ? materialOf(desc, code) : "altro";

        const lineKg = (!powder || alertInfo) ? 0 : resolveQtyKg({ qty, um, packKg, desc });

        const lineKey = `${number}|${i}|${(norm(code)||norm(desc).slice(0,24))}`;

        lines.push({
          lineKey,
          code,
          desc: cleanShort(desc),
          um,
          qty,
          powder,
          packKg,
          lineKg,
          material,
          alertInfo,
        });
      }

      outDocs.push({ customer, number, date, conclusion, totalDoc, lines });
      if(di && di%12===0) await yieldFrame();
    }
    return outDocs;
  }

  async function syncOrders(isBoot=false, reason="manual"){
    try {
      setOnlinePill("warn", "Stato: sincronizzazione");
      const isFirstPass = !loader.firstRenderDone;
      showLoader(isFirstPass ? "Connessione" : "Aggiornamento");
      if(isBoot) bootSet(40, "DOWNLOAD: ordini in corso");

      const res = await fetchWithTimeout(XML_PROXY_CFG.proxyUrl, 16000, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if(j && j.ok === false) throw new Error(j.error || "Proxy: errore");
      const xmlText = j?.xml;
      if(!xmlText || typeof xmlText !== "string") throw new Error("XML mancante");

      state.xmlModifiedTime = j?.modifiedTime || null;
      state.lastFetchAt = Date.now();
      localStorage.setItem(XML_PROXY_CFG.cacheKey, JSON.stringify({ at: state.lastFetchAt, xml: xmlText, modifiedTime: state.xmlModifiedTime }));

      showLoader(isFirstPass ? "Parsing" : "Aggiornamento");
      state.docs = await parseEasyfattXml(xmlText);
      state.fatturatoLordo = computeFatturatoLordo(state.docs); // CODEX: calcolo fatturato lordo da XML

      const powderDocs = [];
      for(const d of state.docs){
        const pLines = d.lines.filter(x=>x.powder);
        if(!pLines.length) continue;
        const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
        const alertLines = d.lines.filter(x=>x.alertInfo);
        powderDocs.push({ customer: d.customer, number: d.number, orderNo: d.number, conclusion: d.conclusion, lines: pLines, alerts: alertLines, totalKg });
      }
      state.powderOrders = powderDocs;
      flushAllowlistPendingRender();

      showLoader(isFirstPass ? "Rendering 1/3" : "Aggiornamento");
      renderHome();
      setOnlinePill("ok", "Stato: online");
      if(isBoot) bootSet(62, "OK: ordini aggiornati");
      loader.inError = false;
      if(loader.firstRenderDone){
        hideLoader();
      } else {
        requestAnimationFrame(()=> markFirstRenderDone());
      }
      resetSyncBackoff();

    } catch(err) {
      console.warn("syncOrders failed", err);
      showLoaderError("Connessione instabile. Riprovo");
      const cached = localStorage.getItem(XML_PROXY_CFG.cacheKey);
      if(cached){
        try {
          const c = JSON.parse(cached);
          state.lastFetchAt = c.at || null;
          state.xmlModifiedTime = c.modifiedTime || null;
          state.docs = await parseEasyfattXml(c.xml||"");
          state.fatturatoLordo = computeFatturatoLordo(state.docs); // CODEX: calcolo fatturato da cache
          const powderDocs = [];
          for(const d of state.docs){
            const pLines = d.lines.filter(x=>x.powder);
            if(!pLines.length) continue;
            const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
            const alertLines = d.lines.filter(x=>x.alertInfo);
            powderDocs.push({ customer: d.customer, number: d.number, orderNo: d.number, conclusion: d.conclusion, lines: pLines, alerts: alertLines, totalKg });
          }
          state.powderOrders = powderDocs;
          flushAllowlistPendingRender();
        } catch(_e) {}
      }
      renderHome();
      setOnlinePill("bad", "Stato: offline (cache)");
      if(isBoot) bootSet(55, "Connessione lenta uso cache locale");
      if(!loader.firstRenderDone){
        requestAnimationFrame(()=> markFirstRenderDone());
      }
      scheduleSyncRetry();
    }
  }

  function setOnlinePill(kind, text){
    const dot = $("dotOnline");
    dot.className = "dot";
    if(kind==="ok") dot.classList.add("ok");
    if(kind==="warn") dot.classList.add("warn");
    if(kind==="bad") dot.classList.add("bad");
    $("txtOnline").textContent = text;
  }
  async function queuedSyncOrders(isBoot=false, reason="manual"){
    if(syncInFlight){
      syncQueued = true;
      return currentSyncPromise;
    }
    syncInFlight = true;
    currentSyncPromise = (async()=>{
      try{
        await syncOrders(isBoot, reason);
      }finally{
        syncInFlight = false;
        if(syncQueued){
          syncQueued = false;
          return queuedSyncOrders(false, "queued");
        }
      }
    })();
    return currentSyncPromise;
  }
  let refreshInFlight = false;
  const debounceRefresh = (()=>{ let t=null; return (reason)=>{ clearTimeout(t); t=setTimeout(()=>triggerRefresh(reason), 180); }; })(); // CODEX: debounce auto-refresh (focus/visibility/pageshow)
  async function triggerRefresh(reason="manual"){
    // Refresh leggero per mobile (focus/pageshow/cta)
    if(refreshInFlight) return;
    refreshInFlight = true;
    try{
      await queuedSyncOrders(false, reason);
      renderHome();
      if(reason==="focus" || reason==="pageshow") showToast("Aggiornato", "Dati ricaricati (riapertura).", 1800);
    }finally{
      refreshInFlight = false;
    }
  }
  function setRefreshError(hasError){
    const btn = $("btnHeaderRefresh");
    const badge = $("refreshErrBadge");
    if(btn) btn.classList.toggle("hasError", !!hasError);
    if(badge) badge.style.display = hasError ? "inline-flex" : "none";
  }
  function wireHeaderRefresh(){
    if(globalThis.__REFRESH_BTN_BOUND__) return;
    const btn = $("btnHeaderRefresh");
    if(!btn) return;
    globalThis.__REFRESH_BTN_BOUND__ = true;
    btn.addEventListener("click", async()=>{
      if(globalThis.__updateInFlight__ || refreshInFlight || syncInFlight) return;
      setRefreshError(false);
      btn.classList.add("isSpinning");
      let ok = false;
      try{
        await triggerRefresh("manual_btn");
        ok = !loader.inError;
      }catch(err){
        console.warn("manual refresh failed", err);
      }finally{
        setTimeout(()=> btn.classList.remove("isSpinning"), 850);
        if(!ok) setRefreshError(true);
      }
    });
  }

  
  
  function humanAuthErr(err){
    const code = (err && (err.code||err.message||"")).toString();
    const map = {
      "auth/unauthorized-domain": "Dominio non autorizzato. Verifica in Firebase: Authentication  Settings  Domini autorizzati.",
      "auth/operation-not-allowed": "Provider Google non abilitato. Verifica in Firebase: Authentication  Sign-in method.",
      "auth/popup-blocked": "Popup bloccato dal browser. Riprovo con reindirizzamento",
      "auth/popup-closed-by-user": "Popup chiuso. Riprova.",
      "auth/cancelled-popup-request": "Richiesta annullata. Riprova.",
      "auth/network-request-failed": "Connessione instabile. Riprova tra qualche secondo.",
      "auth/invalid-api-key": "Config Firebase non valida (apiKey).",
      "auth/invalid-oauth-client-id": "Client OAuth non valido (Google). Controlla la configurazione Web SDK.",
      "auth/redirect-cancelled-by-user": "Accesso annullato. Riprova.",
      "auth/redirect-operation-pending": "Accesso gi in corso. Attendi e riprova."
    };
    for (const k in map){ if(code.includes(k)) return map[k]; }
    return "Errore accesso. Controlla rete e riprova.";
  }

// ===============================
  // AUTH (Google / Email + allowlist email)
  // ===============================
  const USERS_COL = "powderUsers";
  // const ACCESS_COL removed (using USERS_COL allowlist)
function showAuthGate(){
    hideAuthLoader();
    $("authGate").classList.add("show");
    lockBody();
  }
  function hideAuthGate(){
    $("authGate").classList.remove("show");
    unlockBody();
  }
  function recentAuthOkWithinTTL(){
    try{
      const ts = parseInt(localStorage.getItem(LS_AUTH_OK) || "0", 10);
      if(!Number.isFinite(ts) || ts<=0) return false;
      return (Date.now() - ts) < AUTH_TTL_MS;
    }catch(_e){ return false; }
  }
  function markAuthOk(email=""){
    try{
      localStorage.setItem(LS_AUTH_OK, String(Date.now()));
      if(email) localStorage.setItem(LS_AUTH_EMAIL, String(email));
    }catch(_e){}
  }
  function clearAuthOk(){
    try{ localStorage.removeItem(LS_AUTH_OK); }catch(_e){}
    try{ localStorage.removeItem(LS_AUTH_EMAIL); }catch(_e){}
  }
  function setAuthGateState(next){
    authGateState = next;
  }
  function showAppShell(){
    const wrap = document.querySelector(".wrap");
    if(wrap){
      wrap.style.visibility = "visible";
      wrap.style.pointerEvents = "auto";
    }
  }
  function showApp(){
    showAppShell();
    hideLogin();
    hideAuthLoader();
  }
  function showAuthLoader(msg="Verifica accesso"){
    const el = $("authLoader");
    if(!el) return;
    const txt = el.querySelector(".txt");
    if(txt) txt.textContent = msg;
    el.classList.add("show");
  }
  function hideAuthLoader(){
    const el = $("authLoader");
    if(el) el.classList.remove("show");
  }
  function hideLogin(){
    hideAuthGate();
  }
  function showLogin(msg=""){
    setAuthGateState("signed_out");
    hideAuthLoader();
    renderAuthLogin(msg);
  }
  function clearRestoreTimeout(){
    if(globalThis.__RESTORE_TIMER__){
      clearTimeout(globalThis.__RESTORE_TIMER__);
      globalThis.__RESTORE_TIMER__ = null;
    }
    restoreExpireHandler = null;
  }
  function startOrKeepRestoreTimeout(onExpire){
    if(typeof onExpire === "function"){
      restoreExpireHandler = onExpire;
    }
    if(globalThis.__RESTORE_TIMER__) return;
    globalThis.__RESTORE_TIMER__ = setTimeout(()=>{
      globalThis.__RESTORE_TIMER__ = null;
      const auth = state.firebase?.auth;
      if(auth && auth.currentUser){
        setAuthGateState("signed_in");
        hideAuthLoader();
        hideLogin();
        return;
      }
      if(typeof restoreExpireHandler === "function"){
        restoreExpireHandler();
      }
    }, RESTORE_TIMEOUT_MS);
  }
  function enterRestoringMode(message="Ripristino sessione"){
    setAuthGateState("restoring");
    showAppShell();
    hideLogin();
    showAuthLoader(message);
  }
  function primeAuthGateUi(){
    if(isMobile() && recentAuthOkWithinTTL()){
      enterRestoringMode("Ripristino sessione");
      return;
    }
    setAuthGateState("unknown");
    showAppShell();
    hideLogin();
    showAuthLoader("Verifica accesso");
  }
  async function getAccessByEmail(email){
    const e = String(email||"").trim().toLowerCase();
    if(!e) return null;
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, e);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||null) : null;
  }

  function renderAuthDenied(email, reason=""){
    setAuthGateState("signed_out");
    hideAuthLoader();
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso non abilitato</div>
      <div class="muted">Questa email non risulta autorizzata ad accedere allhub.</div>
      <div style="height:10px"></div>
      <div class="pill" style="display:inline-block;background:#fff3f2;color:#8a1f1a;border:1px solid #ffd1cd;">${escapeHtml(email||"")}</div>
      ${reason ? `<div style="height:10px"></div><div class="muted">${escapeHtml(reason)}</div>` : ``}
      <div style="height:14px"></div>
      <button id="btnLogout" class="btn bad" type="button">Esci</button>
      <div style="height:8px"></div>
      <div class="muted">Se serve, chiedi allamministrazione di abilitare la tua email.</div>
    `;
    $("btnLogout").onclick = async () => {
      try{ await state.firebase.authApi.signOut(state.firebase.auth); }catch(e){}
      renderAuthLogin("");
    };
  }



  function renderAuthLogin(msg=""){
    setAuthGateState("signed_out");
    hideAuthLoader();
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso richiesto</div>
      <div class="muted">${msg || "Accedi per iniziare. Se la tua email non  autorizzata, contatta un amministratore."}</div>
      <div style="height:12px"></div>

      <button class="btn good" id="btnGoogle" style="width:100%;">Accedi con Google</button>
      <div style="height:10px"></div>

      <div class="divider"></div>
      <div class="stepTitle" style="font-size:16px; margin-top:0;">Oppure con email</div>

      <div class="authRow">
        <div class="field">
          <label>Nome</label>
          <input id="authName" autocomplete="given-name" placeholder="Nome" />
        </div>
        <div class="field">
          <label>Cognome</label>
          <input id="authSurname" autocomplete="family-name" placeholder="Cognome" />
        </div>
      </div>
      <div class="field">
        <label>Email</label>
        <input id="authEmail" type="email" autocomplete="email" placeholder="nome@azienda.it" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="authPass" type="password" autocomplete="current-password" placeholder="Password" />
      </div>

      <div class="row2">
        <button class="btn" id="btnEmailLogin">Accedi</button>
        <button class="btn ghost" id="btnEmailSignup">Crea account</button>
      </div>

      <div style="height:12px"></div>
      <div class="muted">Nota: la pagina resta sempre in italiano.</div>
    `;

    b.querySelector("#btnGoogle").onclick = async()=>{
      const authApi = state.firebase.authApi;
      const auth = state.firebase.auth;
      const prov = new authApi.GoogleAuthProvider();
      state.lastAuthErrorMsg = "";
      // Provo popup (pi veloce). Se bloccato, fallback su redirect (pi stabile su mobile).
      try{
        await authApi.signInWithPopup(auth, prov);
      }catch(err){
        console.warn("Google popup error", err);
        const msg = humanAuthErr(err);
        if((err && err.code==="auth/popup-blocked") || (err && err.code==="auth/operation-not-supported-in-this-environment")){
          showToast("Accesso", msg);
          try{
            await authApi.signInWithRedirect(auth, prov);
            return;
          }catch(err2){
            console.warn("Google redirect error", err2);
            state.lastAuthErrorMsg = humanAuthErr(err2);
            renderAuthLogin(state.lastAuthErrorMsg);
            return;
          }
        }
        state.lastAuthErrorMsg = msg;
        showToast("Accesso", msg);
      }
    };

    b.querySelector("#btnEmailLogin").onclick = async()=>{
      const email = b.querySelector("#authEmail").value.trim();
      const pass  = b.querySelector("#authPass").value;
      if(!email || !pass){
        showToast("Accesso", "Inserisci email e password.");
        return;
      }
      try{
        const authApi = state.firebase.authApi;
        await authApi.signInWithEmailAndPassword(state.firebase.auth, email, pass);
      }catch(err){
        console.warn(err);
        showToast("Accesso", "Credenziali non valide o account inesistente.");
      }
    };

    b.querySelector("#btnEmailSignup").onclick = async()=>{
      const name = b.querySelector("#authName").value.trim();
      const sur  = b.querySelector("#authSurname").value.trim();
      const email = b.querySelector("#authEmail").value.trim();
      const pass  = b.querySelector("#authPass").value;
      if(!name || !sur || !email || !pass){
        showToast("Registrazione", "Compila nome, cognome, email e password.");
        return;
      }
      try{
        const authApi = state.firebase.authApi;
        const cred = await authApi.createUserWithEmailAndPassword(state.firebase.auth, email, pass);
        await upsertUserProfile(cred.user, { fullName: `${name} ${sur}`, name, surname: sur, email });
      }catch(err){
        console.warn(err);
        showToast("Registrazione", "Impossibile creare laccount (email gi usata o password debole).");
      }
    };
  }

  async function upsertUserProfile(user, fields){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, user.uid);
    await fs.setDoc(ref, { uid:user.uid, ...fields, updatedAt: nowIso(), createdAt: nowIso() }, { merge:true });
  }

  async function loadUserProfile(uid){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, uid);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||{}) : null;
  }

  let __fsUnsub = null;
  let __fsRetryT = null;
  let __fsBackoffMs = 1500;
  const __fsBackoffMax = 60000;
  let __fsLastErrLog = 0;
  let __fsVisT = null;
  let __fsLifecycleBound = false;

  function __fsStopListen(){
    if(__fsUnsub){
      try{ __fsUnsub(); }catch(_e){}
      __fsUnsub = null;
    }
    if(__fsRetryT){
      clearTimeout(__fsRetryT);
      __fsRetryT = null;
    }
  }

  function __fsStartListen(){
    if(__fsUnsub) return;
    if(__fsRetryT){ clearTimeout(__fsRetryT); __fsRetryT = null; }
    if(!state.firebase.ok || !state.user) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    if(!fs || !db) return;
    try{
      const col = fs.collection(db, "powderProductions");
      const hcol = fs.collection(db, "powderProdHistory");
      const unsubs = [];

      const onErr = (err)=>{
        const now = Date.now();
        if(!__fsLastErrLog || (now - __fsLastErrLog) > 10000){
          console.warn("onSnapshot error", err);
          __fsLastErrLog = now;
        }
        __fsStopListen();
        if(navigator.onLine === false) return;
        __fsBackoffMs = Math.min(__fsBackoffMax, __fsBackoffMs * 2);
        const jitter = Math.floor(Math.random() * 251);
        __fsRetryT = setTimeout(()=>{ __fsRetryT = null; __fsStartListen(); }, __fsBackoffMs + jitter);
      };

      const activeNext = (snap)=>{
        const arr = [];
        snap.forEach(doc=>arr.push({ id: doc.id, ...doc.data() }));
        state.activeProductions = arr.filter(x=>x && x.active);
        renderHome();
        __fsBackoffMs = 1500;
      };

      const histNext = (snap)=>{
        const hist = [];
        snap.forEach(doc=>hist.push({ id: doc.id, ...doc.data() }));
        const resetAfter = getStatsClearTs();
        const filtered = resetAfter ? hist.filter(h=> tsFromId(h.id||h.at||0) > resetAfter) : hist;
        state.history = filtered;
        state.historyReady = true;
        renderStats();
        renderHeaderKpis();
        try{ renderCompletedSection(); }catch(_e){}
        try{ renderPartialBanner && renderPartialBanner(); }catch(_e){}
        __fsBackoffMs = 1500;
      };

      unsubs.push(fs.onSnapshot(col, activeNext, onErr));
      try {
        unsubs.push(fs.onSnapshot(hcol, histNext, onErr));
      } catch(_e) {}

      __fsUnsub = ()=>{
        for(const u of unsubs){
          try{ u && u(); }catch(_e){}
        }
        __fsUnsub = null;
      };
    }catch(err){
      const now = Date.now();
      if(!__fsLastErrLog || (now - __fsLastErrLog) > 10000){
        console.warn("snapshot start failed", err);
        __fsLastErrLog = now;
      }
    }
  }

  function __fsBindLifecycle(){
    if(__fsLifecycleBound) return;
    __fsLifecycleBound = true;
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "hidden"){
        __fsStopListen();
      } else {
        if(__fsVisT){ clearTimeout(__fsVisT); }
        __fsVisT = setTimeout(()=>{ __fsVisT = null; __fsStartListen(); }, 300);
      }
    });
    window.addEventListener("online", ()=>{ __fsBackoffMs = 1500; __fsStartListen(); });
    window.addEventListener("offline", ()=>{ __fsStopListen(); });
  }

  function resetAuthDependentState(){
    __fsStopListen();
    state.historyReady = false;
    state.history = [];
    if(state.notifUnsub){
      try{ state.notifUnsub(); }catch(_e){}
      state.notifUnsub = null;
    }
    state.notifications = { inbox: [], ready:false, unavailable:false, error:"" };
    updateNotificationBadge();
    renderNotifCenter();
    renderHeaderKpis();
    state.user = null;
    state.operator = null;
    applyRoleClasses();
    updateKioskAdminMode();
    $("hdrUser").textContent = "";
  }
  function enterSignedOut(msg=""){
    clearRestoreTimeout();
    clearAuthOk();
    setAuthGateState("signed_out");
    hideAuthLoader();
    resetAuthDependentState();
    renderAuthLogin(msg);
  }

  async function ensureAuthFlow(){
    // chiamata dopo init firebase
    const authApi = state.firebase.authApi;
    const auth = state.firebase.auth;

    primeAuthGateUi();

    // Gestisci redirect result (mostra errori)
    try{
      await authApi.getRedirectResult(auth);
    }catch(e){
      console.warn("getRedirectResult error", e);
      state.lastAuthErrorMsg = humanAuthErr(e);
    }
    if(globalThis.__AUTH_LISTENER_BOUND__) return;
    globalThis.__AUTH_LISTENER_BOUND__ = true;
    authApi.onAuthStateChanged(auth, async(user)=>{
      clearRestoreTimeout();
      if(!user){
        __fsStopListen();
      }
      if(!user){
        const msg = state.lastAuthErrorMsg || "";
        state.lastAuthErrorMsg = "";
        if(isMobile() && recentAuthOkWithinTTL()){
          enterRestoringMode("Ripristino sessione");
          startOrKeepRestoreTimeout(()=> enterSignedOut(msg));
          return;
        }
        enterSignedOut(msg);
        return;
      }

      setAuthGateState("signed_in");
      showApp();
      markAuthOk(user.email || "");

      // profilo
      let profile = await loadUserProfile(user.uid);
      if(!profile){
        const dn = (user.displayName||"").trim();
        profile = { fullName: dn || user.email || "" , email: user.email||"" };
        await upsertUserProfile(user, profile);
      } else {
        // assicurati fullName
        if(!profile.fullName){
          const dn = (user.displayName||"").trim();
          profile.fullName = dn || user.email || "";
          await upsertUserProfile(user, { fullName: profile.fullName, email: user.email||"" });
        }
      }
      // allowlist email
      const access = await getAccessByEmail(user.email||"");
      if(!access || access.enabled === false){
        clearAuthOk();
        resetAuthDependentState();
        renderAuthDenied(user.email||"", access && access.enabled===false ? "Accesso disabilitato." : "Email non presente in elenco autorizzati.");
        return;
      }


      // usa displayName da allowlist se presente (coerente per reparto)
      if(access && access.displayName){ profile.fullName = access.displayName; }

      state.user = { uid: user.uid, fullName: profile.fullName, email: (user.email||profile.email||""), isAdmin: Boolean(access && access.isAdmin) };
      state.operator = state.user.fullName;
      $("hdrUser").textContent = state.user.fullName;
      applyRoleClasses();
      guardAdminAccessOnMobile();
      bindAdminHashGuard();
      try{ await loadGlobalStats(); }catch(_e){ applyGlobalStats(getGlobalStatsData(), state.globalStats?.source||"local"); }
      renderHeaderKpis();
      updateKioskAdminMode();
      try{ await initNotificationsInbox(); }catch(_e){ state.notifications.unavailable = true; renderNotifCenter(); }
      renderNotifCenter();
      hideAuthGate();
      hideAuthLoader();
      renderHome();
      ensureAllowlistListener();
      __fsStartListen();
    });
  }
  function handleAuthResume(){
    if(!isMobile()) return;
    if(authGateState === "signed_out") return;
    if(!recentAuthOkWithinTTL()) return;
    if(!state.firebase?.auth) return;
    enterRestoringMode("Ripristino sessione");
    startOrKeepRestoreTimeout(()=> enterSignedOut(""));
  }
  function wireAuthResumeHandlers(){
    if(globalThis.__AUTH_RESUME_BOUND__) return;
    globalThis.__AUTH_RESUME_BOUND__ = true;
    const resume = ()=> handleAuthResume();
    window.addEventListener("pageshow", resume);
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "visible") resume();
    });
    window.addEventListener("focus", resume);
  }


  // ===============================
  // LIVE SYNC (Firestore) - lazy import
  // ===============================
  async function initLiveSync(){
    try {
      const timeoutMs = 5500;
      const t = new Promise((_,rej)=>setTimeout(()=>rej(new Error("firebase timeout")), timeoutMs));

      const apiPromise = (async()=>{
        const { initializeApp } = await import(FIREBASE_IMPORT_APP);
        const fs = await import(FIREBASE_IMPORT_FS);
        const fa = await import(FIREBASE_IMPORT_AUTH);
        const fm = await import(FIREBASE_IMPORT_MSG);

        try{ fs.setLogLevel && fs.setLogLevel("error"); }catch(_e){}

        const app = initializeApp(firebaseConfig);
        const db = fs.initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
        const auth = fa.getAuth(app);
        let messaging = null;

        try { await fa.setPersistence(auth, fa.browserLocalPersistence); } catch(_e){}

        state.firebase.ok = true;
        state.firebase.db = db;
        state.firebase.api = fs;
        state.firebase.authApi = fa;
        state.firebase.auth = auth;
        state.firebase.msgApi = fm;
        try{ state.push.supported = await fm.isSupported(); }catch(_e){ state.push.supported = false; }
        if(state.push.supported){
          try{ messaging = fm.getMessaging(app); }catch(_e){ messaging = null; }
        }
        state.firebase.messaging = messaging;
      })();

      await Promise.race([apiPromise, t]);

      // Auth flow gate
      await ensureAuthFlow();
      __fsBindLifecycle();
      __fsStartListen();

    } catch(err) {
      console.warn("Firebase init failed:", err);
      state.firebase.ok = false;
      state.notifications.unavailable = true;
      renderNotifCenter();
      updateNotificationBadge();
      renderHome();
      renderAuthLogin("Connessione Firebase non disponibile. Verifica rete o contatta il responsabile.");
    }
  }

  async function upsertActiveProduction(prod){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = prod.id || `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { ...prod, id, active:true }, { merge:true });
    return id;
  }

  async function closeActiveProduction(id, payload={}){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { active:false, closedAt: nowIso(), ...payload }, { merge:true });
  }

  async function addHistory(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdHistory", id), { ...entry, id, at: nowIso(), concludedAt: entry.endedAt || nowIso() });
    return id;
  }

  function mobileAllowlistDoc(fs, db){
    return fs.doc(db, ALLOW_PATH.col, ALLOW_PATH.doc);
  }
  function fmtAllowlistTs(raw){
    try{
      const dt = raw && typeof raw.toDate==="function" ? raw.toDate() : raw ? new Date(raw) : null;
      if(dt && Number.isFinite(dt.getTime())) return fmtDateTime(dt);
    }catch(_e){}
    return "";
  }
  function ensureAllowCommittedSet(){
    if(!(globalThis.__allowCommitted instanceof Set)){
      const base = (globalThis.__ALLOW_KEYS__ instanceof Set) ? globalThis.__ALLOW_KEYS__ : new Set();
      globalThis.__allowCommitted = new Set(Array.from(base));
    }
    return globalThis.__allowCommitted;
  }
  function ensureAllowDraftSet(){
    if(!(globalThis.__allowDraft instanceof Set)){
      const committed = ensureAllowCommittedSet();
      globalThis.__allowDraft = new Set(Array.from(committed));
    }
    return globalThis.__allowDraft;
  }
  function refreshAllowDirtyFlag(){
    const draft = ensureAllowDraftSet();
    const committed = ensureAllowCommittedSet();
    let dirty = draft.size !== committed.size;
    if(!dirty){
      for(const k of draft){
        if(!committed.has(k)){
          dirty = true;
          break;
        }
      }
      if(!dirty){
        for(const k of committed){
          if(!draft.has(k)){
            dirty = true;
            break;
          }
        }
      }
    }
    state.mobileAllowDirty = dirty;
    globalThis.__allowDraftDirty = dirty;
  }
  let __allowRenderTimer = null;
  let __allowResetTimer = null;
  function scheduleAllowlistRender(){
    if(!state.powderOrders || !state.powderOrders.length){
      state.mobileAllowlist.pendingRender = true;
      return;
    }
    state.mobileAllowlist.pendingRender = false;
    clearTimeout(__allowRenderTimer);
    __allowRenderTimer = setTimeout(()=>{
      renderHome();
    }, 100);
  }
  function flushAllowlistPendingRender(){
    if(state.mobileAllowlist?.pendingRender && state.powderOrders && state.powderOrders.length){
      scheduleAllowlistRender();
    }
  }
  let __allowUnsub = null;
  async function ensureAllowlistListener(){
    if(globalThis.__ALLOWLIST_LISTEN_STARTED__) return;
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    if(!fs || !db) return;
    globalThis.__ALLOWLIST_LISTEN_STARTED__ = true;
    try{
      const ref = mobileAllowlistDoc(fs, db);
      __allowUnsub = fs.onSnapshot(ref, (snap)=>{
        const data = snap.exists() ? (snap.data()||{}) : {};
        const keysArr = Array.isArray(data.keys) ? data.keys.filter(Boolean).map(String) : [];
        const allowSet = new Set(keysArr);
        globalThis.__ALLOW_LOADED__ = true;
        globalThis.__ALLOW_KEYS__ = new Set(keysArr);
        globalThis.__allowCommitted = new Set(keysArr);
        if(!globalThis.__allowDraftDirty){
          globalThis.__allowDraft = new Set(allowSet);
        }
        globalThis.__ALLOW_META__ = {
          updatedAt: data.updatedAt || null,
          updatedBy: data.updatedBy || "",
          lastError: "",
          lastSyncTs: Date.now()
        };
        state.mobileAllowlist = {
          ready: true,
          keys: allowSet,
          updatedAt: data.updatedAt || null,
          updatedBy: data.updatedBy || "",
          allowAll: Boolean(data.allowAll) && snap.exists(),
          docExists: snap.exists(),
          error: "",
          lastError: "",
          lastSyncTs: Date.now(),
          pendingRender: false
        };
        state.mobileAllowSelection = new Set(globalThis.__allowDraft);
        refreshAllowDirtyFlag();
        state.mobileAllowSaveState = "idle";
        scheduleAllowlistRender();
      }, (err)=>{
        console.warn("allowlist snapshot error", err);
        const code = err?.code || "";
        const message = err?.message || String(err);
        globalThis.__ALLOW_LOADED__ = true;
        globalThis.__ALLOW_KEYS__ = new Set();
        globalThis.__allowCommitted = new Set();
        if(!globalThis.__allowDraftDirty){
          globalThis.__allowDraft = new Set();
        }
        globalThis.__ALLOW_META__ = {
          ...(globalThis.__ALLOW_META__||{}),
          lastError: code ? `${code}: ${message}` : message,
          lastSyncTs: Date.now()
        };
        state.mobileAllowlist.error = code || message;
        state.mobileAllowlist.lastError = code || message;
        state.mobileAllowlist.lastSyncTs = Date.now();
        state.mobileAllowlist.ready = true;
        state.mobileAllowlist.keys = new Set();
        state.mobileAllowlist.docExists = false;
        state.mobileAllowlist.allowAll = false;
        state.mobileAllowSelection = new Set();
        state.mobileAllowDirty = false;
        state.mobileAllowSaveState = "error";
        renderHome();
      });
    }catch(err){
      console.warn("allowlist listen failed", err);
      const code = err?.code || "";
      const message = err?.message || String(err);
      globalThis.__ALLOW_LOADED__ = true;
      globalThis.__ALLOW_KEYS__ = new Set();
      globalThis.__allowCommitted = new Set();
      if(!globalThis.__allowDraftDirty){
        globalThis.__allowDraft = new Set();
      }
      globalThis.__ALLOW_META__ = {
        ...(globalThis.__ALLOW_META__||{}),
        lastError: code ? `${code}: ${message}` : message,
        lastSyncTs: Date.now()
      };
      state.mobileAllowlist.error = code || message;
      state.mobileAllowlist.lastError = code || message;
      state.mobileAllowlist.lastSyncTs = Date.now();
      state.mobileAllowlist.ready = true;
      state.mobileAllowlist.keys = new Set();
      state.mobileAllowlist.docExists = false;
      state.mobileAllowlist.allowAll = false;
      state.mobileAllowSelection = new Set();
      state.mobileAllowDirty = false;
      state.mobileAllowSaveState = "error";
    }
  }
  function resetAllowlistInMemory(meta={}){
    globalThis.__ALLOW_LOADED__ = true;
    globalThis.__ALLOW_KEYS__ = new Set();
    globalThis.__allowCommitted = new Set();
    globalThis.__allowDraft = new Set();
    globalThis.__allowDraftDirty = false;
    state.mobileAllowlist = {
      ...(state.mobileAllowlist||{}),
      ready: true,
      keys: new Set(),
      updatedAt: meta.updatedAt || null,
      updatedBy: meta.updatedBy || "",
      allowAll: false,
      docExists: meta.docExists !== false,
      error: "",
      lastError: "",
      lastSyncTs: Date.now(),
      pendingRender: false
    };
    state.mobileAllowSelection = new Set();
    state.mobileAllowDirty = false;
    state.mobileAllowSaveState = "idle";
    globalThis.__ALLOW_META__ = { ...(globalThis.__ALLOW_META__||{}), updatedBy: meta.updatedBy || "", lastError: "", lastSyncTs: Date.now() };
  }
  function handleMobileAllowResetClick(){
    if(state.mobileAllowReset?.status === "saving") return;
    if(state.mobileAllowReset?.confirm){
      performMobileAllowReset();
      return;
    }
    state.mobileAllowReset = { ...(state.mobileAllowReset||{}), confirm:true };
    if(__allowResetTimer) clearTimeout(__allowResetTimer);
    renderMobileAllowPanel(__allOrdersCache, __allOrdersKeySet);
    __allowResetTimer = setTimeout(()=>{
      state.mobileAllowReset = { ...(state.mobileAllowReset||{}), confirm:false };
      renderMobileAllowPanel(__allOrdersCache, __allOrdersKeySet);
    }, 3000);
  }
  async function performMobileAllowReset(){
    if(!(state.user && state.user.isAdmin)){
      state.mobileAllowReset = { confirm:false, status:"error", lastError:"permission-denied" };
      renderMobileAllowPanel(__allOrdersCache, __allOrdersKeySet);
      return;
    }
    if(!state.firebase.ok){
      state.mobileAllowReset = { confirm:false, status:"error", lastError:"firebase-offline" };
      renderMobileAllowPanel(__allOrdersCache, __allOrdersKeySet);
      return;
    }
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = mobileAllowlistDoc(fs, db);
    cleanupLegacyAllowlistCaches();
    state.mobileAllowReset = { confirm:false, status:"saving", lastError:"" };
    renderMobileAllowPanel(__allOrdersCache, __allOrdersKeySet);
    try{
      await fs.setDoc(ref, {
        keys: [],
        updatedAt: fs.serverTimestamp(),
        updatedBy: state.user.email || state.user.fullName || ""
      }, { merge:true });
      resetAllowlistInMemory({ updatedBy: state.user.email || state.user.fullName || "", docExists:true });
      state.mobileAllowReset = { confirm:false, status:"success", lastError:"" };
      refreshAllowDirtyFlag();
      setTimeout(()=> renderHome(), 100);
    }catch(err){
      console.warn("reset allowlist error", err);
      const code = err?.code || "";
      const msg = err?.message || String(err);
      const friendly = code ? code : msg;
      state.mobileAllowReset = { confirm:false, status:"error", lastError:friendly || "errore" };
    }
    if(__allowResetTimer){
      clearTimeout(__allowResetTimer);
      __allowResetTimer = null;
    }
    renderMobileAllowPanel(__allOrdersCache, __allOrdersKeySet);
  }
  async function saveMobileAllowlist(){
    if(!(state.user && state.user.isAdmin)){
      showToast("Solo admin", "Non hai i permessi per inviare ordini al mobile.");
      return;
    }
    if(!state.firebase.ok){
      showToast("Connessione mancante", "Firebase non disponibile.");
      return;
    }
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = mobileAllowlistDoc(fs, db);
    const keys = Array.from(ensureAllowDraftSet());
    state.mobileAllowSaveState = "saving";
    renderHome();
    try{
      await fs.setDoc(ref, {
        keys,
        updatedAt: fs.serverTimestamp(),
        updatedBy: state.user.email || state.user.fullName || ""
      }, { merge:true });
      state.mobileAllowSaveState = "idle";
      state.mobileAllowDirty = false;
      state.mobileAllowlist.error = "";
      state.mobileAllowlist.lastError = "";
      state.mobileAllowlist.keys = new Set(keys);
      state.mobileAllowSelection = new Set(keys);
      globalThis.__allowCommitted = new Set(keys);
      globalThis.__ALLOW_KEYS__ = new Set(keys);
      globalThis.__allowDraft = new Set(keys);
      globalThis.__allowDraftDirty = false;
      globalThis.__ALLOW_META__ = { ...(globalThis.__ALLOW_META__||{}), lastError:"" };
      showToast("Salvato ", "Ordini inviati a mobile aggiornati.");
    }catch(err){
      console.warn("save allowlist error", err);
      state.mobileAllowSaveState = "error";
      const code = err?.code || "";
      const msg = err?.message || String(err);
      const friendly = code ? `${code}` : msg;
      state.mobileAllowlist.error = friendly;
      state.mobileAllowlist.lastError = friendly;
      globalThis.__ALLOW_META__ = { ...(globalThis.__ALLOW_META__||{}), lastError: friendly };
      showToast("Salvataggio bloccato", `${friendly || "Errore sconosciuto"}. Controlla le regole Firestore.`);
    }
    renderHome();
  }

  async function clearCompletedHistory(){
    if(!state.firebase.ok || !(state.user && state.user.isAdmin)) return;
    if(!confirm("Eliminare tutti gli ordini conclusi?")) return;
    if(!confirm("Conferma finale: loperazione  irreversibile.")) return;
    try{
      const fs = state.firebase.api;
      const db = state.firebase.db;
      const snap = await fs.getDocs(fs.collection(db, "powderProdHistory"));
      for(const d of snap.docs){
        await fs.deleteDoc(d.ref);
      }
      state.history = [];
      state.historyReady = true;
      renderCompletedSection();
      renderStats();
      renderHeaderKpis();
      showToast("Cancellati", "Ordini conclusi rimossi.");
    }catch(err){
      console.warn(err);
      showToast("Errore", "Impossibile cancellare i conclusi.");
    }
  }

  async function addAbort(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdAborts", id), { ...entry, id, at: nowIso() });
  }

  async function addIssue(entry){
  if(!state.firebase.ok) return;
  const fs = state.firebase.api;
  const db = state.firebase.db;
  const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;

  await fs.setDoc(fs.doc(db, "powderProdIssues", id), { ...entry, id, at: nowIso() });

  // (opzionale) invio email via Firestore "Trigger Email" extension
  // Collezione default: "email"
  if(ISSUE_EMAIL_ENABLED && ISSUE_EMAIL_TO){
    try{
      const subject = `Segnalazione Hub Polveri  Ordine ${entry?.orderNo || ""}`.trim();
      const text = [
        "Nuova segnalazione dal Hub Linea Polveri",
        `Cliente: ${entry?.customer || ""}`,
        `Ordine: ${entry?.orderNo || ""}`,
        `Operatore: ${state.user?.fullName || ""}`,
        `Dettagli: ${entry?.text || entry?.message || ""}`
      ].join("\n");

      await fs.setDoc(fs.doc(db, "email", id), {
        to: ISSUE_EMAIL_TO,
        message: { subject, text }
      });
    }catch(err){
      console.warn("email issue failed", err);
    }
  }
}

// VOICE (Gemini TTS via backend proxy + fallback WebSpeech)
  // ===============================
  /*
     Obiettivo:
    - Desktop: voce "Gemini TTS" (qualit alta) tramite un backend/proxy (API key MAI nel client).
    - Fallback: Web Speech API (voci Google/Chrome) se il proxy non  configurato o non risponde.

     Config rapida:
    - Imposta QUI sotto la URL del tuo backend:
        const GEMINI_TTS_PROXY_URL = "https://geminitts-zxiqbo2osa-ew.a.run.app";
    - Se la lasci vuota, user automaticamente la voce WebSpeech come prima.
  */

  const GEMINI_TTS_ENABLED = true;
  const GEMINI_TTS_PROXY_URL = "https://geminitts-zxiqbo2osa-ew.a.run.app"; // <-- INCOLLA QUI la URL della Cloud Function / Cloud Run
  const GEMINI_TTS_VOICE = "Kore"; // voce prebuilt (AI Studio  TTS voices)
  const GEMINI_TTS_LANG  = "it-IT";

  let _googleVoice = null;
  globalThis.__ttsLastMode = 'none';
  globalThis.__ttsLastError = '';

  async function playCue(){ /* no-op */ }

  // Runtime state (Gemini audio)
  let _ttsAudioEl = null;
  let _ttsAbort = null;
  let _ttsRetryTimer = null;

  function stopTTS(){
    try{ if(_ttsAbort) _ttsAbort.abort(); }catch(_){}
    _ttsAbort = null;
    try{
      if(_ttsAudioEl){
        _ttsAudioEl.pause();
        _ttsAudioEl.src = "";
        _ttsAudioEl.load();
      }
    }catch(_){}
  }

  function scheduleTTSRetry(msg){
    if(_ttsRetryTimer) return;
    _ttsRetryTimer = setTimeout(()=>{
      _ttsRetryTimer = null;
      try{ speak(msg); }catch(_){}
    }, 360);
  }

  function _isDesktopVoiceAllowed(){
    try{
      // Heuristics: desktop = hover + pointer fine + viewport abbastanza grande
      const mm = (q) => window.matchMedia && window.matchMedia(q).matches;
      const fine = mm('(pointer: fine)') && mm('(hover: hover)');
      const wide = Math.max(window.innerWidth || 0, document.documentElement.clientWidth || 0) >= 900;

      // Hard-block common mobile/tablet UAs (Android/iOS/iPad)
      const ua = (navigator.userAgent || '').toLowerCase();
      const mobileUA = /android|iphone|ipod|ipad|iemobile|mobile|tablet/.test(ua);

      return fine && wide && !mobileUA;
    }catch(_){
      return false;
    }
  }

  function _pickGoogleVoice(){
    try{
      if(!("speechSynthesis" in window)) return null;
      const voices = window.speechSynthesis.getVoices() || [];
      if(!voices.length) return null;

      const norm = (s)=> String(s||"").toLowerCase();
      const isIt = (v)=> norm(v.lang).startsWith("it");
      const isGoogle = (v)=> norm(v.name).includes("google");

      return voices.find(v => isIt(v) && isGoogle(v))
          || voices.find(v => isIt(v))
          || voices.find(v => isGoogle(v))
          || voices[0];
    }catch(_){
      return null;
    }
  }

  function _ensureGoogleVoice(){
    if(_googleVoice) return;
    _googleVoice = _pickGoogleVoice();
  }

  if("speechSynthesis" in window){
    try{ _googleVoice = _pickGoogleVoice(); }catch(_){}
    try{
      window.speechSynthesis.onvoiceschanged = () => { try{ _googleVoice = _pickGoogleVoice(); }catch(_){ } };
    }catch(_){}
    setTimeout(() => { try{ _googleVoice = _pickGoogleVoice(); }catch(_){ } }, 0);
  }

  function _hasGeminiProxy(){
    return GEMINI_TTS_ENABLED && typeof GEMINI_TTS_PROXY_URL === "string" && GEMINI_TTS_PROXY_URL.trim().length > 0;
  }

  function _b64ToU8(b64){
    const bin = atob(String(b64||""));
    const u8 = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i) & 255;
    return u8;
  }

  async function _playWavArrayBuffer(wavBuf){
    if(!_ttsAudioEl){
      _ttsAudioEl = new Audio();
      _ttsAudioEl.preload = "auto";
    }
    const blob = new Blob([wavBuf], { type: "audio/wav" });
    const objUrl = URL.createObjectURL(blob);
    _ttsAudioEl.src = objUrl;

    return new Promise((resolve, reject)=>{
      const cleanup = ()=>{
        try{ URL.revokeObjectURL(objUrl); }catch(_){}
        try{ _ttsAudioEl.onended = null; _ttsAudioEl.onerror = null; }catch(_){}
      };
      _ttsAudioEl.onended = ()=>{ cleanup(); resolve(); };
      _ttsAudioEl.onerror = ()=>{ cleanup(); reject(new Error("Audio playback error")); };

      try{
        const p = _ttsAudioEl.play();
        if(p && typeof p.then === "function"){
          p.then(()=>{}).catch((err)=>{ cleanup(); reject(err); });
        }
      }catch(err){
        cleanup();
        reject(err);
      }
    });
  }

  async function _speakViaGeminiProxy(exactText){
    // NB: NON mettere la API key nel client. Il proxy la tiene server-side.
    const ctrl = new AbortController();
    _ttsAbort = ctrl;

    const payload = {
      text: String(exactText||""),
      lang: GEMINI_TTS_LANG,
      voice: GEMINI_TTS_VOICE,
      style: "chiaro, professionale, tono aziendale",
    };

    const res = await fetch(GEMINI_TTS_PROXY_URL.trim(), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      signal: ctrl.signal,
      mode: "cors",
      cache: "no-store",
      credentials: "omit",
    });

    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`Proxy TTS HTTP ${res.status}${t?`  ${t.slice(0,180)}`:""}`);
    }

    const ct = (res.headers.get("content-type")||"").toLowerCase();
    let wavBuf = null;

    if(ct.includes("application/json")){
      const j = await res.json();
      const b64 = j.audioB64 || j.audio || j.data || "";
      if(!b64) throw new Error("Proxy TTS: audio mancante (JSON).");
      wavBuf = _b64ToU8(b64).buffer;
    }else{
      // consigliato: backend risponde direttamente audio/wav
      wavBuf = await res.arrayBuffer();
    }

    await _playWavArrayBuffer(wavBuf);
  }

  async function speak(text){
    if(!_isDesktopVoiceAllowed()){
      globalThis.__ttsLastMode = 'disabled';
      globalThis.__ttsLastError = '';
      return;
    }

    const msg = String(text || "").trim();
    if(!msg){
      globalThis.__ttsLastMode = 'none';
      globalThis.__ttsLastError = '';
      return;
    }

    const safeMsg = (msg.length > 520) ? (msg.slice(0, 520).trim() + "") : msg;
    globalThis.__ttsLastError = '';

    try{ await playCue("start"); }catch(_){}

    // Stop eventuale audio precedente e/o fetch in corso
    try{ stopTTS(); }catch(_){}
    try{ if("speechSynthesis" in window) window.speechSynthesis.cancel(); }catch(_){}

    // 1) Gemini TTS (proxy) se configurato
    if(_hasGeminiProxy()){
      globalThis.__ttsLastMode = 'gemini';
      try{
        // istruzione per recitare esattamente (senza cambiare parole)
        const prompt = `Leggi ESATTAMENTE (senza cambiare parole) in italiano (${GEMINI_TTS_LANG}), tono chiaro e professionale, il seguente testo:\n${safeMsg}`;
        await _speakViaGeminiProxy(prompt);
        try{ await playCue("end"); }catch(_){}
        return;
      }catch(e){
        globalThis.__ttsLastError = (e && e.message) ? String(e.message) : String(e || "");
        console.log("TTS (Gemini proxy) error:", e);

        // Se autoplay bloccato, prova un retry
        const em = globalThis.__ttsLastError || "";
        if(/notallowed|not-allowed|gesture|autoplay/i.test(em)){
          scheduleTTSRetry(safeMsg);
          return;
        }
        // fallback sotto (WebSpeech)
      }
    }

    // 2) Fallback Web Speech (come prima)
    try{
      if(!("speechSynthesis" in window)){
        globalThis.__ttsLastMode = 'none';
        return;
      }

      _ensureGoogleVoice();
      globalThis.__ttsLastMode = 'webspeech';

      const u = new SpeechSynthesisUtterance(safeMsg);
      u.lang = GEMINI_TTS_LANG;
      u.rate = 0.92;
      u.pitch = 0.90;

      if(_googleVoice) u.voice = _googleVoice;

      u.onend = () => { try{ playCue("end"); }catch(_){ } };
      u.onerror = (ev) => {
        try{ playCue("end"); }catch(_){ }
        const err = (ev && ev.error) ? String(ev.error) : "";
        const autoplayBlocked = /not-allowed|gesture|autoplay/i.test(err);
        if(autoplayBlocked){
          scheduleTTSRetry(safeMsg);
        }
      };

      window.speechSynthesis.speak(u);
    }catch(e){
      globalThis.__ttsLastMode = globalThis.__ttsLastMode || 'webspeech';
      globalThis.__ttsLastError = (e && e.message) ? String(e.message) : String(e || "");
      console.log("TTS (WebSpeech) error:", e);
      try{ playCue("end"); }catch(_){ }
    }
  }

  globalThis.speak = speak;
  globalThis._pickGoogleVoice = _pickGoogleVoice;
  globalThis.__geminiTts = {
    enabled: GEMINI_TTS_ENABLED,
    proxyUrl: GEMINI_TTS_PROXY_URL,
    voice: GEMINI_TTS_VOICE,
    lang: GEMINI_TTS_LANG
  };


// ===============================
  // RENDER
  // ===============================
  function prodRatio(p){
    const startedAt = p.startedAt ? new Date(p.startedAt).getTime() : null;
    if(!startedAt) return 0;
    const elapsed = Date.now() - startedAt;
    const kg = Number(p.totalKg||0);
    const expectedMs = Math.max(1, (kg/500) * 3600 * 1000);
    return elapsed / expectedMs;
  }

  
  function computePartialOrders(){
    const orders = state.powderOrders || [];
    const hist = state.history || [];
    const completedByOrder = new Map();
    for(const h of hist){
      if(!h || !h.orderNo) continue;
      const on = String(h.orderNo);
      const arr = Array.isArray(h.concludedLineKeys) ? h.concludedLineKeys : [];
      if(!completedByOrder.has(on)) completedByOrder.set(on, new Set());
      const set = completedByOrder.get(on);
      for(const k of arr){ if(k) set.add(String(k)); }
    }
    const partial = [];
    const full = [];
    for(const o of orders){
      const on = String(o.orderNo || o.number || "");
      if(!on) continue;
      let autoDone = 0;
      const keys = [];
      for(const l of (o.lines||[])){
        if(isNonProductionLine(l)){
          autoDone++;
          continue;
        }
        const lk = String(l.lineKey||"");
        if(lk) keys.push(lk);
      }
      const total = keys.length + autoDone;
      if(total<=0) continue;
      const doneSet = completedByOrder.get(on) || new Set();
      let doneReal = 0;
      for(const k of keys){ if(doneSet.has(k)) doneReal++; }
      const concludedTotal = doneReal + autoDone;
      const remaining = total - concludedTotal;
      const hasRealProgress = doneReal>0;
      if(hasRealProgress && remaining>0) partial.push({ orderNo:on, customer:o.customer||"", done:concludedTotal, total });
      else if(concludedTotal>0 && remaining<=0) full.push({ orderNo:on, customer:o.customer||"", done:concludedTotal, total });
    }
    return { partial, full };
  }

  function opNormName(s){
    try{
      return norm(String(s||""))
        .replace(/[^a-z0-9\s]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }catch(_e){
      return String(s||"").toLowerCase().trim().replace(/\s+/g," ");
    }
  }
  function sameOperator(a,b){
    const A = opNormName(a);
    const B = opNormName(b);
    if(!A || !B) return false;
    if(A===B) return true;
    if(A.startsWith(B) || B.startsWith(A)) return true;
    const aT = A.split(" ").filter(Boolean);
    const bT = B.split(" ").filter(Boolean);
    const short = aT.length<=bT.length ? aT : bT;
    const long = aT.length<=bT.length ? bT : aT;
    const set = new Set(long);
    for(const t of short){ if(t && !set.has(t)) return false; }
    return short.length>0;
  }

  function handlePrimaryCta(){
    const active = state.activeProductions || [];
    const me = (state.user?.fullName || state.operator || "");
    const ownActive = me && active.some(p=>sameOperator(p.operator||p.operatorName||"", me));
    if(ownActive) openRunningModal(); else openProdModal();
  }

  function buildOrderViews(options={}){
    // Filtra righe gi concluse e applica priorit/visibilit lato UI (no backend)
    const applyRoleVisibility = options.applyRoleVisibility !== false;
    const includeHidden = options.includeHidden === true;
    const concluded = new Set();
    for(const h of (state.history||[])){
      if(!h || !Array.isArray(h.concludedLineKeys)) continue;
      for(const k of h.concludedLineKeys){ if(k) concluded.add(String(k)); }
    }
    const activeMap = new Map();
    for(const p of (state.activeProductions||[])){
      const keys = Array.isArray(p.selectedLineKeys) ? p.selectedLineKeys : [];
      for(const k of keys){ if(k) activeMap.set(String(k), p); }
    }
    const partialMap = new Map();
    const fullMap = new Map();
    try{
      const { partial, full } = computePartialOrders();
      partial.forEach(p=>partialMap.set(String(p.orderNo), p));
      full.forEach(p=>fullMap.set(String(p.orderNo), p));
    }catch(_e){}

    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    const isMobileView = isMobile();
    const allowInfo = state.mobileAllowlist || {};
    const allowKeySet = (globalThis.__ALLOW_KEYS__ instanceof Set) ? globalThis.__ALLOW_KEYS__ : new Set();
    const allowLoaded = Boolean(globalThis.__ALLOW_LOADED__);
    const allowFilterActive = Boolean(!isAdmin && isMobileView && allowLoaded);
    const allowGuardActive = Boolean(!isAdmin && isMobileView && !allowLoaded);

    const meOp = (state.user?.fullName || state.operator || "");

    const orders = [];
    const baseOrders = [];
    const orderKeySet = new Set();
    for(const o of (state.powderOrders || [])){
      const orderNo = o.orderNo || o.number || "";
      const note = getOrderNote(o);
      const priorityInfo = computePriorityFromNote(note);
      let autoDone = 0;
      const lines = (o.lines||[]).map(l=>{
        if(isNonProductionLine(l)){
          autoDone++;
          return null;
        }
        const key = String(l.lineKey||"");
        const activeProd = activeMap.get(key) || null;
        const status = concluded.has(key) ? "done" : activeProd ? "active" : "idle";
        const activeOp = activeProd?.operator || activeProd?.operatorName || "";
        const activeIsMe = Boolean(activeProd && sameOperator(activeOp, meOp));
        return { ...l, status, activeProd, activeOp, activeIsMe, conclusion: l.conclusion || o.conclusion || "" };
      }).filter(Boolean).filter(l=>l.status !== "done");
      const alerts = Array.isArray(o.alerts) ? o.alerts : [];
      if(!lines.length){
        if(autoDone>0) continue;
        if(!alerts.length) continue;
      }

      const planDate = priorityInfo.date || extractDateFromText(note);
      const daysAway = planDate ? diffDaysFromNow(planDate) : null;
      const k = getOrderKey(o);
      const baseOrder = { ...o, orderNo, lines, alerts, autoDone, totalLines: lines.length + autoDone, partialInfo: partialMap.get(String(orderNo)) || null, isCompleted: fullMap.has(String(orderNo)), note, priorityInfo, planDate, daysAway };
      baseOrder.__k = k;
      baseOrder.stableKey = k;
      baseOrders.push(baseOrder);
      orderKeySet.add(k);

      let visible = true;
      if(applyRoleVisibility){
        if(isDesktop){
          if(isAdmin){
            visible = true;
          } else {
            const beyondWindow = Boolean(planDate && daysAway!=null && daysAway>3);
            visible = !beyondWindow;
          }
        } else {
          visible = priorityInfo.visible !== false;
        }
      }
      if(visible && allowFilterActive){
        visible = allowKeySet.has(k);
      } else if(allowGuardActive){
        visible = false;
      }
      if(!visible && !includeHidden) continue;
      orders.push(baseOrder);
    }

    return { orders, baseOrders, concluded, activeMap, partialMap, fullMap, orderKeySet, allowKeySet };
  }

  function resolvePackKgForLine(line){
    const direct = Number(line?.packKg);
    if(Number.isFinite(direct) && direct>0) return direct;
    const fromDesc = detectPackKg(line?.desc || "");
    if(Number.isFinite(fromDesc) && fromDesc>0) return fromDesc;
    const fromCombo = detectPackKg(`${line?.desc||""} ${line?.um||""}`);
    if(Number.isFinite(fromCombo) && fromCombo>0) return fromCombo;
    return null;
  }
  function isUnitKg(um){
    const u = norm(um||"");
    return (u==="kg") || /\bkg\b/.test(u);
  }
  function isBagOrPieceUnit(um){
    const u = norm(um||"");
    return /\b(sac|sacco|sacchi|sacchetto|sacchetti)\b/.test(u) || /\b(pz|pez|pezzi|pezzo)\b/.test(u);
  }

  function estimateLineKg(line){
    if(!line) return 0;
    const packParsed = resolvePackKgForLine(line);
    const lineKg = resolveQtyKg({
      qty: line.qty,
      um: line.um,
      uom: line.uom,
      unitaMisura: line.unitaMisura,
      unit: line.unit,
      measure: line.measure,
      packKg: packParsed,
      desc: line.desc || ""
    });
    if(Number.isFinite(lineKg) && lineKg>0) return lineKg;
    const fallback = Number(line.lineKg);
    if(Number.isFinite(fallback) && fallback>0) return fallback;
    return 0;
  }

  const DEFAULT_BOBINA_GR_F480 = 10000;
  const DEFAULT_BOBINA_GR_F830 = 10000;
  function readBobinaGr(key, def){
    const n = parseInt(localStorage.getItem(key)||"", 10);
    return Number.isFinite(n) && n>=500 && n<=50000 ? n : def;
  }

  function computeVisiblePowderSummary(orders){ // UI-FIX: kg-totali
    const lines = [];
    for(const o of (orders||[])){
      for(const l of (o.lines||[])){ lines.push(l); }
    }
    let totalKg = 0;
    let kgTot1kg = 0;
    let kgTot5kg = 0;
    let kgUnknown = 0;
    const capF480 = readBobinaGr("gc_bobina_gr_f480_v1", DEFAULT_BOBINA_GR_F480);
    const capF830 = readBobinaGr("gc_bobina_gr_f830_v1", DEFAULT_BOBINA_GR_F830);
    const samples = [];
    for(const l of lines){
      const lineKg = estimateLineKg(l);
      if(Number.isFinite(lineKg)) totalKg += lineKg;
      const pack = resolvePackKgForLine(l);
      if(Number.isFinite(lineKg) && lineKg>0){
        if(pack===1){
          kgTot1kg += lineKg;
        } else if(pack===5){
          kgTot5kg += lineKg;
        } else {
          kgUnknown += lineKg;
        }
      }
      if(samples.length < 5) samples.push({ rawQty: l.qty, parsedQty: parseItNumber(l.qty) });
    }
    const filmF480Gr = kgTot1kg * 10;
    const filmF830Gr = kgTot5kg * 4;
    const capF480Valid = Number.isFinite(capF480) && capF480>0;
    const capF830Valid = Number.isFinite(capF830) && capF830>0;
    const bobineF480 = capF480Valid ? Math.ceil(filmF480Gr / capF480) : null;
    const bobineF830 = capF830Valid ? Math.ceil(filmF830Gr / capF830) : null;
    const bobine = {
      kgTot1kg,
      kgTot5kg,
      kgUnknown,
      filmF480Gr,
      filmF830Gr,
      capF480,
      capF830,
      bobineF480,
      bobineF830
    };
    return { totalKg, lineCount: lines.length, samples, labels: null, bobine };
  }

  function defaultMagazzinoFilters(){
    return { customer:"", orderQuery:"", item:"" };
  }
  function loadMagazzinoFilters(){
    try{
      const raw = localStorage.getItem(MAG_FILTERS_KEY);
      const parsed = raw ? JSON.parse(raw) : {};
      return { ...defaultMagazzinoFilters(), ...(parsed && typeof parsed==="object" ? parsed : {}) };
    }catch(_e){
      return defaultMagazzinoFilters();
    }
  }
  function saveMagazzinoFilters(filters){
    try{ localStorage.setItem(MAG_FILTERS_KEY, JSON.stringify(filters||defaultMagazzinoFilters())); }catch(_e){}
  }
  function setMagazzinoFilters(next){
    state.magFilters = { ...defaultMagazzinoFilters(), ...(state.magFilters||{}), ...(next||{}) };
    saveMagazzinoFilters(state.magFilters);
  }
  function resetMagazzinoFilters(){
    state.magFilters = defaultMagazzinoFilters();
    saveMagazzinoFilters(state.magFilters);
  }
  function collectMagazzinoItemLabels(detail){
    const labels = [];
    const push = (val)=>{
      if(val==null) return;
      const txt = String(val).trim();
      if(txt) labels.push(txt);
    };
    const order = detail?.order || {};
    for(const l of (order.lines||[])){
      push(l.imballaggio); push(l.imballo); push(l.articolo); push(l.item); push(l.imballaggi); push(l.desc); push(l.code);
    }
    const comp = detail?.comp || {};
    if(Number(comp.productKg)) push("Prodotto da completare");
    comp?.bobine?.forEach?.((_,label)=> push(label));
    if(Number(comp.etichette)) push("Etichette");
    comp?.scatole?.forEach?.((_,label)=> push(label));
    comp?.divisori?.forEach?.((_,label)=> push(label));
    comp?.altri?.forEach?.((_,label)=> push(label));
    if((comp.nonConfig||[]).length) push("Non configurati");
    return labels;
  }
  function collectMagazzinoOptions(orderDetails){
    const customers = new Map();
    const items = new Map();
    const push = (map, label)=>{
      const normVal = stableNorm(label);
      if(!normVal || map.has(normVal)) return;
      map.set(normVal, String(label).trim());
    };
    for(const detail of (orderDetails||[])){
      const order = detail?.order || {};
      const customerRaw = order.customer || order.cliente || order.customerName || order.ragioneSociale || "";
      push(customers, customerRaw);
      const labels = collectMagazzinoItemLabels(detail);
      for(const lbl of labels){ push(items, lbl); }
    }
    const toArr = (map)=> Array.from(map.values()).sort((a,b)=> a.localeCompare(b,"it",{ sensitivity:"base" }));
    return { customers: toArr(customers), items: toArr(items) };
  }
  function collectMagazzinoItemNorms(detail){
    const set = new Set();
    for(const lbl of collectMagazzinoItemLabels(detail)){
      const n = stableNorm(lbl);
      if(n) set.add(n);
    }
    return set;
  }
  function aggregateMagazzinoTotalsFromDetails(orderDetails){
    const totals = { productKg:0, bobine:new Map(), etichette:0, scatole:new Map(), divisori:new Map(), altri:new Map(), nonConfig:[], warnings:[] };
    for(const { comp } of (orderDetails||[])){
      const c = comp || {};
      totals.productKg += Number(c.productKg||0);
      c?.bobine?.forEach?.((qty,label)=> magAddToMap(totals.bobine, label, qty));
      totals.etichette += Number(c.etichette||0);
      c?.scatole?.forEach?.((qty,label)=> magAddToMap(totals.scatole, label, qty));
      c?.divisori?.forEach?.((qty,label)=> magAddToMap(totals.divisori, label, qty));
      c?.altri?.forEach?.((qty,label)=> magAddToMap(totals.altri, label, qty));
      if(Array.isArray(c.nonConfig)) totals.nonConfig.push(...c.nonConfig);
      if(Array.isArray(c.warnings)) totals.warnings.push(...c.warnings);
    }
    return totals;
  }
  function applyMagazzinoFilters(orderDetails, filters){
    const base = Array.isArray(orderDetails) ? orderDetails : [];
    const applied = { ...defaultMagazzinoFilters(), ...(filters||{}) };
    const custFilter = stableNorm(applied.customer);
    const orderFilter = stableNorm(applied.orderQuery);
    const itemFilter = stableNorm(applied.item);
    const filtered = [];
    for(const detail of base){
      const order = detail?.order || {};
      const customerRaw = order.customer || order.cliente || order.customerName || order.ragioneSociale || "";
      const customerNorm = stableNorm(customerRaw);
      if(custFilter){
        if(customerNorm!==custFilter && !customerNorm.includes(custFilter)) continue;
      }
      if(orderFilter){
        const orderTokens = stableNorm([order.orderNo, order.number, order.docNumber, order.id, order.orderId, order.numero, order.codiceOrdine].filter(Boolean).join(" "));
        const lineTokens = stableNorm((order.lines||[]).map(l=>`${l.code||""} ${l.desc||""} ${l.orderNo||""}`).join(" "));
        const probe = `${orderTokens} ${lineTokens}`.trim();
        if(!probe || !probe.includes(orderFilter)) continue;
      }
      if(itemFilter){
        const itemNorms = collectMagazzinoItemNorms(detail);
        let ok = false;
        for(const n of itemNorms){
          if(n===itemFilter || n.includes(itemFilter)){ ok=true; break; }
        }
        if(!ok) continue;
      }
      filtered.push(detail);
    }
    const totals = aggregateMagazzinoTotalsFromDetails(filtered);
    return { filteredOrders: filtered, filteredTotals: totals, applied };
  }
  const handleMagOrderInput = debounce((value)=>{
    setMagazzinoFilters({ orderQuery: value||"" });
    renderMagazzino();
  }, 200);
  function renderMagFilterChips(container, filters){
    if(!container) return;
    const chips = [];
    const f = { ...defaultMagazzinoFilters(), ...(filters||{}) };
    const push = (key, label, value)=>{
      if(!value) return;
      chips.push(`<button class="magChip" data-key="${key}" type="button">${escapeHtml(label)}: ${escapeHtml(value)} <span class="x" aria-hidden="true"></span></button>`);
    };
    push("customer", "Cliente", f.customer);
    push("orderQuery", "Ordine", f.orderQuery);
    push("item", "Articolo", f.item);
    container.innerHTML = chips.join("");
    container.style.display = chips.length ? "flex" : "none";
    if(!chips.length) return;
    container.querySelectorAll(".magChip").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        const key = chip.dataset.key;
        if(!key) return;
        setMagazzinoFilters({ [key]: "" });
        renderMagazzino();
      });
    });
  }

  function buildMagazzinoData(){
    const { orders } = buildOrderViews();
    const totals = { productKg:0, bobine:new Map(), etichette:0, scatole:new Map(), divisori:new Map(), altri:new Map(), nonConfig:[], warnings:[] };
    const orderDetails = [];
    for(const o of orders){
      const comp = { productKg:0, bobine:new Map(), etichette:0, scatole:new Map(), divisori:new Map(), altri:new Map(), nonConfig:[], warnings:[] };
      const status = o.lines.some(l=>l.status==="active") ? "in_produzione" : (o.partialInfo ? "parziale" : "da_fare");
      for(const l of (o.lines||[])){
        const qtyKgRimanenti = magResolveQtyKg(l); // CODEX: kg residui per Statistiche/Magazzino
        if(Number.isFinite(qtyKgRimanenti) && qtyKgRimanenti>0){
          comp.productKg += qtyKgRimanenti;
          totals.productKg += qtyKgRimanenti;
        }
        const packKg = magDetectPackKg(l);
        const { bom, source } = magMatchBom(l, packKg) || {};
        const unsupportedPack = (source==="pack_unsupported");
        if(!packKg || packKg<=0 || !bom){
          const note = unsupportedPack ? "Non configurato (packKg non supportato)" : "";
          const nc = { desc:l.desc, customer:o.customer, orderNo:o.orderNo||o.number, qtyKg:qtyKgRimanenti, packKg, code:l.code||"", note };
          comp.nonConfig.push(nc);
          totals.nonConfig.push(nc);
          continue;
        }
        const bags = Number(packKg) ? (qtyKgRimanenti/packKg) : 0;
        if(!Number.isFinite(bags) || bags<=0){
          const nc = { desc:l.desc, customer:o.customer, orderNo:o.orderNo||o.number, qtyKg:qtyKgRimanenti, packKg, code:l.code||"" };
          comp.nonConfig.push(nc);
          totals.nonConfig.push(nc);
          continue;
        }
        if(Math.abs(bags - Math.round(bags)) > 0.01){
          const warn = `${l.desc}  ${bags.toFixed(2)} sacchi da ${packKg} kg`;
          comp.warnings.push(warn);
          totals.warnings.push(warn);
        }
        // CODEX: per i kg totali uso qtyKg (gi in kg reali). packKg serve solo per calcolare i sacchi  componenti.
        if(bom.bobine){
          for(const [label,cfg] of Object.entries(bom.bobine)){
            const perBag = Number((cfg && cfg.perBag!=null) ? cfg.perBag : cfg) || 0;
            const unit = (cfg && cfg.unit) || "g";
            const grams = unit==="kg" ? perBag*1000 : perBag;
            magAddToMap(comp.bobine, label, grams * bags);
            magAddToMap(totals.bobine, label, grams * bags);
          }
        }
        if(Number(bom.etichettePerBag)){
          const tot = Number(bom.etichettePerBag||0) * bags;
          comp.etichette += tot;
          totals.etichette += tot;
        }
        if(bom.scatole){
          for(const [label,val] of Object.entries(bom.scatole)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.scatole, label, tot);
            magAddToMap(totals.scatole, label, tot);
          }
        }
        if(bom.divisori){
          for(const [label,val] of Object.entries(bom.divisori)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.divisori, label, tot);
            magAddToMap(totals.divisori, label, tot);
          }
        }
        if(bom.altri){
          for(const [label,val] of Object.entries(bom.altri)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.altri, label, tot);
            magAddToMap(totals.altri, label, tot);
          }
        }
      }
      orderDetails.push({ order:o, comp, status });
    }
    return { totals, orderDetails };
  }
  const WH_MODAL_ALL_KEY = "__wh_all__";
  function buildMagazzinoDetailLookup(orderDetails){
    const map = new Map();
    const push = (key, entry)=>{
      if(!key) return;
      const arr = map.get(key) || [];
      arr.push(entry);
      map.set(key, arr);
    };
    for(const { order, comp } of (orderDetails||[])){
      const orderLabel = `${order.customer||"Cliente"}  Ord. ${order.orderNo||order.number||""}`;
      const baseSub = order.conclusion ? `Conclusione: ${order.conclusion}` : "";
      const warnSub = (comp?.warnings?.length ? `Attenzione sacchi: ${comp.warnings.length}` : "");
      const sub = [baseSub, warnSub].filter(Boolean).join("  ");
      if(comp.productKg){
        push("productKg|Prodotti da completare", { orderLabel, qty: comp.productKg, unit:"kg", desc: sub });
      }
      comp?.bobine?.forEach?.((qty,label)=>{
        push(`bobine|${label}`, { orderLabel, qty, unit:"g", desc: sub });
      });
      if(Number(comp?.etichette)){
        push("etichette|Etichette", { orderLabel, qty: comp.etichette, unit:"pz", desc: sub });
      }
      comp?.scatole?.forEach?.((qty,label)=>{
        push(`scatole|${label}`, { orderLabel, qty, unit:"pz", desc: sub });
      });
      comp?.divisori?.forEach?.((qty,label)=>{
        push(`divisori|${label}`, { orderLabel, qty, unit:"pz", desc: sub });
      });
      comp?.altri?.forEach?.((qty,label)=>{
        push(`altri|${label}`, { orderLabel, qty, unit:"pz", desc: sub });
      });
      for(const nc of (comp?.nonConfig||[])){
        const desc = `${nc.desc||"Prodotto"}${nc.packKg?`  ${nc.packKg} kg`: ""}${nc.note?`  ${nc.note}`:""}`;
        push("nonconfig|Non configurati", { orderLabel, qty: nc.qtyKg||0, unit:"kg", desc });
      }
    }
    return map;
  }
  function buildMagazzinoOverview(totals){
    const items = [];
    const push = (key, label, qty, unit, extra={})=>{
      const numericQty = Number(qty||0);
      if(!Number.isFinite(numericQty) || numericQty<=0) return;
      const sortBase = unit==="g" ? numericQty/1000 : numericQty;
      items.push({ key, label, qty:numericQty, unit: unit||"", type: extra.type||"", subtitle: extra.subtitle||"", sortVal: sortBase });
    };
    push("productKg|Prodotti da completare", "Prodotto da completare", totals.productKg, "kg", { type:"product", subtitle:"Kg totali residui" });
    totals.bobine.forEach((qty,label)=> push(`bobine|${label}`, label, qty, "g", { type:"bobine", subtitle:"Bobine" }));
    push("etichette|Etichette", "Etichette", totals.etichette, "pz", { type:"etichette", subtitle:"Etichette totali" });
    totals.scatole.forEach((qty,label)=> push(`scatole|${label}`, label, qty, "pz", { type:"scatole", subtitle:"Scatole" }));
    totals.divisori.forEach((qty,label)=> push(`divisori|${label}`, label, qty, "pz", { type:"divisori", subtitle:"Divisori" }));
    totals.altri.forEach((qty,label)=> push(`altri|${label}`, label, qty, "pz", { type:"altri", subtitle:"Altri componenti" }));
    if(totals.nonConfig.length){
      push("nonconfig|Non configurati", "Non configurati", totals.nonConfig.length, "pz", { type:"warning", subtitle:"Distinte non configurate" });
    }
    return items.sort((a,b)=> (b.sortVal||0) - (a.sortVal||0));
  }
  function formatWhQty(item){
    if(!item) return "";
    if(item.unit==="kg") return magFmtKg(item.qty);
    if(item.unit==="g"){
      const asKg = item.qty/1000;
      if(asKg >= 1) return magFmtKg(asKg);
      return magFmtGram(item.qty);
    }
    const base = magFmtFraction(item.qty);
    return item.unit ? `${base} ${item.unit}` : base;
  }
  function formatWhDetailQty(unit, qty){
    const fakeItem = { unit: unit||"", qty };
    return formatWhQty(fakeItem);
  }

  function updateMobileAllowUi(ordersList, orderKeySet){
    const allowInfo = state.mobileAllowlist || {};
    const committed = ensureAllowCommittedSet();
    const draft = ensureAllowDraftSet();
    const orderKeySetLocal = (orderKeySet instanceof Set) ? orderKeySet : new Set((ordersList||[]).map(o=>o?.__k || getOrderKey(o)));
    let matchCount = 0;
    for(const k of committed){
      if(orderKeySetLocal.has(k)) matchCount++;
    }
    const totalOrders = Array.isArray(ordersList) ? ordersList.length : 0;
    const selectionCount = committed.size;
    const updatedTxt = fmtAllowlistTs(allowInfo.updatedAt);
    const docCount = committed.size;
    const docMissing = allowInfo.ready && !allowInfo.docExists;
    const updatedLabel = allowInfo.ready
      ? (docMissing ? "Nessuna assegnazione salvata: filtro vuoto." : (allowInfo.allowAll ? "Filtro disattivo: salva per limitare gli ordini." : `Aggiornato ${updatedTxt}${allowInfo.updatedBy ? `  ${allowInfo.updatedBy}` : ""}  ${docCount} ordini live`))
      : "Sincronizzazione in corso";
    const lastErrorTxt = allowInfo.lastError || allowInfo.error || (globalThis.__ALLOW_META__||{}).lastError || "";
    const updByEl = $("mobileAllowUpdatedBy");
    if(updByEl) updByEl.textContent = allowInfo.updatedBy ? `Ultimo invio: ${allowInfo.updatedBy}` : "In attesa di primo invio";

    const updEl = $("mobileAllowUpdate");
    if(updEl) updEl.textContent = updatedLabel;
    const totEl = $("mobileAllowTotal");
    if(totEl) totEl.textContent = String(totalOrders);
    const sentEl = $("mobileAllowSent");
    if(sentEl) sentEl.textContent = String(selectionCount);
    const matchEl = $("mobileAllowMatch");
    if(matchEl) matchEl.textContent = String(matchCount);

    refreshAllowDirtyFlag();
    const statusEl = $("mobileAllowStatus");
    const feedback = $("mobileAllowFeedback");
    const status = state.mobileAllowSaveState;
    const hasError = Boolean(lastErrorTxt);
    if(statusEl){
      statusEl.className = "statusBadge";
      if(!allowInfo.ready){
        statusEl.textContent = "Sync";
      } else if(status==="saving"){
        statusEl.textContent = "Salvataggio";
        statusEl.classList.add("live");
      } else if(status==="error" || hasError){
        statusEl.textContent = "Errore";
        statusEl.classList.add("error");
      } else if(docMissing){
        statusEl.textContent = "Vuoto";
      } else if(allowInfo.allowAll){
        statusEl.textContent = "Filtro off";
      } else if(state.mobileAllowDirty){
        statusEl.textContent = "Da salvare";
      } else {
        statusEl.textContent = "Salvato";
        statusEl.classList.add("live");
      }
    }
    if(feedback){
      feedback.className = "saveBadge";
      if(!allowInfo.ready){
        feedback.textContent = "Stato: caricamento allowlist";
      } else if(status==="saving"){
        feedback.textContent = "Salvataggio in corso";
      } else if(status==="error" || hasError){
        feedback.classList.add("error");
        feedback.textContent = `Salvataggio non consentito${lastErrorTxt ? `  ${lastErrorTxt}` : ""}`;
      } else if(state.mobileAllowDirty){
        feedback.textContent = "Modifiche locali non salvate.";
      } else if(docMissing){
        feedback.textContent = "Assegnazioni vuote: nessun ordine inviato.";
      } else {
        feedback.classList.add("live");
        const modeTxt = allowInfo.allowAll ? "Filtro disattivo." : "Filtro attivo.";
        feedback.textContent = `${modeTxt} Match: ${matchCount}/${totalOrders}`;
      }
    }
  }

  function renderAdminMobileSendList(allOrders, searchText){
    const list = $("mobileSendList");
    const source = Array.isArray(allOrders) ? allOrders : [];
    const term = norm(searchText || "");
    const filtered = term ? source.filter(o=>{
      const probe = `${o.customer||""} ${o.orderNo||o.number||""} ${o.conclusion||""} ${(o.lines&&o.lines[0]?.desc)||""}`;
      return norm(probe).includes(term);
    }) : source;
    if(!list) return { filteredOrders: filtered, total: source.length };
    list.innerHTML = "";
    if(!filtered.length){
      list.innerHTML = `<div class="muted">Nessun ordine trovato.</div>`;
      return { filteredOrders: [], total: source.length };
    }
    const draft = ensureAllowDraftSet();
    const frag = document.createDocumentFragment();
    for(const o of filtered){
      const key = o.__k || o.stableKey || getOrderKey(o);
      const checked = draft.has(key);
      const line = (o.lines && o.lines[0]) || {};
      const qtyLabel = formatQtyWithKg(line.qty, line.um);
      const row = document.createElement("div");
      row.className = "mobileSendRow";
      if(checked) row.classList.add("selected");
      row.dataset.k = key;
      row.innerHTML = `
        <div class="info">
          <div class="name">${escapeHtml(o.customer||"Cliente")}  Ord. ${escapeHtml(o.orderNo||o.number||"")}</div>
          <div class="meta">${escapeHtml(line.desc||"Prodotto")}  ${escapeHtml(qtyLabel)}${o.conclusion?`  Consegna: ${escapeHtml(o.conclusion)}`:""}</div>
        </div>
        <div class="mobileSendToggle" role="switch" aria-checked="${checked ? "true" : "false"}">
          <div class="knob"></div>
        </div>`;
      frag.appendChild(row);
    }
    list.appendChild(frag);
    return { filteredOrders: filtered, total: source.length };
  }

  function renderMobileAllowPanel(baseOrders=__allOrdersCache, orderKeySet=__allOrdersKeySet){
    const panel = $("mobileSendCard");
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    const isMobileView = isMobile();
    if(!panel) return;
    panel.style.display = isAdmin ? "block" : "none";
    panel.classList.toggle("isMobileAdmin", Boolean(isAdmin && isMobileView));
    panel.classList.toggle("isDesktopAdmin", Boolean(isAdmin && !isMobileView));
    if(!isAdmin) return;

    const ordersList = Array.isArray(baseOrders) ? baseOrders : (__allOrdersCache||[]);
    const orderKeySetLocal = (orderKeySet instanceof Set) ? orderKeySet : (__allOrdersKeySet instanceof Set ? __allOrdersKeySet : new Set((ordersList||[]).map(o=>o?.__k || getOrderKey(o))));
    __allOrdersCache = Array.isArray(ordersList) ? [...ordersList] : [];
    __allOrdersKeySet = new Set(orderKeySetLocal);

    updateMobileAllowUi(ordersList, orderKeySetLocal);
    const status = state.mobileAllowSaveState;
    const resetState = state.mobileAllowReset || {};
    const resetConfirm = Boolean(resetState.confirm);

    const searchInput = $("mobileAllowSearch");
    if(searchInput){
      if(searchInput.value !== (state.mobileAllowSearchTerm||"")){
        searchInput.value = state.mobileAllowSearchTerm || "";
      }
      searchInput.oninput = (e)=>{
        state.mobileAllowSearchTerm = e.target.value || "";
        renderMobileAllowPanel(ordersList, orderKeySetLocal);
      };
    }

    const list = $("mobileSendList");
    const { filteredOrders } = renderAdminMobileSendList(ordersList, state.mobileAllowSearchTerm || "");
    if(list){
      list.__filteredOrders = filteredOrders;
      list.__allOrders = ordersList;
      list.__orderKeySet = orderKeySetLocal;
    }
    if(list){
      if(!list.dataset.bound){
        list.dataset.bound = "1";
        list.addEventListener("click", (e)=>{
          if(e.target.closest("#mobileSendCard")){ e.preventDefault(); e.stopPropagation(); }
          if(e.target.closest("input") || e.target.closest("button") || e.target.closest("textarea")) return;
          const row = e.target.closest(".mobileSendRow");
          if(!row) return;
          const key = row.dataset.k;
          if(!key) return;
          e.preventDefault();
          e.stopPropagation();
          const draft = ensureAllowDraftSet();
          const next = !draft.has(key);
          if(next) draft.add(key); else draft.delete(key);
          refreshAllowDirtyFlag();
          row.classList.toggle("selected", next);
          const toggle = row.querySelector(".mobileSendToggle");
          if(toggle) toggle.setAttribute("aria-checked", next ? "true" : "false");
          updateMobileAllowUi(list.__allOrders || ordersList, list.__orderKeySet || orderKeySetLocal);
        });
      }
    }

    const selectAllBtn = $("btnAllowSelectAll");
    if(selectAllBtn){
      selectAllBtn.onclick = ()=>{
        const set = ensureAllowDraftSet();
        const filtered = (list && Array.isArray(list.__filteredOrders)) ? list.__filteredOrders : filteredOrders;
        for(const o of filtered){
          set.add(o.__k || o.stableKey || getOrderKey(o));
        }
        refreshAllowDirtyFlag();
        const res = renderAdminMobileSendList(list?.__allOrders || ordersList, state.mobileAllowSearchTerm || "");
        if(list) list.__filteredOrders = res.filteredOrders;
        updateMobileAllowUi(list?.__allOrders || ordersList, list?.__orderKeySet || orderKeySetLocal);
      };
    }
    const clearBtn = $("btnAllowClear");
    if(clearBtn){
      clearBtn.onclick = ()=>{
        const set = ensureAllowDraftSet();
        const filtered = (list && Array.isArray(list.__filteredOrders)) ? list.__filteredOrders : filteredOrders;
        for(const o of filtered){
          set.delete(o.__k || o.stableKey || getOrderKey(o));
        }
        refreshAllowDirtyFlag();
        const res = renderAdminMobileSendList(list?.__allOrders || ordersList, state.mobileAllowSearchTerm || "");
        if(list) list.__filteredOrders = res.filteredOrders;
        updateMobileAllowUi(list?.__allOrders || ordersList, list?.__orderKeySet || orderKeySetLocal);
      };
    }
    const saveBtn = $("btnSaveMobileAllow");
    if(saveBtn){
      saveBtn.disabled = status==="saving";
      saveBtn.onclick = ()=> saveMobileAllowlist();
    }
    const resetBtn = $("btnResetMobileAllow");
    if(resetBtn){
      const saving = resetState.status === "saving";
      resetBtn.textContent = resetConfirm ? "Conferma reset" : "Reset invio mobile";
      resetBtn.disabled = saving;
      if(!resetBtn.dataset.bound){
        resetBtn.dataset.bound = "1";
        resetBtn.onclick = ()=> handleMobileAllowResetClick();
      }
    }
    const resetBadge = $("mobileAllowResetStatus");
    if(resetBadge){
      resetBadge.className = "saveBadge";
      const statusTxt = resetState.status || "idle";
      if(statusTxt === "success"){
        resetBadge.classList.add("live");
        resetBadge.textContent = "Reset completato ";
      } else if(statusTxt === "error"){
        resetBadge.classList.add("error");
        const err = resetState.lastError || "";
        resetBadge.textContent = `Reset non consentito${err ? ` (${err})` : ""}`;
      } else if(statusTxt === "saving"){
        resetBadge.textContent = "Reset in corso";
      } else {
        resetBadge.textContent = resetConfirm ? "Premi ancora per confermare" : "Pronto al reset";
      }
    }
  }

  function computeFatturatoLordo(docs){
    let tot = 0;
    let found = false;
    for(const d of (docs||[])){
      const raw = d?.totalDoc;
      const num = Number.isFinite(raw) ? Number(raw) : parseCurrencyValue(raw);
      if(Number.isFinite(num)){
        tot += num;
        found = true;
      }
    }
    return found ? tot : null;
  }

  function resolveFatturatoValue(){
    try{
      if(state.fatturatoLordo!=null && Number.isFinite(state.fatturatoLordo)) return state.fatturatoLordo;
      if((state.fatturatoLordo==null) && (state.docs && state.docs.length)){
        const computed = computeFatturatoLordo(state.docs); // CODEX: calcolo on-demand da XML gi in memoria
        if(computed!=null){
          state.fatturatoLordo = computed;
          return computed;
        }
      }
      const el = $("fatValue");
      if(el && el.dataset && el.dataset.value){
        const n = parseCurrencyValue(el.dataset.value);
        if(n!=null) return n;
      }
      const saved = parseCurrencyValue(localStorage.getItem(FAT_VALUE_KEY));
      if(saved!=null) return saved;
    }catch(_e){}
    return null;
  }
  function updateFatturatoUI(){
    const el = $("fatValue");
    const sub = $("fatSubtitle");
    if(!el) return;
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    const isWide = window.matchMedia("(min-width: 980px)").matches;
    const shouldReveal = isAdmin || isWide;
    const val = resolveFatturatoValue();
    const numericVal = Number.isFinite(val) ? Number(val) : parseCurrencyValue(val);
    state.fatturatoLordo = numericVal;
    if(numericVal!=null){
      el.dataset.value = String(numericVal);
      try{ localStorage.setItem(FAT_VALUE_KEY, String(numericVal)); }catch(_e){}
    } else {
      delete el.dataset.value;
    }
    const formatted = numericVal!=null ? new Intl.NumberFormat("it-IT", { style:"currency", currency:"EUR" }).format(numericVal) : "Dati non disponibili";
    if(shouldReveal){
      el.classList.add("reveal");
      el.classList.remove("blur");
      el.textContent = formatted;
      if(sub) sub.textContent = isAdmin ? "Fatturato lordo visibile agli amministratori ovunque." : "Fatturato lordo visibile su schermi larghi.";
    } else {
      el.classList.add("blur");
      if(el.classList.contains("reveal")){
        el.textContent = formatted;
      } else {
        el.textContent = " ";
      }
      if(sub) sub.textContent = "Tocca per mettere a fuoco il fatturato lordo.";
    }
  }

  function getOrderNote(order){
    try{
      const overridesRaw = localStorage.getItem("ORDER_NOTE_OVERRIDES") || "";
      if(overridesRaw){
        const map = JSON.parse(overridesRaw);
        const key = order.orderNo || order.number || "";
        if(key && map && map[key]) return map[key];
      }
    }catch(_e){}
    return order.note || order.comment || order.internalNote || "";
  }

  function extractDateFromText(text){
    const t = norm(text||"");
    if(!t) return null;
    const monthMap = { "gennaio":0,"febbraio":1,"marzo":2,"aprile":3,"maggio":4,"giugno":5,"luglio":6,"agosto":7,"settembre":8,"ottobre":9,"novembre":10,"dicembre":11 };
    let m = t.match(/(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)(?:\s+(\d{4}))?/);
    if(m){
      const d = parseInt(m[1],10);
      const mo = monthMap[m[2]];
      const y = m[3] ? parseInt(m[3],10) : (new Date()).getFullYear();
      if(!isNaN(d) && mo!=null) return new Date(y, mo, d);
    }
    m = t.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
    if(m){
      const d = parseInt(m[1],10);
      const mo = parseInt(m[2],10)-1;
      let y = m[3] ? parseInt(m[3],10) : (new Date()).getFullYear();
      if(y<100) y = 2000 + y;
      if(!isNaN(d) && mo>=0) return new Date(y, mo, d);
    }
    return null;
  }

  function diffDaysFromNow(date){
    if(!date) return null;
    const now = new Date();
    const tzNow = new Date(now.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
    const tzTarget = new Date(date.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
    return Math.floor((tzTarget - tzNow)/(24*3600*1000));
  }

  function computePriorityFromNote(note){
    // Parsing leggero per note di priorit (giorno prima/giorno stesso)
    const n = norm(note||"");
    if(!n) return { priority:"normal", visible:true };
    if(/da\s*fare\s*oggi/.test(n)){
      return { priority:"today", visible:true, reason:"Da fare oggi" };
    }
    const target = extractDateFromText(n);
    if(target){
      const diffDays = diffDaysFromNow(target);
      if(diffDays != null){
        const tzTarget = new Date(target.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
        if(diffDays >= 2) return { priority:"scheduled", visible:false, date: tzTarget };
        if(diffDays >= 1) return { priority:"scheduled", visible:true, date: tzTarget, reason:"Da iniziare domani" };
        if(diffDays >= 0) return { priority:"scheduled", visible:true, date: tzTarget, reason:"Da iniziare oggi" };
      }
    }
    return { priority:"normal", visible:true };
  }

  // CODEX: helper magazzino (match robusto su nome/codice + pack)
  function magNormalizeName(name){
    return norm(name).replace(/\bkg\b/g," ").replace(/\b\d+(?:[\.,]\d+)?\b/g," ").replace(/\s+/g," ").trim();
  }
  function magDetectPackKg(line){
    return resolvePackKgForLine(line);
  }
  function magResolveQtyKg(line){ // CODEX: kg rimanenti realistici per Statistiche/Magazzino
    const kg = resolveQtyKg({
      qty: line?.qty,
      um: line?.um,
      uom: line?.uom,
      unitaMisura: line?.unitaMisura,
      unit: line?.unit,
      measure: line?.measure,
      packKg: magDetectPackKg(line),
      desc: line?.desc || ""
    });
    if(Number.isFinite(kg) && kg>0) return kg;
    const lineKg = Number(line?.lineKg);
    if(Number.isFinite(lineKg) && lineKg>0) return lineKg;
    return 0;
  }
  function magFindPackEntry(packs, packKg){
    if(!packs || packKg==null) return null;
    if(packs[packKg]) return packs[packKg];
    if(packs[String(packKg)]) return packs[String(packKg)];
    const nearKey = Object.keys(packs||{}).find(k=>Math.abs(Number(k||0)-Number(packKg))<0.011);
    return nearKey ? packs[nearKey] : null;
  }
  function magMatchBom(line, packKg){
    const codeKey = norm(line.code||"").replace(/\s+/g,"");
    const normalizedPack = Number(packKg);
    if(codeKey && MAGAZZINO_BOM.byCode[codeKey]){
      const entry = magFindPackEntry(MAGAZZINO_BOM.byCode[codeKey].packs, packKg);
      if(entry) return { bom: entry, source:"code" };
    }
    const nameKey = magNormalizeName(line.desc||"");
    if(nameKey && MAGAZZINO_BOM.byName[nameKey]){
      const entry = magFindPackEntry(MAGAZZINO_BOM.byName[nameKey].packs, packKg);
      if(entry) return { bom: entry, source:"name" };
    }
    const defaultEntry = magFindPackEntry(MAGAZZINO_BOM.defaultByPackKg, packKg);
    if(defaultEntry) return { bom: defaultEntry, source:"default" };
    if(Number.isFinite(normalizedPack)) return { bom:null, source:"pack_unsupported" };
    return { bom:null, source:"not_found" };
  }
  function magFmtKg(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "";
    return `${n.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1")} kg`;
  }
  function magFmtGram(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "";
    const g = n%1===0 ? n.toFixed(0) : n.toFixed(1); // CODEX: bobine in grammi con max 1 decimale
    return `${g.replace(/\.0$/,"")} g`;
  }
  function magFmtFraction(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "";
    return n.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1");
  }
  function magAddToMap(map, key, delta){
    if(!key) return;
    const cur = Number(map.get(key)||0);
    const add = Number(delta||0);
    if(!Number.isFinite(add)) return;
    map.set(key, cur + add);
  }


function escapeHtml(s){
  return String(s==null?"":s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}

function tsFromId(id){
  try{
    const n = Number(String(id||"").split("_")[0]);
    return Number.isFinite(n) ? n : 0;
  }catch(_e){ return 0; }
}

function renderCompletedSection(){
  const list = $("completedList");
  const empty = $("completedEmpty");
  const badge = $("completedBadge");
  if(!list || !empty || !badge) return;

  const hist = Array.isArray(state.history) ? state.history.slice() : [];
  hist.sort((a,b)=> tsFromId(b.id||b.at||0) - tsFromId(a.id||a.at||0));

  const entries = hist.filter(h=>h && (h.orderNo || h.customer || h.operator)).slice(0, 10);
  badge.textContent = entries.length ? String(entries.length) : "0";

  list.innerHTML = "";
  if(!entries.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";
  const isAdmin = Boolean(state.user && state.user.isAdmin);
  let adminBox = document.getElementById("completedAdmin");
  if(isAdmin){
    if(!adminBox){
      adminBox = document.createElement("div");
      adminBox.id = "completedAdmin";
      adminBox.style.margin = "10px 0";
      adminBox.innerHTML = `<button class="btn bad" id="btnClearCompleted" style="width:100%;">Cancella tutti conclusi</button>`;
      list.parentElement.appendChild(adminBox);
    }
    const btn = adminBox.querySelector("#btnClearCompleted");
    if(btn) btn.onclick = ()=> clearCompletedHistory();
    adminBox.style.display = "block";
  } else if(adminBox){
    adminBox.style.display = "none";
  }

  // status maps (in base all'XML corrente)
  let partialSet = new Set(), fullSet = new Set();
  try{
    const { partial, full } = computePartialOrders();
    for(const p of partial) partialSet.add(String(p.orderNo));
    for(const f of full) fullSet.add(String(f.orderNo));
  }catch(_e){}

  for(const h of entries){
    const orderNo = h.orderNo ? String(h.orderNo) : "";
    const customer = h.customer || "";
    const operator = h.operator || h.operatorName || (h.userName||"") || "Operatore";
    const at = h.at ? fmtDateTime(h.at) : "";
    const kg = (()=>{
      try{
        if(Array.isArray(h.perLine) && h.perLine.length){
          return Math.round(h.perLine.reduce((a,x)=>a + (Number(x.producedKg||0)||0), 0));
        }
      }catch(_e){}
      return null;
    })();

    let status = "Produzione registrata";
    if(fullSet.has(orderNo)) status = "Ordine concluso";
    else if(partialSet.has(orderNo)) status = "Ordine parzialmente concluso";

    const div = document.createElement("div");
    div.className = "item completedItem rowPress";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name ellipsis" title="Ordine n. ${escapeHtml(orderNo)} ${customer?` ${escapeHtml(customer)}`:""}">Ordine n. ${escapeHtml(orderNo)} ${customer?` ${escapeHtml(customer)}`:""}</div>
          <div class="completedMeta">
            <div><b>${escapeHtml(operator)}</b></div>
            ${at?`<div class="kv">${escapeHtml(at)}</div>`:""}
            ${kg!=null?`<div class="kv"><b>${kg}</b> kg</div>`:""}
            <div>${escapeHtml(status)}</div>
          </div>
        </div>
        <div class="badge">Dettagli</div>
      </div>
    `;
    div.addEventListener("click", ()=> openHistModal(h.id));
    list.appendChild(div);
  }
}

function openHistModal(id){
  const h = (state.history||[]).find(x=>x && x.id===id);
  if(!h) return;

  const orderNo = h.orderNo ? String(h.orderNo) : "";
  const customer = h.customer || "";
  const operator = h.operator || h.operatorName || "Operatore";
  $("histTitle").textContent = `Ordine n. ${orderNo}${customer?`  ${customer}`:""}`;
  $("histSub").textContent = `Operatore: ${operator}${h.at?`  ${fmtDateTime(h.at)}`:""}`;

  const body = $("histBody");
  const lines = Array.isArray(h.perLine) ? h.perLine : [];
  const lineHtml = lines.length ? lines.map(l=>`
    <div class="item" style="margin-bottom:10px;">
      <div class="top">
        <div>
          <div class="name">${escapeHtml(l.desc||"")}</div>
          <div class="muted">Pianificati: <b>${escapeHtml(String(l.plannedKg??""))}</b> kg  Prodotti: <b>${escapeHtml(String(l.producedKg??""))}</b> kg</div>
        </div>
        <div class="badge">${escapeHtml(String(l.qty??""))} ${escapeHtml(String(l.um??""))}</div>
      </div>
      ${l.code?`<div class="muted" style="margin-top:6px;">Codice: <b>${escapeHtml(String(l.code))}</b></div>`:""}
    </div>
  `).join("") : `<div class="muted">Nessun dettaglio righe disponibile.</div>`;

  const sig = h.signature ? `<div style="margin-top:14px;"><div class="muted" style="margin-bottom:6px;">Firma</div><img src="${h.signature}" alt="Firma" style="width:100%; max-width:520px; border:1px solid var(--stroke); border-radius:14px; background:#fff;"></div>` : "";

  body.innerHTML = `
    <div class="muted">Stato: <b>${escapeHtml((()=>{ try{ const {partial,full}=computePartialOrders(); const ps=new Set(partial.map(x=>String(x.orderNo))); const fs=new Set(full.map(x=>String(x.orderNo))); if(fs.has(orderNo)) return "Ordine concluso"; if(ps.has(orderNo)) return "Ordine parzialmente concluso"; }catch(_e){} return "Storico"; })())}</b></div>
    <div style="height:12px"></div>
    ${lineHtml}
    ${sig}
  `;

  $("histModal").classList.add("show");
  lockBody();
}

function renderHome(){
    if(!loader.firstRenderDone){
      showLoader("Rendering 2/3");
    }
    let partialCount = 0;
    let prodKey = null;
    let alertKey = null;
    relocateStatsCard(); // CODEX: mantiene Statistiche nella colonna panoramica
    try{ const el=$('homeWelcome'); if(el && state.user){ el.textContent = `Benvenuto, ${state.user.fullName}`; } }catch(e){}

    const views = buildOrderViews();
    pruneSelectionAgainstOrders(views.baseOrders);
    updateSelectionCounter();
    const visibleOrders = views.orders; // UI-FIX: kg-totali
    const kgSummary = computeVisiblePowderSummary(visibleOrders); // UI-FIX: kg-totali
    $("kPowderLines").textContent = kgSummary.lineCount ? kgSummary.lineCount.toString() : "0"; // UI-FIX: kg-totali
    setHomeKgTotali(kgSummary.totalKg); // UI-FIX: kg-totali
    const kPowderMeta = $("kPowderMeta"); // UI-FIX: kg-totali
    if(kPowderMeta) kPowderMeta.textContent = `Calcolato su ${kgSummary.lineCount} righe visibili`; // UI-FIX: kg-totali
    const bobine = kgSummary.bobine;
    const kBobineF480 = $("kBobineF480");
    const kBobineF830 = $("kBobineF830");
    const kBobineF480Meta = $("kBobineF480Meta");
    const kBobineF830Meta = $("kBobineF830Meta");
    const fmtInt = (n)=> Number.isFinite(n) ? Math.max(0, Math.round(n)).toLocaleString("it-IT") : "0";
    const fmtGram = (n)=>{
      const num = Number(n||0);
      if(!Number.isFinite(num)) return "";
      const rounded = Math.round(num*10)/10;
      return `${rounded.toLocaleString("it-IT")} g`;
    };
    const fmtKg = (n)=>{
      const num = Number(n||0);
      if(!Number.isFinite(num)) return "0";
      return num.toLocaleString("it-IT", { maximumFractionDigits: 3 });
    };
    if(kBobineF480 && kBobineF830){
      if(bobine){
        const capF480Valid = Number.isFinite(bobine.capF480) && bobine.capF480>0;
        const capF830Valid = Number.isFinite(bobine.capF830) && bobine.capF830>0;
        kBobineF480.textContent = capF480Valid && bobine.bobineF480!=null ? fmtInt(bobine.bobineF480) : "";
        kBobineF830.textContent = capF830Valid && bobine.bobineF830!=null ? fmtInt(bobine.bobineF830) : "";
        if(kBobineF480Meta){
          kBobineF480Meta.textContent = capF480Valid
            ? `Film: ${fmtGram(bobine.filmF480Gr)}  Kg: ${fmtKg(bobine.kgTot1kg)}  1 bobina = ${fmtGram(bobine.capF480)}`
            : "Capacit bobina non configurata";
        }
        if(kBobineF830Meta){
          kBobineF830Meta.textContent = capF830Valid
            ? `Film: ${fmtGram(bobine.filmF830Gr)}  Kg: ${fmtKg(bobine.kgTot5kg)}  1 bobina = ${fmtGram(bobine.capF830)}`
            : "Capacit bobina non configurata";
        }
      } else {
        kBobineF480.textContent = "";
        kBobineF830.textContent = "";
        if(kBobineF480Meta) kBobineF480Meta.textContent = "Stima non disponibile";
        if(kBobineF830Meta) kBobineF830Meta.textContent = "Stima non disponibile";
      }
    }
    const pOrders = state.powderOrders || [];
    const badgeEl = $("badgeCounts");
    if(badgeEl){
      const isAdmin = Boolean(state.user && state.user.isAdmin);
      const allowInfo = state.mobileAllowlist || {};
      const allowLoaded = Boolean(globalThis.__ALLOW_LOADED__);
      const mobileView = isMobile();
      if(mobileView && !isAdmin && !allowLoaded){
        badgeEl.textContent = " ordini";
      } else {
        const count = (mobileView && !isAdmin) ? visibleOrders.length : pOrders.length;
        const noun = count === 1 ? "ordine" : "ordini";
        badgeEl.textContent = `${count} ${noun}`;
      }
    }
    const alertOrder = pOrders.find(o=>Array.isArray(o.alerts) && o.alerts.length);
    if(alertOrder){
      const a = (alertOrder.alerts || [])[0] || {};
      const label = (a.desc || a.alertInfo?.label || "").trim();
      const orderId = alertOrder.number || alertOrder.orderNo || "";
      const customer = alertOrder.customer || "";
      const base = [orderId, label || customer].filter(Boolean).join("|");
      alertKey = base ? base.slice(0,160) : null;
    }
    renderMobileAllowPanel(views.baseOrders, views.orderKeySet);
    const mobileInfo = $("mobileAllowInfo");
    if(mobileInfo){
      const showMobileInfo = isMobile() && state.user && !(state.user && state.user.isAdmin);
      mobileInfo.style.display = showMobileInfo ? "block" : "none";
      if(showMobileInfo){
        const allowInfo = state.mobileAllowlist || {};
        const allowLoaded = Boolean(globalThis.__ALLOW_LOADED__);
        const count = visibleOrders.length;
        const docMissing = allowLoaded && !allowInfo.docExists;
        if(docMissing){
          mobileInfo.textContent = "Assegnazioni non configurate";
        } else if(allowLoaded && count===0){
          mobileInfo.textContent = "Nessun ordine assegnato dalladmin";
        } else {
          mobileInfo.innerHTML = `Ordini assegnati: <span id=\"mobileAllowCount\">${count}</span><span id=\"mobileAllowMsg\" style=\"margin-left:6px; color:var(--muted); font-weight:800;\"></span>`;
          const countEl = $("mobileAllowCount");
          const msgEl = $("mobileAllowMsg");
          if(countEl) countEl.textContent = String(count);
          if(msgEl) msgEl.textContent = "";
          if(allowLoaded && count===0 && msgEl){
            msgEl.textContent = "Assegnazioni attive: nessun ordine";
          }
        }
      }
    }

    let txt = "Ordini: ";
    if(state.xmlModifiedTime) txt += `aggiornati ${state.xmlModifiedTime}`;
    else if(state.lastFetchAt) txt += `aggiornati ${fmtDateTime(state.lastFetchAt)}`;
    else txt += "in sincronizzazione";
    $("txtXmlTime").textContent = txt;
    updateFatturatoUI(); // CODEX: aggiornamento UI fatturato lordo

    // Banner ordini parzialmente conclusi (globale)
    try{
      const { partial } = computePartialOrders();
      partialCount = partial.length;
      state.partialOrders = partial;
      const b = $("partialBanner");
      if(b){
        if(partial.length){
          b.dataset.display = "flex";
          b.style.display = "flex";
          requestAnimationFrame(()=> b.classList.add("show"));
          const n = partial.length;
          $("partialBannerTitle").textContent = `Ci sono ${n} ordini parzialmente conclusi in corso`;
          $("partialBannerSub").textContent = `Apri Produzione per completare le righe rimanenti.`;
        } else {
          b.classList.remove("show");
          setTimeout(()=>{ b.style.display = "none"; }, 180);
        }
      }
      if($("partialModal")?.classList.contains("show")) renderPartialOrdersList(); // CODEX: re-render immediato elenco parziali
    }catch(_e){}

    // Ordini conclusi (sezione Home)
    try{ renderCompletedSection(); }catch(_e){}

    const active = state.activeProductions || [];
    const strip = $("prodStrip");
    if(active.length){
      strip.style.display = "block";
      $("prodCount").textContent = String(active.length);
      const parts = active.slice(0,6).map(p=>`${p.operator||"Operatore"}: ${p.customer||"Cliente"}  Ordine n. ${p.orderNo||""}`);
      const marqueeTxt = parts.join("      ") + (active.length>6 ? "      ..." : "");
      $("prodMarquee").textContent = marqueeTxt;
      prodKey = `${active.length}|${marqueeTxt}`.slice(0,160);
      const ratios = active.map(p=>prodRatio(p));
      const r = ratios.length ? Math.max(...ratios) : 0;
      const hue = Math.max(0, 120 - (120 * Math.min(1,r)));
      strip.style.background = `hsla(${hue}, 80%, 45%, .22)`;
      strip.style.borderColor = `hsla(${hue}, 80%, 55%, .35)`;
    } else {
      strip.style.display = "none";
      prodKey = null;
    }
    try{
      const btn = $("btnGoProd");
      if(btn){
        const me = (state.user?.fullName || state.operator || "").toLowerCase();
        const ownActive = me && active.some(p=>String(p.operator||"").toLowerCase()===me);
        btn.textContent = ownActive ? "APRI PRODUZIONE IN CORSO" : "VAI IN PRODUZIONE";
        btn.setAttribute("aria-label", btn.textContent);
      }
    }catch(_e){}

    renderStats();
    renderHeaderKpis();
    renderMagazzino(); // CODEX: re-render magazzino dopo gli stessi filtri degli ordini
    if(isMobile()){
      checkMobileEvents({ partialCount, prodKey, alertKey });
    }
    if(!loader.firstRenderDone){
      showLoader("Rendering 3/3");
    }
  }

  
  async function bumpOperatorKg(uid, fullName, kg){
    if(!state.firebase.ok || !uid) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, "operatorStats", uid);
    await fs.runTransaction(db, async(tx)=>{
      const snap = await tx.get(ref);
      const cur = snap.exists() ? (snap.data()||{}) : {};
      const totalKg = Number(cur.totalKg||0) + Number(kg||0);
      const totalRuns = Number(cur.totalRuns||0) + 1;
      tx.set(ref, { uid, fullName, totalKg, totalRuns, updatedAt: nowIso() }, { merge:true });
    });
  }

  function renderGlobalStatsSummary(){
    const list = $("statsList");
    const badge = $("statsBadge");
    if(!badge) return;
    const clearedAt = getStatsClearTs();
    const statsHist = clearedAt ? getStatsHistoryEntries() : [];
    const stats = clearedAt ? {
      concludedCountTotal: statsHist.length,
      concludedKgTotal: statsHist.reduce((a,h)=>a + Number(h.kg||0), 0),
      updatedAt: null,
      updatedBy: ""
    } : getGlobalStatsData();
    const fmtCount = (n)=> Number.isFinite(n) ? Math.max(0, Math.round(n)).toLocaleString("it-IT") : "";
    const fmtKg = (n)=> Number.isFinite(n) ? `${Math.round(Math.max(0, Number(n)||0)).toLocaleString("it-IT")} kg` : "";
    badge.textContent = fmtCount(stats.concludedCountTotal);
    if(!list || !list.parentElement) return;
    let summary = document.getElementById("globalStatsSummary");
    if(!summary){
      summary = document.createElement("div");
      summary.id = "globalStatsSummary";
      summary.style.padding = "12px";
      summary.style.margin = "0 0 12px";
      summary.style.borderRadius = "14px";
      summary.style.border = "1px solid var(--stroke)";
      summary.style.background = "rgba(0,0,0,.02)";
      list.parentElement.insertBefore(summary, list);
    }
    const desc = clearedAt ? "Dati storici eliminati su questo dispositivo." : "Cumulativo totale, indipendente dai record eliminati.";
    summary.innerHTML = `
      <div class="stepTitle" style="margin:0 0 6px 0;">Statistiche globali</div>
      <div class="muted" style="margin-bottom:8px;">${desc}</div>
      <div style="display:flex; align-items:center; justify-content:space-between; font-weight:800;">
        <div class="muted" style="font-weight:800;">Ordini conclusi</div>
        <div>${fmtCount(stats.concludedCountTotal)}</div>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px; font-weight:800;">
        <div class="muted" style="font-weight:800;">Kg totali</div>
        <div>${fmtKg(stats.concludedKgTotal)}</div>
      </div>
    `;
  }
  function renderOperatorLeaderboardSection(data, opts={}){
    const container = $("operatorLeaderboard");
    if(!container) return;
    const canSeeStats = opts.canSeeStats !== false;
    const rangeLabel = opts.rangeLabel || "Questo mese";
    const baseData = Array.isArray(data) ? data : [];
    let currentSort = (opts.sortOverride || readOpRankSort()) === "kg" ? "kg" : "orders";
    if(!canSeeStats){
      container.innerHTML = `<div class="opLbCard"><div class="opLbEmpty">Statistiche complete riservate agli amministratori.</div></div>`;
      return;
    }
    container.innerHTML = `
      <div class="opLbCard">
        <div class="opLbHead">
          <div>
            <div class="opLbTitle">Classifica operatori</div>
            <div class="opLbMeta">${escapeHtml(rangeLabel)}  Ordinata per ${currentSort==="kg" ? "kg prodotti" : "ordini conclusi"}</div>
          </div>
          <div class="opLbToggles" role="group" aria-label="Ordina classifica operatori">
            <button class="opLbToggleBtn" data-sort="orders" type="button">Ordini</button>
            <button class="opLbToggleBtn" data-sort="kg" type="button">Kg</button>
          </div>
        </div>
        <div class="opLbList" id="opLbList"></div>
      </div>`;
    const listEl = container.querySelector("#opLbList");
    const metaEl = container.querySelector(".opLbMeta");
    const buttons = Array.from(container.querySelectorAll(".opLbToggleBtn"));
    const applySort = (mode)=>{
      currentSort = mode === "kg" ? "kg" : "orders";
      saveOpRankSort(currentSort);
      buttons.forEach(btn=>{
        const active = (btn.dataset.sort === currentSort);
        btn.classList.toggle("active", active);
        if(active) btn.setAttribute("aria-pressed","true"); else btn.setAttribute("aria-pressed","false");
      });
      if(metaEl){
        metaEl.textContent = `${rangeLabel}  Ordinata per ${currentSort==="kg" ? "kg prodotti" : "ordini conclusi"}`;
      }
      if(!listEl) return;
      const sorted = baseData.slice().sort((a,b)=>{
        if(currentSort==="kg"){
          const diff = (b.kg||0) - (a.kg||0);
          if(diff!==0) return diff;
          return (b.orders||0) - (a.orders||0);
        }
        const diff = (b.orders||0) - (a.orders||0);
        if(diff!==0) return diff;
        return (b.kg||0) - (a.kg||0);
      });
      if(!sorted.length){
        listEl.innerHTML = `<div class="opLbEmpty">Nessun dato disponibile.</div>`;
        return;
      }
      const rowsHtml = sorted.map((item, idx)=>{
        const rank = idx + 1;
        const badgeClass = rank<=3 ? ` top${rank}` : "";
        const label = escapeHtml(item.operatorLabel || "Sconosciuto");
        const kgTxt = formatMonthlyKg(item.kg);
        const ordTxt = formatMonthlyOrders(item.orders);
        const eventsTxt = formatMonthlyOrders(item.eventsCount);
        return `
          <div class="opLbRow${badgeClass}">
            <div class="opLbRank">#${rank}</div>
            <div>
              <div class="opLbName">${label}</div>
              <div class="opLbSub">Attivit: ${eventsTxt}</div>
            </div>
            <div class="opLbMetrics">
              <div class="opLbMetric">
                <div class="lbl">Kg mese</div>
                <div class="val">${kgTxt}</div>
              </div>
              <div class="opLbMetric">
                <div class="lbl">Ordini mese</div>
                <div class="val">${ordTxt}</div>
              </div>
            </div>
          </div>`;
      }).join("");
      listEl.innerHTML = rowsHtml;
    };
    buttons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        applySort(btn.dataset.sort === "kg" ? "kg" : "orders");
      });
    });
    applySort(currentSort);
  }

  function renderStats(){
    const list = $("statsList");
    const canSeeStats = Boolean((state.user && state.user.isAdmin) || window.matchMedia("(min-width: 980px)").matches);
    const statsHist = getStatsHistoryEntries();
    const statsHistAll = getStatsHistoryEntriesAll();
    const { start, end, label: rangeLabel } = getCurrentMonthRange();
    const leaderboardData = computeOperatorLeaderboard(statsHistAll, start, end);
    renderOperatorLeaderboardSection(leaderboardData, { canSeeStats, rangeLabel });
    const badgeEl = $("statsBadge");
    const badgeValue = statsHist.length ? Math.max(0, Math.round(statsHist.length||0)).toString() : "0";
    if(badgeEl) badgeEl.textContent = badgeValue;
    if(!canSeeStats){
      list.innerHTML = `<div class="muted">Statistiche complete riservate agli amministratori.</div>`;
      return;
    }
    renderGlobalStatsSummary();

    // Admin: reset storico
    try{
      const adminBoxId = "adminStatsBox";
      let box = document.getElementById(adminBoxId);
      if(state.user && state.user.isAdmin){
        if(!box){
          box = document.createElement("div");
          box.id = adminBoxId;
          box.style.marginTop = "12px";
          box.innerHTML = `
            <div class="divider"></div>
            <div class="stepTitle" style="font-size:14px; margin-top:0;">Admin</div>
            <button class="btn bad" id="btnClearHistory" style="width:100%;">Elimina dati storici</button>
            <div class="muted" id="statsClearFeedback" style="margin-top:8px;">Attenzione: operazione irreversibile.</div>
          `;
          list.parentElement.appendChild(box);
        }
      } else {
        if(box) box.remove();
      }
    }catch(_e){}
    const hist = statsHist;
    const cleared = getStatsClearTs();
    if(!hist.length){
      const clearedMsg = cleared ? `<div class="muted" style="margin-top:6px;">Dati storici eliminati su questo dispositivo.</div>` : "";
      list.innerHTML = `<div class="muted">Nessun dato storico disponibile (in attesa delle prime produzioni).</div>${clearedMsg}`;
      return;
    }
    const agg = new Map();
    for(const h of hist){
      const op = h.operator;
      const kg = Number(h.kg||0);
      const ms = Number(h.durationMs||0);
      const a = agg.get(op) || { kg:0, ms:0, n:0 };
      a.kg += kg; a.ms += ms; a.n += 1;
      agg.set(op, a);
    }
    const rows = Array.from(agg.entries()).map(([op,a])=>{
      const hours = a.ms/3600000;
      const speed = hours>0 ? (a.kg/hours) : 0;
      return { op, ...a, speed };
    }).sort((x,y)=>y.kg-x.kg);

    list.innerHTML = "";
    for(const r of rows){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${r.op}</div>
            <div class="sub">${r.n} produzioni  Velocit media: ${Math.round(r.speed)} kg/h</div>
          </div>
          <div class="badge">${Math.round(r.kg)} kg</div>
        </div>`;
        list.appendChild(div);
    }
  }
  function wireStatsClearAction(){
    if(globalThis.__STATS_CLEAR_HANDLER_BOUND__) return;
    globalThis.__STATS_CLEAR_HANDLER_BOUND__ = true;
    document.addEventListener("click", (e)=>{
      const btn = e.target?.closest("#btnClearHistory");
      if(!btn) return;
      if(!(state.user && state.user.isAdmin)){
        showToast("Accesso limitato", "Solo gli amministratori possono azzerare le statistiche.");
        return;
      }
      const msg = "Confermi eliminazione dati storici? Questa azione non  reversibile.";
      if(!confirm(msg)) return;
      clearProdStatsHistoryHard();
    });
  }

  function renderMagazzino(){
    // Distinta base lato client (desktop only) - usa dati gi filtrati dall'UI ordini
    const card = $("warehouseCard");
    const body = $("warehouseBody");
    const badge = $("warehouseBadge");
    if(!card || !body || !badge) return;
    const isDesktop = window.matchMedia("(min-width: 1025px)").matches;
    card.style.display = isDesktop ? "block" : "none";
    document.body.classList.toggle("desktopV2", isDesktop);
    if(!isDesktop){
      body.innerHTML = "";
      badge.textContent = "";
      return;
    }

    const { totals, orderDetails } = buildMagazzinoData();
    const filters = state.magFilters || defaultMagazzinoFilters();
    const { filteredOrders, filteredTotals, applied } = applyMagazzinoFilters(orderDetails, filters);
    const options = collectMagazzinoOptions(orderDetails);
    const sortedDetails = filteredOrders.slice().sort((a,b)=>`${a.order.customer||""}`.localeCompare(`${b.order.customer||""}`) || `${a.order.orderNo||a.order.number||""}`.localeCompare(`${b.order.orderNo||b.order.number||""}`));
    const detailLookup = buildMagazzinoDetailLookup(sortedDetails);
    const overviewItems = buildMagazzinoOverview(filteredTotals);
    state.magazzinoDetailLookup = detailLookup;
    state.magazzinoOverview = overviewItems;
    const TOP_LIMIT = 12;
    const visibleItems = overviewItems.slice(0, TOP_LIMIT);
    const needsSeeAll = overviewItems.length > visibleItems.length;
    badge.textContent = `${sortedDetails.length || 0}`;
    badge.title = `Ordini filtrati: ${sortedDetails.length} / Totale: ${orderDetails.length}`;

    const kpisHtml = (()=>{
      const updatedTxt = state.xmlModifiedTime || (state.lastFetchAt ? fmtDateTime(state.lastFetchAt) : "");
      const critCount = (filteredTotals.warnings?.length||0) + (filteredTotals.nonConfig?.length||0);
      return `<div class="whKpiRow">
        <div class="whKpi"><span class="v">${overviewItems.length || 0}</span><span>Articoli monitorati</span></div>
        <div class="whKpi"><span class="v">${critCount}</span><span>Criticit</span></div>
        <div class="whKpi"><span class="v">${escapeHtml(updatedTxt)}</span><span>Aggiornato</span></div>
      </div>`;
    })();
    const overviewHtml = visibleItems.length
      ? visibleItems.map(it=>`
        <button class="whOverviewRow rowPress" data-key="${escapeHtml(it.key)}" type="button">
          <div style="flex:1; min-width:0;">
            <div class="whOverviewName">${escapeHtml(it.label)}</div>
            ${it.subtitle ? `<div class="whOverviewSub">${escapeHtml(it.subtitle)}</div>`:""}
          </div>
          <div class="whOverviewVal">${formatWhQty(it)}</div>
        </button>`).join("")
      : `<div class="muted">${orderDetails.length ? "Nessun ordine corrisponde ai filtri." : "Nessun ordine disponibile."}</div>`;
    const seeAllHtml = "";
    const critAlert = (()=>{
      const crit = [];
      if((filteredTotals.warnings||[]).length) crit.push(`<div class="badge" style="background:rgba(255,159,10,.14); border-color:rgba(255,159,10,.3);">Solleciti sacchi: ${filteredTotals.warnings.length}</div>`);
      if((filteredTotals.nonConfig||[]).length) crit.push(`<div class="badge" style="background:rgba(255,149,0,.12); border-color:rgba(255,149,0,.3);">Distinte mancanti: ${filteredTotals.nonConfig.length}</div>`);
      return crit.join("");
    })();
    const hasFilters = Boolean(applied.customer || applied.orderQuery || applied.item);
    const filterBarHtml = `<div class="magFilterBar">
      <div class="magFilterField">
        <label class="magFilterLabel" for="magFilterCustomer">Cliente</label>
        <select id="magFilterCustomer" class="magFilterInput">
          <option value="">Tutti</option>
          ${options.customers.map(c=>`<option value="${escapeHtml(c)}"${stableNorm(c)===stableNorm(applied.customer)?" selected":""}>${escapeHtml(c)}</option>`).join("")}
        </select>
      </div>
      <div class="magFilterField">
        <label class="magFilterLabel" for="magFilterOrder">Ordine</label>
        <input id="magFilterOrder" class="magFilterInput" type="search" placeholder="Cerca ordine" value="${escapeHtml(applied.orderQuery||"")}" autocomplete="off" inputmode="search" />
      </div>
      <div class="magFilterField">
        <label class="magFilterLabel" for="magFilterItem">Articolo (imballaggio)</label>
        <select id="magFilterItem" class="magFilterInput">
          <option value="">Tutti</option>
          ${options.items.map(i=>`<option value="${escapeHtml(i)}"${stableNorm(i)===stableNorm(applied.item)?" selected":""}>${escapeHtml(i)}</option>`).join("")}
        </select>
      </div>
      <div class="magFilterActions">
        <div class="magResultBadge" id="magResultBadge">Risultati: ${overviewItems.length}  Ordini: ${sortedDetails.length}</div>
        <button class="btn ghost" id="magFiltersReset" type="button"${hasFilters ? "" : " style=\"opacity:.8;\""}>Pulisci filtri</button>
      </div>
    </div>
    <div class="magFilterChips" id="magFilterChips"></div>`;
    body.innerHTML = `<div class="magSimple">
      <div class="magTitle">Panoramica magazzino</div>
      ${filterBarHtml}
      ${kpisHtml}
      ${critAlert?`<div class="whCritRow">${critAlert}</div>`:""}
      <div id="whOverview" class="whOverview rowsScroll">${overviewHtml}${seeAllHtml}</div>
      <div class="row2 whActions" style="margin-top:10px;">
        <button class="btn ghost" id="whSeeAll" type="button"${needsSeeAll ? "" : " style=\"opacity:.65;\""}>Apri elenco completo</button>
        <button class="btn" type="button" id="whScrollTop">Torna in cima</button>
      </div>
    </div>`;

    const rows = Array.from(body.querySelectorAll(".whOverviewRow"));
    for(const row of rows){
      row.addEventListener("click", ()=> openWhModal(row.dataset.key));
    }
    const seeAllBtn = $("whSeeAll");
    if(seeAllBtn){
      seeAllBtn.addEventListener("click", ()=> openWhModal(WH_MODAL_ALL_KEY));
    }
    const scrollTopBtn = $("whScrollTop");
    if(scrollTopBtn){
      scrollTopBtn.addEventListener("click", ()=>{
        const wrap = $("whOverview");
        if(wrap) wrap.scrollTo({ top:0, behavior:"smooth" });
      });
    }
    const customerSelect = $("magFilterCustomer");
    if(customerSelect){
      customerSelect.onchange = (e)=>{
        setMagazzinoFilters({ customer: e.target.value || "" });
        renderMagazzino();
      };
    }
    const orderInput = $("magFilterOrder");
    if(orderInput){
      orderInput.value = applied.orderQuery || "";
      orderInput.oninput = (e)=> handleMagOrderInput(e.target.value || "");
    }
    const itemSelect = $("magFilterItem");
    if(itemSelect){
      itemSelect.onchange = (e)=>{
        setMagazzinoFilters({ item: e.target.value || "" });
        renderMagazzino();
      };
    }
    const resetBtn = $("magFiltersReset");
    if(resetBtn){
      resetBtn.addEventListener("click", ()=>{
        resetMagazzinoFilters();
        renderMagazzino();
      });
    }
    renderMagFilterChips($("magFilterChips"), applied);
    const resultBadge = $("magResultBadge");
    if(resultBadge){
      resultBadge.textContent = `Risultati: ${overviewItems.length}  Ordini: ${sortedDetails.length}`;
    }
  }

  function renderWhModalContent(key){
    const modalTitle = $("whModalTitle");
    const modalSub = $("whModalSub");
    const modalBody = $("whModalBody");
    if(!modalTitle || !modalSub || !modalBody) return;
    const overview = Array.isArray(state.magazzinoOverview) ? state.magazzinoOverview : [];
    const lookup = (state.magazzinoDetailLookup instanceof Map) ? state.magazzinoDetailLookup : new Map();
    const renderSection = (item)=>{
      const entries = lookup.get(item.key) || [];
      const rows = entries.length ? entries.map(e=>`
        <div class="whModalRow">
          <div style="flex:1; min-width:0;">
            <div class="whModalName">${escapeHtml(e.orderLabel||"Ordine")}</div>
            ${e.desc ? `<div class="whModalSub">${escapeHtml(e.desc)}</div>`:""}
          </div>
          <div class="whModalVal">${formatWhDetailQty(e.unit, e.qty)}</div>
        </div>`).join("") : `<div class="muted">Nessun dettaglio disponibile.</div>`;
      return `<div class="whModalSection">
        <div class="tit">${escapeHtml(item.label)}</div>
        ${rows}
      </div>`;
    };

    if(key === WH_MODAL_ALL_KEY){
      modalTitle.textContent = "Dettaglio magazzino";
      modalSub.textContent = "Elenco completo articoli e ordini";
      modalBody.innerHTML = overview.length ? overview.map(renderSection).join("") : `<div class="muted">Nessun dato disponibile.</div>`;
      return;
    }

    const item = overview.find(it=>it.key===key);
    modalTitle.textContent = item?.label || "Dettaglio articolo";
    modalSub.textContent = item?.subtitle || "Ripartizione per cliente/ordine";
    modalBody.innerHTML = renderSection(item || { key, label:"Articolo", subtitle:"" });
  }

  function openWhModal(key){
    const modal = $("whModal");
    if(!modal) return;
    renderWhModalContent(key || WH_MODAL_ALL_KEY);
    modal.classList.remove("hidden");
    requestAnimationFrame(()=> modal.classList.add("show"));
    lockBody();
  }
  function closeWhModal(){
    const modal = $("whModal");
    if(!modal || !modal.classList.contains("show")) return;
    modal.classList.remove("show");
    setTimeout(()=> modal.classList.add("hidden"), 160);
    unlockBody();
  }

  function getOperatorName(){
    const fromState = (state.user?.fullName || "").trim();
    if(fromState) return fromState;
    const authUser = state.firebase?.auth?.currentUser;
    const dn = (authUser?.displayName || "").trim();
    if(dn) return dn;
    const email = (state.user?.email || authUser?.email || "").trim();
    if(email && email.includes("@")){
      const [beforeAt] = email.split("@");
      if(beforeAt) return beforeAt;
    }
    return "Operatore";
  }

  function formatMonthlyKg(kg){
    const safe = Math.max(0, Number(kg) || 0);
    const rounded = Math.round(safe * 10) / 10;
    const hasDecimal = Math.abs(Math.round(rounded * 10) % 10) !== 0;
    return new Intl.NumberFormat("it-IT", { minimumFractionDigits: hasDecimal ? 1 : 0, maximumFractionDigits: 1 }).format(rounded);
  }

  function formatMonthlyOrders(n){
    const val = Math.max(0, Math.round(Number(n) || 0));
    return val.toLocaleString("it-IT");
  }

  function getMonthlyKpiFromExistingStats(){
    const hist = getStatsHistoryEntries();
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();
    const nameKey = norm(getOperatorName() || "");
    const uid = state.user?.uid || "";
    const filtered = hist.filter(h=>{
      const rawDate = h?.startedAt || h?.endedAt || h?.at;
      if(!rawDate) return false;
      const dt = new Date(rawDate);
      if(!Number.isFinite(dt.getTime())) return false;
      if(dt.getFullYear()!==y || dt.getMonth()!==m) return false;
      if(uid && h.operatorUid) return h.operatorUid === uid;
      if(nameKey) return norm(h.operator||"") === nameKey;
      return false;
    });
    if(!filtered.length) return { kg:0, orders:0 };
    const totKg = filtered.reduce((a,h)=>{
      const v = Number(h.kg);
      return Number.isFinite(v) ? a + v : a;
    }, 0);
    return {
      kg: Number.isFinite(totKg) ? totKg : 0,
      orders: filtered.length
    };
  }

  function renderMobileWelcome(){
    const box = $("mobileWelcome");
    if(!box) return;
    const name = escapeHtml(getOperatorName() || "Operatore");
    const { kg, orders } = getMonthlyKpiFromExistingStats();
    const kgTxt = formatMonthlyKg(kg);
    const ordTxt = formatMonthlyOrders(orders);
    box.innerHTML = `Benvenuto operatore <span class="highlight">${name}</span>, questo mese hai prodotto <span class="kpi">${kgTxt}</span> kg e hai concluso <span class="kpi">${ordTxt}</span> ordini.`;
  }

  function scrollToStatsSection(){
    const target = document.getElementById("statsProduzione") || document.getElementById("statsProdCard") || document.getElementById("statsCardAnchor");
    if(target){
      const nextCard = target.nextElementSibling && target.nextElementSibling.classList?.contains("card") ? target.nextElementSibling : null;
      const el = target.closest(".card") || nextCard || target;
      try{
        el.scrollIntoView({ behavior:"smooth", block:"start" });
      }catch(_e){
        const rect = el.getBoundingClientRect();
        const top = rect.top + window.pageYOffset - 12;
        window.scrollTo({ top, behavior:"smooth" });
      }
      return;
    }
    window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
  }

  function renderHeaderKpis(){
    const kgEl = $("hdrMonthKg");
    const ordEl = $("hdrMonthOrders");
    const deskKgEl = $("deskMonthKg");
    const deskOrdEl = $("deskMonthOrders");
    if(!kgEl || !ordEl) return;
    let kgTxt = "0";
    let ordTxt = "0";
    try{
      const { kg, orders } = getMonthlyKpiFromExistingStats();
      kgTxt = formatMonthlyKg(kg);
      ordTxt = formatMonthlyOrders(orders);
    }catch(_e){}
    kgEl.textContent = kgTxt;
    ordEl.textContent = ordTxt;
    if(deskKgEl) deskKgEl.textContent = kgTxt;
    if(deskOrdEl) deskOrdEl.textContent = ordTxt;
    renderMobileWelcome();
  }

  // ===============================
  // NOTIFICATIONS (inbox + badge)
  // ===============================
  let notifReadCache = null;
  function getNotifReadSet(){
    if(notifReadCache instanceof Set) return notifReadCache;
    try{
      const raw = localStorage.getItem(NOTIF_READ_KEY) || "[]";
      const arr = JSON.parse(raw);
      notifReadCache = new Set(Array.isArray(arr) ? arr.filter(Boolean) : []);
    }catch(_e){
      notifReadCache = new Set();
    }
    return notifReadCache;
  }
  function saveNotifReadSet(set){
    try{ localStorage.setItem(NOTIF_READ_KEY, JSON.stringify(Array.from(set||[]))); }catch(_e){}
    notifReadCache = set instanceof Set ? set : new Set();
  }
  function markNotificationsRead(ids){
    if(!ids || !ids.length) return;
    const set = getNotifReadSet();
    let changed = false;
    for(const id of ids){
      if(id && !set.has(id)){
        set.add(id);
        changed = true;
      }
    }
    if(changed) saveNotifReadSet(set);
  }
  function markAllNotificationsRead(){
    const ids = (state.notifications?.inbox || []).map(n=>n.id).filter(Boolean);
    markNotificationsRead(ids);
    updateNotificationBadge();
  }
  function notifUnreadCount(){
    const set = getNotifReadSet();
    const inbox = (state.notifications && Array.isArray(state.notifications.inbox)) ? state.notifications.inbox : [];
    let n = 0;
    for(const it of inbox){
      if(it && it.id && !set.has(it.id)) n++;
    }
    return n;
  }
  function updateNotificationBadge(){
    const badge = $("pillPushBadge");
    if(!badge) return;
    const unread = notifUnreadCount();
    if(unread>0){
      badge.textContent = unread>99 ? "99+" : String(unread);
      badge.style.display = "inline-flex";
    } else {
      badge.style.display = "none";
    }
  }
  function renderNotifCenter(){
    const list = $("notifList");
    const empty = $("notifEmpty");
    const status = $("notifStatus");
    const unavailable = $("notifUnavailable");
    const adminBox = $("notifAdminBox");
    const toggleBtn = $("btnTogglePush");
    const sub = $("notifSub");
    if(adminBox) adminBox.style.display = state.user && state.user.isAdmin ? "block" : "none";
    const notifs = (state.notifications && Array.isArray(state.notifications.inbox)) ? state.notifications.inbox : [];
    const isUnavailable = Boolean(state.notifications?.unavailable || !state.firebase.ok);
    if(unavailable) unavailable.style.display = isUnavailable ? "flex" : "none";
    if(sub) sub.textContent = isUnavailable ? "UI non disponibile (permessi Firebase)." : "Push, messaggi interni e registro.";
    if(status){
      if(isUnavailable){
        status.textContent = "Centro notifiche non disponibile (permessi o connessione).";
      } else if(state.notifications?.ready){
        status.textContent = notifs.length ? `${notifs.length} notifiche recenti` : "Nessuna notifica recente";
      } else {
        status.textContent = "Caricamento notifiche";
      }
    }
    if(list){
      list.innerHTML = "";
      if(!isUnavailable && notifs.length){
        const readSet = getNotifReadSet();
        const frag = document.createDocumentFragment();
        for(const n of notifs){
          const div = document.createElement("div");
          const isUnread = n?.id && !readSet.has(n.id);
          div.className = `notifItem${isUnread ? " unread" : ""}`;
          let dateTxt = "";
          try{
            const raw = n?.createdAt;
            const dt = raw && typeof raw.toDate==="function" ? raw.toDate() : raw ? new Date(raw) : null;
            if(dt && Number.isFinite(dt.getTime())) dateTxt = fmtDateTime(dt);
          }catch(_e){}
          const creator = n?.createdBy ? `  Da ${escapeHtml(n.createdBy)}` : "";
          div.innerHTML = `
            <div class="notifTitle">${escapeHtml(n?.title || "Aggiornamento")}</div>
            <div class="notifBody">${escapeHtml(n?.body || "")}</div>
            <div class="notifMeta"><span>${escapeHtml(dateTxt)}</span>${creator?`<span>${creator}</span>`:""}</div>`;
          frag.appendChild(div);
        }
        list.appendChild(frag);
      }
      if(empty) empty.style.display = (!isUnavailable && state.notifications?.ready && !notifs.length) ? "block" : "none";
    }
    if(toggleBtn){
      const perm = (typeof Notification !== "undefined") ? Notification.permission : "unsupported";
      toggleBtn.textContent = perm === "granted" ? "Disattiva push" : "Attiva push";
    }
    updateNotificationBadge();
  }
  async function initNotificationsInbox(){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    if(state.notifUnsub){
      try{ state.notifUnsub(); }catch(_e){}
      state.notifUnsub = null;
    }
    try{
      const q = fs.query(
        fs.collection(db, NOTIF_COLLECTION),
        fs.orderBy("createdAt","desc"),
        fs.limit(NOTIF_LIMIT)
      );
      state.notifications.ready = false;
      state.notifications.unavailable = false;
      state.notifUnsub = fs.onSnapshot(q, (snap)=>{
        const arr = [];
        snap.forEach(doc=>arr.push({ id: doc.id, ...doc.data() }));
        state.notifications.inbox = arr;
        state.notifications.ready = true;
        state.notifications.unavailable = false;
        renderNotifCenter();
        updateNotificationBadge();
      }, (err)=>{
        console.warn("notif snapshot err", err);
        state.notifications.unavailable = true;
        state.notifications.ready = true;
        state.notifications.error = err?.code || String(err);
        renderNotifCenter();
      });
    }catch(err){
      console.warn("init notifications failed", err);
      state.notifications.unavailable = true;
      state.notifications.ready = true;
      state.notifications.error = err?.code || String(err);
      renderNotifCenter();
    }
  }
  async function sendAdminNotification(title, body){
    if(!state.firebase.ok) throw new Error("Firebase non disponibile");
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const col = fs.collection(db, NOTIF_COLLECTION);
    await fs.addDoc(col, {
      title: title || "Aggiornamento",
      body: body || "",
      line: "polveri",
      createdAt: fs.serverTimestamp(),
      createdBy: state.user?.fullName || "Admin",
      createdByUid: state.user?.uid || ""
    });
  }
  function openNotifModal(){
    const modal = $("notifModal");
    if(!modal) return;
    modal.classList.add("show");
    lockBody();
    renderNotifCenter();
    markAllNotificationsRead();
  }
  function closeNotifModal(){
    const modal = $("notifModal");
    if(!modal) return;
    modal.classList.remove("show");
    unlockBody();
    updateNotificationBadge();
  }
  function focusCompletedFromNotif(){
    closeNotifModal();
    const card = $("completedCard");
    if(card){
      card.scrollIntoView({ behavior:"smooth", block:"start" });
      card.classList.add("pressCard");
      setTimeout(()=>card.classList.remove("pressCard"), 1200);
    }
  }
  async function togglePushFromCenter(){
    if(typeof Notification === "undefined"){
      showToast("Non supportato", "Questo browser non supporta le notifiche.");
      return;
    }
    const perm = Notification.permission;
    if(perm === "granted"){
      const ok = confirm("Vuoi DISATTIVARE le notifiche push su questo dispositivo?");
      if(ok) await pushDisableFlow();
    } else {
      await pushEnableFlow();
    }
    renderNotifCenter();
    updatePushPill();
  }

  // ===============================
  // PRODUCTION MODAL FLOW
  // ===============================
  function openProdModal(){
    if(!state.user){
      renderAuthLogin("Per iniziare un ordine devi prima accedere con un account autorizzato.");
      return;
    }
    state.prodModalOpenedAt = Date.now();
    state.startedThisSession = false;
    state.prodModalTouched = false;
    $("prodModal").classList.add("show");
    lockBody();
    updateSelectionCounter();
    renderProdStepOrders();
  }

  function closeProdModalRequest(){
    // UI-FIX: remove-motivazione
    $("prodModal").classList.remove("show");
    unlockBody();
  }

  function renderPartialOrdersList(){
    const body = $("partialBody");
    if(!body) return;
    let partial = [];
    try{ partial = computePartialOrders().partial || []; }catch(_e){ partial = []; }
    const partialSet = new Set(partial.map(p=>String(p.orderNo||p.number||"")));
    const { baseOrders } = buildOrderViews({ applyRoleVisibility:false, includeHidden:true });
    const rows = baseOrders.filter(o=>partialSet.has(String(o.orderNo||o.number||"")));
    if(!rows.length){
      body.innerHTML = `<div class="muted">Nessun ordine parzialmente concluso.</div>`;
      return;
    }
    body.innerHTML = `<div class="list" id="partialList"></div>`;
    const list = body.querySelector("#partialList");
    list.classList.add("chunkyList");
    rows.forEach(o=>{
      const done = o.partialInfo?.done || 0;
      const total = o.partialInfo?.total || (done + (o.lines?.length||0) + (o.autoDone||0));
      const div = document.createElement("div");
      div.className = "item pressCard rowPress";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name ellipsis" title="${escapeHtml(o.customer||"Cliente")}  Ordine ${escapeHtml(o.orderNo||o.number||"")}">${escapeHtml(o.customer||"Cliente")}  Ordine ${escapeHtml(o.orderNo||o.number||"")}</div>
            <div class="sub">Conclusione prevista: <b>${escapeHtml(o.conclusion||"")}</b></div>
            <div class="muted" style="margin-top:6px;">Righe concluse: ${done}/${total}  Kg: ${Math.round(o.totalKg||0)}</div>
          </div>
          <div class="badge" style="border-color:var(--warn); color:var(--warn);">Parziale</div>
        </div>`;
      div.onclick = ()=>{
        $("partialModal").classList.remove("show");
        unlockBody();
        openProdModal();
        setTimeout(()=>renderOrderDetail(o), 60);
      };
      list.appendChild(div);
    });
  }

  async function startSelectedProductions(contextOrder){
    const { baseOrders } = buildOrderViews({ applyRoleVisibility:false, includeHidden:true });
    pruneSelectionAgainstOrders(baseOrders);
    const groups = groupSelectionByOrder();
    updateSelectionCounter();
    if(!groups.size){
      showToast("Seleziona righe", "Non hai selezionato righe da avviare.");
      return;
    }
    const opName = (state.user?.fullName || state.operator || 'Operatore');
    const baseMap = new Map(baseOrders.map(o=>[`${o.orderNo||o.number||""}__${o.customer||""}`, o]));
    let launched = 0;
    let totalLines = 0;
    for(const [key, group] of groups.entries()){
      const base = baseMap.get(key);
      if(!base) continue;
      const availableLines = (base.lines||[]).filter(l=>l.status!=="active");
      const selectedKeys = new Set((group.lines||[]).map(l=>String(l.lineKey||"")));
      const selectedLines = availableLines.filter(l=>selectedKeys.has(String(l.lineKey||"")));
      if(!selectedLines.length) continue;
      const isFullOrderStart = availableLines.length>0 && availableLines.every(l=>selectedKeys.has(String(l.lineKey||"")));
      const totalKg = selectedLines.reduce((a,l)=>a + estimateLineKg(l), 0) || base.totalKg || 0;
      const prod = {
        operator: opName,
        customer: base.customer,
        orderNo: base.orderNo || base.number,
        conclusion: base.conclusion || "",
        totalKg,
        selectedLineKeys: selectedLines.map(l=>l.lineKey),
        isFullOrderStart,
        startedAt: nowIso(),
        active: true
      };
      await upsertActiveProduction(prod);
      const machineHint = machineHintFromLines(selectedLines);
      const machineMsg = machineHint==="small" ? " Utilizzare macchina piccola per fare questo ordine." : " Utilizzare macchina grande.";
      speak(`Ordine: operatore ${opName} ha avviato ordine ${prod.orderNo} del cliente ${prod.customer}.${machineMsg}`);
      launched++;
      totalLines += selectedLines.length;
    }
    if(!launched){
      showToast("Selezione non valida", "Seleziona righe non gi in produzione.");
      return;
    }
    state.startedThisSession = true;
    ensureSelectionState().clear();
    updateSelectionCounter();
    $("prodModal").classList.remove("show");
    unlockBody();
    const targetOrder = contextOrder ? `Ordine n. ${contextOrder.orderNo||contextOrder.number||""}` : "Ordini selezionati";
    showToast("Produzione avviata", `${targetOrder}  ${launched} ordini  ${totalLines} righe`);
  }

  function renderProdStepOperator(){
    // (disattivato) operatore gi identificato da accesso
    renderProdStepOrders();
  }

  async function renderProdStepOrders(){
    $("prodModalTitle").textContent = "Produzione  Ordini";
    const body = $("prodModalBody");
    const { orders, baseOrders } = buildOrderViews();
    pruneSelectionAgainstOrders(baseOrders);
    updateSelectionCounter();
    orders.sort((a,b)=>{
      const ra = a.priorityInfo?.priority==="today" ? 0 : a.priorityInfo?.priority==="scheduled" ? 1 : 2;
      const rb = b.priorityInfo?.priority==="today" ? 0 : b.priorityInfo?.priority==="scheduled" ? 1 : 2;
      return ra - rb;
    });
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    let planMessageHtml = "";
    if(isDesktop){
      if(isAdmin){
        planMessageHtml = `<div class="planMessage"><div class="headline">Vista admin</div><div class="muted">Tutti gli ordini (anche oltre 3 giorni) sono visibili per la pianificazione.</div></div>`; // CODEX: messaggio visibilit admin desktop
      } else {
        const windowOrders = baseOrders.filter(o=>o.daysAway==null || o.daysAway<=3);
        const listHtml = windowOrders.slice(0,8).map(o=>`<li>${escapeHtml(o.customer||"Cliente")}  Ord. ${escapeHtml(o.orderNo||o.number||"")}${o.conclusion?`  ${escapeHtml(o.conclusion)}`:""}</li>`).join("") || `<li>Nessuna data pianificata disponibile.</li>`;
        planMessageHtml = `<div class="planMessage"><div class="headline">Ci sono ${baseOrders.length} ordini da fare. In base alla pianificazione, puoi andare in produzione con questi ${windowOrders.length} ordini:</div><ul>${listHtml}</ul></div>`; // CODEX: messaggio finestra 3 giorni per operatori desktop
      }
    }
    body.innerHTML = `
      <div class="stepTitle">Ordini disponibili</div>
      <div class="muted">Operatore: <b>${state.user?.fullName || ""}</b>. Tocca un cliente: vedrai gli ordini separati per numero.</div>
      ${planMessageHtml}
      <div style="height:10px"></div>
      <div class="list" id="orderList"></div>
    `;

    const list = body.querySelector("#orderList");
    list.classList.add("chunkyList");
    if(!orders.length){
      const windowHasOrders = baseOrders.some(o=>o.daysAway==null || o.daysAway<=3);
      const emptyMsg = (isDesktop && !isAdmin && baseOrders.length && !windowHasOrders)
        ? "Nessun ordine pianificato entro i prossimi 3 giorni."
        : "Nessun ordine disponibile (attendi sincronizzazione).";
      list.innerHTML = `<div class="muted">${emptyMsg}</div>
        <div style="height:10px"></div>
        <button class="btn" id="btnRetry" style="width:100%;">Riprova sincronizzazione</button>`;
      body.querySelector("#btnRetry").onclick = async()=>{
        body.querySelector("#btnRetry").textContent = "Sincronizzo";
        await queuedSyncOrders(false, "manual_retry");
        renderProdStepOrders();
      };
      return;
    }

    const byCust = new Map();
    for(const o of orders){
      const key = o.customer || "Cliente";
      if(!byCust.has(key)) byCust.set(key, []);
      byCust.get(key).push(o);
    }

    const groups = Array.from(byCust.entries());
    await appendChunked(list, groups, ([cust, arr])=>{
      const sec = document.createElement("div");
      sec.className = "item";
      sec.innerHTML = `<div class="top"><div><div class="name">${cust}</div><div class="sub">${arr.length} ordini</div></div><div class="badge">Apri</div></div>`;
      sec.style.cursor = "pointer";
      sec.onclick = ()=>{ renderCustomerOrders(cust, arr); };
      return sec;
    }, 120);
  }

  async function renderCustomerOrders(cust, orders){
    $("prodModalTitle").textContent = `Produzione  ${cust}`;
    const body = $("prodModalBody");
    body.innerHTML = `
      <div class="stepTitle">Ordini per ${cust}</div>
      <div class="muted">Ordini separati per numero. Apri un ordine per vedere le righe.</div>
      <div style="height:10px"></div>
      <div class="list" id="custOrders"></div>
      <div style="height:12px"></div>
      <button class="btn ghost" id="btnBackOrders" style="width:100%;"> Torna alla lista clienti</button>
    `;
    body.querySelector("#btnBackOrders").onclick = renderProdStepOrders;

    const list = body.querySelector("#custOrders");
    list.classList.add("chunkyList");
    await appendChunked(list, orders, (o)=>{
      const div = document.createElement("div");
      div.className = "item";
      div.style.cursor = "pointer";
      const totalQty = o.lines.reduce((a,l)=>a + Number(l.qty||0), 0);
      const priority = o.priorityInfo?.priority || "normal";
      const badgeText = priority==="today" ? "Priorit" : o.partialInfo ? "Parziale" : "Apri";
      const alertTag = (o.alerts&&o.alerts.length) ? `<div class="muted" style="margin-top:6px;">Avvisi: ${o.alerts.length}</div>` : "";
      const selectedCount = selectedEntriesForOrder(o).length;
      const selectionTag = selectedCount ? `<div class="muted" style="margin-top:6px; color:rgba(10,58,125,.92); font-weight:900;">Righe selezionate: ${selectedCount}</div>` : "";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">Ordine n. ${o.orderNo || o.number}</div>
            <div class="sub">Righe: ${o.lines.length}  Quantit: ${formatQtyWithKg(totalQty, "kg")}  Conclusione: ${o.conclusion||""}</div>
            ${o.partialInfo ? `<div class="muted" style="margin-top:6px;">Ordine parzialmente concluso (${o.partialInfo.done}/${o.partialInfo.total}).</div>`:""}
            ${o.priorityInfo?.reason ? `<div class="muted" style="margin-top:6px;">${escapeHtml(o.priorityInfo.reason)}</div>`:""}
            ${alertTag}
            ${selectionTag}
          </div>
          <div class="badge">${badgeText}</div>
        </div>`;
      div.onclick = ()=>renderOrderDetail(o);
      return div;
    }, 120);
  }

  function renderOrderDetail(order){
    const orderNo = order.orderNo || order.number;
    $("prodModalTitle").textContent = `Ordine n. ${orderNo}`;
    const body = $("prodModalBody");
    const lines = order.lines || [];
    const alerts = order.alerts || [];
    const alertHtml = alerts.length ? `<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${alerts.map(a=>{
      const palette = alertPalette(a.alertInfo?.color);
      const style = `background:${palette.bg};border-color:${palette.border};color:${palette.color};${palette.shadow?`box-shadow:${palette.shadow};`:``}`;
      return `<div class="alertBanner" style="${style}"><div class="label">${escapeHtml(a.desc||a.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`;
    }).join("")}</div>` : "";
    body.innerHTML = `
      <div class="stepTitle">${order.customer}</div>
      <div class="muted">Seleziona le righe da produrre, poi avvia. (Seleziona tutto = ordine completo)</div>
      ${order.partialInfo ? `<div class="warnBanner" style="margin:10px 0 6px;">
        <div class="icon"></div>
        <div class="txt">
          <div class="t">Ordine parzialmente concluso</div>
          <div class="s">Restano ${order.partialInfo.total - order.partialInfo.done} righe da completare.</div>
        </div>
      </div>` : ``}
      ${alertHtml}
      ${order.conclusion ? `<div class="muted" style="margin:6px 0 8px; font-weight:800;">Conclusione prevista: <b>${escapeHtml(order.conclusion)}</b></div>`:""}
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAll">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAll">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="lineList"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnStartProd" style="width:100%;">INIZIA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackCust" style="width:100%;"> Torna agli ordini cliente</button>
    `;

    const globalSelection = ensureSelectionState();
    const selected = new Set(selectedEntriesForOrder(order).map(x=>String(x.lineKey)));
    const lineList = body.querySelector("#lineList");
    lineList.classList.add("chunkyList");

    async function rerenderLines(){
      selected.clear();
      selectedEntriesForOrder(order).forEach(x=>selected.add(String(x.lineKey)));
      await appendChunked(lineList, lines, (l)=>{
        const id = l.lineKey;
        const selectionKey = makeSelectionKey(order, l);
        const div = document.createElement("div");
        const checked = selected.has(id) || globalSelection.has(selectionKey);
        const isActive = l.status === "active";
        const isMineActive = Boolean(isActive && l.activeIsMe && l.activeProd);
        const isBlocked = isActive && !isMineActive;
        div.className = `item pressCard selectableLine${checked ? " selected" : ""}`;
        div.style.cursor = isBlocked ? "not-allowed" : "pointer";
        const qtyLabel = formatQtyWithKg(l.qty, l.um);
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${l.desc}</div>
              <div class="sub" style="font-size:13px; font-weight:900;">Quantit: <span style="font-size:15px;">${qtyLabel}</span></div>
              ${l.code?`<div class="muted" style="margin-top:6px;">Cod: <b>${l.code}</b></div>`:""}
              ${l.conclusion ? `<div class="muted" style="margin-top:6px;">Conclusione prevista: ${escapeHtml(l.conclusion)}</div>`:""}
              ${isActive ? `<div class="muted" style="margin-top:6px; font-weight:800;">In produzione da ${escapeHtml(isMineActive ? "te" : (l.activeOp||"operatore"))}  ${isMineActive ? "tocca per riaprire." : "riapri la produzione in corso."}</div>` : ""}
            </div>
            <div class="badge">${checked ? "" : (isBlocked ? "Bloccato" : "Seleziona")}</div>
          </div>
        `;
        if(!isActive){
          div.onclick = ()=>{
            const meta = {
              orderNo,
              customer: order.customer,
              lineKey: l.lineKey,
              desc: l.desc,
              qty: l.qty,
              um: l.um,
              packKg: l.packKg,
              lineKg: l.lineKg,
              conclusion: l.conclusion || order.conclusion || "",
              orderConclusion: order.conclusion || "",
              totalKg: order.totalKg || 0
            };
            if(selected.has(id) || globalSelection.has(selectionKey)){
              selected.delete(id);
              globalSelection.delete(selectionKey);
            } else {
              selected.add(id);
              globalSelection.set(selectionKey, meta);
            }
            state.prodModalTouched = true;
            rerenderLines();
            updateSelectionCounter();
          };
        } else if(isMineActive){
          div.onclick = ()=>{
            try{
              openRunningModal();
              setTimeout(()=>{ try{ renderRunningDetail(l.activeProd); }catch(_e){} }, 60);
            }catch(_e){}
            showToast("In produzione", "Questa riga  gi in produzione da te. Apro la produzione in corso");
          };
        } else {
          div.onclick = ()=> showToast("In produzione", `Riga gi avviata da ${l.activeOp||"un operatore"}.`);
        }
        return div;
      }, 100);
      const totalSelected = selectionCount();
      const startBtn = body.querySelector("#btnStartProd");
      startBtn.disabled = totalSelected===0;
      startBtn.style.opacity = totalSelected===0 ? ".6" : "1";
      startBtn.textContent = totalSelected>0 ? `INIZIA PRODUZIONE (${totalSelected})` : "INIZIA PRODUZIONE";
    }

    body.querySelector("#btnSelAll").onclick = ()=>{
      lines.filter(l=>l.status!=="active").forEach(l=>{
        selected.add(l.lineKey);
        const key = makeSelectionKey(order, l);
        globalSelection.set(key, {
          orderNo,
          customer: order.customer,
          lineKey: l.lineKey,
          desc: l.desc,
          qty: l.qty,
          um: l.um,
          packKg: l.packKg,
          lineKg: l.lineKg,
          conclusion: l.conclusion || order.conclusion || "",
          orderConclusion: order.conclusion || "",
          totalKg: order.totalKg || 0
        });
      });
      state.prodModalTouched = true;
      rerenderLines();
      updateSelectionCounter();
    };
    body.querySelector("#btnClrAll").onclick = ()=>{
      clearSelectionForOrder(order);
      selected.clear();
      state.prodModalTouched = true;
      rerenderLines();
      updateSelectionCounter();
    };
      body.querySelector("#btnBackCust").onclick = ()=>{
        const custOrders = buildOrderViews().orders.filter(o=>o.customer===order.customer);
        renderCustomerOrders(order.customer, custOrders);
      };

      body.querySelector("#btnStartProd").onclick = async()=>{
      if(selectionCount()===0) return;
      await startSelectedProductions(order);
      };

    rerenderLines();
  }

  // ===============================
  // RUNNING MODAL
  // ===============================
  function openRunningModal(){
    $("runningModal").classList.add("show");
    lockBody();
    renderRunning();
  }

  function renderRunning(){
    const body = $("runningBody");
    const active = state.activeProductions || [];
    if(!active.length){
      body.innerHTML = `<div class="muted">Nessuna produzione attiva al momento.</div>`;
      return;
    }
    body.innerHTML = `<div class="stepTitle">Attivit in corso</div><div class="muted">Apri per vedere dettagli e concludere la produzione.</div><div style="height:10px"></div><div class="list" id="runList"></div>`;
    const list = body.querySelector("#runList");
    list.classList.add("chunkyList");

    active
      .sort((a,b)=> (new Date(a.startedAt||0)) - (new Date(b.startedAt||0)))
      .forEach(p=>{
        const elapsedMin = p.startedAt ? Math.floor((Date.now() - new Date(p.startedAt).getTime())/60000) : 0;
        const ratio = prodRatio(p);
        const hue = Math.max(0, 120 - (120 * Math.min(1,ratio)));
        const div = document.createElement("div");
        div.className = "item";
        div.style.cursor = "pointer";
        div.style.borderColor = `hsla(${hue}, 80%, 55%, .35)`;
        div.style.background = `hsla(${hue}, 80%, 45%, .14)`;
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${p.operator||"Operatore"}  Ordine n. ${p.orderNo||""}</div>
              <div class="sub">${p.customer||"Cliente"}  ${Math.round(Number(p.totalKg||0))} kg  In corso da ${elapsedMin} min  Conclusione: ${p.conclusion||""}</div>
            </div>
            <div class="badge">Apri</div>
          </div>
        `;
        div.onclick = ()=>renderRunningDetail(p);
        list.appendChild(div);
      });
  }

  function renderRunningDetail(p){
    const body = $("runningBody");
    const order = state.powderOrders.find(o=>o.number===p.orderNo && o.customer===p.customer) || null;
    const selected = new Set(p.selectedLineKeys || []);
    const toConclude = new Set(selected);
    const producedKg = new Map();

    const availableLines = order ? order.lines.filter(l=>selected.has(l.lineKey)) : [];
    const alerts = order?.alerts || [];
    const alertHtml = alerts.length ? `<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${alerts.map(a=>{
      const palette = alertPalette(a.alertInfo?.color);
      const style = `background:${palette.bg};border-color:${palette.border};color:${palette.color};${palette.shadow?`box-shadow:${palette.shadow};`:``}`;
      return `<div class="alertBanner" style="${style}"><div class="label">${escapeHtml(a.desc||a.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`;
    }).join("")}</div>` : "";
    body.innerHTML = `
      <div class="stepTitle">${p.operator||"Operatore"}  Ordine n. ${p.orderNo}</div>
      <div class="muted">${p.customer}  Seleziona cosa stai concludendo, poi premi Ho concluso la produzione.</div>
      ${alertHtml}
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAllRun">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAllRun">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="runLines"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnConclude" style="width:100%;">HO CONCLUSO LA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn bad" id="btnCancelProd" style="width:100%;">Annulla produzione in corso</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackRun" style="width:100%;"> Torna a elenco produzioni</button>
    `;

    const runLines = body.querySelector("#runLines");
    function rerender(){
      runLines.innerHTML = "";
      for(const l of availableLines){
        const checked = toConclude.has(l.lineKey);
        const div = document.createElement("div");
        div.className = `item pressCard selectableLine${checked ? " selected" : ""}`;
        const lineConclusion = l.conclusion || (order?.conclusion || "");
        div.style.cursor = "pointer";
        div.style.borderColor = checked ? "rgba(46,123,255,.55)" : "rgba(255,255,255,.12)";
        const isWhiteBag = isWhiteBagRow(l); // CODEX: riga solo banner se sacchetto bianco
        if(isWhiteBag){
          div.innerHTML = renderWhiteBagBanner({ selectable: true, checked });
        } else {
          const qtyLabel = formatQtyWithKg(l.qty, l.um);
          div.innerHTML = `
            <div class="top">
              <div>
                <div class="name">${l.desc}</div>
                <div class="sub">Quantit: ${qtyLabel}  Cod: ${l.code||""}${lineConclusion?`  Conclusione: ${lineConclusion}`:""}</div>
                <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
                  <div class="muted" style="font-size:12px; font-weight:900; min-width:150px;">Quantit prodotta (kg, opzionale)</div>
                  <input class="kgInput" data-k="${l.lineKey}" type="number" inputmode="decimal" step="0.1" placeholder="auto" style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--stroke); background: rgba(0,0,0,.02); font-weight:900;"/>
                </div>
              </div>
              <div class="badge">${checked ? "" : "Seleziona"}</div>
            </div>`;
          const inp = div.querySelector(".kgInput");
          if(inp){
            const prev = producedKg.get(l.lineKey);
            if(prev!=null) inp.value = prev;
            inp.addEventListener("click", (e)=>e.stopPropagation());
            inp.addEventListener("touchstart", (e)=>e.stopPropagation(), {passive:true});
            inp.addEventListener("input", ()=>{ producedKg.set(l.lineKey, inp.value); });
          }
        }

        div.onclick = ()=>{
          if(toConclude.has(l.lineKey)) toConclude.delete(l.lineKey); else toConclude.add(l.lineKey);
          rerender();
        };
        runLines.appendChild(div);
      }
      $("btnConclude").disabled = toConclude.size===0;
      $("btnConclude").style.opacity = toConclude.size===0 ? ".6" : "1";
      const btn = $("btnConclude");
      if(btn && btn.classList.contains("isBusy")){
        btn.disabled = true;
        btn.setAttribute("aria-disabled","true");
        btn.style.opacity = ".82";
      } else if(btn){
        btn.removeAttribute("aria-disabled");
      }
    }

    body.querySelector("#btnSelAllRun").onclick = ()=>{
      for(const k of selected) toConclude.add(k);
      rerender();
    };
    body.querySelector("#btnClrAllRun").onclick = ()=>{
      toConclude.clear();
      rerender();
    };
    body.querySelector("#btnBackRun").onclick = renderRunning;
    const orderKey = order ? getOrderKey(order) : stableKey({ orderNo:p.orderNo, number:p.orderNo, id:p.id||p.orderNo, customer:p.customer });

    const canCancel = Boolean(state.user && state.user.isAdmin);
    if(!canCancel){
      body.querySelector("#btnCancelProd").style.display = "none";
    } else {
      body.querySelector("#btnCancelProd").onclick = async()=>{
        if(!confirm("Sei sicuro che vuoi annullare la produzione in corso?")) return;
        await closeActiveProduction(p.id, { cancelled:true });
        showToast("Produzione annullata", `Ordine n. ${p.orderNo}  ${p.customer}`);
        showCancelBanner(`Ordine n. ${p.orderNo}  ${p.customer}`);
        setTimeout(()=>hideCancelBanner(), 6500);
        renderRunning();
        renderHome();
      };
    }

    const concludeBtn = body.querySelector("#btnConclude");
    const inflightMap = globalThis.__CONCLUDE_INFLIGHT__;
    const recentMap = globalThis.__CONCLUDE_RECENT__;

    const setConcludeBusy = (isBusy, label="Conclusione")=>{
      if(!concludeBtn) return;
      if(!concludeBtn.dataset.defaultLabel){
        concludeBtn.dataset.defaultLabel = concludeBtn.textContent || "HO CONCLUSO LA PRODUZIONE";
      }
      if(isBusy){
        concludeBtn.classList.add("isBusy");
        concludeBtn.setAttribute("aria-disabled","true");
        concludeBtn.disabled = true;
        concludeBtn.innerHTML = `<span class="btnLabel"><span class="miniSpinner" aria-hidden="true"></span>${label}</span>`;
      } else {
        concludeBtn.classList.remove("isBusy");
        concludeBtn.removeAttribute("aria-disabled");
        concludeBtn.disabled = toConclude.size===0;
        concludeBtn.innerHTML = concludeBtn.dataset.defaultLabel;
        concludeBtn.style.opacity = concludeBtn.disabled ? ".6" : "1";
      }
    };
    const markConcludeCompleted = ()=>{
      if(!concludeBtn) return;
      concludeBtn.classList.add("isBusy");
      concludeBtn.disabled = true;
      concludeBtn.setAttribute("aria-disabled","true");
      concludeBtn.innerHTML = `<span class="btnLabel">Concluso</span>`;
      concludeBtn.style.opacity = ".92";
    };
    const isOrderAlreadyConcluded = async()=>{
      try{
        if(!order) return false;
        const totalLines = (order.lines||[]).filter(l=>!isNonProductionLine(l)).length;
        if(totalLines<=0) return false;
        const done = new Set();
        for(const h of (state.history||[])){
          if(!h) continue;
          const same = String(h.orderNo||"")===String(p.orderNo||"") || (h.orderKey && h.orderKey===orderKey);
          if(!same) continue;
          const arr = Array.isArray(h.concludedLineKeys) ? h.concludedLineKeys : [];
          for(const k of arr){ if(k) done.add(String(k)); }
        }
        return done.size >= totalLines;
      }catch(_e){
        return false;
      }
    };

    if(concludeBtn && !concludeBtn.__handlerBound){
      concludeBtn.__handlerBound = true;
      globalThis.__CONCLUDE_HANDLER_BOUND__ = true;
      concludeBtn.addEventListener("click", async()=>{
        if(!toConclude.size) return;

        const now = Date.now();
        if(inflightMap.get(orderKey) === true) return;
        if(now - (recentMap.get(orderKey)||0) < 2500) return;
        inflightMap.set(orderKey, true);
        recentMap.set(orderKey, now);
        let concluded = false;
        try{
          setConcludeBusy(true, "Conclusione");

          if(await isOrderAlreadyConcluded()){
            markConcludeCompleted();
            showToast("Ordine gi concluso", `Ordine n. ${p.orderNo}  ${p.customer}`);
            concluded = true;
            return;
          }

          const allStarted = toConclude.size === selected.size;
          const askConfirm = Boolean(p.isFullOrderStart) && allStarted;
          if(askConfirm && !confirm("Stai concludendo lintero ordine. Confermi?")) return;

          const startedAtMs = p.startedAt ? new Date(p.startedAt).getTime() : Date.now();
          const durationMs = Date.now() - startedAtMs;

          // calcolo kg + dettagli righe
          let kg = 0;
          const perLine = [];
          if(order){
            const m = new Map(order.lines.map(l=>[l.lineKey,l]));
            for(const k of toConclude){
              const l = m.get(k);
              if(!l) continue;
              const raw = producedKg.get(k);
              const val = raw!=null && String(raw).trim()!=="" ? Number(String(raw).replace(",", ".")) : NaN;
              const fallback = Number(l.qty||0);
              const prodVal = Number.isFinite(val) ? val : (Number.isFinite(fallback) ? fallback : (l.lineKg||0));
              kg += prodVal;
              perLine.push({
                lineKey: k,
                desc: l.desc,
                code: l.code || "",
                plannedKg: Number(l.lineKg||0),
                producedKg: Number(prodVal||0),
                qty: l.qty,
                um: l.um || ""
              });
            }
          } else {
            kg = Number(p.totalKg||0);
          }

          const ctx = `${p.customer}  Ordine n. ${p.orderNo}  ${Math.round(kg)} kg`;
          const concludedOk = await new Promise((resolve)=>{
            openSignModal(ctx, async(signatureDataUrl)=>{
              await closeActiveProduction(p.id, { concluded:true });

              const entry = {
                orderKey,
                operator: (state.user?.fullName || p.operator || "Operatore"),
                operatorUid: state.user?.uid || "",
                customer: p.customer,
                orderNo: p.orderNo,
                kg,
                durationMs,
                startedAt: p.startedAt || nowIso(),
                endedAt: nowIso(),
                concludedLineKeys: Array.from(toConclude),
                totalKgOrder: Number(p.totalKg||0),
                perLine,
                signature: signatureDataUrl,
                statementAccepted: true
              };

              const newId = await addHistory(entry);
              const withId = { ...entry, id: newId || `${Date.now()}_${Math.random().toString(16).slice(2)}`, at: nowIso() };
              state.history = [...(state.history||[]), withId];
              state.historyReady = true;
              try{ await bumpGlobalStats(1, kg); }catch(_e){}
              try{ renderCompletedSection(); }catch(_e){}
              state.activeProductions = (state.activeProductions||[]).filter(x=>x.id!==p.id);
              try{ state.partialOrders = computePartialOrders().partial; }catch(_e){}
              renderHome();
              renderHeaderKpis();

              // aggiorna classifica kg (aggregato)
              try{
                await bumpOperatorKg(state.user?.uid || "", state.user?.fullName || p.operator || "Operatore", kg);
              }catch(_e){}

              speak(`Ordine concluso da ${(state.user?.fullName||p.operator||"Operatore")}  ordine ${p.orderNo}  cliente ${p.customer}`);

              showToast("Produzione conclusa", `Operatore ${(state.user?.fullName||p.operator||"Operatore")}  Ordine n. ${p.orderNo}  ${Math.round(kg)} kg`);
              showToast("Ordine concluso", `Ordine n. ${p.orderNo} registrato tra i conclusi.`, 2200);
              renderRunning();
              markConcludeCompleted();
              concludeBtn.blur?.();
              resolve(true);
            }, ()=>resolve(false));
          });
          concluded = Boolean(concludedOk);
        } catch(err){
          console.error("Errore conclusione", err);
          showToast("Errore conclusione", "Riprova tra poco o verifica la connessione.");
        } finally{
          inflightMap.set(orderKey, false);
          if(!concluded){
            setConcludeBusy(false, concludeBtn?.dataset?.defaultLabel || "HO CONCLUSO LA PRODUZIONE");
          }
        }
      });
      (async()=>{
        if(await isOrderAlreadyConcluded()){
          markConcludeCompleted();
        }
      })();
    }

    rerender();
  }

  function openPartialModal(){
    $("partialModal").classList.add("show");
    lockBody();
    renderPartialOrdersList();
  }
  function closePartialModal(){
    $("partialModal").classList.remove("show");
    unlockBody();
  }

  
  // ===============================
  // SIGNATURE PAD
  // ===============================
  const sig = { canvas:null, ctx:null, drawing:false, empty:true, last:{x:0,y:0}, dpr:1 };
  function sigInit(){
    if(sig.canvas){ sig.resize?.(); return; }
    sig.canvas = $("signCanvas");
    sig.canvas.style.touchAction = "none";
    sig.canvas.style.pointerEvents = "auto";
    sig.ctx = sig.canvas.getContext("2d");
    sig.ctx.lineCap = "round";
    sig.ctx.lineJoin = "round";
    sig.ctx.lineWidth = 3.2;
    sig.ctx.strokeStyle = "#000";

    function resize(){
      const rect = sig.canvas.getBoundingClientRect();
      sig.dpr = Math.max(1, window.devicePixelRatio || 1);
      sig.canvas.width = Math.floor(rect.width * sig.dpr);
      sig.canvas.height = Math.floor(rect.height * sig.dpr);
      sig.ctx.setTransform(sig.dpr,0,0,sig.dpr,0,0);
      sig.ctx.clearRect(0,0,rect.width,rect.height);
      sig.empty = true;
    }
    sig.resize = resize;
    resize();
    window.addEventListener("resize", resize);

    function pos(e){
      const rect = sig.canvas.getBoundingClientRect();
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      return { x: p.clientX - rect.left, y: p.clientY - rect.top };
    }
    function down(e){
      e.preventDefault();
      sig.drawing = true;
      const p = pos(e);
      sig.last = p;
    }
    function move(e){
      if(!sig.drawing) return;
      e.preventDefault();
      const p = pos(e);
      sig.ctx.beginPath();
      sig.ctx.moveTo(sig.last.x, sig.last.y);
      sig.ctx.lineTo(p.x, p.y);
      sig.ctx.stroke();
      sig.last = p;
      sig.empty = false;
    }
    function up(e){
      if(!sig.drawing) return;
      e.preventDefault();
      sig.drawing = false;
    }

    sig.canvas.addEventListener("pointerdown", down);
    sig.canvas.addEventListener("pointermove", move);
    window.addEventListener("pointerup", up);
    sig.canvas.addEventListener("touchstart", down, {passive:false});
    sig.canvas.addEventListener("touchmove", move, {passive:false});
    window.addEventListener("touchend", up, {passive:false});
  }

  function sigClear(){
    if(!sig.canvas) return;
    const rect = sig.canvas.getBoundingClientRect();
    sig.ctx.clearRect(0,0,rect.width,rect.height);
    sig.empty = true;
  }

  function openSignModal(contextText, onOk, onCancel){
    sigInit();
    $("signCheck").checked = false;
    $("signContext").textContent = contextText;
    sigClear();
    $("signModal").classList.add("show");
    lockBody();
    requestAnimationFrame(()=> sig.resize?.()); // CODEX: forza ridimensionamento firma quando visibile

    let handled = false;
    const close = (wasCancelled=false)=>{
      if(handled) return;
      handled = true;
      $("signModal").classList.remove("show");
      unlockBody();
      $("signOk").onclick = null;
      if(wasCancelled && typeof onCancel==="function"){
        onCancel();
      }
    };

    $("signClose").onclick = ()=>close(true);
    $("signClear").onclick = ()=>sigClear();
    $("signOk").onclick = ()=>{
      if(!$("signCheck").checked){
        showToast("Conferma richiesta", "Spunta la dichiarazione prima di concludere.");
        return;
      }
      if(sig.empty){
        showToast("Firma richiesta", "Inserisci la firma prima di concludere.");
        return;
      }
      const dataUrl = sig.canvas.toDataURL("image/png");
      close();
      onOk(dataUrl);
    };
  }


  // ===============================
  // PUSH (PWA + FCM Web Push)
  // ===============================
  function isIOS(){
    return /iphone|ipad|ipod/i.test(navigator.userAgent || "");
  }
  function isStandalone(){
    // iOS: navigator.standalone; others: display-mode
    return (window.navigator.standalone === true) || window.matchMedia("(display-mode: standalone)").matches;
  }

  function updatePushPill(){
    const dot = $("#dotPush");
    const txt = $("#txtPush");
    if(!dot || !txt) return;

    const perm = (typeof Notification !== "undefined") ? Notification.permission : "unsupported";
    state.push.permission = perm;

    if(!state.push.supported){
      dot.className = "dot";
      txt.textContent = "Notifiche: non supportate";
      return;
    }
    if(perm !== "granted"){
      dot.className = "dot";
      txt.textContent = "Notifiche: disattive";
      return;
    }
    dot.className = "dot ok";
    txt.textContent = "Notifiche: attive";
  }

  async function registerPushSW(){
    if(!("serviceWorker" in navigator)) throw new Error("Service worker non supportati");
    // Scope: cartella attuale (/tabellone-produzione-live/)
    const swUrl = new URL("firebase-messaging-sw.js", location.href).toString();
    const reg = await navigator.serviceWorker.register(swUrl, { scope: "./" });
    return reg;
  }

  async function savePushToken(token){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const u = state.user || {};
    const id = await tokenDocId(token);
    const ref = fs.doc(db, "powderPushTokens", id);
    await fs.setDoc(ref, {
      token,
      uid: u.uid || "",
      email: u.email || "",
      displayName: u.fullName || u.displayName || "",
      role: (u.isAdmin ? "admin" : "operator"),
      line: "polveri",
      userAgent: navigator.userAgent || "",
      platform: isIOS() ? "ios" : /android/i.test(navigator.userAgent||"") ? "android" : "desktop",
      enabled: true,
      lastSeenAt: fs.serverTimestamp(),
      createdAt: fs.serverTimestamp()
    }, { merge:true });
  }

  async function deletePushToken(token){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = await tokenDocId(token);
    try{ await fs.deleteDoc(fs.doc(db, "powderPushTokens", id)); }catch(_e){}
  }

  async function tokenDocId(token){
    // doc id robusto e corto (sha256)
    const enc = new TextEncoder().encode(token);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  async function pushEnableFlow(){
    if(!state.push.supported){
      showToast("Notifiche non supportate", "Questo browser/dispositivo non supporta le push per questa app.");
      return;
    }

    const perm = await Notification.requestPermission();
    state.push.permission = perm;

    if(perm !== "granted"){
      showToast("Notifiche non abilitate", "Permesso negato o non concesso.");
      updatePushPill();
      return;
    }

    try{
      const fm = state.firebase.msgApi;
      const messaging = state.firebase.messaging;
      const swReg = await registerPushSW();

      const token = await fm.getToken(messaging, {
        vapidKey: FCM_VAPID_KEY,
        serviceWorkerRegistration: swReg
      });

      if(!token){
        showToast("Errore notifiche", "Token non generato. Controlla VAPID key in Firebase Console.");
        updatePushPill();
        return;
      }

      state.push.token = token;
      state.push.enabled = true;

      await savePushToken(token);

      // Foreground messages  toast
      try{
        fm.onMessage(messaging, (payload)=>{
          const title = payload?.notification?.title || "Aggiornamento";
          const body = payload?.notification?.body || "";
          showToast(title, body || "Nuova notifica");
          try{ beep(); }catch(_e){}
        });
      }catch(_e){}

      updatePushPill();
      showToast("Notifiche attive", "Perfetto: questo dispositivo ricever notifiche anche ad app chiusa.");
    }catch(err){
      console.warn(err);
      showToast("Errore notifiche", String(err?.message || err));
      updatePushPill();
    }
  }

  async function pushDisableFlow(){
    try{
      const perm = Notification.permission;
      if(perm !== "granted"){
        showToast("Gi disattive", "Su questo dispositivo le push non risultano attive.");
        updatePushPill();
        return;
      }

      const fm = state.firebase.msgApi;
      const messaging = state.firebase.messaging;

      // Recupera token corrente (serve per delete lato client)
      const swReg = await registerPushSW();
      const token = await fm.getToken(messaging, { vapidKey: FCM_VAPID_KEY, serviceWorkerRegistration: swReg }).catch(()=>null);

      if(token){
        await fm.deleteToken(messaging).catch(()=>{});
        await deletePushToken(token);
      }

      state.push.token = "";
      state.push.enabled = false;

      updatePushPill();
      showToast("Notifiche disattivate", "Ok, questo dispositivo non ricever pi push.");
    }catch(err){
      console.warn(err);
      showToast("Errore", "Impossibile disattivare le notifiche su questo dispositivo.");
    }
  }

  function wirePushUI(){
    const btn = $("#pillPush");
    if(btn){
      btn.addEventListener("click", ()=>{
        openNotifModal();
      });
    }
  }

  async function startHub(){
    if(globalThis.__HUB_BOOTED__) return;
    globalThis.__HUB_BOOTED__ = true;

    primeAuthGateUi();
    wireAuthResumeHandlers();

    try{ statsDesktopMq.addEventListener("change", relocateStatsCard); }catch(_e){ try{ statsDesktopMq.addListener(relocateStatsCard); }catch(_e2){} }
    relocateStatsCard();
    updateDesktopStackClass();
    setHdrH();
    updateDesktopV2Class();
    updateKioskAdminMode();
    window.addEventListener("resize", updateKioskAdminMode);
    window.addEventListener("resize", scheduleDesktopStackUpdate);
    window.addEventListener("resize", handleDesktopResize);
    window.addEventListener("orientationchange", handleDesktopResize);
    window.addEventListener("orientationchange", updateKioskAdminMode);
    try{ kioskAspectMq && kioskAspectMq.addEventListener("change", updateKioskAdminMode); }catch(_e){ try{ kioskAspectMq && kioskAspectMq.addListener(updateKioskAdminMode); }catch(_e2){} }
    wireStatsClearAction();

    // ===============================
    // HOME interactions
    // ===============================
    $("btnGoProd").addEventListener("click", ()=> handlePrimaryCta());
    try{
      const pb = $("partialBanner");
      pb?.addEventListener("click", ()=> openPartialModal());
      pb?.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openPartialModal(); } });
    }catch(_e){}
    try{ $("partialClose").addEventListener("click", ()=> closePartialModal()); }catch(_e){}
    try{ $("partialModal").addEventListener("click", (e)=>{ if(e.target===$("partialModal")) closePartialModal(); }); }catch(_e){}
    $("prodStrip").addEventListener("click", ()=> openRunningModal());
    try{ $("cancelBannerClose").addEventListener("click", ()=> hideCancelBanner()); }catch(_e){}

    $("prodModalClose").addEventListener("click", ()=> closeProdModalRequest());
    $("runningClose").addEventListener("click", ()=> { $("runningModal").classList.remove("show"); unlockBody(); });

    // History modal
    try{
      $("histClose").addEventListener("click", ()=>{ $("histModal").classList.remove("show"); unlockBody(); });
      $("histModal").addEventListener("click", (e)=>{ if(e.target===$("histModal")){ $("histModal").classList.remove("show"); unlockBody(); } });
    }catch(_e){}
    try{
      $("whModalClose")?.addEventListener("click", ()=> closeWhModal());
      $("whModal")?.addEventListener("click", (e)=>{ if(e.target===$("whModal")) closeWhModal(); });
    }catch(_e){}
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeWhModal(); });
    try{
      $("notifClose").addEventListener("click", ()=> closeNotifModal());
      $("notifModal").addEventListener("click", (e)=>{ if(e.target===$("notifModal")) closeNotifModal(); });
    }catch(_e){}
    try{ $("btnNotifCompleted").addEventListener("click", ()=> focusCompletedFromNotif()); }catch(_e){}
    try{ $("btnTogglePush").addEventListener("click", ()=> togglePushFromCenter()); }catch(_e){}
    try{
      $("btnSendNotif").addEventListener("click", async()=>{
        const fb = $("notifAdminFeedback");
        if(!(state.user && state.user.isAdmin)){
          showToast("Solo admin", "Non hai i permessi per inviare notifiche.");
          if(fb) fb.textContent = "Permesso mancante.";
          return;
        }
        const title = ($("notifTitle")?.value || "").trim();
        const body = ($("notifBodyInput")?.value || "").trim();
        if(!title || !body){
          showToast("Testo mancante", "Inserisci titolo e testo della notifica.");
          if(fb) fb.textContent = "Titolo e testo obbligatori.";
          return;
        }
        if(fb) fb.textContent = "Invio";
        try{
          await sendAdminNotification(title, body);
          if(fb) fb.textContent = "Notifica inviata.";
          const bodyEl = $("notifBodyInput");
          if(bodyEl) bodyEl.value = "";
        }catch(err){
          console.warn("send notif error", err);
          if(fb) fb.textContent = "Invio non riuscito (permessi o rete).";
          showToast("Invio non riuscito", "Controlla i permessi Firestore o la rete.");
        }
      });
    }catch(_e){}

    // Fatturato reveal
    $("fatValue").addEventListener("click", ()=>{
      const el = $("fatValue");
      const isAdmin = Boolean(state.user && state.user.isAdmin);
      const isWide = window.matchMedia("(min-width: 980px)").matches;
      if(isAdmin || isWide){
        el.classList.add("reveal");
        updateFatturatoUI();
        return;
      }
      el.classList.toggle("reveal");
      updateFatturatoUI();
    });

    // Call Matteo (numero fisso)
    const MATTEO_TEL = "+393516709334";
    $("btnCallMatteo").addEventListener("click", ()=>{
      window.location.href = `tel:${MATTEO_TEL}`;
    });

    // Stats helper
    $("btnOpenStats").addEventListener("click", ()=>{
      showToast("Statistiche", "Sezione statistiche completa in fondo alla pagina.");
      window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
    });
    try{
      $("btnMobileStats")?.addEventListener("click", (e)=>{
        e.preventDefault();
        scrollToStatsSection();
      });
    }catch(_e){}

    // Issues (registrazione interna)
    $("btnSendIssue").addEventListener("click", async()=>{
      const txt = $("issueText").value.trim();
      if(!txt){
        showToast("Segnalazione", "Scrivi il problema prima di inviare.");
        return;
      }
      if(!state.user){
        renderAuthLogin("Per inviare una segnalazione  necessario accedere.");
        return;
      }
      const op = state.user.fullName || "Operatore";
      const payload = {
        operator: op,
        operatorUid: state.user.uid,
        text: txt,
        when: fmtDateTime(Date.now()),
        kind: "problema_macchina_o_prodotto",
        url: location.href,
        ua: navigator.userAgent
      };
      await addIssue(payload);
      $("issueText").value = "";
      showToast("Segnalazione registrata", "Ok. La segnalazione  stata salvata. Per urgenze: usa Chiama Matteo.", 3200);
    });

    document.addEventListener("visibilitychange", ()=>{
      if(!document.hidden) debounceRefresh("focus");
    });
    window.addEventListener("focus", ()=> debounceRefresh("focus"));
    window.addEventListener("pageshow", (e)=>{
      if(e.persisted || !document.hidden) debounceRefresh("pageshow");
    });
    try{ window.matchMedia("(min-width: 980px)").addEventListener("change", ()=> updateFatturatoUI()); }catch(_e){}

    document.documentElement.setAttribute("translate","no");
    document.body.setAttribute("translate","no");

    // Blocca zoom (mobile/Android)
    document.addEventListener("gesturestart", (e)=>e.preventDefault(), {passive:false});
    document.addEventListener("gesturechange", (e)=>e.preventDefault(), {passive:false});
    document.addEventListener("gestureend", (e)=>e.preventDefault(), {passive:false});
    document.addEventListener("wheel", (e)=>{ if(e.ctrlKey) e.preventDefault(); }, {passive:false});

    await boot();
    try{ wirePushUI(); updatePushPill(); renderNotifCenter(); updateNotificationBadge(); }catch(_e){}
    try{ wireHeaderRefresh(); }catch(_e){}
  }




// start
  await startHub();

  </script>
</body>
</html>
