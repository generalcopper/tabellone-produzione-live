<!doctype html><html lang="it" translate="no"><head><meta charset="utf-8"><link rel="preconnect" href="https://www.gstatic.com" crossorigin><link rel="preconnect" href="https://accounts.google.com" crossorigin><link rel="preconnect" href="https://apis.google.com" crossorigin><link rel="preconnect" href="https://script.google.com" crossorigin><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="google" content="notranslate"><meta http-equiv="Content-Language" content="it"><meta name="color-scheme" content="light"><title>Hub Linea Polveri</title><link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2716%27 fill=%27%232e7bff%27/%3E%3Cpath d=%27M22 43c0-11 8-20 20-20h2v6h-2c-8 0-14 6-14 14v2h-6v-2z%27 fill=%27white%27/%3E%3Cpath d=%27M40 33a6 6 0 1 1 0-12h2v6h-2a0 0 0 0 0 0 0 0 0 0 0 0 0 6z%27 fill=%27white%27 opacity=%270.9%27/%3E%3C/svg%3E"><style>@keyframes marquee{0%{transform:translateX(0)}to{transform:translateX(-100%)}}@keyframes spin{to{transform:rotate(360deg)}}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(52,199,89,.35)}70%{box-shadow:0 0 0 10px transparent}to{box-shadow:0 0 0 0 transparent}}@keyframes topAlertMarquee{0%{transform:translateX(0)}to{transform:translateX(-50%)}}:root{--bg:#e9ecf3;--bg2:#f7f8fb;--card:rgba(255,255,255,0.9);--card2:rgba(255,255,255,0.94);--stroke:rgba(12,22,52,.10);--text:rgba(12,16,26,.90);--muted:rgba(12,16,26,.62);--accent:#0a84ff;--good:#34c759;--warn:#ff9f0a;--bad:#ff3b30;--shadow:0 18px 44px rgba(15,23,42,.16);--radius:20px;--radius2:24px;--safe-top:env(safe-area-inset-top);--safe-bot:env(safe-area-inset-bottom);--banner-offset:0px;--hdrH:92px}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body,html{margin:0;height:100%;font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Avenir Next",Avenir,"Helvetica Neue",Helvetica,Arial,sans-serif;color:var(--text);overflow-y:auto;overflow-x:hidden;max-width:100vw}body::before{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;background:radial-gradient(900px 900px at 20% 18%,rgba(10,132,255,.14),transparent),radial-gradient(1100px 1100px at 82% 12%,rgba(52,199,89,.1),transparent),linear-gradient(180deg,var(--bg)0,var(--bg2) 100%);background-size:cover;background-repeat:no-repeat;background-position:center}.wrap,body,html,main{background:0 0!important}.wrap{max-width:1360px;width:min(96vw,1360px);margin:0 auto;padding:calc(14px + var(--safe-top) + var(--banner-offset)) 16px calc(26px + var(--safe-bot))}header.headerRow{justify-content:space-between;gap:12px;padding:calc(6px + var(--safe-top)*.3)0 8px;margin-bottom:12px;min-height:72px;flex-wrap:nowrap;width:100%}.brand,.headerRow .actions,header.headerRow{display:flex;align-items:center;min-width:0}.headerRow .actions{justify-content:flex-end;gap:8px;flex:0 0 auto;width:auto;overflow:visible;padding-right:8px}.brand{gap:12px;flex:1 1 auto}.brandLogo{width:80px;height:80px;border-radius:0!important;flex:0 0 auto;display:block;object-fit:contain;background:0 0;transform:translateY(-4px)}.title,.titleWrap{display:flex;flex-direction:column;min-width:0}.titleWrap{gap:4px;justify-content:center;flex:1 1 auto}.title{font-size:40px;line-height:.85;font-weight:800;letter-spacing:-.02em;text-transform:none;align-items:flex-start;gap:2px;word-break:break-word}.title .titleLine{display:block;line-height:1.05;overflow:hidden;text-overflow:ellipsis}.title .titleLine.accent{color:#0a84ff}.subtitle{margin-top:2px;font-size:14px;color:var(--muted);font-weight:600}.mobileWelcomeWrap{display:none;gap:8px;margin-top:6px;width:100%;max-width:100%}.mobileWelcome{font-size:13px;line-height:1.4;color:var(--muted);font-weight:700;background:rgba(0,0,0,.03);border:1px solid var(--stroke);border-radius:14px;padding:10px 12px;box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}.mobileWelcome .highlight{color:var(--text);font-weight:800}.mobileWelcome .kpi{color:var(--text);font-weight:900}.mobileStatsLink{display:inline-flex;align-items:center;justify-content:center;gap:6px;align-self:flex-start;border:0;border-radius:999px;padding:10px 14px;background:rgba(10,132,255,.12);color:#0a84ff;font-weight:900;font-size:13px;letter-spacing:.01em;box-shadow:0 10px 18px rgba(10,132,255,.16);cursor:pointer;transition:transform .12s ease,box-shadow .16s ease}.mobileStatsLink:active{transform:translateY(1px);box-shadow:0 8px 16px rgba(10,132,255,.14)}.mobileStatsLink:focus-visible{outline:2px solid rgba(10,132,255,.28);outline-offset:2px}@media (max-width:820px){body.role-operator #desktopSummaryCard,body.role-operator #notifAdminBox,body.role-operator .adminOnly,body.role-operator .adminPanel,body.role-operator .tab-admin,body.role-operator [data-tab=admin]{display:none!important}body.role-admin .adminMobileHeader{display:flex}body.role-admin .adminMobileStack{gap:14px}body.role-admin #mobileSendCard,body.role-admin #mobileSendCard .mobileSendShell{display:flex;flex-direction:column;gap:12px}body.role-admin #mobileSendCard .mobileSendTopbar{flex-direction:column;align-items:flex-start;gap:10px}body.role-admin #mobileSendCard .mobileSendToolbar{flex-direction:column;align-items:stretch;gap:8px}body.role-admin #mobileSendCard .mobileSendToolbarBtns{width:100%;justify-content:stretch;gap:8px}body.role-admin #mobileSendCard .mobileSendToolbarBtns .btn{width:100%}body.role-admin #mobileSendCard .microActions{justify-content:flex-start}body.role-admin #mobileSendCard .mobileSendBody,body.role-admin #mobileSendCard .mobileSendListPane{max-height:none}}@media (max-width:720px){header.headerRow{gap:10px;padding-top:calc(6px + var(--safe-top));min-height:64px}.title{flex-direction:column;text-align:left}.title,.titleWrap{width:auto;align-items:flex-start}.subtitle,.titleWrap{text-align:left}.statusRow{gap:6px}}@media (max-width:640px){header.headerRow{display:flex;justify-content:space-between;flex-wrap:nowrap;padding:calc(8px + var(--safe-top)*.5)0 8px;min-height:56px;width:100%}.wrap{padding:calc(12px + var(--safe-top)) 14px calc(22px + var(--safe-bot))}.brand,header.headerRow{gap:10px;align-items:center}.brand{min-width:0;flex:1 1 auto}.brandLogo{width:48px;height:48px;border-radius:0!important;transform:none;object-fit:contain;flex:0 0 auto}.titleWrap{min-width:0;overflow:hidden;gap:2px}.title{font-size:32px;line-height:.95}.title .titleLine{overflow-wrap:anywhere}.subtitle{display:none}.statusRow{flex:0 0 auto;display:flex;align-items:center;justify-content:flex-end;flex-wrap:nowrap;gap:8px;padding:0;min-width:0;width:auto}.mobileWelcomeWrap{display:flex;flex-direction:column}#headerTicker,.headerMarquee,.headerTicker,.refreshText,.statusRow #pillOnline,.statusRow #pillPush,.statusRow #pillSync,.statusRow .pill,.statusRow .pillQuiet{display:none!important}.kv,.row2{grid-template-columns:1fr}.deskRowOpsSend{display:block}#completedCard .bd,#statsProdCard .bd{max-height:none;overflow:visible}#btnHeaderRefresh.iconBtn{width:44px;height:44px;min-width:44px;min-height:44px;border-radius:14px}}@media (min-width:641px) and (max-width:1024px){.wrap{padding:calc(14px + var(--safe-top) + var(--banner-offset)) 18px calc(24px + var(--safe-bot))}header.headerRow{gap:14px;min-height:68px;align-items:center}.brandLogo{width:72px;height:72px;transform:translateY(-2px)}.title{font-size:38px;line-height:.9}.subtitle{font-size:13px;line-height:1.2}.mobileWelcomeWrap{display:flex;flex-direction:column}.statusRow{gap:8px}#headerTicker,.headerMarquee,.headerTicker{display:none!important}.deskRowOpsSend{display:block}.kv{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}}@media (min-width:1025px){.wrap{padding:calc(14px + var(--safe-top) + var(--banner-offset)) 18px calc(26px + var(--safe-bot))}header.headerRow{gap:14px;min-height:74px}#completedCard .bd,#statsProdCard .bd{max-height:none;overflow:visible}body.desktopAsMobile .wrap{max-width:820px;margin:0 auto;padding-left:16px;padding-right:16px;display:block}body.desktopAsMobile .headerRow{width:100%;margin-left:auto;margin-right:auto}body.desktopAsMobile .grid,body.desktopAsMobile .homeWrapOrMainContainer{display:flex!important;flex-direction:column;gap:12px}body.desktopAsMobile .deskRowOpsSend>*,body.desktopAsMobile .grid>*,body.desktopAsMobile .homeWrapOrMainContainer>*,body.desktopAsMobile .sideStack>*{width:100%;max-width:100%}body.desktopAsMobile .deskRowOpsSend,body.desktopAsMobile .sideStack{display:flex;flex-direction:column;gap:12px;width:100%}body.desktopAsMobile .deskRowOpsSend{display:flex!important}body.desktopAsMobile .row2{display:flex;flex-direction:column;gap:10px}body.desktopAsMobile .grid,body.desktopAsMobile .homeWrapOrMainContainer{align-items:stretch}body.desktopAsMobile .homeWrapOrMainContainer>*{flex:0 0 auto}body.desktopAsMobile.adminDeskLayout .homeWrapOrMainContainer{display:flex!important;grid-template-columns:none}}.pill,.statusRow{display:flex;gap:8px;align-items:center;min-width:0}.statusRow{flex-wrap:nowrap;justify-content:flex-end;width:auto;flex:0 0 auto;padding:2px 0;min-height:44px}.pill{padding:7px 10px;border:1px solid var(--stroke);border-radius:999px;background:rgba(0,0,0,.04);font-size:12px;color:var(--muted);white-space:nowrap;flex:0 1 auto}.pill span:last-child{overflow:hidden;text-overflow:ellipsis}.iconBtn{position:relative;width:36px;height:36px;min-width:36px;min-height:36px;border-radius:16px;border:1px solid var(--stroke);background:rgba(0,0,0,.04);color:rgba(0,0,0,.86);font-size:18px;font-weight:900;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .14s cubic-bezier(.22,.61,.36,1),opacity .14s ease,box-shadow .16s ease;box-shadow:0 10px 20px rgba(0,0,0,.06)}.iconBtn:active{transform:scale(.98);opacity:.92;box-shadow:0 8px 16px rgba(0,0,0,.06)}.iconBtn:focus-visible{outline:2px solid rgba(10,132,255,.25);outline-offset:2px}.iconBtn .icon{display:inline-flex;align-items:center;justify-content:center;line-height:1}.iconBtn.isSpinning .icon{animation:spin .85s ease-in-out}.iconBtn .errBadge{position:absolute;top:-6px;right:-6px;padding:4px 6px;border-radius:12px;background:#ff3b30;color:#fff;font-size:10px;font-weight:900;box-shadow:0 6px 14px rgba(255,59,48,.32);display:none;white-space:nowrap}.iconBtn.hasError .errBadge{display:inline-flex}#btnHeaderRefresh{position:relative;z-index:2}@media (max-width:720px){.iconBtn{width:44px;height:44px;min-width:44px;min-height:44px}}@media (prefers-reduced-motion:reduce){.iconBtn{transition:none}.iconBtn.isSpinning .icon{animation:none}}.dot,.pillBadge{border-radius:999px}.pillBadge{display:none;min-width:18px;height:18px;padding:0 6px;background:var(--bad);color:#fff;font-weight:900;font-size:11px;align-items:center;justify-content:center;line-height:1}.dot{width:10px;height:10px;background:rgba(255,255,255,.25)}.dot.ok{background:var(--good)}.dot.warn{background:var(--warn)}.dot.bad{background:var(--bad)}.pillQuiet{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.08);color:var(--muted);padding:6px 9px}.grid{display:grid;grid-template-columns:1fr;gap:14px}.grid>*{min-width:0}.homeWrapOrMainContainer{width:100%}.desktopShell{display:grid;grid-template-columns:1fr;align-items:start;gap:16px}.desktopCol,.mainCol{display:flex;flex-direction:column}.desktopCol{gap:16px;min-width:0}.mainCol{gap:14px;align-items:stretch}.mainCol>#completedCard,.mainCol>#warehouseCard{position:relative;display:flex;flex-direction:column;min-width:0;z-index:auto}.mainCol>#warehouseCard{margin-top:8px}@media (min-width:900px){.mainCol{gap:16px}.mainCol>#warehouseCard{margin-top:10px}.desktopShell{grid-template-columns:minmax(520px,1fr) minmax(440px,.9fr);gap:18px}}@media (min-width:1025px){.title{font-size:46px}#opsCard,#warehouseCard{min-height:clamp(360px,52vh,640px)}#warehouseCard .bd{flex:1}body.adminDeskLayout .homeWrapOrMainContainer{display:grid;grid-template-columns:minmax(560px,44%) 1fr;gap:14px;align-items:start}body.adminDeskLayout .homeWrapOrMainContainer>*{min-width:0}#opsCard,#warehouseCard,body.adminDeskLayout #mobileSendCard{display:flex;flex-direction:column}body.adminDeskLayout #mobileSendList{flex:1;min-height:0;overflow-y:auto}body.adminDeskLayout #mobileSendCard{position:relative;z-index:2;box-shadow:0 18px 40px rgba(0,0,0,.12);border:1px solid rgba(10,132,255,.12)}body.adminDeskLayout #statsProdCard{position:relative;z-index:1;opacity:.96;box-shadow:0 12px 28px rgba(0,0,0,.08);max-height:clamp(320px,48vh,540px);display:flex;flex-direction:column}body.adminDeskLayout #statsProdCard .bd{max-height:clamp(260px,42vh,480px)}body.adminDeskLayout #warehouseCard{display:flex;flex-direction:column;min-height:0;max-height:52vh}body.adminDeskLayout #warehouseCard .hd{flex:0 0 auto}body.adminDeskLayout #warehouseCard .bd{display:flex;flex-direction:column;flex:1 1 auto;min-height:0}body.adminDeskLayout #warehouseBody{flex:1 1 auto;min-height:0;overflow-y:auto;overscroll-behavior:contain}}.card{border:1px solid rgba(255,255,255,.8);background:linear-gradient(180deg,var(--card)0,var(--card2) 100%);backdrop-filter:blur(18px);border-radius:var(--radius2);box-shadow:var(--shadow);overflow:hidden;box-sizing:border-box;min-width:0}#warehouseCard .bd{overflow:visible;padding-bottom:16px}#warehouseBody{min-height:280px;max-height:calc(100vh - 240px);overflow-x:visible;overflow-y:auto;-webkit-overflow-scrolling:touch}.card .bd,.card .hd{min-width:0;display:flex}.card .hd{padding:14px 14px 10px;align-items:center;justify-content:space-between;gap:12px;border-bottom:1px solid rgba(12,22,52,.06)}.card .hd h2{margin:0;font-size:14px;font-weight:800;letter-spacing:.02em;color:rgba(0,0,0,.88);text-transform:uppercase}.card .bd{padding:14px;flex-direction:column;gap:10px}.heroCard .hd{padding:18px 18px 12px;border-bottom:none;align-items:flex-start}.heroCard .bd{padding:4px 18px 18px;gap:14px}.introCard{padding:18px}.introTop{display:flex;flex-direction:column;gap:4px}.eyebrow,.introTop .introTitle{font-size:22px;font-weight:900;letter-spacing:-.01em;color:rgba(12,16,26,.92)}.introTop .introLead{font-size:14px;color:var(--muted);font-weight:700}.eyebrow{text-transform:uppercase;letter-spacing:.08em;font-size:12px;color:rgba(12,16,26,.6)}.summaryGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}.summaryTile{border:1px solid rgba(12,22,52,.06);background:linear-gradient(145deg,rgba(255,255,255,.9),rgba(255,255,255,.82));border-radius:16px;padding:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.7);display:flex;flex-direction:column;gap:6px}.summaryTile .t,.summaryValue{font-weight:900;letter-spacing:.01em;color:rgba(12,16,26,.74)}.summaryValue{font-size:26px;letter-spacing:-.01em;color:rgba(12,16,26,.92)}.summaryActions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:4px 0}.primaryBtn{width:100%;border:0;border-radius:20px;padding:18px;background:linear-gradient(180deg,#2e7bff,rgba(18,105,245,.9));color:#fff;font-weight:900;font-size:19px;letter-spacing:.02em;box-shadow:0 18px 36px rgba(46,123,255,.28);cursor:pointer;min-height:56px;transition:transform .15s cubic-bezier(.22,.61,.36,1),box-shadow .18s ease,filter .18s ease}.primaryBtn:active{transform:translateY(1.5px) scale(.995);box-shadow:0 12px 22px rgba(46,123,255,.2)}.primaryBtn:focus-visible{outline:2px solid rgba(46,123,255,.35);outline-offset:2px}.warnBanner{display:flex;align-items:center;gap:12px;padding:12px;border-radius:16px;background:rgba(255,149,0,.12);border:1px solid rgba(255,149,0,.28);transition:opacity .18s ease,transform .2s cubic-bezier(.22,.61,.36,1)}.warnBanner .icon{font-size:20px;line-height:1}.warnBanner .txt{flex:1;min-width:0}.warnBanner .txt .t{font-weight:900;color:rgba(0,0,0,.88)}.warnBanner .txt .s{margin-top:2px;font-size:12px;color:rgba(0,0,0,.62)}.alertBanner,.whiteBagBanner{display:flex;align-items:center;font-weight:900;letter-spacing:.01em}.alertBanner{gap:12px;padding:12px;border-radius:16px;border:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.04);box-shadow:inset 0 1px 0 rgba(255,255,255,.6);transition:opacity .2s ease,transform .2s cubic-bezier(.22,.61,.36,1)}.alertBanner .label{flex:1;min-width:0;word-break:break-word}.alertBanner .hint{font-size:12px;color:rgba(0,0,0,.7);font-weight:800}.whiteBagBanner{justify-content:flex-start;gap:14px;flex-wrap:wrap;width:100%;padding:16px;margin:0;border-radius:18px;background:rgba(255,255,255,.92);border:1px solid rgba(255,255,255,.35);color:#1c1c1e;box-shadow:inset 0 1px 0 rgba(0,0,0,.04),0 12px 26px rgba(0,0,0,.06);line-height:1.25;pointer-events:auto;word-break:break-word}.whiteBagBanner .icon{font-size:22px}.whiteBagBanner .txt{display:flex;flex-direction:column;gap:4px;flex:1;min-width:0}.whiteBagBanner .txt .t{font-size:15px;letter-spacing:.02em}.whiteBagBanner .txt .s{font-size:13px;font-weight:800;opacity:.9}.fadeCard{opacity:0;transform:translateY(6px)}.fadeCard.show{opacity:1;transform:translateY(0)}.planMessage{padding:12px;border-radius:16px;border:1px solid rgba(0,0,0,.06);background:linear-gradient(180deg,rgba(0,0,0,.03),rgba(0,0,0,.01));box-shadow:0 12px 30px rgba(0,0,0,.08);margin-bottom:10px}.planMessage .headline{font-weight:950;letter-spacing:.01em}.planMessage ul{margin:10px 0 0 18px;color:var(--muted);font-weight:800;padding-left:12px}.planMessage li{margin-bottom:6px}.cardTopActions,.modalTopActions{display:flex;gap:8px;align-items:center}.cardTopActions{margin-left:auto}.miniBtn{border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:var(--text);padding:8px 10px;border-radius:12px;font-weight:700;font-size:12px;line-height:1;cursor:pointer;-webkit-tap-highlight-color:transparent;white-space:nowrap}.miniBtn:active{transform:translateY(1px)}.row2{display:grid;grid-template-columns:repeat(auto-fit,minmax(0,1fr));gap:10px;min-width:0}.btn{border:1px solid var(--stroke);background:rgba(0,0,0,.04);color:rgba(0,0,0,.88);padding:14px 12px;border-radius:16px;font-weight:800;cursor:pointer;min-height:44px}.btn:hover{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.12)}.btn:active{transform:translateY(1px);background:rgba(0,0,0,.08);border-color:rgba(0,0,0,.14)}.btn.good{background:rgba(32,201,151,.16);border-color:rgba(32,201,151,.35)}.btn.good:hover{background:rgba(32,201,151,.18);border-color:rgba(32,201,151,.38)}.btn.good:active{background:rgba(32,201,151,.2);border-color:rgba(32,201,151,.4)}.btn.isBusy{pointer-events:none;opacity:.82;cursor:default}.btn.isBusy .btnLabel{display:inline-flex;align-items:center;justify-content:center;gap:10px}.btn.isBusy .miniSpinner{width:14px;height:14px;border-radius:50%;border:2px solid rgba(0,0,0,.14);border-top-color:rgba(0,0,0,.7);animation:spin .75s linear infinite;display:inline-block}.btn.bad{background:rgba(255,77,79,.14);border-color:rgba(255,77,79,.35)}.btn.bad:hover{background:rgba(255,77,79,.16);border-color:rgba(255,77,79,.38)}.btn.bad:active{background:rgba(255,77,79,.18);border-color:rgba(255,77,79,.4)}.btn.ghost{background:0 0;border-color:var(--stroke)}.btn.ghost:hover{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.1)}.btn.ghost:active{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.12)}.bigStrip{border-radius:18px;padding:14px;border:1px solid rgba(12,128,60,.72);background:linear-gradient(120deg,#0f9f45,#0c8b3b 55%,#0a7331);position:relative;overflow:hidden;cursor:pointer;color:#fff;box-shadow:0 18px 38px rgba(12,128,60,.36);transition:transform .12s ease,box-shadow .18s ease}#prodStrip{background:rgba(24,207,23,.4);border-color:rgba(50,232,48,.65);border-width:1.5px;box-shadow:0 8px 20px rgba(24,207,23,.1);color:#fff}.bigStrip:active{transform:translateY(1px);box-shadow:0 12px 24px rgba(12,128,60,.28)}.bigStrip .label{font-weight:900;font-size:14px;text-transform:uppercase;letter-spacing:.06em;opacity:1}.bigStrip .marquee{margin-top:10px;font-size:18px;font-weight:900;white-space:nowrap;overflow:hidden;position:relative;padding-bottom:2px}.bigStrip .marquee span{display:inline-block;padding-left:100%;animation:marquee 16s linear infinite}.bigStrip .meta{margin-top:10px;font-size:12px;color:rgba(255,255,255,.94);display:flex;gap:12px;flex-wrap:wrap}@media (max-width:640px){#prodStrip{display:grid;grid-template-columns:1fr auto;grid-template-areas:"label count""marquee marquee""hint hint";box-sizing:border-box;padding:12px;gap:6px 10px;border-radius:18px;align-items:center;touch-action:manipulation}#prodStrip .label{grid-area:label;margin:0;min-width:0;line-height:1.2}#prodStrip,#prodStrip .marquee{max-width:100%;width:100%;overflow:hidden}#prodStrip .marquee{grid-area:marquee;min-width:0;margin-top:0;white-space:nowrap;mask-image:linear-gradient(90deg,transparent 0,rgba(0,0,0,.4) 3%,#000 12%,#000 88%,rgba(0,0,0,.4) 97%,transparent 100%);-webkit-mask-image:linear-gradient(90deg,transparent 0,rgba(0,0,0,.4) 3%,#000 12%,#000 88%,rgba(0,0,0,.4) 97%,transparent 100%)}#prodStrip .marquee span{padding-left:50%;min-width:100%;will-change:transform}#prodStrip .meta{grid-area:count;display:contents;margin-top:0;gap:0}#prodStrip .metaCount{grid-area:count;justify-self:end;min-width:0;line-height:1.3}#prodStrip .metaHint{grid-area:hint;min-width:0;line-height:1.3;opacity:.92}}.kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;min-width:0}.k{border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.03);border-radius:16px;padding:10px 12px}.k .t{font-size:12px;color:var(--muted);font-weight:700}.k .v{margin-top:4px;font-size:18px;font-weight:900}.item .top,.list{display:flex;gap:10px}.list{flex-direction:column;min-width:0}.item{border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.03);border-radius:16px;padding:12px;overflow-wrap:anywhere;min-width:0}.item .top{justify-content:space-between;align-items:flex-start;flex-wrap:wrap}.item .name{font-weight:900;font-size:16px;line-height:1.1;word-break:break-word}.item .sub{margin-top:6px;font-size:12px;color:var(--muted);font-weight:700;word-break:break-word}.notifList{display:flex;flex-direction:column;gap:8px}.notifItem{border:1px solid var(--stroke);background:#fff;border-radius:14px;padding:10px 12px}.notifItem.unread{border-color:rgba(46,123,255,.38);box-shadow:0 8px 18px rgba(46,123,255,.12)}.notifTitle{font-weight:950;font-size:14px;letter-spacing:.01em}.notifBody{margin-top:6px;color:var(--muted);font-weight:800;font-size:13px}.notifMeta{margin-top:8px;font-size:11px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}.notifEmpty{color:var(--muted);font-weight:800}.badge{padding:7px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.04);font-size:12px;font-weight:900;white-space:nowrap;display:inline-flex;align-items:center;gap:6px;max-width:100%;min-width:0}.pressCard{cursor:pointer;transition:transform .16s cubic-bezier(.18,.69,.25,1),box-shadow .18s ease,background .18s ease,opacity .18s ease;will-change:transform,opacity}.pressCard:hover{box-shadow:0 14px 30px rgba(0,0,0,.12)}.pressCard:active{transform:scale(.99);box-shadow:0 12px 32px rgba(0,0,0,.14)}.rowPress{cursor:pointer;transition:background .14s ease,transform .14s ease,box-shadow .16s ease}.rowPress:hover{background:rgba(0,0,0,.03)}.rowPress:active{transform:translateY(1px);box-shadow:0 10px 20px rgba(0,0,0,.08)}.ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.rowsScroll{max-height:clamp(260px,45vh,560px);overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-right:2px}@media (max-width:899px){.rowsScroll{max-height:none}}.rowsScroll::-webkit-scrollbar{width:10px}.rowsScroll::-webkit-scrollbar-thumb{background:rgba(0,0,0,.12);border-radius:999px}.rowsScroll::-webkit-scrollbar-track{background:0 0}@media (prefers-reduced-motion:reduce){.rowPress{transition:none}.rowsScroll{scroll-behavior:auto}}.selectableLine{position:relative;overflow:hidden}.selectableLine::after{content:"";position:absolute;inset:-1px;border-radius:16px;background:linear-gradient(180deg,rgba(46,123,255,.08),rgba(46,123,255,.04));opacity:0;transition:opacity .16s ease,transform .16s ease;z-index:0}.selectableLine.selected{border-color:rgba(46,123,255,.35);box-shadow:0 14px 30px rgba(46,123,255,.14);background:rgba(46,123,255,.08)}.selectableLine.selected::after{opacity:1}.selectableLine .top,.selectableLine .whiteBagBanner{position:relative;z-index:1}.magGrid{display:grid;grid-template-columns:1fr;gap:14px}@media (min-width:1180px){.magGrid{grid-template-columns:.85fr 1.15fr;align-items:start}}.magBox{border:1px solid rgba(0,0,0,.1);border-radius:16px;padding:12px;background:rgba(0,0,0,.02)}.magTitle{font-weight:900;font-size:15px;margin:0 0 8px;letter-spacing:.02em}.magList{display:flex;flex-direction:column;gap:8px}.magRow{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.05)}.magRow .l{font-weight:900;font-size:13px;color:rgba(0,0,0,.9);flex:1;min-width:0}.magRow .s{color:var(--muted);font-size:12px;margin-top:4px}.magRow .v{font-weight:1000;letter-spacing:.01em;white-space:nowrap}.magBadge,.magPill{border-radius:12px;font-weight:900}.magPill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border:1px solid rgba(0,0,0,.06);font-size:12px;color:rgba(0,0,0,.82)}.magBadge{background:rgba(0,0,0,.06);padding:3px 8px;font-size:11px}.magFilterBar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin:2px 0 10px}.magFilterField{display:flex;flex-direction:column;gap:6px;min-width:0;flex:1 1 180px}.magFilterLabel{font-size:11px;font-weight:900;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}.magFilterInput{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--stroke);background:#fff;font-weight:850;color:rgba(0,0,0,.86);box-shadow:inset 0 1px 0 rgba(255,255,255,.8)}.magFilterInput:focus-visible{outline:2px solid rgba(10,132,255,.25);outline-offset:2px}.magFilterActions{display:flex;align-items:center;gap:8px;flex:0 0 auto;min-width:0;flex-wrap:wrap}.magResultBadge{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:12px;background:rgba(0,0,0,.05);border:1px solid var(--stroke);font-weight:900;font-size:12px;white-space:nowrap}.magFilterChips{display:flex;flex-wrap:wrap;gap:8px;margin-top:2px}.magChip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:12px;background:rgba(10,132,255,.1);border:1px solid rgba(10,132,255,.28);color:rgba(0,0,0,.88);font-weight:900;font-size:12px;cursor:pointer}.magChip .x{font-weight:1000;opacity:.8;line-height:1}@media (max-width:1180px){.magFilterBar{flex-direction:column;align-items:stretch}.magFilterActions{justify-content:flex-start}.magFilterField{flex:1 1 auto}}.signaturePad{touch-action:none;background:#fff}.whOverview{display:flex;flex-direction:column;gap:8px;margin-top:6px}.whKpiRow{display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 6px}.whKpi{border:1px solid rgba(0,0,0,.08);background:linear-gradient(135deg,rgba(10,132,255,.08),rgba(10,132,255,.02));color:rgba(0,0,0,.86);border-radius:12px;padding:8px 10px;font-weight:900;font-size:12px;display:inline-flex;gap:8px;align-items:center;box-shadow:0 10px 24px rgba(0,0,0,.06)}.whKpi .v{font-size:15px;letter-spacing:.01em}:root{--whOk:rgba(52,199,89,.95);--whWarn:rgba(255,149,0,.95);--whNon:rgba(255,59,48,.95)}.whMgr{display:grid;grid-template-columns:1.35fr .65fr;gap:12px;margin:10px 0 8px}@media (max-width:900px){.whMgr{grid-template-columns:1fr}}.whMgrCard{background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:12px;min-width:0}.whMgrHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}.whMgrKpi .v,.whMgrTitle{font-weight:1000;font-size:13px;letter-spacing:.01em}.whMgrMeta,.whMgrSub{font-size:12px;color:var(--muted)}.whMgrSub{margin-top:2px}.whMgrMeta{white-space:nowrap}.whMgrKpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}@media (max-width:900px){.whMgrKpis{grid-template-columns:repeat(2,minmax(0,1fr))}}.whMgrKpi{border-radius:14px;padding:10px;background:#fff;border:1px solid rgba(0,0,0,.06);display:flex;flex-direction:column;gap:4px;min-width:0}.whMgrKpi .v{font-size:16px;font-variant-numeric:tabular-nums}.whMgrKpi .l{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.whMgrKpi[data-tone=ok]{background:linear-gradient(180deg,rgba(52,199,89,.14),#fff)}.whMgrKpi[data-tone=warn]{background:linear-gradient(180deg,rgba(255,149,0,.16),#fff)}.whMgrKpi[data-tone=non]{background:linear-gradient(180deg,rgba(255,59,48,.12),#fff)}.whMgrViz{display:flex;align-items:center;gap:12px}.whDonut,.whDonut::after{border-radius:999px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}.whDonut{width:96px;height:96px;background:conic-gradient(rgba(0,0,0,.08)0 360deg);position:relative;flex:0 0 auto}.whDonut::after{content:"";position:absolute;inset:14px;background:#fff}.whDonutCenter,.whLegend{display:flex;flex-direction:column}.whDonutCenter{position:absolute;inset:0;align-items:center;justify-content:center;gap:2px;z-index:2;text-align:center;padding:0 8px}.whDonutCenter .v{font-weight:1000;font-size:14px;font-variant-numeric:tabular-nums}.whDonutCenter .l{font-size:11px;color:var(--muted)}.whLegend{gap:6px;min-width:0;flex:1 1 auto}.whLegendItem{display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(0,0,0,.86);min-width:0}.whDot{width:10px;height:10px;border-radius:999px;background:var(--whOk);flex:0 0 auto}.whDot.warn{background:var(--whWarn)}.whDot.non{background:var(--whNon)}.whLegendItem .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.whLegendItem .val{margin-left:auto;color:var(--muted);font-variant-numeric:tabular-nums}@media print{.whMgrCard{background:#fff!important}.whDonut,.whMgrCard{box-shadow:none!important}}.whOverviewRow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.06);box-shadow:0 12px 24px rgba(0,0,0,.05);cursor:pointer;transition:transform .18s ease,box-shadow .18s ease,border-color .18s ease;width:100%;text-align:left}.whOverviewRow:hover{transform:translateY(-2px);box-shadow:0 16px 32px rgba(0,0,0,.08);border-color:rgba(10,132,255,.18)}.whOverviewRow:active{transform:translateY(0);box-shadow:0 10px 22px rgba(0,0,0,.07)}.whOverviewName{font-weight:1000;font-size:14px;letter-spacing:.01em;color:rgba(0,0,0,.9)}.whOverviewSub{font-size:12px;color:var(--muted);margin-top:4px}.whOverviewVal{font-weight:1000;font-size:15px;white-space:nowrap}.whOverviewAll{background:0 0;border:0;color:var(--accent);font-weight:900;font-size:13px;padding:6px 6px 0;cursor:pointer;align-self:flex-start;text-decoration:underline}#whDetails{margin-top:12px}.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:18px;z-index:99999;background:rgba(0,0,0,.38);backdrop-filter:blur(12px);opacity:0;pointer-events:none;transition:opacity .18s cubic-bezier(.22,.61,.36,1)}.modal.show{opacity:1;pointer-events:auto}.modal.hidden{display:none}.modalCard,.modalTop{display:flex;background:rgba(255,255,255,.94)}.modalCard{border-radius:22px;border:1px solid rgba(0,0,0,.06);box-shadow:0 26px 60px rgba(0,0,0,.18);width:min(820px,100%);max-height:80vh;overflow:hidden;flex-direction:column;backdrop-filter:blur(8px)}.modalTop{justify-content:space-between;align-items:center;padding:14px 16px 12px;gap:12px;border-bottom:1px solid rgba(0,0,0,.05);position:sticky;top:0;z-index:2}.modalTitle{font-size:15px;font-weight:1000;letter-spacing:.01em}.calcHint,.modalCalc,.modalSub{font-size:12px;color:var(--muted);margin-top:4px}.calcHint,.modalCalc{line-height:1.2;font-weight:600;opacity:.95;max-width:100%;word-break:break-word}.modalClose{border:0;background:rgba(0,0,0,.06);border-radius:12px;width:36px;height:36px;font-size:18px;font-weight:900;cursor:pointer}.modalBody{padding:14px 16px 18px;overflow:auto}.whModalSection{margin-bottom:12px;padding:12px;border:1px solid rgba(0,0,0,.06);border-radius:14px;background:#fff}.whModalSection .tit{font-weight:900;font-size:13px;margin:0 0 8px;color:rgba(0,0,0,.88)}.whModalRow{display:flex;justify-content:space-between;gap:10px;padding:8px 6px;border-radius:10px;border:1px dashed rgba(0,0,0,.05);background:rgba(0,0,0,.02);margin-top:6px}.whModalRow:first-of-type{margin-top:0}.whModalName{font-weight:900;font-size:13px;color:rgba(0,0,0,.92)}.whModalSub{font-size:12px;color:var(--muted);margin-top:4px}.whModalVal{font-weight:1000;white-space:nowrap}@media (min-width:1025px){body.desktopV2 #warehouseCard #whDetails{display:none!important}}.blur{filter:blur(10px);opacity:.85;transition:filter .12s ease,opacity .12s ease}.blur.reveal{filter:blur(0);opacity:1}.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(10px);z-index:9999;align-items:flex-end;justify-content:center;padding:14px;padding-bottom:calc(14px + var(--safe-bot));opacity:0;visibility:hidden;pointer-events:none;transition:opacity .18s cubic-bezier(.22,.61,.36,1),visibility 0s linear .18s}#warehouseModal.overlay,.overlay{display:flex}@media (min-width:900px){#warehouseModal.overlay{align-items:center;padding:24px 18px}#warehouseModal .sheet{max-height:86vh}}.overlay.show{opacity:1;visibility:visible;pointer-events:auto;transition-delay:0s}.sheet,.sheet .shd{display:flex;background:#fff}.sheet{width:min(980px,100%);max-width:100vw;max-height:88vh;border:1px solid var(--stroke);border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.18);overflow:hidden;flex-direction:column;box-sizing:border-box;transform:translateY(10px) scale(.995);opacity:0;transition:transform .22s cubic-bezier(.22,.61,.36,1),opacity .2s ease}.overlay.show .sheet{transform:translateY(0) scale(1);opacity:1}@media (prefers-reduced-motion:reduce){.overlay{transition:none}.sheet{transform:none!important}.alertBanner,.pressCard,.sheet,.warnBanner{transition:none}}.sheet .shd{padding:14px 14px 10px;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid rgba(0,0,0,.06);position:sticky;top:0;z-index:2}.sheet .shd .h{font-weight:1000;letter-spacing:.02em;font-size:14px;text-transform:uppercase;opacity:.9}.sheet .shd .titleCol{display:flex;flex-direction:column;gap:6px;align-items:flex-start;min-width:0;flex:1}.field label,.selCounter,.sheet .shd .x{font-size:12px;font-weight:900}.selCounter{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(46,123,255,.38);background:rgba(46,123,255,.14);color:#0a3a7d;white-space:nowrap}.selCounter strong{font-size:13px}.sheet .shd .x{width:40px;height:40px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.04);color:rgba(0,0,0,.86);font-size:18px;cursor:pointer}.sheet .sbd{padding:14px;overflow:auto}@media (max-width:720px){.sheet{border-radius:18px;max-height:90vh}.sheet .sbd{padding-bottom:calc(18px + var(--safe-bot))}}.stepTitle{font-size:18px;font-weight:950;margin:0 0 10px}.muted{color:var(--muted);font-weight:700;font-size:13px}.radio,.radioRow{display:flex;gap:10px}.radioRow{flex-direction:column;margin-top:12px}.radio{align-items:center;padding:12px;border-radius:16px;border:1px solid var(--stroke);background:rgba(0,0,0,.03);cursor:pointer;font-weight:900}.radio:hover{background:rgba(0,0,0,.06);border-color:rgba(0,0,0,.12)}.radio:active{background:rgba(0,0,0,.08);border-color:rgba(0,0,0,.14)}.radio input{accent-color:var(--accent);width:18px;height:18px}.divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}.startupCard,.toast{border:1px solid var(--stroke);background:#fff}.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(18px + var(--safe-bot));z-index:10050;width:min(520px,calc(100% - 24px - env(safe-area-inset-left) - env(safe-area-inset-right)));max-width:calc(100% - 24px - env(safe-area-inset-left) - env(safe-area-inset-right));color:rgba(0,0,0,.9);border-radius:18px;padding:12px 14px;padding-left:max(14px,env(safe-area-inset-left));padding-right:max(14px,env(safe-area-inset-right));box-shadow:0 18px 40px rgba(0,0,0,.18);display:none}.toast.show{display:block}.toast .tt{font-weight:950}.toast .tb{margin-top:6px;color:var(--muted);font-weight:700;font-size:13px}#toastTitle{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}#authGate,#startup{position:fixed;inset:0;align-items:center;justify-content:center}#startup{z-index:10000;display:flex;padding:20px;background:radial-gradient(1000px 700px at 50% -20%,rgba(46,123,255,.35),rgba(46,123,255,0) 55%),linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,.45));backdrop-filter:blur(14px)}.startupCard{width:min(780px,100%);border-radius:26px;box-shadow:0 20px 60px rgba(0,0,0,.18);overflow:hidden}.startupCard .a{padding:18px 18px 12px;font-weight:1000;letter-spacing:.02em;text-transform:uppercase;color:rgba(0,0,0,.9);border-bottom:1px solid rgba(0,0,0,.06)}.startupCard .b{padding:18px;color:rgba(0,0,0,.88);font-weight:750;line-height:1.35}.authLoader .dot,.bootBar,.bootBar>div{height:10px;border-radius:999px}.bootBar{background:rgba(255,255,255,.1);overflow:hidden;margin-top:14px}.bootBar>div{height:100%;width:0%;background:linear-gradient(90deg,#2e7bff,#20c997);transition:width .25s ease}.bootMsg{margin-top:10px;color:var(--muted);font-weight:700;font-size:13px}button,input,select,textarea{font-size:16px}.authCard,textarea{border:1px solid var(--stroke)}textarea{width:100%;min-height:120px;border-radius:16px;background:rgba(0,0,0,.04);color:rgba(0,0,0,.9);padding:12px;font-weight:700;resize:vertical}#authGate{z-index:10020;display:none;padding:18px;background:rgba(0,0,0,.35);backdrop-filter:blur(16px)}#authGate.show{display:flex}.authCard{width:min(720px,100%);border-radius:26px;background:#fff;box-shadow:0 24px 70px rgba(0,0,0,.18);overflow:hidden}.authLoader,.field input{border-radius:14px;font-weight:800}.authLoader{position:fixed;top:calc(12px + var(--safe-top));left:50%;transform:translateX(-50%);z-index:10010;display:none;align-items:center;gap:10px;padding:10px 14px;background:rgba(0,0,0,.88);color:#fff;letter-spacing:-.01em;box-shadow:0 16px 44px rgba(0,0,0,.24);pointer-events:none}.authLoader .dot{width:10px;background:#34c759;box-shadow:0 0 0 0 rgba(52,199,89,.4);animation:pulse 1.6s infinite}.authLoader.show,.field{display:flex}.authCard .ah{padding:16px 16px 12px;font-weight:1000;letter-spacing:.02em;text-transform:uppercase;border-bottom:1px solid rgba(0,0,0,.06)}.authCard .ab{padding:16px}.field{flex-direction:column;gap:6px;margin-bottom:10px}.field label{color:rgba(0,0,0,.62);text-transform:uppercase;letter-spacing:.06em}.field input{padding:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.02);font-size:16px;outline:0}.authRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}.linkBtn{border:0;background:0 0;color:var(--accent);font-weight:900;padding:0}body.noscroll{overflow:hidden}.completedItem,.linkBtn{cursor:pointer}.completedItem:hover{background:rgba(0,0,0,.05)}.completedMeta{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;color:var(--muted);font-size:12px}.kv{font-variant-numeric:tabular-nums}.pillBtn{cursor:pointer;border:0}#prodModalBody .list .item:active,.pillBtn:active{transform:scale(.98)}.pillBtn:focus{outline:2px solid rgba(255,255,255,.18);outline-offset:2px}.topBanner{position:fixed;top:0;left:0;right:0;z-index:80;display:none;align-items:center;gap:10px;padding:calc(10px + var(--safe-top)) 14px 12px;background:linear-gradient(180deg,rgba(255,59,48,.18),rgba(255,59,48,.08));border-bottom:1px solid rgba(255,59,48,.28);box-shadow:0 16px 30px rgba(0,0,0,.18)}.topBanner.show{display:flex}.topBanner .icon{font-size:20px}.topBanner .body{flex:1;min-width:0}.topBanner .title{font-weight:900;font-size:16px}.topBanner .sub{font-size:13px;color:var(--muted);font-weight:800}.lastAlertBox,.topBanner .closeBtn{padding:10px 12px;border-radius:14px}.topBanner .closeBtn{border:0;font-weight:900;cursor:pointer}#topAlertBanner{position:fixed;top:calc(env(safe-area-inset-top,0));z-index:1200;display:flex;padding:14px 16px;background:rgba(255,255,255,.86);border:1px solid rgba(255,255,255,.6);max-height:40vh}#topAlertBanner .topAlertClose,.topBanner .closeBtn{background:rgba(0,0,0,.06)}#topAlertSpacer{width:100%}.lastAlertBox{margin-top:10px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.9);box-shadow:inset 0 1px 0 rgba(255,255,255,.6);opacity:.88;font-size:13px;line-height:1.35;word-break:break-word}.lastAlertLabel{font-weight:900;letter-spacing:.01em;color:rgba(12,16,26,.82);margin-bottom:4px}.lastAlertText{font-weight:800;color:rgba(12,16,26,.9);white-space:pre-wrap}.chunkyList{content-visibility:auto;contain-intrinsic-size:800px 2000px}@media (max-width:640px){.hideOnMobile{display:none!important}}.adminMobileHeader{display:none;flex-direction:column;gap:2px;padding:4px 2px 0}.adminMobileHeader .adminMobileTitle{font-weight:900;font-size:18px;letter-spacing:-.01em}.adminMobileHeader .adminMobileSub{font-size:13px;color:var(--muted);font-weight:800}.adminMobileStack{display:flex;flex-direction:column;gap:16px;width:100%}.mobileAssignInfo{background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.82));box-shadow:0 12px 26px rgba(15,23,42,.14)}.adminPanel{border:1px solid rgba(255,255,255,.78);border-radius:20px;padding:16px;background:linear-gradient(165deg,rgba(255,255,255,.96),rgba(247,249,252,.9));box-shadow:0 16px 36px rgba(15,23,42,.15);margin-top:0;min-width:0;backdrop-filter:blur(18px)}.adminPanel .panelHead{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;min-width:0;flex-wrap:wrap}.adminPanel .panelTitle{font-weight:900;letter-spacing:.02em;text-transform:uppercase;font-size:13px}.adminPanel .panelSub{font-size:12px;color:var(--muted);font-weight:800;margin-top:4px;min-width:0}.adminPanel .statusBadge{border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:6px 10px;font-size:12px;font-weight:900;background:rgba(0,0,0,.04);color:rgba(0,0,0,.76);white-space:nowrap;min-width:120px;text-align:center}.adminPanel .statusBadge.live{color:#0b5d2a;border-color:rgba(52,199,89,.4);background:rgba(52,199,89,.1)}.adminPanel .statusBadge.error{color:#8a1f1a;border-color:rgba(255,59,48,.4);background:rgba(255,59,48,.14)}.adminList{display:flex;flex-direction:column;gap:8px;padding:6px 0 2px;min-width:0}.adminSearch{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:#fff;font-weight:800;box-shadow:inset 0 1px 0 rgba(255,255,255,.8)}.mobileSendRow{border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px;background:#fff;display:flex;gap:10px;align-items:center;justify-content:space-between;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,background .12s ease,opacity .12s ease;min-width:0}.mobileSendRow:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,0,0,.06)}.mobileSendRow:active{transform:translateY(0);opacity:.9}.mobileSendRow.selected{border-color:rgba(10,132,255,.35);background:linear-gradient(180deg,rgba(10,132,255,.08),rgba(10,132,255,.03));box-shadow:0 12px 24px rgba(10,132,255,.12)}.mobileSendRow .info{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}.mobileSendRow .info .name{font-weight:900}.mobileSendRow .info .meta{font-size:12px;color:var(--muted);font-weight:800}.mobileSendToggle{position:relative;width:48px;height:28px;border-radius:999px;background:rgba(0,0,0,.12);box-shadow:inset 0 1px 3px rgba(0,0,0,.14);transition:background .18s ease;flex:0 0 auto}.mobileSendToggle .knob,.switch .slider:before{position:absolute;left:3px;top:3px;background:#fff;border-radius:50%}.mobileSendToggle .knob{width:22px;height:22px;box-shadow:0 2px 6px rgba(0,0,0,.18);transition:transform .2s cubic-bezier(.22,.61,.36,1),background .18s ease}.mobileSendRow.selected .mobileSendToggle{background:linear-gradient(90deg,#0a84ff,#34c759)}.mobileSendRow.selected .mobileSendToggle .knob{transform:translateX(20px);background:#fff}.saveBadge{border:1px solid rgba(0,0,0,.08);border-radius:12px;padding:8px 10px;font-size:12px;font-weight:900;background:rgba(0,0,0,.02);color:rgba(0,0,0,.78)}.saveBadge.live{color:#0b5d2a;border-color:rgba(52,199,89,.35);background:rgba(52,199,89,.1)}.saveBadge.error{color:#8a1f1a;border-color:rgba(255,59,48,.35);background:rgba(255,59,48,.14)}.mobileAssignInfo{display:none;margin:6px 0 12px;padding:10px 12px;border:1px solid rgba(0,0,0,.06);border-radius:12px;background:rgba(0,0,0,.03);font-weight:850;color:rgba(0,0,0,.72);font-size:13px}.switch{position:relative;display:inline-block;width:46px;height:26px}.switch input{display:none}.switch .slider{position:absolute;cursor:pointer;inset:0;background:rgba(0,0,0,.12);border-radius:999px;transition:.2s;box-shadow:inset 0 1px 3px rgba(0,0,0,.16)}.switch .slider:before{content:"";height:20px;width:20px;box-shadow:0 1px 4px rgba(0,0,0,.18);transition:.2s}.switch input:checked+.slider{background:linear-gradient(90deg,#0a84ff,#34c759)}.switch input:checked+.slider:before{transform:translateX(20px)}@media (min-width:1025px){body.adminDeskLayout #mobileSendCard{margin-top:0;padding:0;overflow:hidden}body.adminDeskLayout .mobileSendShell{display:flex;flex-direction:column;flex:1 1 auto;min-height:0;background:linear-gradient(180deg,#fff 0,#f8fafc 100%)}body.adminDeskLayout .mobileSendTopbar{position:sticky;top:0;z-index:2;flex:0 0 auto;padding:16px 18px 14px;border-bottom:1px solid rgba(0,0,0,.05);background:rgba(255,255,255,.9);backdrop-filter:blur(18px)}body.adminDeskLayout .mobileSendHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;min-width:0;flex-wrap:wrap}body.adminDeskLayout .mobileSendTitleCol{min-width:0;display:flex;flex-direction:column;gap:6px}body.adminDeskLayout .mobileStatsLine{display:flex;align-items:center;flex-wrap:wrap;gap:6px;font-size:13px;color:var(--muted);font-weight:800;font-variant-numeric:tabular-nums;letter-spacing:.01em;cursor:default}body.adminDeskLayout .mobileStatsLine b{color:rgba(0,0,0,.9);font-weight:900}body.adminDeskLayout .mobileStatsLine .statSep{opacity:.6}body.adminDeskLayout .mobileSendSubline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}body.adminDeskLayout .mobileSendStatus{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;justify-content:flex-end;min-width:0}body.adminDeskLayout .statusBadge{border-radius:999px;padding:7px 12px;border-color:rgba(0,0,0,.08);background:rgba(0,0,0,.03)}body.adminDeskLayout .saveBadge{border-radius:999px;padding:7px 12px;background:0 0;border-color:rgba(0,0,0,.06);font-weight:850}body.adminDeskLayout .mobileSendToolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:12px;padding-top:6px;border-top:1px solid rgba(0,0,0,.04)}body.adminDeskLayout .mobileSendToolbar .adminSearch{flex:1 1 320px;min-width:0}body.adminDeskLayout .mobileSendToolbarBtns{display:flex;gap:8px;align-items:center;flex:0 0 auto}body.adminDeskLayout .btn.actionGhost,body.adminDeskLayout .btn.actionPrimary{border-radius:12px;min-height:42px;padding:12px 16px;font-weight:900;letter-spacing:.01em;box-shadow:none}body.adminDeskLayout .btn.actionPrimary{background:#0a84ff;color:#fff;border-color:#0a84ff}body.adminDeskLayout .btn.actionPrimary:hover{background:#086fd4;border-color:#086fd4}body.adminDeskLayout .btn.actionGhost{background:0 0;border-color:rgba(0,0,0,.14)}body.adminDeskLayout .btn.actionGhost:hover{background:rgba(0,0,0,.04)}body.adminDeskLayout .microActions{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-left:auto;color:var(--muted);font-weight:800;font-size:13px}body.adminDeskLayout .microActions .textAction{border:0;background:0 0;padding:6px 0;color:rgba(0,0,0,.72);font-weight:850;cursor:pointer}body.adminDeskLayout .microActions .textAction:hover{color:rgba(0,0,0,.9);text-decoration:underline}body.adminDeskLayout .adminList{max-height:none}body.adminDeskLayout .mobileSendBody{display:flex;flex-direction:column;gap:10px;padding:12px 18px 16px;flex:1;min-height:0;box-sizing:border-box}body.adminDeskLayout .mobileSendListPane{display:flex;flex-direction:column;min-width:0;background:0 0;border-radius:0;border:0;box-shadow:none;padding:0;gap:12px;height:100%;min-height:0}body.adminDeskLayout .mobileSendListPane .listHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:4px 0;border-bottom:1px solid rgba(0,0,0,.05)}body.adminDeskLayout .mobileSendListPane .listHead .panelSub{margin:0}body.adminDeskLayout .mobileSendListPane .adminList{flex:1 1 auto;min-height:0;overflow-y:auto;overscroll-behavior:contain;padding:2px 0 6px}body.adminDeskLayout #mobileSendList{border-top:1px solid rgba(0,0,0,.04);border-bottom:1px solid rgba(0,0,0,.04)}body.adminDeskLayout .mobileSendRow{border:0;border-radius:0;padding:12px 4px;background:0 0;box-shadow:none;position:relative}body.adminDeskLayout .mobileSendRow+.mobileSendRow{border-top:1px solid rgba(0,0,0,.06)}body.adminDeskLayout .mobileSendRow:hover{background:rgba(0,0,0,.02);box-shadow:none;transform:none}body.adminDeskLayout .mobileSendRow:active{transform:translateY(0);opacity:.95}body.adminDeskLayout .mobileSendRow.selected{background:linear-gradient(180deg,rgba(10,132,255,.08),rgba(10,132,255,.03));border-top-color:rgba(10,132,255,.18);border-bottom:1px solid rgba(10,132,255,.14);box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}body.adminDeskLayout .mobileSendRow .info .name{font-weight:900;letter-spacing:-.01em}body.adminDeskLayout .mobileSendRow .info .meta{color:rgba(0,0,0,.55)}body.adminDeskLayout .mobileSendToggle{box-shadow:inset 0 1px 2px rgba(0,0,0,.12)}body.adminDeskLayout .mobileSendListPane .panelSub{color:rgba(0,0,0,.6);font-weight:850}body.adminDeskLayout #mobileSendCard{display:flex;flex-direction:column;min-height:0;max-height:calc(100vh - 120px)}body.adminDeskLayout #mobileSendCard .cardBody,body.adminDeskLayout #mobileSendCard .mobileSendBody,body.adminDeskLayout #mobileSendCard .panelBody{min-height:0;flex:1 1 auto;display:flex;flex-direction:column}body.adminDeskLayout #mobileSendList{flex:1 1 auto;min-height:0;overflow-y:auto!important;overflow-x:hidden!important;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}}body.kioskAdmin::before{background:radial-gradient(1400px 1200px at 50% -10%,rgba(46,123,255,.08),rgba(46,123,255,0) 52%),linear-gradient(180deg,var(--bg)0,var(--bg2) 100%)}body.kioskAdmin .wrap{max-width:1820px;width:min(96vw,1820px);padding:calc(12px + var(--safe-top) + var(--banner-offset)) 22px calc(28px + var(--safe-bot))}@media (min-aspect-ratio:16/9){body.kioskAdmin .wrap{max-width:1880px;padding-left:26px;padding-right:26px}}body.kioskAdmin .headerRow{padding:calc(8px + var(--safe-top)*.25)0 12px;margin-bottom:10px;min-height:68px;gap:16px}body.kioskAdmin .brand{gap:14px}body.kioskAdmin .brandLogo{width:76px;height:76px;transform:translateY(-2px)}body.kioskAdmin .title{font-size:44px;line-height:.9}body.kioskAdmin .subtitle{max-width:780px;line-height:1.3}body.kioskAdmin .statusRow{gap:10px;padding:0}body.kioskAdmin .pill{padding:6px 10px}body.kioskAdmin .iconBtn{box-shadow:0 10px 24px rgba(0,0,0,.08)}body.kioskAdmin .grid{grid-template-columns:minmax(420px,540px) minmax(0,1fr);gap:16px;align-items:start}@media (min-width:1600px){body.kioskAdmin .grid{grid-template-columns:minmax(460px,640px) minmax(0,1fr)}}body.kioskAdmin .grid>*{min-width:0}body.kioskAdmin #opsCard{min-height:620px}body.kioskAdmin .card{border-radius:20px;box-shadow:0 14px 34px rgba(0,0,0,.1)}body.kioskAdmin .card .hd{padding:16px 16px 12px}body.kioskAdmin .card .bd{padding:16px}body.kioskAdmin .primaryBtn{padding:20px}body.kioskAdmin .kv{font-variant-numeric:tabular-nums}body.kioskAdmin .k{padding:12px 14px}body.kioskAdmin .k .t{color:rgba(0,0,0,.58)}body.kioskAdmin .k .v{letter-spacing:-.01em}body.kioskAdmin .badge,body.kioskAdmin .k .v,body.kioskAdmin .pill{font-variant-numeric:tabular-nums}body.kioskAdmin .list{gap:10px}body.kioskAdmin .item{padding:12px 14px;border-color:rgba(0,0,0,.08);box-shadow:0 6px 16px rgba(0,0,0,.08)}body.kioskAdmin .item .top{align-items:center}body.kioskAdmin .completedMeta{gap:10px;row-gap:4px}body.kioskAdmin #completedCard,body.kioskAdmin #statsProdCard{display:flex;flex-direction:column;min-height:0}body.kioskAdmin #completedCard .bd,body.kioskAdmin #statsProdCard .bd{max-height:none;overflow:visible}body.kioskAdmin #completedCard .hd,body.kioskAdmin #statsProdCard .hd{position:sticky;top:0;background:inherit;z-index:2}body.kioskAdmin #completedList,body.kioskAdmin #statsList{min-width:0}body.kioskAdmin .row2{gap:12px}@media (min-aspect-ratio:16/9){body.kioskAdmin .headerRow{margin-bottom:8px}body.kioskAdmin .grid{gap:18px}body.kioskAdmin #completedCard .bd,body.kioskAdmin #statsProdCard .bd{max-height:clamp(360px,52vh,620px)}}@media (min-width:1025px){body.desktopV2 .wrap{width:100%;max-width:1920px;margin:0 auto;padding:calc(14px + var(--safe-top) + var(--banner-offset)) 18px calc(26px + var(--safe-bot));box-sizing:border-box}body.desktopV2 #completedCard,body.desktopV2 #mobileSendCard,body.desktopV2 #warehouseCard{display:flex;flex-direction:column;min-height:0}body.desktopV2 #completedCard .bd,body.desktopV2 #mobileSendCard .mobileSendBody,body.desktopV2 #mobileSendCard .mobileSendListPane,body.desktopV2 #warehouseCard .bd{display:flex;flex-direction:column;flex:1 1 auto;min-height:0}body.desktopV2 #completedBody,body.desktopV2 #mobileSendList,body.desktopV2 #warehouseBody{flex:1 1 auto;min-height:0;overflow-y:auto!important;overflow-x:hidden!important;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}body.desktopV2 .desktopShell{grid-template-columns:minmax(560px,1.05fr) minmax(460px,.95fr);gap:14px}body.adminDeskLayout #desktopSummaryCard{display:none!important}body.adminDeskLayout #mobileSendCard{max-height:calc(100vh - var(--hdrH,76px) - 18px)!important;height:calc(100vh - var(--hdrH,74px) - 18px)!important;max-height:none!important}body.adminDeskLayout #statsProdCard.miniCard{opacity:.9}body.adminDeskLayout #statsProdCard.miniCard .bd,body.adminDeskLayout #statsProdCard.miniCard .hd{padding:10px 12px}body.adminDeskLayout #statsProdCard.miniCard h2{font-size:16px}body.adminDeskLayout #statsProdCard.miniCard .bd>.muted:first-child{display:none}body.adminDeskLayout #statsProdCard.miniCard #statsBody{max-height:200px!important}#operatorLeaderboard{margin:0 0 14px}.opLbCard{border:1px solid var(--stroke);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.82),rgba(255,255,255,.94));padding:12px;box-shadow:0 10px 24px rgba(0,0,0,.04)}.opLbHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}.opLbTitle{font-weight:900;font-size:15px}.opLbMeta{color:var(--muted);font-weight:800;font-size:12px}.opLbToggles{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}.opLbToggleBtn{border:1px solid var(--stroke);background:rgba(0,0,0,.02);padding:8px 12px;border-radius:999px;font-weight:900;font-size:12px;color:var(--muted);cursor:pointer;transition:all .14s ease}.opLbToggleBtn.active{color:#0a84ff;background:rgba(10,132,255,.12);border-color:rgba(10,132,255,.28);box-shadow:0 8px 20px rgba(10,132,255,.12)}.opLbToggleBtn:focus-visible{outline:2px solid rgba(10,132,255,.32);outline-offset:2px}.opLbList{margin-top:10px;display:flex;flex-direction:column;gap:8px}.opLbRow{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;padding:10px 12px;border:1px solid var(--stroke);border-radius:14px;background:var(--card2);box-shadow:0 8px 20px rgba(0,0,0,.06)}.opLbRank{min-width:38px;height:38px;border-radius:12px;background:rgba(0,0,0,.04);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--text)}.opLbName{font-weight:900;font-size:14px}.opLbMetric .lbl,.opLbSub{color:var(--muted);font-size:12px;font-weight:800}.opLbMetrics{display:flex;align-items:center;gap:12px;justify-content:flex-end;flex-wrap:wrap}.opLbMetric{display:flex;flex-direction:column;align-items:flex-end;gap:2px;font-weight:900}.opLbMetric .val{font-variant-numeric:tabular-nums;font-size:15px}.opLbRow.top1{border-color:rgba(52,199,89,.26);background:linear-gradient(180deg,rgba(52,199,89,.12),rgba(52,199,89,.08))}.opLbRow.top2{border-color:rgba(10,132,255,.22)}.opLbRow.top3{border-color:rgba(255,159,10,.22)}.opLbEmpty{padding:8px;color:var(--muted);font-weight:800}@media (max-width:800px){.opLbRow{grid-template-columns:auto 1fr;grid-template-areas:"rank name""metrics metrics"}.opLbRank{grid-area:rank}.opLbName{grid-area:name}.opLbSub{grid-column:2/-1}.opLbMetrics{grid-area:metrics;justify-content:flex-start;gap:16px;padding-left:4px}.opLbMetric{align-items:flex-start}.opLbMetric .val{font-size:14px}}@media (max-width:520px){.opLbRow{border-radius:12px}.opLbCard,.opLbRow{padding:10px}.opLbToggleBtn{padding:7px 10px}.opLbMetrics{gap:12px}}body.adminDeskLayout #mobileSendCard .mobileSendShell{height:100%;min-height:0;display:flex;flex-direction:column}body.adminDeskLayout #mobileSendCard .mobileSendTopbar{flex:0 0 auto}body.adminDeskLayout #mobileSendCard .mobileSendBody,body.adminDeskLayout #mobileSendCard .mobileSendListPane{flex:1 1 auto;min-height:0}body.adminDeskLayout #mobileSendList{flex:1 1 auto;min-height:0;overflow-y:auto!important;overflow-x:hidden!important;overscroll-behavior:contain;-webkit-overflow-scrolling:touch;scrollbar-gutter:stable}#warehouseCard .magSimple{display:flex;flex-direction:column;gap:10px}#warehouseCard .whCritRow{display:flex;flex-wrap:wrap;gap:8px;margin:2px 0}#warehouseCard .whKpiRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:4px 0}#warehouseCard .whKpi{min-width:0}#warehouseCard .whActions{margin-top:8px}}@media (min-width:768px) and (max-width:1024px){header.headerRow{min-height:76px;align-items:center}.brandLogo{width:64px;height:64px;transform:none}.title{line-height:1.05}.subtitle{line-height:1.25}}@media (min-width:900px){.desktopShell{display:grid!important}.desktopShell>.mainCol,.desktopShell>.sideCol{display:flex!important;grid-column:1!important;grid-row:auto!important}.desktopShell>.sideCol{grid-column:2!important}#completedCard,#opsCard,#statsProdCard,#warehouseCard{grid-column:auto!important;grid-row:auto!important}#completedCard,#statsProdCard{position:relative!important;z-index:0!important;isolation:isolate;overflow:hidden!important;max-width:100%!important}#completedCard .hd,#statsProdCard .hd{position:sticky!important;top:0!important;z-index:1!important;background:inherit!important}#completedCard .bd,#statsProdCard .bd{overflow:hidden!important;max-height:none!important;min-height:0!important}#completedBody,#statsBody{overflow-y:auto!important;overflow-x:hidden!important;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;max-height:clamp(320px,46vh,620px)!important;min-height:0!important}#completedList,#operatorLeaderboard,#statsList{min-width:0!important;max-width:100%!important}#completedList .item,#statsList .item{max-width:100%!important;overflow:hidden}#completedList .item *,#statsList .item *{min-width:0!important}body.kioskAdmin #completedCard .bd,body.kioskAdmin #statsProdCard .bd{overflow:hidden!important;max-height:none!important}body.kioskAdmin #completedCard .hd,body.kioskAdmin #statsProdCard .hd{z-index:1!important}#warehouseCard,#warehouseCard .bd{display:flex;flex-direction:column;min-height:0}#warehouseCard{overflow:hidden!important;position:relative;z-index:0;isolation:isolate}#warehouseCard .bd{flex:1 1 auto;padding-bottom:14px!important}#warehouseBody{flex:1 1 auto;min-height:0!important;max-height:clamp(300px,48vh,720px)!important;overflow-y:auto!important;overflow-x:hidden!important;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}#warehouseBody,#warehouseBody *{max-width:100%;min-width:0}#warehouseBody{word-break:break-word;overflow-wrap:anywhere}#warehouseCard .bd,body.desktopV2 #warehouseCard,body.desktopV2 #warehouseCard .bd,body.kioskAdmin #warehouseCard,body.kioskAdmin #warehouseCard .bd{overflow:hidden!important}body.desktopV2 #warehouseBody,body.kioskAdmin #warehouseBody{overflow-y:auto!important;overflow-x:hidden!important}}@media (min-width:1025px){#opsCard{min-height:auto!important}#opsCard .bd{max-height:clamp(260px,34vh,460px)!important;overflow-y:auto!important;overflow-x:hidden!important;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding:4px 16px 14px!important;gap:10px!important}#opsCard .hd{padding:14px 16px 10px!important}#opsCard .kv{gap:8px!important}#opsCard .k{padding:8px 10px!important;border-radius:14px!important}#opsCard .k .v{font-size:16px!important}#opsCard .primaryBtn{padding:12px 14px!important;font-size:14px!important}}@media (min-width:1024px){body,html{height:100%;overflow:hidden}.wrap{box-sizing:border-box;display:grid!important;grid-template-rows:auto 1fr;align-content:stretch}.wrap>header.headerRow{grid-row:1}.wrap>.desktopShell{place-self:center;height:min(100%,calc((100vw - 56px)*3/4))!important;aspect-ratio:4/3;align-content:start;grid-row:2;height:100%!important;overscroll-behavior:contain;-webkit-overflow-scrolling:touch;padding:14px 18px 22px!important;box-sizing:border-box;width:100%!important;justify-self:center;align-self:stretch;min-width:0}header.headerRow{min-height:var(--hdrH);background:rgba(233,236,243,.78)!important;backdrop-filter:blur(10px);border-bottom:1px solid rgba(12,22,52,.08);overflow:hidden!important;transform:translateY(0);max-height:180px;will-change:transform,opacity,max-height;transition:transform 260ms cubic-bezier(.22,.61,.36,1),opacity .2s ease,max-height 260ms cubic-bezier(.22,.61,.36,1),padding 260ms cubic-bezier(.22,.61,.36,1),margin 260ms cubic-bezier(.22,.61,.36,1);margin:0 auto 12px!important;padding:calc(10px + var(--safe-top)) 18px 10px!important;position:sticky!important;transform:none!important;opacity:1!important;height:auto!important;pointer-events:auto!important;backdrop-filter:none!important}.wrap>.desktopShell *{min-width:0;max-width:100%}.wrap>.desktopShell,header.headerRow{width:min(100%,var(--deskW32))!important;background:0 0!important;border:0!important;box-shadow:none!important}.wrap>.desktopShell{overflow-x:hidden!important;max-width:min(98vw,calc((100dvh - var(--hdrH) - 24px)*3/2),1700px)!important;max-width:none!important;margin:0 auto!important;padding:0 18px calc(22px + var(--safe-bot))!important;outline:0!important;overflow:visible!important}.desktopShell .card,.desktopShell .item,.desktopShell .k,.wrap>.desktopShell .card,.wrap>.desktopShell .item,.wrap>.desktopShell .k{overflow-wrap:anywhere;word-break:break-word}.wrap>.desktopShell .item,.wrap>.desktopShell .k,.wrap>.desktopShell .kv,.wrap>.desktopShell .row{white-space:normal}.wrap>.desktopShell .card .bd{min-height:0}body.kioskAdmin .desktopShell{grid-template-columns:minmax(560px,1.05fr) minmax(0,.95fr)!important}#completedCard .hd,#statsProdCard .hd,#warehouseCard .hd,header.headerRow{position:static!important;top:auto!important;z-index:auto!important}#completedBody,#statsBody,#warehouseBody{max-height:none!important;overflow:visible!important}:root{--deskW32:min( 99vw,clamp(1240px,calc((100dvh - var(--hdrH) - 16px) * 3 / 2),1920px) )}.wrap{width:100%!important;max-width:none!important;height:100dvh!important;margin:0!important;padding:0!important;overflow-y:auto!important;overflow-x:hidden!important;-webkit-overflow-scrolling:touch;display:block!important}.desktopShell{grid-template-columns:minmax(600px,1.05fr) minmax(0,.95fr)!important;gap:18px!important;align-items:start!important;font-size:13px!important}#completedCard,#opsCard,#statsProdCard,#warehouseCard{overflow:hidden!important;position:relative;z-index:0;isolation:isolate}#completedCard .bd,#opsCard .bd,#statsProdCard .bd{overflow:hidden!important;min-height:0!important}#warehouseCard .bd{min-height:0!important}#completedBody,#statsBody,#warehouseBody{max-height:clamp(320px,46vh,620px)!important;overflow-y:auto!important;overflow-x:hidden!important;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}#statsBody,#warehouseBody{max-height:clamp(240px,34vh,520px)!important}#warehouseBody{max-height:clamp(460px,62vh,920px)!important}.desktopShell .card .hd h2{font-size:12px!important;letter-spacing:.02em!important}.desktopShell .badge,.desktopShell .muted,.desktopShell .pill{font-size:12px!important}.desktopShell .item,.desktopShell .k{padding:10px!important;border-radius:14px!important}.desktopShell .k{padding:8px 10px!important}.desktopShell .k .v{font-size:15px!important}.desktopShell .k .l{font-size:11px!important}.desktopShell .btn,.desktopShell .primaryBtn{padding:10px 12px!important;font-size:13px!important;border-radius:14px!important}.desktopShell .btn.ghost{padding:9px 12px!important}#mobileSendCard .mobileSendRow{padding:8px 10px!important;border-radius:12px!important;gap:8px!important}#mobileSendCard .panelTitle{font-size:12px!important}#mobileSendCard .mobileSendTopbar{gap:8px!important}#mobileSendCard button,#mobileSendCard input,#mobileSendCard select{font-size:13px!important;padding:9px 10px!important;border-radius:12px!important}#mobileSendCard button{padding:9px 11px!important}html.deskScrolled header.headerRow{display:none!important;min-height:0!important;display:flex!important;transform:translateY(-110%);opacity:0;max-height:0!important;padding:0!important;margin:0!important;pointer-events:none}html.deskScrolled .wrap{padding-top:calc(10px + var(--safe-top) + var(--banner-offset))!important}#warehouseCard .hd{padding:12px 14px 10px!important}#warehouseCard .bd{padding:12px 14px 14px!important;overflow:hidden!important}#warehouseCard .magFilterBar{display:grid!important;grid-template-columns:minmax(0,1fr) minmax(0,1fr) minmax(0,1fr) auto!important;gap:8px!important;align-items:end!important;margin:0 0 8px!important}#warehouseCard .magFilterField{gap:4px!important;min-width:0!important;flex:initial!important}#warehouseCard .magFilterLabel{font-size:10px!important;line-height:1!important;opacity:.78!important;letter-spacing:.02em}#warehouseCard .magFilterInput{padding:8px 10px!important;border-radius:10px!important;font-size:12px!important;font-weight:850!important;height:34px!important}#warehouseCard .magFilterActions{justify-content:flex-end!important;gap:8px!important;align-items:center!important;flex-wrap:nowrap!important}#warehouseCard .magResultBadge{font-size:11px!important;padding:6px 8px!important;border-radius:10px!important;white-space:nowrap!important}#warehouseCard #magFiltersReset.btn{padding:8px 10px!important;font-size:12px!important;border-radius:12px!important;min-height:34px!important}#warehouseCard .magFilterChips{gap:6px!important;margin:2px 0 8px!important}#warehouseCard .magChip{padding:6px 8px!important;border-radius:12px!important;font-size:11px!important}#warehouseCard .whKpiRow{gap:6px!important;margin:2px 0 6px!important}#warehouseCard .whKpi{padding:6px 8px!important;border-radius:12px!important;font-size:11px!important}#warehouseCard .whCritRow{margin:6px 0 8px!important}#warehouseCard .whOverview.rowsScroll{max-height:clamp(420px,60vh,760px)!important;padding-right:2px!important}#warehouseCard .whOverviewRow{padding:7px 10px!important;border-radius:12px!important;box-shadow:0 8px 16px rgba(0,0,0,.04)!important}#warehouseCard .whOverviewName{font-size:13px!important}#warehouseCard .whOverviewSub{font-size:11px!important}#warehouseCard .whOverviewVal{font-size:13px!important}#warehouseCard .whActions{margin-top:8px!important}#warehouseCard .whActions .btn{padding:10px 12px!important;font-size:12px!important;border-radius:14px!important}@media (max-width:1180px){#warehouseCard .magFilterBar{grid-template-columns:minmax(0,1fr) minmax(0,1fr)!important}#warehouseCard .magFilterActions{grid-column:1/-1!important;justify-content:space-between!important;flex-wrap:wrap!important}}.wrap{transition:padding-top 260ms cubic-bezier(.22,.61,.36,1);padding-top:0!important}}html.deskScrolled header.headerRow{position:static!important;top:auto!important;z-index:auto!important;transform:none!important;opacity:1!important;height:auto!important}html.deskScrolled .wrap{padding-top:calc(12px + var(--safe-top))!important}@media (max-width:1024px){.brand,header.headerRow{justify-content:flex-start!important;gap:10px!important}header.headerRow{flex-direction:column!important;align-items:stretch!important;padding-top:calc(10px + var(--safe-top)*.6)!important;padding-bottom:10px!important;min-height:0!important}.brand{width:100%!important;align-items:center!important}.brandLogo{width:56px!important;height:56px!important;flex:0 0 auto!important}.title{font-size:30px!important;line-height:.98!important}.subtitle{font-size:12.5px!important;line-height:1.25!important;max-width:100%!important;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden}.headerRow .actions,.statusRow.actions{width:100%!important;justify-content:flex-start!important}.statusRow.actions{overflow-x:auto!important;overflow-y:hidden!important;-webkit-overflow-scrolling:touch;overscroll-behavior-x:contain;padding-bottom:2px!important;scrollbar-width:none}.statusRow.actions::-webkit-scrollbar{display:none}.pill{font-size:12px!important;padding:6px 9px!important;flex:0 0 auto!important;max-width:86vw}.pill span:last-child{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70vw}#btnHeaderRefresh.iconBtn{width:40px!important;height:40px!important;min-width:40px!important;min-height:40px!important;border-radius:14px!important;font-size:18px!important}}@media (max-width:640px){header.headerRow #btnHeaderRefresh.iconBtn,header.headerRow .statusRow #pillOnline,header.headerRow .statusRow #pillPush,header.headerRow .statusRow #pillSync,header.headerRow .statusRow .pill,header.headerRow .statusRow .pillQuiet{display:inline-flex!important}}@media (max-width:899px){header.headerRow{flex-direction:column!important;align-items:stretch!important;justify-content:flex-start!important;gap:10px!important;padding:calc(10px + var(--safe-top))0 10px!important;min-height:0!important;flex-wrap:nowrap!important}.brand{width:100%!important;flex:1 1 auto!important;min-width:0!important}.brandLogo{width:46px!important;height:46px!important;transform:none!important}.title{font-size:30px!important;line-height:1!important;gap:0!important}.subtitle{display:-webkit-box!important;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden!important;font-size:12px!important;line-height:1.25!important;max-width:100%!important}.headerRow .statusRow.actions{width:100%!important;justify-content:flex-start!important;gap:8px!important;overflow-x:auto!important;overflow-y:visible!important;padding:2px 8px 4px!important;-webkit-overflow-scrolling:touch;overscroll-behavior-x:contain;scrollbar-width:none;min-height:44px!important}.headerRow .statusRow.actions::-webkit-scrollbar{display:none}.headerRow .statusRow.actions>*{flex:0 0 auto!important}header.headerRow .statusRow #pillOnline,header.headerRow .statusRow #pillPush,header.headerRow .statusRow #pillSync,header.headerRow .statusRow .pill,header.headerRow .statusRow .pillQuiet{display:flex!important}#btnHeaderRefresh{display:inline-flex!important}.pill{max-width:min(78vw,520px)!important}.pill span:last-child{max-width:64vw!important}#txtOnline,#txtPush,#txtSync,#txtXmlTime{max-width:60vw!important;overflow:hidden!important;text-overflow:ellipsis!important;white-space:nowrap!important}.iconBtn{width:40px!important;height:40px!important;min-width:40px!important;min-height:40px!important;border-radius:14px!important}#pillPush.pillBtn{padding:7px 10px!important;gap:8px!important}body,html{overflow-x:hidden!important}.wrap{width:100%!important;max-width:100%!important;padding-left:14px!important;padding-right:14px!important}.card,.card *{min-width:0!important}.card{max-width:100%!important;overflow:hidden!important}.card *{max-width:100%}.card .bd{overflow:hidden!important}.kv,.row2{grid-template-columns:1fr!important}.item,.line,.listRow,.row{max-width:100%!important;overflow:hidden}.item *,.line *,.listRow *,.row *{min-width:0!important}button,input,select,textarea{max-width:100%!important}textarea{width:100%!important}}#cardF480 .details,#cardF480 .meta,#cardF480 .muted,#cardF480 .sub,#cardF480 .tiny,#cardF480 small,#cardF830 .details,#cardF830 .meta,#cardF830 .muted,#cardF830 .sub,#cardF830 .tiny,#cardF830 small{display:none!important}.modalStepWrap{position:relative;overflow:visible;height:auto;transition:none!important}.modalStep{display:none;opacity:1;transform:none;transition:none!important;pointer-events:none}.modalStep.isActive{display:block;pointer-events:auto}.modalBody,.modalContent,.modalStep,.stepBody{justify-content:flex-start!important;align-content:flex-start!important}#prodModalBody .list .item{-webkit-tap-highlight-color:transparent;touch-action:manipulation;transform:translateZ(0);will-change:transform}@media (max-width:900px){.statusRow.actions{width:100%;max-width:100%;display:flex;flex-wrap:wrap;justify-content:flex-end;gap:8px;overflow:visible}.statusRow.actions>*{min-width:0;max-width:100%}.statusRow.actions .pill{flex:1 1 220px;max-width:100%}#pillPush{max-width:100%}#btnHeaderRefresh,#pillPush{flex:0 0 auto}.statusRow.actions .pill span{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;max-width:100%}}#warehouseBody .magSimple,#warehouseModalBody .magSimple{padding:16px!important}@media (min-width:900px){#warehouseBody .magSimple,#warehouseModalBody .magSimple{min-height:420px}}#warehouseBody{max-height:none!important;height:auto!important}#warehouseBody #whOverview.rowsScroll,#warehouseBody .magSimple,#warehouseModalBody .magSimple,#warehouseModalBody .whOverview.rowsScroll{overflow:visible!important;max-height:none!important;height:auto!important}#warehouseBody,#warehouseCard,#whOverview{overflow:visible!important}#warehouseCard .magChip,#warehouseCard .magFilterActions,#warehouseCard .magFilterBar,#warehouseCard .magFilterField,#warehouseCard .magFilterInput,#warehouseCard .magFilterLabel,#warehouseCard .magRow,#warehouseCard .whKpi,#warehouseCard .whOverviewRow,#whModalBody .whModalRow{min-width:0;max-width:100%}#warehouseCard .magChip *,#warehouseCard .magFilterActions *,#warehouseCard .magFilterBar *,#warehouseCard .magFilterField *,#warehouseCard .magFilterInput *,#warehouseCard .magFilterLabel *,#warehouseCard .magRow *,#warehouseCard .whKpi *,#warehouseCard .whOverviewRow *,#whModalBody .whModalRow *{white-space:normal!important;overflow:visible!important;text-overflow:clip!important;overflow-wrap:anywhere;word-break:break-word}#warehouseCard .magRow,#warehouseCard .whOverviewRow,#whModalBody .whModalRow{height:auto!important}#warehouseBody #whOverview,#warehouseBody .whOverviewRow,#warehouseModalBody .whOverview,#warehouseModalBody .whOverviewRow{pointer-events:auto!important;position:relative;z-index:1}#warehouseBody .whOverviewRow::after{pointer-events:none}@media (min-width:1024px){#warehouseBody,#warehouseCard,#warehouseCard .bd{min-height:auto!important}#warehouseBody,#warehouseBody .items,#warehouseBody .list,#warehouseBody .rows,#warehouseBody .rowsScroll,#warehouseCard,#warehouseCard .bd{overflow:visible!important;max-height:none!important;height:auto!important}}@media (max-width:899px){body,html{background:radial-gradient(900px 900px at 20% 18%,rgba(10,132,255,.14),transparent),radial-gradient(1100px 1100px at 82% 12%,rgba(52,199,89,.1),transparent),linear-gradient(180deg,var(--bg)0,var(--bg2) 100%)!important;background:linear-gradient(180deg,var(--bg)0,var(--bg2) 100%)!important;background-size:cover!important;background-repeat:no-repeat!important;background-position:center!important}header.headerRow .brand{align-items:flex-start!important;gap:12px!important}header.headerRow .brandLogo{width:64px!important;height:64px!important;transform:none!important}header.headerRow .titleWrap{gap:3px!important}header.headerRow .title{font-size:32px!important;line-height:.98!important;gap:0!important}header.headerRow .subtitle{font-size:12.5px!important;line-height:1.3!important}#pillSync{display:none!important}header.headerRow .statusRow.actions>.pill:not([id]){display:none!important}header.headerRow .statusRow.actions{overflow:visible!important;overflow-x:visible!important;flex-wrap:nowrap!important;justify-content:space-between!important;align-items:center!important;gap:10px!important}#pillOnline{flex:1 1 auto!important;min-width:0!important;white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important}#btnHeaderRefresh,#pillPush{flex:0 0 auto!important}#pillPush.pillBtn{padding:9px 12px!important}#opsCard .kv>.k,#pillPush.pillBtn,.iconBtn{border-radius:16px!important}.iconBtn{width:42px!important;height:42px!important;min-width:42px!important;min-height:42px!important}body::before{background:linear-gradient(180deg,var(--bg)0,var(--bg2) 100%)!important}#opsCard .kv{display:grid!important;grid-template-columns:repeat(2,minmax(0,1fr))!important;gap:10px!important}#opsCard .kv>.k{padding:10px!important;min-height:0!important}#opsCard .kv>.k .t{font-size:12px!important;line-height:1.15!important}#opsCard .kv>.k .v{font-size:18px!important;line-height:1.1!important}#opsCard .kv>.k .muted{font-size:11.5px!important;line-height:1.2!important}}#topAlertBanner{left:0!important;right:0!important;top:0!important;border-radius:0!important;padding:calc(env(safe-area-inset-top,0) + 6px) 12px 6px!important;background:rgba(255,214,10,.96)!important;backdrop-filter:blur(0)!important;box-shadow:0 10px 24px rgba(0,0,0,.18)!important;border:0!important;color:rgba(20,20,20,.96)!important;align-items:center!important;gap:10px!important;max-height:none!important;overflow:hidden!important;min-height:32px!important}#topAlertBanner .topAlertText{flex:1!important;min-width:0!important;overflow:hidden!important;white-space:nowrap!important;word-break:normal!important;font-weight:900!important;letter-spacing:.01em!important;font-size:13px!important;line-height:1.05!important}#topAlertBanner .topAlertTrack{display:inline-flex;align-items:center;white-space:nowrap;width:max-content;will-change:transform;animation:topAlertMarquee 18s linear infinite}#topAlertBanner .topAlertMsg{display:inline-block;padding-right:56px}#topAlertBanner .topAlertClose{border:0!important;background:rgba(0,0,0,.12)!important;color:rgba(20,20,20,.96)!important;border-radius:12px!important;padding:6px 10px!important;font-weight:900!important;cursor:pointer!important;flex:0 0 auto!important}@media (max-width:820px){body.role-admin .operatorOnly{display:none!important}#absenceCard{margin-top:14px}.absenceDates{display:grid;grid-template-columns:1fr 1fr;gap:10px}.absenceHint{font-size:12px;color:var(--muted);font-weight:700;line-height:1.25}#absenceModal .sbd{padding-bottom:calc(env(safe-area-inset-bottom,0) + 14px)}}@media (min-width:821px){#absenceCard{display:none!important}}:root{--pillYellow:rgba(255,204,0,.86)}@media (max-width:820px){body.role-operator #btnNotifCompleted,body.role-operator #btnTogglePush,body.role-operator #issueCard #btnSendIssue,body.role-operator #issueCard textarea,body.role-operator #notifAdminBox{display:none!important}body.role-operator #notifRowOperator{display:flex!important}body.role-operator #btnIssueOpen{display:inline-flex!important}body.role-operator #warehouseBody{display:none!important}#topAlertBanner .topAlertOpen,body.role-operator #btnWarehouseOpen{display:inline-flex!important}#topAlertBanner{cursor:pointer}}#callMatteoCard,#topAlertBanner .topAlertOpen{display:none}@media (max-width:820px){#topAlertBanner .topAlertOpen{display:inline-flex!important}.statusRow.actions{flex-wrap:wrap!important;justify-content:flex-start!important}.statusRow.actions .pillBtn{flex:0 0 auto}}@media (max-width:820px){body.role-operator #callMatteoCard{display:block!important}}@media (min-width:821px){#callMatteoCard{display:none!important}}#btnNotifCompleted,#btnTogglePush,#notifAdminBox{display:none!important}@media (max-width:820px){.overlay{padding:12px;padding-bottom:calc(12px + var(--safe-bot))}.sheet{width:100%;max-width:100%;border-radius:22px}.sheet .sbd{padding:14px;padding-bottom:calc(18px + var(--safe-bot))}.sheet textarea{min-height:140px}.sheet .btn,.sheet .primaryBtn{border-radius:16px}}#notifRowOperator{display:flex!important}@media (min-width:1025px){#warehouseCard{min-height:auto!important;display:block!important}#warehouseCard .bd{flex:0 0 auto!important}}#btnWarehouseOpen{display:inline-flex!important;align-items:center;justify-content:center;gap:10px}#warehouseBody{display:block!important}@media (max-width:820px){body.role-operator #warehouseBody{display:block!important}}#warehouseCard .whOverviewRow.whStatic{cursor:default!important;transform:none!important}#warehouseCard .whOverviewRow.whStatic:hover{transform:none!important;box-shadow:0 14px 28px rgba(0,0,0,.07)!important}#warehouseCard .whOverviewRow.whStatic:active{transform:none!important}@media (max-width:820px){.overlay{align-items:flex-end;justify-content:center;padding:12px;padding-top:calc(12px + var(--safe-top))}.sheet{width:100%;max-height:calc(100vh - 24px - var(--safe-top) - var(--safe-bot));border-radius:22px}.sheet .sbd,.sheet .shd{padding:14px}.sheet input,.sheet select,.sheet textarea{width:100%;box-sizing:border-box}.sheet .x{width:42px;height:42px;border-radius:14px}}</style><style>.logFilterBar{display:grid;grid-template-columns:repeat(auto-fit,minmax(0,1fr));gap:8px;align-items:end;margin-top:6px}.logFilterBar .logField,.logRows{display:flex;flex-direction:column}.logFilterBar .logField{gap:4px;min-width:0}.logFilterBar .logLabel{font-size:11px;letter-spacing:.02em;text-transform:uppercase;font-weight:900;color:var(--muted)}.logFilterBar select{border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-weight:850;font-size:13px;background:rgba(0,0,0,.03);color:var(--text)}.logFilterBar button{height:100%}.logRows{gap:10px}.logRow{border:1px solid rgba(0,0,0,.05);border-radius:14px;padding:12px;background:rgba(0,0,0,.02);box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}.logRow .logTitle{font-weight:900;color:rgba(0,0,0,.92)}.logRow .logMeta{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;font-size:12px;color:var(--muted);font-weight:800}.logRow .logDesc{margin-top:6px;font-weight:800}.logRow .logSub{margin-top:4px;font-size:12px;color:var(--muted);font-weight:800}.logBadge{padding:4px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.04);font-size:11px;font-weight:900}.logRows.rowsScroll{max-height:380px;overflow-y:auto;padding-right:4px}.logEmpty{display:none;margin-top:4px;color:var(--muted);font-weight:800}@media (max-width:720px){.logFilterBar{grid-template-columns:1fr;align-items:stretch}.logFilterBar button{width:100%}.logRows.rowsScroll{max-height:none}}</style><style>#absenceModal.absenceOverlay{padding:0;align-items:stretch;justify-content:flex-start;background:radial-gradient(140% 140%at 10%0,rgba(10,132,255,.16),transparent),radial-gradient(120% 140%at 80%0,rgba(52,199,89,.12),transparent),rgba(6,12,24,.56);backdrop-filter:blur(12px)}#absenceModal .absenceSheet{width:100%;max-width:100%;min-height:100vh;border-radius:0;padding:calc(18px + var(--safe-top)) 16px calc(20px + var(--safe-bot));display:flex;flex-direction:column;gap:16px;position:relative;overflow-y:auto;background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(245,247,252,.92));box-shadow:0 18px 46px rgba(0,0,0,.22)}#absenceModal .absenceTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}#absenceModal .absenceTitleCol{display:flex;flex-direction:column;gap:6px}#absenceModal .absenceBreadcrumb{font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}#absenceModal .absenceTitle{font-size:26px;font-weight:950;letter-spacing:-.02em;color:rgba(12,16,26,.96)}#absenceModal .absenceSub{font-weight:820;color:var(--muted)}#absenceModal .absenceUser{display:inline-flex;align-items:center;gap:8px;font-weight:900;color:rgba(12,16,26,.86);padding:10px 12px;border:1px solid var(--stroke);border-radius:14px;background:rgba(0,0,0,.03);width:max-content;box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}#absenceModal .absenceSteps{display:flex;flex-direction:column;gap:12px}#absenceModal .absenceStep{display:none;padding:16px;border-radius:18px;border:1px solid var(--stroke);background:rgba(255,255,255,.9);box-shadow:0 18px 36px rgba(0,0,0,.08)}#absenceModal .absenceStep.isActive{display:block}#absenceModal .absenceGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(0,1fr));gap:12px}#absenceModal .absenceLabel{font-weight:900;color:var(--muted);margin-bottom:6px}#absenceModal .absenceHintBox{padding:12px;border-radius:14px;border:1px dashed rgba(10,132,255,.3);background:rgba(10,132,255,.06);font-weight:800;color:rgba(10,132,255,.9)}#absenceModal .absenceActions{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}#absenceModal .absenceActions .spacer{flex:1 1 auto;min-width:0}#absenceModal .absenceFeedback{font-weight:900;color:var(--muted)}#absenceModal .absenceReviewCard{border:1px solid var(--stroke);border-radius:16px;padding:12px;background:linear-gradient(160deg,rgba(10,132,255,.08),rgba(0,0,0,.02));display:flex;flex-direction:column;gap:10px}#absenceModal .absenceReviewRow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;font-weight:900;color:rgba(12,16,26,.9)}#absenceModal .absenceReviewRow .label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.04em}#absenceModal .absenceReviewRow .value{text-align:right;max-width:60%;word-break:break-word}#absenceModal .absenceStepperDots{display:flex;gap:8px;align-items:center}#absenceModal .absenceDot{width:10px;height:10px;border-radius:999px;background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.1)}#absenceModal[data-step=form] .absenceDot[data-step=form],#absenceModal[data-step=review] .absenceDot[data-step=review]{background:#0a84ff;border-color:#0a84ff;box-shadow:0 0 0 6px rgba(10,132,255,.16)}@media (max-width:720px){#absenceModal .absenceSheet{padding:calc(14px + var(--safe-top)) 12px calc(18px + var(--safe-bot));gap:12px}#absenceModal .absenceTitle{font-size:22px}#absenceModal .absenceStep{padding:14px}}</style><style>:root{--whSurface:rgba(255,255,255,0.78);--whStroke:rgba(15,23,42,.08);--whGlass:rgba(255,255,255,0.9);--whGlow:0 24px 80px rgba(15,23,42,.14);--whOk:#34c759;--whWarn:#ff9f0a;--whNon:#d0d5e2}#warehouseCard{background:linear-gradient(180deg,rgba(255,255,255,.9)0,rgba(245,247,252,.92) 100%);border:1px solid rgba(255,255,255,.9);box-shadow:0 24px 70px rgba(15,23,42,.12)}#warehouseCard .hd{border-bottom:1px solid rgba(15,23,42,.06);padding:16px 18px 12px}#warehouseCard .bd{padding:18px;background:radial-gradient(120% 120%at 20%0,rgba(10,132,255,.08),transparent),radial-gradient(120% 120%at 80%0,rgba(52,199,89,.06),transparent)}.whShell{display:flex;flex-direction:column;gap:14px}.whHeroGlass{display:grid;grid-template-columns:1.1fr minmax(220px,.9fr);gap:14px;padding:18px;border-radius:18px;background:var(--whGlass);border:1px solid var(--whStroke);box-shadow:var(--whGlow);backdrop-filter:blur(14px);align-items:center}@media (max-width:980px){.whHeroGlass{grid-template-columns:1fr;gap:12px}}.whHeroText{display:flex;flex-direction:column;gap:10px}.whHeroTitle{font-size:22px;font-weight:900;letter-spacing:-.01em;color:rgba(12,16,26,.94)}.whHeroSub{font-size:14px;font-weight:800;color:var(--muted)}.whChip,.whChipRow{gap:8px;align-items:center}.whChip{display:inline-flex;border-radius:999px;padding:8px 12px;background:rgba(10,132,255,.12);color:#0a84ff;font-weight:900;font-size:13px;width:max-content;box-shadow:inset 0 1px 0 rgba(255,255,255,.6)}.whChipRow{display:flex;flex-wrap:wrap}.whChipPill{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:14px;background:rgba(0,0,0,.04);border:1px solid rgba(15,23,42,.06);font-weight:800;color:rgba(12,16,26,.82)}.whChipPill[data-tone=warn]{background:rgba(255,159,10,.14);border-color:rgba(255,159,10,.24)}.whChipPill[data-tone=non]{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.08)}.whDonutWrap,.whHeroViz{display:flex;justify-content:flex-end}.whHeroViz{width:100%}.whDonutWrap{align-items:center;gap:14px;flex-wrap:wrap}.whDonutWrap .whDonutLg{flex:0 0 auto}.whDonutLg{width:160px;height:160px;box-shadow:0 18px 42px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.04);background:conic-gradient(var(--whOk) 0deg 240deg,var(--whWarn) 240deg 320deg,var(--whNon) 320deg 360deg)}.whLegendCompact{flex:1 1 220px;min-width:200px;display:flex;flex-direction:column;gap:6px}.whLegendItem{display:flex;align-items:flex-start;gap:8px;justify-content:space-between;padding:6px 0;font-weight:800;color:rgba(12,16,26,.78)}.whLegendItem .name{flex:1;min-width:0;white-space:normal}.whLegendItem .val{font-variant-numeric:tabular-nums;color:rgba(12,16,26,.64);white-space:nowrap}.whLegendItem .whDot{width:10px;height:10px;border-radius:999px;background:var(--whOk)}.whLegendItem .whDot.warn{background:var(--whWarn)}.whLegendItem .whDot.non{background:var(--whNon)}.whMiniGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}.whListCard,.whMiniCard{border:1px solid var(--whStroke)}.whMiniCard{padding:14px 16px;border-radius:16px;background:var(--whSurface);box-shadow:inset 0 1px 0 rgba(255,255,255,.7),0 10px 32px rgba(15,23,42,.08);display:flex;flex-direction:column;gap:6px}.whMiniCard .label{font-size:12px;font-weight:800;color:var(--muted);letter-spacing:.01em}.whMiniCard .value{font-size:22px;letter-spacing:-.01em}.whMiniCard[data-tone=ok] .value{color:var(--whOk)}.whMiniCard[data-tone=warn] .value{color:var(--whWarn)}.whMiniCard[data-tone=non] .value{color:#8c8fa3}.whListCard{background:var(--whGlass);border-radius:18px;padding:16px;box-shadow:var(--whGlow);backdrop-filter:blur(12px)}.whListHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}.whListTitle{font-size:18px;font-weight:900;letter-spacing:-.01em;color:rgba(12,16,26,.92)}.whListBadge{padding:8px 12px;border-radius:12px;border:1px solid var(--whStroke);background:rgba(0,0,0,.03);font-weight:800;font-size:12px;color:var(--muted)}.whList{display:flex;flex-direction:column;gap:8px}.whListRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px 14px;border-radius:14px;background:rgba(255,255,255,.92);border:1px solid rgba(15,23,42,.06);box-shadow:0 12px 30px rgba(15,23,42,.06)}.whListRow .name,.whMiniCard .value{font-weight:900;color:rgba(12,16,26,.9)}.whListRow .sub{margin-top:4px;font-size:12px;font-weight:800;color:var(--muted)}.whListRow .value{font-weight:900;font-size:15px;color:rgba(12,16,26,.9);white-space:nowrap}.whFooterActions{margin-top:12px;display:flex;justify-content:flex-end}.whGhostBtn{border:1px solid var(--whStroke);background:rgba(10,132,255,.08);color:#0a84ff;padding:12px 14px;border-radius:14px;font-weight:900;cursor:pointer;box-shadow:0 12px 28px rgba(10,132,255,.12)}.whGhostBtn:active{transform:translateY(1px)}</style><style>#warehouseModal{align-items:center;justify-content:center;background:radial-gradient(120% 140%at 18% 10%,rgba(10,132,255,.18),transparent),radial-gradient(120% 140%at 82% 8%,rgba(52,199,89,.14),transparent),rgba(6,12,24,.48);backdrop-filter:blur(12px);padding:20px}#warehouseModal .whSheet{position:relative;width:min(1120px,96vw);border-radius:28px;overflow:hidden;background:linear-gradient(135deg,rgba(255,255,255,.94),rgba(245,247,252,.9));border:1px solid rgba(255,255,255,.7);box-shadow:0 26px 64px rgba(15,23,42,.22),0 2px 0 rgba(255,255,255,.6)}#warehouseModal .whHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:22px 24px 18px;background:linear-gradient(120deg,rgba(10,132,255,.14),rgba(52,199,89,.1));border-bottom:1px solid rgba(15,23,42,.06)}#warehouseModal .whTitleWrap{display:flex;flex-direction:column;gap:8px;min-width:0}#warehouseModal .whTitleRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}#warehouseModal .whTitle{font-size:30px;font-weight:950;letter-spacing:-.02em;color:rgba(12,16,26,.96)}#warehouseModal .whSubtitle{font-size:14px;font-weight:820;color:var(--muted)}#warehouseModal .whBadge{padding:8px 12px;border-radius:12px;background:rgba(0,0,0,.06);border:1px solid rgba(15,23,42,.08);box-shadow:inset 0 1px 0 rgba(255,255,255,.72),0 8px 22px rgba(15,23,42,.08);font-weight:900}#warehouseModal .whChips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:4px}#warehouseModal .whChip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:900;font-size:12px;letter-spacing:.01em;border:1px solid rgba(15,23,42,.08);box-shadow:inset 0 1px 0 rgba(255,255,255,.72),0 10px 26px rgba(15,23,42,.08)}#warehouseModal .whChip.accent{background:rgba(10,132,255,.16);color:#0a84ff;border-color:rgba(10,132,255,.28)}#warehouseModal .whChip.good{background:rgba(52,199,89,.18);color:#168f45;border-color:rgba(52,199,89,.26)}#warehouseModal .whChip.ghost{background:rgba(0,0,0,.04);color:rgba(12,16,26,.82)}#warehouseModal .whToolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}#warehouseModal .whBtn{border:1px solid rgba(15,23,42,.1);background:rgba(255,255,255,.7);color:rgba(12,16,26,.92);padding:10px 14px;border-radius:14px;font-weight:900;display:inline-flex;align-items:center;gap:8px;box-shadow:0 12px 26px rgba(15,23,42,.12);cursor:pointer;min-height:42px}#warehouseModal .whBtn.ghost{background:rgba(255,255,255,.9)}#warehouseModal .whBtn:active{transform:translateY(1px)}#warehouseModal .whBtn.isBusy{opacity:.7;pointer-events:none}#warehouseModal .whClose{width:46px;height:46px;border-radius:16px;border:1px solid rgba(15,23,42,.08);background:rgba(0,0,0,.06);box-shadow:0 12px 22px rgba(15,23,42,.12);color:rgba(12,16,26,.9)}#warehouseModal .whBody{display:grid;grid-template-columns:1fr;gap:16px;padding:18px 20px 20px;background:linear-gradient(180deg,rgba(255,255,255,.86),rgba(245,247,252,.96))}#warehouseModal .whGlassCard{background:rgba(255,255,255,.92);border:1px solid rgba(15,23,42,.06);border-radius:22px;padding:18px;box-shadow:0 22px 48px rgba(15,23,42,.12);backdrop-filter:blur(12px)}#warehouseModal .whCardHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px}#warehouseModal .whCardLabel{font-size:12px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}#warehouseModal .whCardTitle{font-size:22px;font-weight:950;letter-spacing:-.01em;color:rgba(12,16,26,.94)}#warehouseModal .whCardHint{font-size:13px;color:var(--muted);font-weight:820;margin-top:4px;max-width:620px}#warehouseModal .whStatus{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:14px;background:rgba(10,132,255,.1);border:1px solid rgba(10,132,255,.16);font-weight:900;color:#0a84ff}#warehouseModal .whStatus .dot{width:11px;height:11px}#warehouseModal .whScroll{max-height:min(62vh,680px);overflow-y:auto;padding:6px;margin:-4px}@media (max-width:1040px){#warehouseModal .whBody{grid-template-columns:1fr}#warehouseModal .whSheet{border-radius:24px}}@media (max-width:760px){#warehouseModal{padding:14px}#warehouseModal .whHeader{flex-direction:column;align-items:flex-start}#warehouseModal .whToolbar{width:100%;justify-content:space-between}#warehouseModal .whScroll{max-height:calc(70vh - var(--safe-top));padding:4px}}@media (max-width:820px){#warehouseModal{align-items:stretch;justify-content:flex-start;padding:0}#warehouseModal .whSheet{width:100%;max-width:100%;height:100vh;max-height:none;border-radius:0;display:flex;flex-direction:column}#warehouseModal .whHeader{width:100%;padding:calc(14px + var(--safe-top)) 16px 12px}#warehouseModal .whBody{flex:1 1 auto;min-height:0;padding:14px 16px calc(18px + var(--safe-bot))}#warehouseModal .whScroll{max-height:none;flex:1 1 auto;overflow-y:auto}}</style><style>#btnWarehouseOpen{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:0!important;opacity:0!important;border:0!important;pointer-events:none!important}</style><style>.supportCard{background:linear-gradient(150deg,rgba(255,255,255,.94),rgba(245,247,252,.9));border:1px solid rgba(255,255,255,.86);box-shadow:0 20px 50px rgba(15,23,42,.12),inset 0 1px 0 rgba(255,255,255,.8);overflow:hidden}.supportCard .hd{align-items:flex-start;padding:16px 18px 8px;gap:10px}.supportTitleCol{display:flex;flex-direction:column;gap:4px}.supportTitleCol .eyebrow{letter-spacing:.14em;font-size:11px;color:rgba(12,16,26,.58)}.supportTitle{margin:0;font-size:18px;letter-spacing:-.01em;font-weight:900;color:rgba(12,16,26,.92)}.supportBadge{padding:9px 12px;border-radius:12px;background:rgba(10,132,255,.12);color:#0a84ff;font-weight:900;font-size:12px;box-shadow:0 12px 28px rgba(10,132,255,.16),inset 0 1px 0 rgba(255,255,255,.7);border:1px solid rgba(10,132,255,.18)}.supportBody{gap:14px}.supportIntro{display:flex;flex-direction:column;gap:6px}.supportLead{font-size:16px;font-weight:900;color:rgba(12,16,26,.9)}.supportSub{font-size:13px;font-weight:800;color:var(--muted);line-height:1.3}.supportActions{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}.supportBtn,.supportBtnIcon{align-items:center;border:1px solid rgba(12,22,52,.08)}.supportBtn{position:relative;border:0;border-radius:18px;padding:16px 14px;display:flex;gap:12px;text-align:left;cursor:pointer;background:rgba(255,255,255,.76);box-shadow:0 18px 36px rgba(15,23,42,.1),inset 0 1px 0 rgba(255,255,255,.8);transition:transform .14s cubic-bezier(.22,.61,.36,1),box-shadow .18s ease;width:100%}.supportBtn:active{transform:translateY(1px);box-shadow:0 12px 24px rgba(15,23,42,.08)}.supportBtnIcon{width:42px;height:42px;border-radius:14px;display:inline-flex;justify-content:center;font-size:20px;background:rgba(0,0,0,.04);box-shadow:inset 0 1px 0 rgba(255,255,255,.8)}.supportBtnText{display:flex;flex-direction:column;gap:3px;flex:1;min-width:0}.supportBtnText .label{font-weight:900;color:rgba(12,16,26,.94);letter-spacing:-.01em}.supportBtnText .hint{font-size:12px;font-weight:780;color:var(--muted)}.supportBtnBadge{font-size:11px;padding:6px 10px;border-radius:12px;background:rgba(0,0,0,.04);border:1px solid rgba(12,22,52,.08);font-weight:850;color:rgba(12,16,26,.76);box-shadow:inset 0 1px 0 rgba(255,255,255,.8)}.supportBtn.accent{background:linear-gradient(135deg,rgba(10,132,255,.18),rgba(10,132,255,.12));border-color:rgba(10,132,255,.28);box-shadow:0 18px 40px rgba(10,132,255,.18),inset 0 1px 0 rgba(255,255,255,.85);color:#0a84ff}.supportBtn.accent .supportBtnBadge{background:rgba(255,255,255,.86);color:#0a84ff;border-color:rgba(10,132,255,.26)}.supportBtn.neutral{background:linear-gradient(135deg,rgba(52,199,89,.14),rgba(255,255,255,.82));border-color:rgba(52,199,89,.26);box-shadow:0 18px 36px rgba(52,199,89,.18),inset 0 1px 0 rgba(255,255,255,.86)}.supportBtn.neutral .supportBtnBadge{background:rgba(255,255,255,.9);color:#0a7331;border-color:rgba(52,199,89,.24)}@media (max-width:720px){.supportCard .hd{flex-direction:column;align-items:flex-start}.supportBadge{align-self:flex-start}.supportActions{grid-template-columns:1fr}.supportBtn{width:100%}}</style><style>.payrollCard{background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(245,247,252,.9));border:1px solid rgba(255,255,255,.9);border-radius:18px;box-shadow:0 18px 40px rgba(15,23,42,.12);padding:16px;display:flex;flex-direction:column;gap:10px;position:relative;overflow:hidden}.payrollCard .pcHead{display:flex;align-items:center;justify-content:space-between;gap:10px}.payrollCard .pcTitle{font-size:18px;font-weight:900;letter-spacing:-.01em;color:rgba(12,16,26,.94)}.payrollCard .pcSub{font-weight:800;color:var(--muted)}.payrollCard .pcBadge{padding:8px 12px;border-radius:999px;background:rgba(10,132,255,.12);color:#0a84ff;font-weight:900;border:1px solid rgba(10,132,255,.14);box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}.payrollCard .pcBody{display:flex;flex-direction:column;gap:10px}.payrollCard .pcActionRow{display:flex;flex-wrap:wrap;gap:8px;align-items:center}.payrollCard .pcHint{font-size:13px;color:var(--muted);font-weight:800}.payrollBtn{border:1px solid var(--stroke);color:rgba(0,0,0,.88);padding:14px 12px;border-radius:14px;font-weight:850;cursor:pointer;min-height:44px}.payrollBtn.primary{background:linear-gradient(180deg,#0a84ff,rgba(10,102,255,.94));color:#fff;border:0;box-shadow:0 16px 30px rgba(10,132,255,.22)}.payrollBtn,.payrollBtn.secondary{background:rgba(0,0,0,.04)}.payrollBtn:active{transform:translateY(1px)}.payrollOverlay{position:fixed;inset:0;z-index:30;display:none;align-items:stretch;justify-content:center;padding:0;background:rgba(4,9,18,.65);backdrop-filter:blur(14px)}.payrollOverlay.show{display:flex}.payrollSheet{width:100%;max-width:1200px;background:linear-gradient(180deg,rgba(255,255,255,.97),rgba(243,246,253,.94));border-radius:0;padding:calc(18px + var(--safe-top)) 18px calc(18px + var(--safe-bot));display:flex;flex-direction:column;gap:14px;overflow-y:auto}.payrollTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}.payrollTitleWrap{display:flex;flex-direction:column;gap:6px}.payrollTitle{font-size:24px;font-weight:950;letter-spacing:-.02em;color:rgba(12,16,26,.96)}.payrollSub{font-weight:820;color:var(--muted)}.payrollBadgeRow{display:flex;gap:8px;flex-wrap:wrap}.payrollPill{padding:8px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.04);font-weight:850;color:rgba(12,16,26,.8)}.payrollClose{border:1px solid var(--stroke);background:rgba(0,0,0,.06);width:44px;height:44px;border-radius:14px;font-size:20px;font-weight:900;cursor:pointer}.payrollPane,.payrollSteps{display:flex;flex-direction:column;gap:12px}.payrollPane{border:1px solid rgba(0,0,0,.06);border-radius:18px;background:rgba(255,255,255,.92);box-shadow:0 14px 32px rgba(15,23,42,.1);padding:16px}.payrollGrid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}@media (max-width:980px){.payrollGrid{grid-template-columns:1fr}.payrollSheet{border-radius:0}}.dropArea{border:2px dashed rgba(10,132,255,.35);background:rgba(10,132,255,.06);border-radius:16px;padding:18px;display:flex;flex-direction:column;gap:10px;align-items:flex-start}.dropArea.drag{border-color:rgba(10,132,255,.9);background:rgba(10,132,255,.12)}.uploadActions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}.miniHint{font-size:12px;color:var(--muted);font-weight:800}.table{width:100%;border-collapse:separate;border-spacing:0 8px}.badgeTone,.table th{font-size:12px;font-weight:900}.table th{text-transform:uppercase;letter-spacing:.04em;text-align:left;color:var(--muted);padding:4px 8px}.table td{background:rgba(0,0,0,.02);padding:10px 8px;border-radius:10px;font-weight:800;color:rgba(12,16,26,.9)}.badgeTone{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px}.tone-ok{background:rgba(52,199,89,.16);color:#0a7a36;border:1px solid rgba(52,199,89,.28)}.tone-warn{background:rgba(255,159,10,.16);color:#b05f02;border:1px solid rgba(255,159,10,.3)}.tone-bad{background:rgba(255,59,48,.16);color:#b0120b;border:1px solid rgba(255,59,48,.3)}.tone-quiet{background:rgba(0,0,0,.06);color:var(--muted);border:1px solid rgba(0,0,0,.1)}.payrollList .row .meta,.snippet{font-size:12px;color:var(--muted);font-weight:800}.pillGroup{display:flex;flex-wrap:wrap;gap:6px}.payrollList{display:flex;flex-direction:column;gap:10px}.payrollList .row{border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px;background:rgba(0,0,0,.02);display:flex;gap:10px;justify-content:space-between;align-items:flex-start}.payrollTabs{display:flex;gap:8px;flex-wrap:wrap}.payrollTab{padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:rgba(0,0,0,.02);font-weight:850;cursor:pointer}.payrollTab.active{background:rgba(10,132,255,.14);border-color:rgba(10,132,255,.3);color:#0a84ff;box-shadow:0 12px 24px rgba(10,132,255,.14)}.payrollNonAdminCard{border:1px solid rgba(0,0,0,.06);border-radius:18px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(245,247,252,.9));box-shadow:0 16px 36px rgba(15,23,42,.12);display:flex;flex-direction:column;gap:10px}.payrollNonAdminHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}.payrollNonAdminActions{display:flex;gap:8px;flex-wrap:wrap}.payrollBadgeSmall{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.08);font-weight:850;color:var(--muted)}.payrollInlineField{display:flex;flex-direction:column;gap:4px}.payrollSelect{border:1px solid var(--stroke);border-radius:12px;padding:10px;font-weight:850;background:rgba(0,0,0,.03)}</style><link rel="manifest" href="/tabellone-produzione-live/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#0b0f14"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Hub Polveri"><link rel="apple-touch-icon" href="icons/apple-touch-icon.png"></head><body><div id="startup"><div class="startupCard"><div class="a">Avviso aziendale</div><div class="b">I dati visualizzati in questo sistema sono <b>riservati</b> e destinati esclusivamente alluso interno.<br> vietata qualsiasi condivisione o diffusione non autorizzata al di fuori dellazienda.<br>Eventuali violazioni potranno comportare <b>provvedimenti disciplinari</b> e <b>azioni legali</b> secondo quanto previsto dalle normative vigenti.<div class="bootBar"><div id="bootFill"></div></div><div id="bootMsg" class="bootMsg">BOOT: inizializzazione</div></div></div></div><div id="authLoader" class="authLoader" role="status" aria-live="polite"><div class="dot" aria-hidden="true"></div><div class="txt">Verifica accesso</div></div><div id="authGate" role="dialog" aria-modal="true"><div class="authCard"><div class="ah">Accesso operatore</div><div class="ab" id="authBody"></div></div></div><div id="cancelBanner" class="topBanner" role="status" aria-live="polite"><div class="icon"></div><div class="body"><div class="title">Produzione annullata</div><div class="sub" id="cancelBannerSub">Lordine  stato annullato.</div></div><button class="closeBtn" id="cancelBannerClose" type="button">Chiudi</button></div><div class="wrap"><header class="headerRow"><div class="brand"><img class="brandLogo" src="./logo%20general%20copper.png" alt="General Copper" decoding="async" loading="eager"><div class="titleWrap"><div class="title" aria-label="Hub linea polveri"><span class="titleLine">Hub Linea</span><span class="titleLine accent">Polveri</span></div><div class="subtitle">Benvenuto operatore <b id="hdrUser">Ludovico</b>, questo mese hai prodotto <span id="hdrMonthKg">0</span> kg e hai concluso <span id="hdrMonthOrders">0</span> ordini.</div></div></div><div class="statusRow actions"><div class="pill" id="pillOnline"><span class="dot warn" id="dotOnline"></span><span id="txtOnline">Stato: sincronizzazione</span></div><div class="pill"><span class="dot ok"></span><span id="txtXmlTime">Ordini: aggiornati 2025-12-23T16:16:18.395Z</span></div><div class="pill pillQuiet" id="pillSync" style="display:flex"><span class="dot warn" id="dotSync"></span><span id="txtSync">Aggiornamento</span></div><button id="btnHeaderRefresh" class="iconBtn" type="button" aria-label="Aggiorna" title="Aggiorna"><span class="icon" aria-hidden="true"></span><span class="errBadge" id="refreshErrBadge">Errore rete</span></button><button class="iconBtn" id="btnHeaderPayrollUser" title="Busta paga" aria-label="Busta paga" type="button"><span class="icon" aria-hidden="true"></span></button><button class="iconBtn adminOnly" id="btnHeaderPayrollAdmin" title="Upload buste paga" aria-label="Upload buste paga" type="button"><span class="icon" aria-hidden="true"></span></button></div></header><div class="grid homeWrapOrMainContainer desktopShell"><div class="desktopCol mainCol"><div class="card heroCard" id="opsCard"><div class="hd"><h2>Operativit</h2><div class="badge" id="badgeCounts"></div></div><div class="bd"><button class="primaryBtn" id="btnGoProd">VAI IN PRODUZIONE</button><div style="height:12px"></div><div id="partialBanner" class="warnBanner pressCard fadeCard" style="display:none" role="button" tabindex="0" aria-label="Ordini parzialmente conclusi"><div class="icon"></div><div class="txt"><div class="t" id="partialBannerTitle">Ci sono ordini parzialmente conclusi in corso</div><div class="s" id="partialBannerSub">Apri per vedere solo gli ordini parziali e concludere.</div></div><div class="badge">Apri</div></div><div style="height:12px"></div><div id="prodStrip" class="bigStrip" style="display:none"><div class="label">Produzione in corso</div><div class="marquee"><span id="prodMarquee"></span></div><div class="meta"><div class="metaCount"><b id="prodCount">0</b> attivit attive</div><div class="metaHint">Tap per dettagli e conclusione</div></div></div><div style="height:12px"></div><div class="kv"><div class="k"><div class="t">Righe polveri</div><div class="v" id="kPowderLines"></div></div><div class="k"><div class="t">Kg totali</div><div class="v" id="kPowderKg"></div><div class="muted" id="kPowderMeta" style="margin-top:4px;font-size:12px">Calcolato su 0 righe visibili</div></div><div class="k" id="cardF480"><div class="t">Bobine F480 (stima)</div><div class="v" id="kBobineF480"></div><div class="muted" id="kBobineF480Meta" style="margin-top:4px;font-size:12px">Stima non disponibile</div></div><div class="k" id="cardF830"><div class="t">Bobine F830 (stima)</div><div class="v" id="kBobineF830"></div><div class="muted" id="kBobineF830Meta" style="margin-top:4px;font-size:12px">Stima non disponibile</div></div></div><div class="muted" id="kBobineUnknown" style="margin-top:6px;font-size:12px;display:none">Non classificati:  kg</div></div></div><div class="card" id="completedCard"><div class="hd"><h2 class="cardTitle">Ordini conclusi</h2><div class="cardTopActions adminOnly"><button type="button" class="miniBtn" data-action="print" data-target="#completedCard">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#completedCard">Condividi</button></div><div class="badge" id="completedBadge">0</div></div><div class="bd"><div class="rowsScroll" id="completedBody"><div class="list" id="completedList"></div><div class="muted" id="completedEmpty" style="display:none">Nessuna produzione conclusa registrata.</div></div></div></div><div id="warehouseAnchor" style="display:none" aria-hidden="true"></div><div class="card operatorOnly" id="callMatteoCard"><div class="bd"><button class="primaryBtn" id="btnCallMatteoBig" aria-label="Chiama Matteo" style="width:100%;border-radius:18px;padding:18px 18px">Chiama Matteo</button></div></div><div class="card" id="warehouseCard"><div class="hd"><h2 class="cardTitle">Gestione magazzino</h2><div class="cardTopActions adminOnly"><button type="button" class="miniBtn" data-action="print" data-target="#warehouseCard">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#warehouseCard">Condividi</button></div><div class="badge" id="warehouseBadge"></div></div><div class="bd"><button class="btn" id="btnWarehouseOpen" style="width:100%;display:none">Apri gestione magazzino</button><div style="height:10px"></div><div id="warehouseBody"></div></div></div><div class="payrollCard" id="payrollUserCard"><div class="pcHead"><div><div class="pcTitle">Busta paga</div><div class="pcSub">Consulta le tue buste paga in stile Apple.</div></div><div class="pcBadge" id="payrollUserBadge">Live</div></div><div class="pcBody"><div class="pcActionRow"><button class="payrollBtn primary" id="btnOpenPayrollUser" type="button">Apri buste paga</button><div class="pcHint" id="payrollUserHint">Accesso riservato al tuo profilo.</div></div></div></div><div class="desktopCol sideCol"><div class="adminMobileHeader adminOnly" id="adminMobileHeader"><div class="eyebrow">Hub admin</div><div class="adminMobileTitle">Strumenti amministratore</div><div class="adminMobileSub">Parit contenuti desktop anche su mobile.</div></div><div class="adminMobileStack" id="adminMobileStack"><div class="card introCard adminOnly" id="desktopSummaryCard"><div class="introTop"><div class="eyebrow">Hub admin</div><div class="introTitle">Panoramica operativa</div><div class="introLead">Vista coerente con il layout mobile, dedicata agli amministratori.</div></div><div class="summaryGrid"><div class="summaryTile"><div class="t">Fatturato lordo</div><div class="summaryValue blur" id="fatValue"> </div><div class="muted" id="fatSubtitle">Visibile per gli amministratori su ogni dispositivo.</div></div><div class="summaryTile"><div class="t">Produzione mese</div><div class="summaryValue"><span id="deskMonthKg"></span> kg</div><div class="muted">Ordini conclusi: <span id="deskMonthOrders"></span></div></div><div class="summaryTile"><div class="t">Supporto rapido</div><div class="summaryActions"><button class="btn ghost" id="btnCallMatteo" style="width:100%">Chiama Matteo</button><button class="btn ghost" id="btnOpenStats" style="width:100%">Statistiche</button></div><div class="muted">Interventi, assistenza e apertura dashboard statistiche.</div></div></div></div><div class="payrollCard adminOnly" id="payrollAdminCard"><div class="pcHead"><div><div class="pcTitle">Upload buste paga</div><div class="pcSub">Carica PDF, estrai con Gemini e invia.</div></div><div class="pcBadge">Admin</div></div><div class="pcBody"><div class="pcActionRow"><button class="payrollBtn primary" id="btnOpenPayrollAdmin" type="button">Apri upload</button><button class="payrollBtn secondary" id="btnPayrollReloadUsers" type="button">Reload utenti</button></div><div class="pcHint">Stato: <span id="payrollAdminStatus">Idle</span></div></div></div><div class="mobileAssignInfo" id="mobileAllowInfo">Ordini assegnati: <span id="mobileAllowCount"></span><span id="mobileAllowMsg" style="margin-left:6px;color:var(--muted);font-weight:800"></span></div><div id="mobileSendAnchor" style="display:none" aria-hidden="true"></div><div id="mobileSendCard" class="adminPanel adminOnly" style="display:none"><div class="mobileSendShell"><div class="mobileSendTopbar"><div class="mobileSendHeader"><div class="mobileSendTitleCol"><div class="panelTitle">Invio ordini a mobile</div><div class="mobileStatsLine" aria-live="polite"><span class="statLabel">Totali:</span><b id="mobileAllowTotal"></b><span class="statSep"></span><span class="statLabel">Inviati:</span><b id="mobileAllowSent"></b><span class="statSep"></span><span class="statLabel">Match:</span><b id="mobileAllowMatch"></b></div><div class="panelSub mobileSendSubline" id="mobileAllowUpdate">Aggiornato </div><div class="panelSub" id="mobileAllowUpdatedBy"></div></div><div class="mobileSendStatus"><div class="statusBadge" id="mobileAllowStatus">Salvato</div><div class="saveBadge" id="mobileAllowFeedback">Stato: </div><div class="saveBadge" id="mobileAllowResetStatus">Pronto al reset</div></div></div><div class="mobileSendToolbar"><input id="mobileAllowSearch" class="adminSearch" type="search" placeholder="Cerca cliente, prodotto, numero"><div class="mobileSendToolbarBtns"><button class="btn actionPrimary" id="btnSaveMobileAllow" type="button">Invia</button><button class="btn actionGhost" id="btnResetMobileAllow" type="button">Reset</button></div><div class="microActions"><button class="textAction" id="btnAllowSelectAll" type="button">Seleziona filtrati</button><span class="statSep"></span><button class="textAction" id="btnAllowClear" type="button">Deseleziona filtrati</button></div></div></div><div class="mobileSendBody"><div class="mobileSendListPane"><div class="listHead"><div class="panelSub">Clicca una riga per inviare o rimuovere dallapp mobile.</div></div><div class="adminList rowsScroll" id="mobileSendList"></div></div></div></div></div><div class="card adminOnly" id="actionLogCard" style="display:none"><div class="hd"><h2>Monitoraggio azioni</h2><div class="cardTopActions"><button type="button" class="miniBtn" data-action="print" data-target="#actionLogCard">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#actionLogCard">Condividi</button></div><div class="badge" id="actionLogBadge"></div></div><div class="bd"><div class="muted">Registro eventi operativi: avvii, chiusure, assenze e segnalazioni.</div><div class="logFilterBar"><div class="logField"><div class="logLabel">Utente</div><select id="actionLogFilterUser"></select></div><div class="logField"><div class="logLabel">Tipo</div><select id="actionLogFilterType"></select></div><button class="btn ghost" id="actionLogClear" type="button">Pulisci filtri</button></div><div class="rowsScroll logRows" id="actionLogList"></div><div class="logEmpty" id="actionLogEmpty">Nessuna azione registrata con i filtri correnti.</div></div></div><div class="card adminOnly" id="alertAdminCard" style="display:none"><div class="hd"><h2>Avviso operatori</h2><div class="badge" id="alertAdminStatus"></div></div><div class="bd"><div class="muted">Banner prioritario per gli operatori linea polveri.</div><div style="height:8px"></div><textarea id="alertMessageInput" placeholder="Testo avviso (mostrato agli operatori)" style="width:100%;padding:12px;border-radius:14px;border:1px solid var(--stroke);min-height:90px;font-weight:800"></textarea><div style="height:8px"></div><div class="row2"><input id="alertExpireInput" type="number" min="0" step="1" inputmode="numeric" placeholder="Durata minuti (0 = nessuna scadenza)" style="width:100%;padding:12px;border-radius:14px;border:1px solid var(--stroke);font-weight:900"><button class="btn good" id="btnSendAlert" type="button" style="width:100%">Invia avviso</button><button class="btn bad" id="btnCancelAlert" type="button" style="width:100%;margin-top:8px">Annulla avviso</button></div><div class="muted" id="alertFeedback" style="margin-top:6px"></div><div id="adminLastAlert" class="lastAlertBox" style="display:none"><div class="lastAlertLabel">Ultimo avviso inviato</div><div class="lastAlertText" id="adminLastAlertText"></div></div></div></div><div id="statsCardAnchor" style="display:none" aria-hidden="true"></div><div id="statsProduzione" style="position:relative;top:-6px" aria-hidden="true"></div><div class="card adminOnly" minicard id="statsProdCard"><div class="hd"><h2>Statistiche produzione</h2><div class="badge" id="statsBadge"></div></div><div class="bd"><div class="muted">Classifica live (kg totali e velocit media) per gli amministratori.</div><div style="height:10px"></div><div class="rowsScroll" id="statsBody"><div id="operatorLeaderboard"></div><div id="statsList" class="list"></div></div></div></div></div><div class="card supportCard" id="supportCard"><div class="hd supportHead"><div class="supportTitleCol"><div class="eyebrow">Supporto rapido</div><h2 class="supportTitle">Segnala o pianifica</h2></div><div class="supportBadge">Live</div></div><div class="bd supportBody"><div class="supportIntro"><div class="supportLead">Due bottoni nello stesso riquadro.</div><div class="supportSub">Segnala anomalie o programma unassenza con un tap, stile Apple/Silicon Valley.</div></div><div class="supportActions"><button class="supportBtn accent" id="btnIssueOpen" type="button"><div class="supportBtnIcon"></div><div class="supportBtnText"><div class="label">Segnala un problema</div><div class="hint">Macchine, materiali, anomalie</div></div><span class="supportBtnBadge">Live</span></button><button class="supportBtn neutral" id="btnAbsenceOpen" type="button"><div class="supportBtnIcon"></div><div class="supportBtnText"><div class="label">Programma unassenza</div><div class="hint">Invia la richiesta in 1 tap</div></div><span class="supportBtnBadge">1 tap</span></button></div></div></div><div class="muted" style="text-align:center"> General Copper SRL  Uso interno</div></div></div></div><div id="payrollAdminModal" class="payrollOverlay" role="dialog" aria-modal="true" style="display:none"><div class="payrollSheet"><div class="payrollTop"><div class="payrollTitleWrap"><div class="payrollTitle">Upload buste paga</div><div class="payrollSub">Gemini  Preview  Match  Invia. Apple style.</div><div class="payrollBadgeRow"><span class="payrollPill" id="payrollAdminStepLabel">Idle</span><span class="payrollPill" id="payrollAdminFileLabel">Nessun file</span><span class="payrollPill" id="payrollAdminMatchLabel">Match non avviato</span></div></div><button class="payrollClose" id="payrollAdminClose" aria-label="Chiudi"></button></div><div class="payrollSteps"><div class="payrollPane" id="payrollStepIdle"><div class="payrollGrid"><div><div class="dropArea" id="payrollDrop"><div class="pcTitle" style="font-size:16px">Trascina qui il PDF</div><div class="pcHint">Supporto file singolo o multipagina. Nessun match automatico.</div><input type="file" id="payrollFileInput" accept="application/pdf" style="display:none"><div class="uploadActions"><button class="payrollBtn secondary" id="btnPayrollSelect" type="button">Seleziona PDF</button> <button class="payrollBtn primary" id="btnPayrollUpload" type="button">Upload (Gemini)</button> <button class="payrollBtn" id="btnPayrollReset" type="button">Reset</button></div><div class="miniHint" id="payrollIdleHint">Stato: inattivo.</div></div></div><div class="payrollPane" style="margin:0"><div class="pcTitle" style="font-size:16px">Regole</div><div class="pcHint">Gemini estrae solo testo. Match e invio partono da bottoni manuali.</div><ul class="pcHint" style="padding-left:18px;margin:10px 0 0 0;line-height:1.5"><li>Preview obbligatoria prima del match.</li><li>Match solo su click "Match".</li><li>Invio solo su click "Invia".</li></ul></div></div></div><div class="payrollPane" id="payrollStepExtract" style="display:none;align-items:center;justify-content:center;text-align:center"><div class="pcTitle" style="font-size:18px">Estrazione in corso</div><div class="pcHint">Gemini sta elaborando il PDF. Attendi.</div></div><div class="payrollPane" id="payrollStepPreview" style="display:none"><div class="pcHead" style="padding:0"><div><div class="pcTitle">Risultato estrazione (Gemini)</div><div class="pcSub" id="payrollPreviewMeta">Pagine rilevate.</div></div><div class="pillGroup"><span class="payrollPill" id="payrollPreviewBadge">OK</span></div></div><div class="rowsScroll" style="max-height:360px;overflow:auto"><table class="table" id="payrollPreviewTable"></table></div><div class="pcHint" id="payrollMissingPages" style="display:none">Pagine con campi mancanti: <span id="payrollMissingList"></span></div><div class="pcActionRow"><button class="payrollBtn primary" id="btnPayrollMatch" type="button">Match</button> <button class="payrollBtn secondary" id="btnPayrollRetry" type="button">Riestrai</button> <button class="payrollBtn" id="btnPayrollReset2" type="button">Reset</button></div></div><div class="payrollPane" id="payrollStepMatch" style="display:none"><div class="pcHead" style="padding:0"><div><div class="pcTitle">Match review</div><div class="pcSub">Controlla matchati e non matchati prima di inviare.</div></div><div class="pillGroup"><span class="payrollPill">OK: <span id="payrollMatchOk">0</span></span> <span class="payrollPill">Ambigui: <span id="payrollMatchAmbig">0</span></span> <span class="payrollPill">Non matchati: <span id="payrollMatchNo">0</span></span></div></div><div class="payrollGrid"><div><div class="pcTitle" style="font-size:16px">Matchati per utente</div><div class="payrollList" id="payrollMatchedList"></div></div><div><div class="pcTitle" style="font-size:16px">Non matchati</div><div class="payrollList" id="payrollUnmatchedList"></div></div></div><div class="pcActionRow"><button class="payrollBtn primary" id="btnPayrollSend" type="button">Invia</button> <button class="payrollBtn secondary" id="btnPayrollBackPreview" type="button">Indietro</button> <button class="payrollBtn" id="btnPayrollReset3" type="button">Reset</button></div></div><div class="payrollPane" id="payrollStepSending" style="display:none"><div class="pcTitle">Invio in corso</div><div class="pcHint" id="payrollSendSummary">Preparazione PDF utenti e scrittura Firestore.</div></div></div></div></div><div id="payrollUserModal" class="payrollOverlay" role="dialog" aria-modal="true" style="display:none"><div class="payrollSheet"><div class="payrollTop"><div class="payrollTitleWrap"><div class="payrollTitle" id="payrollUserTitle">Le tue buste paga</div><div class="payrollSub">Seleziona il mese e visualizza i dettagli.</div><div class="payrollBadgeRow"><span class="payrollPill" id="payrollUserMonthBadge"></span><span class="payrollPill" id="payrollUserAmountBadge"></span></div></div><button class="payrollClose" id="payrollUserClose" aria-label="Chiudi"></button></div><div class="payrollPane"><div class="payrollInlineField"><label class="pcSub" for="payrollMonthSelect">Mese</label> <select id="payrollMonthSelect" class="payrollSelect"></select></div><div class="payrollNonAdminCard"><div class="payrollNonAdminHeader"><div><div class="pcTitle" id="payrollUserNet"></div><div class="pcSub" id="payrollUserDocMeta">Documento: </div></div><div class="payrollBadgeSmall" id="payrollUserDate">Aggiornato </div></div><div class="payrollNonAdminActions"><button class="payrollBtn primary" id="btnPayrollPrint" type="button">Stampa</button> <button class="payrollBtn secondary" id="btnPayrollShare" type="button">Condividi</button></div><div class="pcHint">Solo lettura. Nessun upload lato non-admin.</div></div><div style="border:1px solid var(--stroke);border-radius:18px;overflow:hidden;background:rgba(0,0,0,.02);min-height:320px"><iframe id="payrollUserPdfFrame" title="Busta paga" style="width:100%;height:360px;border:0;background:#fff"></iframe></div></div></div></div><div id="whModal" class="modal hidden" role="dialog" aria-modal="true"><div class="modalCard"><div class="modalTop"><div><div class="modalTitle" id="whModalTitle">Dettaglio magazzino</div><div class="modalSub" id="whModalSub"></div><div class="modalCalc" id="whModalCalc" style="display:none"></div></div><button class="modalClose" id="whModalClose" aria-label="Chiudi"></button></div><div class="modalBody" id="whModalBody"></div></div></div><div id="notifModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h">Centro notifiche</div><div class="muted" id="notifSub">Push, messaggi interni e registro.</div></div><button class="x" id="notifClose" aria-label="Chiudi"></button></div><div class="sbd" id="notifBody"><div class="stepTitle">Inbox</div><div class="muted" id="notifStatus">Caricamento notifiche</div><div style="height:8px"></div><div id="notifUnavailable" class="alertBanner" style="display:none"><div class="label">Centro notifiche non disponibile (permessi o connessione).</div><div class="hint">Nessun blocco: lapp continua a funzionare.</div></div><div id="notifList" class="notifList"></div><div class="notifEmpty" id="notifEmpty" style="display:none">Nessuna notifica disponibile.</div><div style="height:12px"></div><div class="row2"><button class="btn ghost" id="btnNotifCompleted" style="width:100%">Registro conclusi</button><button class="btn" id="btnTogglePush" style="width:100%">Gestisci push</button></div><div style="height:12px"></div><div class="row2" id="notifRowOperator" style="display:none"><button class="btn bad" id="btnClearNotifs" style="width:100%">Cancella notifiche</button></div><div style="height:12px"></div><div id="notifAdminBox" style="display:none"><div class="stepTitle">Invia notifica (admin)</div><div class="muted">Messaggio a tutti gli operatori linea polveri (push o inbox). Richiede permessi Firestore.</div><div style="height:8px"></div><input type="text" id="notifTitle" placeholder="Titolo (es. Aggiornamento impianto)" style="width:100%;padding:12px;border-radius:14px;border:1px solid var(--stroke);font-weight:900"><div style="height:8px"></div><textarea id="notifBodyInput" placeholder="Testo notifica" style="width:100%;padding:12px;border-radius:14px;border:1px solid var(--stroke);min-height:90px;font-weight:800"></textarea><div style="height:8px"></div><button class="btn good" id="btnSendNotif" style="width:100%">Invia a tutti</button><div class="muted" id="notifAdminFeedback" style="margin-top:6px"></div></div></div></div></div><div id="histModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet" id="histModalSheet"><div class="shd"><div class="titleCol" id="histModalHeader"><div class="h cardTitle" id="histTitle">Dettaglio produzione</div><div class="sub" id="histSub"></div></div><div class="modalTopActions adminOnly"><button type="button" class="miniBtn" data-action="print" data-target="#histModalSheet">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#histModalSheet">Condividi</button></div><button class="x" id="histClose" aria-label="Chiudi"></button></div><div class="sbd" id="histBody"></div></div></div><div id="toast" class="toast"><div class="tt" id="toastTitle">Attenzione</div><div class="tb" id="toastBody"></div></div><div id="prodModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h" id="prodModalTitle">Produzione</div><div class="selCounter" id="selectionCounter" style="display:none">0 righe selezionate</div></div><button class="x" id="prodModalClose" aria-label="Chiudi"></button></div><div class="sbd"><div class="modalStepWrap" id="prodModalBody"></div></div></div></div><div id="runningModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="h">Produzione in corso</div><button class="x" id="runningClose" aria-label="Chiudi"></button></div><div class="sbd" id="runningBody"></div></div></div><div id="absenceModal" class="overlay absenceOverlay" role="dialog" aria-modal="true" aria-label="Programma un'assenza" style="display:none" data-step="form"><div class="sheet absenceSheet"><div class="absenceTop"><div class="absenceTitleCol"><div class="absenceBreadcrumb" id="absenceBreadcrumb">Step 1 di 2  Compila</div><div class="absenceTitle">Programma un'assenza</div><div class="absenceSub">Inserisci date e motivazione, poi conferma il riepilogo prima dell'invio.</div><div class="absenceUser"> <span id="absUserName">Operatore</span></div></div><div class="absenceStepperDots"><div class="absenceDot" data-step="form" aria-hidden="true"></div><div class="absenceDot" data-step="review" aria-hidden="true"></div><button class="x" id="absenceClose" aria-label="Chiudi"></button></div></div><div class="absenceSteps"><div class="absenceStep isActive" data-step="form" id="absenceFormStep"><div class="absenceGrid"><div class="field" style="margin-bottom:0"><div class="absenceLabel">Da</div><input id="absFrom" type="datetime-local"></div><div class="field" style="margin-bottom:0"><div class="absenceLabel">A</div><input id="absTo" type="datetime-local"></div></div><div class="field" style="margin-top:10px"><div class="absenceLabel">Motivazione</div><textarea id="absReason" placeholder="Es. visita medica, permesso personale, ecc."></textarea></div><div class="absenceHintBox">Rivedi i dati nel passo successivo: potrai ancora modificarli prima dell'invio.</div><div class="absenceActions"><div class="spacer"></div><button class="btn good" id="btnAbsenceNext" style="width:100%;max-width:260px">Vai al riepilogo</button></div></div><div class="absenceStep" data-step="review" id="absenceReviewStep"><div class="absenceReviewCard"><div class="absenceReviewRow"><div class="label">Operatore</div><div class="value" id="absSummaryUser"></div></div><div class="absenceReviewRow"><div class="label">Periodo</div><div class="value"><span id="absSummaryFrom"></span>  <span id="absSummaryTo"></span></div></div><div class="absenceReviewRow"><div class="label">Motivazione</div><div class="value" id="absSummaryReason"></div></div></div><div class="absenceActions"><button class="btn ghost" id="btnAbsenceEdit" type="button" style="flex:1">Modifica dati</button><button class="btn good" id="btnAbsenceSend" style="flex:1">Invia richiesta</button></div></div></div><div id="absFeedback" class="muted absenceFeedback" aria-live="polite"></div></div></div><div id="alertModal" class="overlay" role="dialog" aria-modal="true" aria-label="Avviso operatori" style="display:none"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h">Avviso operatori</div><div class="muted">Messaggio attivo.</div></div><button class="x" id="alertClose" aria-label="Chiudi"></button></div><div class="sbd"><div class="card" style="margin:0"><div class="bd"><div id="alertModalText" style="font-weight:900;white-space:pre-wrap"></div></div></div></div></div></div><div id="warehouseModal" class="overlay" role="dialog" aria-modal="true" aria-label="Gestione magazzino" style="display:none"><div class="sheet whSheet"><div class="whHeader"><div class="whTitleWrap"><div class="eyebrow">Inventory cockpit</div><div class="whTitleRow"><div class="whTitle">Gestione magazzino</div><div class="badge whBadge" id="warehouseBadgeModal"></div></div><div class="whSubtitle">Riepilogo materiali e residui aggiornati live.</div><div class="whChips"><span class="whChip accent">Live sync</span><span class="whChip ghost">Residui</span><span class="whChip good">Disponibile</span></div></div><div class="whToolbar"><button class="whBtn ghost" id="warehouseRefreshBtn" type="button"><span class="icon"></span><span>Aggiorna</span></button><button class="x whClose" id="warehouseClose" aria-label="Chiudi"></button></div></div><div class="whBody"><div class="whGlassCard"><div class="whCardHead"><div><div class="whCardLabel">Dashboard scorte</div><div class="whCardTitle">Panoramica live</div><div class="whCardHint">Filtri, residui e riepiloghi con la stessa struttura del pannello principale.</div></div><div class="whStatus"><span class="dot ok"></span><span class="whStatusText">Attivo</span></div></div><div class="whScroll" id="warehouseModalBody"></div></div></div></div></div><div id="issueModal" class="overlay" role="dialog" aria-modal="true" aria-label="Segnala un problema" style="display:none"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h">Segnala un problema</div><div class="muted">Segnalazione interna. Scrivi chiaro e diretto.</div></div><button class="x" id="issueClose" aria-label="Chiudi"></button></div><div class="sbd"><div class="field"><div class="muted">Dettagli</div><textarea id="issueModalText" placeholder="Es. sacchettatrice bloccata, bobina finita, ordine X in attesa"></textarea></div><div id="issueModalFeedback" class="muted" style="font-weight:900;margin-top:6px"></div><div style="height:10px"></div><button class="btn good" id="btnIssueSendModal" style="width:100%">Invia segnalazione</button></div></div></div><div id="partialModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="h">Ordini parzialmente conclusi</div><button class="x" id="partialClose" aria-label="Chiudi"></button></div><div class="sbd" id="partialBody"></div></div></div><div id="signModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="h">Conclusione  Firma</div><button class="x" id="signClose" aria-label="Chiudi"></button></div><div class="sbd"><div class="stepTitle">Dichiarazione e firma</div><div class="muted" id="signContext"></div><div style="height:10px"></div><div class="muted" style="font-weight:800">Dichiarazione: <b>dichiaro</b> che la produzione  stata eseguita secondo le procedure aziendali e i controlli previsti.</div><div style="height:10px"></div><div style="display:flex;gap:10px;align-items:center"><input id="signCheck" type="checkbox" style="width:20px;height:20px;accent-color:var(--good)"><label for="signCheck" style="font-weight:900">Confermo la dichiarazione</label></div><div style="height:12px"></div><div style="border:1px solid var(--stroke);border-radius:18px;overflow:hidden;background:rgba(0,0,0,.02)"><canvas id="signCanvas" class="signaturePad" style="width:100%;height:220px;display:block"></canvas></div><div style="height:10px"></div><div class="row2"><button class="btn" id="signClear">Pulisci firma</button><button class="btn good" id="signOk">CONCLUDI</button></div></div></div></div><script type="module">const e="https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",t="EASYFATT_XML_CACHE_V1",n="https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js",o="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js",i="https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js",a="https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js",r="https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js",s={apiKey:"AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",authDomain:"tabellone-produzione-liv-e313e.firebaseapp.com",projectId:"tabellone-produzione-liv-e313e",storageBucket:"tabellone-produzione-liv-e313e.firebasestorage.app",messagingSenderId:"537555699968",appId:"1:537555699968:web:4d04cb9596b67bfb0e4be5"},l="PASTE_PUBLIC_VAPID_KEY_HERE",c="hub_auth_ok_ts_v1",d="hub_auth_last_email_v1",u="FATTURATO_EUR_CACHE",m="POLVERI_NOTIF_READ_V1",p="powder_notif_dismissed_v1";let g=null;const f="powderNotifications",b="powderActionLogs";async function h(e,t,n){try{if(!N.firebase.ok)return;const o=N.firebase.api,i=N.firebase.db,a=o.collection(i,"email"),r={subject:e||"Hub Linea Polveri",text:t||""};n&&(r.html=n),await o.addDoc(a,{to:"matteo@generalcoppersrl.com",message:r,createdAt:o.serverTimestamp(),line:"polveri",createdBy:N.user?.fullName||"Sistema"})}catch(e){console.warn("enqueueMatteoEmail error",e)}}const y="hub_config",v="hub_linea_polveri_mobile_allowlist",w="hub_alerts",_="active",S="dismissedAlertId",A="gc_magazzino_filters_v1",T="gc_op_rank_sort_v1",L=new Set(["mast250viri","mast500viri","codmast250viri","codmast500viri"]),C={5:{prodottoKgPerBag:5,bobine:{"Bobina blu f830":{perBag:20,unit:"g"}},etichettePerBag:1,scatole:{"Scatola americana | 20 kg":.25},divisori:{"Divisorio Z":.25},altri:{}},1:{prodottoKgPerBag:1,bobine:{"Bobina blu f480":{perBag:10,unit:"g"}},etichettePerBag:1,scatole:{"Scatola americana | 20 kg":.05},divisori:{"Divisorio Croce texo":.05},altri:{}}},E={defaultByPackKg:C,byCode:{},byName:{"ossicloruro di rame 50%":{packs:C}}};try{"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>e.forEach(e=>e.unregister())).catch(()=>{})}catch(e){}const N={lastAuthErrorMsg:"",xmlModifiedTime:null,lastFetchAt:null,docs:[],fatturatoLordo:null,powderOrders:[],activeProductions:[],history:[],historyReady:!1,globalStats:{ready:!1,data:{concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""},source:"init",error:""},user:null,operator:null,selectedLines:new Map,prodModalOpenedAt:0,startedThisSession:!1,prodModalTouched:!1,firebase:{ok:!1,db:null,api:null,storage:null,storageApi:null},magFilters:function(){try{const e=localStorage.getItem(A),t=e?JSON.parse(e):{},n=t&&"object"==typeof t&&t.orderQuery&&!t.order?{order:t.orderQuery}:{};return{customer:"",order:"",item:"",...t&&"object"==typeof t?t:{},...n}}catch(e){return{customer:"",order:"",item:""}}}(),magazzinoOverview:[],magazzinoDetailLookup:new Map,mobileAllowlist:{ready:!1,keys:new Set,updatedAt:null,updatedBy:"",allowAll:!0,docExists:!1,error:"",lastError:"",lastSyncTs:null,pendingRender:!1},mobileAllowSelection:new Set,mobileAllowDirty:!1,mobileAllowSaveState:"idle",mobileAllowSearchTerm:"",mobileAllowReset:{confirm:!1,status:"idle",lastError:""},notifications:{inbox:[],ready:!1,unavailable:!1,error:""},actionLogs:{entries:[],ready:!1,error:""},payroll:{admin:{step:"idle",files:[],originalPdfBytes:null,sourceFileName:"",sourceFileHash:"",gemini:{loading:!1,error:"",pages:[]},match:{pages:[],grouped:[],unmatched:[],matchedCount:0,ambiguousCount:0,unmatchedCount:0},users:[],loadingUsers:!1,sending:!1,sendSummary:null},userView:{docs:[],ready:!1,error:"",selectedMonth:"",months:[],loading:!1}},notifUnsub:null,push:{supported:!1,permission:"default",token:"",enabled:!1},alerts:{unsub:null,data:null},alertSaving:!1};globalThis.__ALLOW_KEYS__=globalThis.__ALLOW_KEYS__ instanceof Set?globalThis.__ALLOW_KEYS__:new Set,globalThis.__ALLOW_META__=globalThis.__ALLOW_META__||{updatedAt:null,updatedBy:"",lastError:"",lastSyncTs:null},globalThis.__ALLOWLIST_LISTEN_STARTED__=Boolean(globalThis.__ALLOWLIST_LISTEN_STARTED__),globalThis.__ALLOWLIST_CACHE_CLEANED__=Boolean(globalThis.__ALLOWLIST_CACHE_CLEANED__),globalThis.__ALLOW_LOADED__=Boolean(globalThis.__ALLOW_LOADED__),globalThis.__CONCLUDE_INFLIGHT__=globalThis.__CONCLUDE_INFLIGHT__ instanceof Map?globalThis.__CONCLUDE_INFLIGHT__:new Map,globalThis.__CONCLUDE_RECENT__=globalThis.__CONCLUDE_RECENT__ instanceof Map?globalThis.__CONCLUDE_RECENT__:new Map,globalThis.__CONCLUDE_HANDLER_BOUND__=Boolean(globalThis.__CONCLUDE_HANDLER_BOUND__),globalThis.__GLOBAL_STATS__=globalThis.__GLOBAL_STATS__&&"object"==typeof globalThis.__GLOBAL_STATS__?globalThis.__GLOBAL_STATS__:{concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""},globalThis.__GLOBAL_STATS_READY__=Boolean(globalThis.__GLOBAL_STATS_READY__),globalThis.__STATS_CLEAR_TS__=Number(globalThis.__STATS_CLEAR_TS__||0),globalThis.__RESTORE_TIMER__=globalThis.__RESTORE_TIMER__||null,globalThis.__AUTH_LISTENER_BOUND__=Boolean(globalThis.__AUTH_LISTENER_BOUND__),globalThis.__AUTH_RESUME_BOUND__=Boolean(globalThis.__AUTH_RESUME_BOUND__);let x="unknown",$=null,k=[],M=new Set;globalThis.__allowCommitted=globalThis.__allowCommitted instanceof Set?globalThis.__allowCommitted:new Set(Array.from(globalThis.__ALLOW_KEYS__||[])),globalThis.__allowDraft=globalThis.__allowDraft instanceof Set?globalThis.__allowDraft:new Set(globalThis.__allowCommitted),globalThis.__allowDraftDirty=Boolean(globalThis.__allowDraftDirty);const O=["allowKeys","mobileAllowlist","hub_allowlist","mobileSendKeys","assignedOrders"];function D(){N.payroll={admin:{step:"idle",files:[],originalPdfBytes:null,sourceFileName:"",sourceFileHash:"",gemini:{loading:!1,error:"",pages:[]},match:{pages:[],grouped:[],unmatched:[],matchedCount:0,ambiguousCount:0,unmatchedCount:0},users:[],loadingUsers:!1,sending:!1,sendSummary:null},userView:{docs:[],ready:!1,error:"",selectedMonth:"",months:[],loading:!1}}}function B(){if(globalThis.__ALLOWLIST_CACHE_CLEANED__)return;globalThis.__ALLOWLIST_CACHE_CLEANED__=!0;const e=[];try{"undefined"!=typeof localStorage&&e.push(localStorage)}catch(e){}try{"undefined"!=typeof sessionStorage&&e.push(sessionStorage)}catch(e){}for(const t of e)try{for(const e of O)t.removeItem(e)}catch(e){}}B();const I="hub_linea_polveri_global_stats_v1",P="hub_config",z="hub_linea_polveri_global_stats",F="hub_linea_polveri_stats_clear_ts",R="gc_prod_history_reset_ts_v1",K=["powderProdHistory","powderProdHistoryCache","powderProdStats","powderProdStats_v1","powder_stats_cache","powder_stats_history","powder_stats_history_v1","powder_history","prod_history","ordiniConclusi","statsHistory","statsHistoryCache","hub_linea_polveri_history"],H=["powderStats_","powderProdHistory_","powderProdStats_","hub_prod_stats_"],U=e=>document.getElementById(e),q={indicator:U("pillSync"),indicatorText:U("txtSync"),indicatorDot:U("dotSync"),firstRenderDone:!1,inError:!1};let W=!1,j=!1,V=null,G=0,Y=null;function Z(){return new Promise(e=>requestAnimationFrame(()=>e()))}async function Q(e,t,n,o=90){if(!e)return;e.innerHTML="";const i=document.createDocumentFragment();for(let a=0;a<(t?.length||0);a++){i.appendChild(n(t[a],a));(a+1)%o===0&&(e.appendChild(i),await Z())}e.appendChild(i)}function J(e){if(!e)return;const t=e.querySelector(".rowsWrap, .listWrap, .tableWrap, .linesWrap, .ordersTable, .modalRows")||e.querySelector("table")||null;t&&requestAnimationFrame(()=>{t.scrollIntoView({block:"start",inline:"nearest"})})}function X(){return globalThis.__GLOBAL_STATS__&&"object"==typeof globalThis.__GLOBAL_STATS__||(globalThis.__GLOBAL_STATS__={concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""}),N.globalStats||(N.globalStats={ready:!1,data:{concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""},source:"init",error:""}),globalThis.__GLOBAL_STATS__}function ee(e,t="local"){const n={concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:"",...e||{}};return globalThis.__GLOBAL_STATS__=n,globalThis.__GLOBAL_STATS_READY__=!0,N.globalStats={...N.globalStats||{},data:n,ready:!0,source:t,error:""},function(e){try{if("undefined"==typeof localStorage)return;localStorage.setItem(I,JSON.stringify(e))}catch(e){}}(n),n}async function te(){let e={concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""},t="init";const n=function(){try{if("undefined"==typeof localStorage)return null;const e=localStorage.getItem(I);if(!e)return null;const t=JSON.parse(e);if(t&&"object"==typeof t)return t}catch(e){}return null}();if(n&&(e={...e,...n},t="localstorage"),N.firebase?.ok)try{const n=N.firebase.api,o=N.firebase.db,i=await n.getDoc(n.doc(o,P,z));if(i.exists()){const n=i.data()||{};e={...e,concludedCountTotal:Number(n.concludedCountTotal||0),concludedKgTotal:Number(n.concludedKgTotal||0),updatedAt:n.updatedAt||n.concludedAt||n.at||null,updatedBy:n.updatedBy||n.user||""},t="firestore"}}catch(e){console.warn("load global stats failed",e),N.globalStats={...N.globalStats||{},error:String(e?.message||e||"")}}const o=ee(e,t);return No(),o}async function ne(e=0,t=0){const n=X();return async function(e){const t=ee(e,N.globalStats?.source||"local");if(N.firebase?.ok)try{const e=N.firebase.api,n=N.firebase.db;await e.setDoc(e.doc(n,P,z),{concludedCountTotal:Number(t.concludedCountTotal||0),concludedKgTotal:Number(t.concludedKgTotal||0),updatedAt:e.serverTimestamp(),updatedBy:N.user?.email||N.user?.fullName||""},{merge:!0}),N.globalStats={...N.globalStats||{},source:"firestore",error:""}}catch(e){console.warn("persist global stats failed",e),N.globalStats={...N.globalStats||{},error:String(e?.message||e||"")}}return No(),t}({concludedCountTotal:Number(n.concludedCountTotal||0)+Number(e||0),concludedKgTotal:Number(n.concludedKgTotal||0)+Number(t||0),updatedAt:pe(),updatedBy:N.user?.email||N.user?.fullName||""})}function oe(){const e=(e,t=F)=>{try{if(e&&"function"==typeof e.getItem){const n=e.getItem(t);if(null!=n)return n}}catch(e){}return null},t=e(localStorage)??e(sessionStorage)??(null!=globalThis.__STATS_CLEAR_TS__?String(globalThis.__STATS_CLEAR_TS__):null),n=e(localStorage,R)??e(sessionStorage,R),o=Math.max(parseInt(t||"0",10),parseInt(n||"0",10));return Number.isFinite(o)?o:0}function ie(){const e=(N.history||[]).filter(e=>e&&e.operator),t=oe();return t?e.filter(e=>To(e.id||e.at||0)>t):e}function ae(e){const t=[e?.endedAt,e?.startedAt,e?.at];for(const e of t){if(!e)continue;const t=new Date(e);if(Number.isFinite(t.getTime()))return t.getTime()}const n=To(e?.id||e?.at||0);return Number.isFinite(n)?n:null}function re(e){if(null==e)return"";let t=String(e||"").trim();if(!t)return"";if(t.includes("@")){const[e]=t.split("@");e&&(t=e.trim())}return t.replace(/\s+/g,"").trim()}function se(e){const t=[e?.operator,e?.operatorName,e?.user,e?.fullName,e?.displayName,e?.operatorEmail,e?.email,e?.uid,e?.operatorUid];for(const e of t){const t=re(e);if(t)return t}return"Sconosciuto"}function le(){const e=Date.now();!function(e){globalThis.__STATS_CLEAR_TS__=e;try{localStorage?.setItem(F,String(e))}catch(e){}try{sessionStorage?.setItem(F,String(e))}catch(e){}try{localStorage?.setItem(R,String(e))}catch(e){}try{sessionStorage?.setItem(R,String(e))}catch(e){}}(e);const{removedKeys:t,stores:n}=function(){const e=[I,...K],t=["hub_linea_polveri_global_stats_","hub_linea_polveri_stats_",...H],n=[];try{"undefined"!=typeof localStorage&&n.push(localStorage)}catch(e){}try{"undefined"!=typeof sessionStorage&&n.push(sessionStorage)}catch(e){}let o=0;for(const i of n)try{const n=new Set;for(let o=0;o<i.length;o++){const a=i.key(o);a&&a!==R&&(e.includes(a)||t.some(e=>a.startsWith(e)))&&n.add(a)}n.forEach(e=>{try{i.removeItem(e),o+=1}catch(e){}})}catch(e){}return{removedKeys:o,stores:n.length}}();N.history=[],N.historyReady=!0;ee({concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""},"cleared"),No(),Mo();try{Wo()}catch(e){}try{Lo()}catch(e){}const o=document.getElementById("statsClearFeedback");o&&(o.textContent="Dati storici eliminati");try{console.info(`[stats-reset] cleared history caches: ${t} key(s) across ${n} storage(s) @${e}`)}catch(e){}Ve("Dati storici eliminati","Statistiche azzerate su questo dispositivo.")}function ce(e="Aggiornamento",t={}){q.inError="error"===t.kind;const n=q.indicator;n&&(n.style.display="flex",q.indicatorText&&(q.indicatorText.textContent=e||"Aggiornamento"),q.indicatorDot&&(q.indicatorDot.className="dot",q.indicatorDot.classList.add(q.inError?"bad":"warn")))}function de(){const e=q.indicator;e&&(e.style.display="none"),q.inError=!1}function ue(){q.firstRenderDone=!0,q.inError||setTimeout(()=>de(),140)}function me(e){q.inError=!0,ce(e||"Connessione instabile. Riprovo",{kind:"error"})}function pe(){return(new Date).toISOString()}function ge(e){const t=e instanceof Date?e:new Date(e);return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()} ${function(e){const t=e instanceof Date?e:new Date(e);return`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}(t)}`}function fe(){return N.selectedLines instanceof Map||(N.selectedLines=new Map),N.selectedLines}function be(e,t){return`${e?.orderNo||e?.number||""}__${e?.customer||""}__${t?.lineKey||t?.lineID||t?.id||""}`}function he(){return fe().size}function ye(){const e=U("selectionCounter");if(!e)return;const t=he();t>0?(e.style.display="inline-flex",e.innerHTML=`<strong>${t}</strong> righe selezionate`):e.style.display="none"}function ve(e){const t=fe();if(!t.size)return;const n=new Set;for(const t of e||[])for(const e of t.lines||[])e&&"active"!==e.status&&n.add(be(t,e));for(const e of Array.from(t.keys()))n.has(e)||t.delete(e);ye()}function we(e){const t=[],n=String(e?.orderNo||e?.number||""),o=String(e?.customer||"");for(const e of fe().values())String(e.orderNo||e.number||"")===n&&String(e.customer||"")===o&&t.push(e);return t}function _e(e){return(e||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function Se(e){return(e&&e.textContent?e.textContent:"").trim()}function Ae(e){if(Number.isFinite(e))return Number(e);const t=null==e?"":String(e).trim();if(!t)return null;const n=t.replace(/\s+/g,"");let o=n;o=/^-?\d{1,3}(?:\.\d{3})*(?:,\d+)?$/.test(n)||/^-?\d+(?:,\d+)?$/.test(n)?n.replace(/\./g,"").replace(",","."):n.replace(/,/g,"");const i=Number(o);return Number.isFinite(i)?i:null}function Te(e){const t=(null==e?"":String(e)).replace(/\./g,"").replace(",",".").replace(/\s+/g,""),n=Number(t);return Number.isFinite(n)?n:0}function Le(e){const t=U("kPowderKg");if(!t)return;const n=(o=e,Number.isFinite(o)?Math.round(o).toLocaleString("it-IT"):null);var o;t.textContent=null!=n?`${n} kg`:""}function Ce(e,t="kg"){const n=`${e??0}`,o=/\bkg\b/i.test(t||""),i=(t||"").trim();return o?`${n} kg`:i?`${n} ${i}  kg`:`${n} kg`}function Ee(){const e="undefined"!=typeof window&&window.matchMedia?window.matchMedia("(max-width: 640px)"):{matches:!1},t=(navigator.userAgent||navigator.vendor||"").toLowerCase(),n=/\b(android|iphone|ipad|ipod|mobile|iemobile|opera mini)\b/.test(t),o="undefined"!=typeof window&&window.innerWidth<=900;return Boolean(e&&e.matches||n||o)}function Ne(){const e=Boolean(N.user&&N.user.isAdmin);document.body.classList.toggle("role-admin",e),document.body.classList.toggle("role-operator",!e),et()}const xe=["admin","mobilesendcard","desktopsummarycard","notifadminbox"];function $e(){if(!Ee())return;if(Boolean(N.user&&N.user.isAdmin))return;const e=("undefined"!=typeof location&&location.hash||"").toLowerCase();if(!e)return;if(xe.some(t=>e.includes(t))){Ve("Sezione disponibile solo per admin","Sezione disponibile solo per admin");try{history.replaceState(null,document.title,location.pathname+location.search)}catch(e){}try{const e=document.querySelector(".wrap")||document.body;e&&"function"==typeof e.scrollIntoView?e.scrollIntoView({behavior:"smooth",block:"start"}):window.scrollTo({top:0,behavior:"smooth"})}catch(e){try{window.scrollTo({top:0,behavior:"smooth"})}catch(e){}}}}let ke=!1;function Me(){const e=document.querySelector("header")||document.querySelector(".header")||null,t=e?e.getBoundingClientRect().height:64;document.documentElement.style.setProperty("--hdrH",`${t}px`)}function Oe(){if(!Ee())return;const e=globalThis.__MOBILE_AUDIO__;if(!e.unlocked)try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return;e.ctx=e.ctx||new t,"suspended"===e.ctx.state&&e.ctx.resume(),e.unlocked=!0}catch(e){}}function De(e){if(!Ee())return;const t=globalThis.__MOBILE_AUDIO__,n=Date.now();if(!(n-t.lastBeepAt<6500))if(t.lastBeepAt=n,navigator.vibrate&&navigator.vibrate("partial"===e?[40,40,60]:[30,30,30]),t.unlocked&&t.ctx)try{const n=t.ctx,o=n.createOscillator(),i=n.createGain();o.type="sine";const a=n.currentTime,r=1e-4;i.gain.setValueAtTime(r,a),i.gain.exponentialRampToValueAtTime(.18,a+.02),i.gain.exponentialRampToValueAtTime(r,a+.18),o.frequency.setValueAtTime("partial"===e?880:740,a),"partial"===e&&(i.gain.setValueAtTime(r,a+.2),i.gain.exponentialRampToValueAtTime(.16,a+.22),i.gain.exponentialRampToValueAtTime(r,a+.36)),o.connect(i),i.connect(n.destination),o.start(a),o.stop(a+("partial"===e?.4:.2))}catch(e){}else t.toastShown||(t.toastShown=!0,Ve("Audio attivo dopo il primo tap","Tocca una volta per abilitare il trillo.",2e3),setTimeout(()=>{t.toastShown=!1},4e3))}function Be(){const e=U("mobileSendCard"),t=U("mobileSendAnchor"),n=e?.parentElement;if(!e||!t||!n)return;if(Boolean(N.user&&N.user.isAdmin&&!Ee()&&"undefined"!=typeof window&&window.innerWidth>=1025)){const t=n.firstElementChild;t!==e&&n.insertBefore(e,t||null)}else{const n=t.parentElement;n&&e.previousElementSibling!==t&&n.insertBefore(e,t.nextElementSibling)}}function Ie(){const e=U("warehouseCard"),t=U("warehouseAnchor"),n=U("opsCard"),o=n?.parentElement;if(!(e&&t&&n&&o))return;const i=Ee();if(document.body.classList.contains("adminDeskLayout")&&!Ee()&&"undefined"!=typeof window&&window.innerWidth>=1025||i){const t=n.nextSibling;e.parentElement===o&&e.previousElementSibling===n||o.insertBefore(e,t)}else{const n=t.parentElement;n&&e.parentElement!==n&&n.insertBefore(e,t.nextElementSibling)}}function Pe(){const e=U("completedCard"),t=document.querySelector(".desktopCol.mainCol"),n=document.querySelector(".desktopCol.sideCol");if(!e||!t||!n)return;N._completedHome||(N._completedHome={parent:e.parentElement,next:e.nextElementSibling});const o=Boolean(N.user&&N.user.isAdmin),i="undefined"!=typeof window&&window.innerWidth>=1025;if(o&&!Ee()&&i)e.parentElement===n&&e===n.firstElementChild||n.insertBefore(e,n.firstElementChild);else{const n=N._completedHome,o=n?.parent||t,i=n?.next||null;i&&i.parentElement===o?e.parentElement===o&&e.nextElementSibling===i||o.insertBefore(e,i):e.parentElement!==o&&o.appendChild(e)}}function ze(){document.body.classList.remove("desktopAsMobile")}globalThis.__MOBILE_AUDIO__=globalThis.__MOBILE_AUDIO__||{unlocked:!1,ctx:null,lastBeepAt:0,toastShown:!1},globalThis.__MOBILE_EVENTS__=globalThis.__MOBILE_EVENTS__||{prevPartialCount:null,prevProdKey:null,prevAlertKey:null},window.addEventListener("pointerdown",Oe,{once:!0,passive:!0}),window.addEventListener("touchstart",Oe,{once:!0,passive:!0});const Fe=(()=>{let e=null;return()=>{clearTimeout(e),e=setTimeout(()=>ze(),150)}})();function Re(){const e=Boolean(N.user&&N.user.isAdmin),t=Boolean(e&&!Ee()&&function(){const e="undefined"!=typeof window&&window.innerWidth>=1200,t=!!vt&&vt.matches;return Boolean(e||t)}());document.body.classList.toggle("kioskAdmin",t),function(){const e=Boolean(N.user&&N.user.isAdmin),t="undefined"!=typeof window&&window.innerWidth>=1025;if(!e||Ee()||!t)return document.body.classList.remove("adminDeskLayout"),Be(),Ie(),void Pe();document.body.classList.add("adminDeskLayout"),Be(),Ie(),Pe()}()}function Ke(){const e=!Ee()&&window.innerWidth>=1025;document.body.classList.toggle("desktopV2",e)}const He=function(e,t=150){let n=null;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e(...o),t)}}(()=>{Me(),Ke()},150);function Ue(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t+e.charCodeAt(n),t|=0;return Math.abs(t>>>0).toString(36)}function qe(e){return(null==e?"":String(e)).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9_.\-\s]/g,"").replace(/\s+/g,"").trim()}function We(e){if(!e)return"o_unknown";const t=e.orderNo||e.number||e.docNumber||e.id||e.orderId||e.numero;if(t){return`o_${Ue(qe(t)||String(t))}`}const n=Array.isArray(e.lines)&&e.lines.length?e.lines[0]:{};return`o_${Ue([qe(e.customer||e.cliente||""),qe(n.desc||n.code||""),qe(`${n.qty??""} ${n.um||n.uom||""}`),qe(e.conclusion||e.date||e.deliveryDate||"")].filter(Boolean).join("|")||"ordine")}`}function je(e){if(!e)return"o_unknown";if(e.__k)return e.__k;const t=We(e);try{Object.defineProperty(e,"__k",{value:t,writable:!1,enumerable:!1})}catch(n){e.__k=t}return t}function Ve(e,t,n=3800){U("toastTitle").textContent=e,U("toastBody").textContent=t,U("toast").classList.add("show"),setTimeout(()=>U("toast").classList.remove("show"),n)}function Ge(e){document.documentElement.style.setProperty("--banner-offset",`${e||0}px`)}function Ye(){const e=U("cancelBanner");e&&(e.classList.remove("show"),Ge(0))}function Ze(e,t){return e.doc(t,w,_)}function Qe(e){const t=e?.exists?.()&&e.data()||{},n=(t?.message||"").trim(),o=function(e){if(!e)return 0;if("function"==typeof e.toDate)try{const t=e.toDate(),n=t?.getTime?.();return Number.isFinite(n)?n:0}catch(e){}if(e instanceof Date){const t=e.getTime();return Number.isFinite(t)?t:0}const t=Number(e);return Number.isFinite(t)?t:0}(t?.expiresAt);return{ok:Boolean(n&&(!o||Date.now()<o)),message:n,id:t?.id??"",expiresAt:o,raw:t}}function Je(){const e=U("topAlertBanner"),t=U("topAlertSpacer");if(t&&t.isConnected&&e){const n=e.getBoundingClientRect().height||0;return t.style.height=`${n}px`,void Ge(n)}const n=U("cancelBanner");if(n&&n.classList.contains("show")){return void Ge(n.getBoundingClientRect().height||0)}Ge(0)}function Xe(){const e=U("topAlertBanner");e&&e.remove();const t=U("topAlertSpacer");t&&t.remove(),Je()}function et(){const e=U("alertAdminCard"),t=U("alertAdminStatus"),n=Boolean(N.user&&N.user.isAdmin),o=N.alerts?.data||null,i=Boolean(n&&o&&o.ok);e&&(e.style.display=n?"block":"none"),t&&(t.textContent=i?"Avviso attivo":"Nessun avviso"),function(e){const t=U("adminLastAlert"),n=U("adminLastAlertText"),o=Boolean(N.user&&N.user.isAdmin);t&&n&&(o&&e?(t.style.display="block",n.textContent=e):(t.style.display="none",n.textContent=""))}(i&&o?.message||"")}function tt(e,t){const{banner:n,text:o,closeBtn:i}=function(){let e=U("topAlertBanner"),t=U("topAlertText"),n=U("topAlertClose");if(!e){e=document.createElement("div"),e.id="topAlertBanner",t=document.createElement("div"),t.className="topAlertText",t.id="topAlertText";const o=document.createElement("div");o.className="topAlertTrack",o.id="topAlertTrack";const i=document.createElement("span");i.className="topAlertMsg",i.id="topAlertMsgA";const a=document.createElement("span");a.className="topAlertMsg",a.id="topAlertMsgB",a.setAttribute("aria-hidden","true"),o.appendChild(i),o.appendChild(a),t.appendChild(o),n=document.createElement("button"),n.id="topAlertClose",n.type="button",n.className="topAlertClose",n.textContent="Chiudi";const r=document.createElement("div");r.className="topAlertOpen",r.id="topAlertOpen",r.textContent="Apri",r.addEventListener("click",e=>{e.stopPropagation(),ni()}),e.addEventListener("click",e=>{e&&e.target&&"topAlertClose"===e.target.id||ni()}),e.appendChild(t),e.appendChild(r),e.appendChild(n),document.body.appendChild(e)}let o=U("topAlertSpacer");o||(o=document.createElement("div"),o.id="topAlertSpacer");const i=document.querySelector(".wrap"),a=i?.querySelector("header.headerRow");return i&&a?o.parentElement===i&&o.nextElementSibling===a||i.insertBefore(o,a):o.parentElement||document.body.insertBefore(o,document.body.firstChild),{banner:e,text:t,closeBtn:n,spacer:o}}();n.dataset.alertId=String(t??"");const a=o?.querySelector?.("#topAlertMsgA"),r=o?.querySelector?.("#topAlertMsgB");a&&(a.textContent=e||""),r&&(r.textContent=e||"");const s=Boolean(N.user&&N.user.isAdmin);i&&(i.style.display=s?"":"none",i.disabled=!s,i.onclick=s?()=>function(e){(function(e){const t=String(e??"");if(t)try{localStorage.setItem(S,t)}catch(e){}})(e),Xe()}(t):null),n.classList.add("show"),Je(),requestAnimationFrame(()=>Je())}function nt(e){const t=Qe(e);N.alerts.data=t,et();if(Boolean(N.user&&N.user.isAdmin))return void Xe();const n=function(e){const t=String(e??"");if(!t)return!1;try{return localStorage.getItem(S)===t}catch(e){return!1}}(t.id);t.ok&&!n?tt(t.message,t.id):Xe()}let ot=0;function it(){ot=window.scrollY||0,document.body.classList.add("noscroll"),document.body.style.top=`-${ot}px`,document.body.style.position="fixed",document.body.style.width="100%"}function at(){document.body.classList.remove("noscroll"),document.body.style.position="",document.body.style.top="",document.body.style.width="",window.scrollTo(0,ot)}const rt=U("bootFill"),st=U("bootMsg");let lt=0;function ct(e,t){lt=Math.max(lt,Math.min(100,e)),rt.style.width=lt.toFixed(0)+"%",t&&(st.textContent=t)}async function dt(){if(globalThis.__BOOT_DONE__){const e=U("startup");return void(e&&(e.style.display="none"))}globalThis.__BOOT_DONE__=!0,ct(10,"AVVIO: inizializzazione interfaccia"),await new Promise(e=>setTimeout(e,220)),ct(25,"DOWNLOAD: ordini in corso");const e=$t(!0,"boot");ct(45,"SYNC: produzione in corso");const t=async function(){try{const e=5500,t=new Promise((t,n)=>setTimeout(()=>n(new Error("firebase timeout")),e)),l=(async()=>{const{initializeApp:e}=await import(n),t=await import(o),l=await import(i),c=await import(a),d=await import(r);try{t.setLogLevel&&t.setLogLevel("error")}catch(e){}const u=e(s),m=t.initializeFirestore(u,{experimentalAutoDetectLongPolling:!0,useFetchStreams:!1}),p=l.getStorage(u,s.storageBucket),g=c.getAuth(u);let f=null;try{await c.setPersistence(g,c.browserLocalPersistence)}catch(e){}N.firebase.ok=!0,N.firebase.db=m,N.firebase.api=t,N.firebase.storage=p,N.firebase.storageApi=l,N.firebase.authApi=c,N.firebase.auth=g,N.firebase.msgApi=d;try{N.push.supported=await d.isSupported()}catch(e){N.push.supported=!1}if(N.push.supported)try{f=d.getMessaging(u)}catch(e){f=null}N.firebase.messaging=f})();await Promise.race([l,t]),await async function(){const e=N.firebase.authApi,t=N.firebase.auth;Yt();try{await e.getRedirectResult(t)}catch(e){console.warn("getRedirectResult error",e),N.lastAuthErrorMsg=Bt(e)}if(globalThis.__AUTH_LISTENER_BOUND__)return;globalThis.__AUTH_LISTENER_BOUND__=!0,e.onAuthStateChanged(t,async e=>{if(jt(),e||rn(),!e){const e=N.lastAuthErrorMsg||"";return N.lastAuthErrorMsg="",Ee()&&Ft()?(Gt("Ripristino sessione"),void Vt(()=>cn(e))):void cn(e)}Kt("signed_in"),Ht(),Wt(),qt(),function(e=""){try{localStorage.setItem(c,String(Date.now())),e&&localStorage.setItem(d,String(e))}catch(e){}}(e.email||"");let t=await async function(e){if(!N.firebase.ok)return null;const t=N.firebase.api,n=N.firebase.db,o=t.doc(n,It,e),i=await t.getDoc(o);return i.exists()?i.data()||{}:null}(e.uid);if(t){if(!t.fullName){const n=(e.displayName||"").trim();t.fullName=n||e.email||"",await Qt(e,{fullName:t.fullName,email:e.email||""})}}else{t={fullName:(e.displayName||"").trim()||e.email||"",email:e.email||""},await Qt(e,t)}const n=await async function(e){const t=String(e||"").trim().toLowerCase();if(!t)return null;if(!N.firebase.ok)return null;const n=N.firebase.api,o=N.firebase.db,i=n.doc(o,It,t),a=await n.getDoc(i);return a.exists()&&a.data()||null}(e.email||"");if(!n||!1===n.enabled)return Rt(),ln(),void function(e,t=""){Kt("signed_out"),qt(),Pt();U("authBody").innerHTML=`\n      <div class="stepTitle">Accesso non abilitato</div>\n      <div class="muted">Questa email non risulta autorizzata ad accedere allhub.</div>\n      <div style="height:10px"></div>\n      <div class="pill" style="display:inline-block;background:#fff3f2;color:#8a1f1a;border:1px solid #ffd1cd;">${Ao(e||"")}</div>\n      ${t?`<div style="height:10px"></div><div class="muted">${Ao(t)}</div>`:""}\n      <div style="height:14px"></div>\n      <button id="btnLogout" class="btn bad" type="button">Esci</button>\n      <div style="height:8px"></div>\n      <div class="muted">Se serve, chiedi allamministrazione di abilitare la tua email.</div>\n    `,U("btnLogout").onclick=async()=>{try{await N.firebase.authApi.signOut(N.firebase.auth)}catch(e){}Zt("")}}(e.email||"",n&&!1===n.enabled?"Accesso disabilitato.":"Email non presente in elenco autorizzati.");n&&n.displayName&&(t.fullName=n.displayName),N.user={uid:e.uid,fullName:t.fullName,email:e.email||t.email||"",isAdmin:Boolean(n&&n.isAdmin)},N.operator=N.user.fullName,U("hdrUser").textContent=N.user.fullName;try{await async function(){try{if(!N.firebase?.ok)return;const e=N.user?.uid||N.user?.email||"";if(!e)return;const t=`gc_action_open_session_v1:${e}`;if(sessionStorage.getItem(t))return;sessionStorage.setItem(t,"1"),await pn({type:"open",action:"Apertura app",description:"Accesso Hub Linea Polveri",meta:Ee()?"mobile":"desktop"})}catch(e){}}()}catch(e){}Ne(),$e(),ke||(window.addEventListener("hashchange",$e),ke=!0);try{await te()}catch(e){ee(X(),N.globalStats?.source||"local")}Wo(),Re();try{await async function(){if(!N.firebase.ok)return;const e=N.firebase.api,t=N.firebase.db;if(N.notifUnsub){try{N.notifUnsub()}catch(e){}N.notifUnsub=null}try{const n=e.query(e.collection(t,f),e.orderBy("createdAt","desc"),e.limit(40));N.notifications.ready=!1,N.notifications.unavailable=!1,N.notifUnsub=e.onSnapshot(n,e=>{const t=[];e.forEach(e=>t.push({id:e.id,...e.data()})),N.notifications.inbox=t,N.notifications.ready=!0,N.notifications.unavailable=!1,Jo(),Qo()},e=>{console.warn("notif snapshot err",e),N.notifications.unavailable=!0,N.notifications.ready=!0,N.notifications.error=e?.code||String(e),Jo()})}catch(e){console.warn("init notifications failed",e),N.notifications.unavailable=!0,N.notifications.ready=!0,N.notifications.error=e?.code||String(e),Jo()}}()}catch(e){N.notifications.unavailable=!0,Jo()}Jo(),Mi();try{await async function(){D(),Di("idle"),Bi(),Oi(),await Fi(),N.user?.isAdmin&&await zi()}()}catch(e){Oi()}zt(),qt(),Eo(),async function(){if(globalThis.__ALLOWLIST_LISTEN_STARTED__)return;if(!N.firebase.ok)return;const e=N.firebase.api,t=N.firebase.db;if(!e||!t)return;globalThis.__ALLOWLIST_LISTEN_STARTED__=!0;try{const n=gn(e,t);An=e.onSnapshot(n,e=>{const t=e.exists()&&e.data()||{},n=Array.isArray(t.keys)?t.keys.filter(Boolean).map(String):[],o=new Set(n);globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set(n),globalThis.__allowCommitted=new Set(n),globalThis.__allowDraftDirty||(globalThis.__allowDraft=new Set(o)),globalThis.__ALLOW_META__={updatedAt:t.updatedAt||null,updatedBy:t.updatedBy||"",lastError:"",lastSyncTs:Date.now()},N.mobileAllowlist={ready:!0,keys:o,updatedAt:t.updatedAt||null,updatedBy:t.updatedBy||"",allowAll:Boolean(t.allowAll)&&e.exists(),docExists:e.exists(),error:"",lastError:"",lastSyncTs:Date.now(),pendingRender:!1},N.mobileAllowSelection=new Set(globalThis.__allowDraft),hn(),N.mobileAllowSaveState="idle",_n()},e=>{console.warn("allowlist snapshot error",e);const t=e?.code||"",n=e?.message||String(e);globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set,globalThis.__allowCommitted=new Set,globalThis.__allowDraftDirty||(globalThis.__allowDraft=new Set),globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:t?`${t}: ${n}`:n,lastSyncTs:Date.now()},N.mobileAllowlist.error=t||n,N.mobileAllowlist.lastError=t||n,N.mobileAllowlist.lastSyncTs=Date.now(),N.mobileAllowlist.ready=!0,N.mobileAllowlist.keys=new Set,N.mobileAllowlist.docExists=!1,N.mobileAllowlist.allowAll=!1,N.mobileAllowSelection=new Set,N.mobileAllowDirty=!1,N.mobileAllowSaveState="error",Eo()})}catch(e){console.warn("allowlist listen failed",e);const t=e?.code||"",n=e?.message||String(e);globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set,globalThis.__allowCommitted=new Set,globalThis.__allowDraftDirty||(globalThis.__allowDraft=new Set),globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:t?`${t}: ${n}`:n,lastSyncTs:Date.now()},N.mobileAllowlist.error=t||n,N.mobileAllowlist.lastError=t||n,N.mobileAllowlist.lastSyncTs=Date.now(),N.mobileAllowlist.ready=!0,N.mobileAllowlist.keys=new Set,N.mobileAllowlist.docExists=!1,N.mobileAllowlist.allowAll=!1,N.mobileAllowSelection=new Set,N.mobileAllowDirty=!1,N.mobileAllowSaveState="error"}}(),function(){if(!N.firebase.ok||!N.user||!N.user.isAdmin)return void Tn();if(wn)return;const e=N.firebase.api,t=N.firebase.db;if(!e||!t)return;const n=(o,i=!1)=>{try{const a=e.query(e.collection(t,b),e.orderBy(o,"desc"),e.limit(200));N.actionLogs.ready=!1,N.actionLogs.error="",wn=e.onSnapshot(a,e=>{const t=[];e.forEach(e=>{const n=e.data()||{};let o=0;if("number"==typeof n.ts&&Number.isFinite(n.ts)&&(o=n.ts),!o){const e=n.createdAt||n.at;try{const t=e&&"function"==typeof e.toDate?e.toDate():e?new Date(e):null;t&&Number.isFinite(t.getTime())&&(o=t.getTime())}catch(e){}o||(o=Date.now())}t.push({id:e.id,...n,ts:o})}),t.sort((e,t)=>(t.ts||0)-(e.ts||0)),N.actionLogs.entries=t,N.actionLogs.ready=!0,N.actionLogs.error="",ko()},e=>{if(console.warn("action log snapshot err",e),!i&&"createdAt"!==o){try{wn&&wn()}catch(e){}return wn=null,void n("createdAt",!0)}N.actionLogs.error="Registro non disponibile",N.actionLogs.ready=!0,ko()})}catch(e){console.warn("ensureActionLogListener error",e),N.actionLogs.error="Registro non disponibile",N.actionLogs.ready=!0,ko()}};n("ts",!1)}(),sn()})}(),function(){if(an)return;function e(e){const t=U("absenceModal");t&&t.setAttribute("data-step",e),document.querySelectorAll("#absenceModal .absenceStep").forEach(t=>{const n=t.dataset.step===e;t.classList.toggle("isActive",n)});const n=U("absenceBreadcrumb");n&&(n.textContent="form"===e?"Step 1 di 2  Compila":"Step 2 di 2  Conferma")}function t(){const e=N.user?.fullName||N.user?.email||"Operatore",t=(U("absFrom")?.value||"").trim()||"",n=(U("absTo")?.value||"").trim()||"",o=(U("absReason")?.value||"").trim()||"";try{U("absSummaryUser").textContent=e}catch(e){}try{U("absSummaryFrom").textContent=t}catch(e){}try{U("absSummaryTo").textContent=n}catch(e){}try{U("absSummaryReason").textContent=o}catch(e){}try{U("absUserName").textContent=e}catch(e){}}function n(){const e=U("absFeedback"),t=(U("absFrom")?.value||"").trim(),n=(U("absTo")?.value||"").trim(),o=(U("absReason")?.value||"").trim();return e&&(e.textContent=""),t&&n?t>n?(e&&(e.textContent="Le date non tornano: 'Da' deve essere prima o uguale ad 'A'."),null):!o||o.length<3?(e&&(e.textContent="Inserisci una motivazione (minimo 3 caratteri)."),null):{from:t,to:n,reason:o,fb:e}:(e&&(e.textContent="Seleziona sia 'Da' che 'A'."),null)}function o(){const n=U("absenceModal");if(!n)return;if(Boolean(N.user&&N.user.isAdmin))return;if(!Ee())return;e("form"),n.style.display="block",n.classList.add("show"),it();try{const e=new Date,t=e=>String(e).padStart(2,"0"),n=`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())}`,o=U("absFrom"),i=U("absTo");o&&!o.value&&(o.value=n),i&&!i.value&&(i.value=n)}catch(e){}t();const o=U("absFeedback");o&&(o.textContent="")}function i(){const t=U("absenceModal");t&&(t.classList.remove("show"),t.style.display="none",at(),e("form"))}an=!0;try{U("btnAbsenceOpen")?.addEventListener("click",o),U("absenceClose")?.addEventListener("click",i),U("absenceModal")?.addEventListener("click",e=>{e.target&&"absenceModal"===e.target.id&&i()}),U("btnAbsenceNext")?.addEventListener("click",()=>{const o=n();if(o){t(),e("review"),o.fb&&(o.fb.textContent="Controlla il riepilogo e premi Invia richiesta.");try{U("btnAbsenceSend")?.focus()}catch(e){}}}),U("btnAbsenceEdit")?.addEventListener("click",()=>{e("form");const t=U("absFeedback");t&&(t.textContent="Puoi modificare i dati prima di inviare.")}),U("btnAbsenceSend")?.addEventListener("click",async()=>{const o=n();if(!o)return;const{from:a,to:r,reason:s,fb:l}=o;t(),e("review");try{U("btnAbsenceSend").disabled=!0,l&&(l.textContent="Invio richiesta");const e={type:"absence_request",line:"polveri",from:a,to:r,reason:s};await async function(e){if(!N.firebase.ok)throw new Error("Firebase non disponibile");const t=N.firebase.api,n=N.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`,i={...e,id:o,at:pe(),createdAt:t.serverTimestamp(),createdBy:N.user?.fullName||"",createdByUid:N.user?.uid||"",createdByEmail:N.user?.email||""};return await t.setDoc(t.doc(n,"powderAbsenceRequests",o),i),i}(e);try{await pn({type:"absence",action:"Programmazione assenza",description:`Da ${a} a ${r}`,meta:s})}catch(e){}try{const e=`Richiesta assenza  ${N.user?.fullName||"Operatore"}`,t=`Da: ${a}  A: ${r}\nMotivo: ${s}`;await Xo(e,t)}catch(e){console.warn("absence notif failed (permissions?)",e);try{await Cn({customer:"ASSENZA",orderNo:"",text:`Richiesta assenza  ${N.user?.fullName||""}\nDa: ${a}  A: ${r}\nMotivo: ${s}`})}catch(e){}}l&&(l.textContent="Richiesta inviata "),Ve("Richiesta inviata","Ok  lamministrazione la vedr nelle notifiche.");try{U("absReason").value=""}catch(e){}setTimeout(()=>i(),450)}catch(e){console.warn("absence send error",e),l&&(l.textContent="Invio non riuscito (connessione o permessi)."),Ve("Invio non riuscito","Controlla connessione o permessi Firebase.")}finally{try{U("btnAbsenceSend").disabled=!1}catch(e){}}})}catch(e){}function a(){Boolean(N.user&&N.user.isAdmin);const e=U("issueModal");if(e){e.style.display="block",e.classList.add("show"),it();try{U("issueModalFeedback").textContent=""}catch(e){}try{U("issueModalText").focus()}catch(e){}}}function r(){const e=U("issueModal");e&&(e.classList.remove("show"),e.style.display="none",at())}function s(){const e=U("warehouseModal"),t=U("warehouseModalBody"),n=U("warehouseBadgeModal");if(e&&t&&n){try{Po(!0)}catch(e){}e.style.display="flex",e.classList.add("show"),it()}}function l(){const e=U("warehouseModal");e&&(e.classList.remove("show"),e.style.display="none",at())}try{U("btnIssueOpen")?.addEventListener("click",a),U("issueClose")?.addEventListener("click",r),U("issueModal")?.addEventListener("click",e=>{e.target===U("issueModal")&&r()}),U("btnIssueSendModal")?.addEventListener("click",async()=>{const e=U("issueModalFeedback"),t=(U("issueModalText")?.value||"").trim();if(e&&(e.textContent=""),!t||t.length<3)e&&(e.textContent="Scrivi almeno 3 caratteri.");else try{U("btnIssueSendModal").disabled=!0,e&&(e.textContent="Invio"),await Cn({text:t,message:t,line:"polveri"}),Ve("Segnalazione inviata","Grazie. La segnalazione  stata registrata.");try{U("issueModalText").value=""}catch(e){}e&&(e.textContent="Inviata "),setTimeout(()=>r(),420)}catch(t){console.warn("issue send modal error",t),e&&(e.textContent="Invio non riuscito (connessione o permessi)."),Ve("Invio non riuscito","Controlla connessione o permessi Firebase.")}finally{try{U("btnIssueSendModal").disabled=!1}catch(e){}}})}catch(e){}try{U("btnWarehouseOpen")?.addEventListener("click",s),U("warehouseClose")?.addEventListener("click",l),U("warehouseModal")?.addEventListener("click",e=>{e.target===U("warehouseModal")&&l()})}catch(e){}try{U("warehouseRefreshBtn")?.addEventListener("click",()=>{const e=U("warehouseRefreshBtn");e&&(e.classList.add("isBusy"),e.disabled=!0);try{Po(!0)}catch(e){}setTimeout(()=>{e&&(e.classList.remove("isBusy"),e.disabled=!1)},480)})}catch(e){}try{U("btnClearNotifs")?.addEventListener("click",()=>{!function(){const e=Go(),t=Yo().map(e=>e.id).filter(Boolean);let n=!1;for(const o of t)o&&!e.has(o)&&(e.add(o),n=!0);n&&function(e){try{localStorage.setItem(p,JSON.stringify(Array.from(e||[])))}catch(e){}g=e instanceof Set?e:new Set}(e);Zo(t),Qo(),Jo()}(),Ve("Notifiche cancellate","Pulite solo su questo dispositivo.")})}catch(e){}try{U("alertClose")?.addEventListener("click",oi),U("alertModal")?.addEventListener("click",e=>{e.target===U("alertModal")&&oi()}),U("topAlertBanner")?.addEventListener("click",e=>{e&&"topAlertClose"===e.target?.id||ni()}),U("topAlertOpen")?.addEventListener("click",e=>{e?.stopPropagation?.(),ni()})}catch(e){}document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?rn():(on&&clearTimeout(on),on=setTimeout(()=>{on=null,sn()},300))}),window.addEventListener("online",()=>{en=1500,sn()}),window.addEventListener("offline",()=>{rn()})}(),sn()}catch(e){console.warn("Firebase init failed:",e),N.firebase.ok=!1,N.notifications.unavailable=!0,Jo(),Qo(),Eo(),Zt("Connessione Firebase non disponibile. Verifica rete o contatta il responsabile.")}}();await Promise.race([e,new Promise(e=>setTimeout(e,3200))]),ct(80,"OTTIMIZZAZIONE: finalizzazione"),await Promise.race([t,new Promise(e=>setTimeout(e,1200))]),ct(100,"OK: pronto"),await new Promise(e=>setTimeout(e,140)),U("startup").style.display="none",Ve("Operativit","Per avviare un ordine: VAI IN PRODUZIONE  scegli operatore  seleziona righe  INIZIA PRODUZIONE.")}function ut(e,t={}){const n=Number(e);if(!Number.isFinite(n))return null;const o=[.5,1,5,10];for(const e of o)if(Math.abs(n-e)<.011)return e;return t.strict?null:n>0?n:null}function mt(e){const t=_e(e||"").replace(/,/g,".");if(!t)return null;const n=[{kg:10,re:/\b10\s?kg\b|\bsacco\s?10\b|\bsacchi\s?da\s?10\b/},{kg:5,re:/\b5\s?kg\b|\bsacco\s?5\b|\bsacchi\s?da\s?5\b/},{kg:1,re:/\b1\s?kg\b|\bsacchetto\s?1\b|\bsacchetti\s?da\s?1\b/},{kg:.5,re:/\b0[.,]5\s?kg\b|\b500\s?g\b|\b0[.,]5kg\b|\bsacchetto\s?500\b/}];for(const{kg:e,re:o}of n)if(o.test(t))return e;const o=t.match(/(\d+(?:\.\d+)?)[x\-\s]*kg\b/);if(o){const e=ut(parseFloat(o[1]));if(null!=e)return e}const i=t.match(/\bkg[x\-\s]*(\d+(?:\.\d+)?)/);if(i){const e=ut(parseFloat(i[1]));if(null!=e)return e}const a=t.match(/(\d+(?:\.\d+)?)[x\-\s]*(?:gr|g|grammi)\b/);if(a){const e=ut(parseFloat(a[1])/1e3);if(null!=e)return e}const r=t.match(/\b(sacchi|sacchetti|sacco|sacchetto)\s*(?:da\s*)?(\d+(?:\.\d+)?)/);if(r){const e=ut(parseFloat(r[2]));if(null!=e)return e}return null}function pt(e={}){const t=Te(e.qty??e.quantity);if(!Number.isFinite(t)||t<=0)return 0;const n=[e.um,e.uom,e.unitaMisura,e.unit,e.measure].find(e=>null!=e&&""!==String(e).trim())||"",o=n.toString().toUpperCase().replace(/\./g,""),i=/\b(PZ|PZS|PCS?|PCE|PEZ|PEZZ[IO]?|NR|SAC|SACCO|SACCHI|SACCHETTO|SACCHETTI|SACCH)\b/.test(o),a=/\bKG\b/.test(o)&&!i,r=i;let s=e.packKg;if(!(Number.isFinite(s)&&s>0)){const t=e.desc||e.description||"",o=mt(t);if(Number.isFinite(o)&&o>0)s=o;else if(n||t){const e=mt(`${t} ${n}`.trim());Number.isFinite(e)&&e>0&&(s=e)}}const l=Number(s),c=Number.isFinite(l)&&l>0;return a?t:r&&c?t*l:t}function gt(e){const t=e||"";if((t||"").toUpperCase().includes("SACCHETTO BIANCO"))return{label:"SACCHETTO BIANCO",color:"white"};const n=_e(t);if(!n)return null;if(!/\b(sacco|sacchetto|bobina)\b/.test(n))return null;const o=n.match(/\b(blu|azzur\w+|ross\w+|bianc\w+|ner\w+|verd\w+|giall\w+)\b/);if(!o)return null;if(/\b(rame|zolfo|caolino|ossicloruro|poltiglia|zeolite)\b/.test(n))return null;const i=o[1],a=i.includes("azzur")||i.includes("blu")?"blue":i.includes("ross")?"red":i.includes("bianc")?"white":i.includes("ner")?"black":i.includes("verd")?"green":i.includes("giall")?"yellow":"other";return{label:(e||"").trim()||"Avviso",color:a}}function ft(e){const t=[];for(const n of e||[]){if(n.alertInfo)continue;const e=Number(n.packKg),o=mt(n.desc||""),i=Number.isFinite(e)&&e>0?e:Number.isFinite(o)&&o>0?o:null;null!=i&&t.push(i)}if(!t.length)return"large";const n=Math.max(...t);return n>=5?"large":n>0?"small":"large"}function bt(e){switch(e){case"blue":return{bg:"rgba(46,123,255,.12)",border:"rgba(46,123,255,.35)",color:"#0a3a7d"};case"red":return{bg:"rgba(255,59,48,.14)",border:"rgba(255,59,48,.4)",color:"#8a1f1a"};case"white":return{bg:"rgba(255,255,255,.92)",border:"rgba(255,255,255,.35)",color:"#1c1c1e",shadow:"0 1px 0 rgba(0,0,0,.04), 0 10px 22px rgba(0,0,0,.08)"};case"black":return{bg:"#1c1c1e",border:"rgba(0,0,0,.6)",color:"#f5f5f7"};case"green":return{bg:"rgba(52,199,89,.14)",border:"rgba(52,199,89,.38)",color:"#0b5d2a"};case"yellow":return{bg:"rgba(255,214,10,.32)",border:"rgba(255,184,0,.68)",color:"#4d2d00",shadow:"0 12px 26px rgba(255,193,7,.22)"};default:return{bg:"rgba(0,0,0,.05)",border:"rgba(0,0,0,.12)",color:"#1c1c1e"}}}function ht(e){if(!e||"object"!=typeof e)return!1;for(const t of Object.values(e)){if("string"!=typeof t)continue;const e=t.toUpperCase();if(e.includes("**"))return!0;if(e.includes("SACCHETTO BIANCO"))return!0}return!1}function yt(e){return ht(e)}window.__resolveQtyKg=pt,window.__detectPackKg=mt;const vt="undefined"!=typeof window&&window.matchMedia?window.matchMedia("(min-aspect-ratio: 16/10)"):null,wt=window.matchMedia("(min-width: 1024px)");function _t(){const e=U("statsProdCard"),t=U("statsCardAnchor"),n=U("opsCard");if(!e||!t||!n)return;const o=t.parentElement;o&&e.parentElement!==o&&o.insertBefore(e,t.nextElementSibling)}function St(e={}){const{selectable:t=!0,checked:n=!1,badgeText:o=""}=e;return`\n      <div class="whiteBagBanner" role="note" aria-label=" SACCHETTO BIANCO  Devi usare il sacchetto bianco">\n        <div class="icon"></div>\n        <div class="txt">\n          <div class="t">SACCHETTO BIANCO</div>\n          <div class="s"> Devi usare il sacchetto bianco</div>\n        </div>\n        ${t?`<div class="badge">${o||(n?"":"Seleziona")}</div>`:""}\n      </div>\n    `}function At(e,t,n){const o=_e(e).replace(/\s+/g,"");if(o&&L.has(o))return!1;const i=_e(t),a=_e(n);if(/\b(mastice)\b/.test(i))return!1;if(/\b(secchio|tanica|flacone|bottiglia|spray|trigger|pompa|nebul|olio|shampoo|deterg|repel|bio)\b/.test(i))return!1;if(/\b\d+(?:[\.,]\d+)?\s*(ml|l|lt)\b/.test(i))return!1;if("l"===a||"lt"===a||"ml"===a)return!1;const r=mt(t),s=/\b(big\s*bag|bigbag)\b/.test(i);return!(null!=r&&r>10.0001&&!s)&&(!!(s&&null!=r&&r>=100)||(!!/\b(sacco|sacchetto|busta|bustina|barattolo)\b/.test(i)||("kg"===a||"g"===a||(!!/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/.test(i)||!!/\b(ossicloruro|poltiglia|caolino|zeolite|zolfo|rame|solfato|idrossido|tribasico|diatomite|agroblumagic|corrobor)\b/.test(i)))))}function Tt(e,t=""){const n=_e(e),o=_e(t),i=e=>e.test(n)||e.test(o);return i(/\b(rame|copper|cupr|cu)\b/)||n.includes("bordolese")||n.includes("poltiglia")?"rame":i(/\b(zolfo|sulfur|sulf)\b/)?"zolfo":i(/\b(caolino|kaolin|caol)\b/)?"caolino":i(/\b(zeolite|zeolit)\b/)?"zeolite":i(/\b(diatomite|agroblumagic|corrobor)\b/)?"corroborante":"altro"}function Lt(e){return(e||"").toString().replace(/\|\s*CONCIME.*$/i,"").replace(/\|\s*CONSENTITO.*$/i,"").replace(/\|\s*AMMESSO.*$/i,"").replace(/\s{2,}/g,"").trim()}function Ct(e){if(!e)return null;const t=["Total","TotalDoc","TotalDocument","TotalAmount","Amount","DocTotal","TotalWithTax","GrossTotal"];for(const n of t){const t=Ae(Se(e.getElementsByTagName(n)[0]));if(null!=t)return t}return null}async function Et(e){const t=[],n=(new DOMParser).parseFromString(e,"text/xml"),o=Array.from(n.getElementsByTagName("Document"));for(let e=0;e<o.length;e++){const n=o[e],i=Se(n.getElementsByTagName("CustomerName")[0])||"Cliente",a=Se(n.getElementsByTagName("Number")[0])||"",r=Se(n.getElementsByTagName("Date")[0])||"";let s=Se(n.getElementsByTagName("ExpectedConclusion")[0])||Se(n.getElementsByTagName("ExpectedDeliveryDate")[0])||Se(n.getElementsByTagName("DeliveryDate")[0])||"";const l=Ct(n),c=[],d=Array.from(n.getElementsByTagName("Row"));for(let e=0;e<d.length;e++){e&&e%90==0&&await Z();const t=d[e],n=Se(t.getElementsByTagName("Code")[0])||"",o=Se(t.getElementsByTagName("Description")[0])||Se(t.getElementsByTagName("Name")[0])||"",i=Se(t.getElementsByTagName("UM")[0])||Se(t.getElementsByTagName("Unit")[0])||"";let r=Se(t.getElementsByTagName("Qty")[0])||Se(t.getElementsByTagName("Quantity")[0])||"0";r=parseFloat(r.replace(",",".")),Number.isFinite(r)||(r=0);const s=gt(o),l=!s&&At(n,o,i),u=mt(o),m=l?Tt(o,n):"altro",p=!l||s?0:pt({qty:r,um:i,packKg:u,desc:o}),g=`${a}|${e}|${_e(n)||_e(o).slice(0,24)}`;c.push({lineKey:g,code:n,desc:Lt(o),um:i,qty:r,powder:l,packKg:u,lineKg:p,material:m,alertInfo:s})}t.push({customer:i,number:a,date:r,conclusion:s,totalDoc:l,lines:c}),e&&e%12==0&&await Z()}return t}async function Nt(n=!1,o="manual"){try{xt("warn","Stato: sincronizzazione");const o=!q.firstRenderDone;ce(o?"Connessione":"Aggiornamento"),n&&ct(40,"DOWNLOAD: ordini in corso");const i=await async function(e,t=15e3,n={}){const o=new AbortController,i=setTimeout(()=>o.abort(),t);try{return await fetch(e,{...n,signal:o.signal})}finally{clearTimeout(i)}}(e,16e3,{cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);const a=await i.json();if(a&&!1===a.ok)throw new Error(a.error||"Proxy: errore");const r=a?.xml;if(!r||"string"!=typeof r)throw new Error("XML mancante");N.xmlModifiedTime=a?.modifiedTime||null,N.lastFetchAt=Date.now(),localStorage.setItem(t,JSON.stringify({at:N.lastFetchAt,xml:r,modifiedTime:N.xmlModifiedTime})),ce(o?"Parsing":"Aggiornamento"),N.docs=await Et(r),N.fatturatoLordo=uo(N.docs);const s=[];for(const e of N.docs){const t=e.lines.filter(e=>e.powder);if(!t.length)continue;const n=t.reduce((e,t)=>e+(t.lineKg||0),0),o=e.lines.filter(e=>e.alertInfo);s.push({customer:e.customer,number:e.number,orderNo:e.number,conclusion:e.conclusion,lines:t,alerts:o,totalKg:n})}N.powderOrders=s,Sn(),ce("Aggiornamento"),Eo(),xt("ok","Stato: online"),n&&ct(62,"OK: ordini aggiornati"),q.inError=!1,q.firstRenderDone?de():requestAnimationFrame(()=>ue()),G=0,V&&(clearTimeout(V),V=null)}catch(e){console.warn("syncOrders failed",e),me("Connessione instabile. Riprovo");const o=localStorage.getItem(t);if(o)try{const e=JSON.parse(o);N.lastFetchAt=e.at||null,N.xmlModifiedTime=e.modifiedTime||null,N.docs=await Et(e.xml||""),N.fatturatoLordo=uo(N.docs);const t=[];for(const e of N.docs){const n=e.lines.filter(e=>e.powder);if(!n.length)continue;const o=n.reduce((e,t)=>e+(t.lineKg||0),0),i=e.lines.filter(e=>e.alertInfo);t.push({customer:e.customer,number:e.number,orderNo:e.number,conclusion:e.conclusion,lines:n,alerts:i,totalKg:o})}N.powderOrders=t,Sn()}catch(e){}Eo(),xt("bad","Stato: offline (cache)"),n&&ct(55,"Connessione lenta uso cache locale"),q.firstRenderDone||requestAnimationFrame(()=>ue()),V||(G=G?Math.min(2*G,2e4):2e3,V=setTimeout(()=>{V=null,$t(!1,"retry")},G),me("Connessione instabile. Riprovo"))}}function xt(e,t){const n=U("dotOnline");n.className="dot","ok"===e&&n.classList.add("ok"),"warn"===e&&n.classList.add("warn"),"bad"===e&&n.classList.add("bad"),U("txtOnline").textContent=t}async function $t(e=!1,t="manual"){return W?(j=!0,Y):(W=!0,Y=(async()=>{try{await Nt(e,t)}finally{if(W=!1,j)return j=!1,$t(!1,"queued")}})(),Y)}_t(),function(){const e=U("callMatteoCard"),t=document.querySelector(".desktopCol.mainCol");if(!e||!t)return;document.body.classList.contains("role-operator")&&Ee()&&(e.parentElement===t&&e===t.lastElementChild||t.appendChild(e))}();let kt=!1;const Mt=(()=>{let e=null;return t=>{clearTimeout(e),e=setTimeout(()=>Ot(t),180)}})();async function Ot(e="manual"){if(!kt){kt=!0;try{await $t(!1,e),Eo(),"focus"!==e&&"pageshow"!==e||Ve("Aggiornato","Dati ricaricati (riapertura).",1800)}finally{kt=!1}}}function Dt(e){const t=U("btnHeaderRefresh"),n=U("refreshErrBadge");t&&t.classList.toggle("hasError",!!e),n&&(n.style.display=e?"inline-flex":"none")}function Bt(e){const t=(e&&(e.code||e.message||"")).toString(),n={"auth/unauthorized-domain":"Dominio non autorizzato. Verifica in Firebase: Authentication  Settings  Domini autorizzati.","auth/operation-not-allowed":"Provider Google non abilitato. Verifica in Firebase: Authentication  Sign-in method.","auth/popup-blocked":"Popup bloccato dal browser. Riprovo con reindirizzamento","auth/popup-closed-by-user":"Popup chiuso. Riprova.","auth/cancelled-popup-request":"Richiesta annullata. Riprova.","auth/network-request-failed":"Connessione instabile. Riprova tra qualche secondo.","auth/invalid-api-key":"Config Firebase non valida (apiKey).","auth/invalid-oauth-client-id":"Client OAuth non valido (Google). Controlla la configurazione Web SDK.","auth/redirect-cancelled-by-user":"Accesso annullato. Riprova.","auth/redirect-operation-pending":"Accesso gi in corso. Attendi e riprova."};for(const e in n)if(t.includes(e))return n[e];return"Errore accesso. Controlla rete e riprova."}const It="powderUsers";function Pt(){qt(),U("authGate").classList.add("show"),it()}function zt(){U("authGate").classList.remove("show"),at()}function Ft(){try{const e=parseInt(localStorage.getItem(c)||"0",10);return!(!Number.isFinite(e)||e<=0)&&Date.now()-e<6048e5}catch(e){return!1}}function Rt(){try{localStorage.removeItem(c)}catch(e){}try{localStorage.removeItem(d)}catch(e){}}function Kt(e){x=e}function Ht(){const e=document.querySelector(".wrap");e&&(e.style.visibility="visible",e.style.pointerEvents="auto")}function Ut(e="Verifica accesso"){const t=U("authLoader");if(!t)return;const n=t.querySelector(".txt");n&&(n.textContent=e),t.classList.add("show")}function qt(){const e=U("authLoader");e&&e.classList.remove("show")}function Wt(){zt()}function jt(){globalThis.__RESTORE_TIMER__&&(clearTimeout(globalThis.__RESTORE_TIMER__),globalThis.__RESTORE_TIMER__=null),$=null}function Vt(e){"function"==typeof e&&($=e),globalThis.__RESTORE_TIMER__||(globalThis.__RESTORE_TIMER__=setTimeout(()=>{globalThis.__RESTORE_TIMER__=null;const e=N.firebase?.auth;if(e&&e.currentUser)return Kt("signed_in"),qt(),void Wt();"function"==typeof $&&$()},6e3))}function Gt(e="Ripristino sessione"){Kt("restoring"),Ht(),Wt(),Ut(e)}function Yt(){Ee()&&Ft()?Gt("Ripristino sessione"):(Kt("unknown"),Ht(),Wt(),Ut("Verifica accesso"))}function Zt(e=""){Kt("signed_out"),qt(),Pt();const t=U("authBody");t.innerHTML=`\n      <div class="stepTitle">Accesso richiesto</div>\n      <div class="muted">${e||"Accedi per iniziare. Se la tua email non  autorizzata, contatta un amministratore."}</div>\n      <div style="height:12px"></div>\n\n      <button class="btn good" id="btnGoogle" style="width:100%;">Accedi con Google</button>\n      <div style="height:10px"></div>\n\n      <div class="divider"></div>\n      <div class="stepTitle" style="font-size:16px; margin-top:0;">Oppure con email</div>\n\n      <div class="authRow">\n        <div class="field">\n          <label>Nome</label>\n          <input id="authName" autocomplete="given-name" placeholder="Nome" />\n        </div>\n        <div class="field">\n          <label>Cognome</label>\n          <input id="authSurname" autocomplete="family-name" placeholder="Cognome" />\n        </div>\n      </div>\n      <div class="field">\n        <label>Email</label>\n        <input id="authEmail" type="email" autocomplete="email" placeholder="nome@azienda.it" />\n      </div>\n      <div class="field">\n        <label>Password</label>\n        <input id="authPass" type="password" autocomplete="current-password" placeholder="Password" />\n      </div>\n\n      <div class="row2">\n        <button class="btn" id="btnEmailLogin">Accedi</button>\n        <button class="btn ghost" id="btnEmailSignup">Crea account</button>\n      </div>\n\n      <div style="height:12px"></div>\n      <div class="muted">Nota: la pagina resta sempre in italiano.</div>\n    `,t.querySelector("#btnGoogle").onclick=async()=>{const e=N.firebase.authApi,t=N.firebase.auth,n=new e.GoogleAuthProvider;N.lastAuthErrorMsg="";try{await e.signInWithPopup(t,n)}catch(o){console.warn("Google popup error",o);const i=Bt(o);if(o&&"auth/popup-blocked"===o.code||o&&"auth/operation-not-supported-in-this-environment"===o.code){Ve("Accesso",i);try{return void await e.signInWithRedirect(t,n)}catch(e){return console.warn("Google redirect error",e),N.lastAuthErrorMsg=Bt(e),void Zt(N.lastAuthErrorMsg)}}N.lastAuthErrorMsg=i,Ve("Accesso",i)}},t.querySelector("#btnEmailLogin").onclick=async()=>{const e=t.querySelector("#authEmail").value.trim(),n=t.querySelector("#authPass").value;if(e&&n)try{const t=N.firebase.authApi;await t.signInWithEmailAndPassword(N.firebase.auth,e,n)}catch(e){console.warn(e),Ve("Accesso","Credenziali non valide o account inesistente.")}else Ve("Accesso","Inserisci email e password.")},t.querySelector("#btnEmailSignup").onclick=async()=>{const e=t.querySelector("#authName").value.trim(),n=t.querySelector("#authSurname").value.trim(),o=t.querySelector("#authEmail").value.trim(),i=t.querySelector("#authPass").value;if(e&&n&&o&&i)try{const t=N.firebase.authApi,a=await t.createUserWithEmailAndPassword(N.firebase.auth,o,i);await Qt(a.user,{fullName:`${e} ${n}`,name:e,surname:n,email:o})}catch(e){console.warn(e),Ve("Registrazione","Impossibile creare laccount (email gi usata o password debole).")}else Ve("Registrazione","Compila nome, cognome, email e password.")}}async function Qt(e,t){if(!N.firebase.ok)return;const n=N.firebase.api,o=N.firebase.db,i=n.doc(o,It,e.uid);await n.setDoc(i,{uid:e.uid,...t,updatedAt:pe(),createdAt:pe()},{merge:!0})}let Jt=null,Xt=null,en=1500;const tn=6e4;let nn=0,on=null,an=!1;function rn(){if(Jt){try{Jt()}catch(e){}Jt=null}Xt&&(clearTimeout(Xt),Xt=null)}function sn(){if(Jt)return;if(Xt&&(clearTimeout(Xt),Xt=null),!N.firebase.ok||!N.user)return;const e=N.firebase.api,t=N.firebase.db;if(e&&t)try{const n=e.collection(t,"powderProductions"),o=e.collection(t,"powderProdHistory"),i=Ze(e,t),a=[],r=e=>{const t=Date.now();if((!nn||t-nn>1e4)&&(console.warn("onSnapshot error",e),nn=t),rn(),!1===navigator.onLine)return;en=Math.min(tn,2*en);const n=Math.floor(251*Math.random());Xt=setTimeout(()=>{Xt=null,sn()},en+n)},s=e=>{const t=[];e.forEach(e=>t.push({id:e.id,...e.data()})),N.activeProductions=t.filter(e=>e&&e.active),Eo(),en=1500},l=e=>{const t=[];e.forEach(e=>t.push({id:e.id,...e.data()}));const n=oe(),o=n?t.filter(e=>To(e.id||e.at||0)>n):t;N.history=o,N.historyReady=!0,Mo(),Wo();try{Lo()}catch(e){}try{renderPartialBanner&&renderPartialBanner()}catch(e){}en=1500};a.push(e.onSnapshot(n,s,r));try{a.push(e.onSnapshot(o,l,r))}catch(e){}try{const t=e.onSnapshot(i,nt,r);a.push(t),N.alerts.unsub=t}catch(e){N.alerts.unsub=null}Jt=()=>{for(const e of a)try{e&&e()}catch(e){}N.alerts.unsub=null,Jt=null}}catch(e){const t=Date.now();(!nn||t-nn>1e4)&&(console.warn("snapshot start failed",e),nn=t)}}function ln(){if(rn(),N.alerts={unsub:null,data:null},N.alertSaving=!1,Xe(),et(),N.historyReady=!1,N.history=[],Tn(),N.actionLogs={entries:[],ready:!1,error:""},D(),N.notifUnsub){try{N.notifUnsub()}catch(e){}N.notifUnsub=null}N.notifications={inbox:[],ready:!1,unavailable:!1,error:""},Qo(),Jo(),Wo();try{U("payrollAdminModal").style.display="none",U("payrollUserModal").style.display="none"}catch(e){}D();try{Di("idle"),Bi()}catch(e){}N.user=null,N.operator=null,Ne(),Re(),U("hdrUser").textContent=""}function cn(e=""){jt(),Rt(),Kt("signed_out"),qt(),ln(),Zt(e)}function dn(){if(globalThis.__AUTH_RESUME_BOUND__)return;globalThis.__AUTH_RESUME_BOUND__=!0;const e=()=>{Ee()&&"signed_out"!==x&&Ft()&&N.firebase?.auth&&(Gt("Ripristino sessione"),Vt(()=>cn("")))};window.addEventListener("pageshow",e),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&e()}),window.addEventListener("focus",e)}async function un(e){if(!N.firebase.ok)return null;const t=N.firebase.api,n=N.firebase.db,o=e.id||`${Date.now()}_${Math.random().toString(16).slice(2)}`;return await t.setDoc(t.doc(n,"powderProductions",o),{...e,id:o,active:!0},{merge:!0}),o}async function mn(e,t={}){if(!N.firebase.ok)return;const n=N.firebase.api,o=N.firebase.db;await n.setDoc(n.doc(o,"powderProductions",e),{active:!1,closedAt:pe(),...t},{merge:!0})}async function pn(e){if(N.firebase.ok)try{const t=N.firebase.api,n=N.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`,i={id:o,actor:e.actor||N.user?.fullName||N.operator||"Operatore",actorUid:e.actorUid||N.user?.uid||"",actorEmail:e.actorEmail||N.user?.email||"",type:e.type||"altro",action:e.action||"Evento",description:e.description||"",meta:e.meta||"",customer:e.customer||"",orderNo:e.orderNo||"",actorIsAdmin:Boolean(N.user?.isAdmin),ts:Date.now(),createdAt:t.serverTimestamp?t.serverTimestamp():pe(),at:pe(),extra:e.extra||{}};if(await t.setDoc(t.doc(n,b,o),i),N.actionLogs&&Array.isArray(N.actionLogs.entries)){const e=Date.now(),t={...i,ts:e};N.actionLogs.entries=[t,...N.actionLogs.entries].slice(0,200),ko()}return i}catch(e){console.warn("addActionLog error",e)}}function gn(e,t){return e.doc(t,y,v)}function fn(){if(!(globalThis.__allowCommitted instanceof Set)){const e=globalThis.__ALLOW_KEYS__ instanceof Set?globalThis.__ALLOW_KEYS__:new Set;globalThis.__allowCommitted=new Set(Array.from(e))}return globalThis.__allowCommitted}function bn(){if(!(globalThis.__allowDraft instanceof Set)){const e=fn();globalThis.__allowDraft=new Set(Array.from(e))}return globalThis.__allowDraft}function hn(){const e=bn(),t=fn();let n=e.size!==t.size;if(!n){for(const o of e)if(!t.has(o)){n=!0;break}if(!n)for(const o of t)if(!e.has(o)){n=!0;break}}N.mobileAllowDirty=n,globalThis.__allowDraftDirty=n}let yn=null,vn=null,wn=null;function _n(){N.powderOrders&&N.powderOrders.length?(N.mobileAllowlist.pendingRender=!1,clearTimeout(yn),yn=setTimeout(()=>{Eo()},100)):N.mobileAllowlist.pendingRender=!0}function Sn(){N.mobileAllowlist?.pendingRender&&N.powderOrders&&N.powderOrders.length&&_n()}let An=null;function Tn(){if(wn){try{wn()}catch(e){}wn=null}N.actionLogs={entries:[],ready:!1,error:""}}function Ln(){"saving"!==N.mobileAllowReset?.status&&(N.mobileAllowReset?.confirm?async function(){if(!N.user||!N.user.isAdmin)return N.mobileAllowReset={confirm:!1,status:"error",lastError:"permission-denied"},void co(k,M);if(!N.firebase.ok)return N.mobileAllowReset={confirm:!1,status:"error",lastError:"firebase-offline"},void co(k,M);const e=N.firebase.api,t=N.firebase.db,n=gn(e,t);B(),N.mobileAllowReset={confirm:!1,status:"saving",lastError:""},co(k,M);try{await e.setDoc(n,{keys:[],updatedAt:e.serverTimestamp(),updatedBy:N.user.email||N.user.fullName||""},{merge:!0}),function(e={}){globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set,globalThis.__allowCommitted=new Set,globalThis.__allowDraft=new Set,globalThis.__allowDraftDirty=!1,N.mobileAllowlist={...N.mobileAllowlist||{},ready:!0,keys:new Set,updatedAt:e.updatedAt||null,updatedBy:e.updatedBy||"",allowAll:!1,docExists:!1!==e.docExists,error:"",lastError:"",lastSyncTs:Date.now(),pendingRender:!1},N.mobileAllowSelection=new Set,N.mobileAllowDirty=!1,N.mobileAllowSaveState="idle",globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},updatedBy:e.updatedBy||"",lastError:"",lastSyncTs:Date.now()}}({updatedBy:N.user.email||N.user.fullName||"",docExists:!0}),N.mobileAllowReset={confirm:!1,status:"success",lastError:""},hn(),setTimeout(()=>Eo(),100)}catch(e){console.warn("reset allowlist error",e);const t=e?.code||"",n=e?.message||String(e),o=t||n;N.mobileAllowReset={confirm:!1,status:"error",lastError:o||"errore"}}vn&&(clearTimeout(vn),vn=null);co(k,M)}():(N.mobileAllowReset={...N.mobileAllowReset||{},confirm:!0},vn&&clearTimeout(vn),co(k,M),vn=setTimeout(()=>{N.mobileAllowReset={...N.mobileAllowReset||{},confirm:!1},co(k,M)},3e3)))}async function Cn(e){if(!N.firebase.ok)return;const t=N.firebase.api,n=N.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`;await t.setDoc(t.doc(n,"powderProdIssues",o),{...e,id:o,at:pe()});try{await pn({type:"issue",action:"Segnalazione problema",description:e?.text||e?.message||"Segnalazione registrata",customer:e?.customer||"",orderNo:e?.orderNo||"",meta:e?.kind||""})}catch(e){}}const En=!0,Nn="https://geminitts-zxiqbo2osa-ew.a.run.app",xn="Kore",$n="it-IT";let kn=null;async function Mn(){}globalThis.__ttsLastMode="none",globalThis.__ttsLastError="";let On=null,Dn=null,Bn=null;function In(e){Bn||(Bn=setTimeout(()=>{Bn=null;try{Fn(e)}catch(e){}},360))}function Pn(){try{if(!("speechSynthesis"in window))return null;const e=window.speechSynthesis.getVoices()||[];if(!e.length)return null;const t=e=>String(e||"").toLowerCase(),n=e=>t(e.lang).startsWith("it"),o=e=>t(e.name).includes("google");return e.find(e=>n(e)&&o(e))||e.find(e=>n(e))||e.find(e=>o(e))||e[0]}catch(e){return null}}if("speechSynthesis"in window){try{kn=Pn()}catch(e){}try{window.speechSynthesis.onvoiceschanged=()=>{try{kn=Pn()}catch(e){}}}catch(e){}setTimeout(()=>{try{kn=Pn()}catch(e){}},0)}async function zn(e){const t=new AbortController;Dn=t;const n={text:String(e||""),lang:$n,voice:xn,style:"chiaro, professionale, tono aziendale"},o=await fetch(Nn.trim(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),signal:t.signal,mode:"cors",cache:"no-store",credentials:"omit"});if(!o.ok){const e=await o.text().catch(()=>"");throw new Error(`Proxy TTS HTTP ${o.status}${e?`  ${e.slice(0,180)}`:""}`)}let i=null;if((o.headers.get("content-type")||"").toLowerCase().includes("application/json")){const e=await o.json(),t=e.audioB64||e.audio||e.data||"";if(!t)throw new Error("Proxy TTS: audio mancante (JSON).");i=function(e){const t=atob(String(e||"")),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=255&t.charCodeAt(e);return n}(t).buffer}else i=await o.arrayBuffer();await async function(e){On||(On=new Audio,On.preload="auto");const t=new Blob([e],{type:"audio/wav"}),n=URL.createObjectURL(t);return On.src=n,new Promise((e,t)=>{const o=()=>{try{URL.revokeObjectURL(n)}catch(e){}try{On.onended=null,On.onerror=null}catch(e){}};On.onended=()=>{o(),e()},On.onerror=()=>{o(),t(new Error("Audio playback error"))};try{const e=On.play();e&&"function"==typeof e.then&&e.then(()=>{}).catch(e=>{o(),t(e)})}catch(e){o(),t(e)}})}(i)}async function Fn(e){if(!function(){try{const e=e=>window.matchMedia&&window.matchMedia(e).matches,t=e("(pointer: fine)")&&e("(hover: hover)"),n=Math.max(window.innerWidth||0,document.documentElement.clientWidth||0)>=900,o=(navigator.userAgent||"").toLowerCase(),i=/android|iphone|ipod|ipad|iemobile|mobile|tablet/.test(o);return t&&n&&!i}catch(e){return!1}}())return globalThis.__ttsLastMode="disabled",void(globalThis.__ttsLastError="");const t=String(e||"").trim();if(!t)return globalThis.__ttsLastMode="none",void(globalThis.__ttsLastError="");const n=t.length>520?t.slice(0,520).trim()+"":t;globalThis.__ttsLastError="";try{await Mn()}catch(e){}try{!function(){try{Dn&&Dn.abort()}catch(e){}Dn=null;try{On&&(On.pause(),On.src="",On.load())}catch(e){}}()}catch(e){}try{"speechSynthesis"in window&&window.speechSynthesis.cancel()}catch(e){}if(En&&"string"==typeof Nn&&Nn.trim().length>0){globalThis.__ttsLastMode="gemini";try{const e=`Leggi ESATTAMENTE (senza cambiare parole) in italiano (${$n}), tono chiaro e professionale, il seguente testo:\n${n}`;await zn(e);try{await Mn()}catch(e){}return}catch(e){globalThis.__ttsLastError=e&&e.message?String(e.message):String(e||""),console.log("TTS (Gemini proxy) error:",e);const t=globalThis.__ttsLastError||"";if(/notallowed|not-allowed|gesture|autoplay/i.test(t))return void In(n)}}try{if(!("speechSynthesis"in window))return void(globalThis.__ttsLastMode="none");kn||(kn=Pn()),globalThis.__ttsLastMode="webspeech";const e=new SpeechSynthesisUtterance(n);e.lang=$n,e.rate=.92,e.pitch=.9,kn&&(e.voice=kn),e.onend=()=>{try{Mn()}catch(e){}},e.onerror=e=>{try{Mn()}catch(e){}const t=e&&e.error?String(e.error):"";/not-allowed|gesture|autoplay/i.test(t)&&In(n)},window.speechSynthesis.speak(e)}catch(e){globalThis.__ttsLastMode=globalThis.__ttsLastMode||"webspeech",globalThis.__ttsLastError=e&&e.message?String(e.message):String(e||""),console.log("TTS (WebSpeech) error:",e);try{Mn()}catch(e){}}}function Rn(e){const t=e.startedAt?new Date(e.startedAt).getTime():null;if(!t)return 0;const n=Date.now()-t,o=Number(e.totalKg||0);return n/Math.max(1,o/500*3600*1e3)}function Kn(){const e=N.powderOrders||[],t=N.history||[],n=new Map;for(const e of t){if(!e||!e.orderNo)continue;const t=String(e.orderNo),o=Array.isArray(e.concludedLineKeys)?e.concludedLineKeys:[];n.has(t)||n.set(t,new Set);const i=n.get(t);for(const e of o)e&&i.add(String(e))}const o=[],i=[];for(const t of e){const e=String(t.orderNo||t.number||"");if(!e)continue;let a=0;const r=[];for(const e of t.lines||[]){if(yt(e)){a++;continue}const t=String(e.lineKey||"");t&&r.push(t)}const s=r.length+a;if(s<=0)continue;const l=n.get(e)||new Set;let c=0;for(const e of r)l.has(e)&&c++;const d=c+a,u=s-d;c>0&&u>0?o.push({orderNo:e,customer:t.customer||"",done:d,total:s}):d>0&&u<=0&&i.push({orderNo:e,customer:t.customer||"",done:d,total:s})}return{partial:o,full:i}}function Hn(e){try{return _e(String(e||"")).replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"").trim()}catch(t){return String(e||"").toLowerCase().trim().replace(/\s+/g,"")}}function Un(e,t){const n=Hn(e),o=Hn(t);if(!n||!o)return!1;if(n===o)return!0;if(n.startsWith(o)||o.startsWith(n))return!0;const i=n.split("").filter(Boolean),a=o.split("").filter(Boolean),r=i.length<=a.length?i:a,s=i.length<=a.length?a:i,l=new Set(s);for(const e of r)if(e&&!l.has(e))return!1;return r.length>0}function qn(e={}){const t=!1!==e.applyRoleVisibility,n=!0===e.includeHidden,o=new Set;for(const e of N.history||[])if(e&&Array.isArray(e.concludedLineKeys))for(const t of e.concludedLineKeys)t&&o.add(String(t));const i=new Map;for(const e of N.activeProductions||[]){const t=Array.isArray(e.selectedLineKeys)?e.selectedLineKeys:[];for(const n of t)n&&i.set(String(n),e)}const a=new Map,r=new Map;try{const{partial:e,full:t}=Kn();e.forEach(e=>a.set(String(e.orderNo),e)),t.forEach(e=>r.set(String(e.orderNo),e))}catch(e){}const s=window.matchMedia("(min-width: 980px)").matches,l=Boolean(N.user&&N.user.isAdmin),c=Ee(),d=(N.mobileAllowlist,globalThis.__ALLOW_KEYS__ instanceof Set?globalThis.__ALLOW_KEYS__:new Set),u=Boolean(globalThis.__ALLOW_LOADED__),m=Boolean(!l&&c&&u),p=Boolean(!l&&c&&!u),g=N.user?.fullName||N.operator||"",f=[],b=[],h=new Set;for(const e of N.powderOrders||[]){const c=e.orderNo||e.number||"",u=po(e),y=bo(u);let v=0;const w=(e.lines||[]).map(t=>{if(yt(t))return v++,null;const n=String(t.lineKey||""),a=i.get(n)||null,r=o.has(n)?"done":a?"active":"idle",s=a?.operator||a?.operatorName||"",l=Boolean(a&&Un(s,g));return{...t,status:r,activeProd:a,activeOp:s,activeIsMe:l,conclusion:t.conclusion||e.conclusion||""}}).filter(Boolean).filter(e=>"done"!==e.status),_=Array.isArray(e.alerts)?e.alerts:[];if(!w.length){if(v>0)continue;if(!_.length)continue}const S=y.date||go(u),A=S?fo(S):null,T=je(e),L={...e,orderNo:c,lines:w,alerts:_,autoDone:v,totalLines:w.length+v,partialInfo:a.get(String(c))||null,isCompleted:r.has(String(c)),note:u,priorityInfo:y,planDate:S,daysAway:A};L.__k=T,L.stableKey=T,b.push(L),h.add(T);let C=!0;if(t)if(s)if(l)C=!0;else{C=!Boolean(S&&null!=A&&A>3)}else C=!1!==y.visible;C&&m?C=d.has(T):p&&(C=!1),(C||n)&&f.push(L)}return{orders:f,baseOrders:b,concluded:o,activeMap:i,partialMap:a,fullMap:r,orderKeySet:h,allowKeySet:d}}function Wn(e){const t=e=>{if(null==e)return null;const t=String(e).replace(/,/g,".").trim();if(!t)return null;return ut(parseFloat(t))},n=[e?.packKg,e?.packkg,e?.formatoKg,e?.formato,e?.sizeKg,e?.size,e?.pack,e?.packaging,e?.packSize,e?.formatoConfezione];for(const e of n){const n=t(e);if(null!=n)return n}const o=[e?.packKgLabel,e?.formatoLabel,e?.desc,e?.prodotto,e?.product,e?.note,e?.variant,e?.variante,`${e?.desc||""} ${e?.um||""}`];for(const e of o){const t=mt(e||"");if(null!=t)return t}return null}function jn(e){if(!e)return 0;const t=Wn(e),n=pt({qty:e.qty,um:e.um,uom:e.uom,unitaMisura:e.unitaMisura,unit:e.unit,measure:e.measure,packKg:t,desc:e.desc||""});if(Number.isFinite(n)&&n>0)return n;const o=Number(e.lineKg);return Number.isFinite(o)&&o>0?o:0}function Vn(e){const t=e||{},n=t.orderNo||t.number||t.docNumber||t.codiceOrdine||t.id||t.orderId||t.numero||"";return String(n||"").trim()}function Gn(e){return qe(Vn(e))}function Yn(e){try{localStorage.setItem(A,JSON.stringify(e||{customer:"",order:"",item:""}))}catch(e){}}function Zn(e){N.magFilters={customer:"",order:"",item:"",...N.magFilters||{},...e||{}},Yn(N.magFilters)}function Qn(e){const t=[],n=e=>{if(null==e)return;const n=String(e).trim();n&&t.push(n)},o=e?.order||{};for(const e of o.lines||[])n(e.imballaggio),n(e.imballo),n(e.articolo),n(e.item),n(e.imballaggi),n(e.desc),n(e.code);const i=e?.comp||{};return Number(i.productKg)&&n("Prodotto da completare"),i?.bobine?.forEach?.((e,t)=>n(t)),Number(i.etichette)&&n("Etichette"),i?.scatole?.forEach?.((e,t)=>n(t)),i?.divisori?.forEach?.((e,t)=>n(t)),i?.altri?.forEach?.((e,t)=>n(t)),(i.nonConfig||[]).length&&n("Non configurati"),t}function Jn(e){const t=new Map,n=new Map,o=new Map,i=(e,t)=>{const n=qe(t);n&&!e.has(n)&&e.set(n,String(t).trim())},a=e=>{const t=Gn(e);if(!t||o.has(t))return;const n=Vn(e),i=function(e){const t=Vn(e)||"Ordine senza numero",n=e?.customer||e?.cliente||e?.customerName||e?.ragioneSociale||"";return n?`${t}  ${n}`:t}(e);o.set(t,{value:n,label:i})};for(const o of e||[]){const e=o?.order||{};i(t,e.customer||e.cliente||e.customerName||e.ragioneSociale||""),a(e);const r=Qn(o);for(const e of r)i(n,e)}const r=e=>Array.from(e.values()).sort((e,t)=>e.localeCompare(t,"it",{sensitivity:"base"})),s=Array.from(o.values()).sort((e,t)=>String(e.value||"").localeCompare(String(t.value||""),"it",{numeric:!0,sensitivity:"base"}));return{customers:r(t),items:r(n),orders:s}}function Xn(e){const t=new Set;for(const n of Qn(e)){const e=qe(n);e&&t.add(e)}return t}function eo(e,t){const n=Array.isArray(e)?e:[],o={customer:"",order:"",item:"",...t||{}},i=qe(o.customer),a=qe(o.order),r=qe(o.item),s=[];for(const e of n){const t=e?.order||{},n=qe(t.customer||t.cliente||t.customerName||t.ragioneSociale||"");if(!i||n===i||n.includes(i)){if(a){const e=Gn(t);if(!e||e!==a)continue}if(r){const t=Xn(e);let n=!1;for(const e of t)if(e===r||e.includes(r)){n=!0;break}if(!n)continue}s.push(e)}}const l=function(e){const t={productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[],linesTotal:0,linesOk:0,linesWarn:0,linesNonConfig:0};for(const{comp:n}of e||[]){const e=n||{};t.linesTotal+=Number(e.linesTotal||0),t.linesOk+=Number(e.linesOk||0),t.linesWarn+=Number(e.linesWarn||0),t.linesNonConfig+=Number(e.linesNonConfig||0),t.productKg+=Number(e.productKg||0),e?.bobine?.forEach?.((e,n)=>So(t.bobine,n,e)),t.etichette+=Number(e.etichette||0),e?.scatole?.forEach?.((e,n)=>So(t.scatole,n,e)),e?.divisori?.forEach?.((e,n)=>So(t.divisori,n,e)),e?.altri?.forEach?.((e,n)=>So(t.altri,n,e)),Array.isArray(e.nonConfig)&&t.nonConfig.push(...e.nonConfig),Array.isArray(e.warnings)&&t.warnings.push(...e.warnings)}return t}(s);return{filteredOrders:s,filteredTotals:l,applied:o}}globalThis.speak=Fn,globalThis._pickGoogleVoice=Pn,globalThis.__geminiTts={enabled:En,proxyUrl:Nn,voice:xn,lang:$n};const to="__wh_all__";function no(e){const t=[],n=(e,n,o,i,a={})=>{const r=Number(o||0);if(!Number.isFinite(r)||r<=0)return;const s="g"===i?r/1e3:r;t.push({key:e,label:n,qty:r,unit:i||"",type:a.type||"",subtitle:a.subtitle||"",sortVal:s})};return n("productKg|Prodotti da completare","Prodotto da completare",e.productKg,"kg",{type:"product",subtitle:"Kg totali residui"}),e.bobine.forEach((e,t)=>n(`bobine|${t}`,t,e,"g",{type:"bobine",subtitle:"Bobine"})),n("etichette|Etichette","Etichette",e.etichette,"pz",{type:"etichette",subtitle:"Etichette totali"}),e.scatole.forEach((e,t)=>n(`scatole|${t}`,t,e,"pz",{type:"scatole",subtitle:"Scatole"})),e.divisori.forEach((e,t)=>n(`divisori|${t}`,t,e,"pz",{type:"divisori",subtitle:"Divisori"})),e.altri.forEach((e,t)=>n(`altri|${t}`,t,e,"pz",{type:"altri",subtitle:"Altri componenti"})),e.nonConfig.length&&n("nonconfig|Non configurati","Non configurati",e.nonConfig.length,"pz",{type:"warning",subtitle:"Distinte non configurate"}),t.sort((e,t)=>(t.sortVal||0)-(e.sortVal||0))}function oo(e){if(!e)return"";if("kg"===e.unit)return _o(e.qty);if("g"===e.unit){const t=e.qty/1e3;return t>=1?_o(t):function(e){const t=Number(e||0);if(!Number.isFinite(t))return"";return`${(t%1==0?t.toFixed(0):t.toFixed(1)).replace(/\.0$/,"")} g`}(e.qty)}const t=function(e){const t=Number(e||0);return Number.isFinite(t)?t.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1"):""}(e.qty);return e.unit?`${t} ${e.unit}`:t}const io={"prodotto da completare":"Somma kg di tutti gli ordini non conclusi","kg totali residui":"Kg residui = kg da produrre  kg gi prodotti","etichette totali":"Pezzi stimati = numero sacchi totali (1 etichetta per sacco)","scatola americana":"Pezzi stimati = kg  20","divisorio croce texo":"Pezzi stimati = sacchi per scatola (1 divisorio per scatola)","divisorio z":"Pezzi stimati = sacchi per scatola (1 divisorio per scatola)","bobina blu f480":"Stima bobine = etichette  resa bobina (F480)","bobina f830":"Stima bobine = etichette  resa bobina (F830)"};function ao(e){const t=String(e||"").split("|")[0];return String(t||"").toLowerCase().replace(/\s+/g,"").trim()}function ro(e,t){if(t&&t.calcHint)return String(t.calcHint);const n=ao(e);return io[n]?io[n]:""}function so(e,t){const n=N.mobileAllowlist||{},o=fn(),i=(bn(),t instanceof Set?t:new Set((e||[]).map(e=>e?.__k||je(e))));let a=0;for(const e of o)i.has(e)&&a++;const r=Array.isArray(e)?e.length:0,s=o.size,l=function(e){try{const t=e&&"function"==typeof e.toDate?e.toDate():e?new Date(e):null;if(t&&Number.isFinite(t.getTime()))return ge(t)}catch(e){}return""}(n.updatedAt),c=o.size,d=n.ready&&!n.docExists,u=n.ready?d?"Nessuna assegnazione salvata: filtro vuoto.":n.allowAll?"Filtro disattivo: salva per limitare gli ordini.":`Aggiornato ${l}${n.updatedBy?`  ${n.updatedBy}`:""}  ${c} ordini live`:"Sincronizzazione in corso",m=n.lastError||n.error||(globalThis.__ALLOW_META__||{}).lastError||"",p=U("mobileAllowUpdatedBy");p&&(p.textContent=n.updatedBy?`Ultimo invio: ${n.updatedBy}`:"In attesa di primo invio");const g=U("mobileAllowUpdate");g&&(g.textContent=u);const f=U("mobileAllowTotal");f&&(f.textContent=String(r));const b=U("mobileAllowSent");b&&(b.textContent=String(s));const h=U("mobileAllowMatch");h&&(h.textContent=String(a)),hn();const y=U("mobileAllowStatus"),v=U("mobileAllowFeedback"),w=N.mobileAllowSaveState,_=Boolean(m);if(y&&(y.className="statusBadge",n.ready?"saving"===w?(y.textContent="Salvataggio",y.classList.add("live")):"error"===w||_?(y.textContent="Errore",y.classList.add("error")):d?y.textContent="Vuoto":n.allowAll?y.textContent="Filtro off":N.mobileAllowDirty?y.textContent="Da salvare":(y.textContent="Salvato",y.classList.add("live")):y.textContent="Sync"),v)if(v.className="saveBadge",n.ready)if("saving"===w)v.textContent="Salvataggio in corso";else if("error"===w||_)v.classList.add("error"),v.textContent="Salvataggio non consentito"+(m?`  ${m}`:"");else if(N.mobileAllowDirty)v.textContent="Modifiche locali non salvate.";else if(d)v.textContent="Assegnazioni vuote: nessun ordine inviato.";else{v.classList.add("live");const e=n.allowAll?"Filtro disattivo.":"Filtro attivo.";v.textContent=`${e} Match: ${a}/${r}`}else v.textContent="Stato: caricamento allowlist"}function lo(e,t){const n=U("mobileSendList"),o=Array.isArray(e)?e:[],i=_e(t||""),a=i?o.filter(e=>_e(`${e.customer||""} ${e.orderNo||e.number||""} ${e.conclusion||""} ${e.lines&&e.lines[0]?.desc||""}`).includes(i)):o;if(!n)return{filteredOrders:a,total:o.length};if(n.innerHTML="",!a.length)return n.innerHTML='<div class="muted">Nessun ordine trovato.</div>',{filteredOrders:[],total:o.length};const r=bn(),s=document.createDocumentFragment();for(const e of a){const t=e.__k||e.stableKey||je(e),n=r.has(t),o=e.lines&&e.lines[0]||{},i=Ce(o.qty,o.um),a=document.createElement("div");a.className="mobileSendRow",n&&a.classList.add("selected"),a.dataset.k=t,a.innerHTML=`\n        <div class="info">\n          <div class="name">${Ao(e.customer||"Cliente")}  Ord. ${Ao(e.orderNo||e.number||"")}</div>\n          <div class="meta">${Ao(o.desc||"Prodotto")}  ${Ao(i)}${e.conclusion?`  Consegna: ${Ao(e.conclusion)}`:""}</div>\n        </div>\n        <div class="mobileSendToggle" role="switch" aria-checked="${n?"true":"false"}">\n          <div class="knob"></div>\n        </div>`,s.appendChild(a)}return n.appendChild(s),{filteredOrders:a,total:o.length}}function co(e=k,t=M){const n=U("mobileSendCard"),o=Boolean(N.user&&N.user.isAdmin),i=Ee();if(!n)return;if(n.style.display=o?"block":"none",n.classList.toggle("isMobileAdmin",Boolean(o&&i)),n.classList.toggle("isDesktopAdmin",Boolean(o&&!i)),!o)return;const a=Array.isArray(e)?e:k||[],r=t instanceof Set?t:M instanceof Set?M:new Set((a||[]).map(e=>e?.__k||je(e)));k=Array.isArray(a)?[...a]:[],M=new Set(r),so(a,r);const s=N.mobileAllowSaveState,l=N.mobileAllowReset||{},c=Boolean(l.confirm),d=U("mobileAllowSearch");d&&(d.value!==(N.mobileAllowSearchTerm||"")&&(d.value=N.mobileAllowSearchTerm||""),d.oninput=e=>{N.mobileAllowSearchTerm=e.target.value||"",co(a,r)});const u=U("mobileSendList"),{filteredOrders:m}=lo(a,N.mobileAllowSearchTerm||"");u&&(u.__filteredOrders=m,u.__allOrders=a,u.__orderKeySet=r),u&&(u.dataset.bound||(u.dataset.bound="1",u.addEventListener("click",e=>{if(e.target.closest("#mobileSendCard")&&(e.preventDefault(),e.stopPropagation()),e.target.closest("input")||e.target.closest("button")||e.target.closest("textarea"))return;const t=e.target.closest(".mobileSendRow");if(!t)return;const n=t.dataset.k;if(!n)return;e.preventDefault(),e.stopPropagation();const o=bn(),i=!o.has(n);i?o.add(n):o.delete(n),hn(),t.classList.toggle("selected",i);const s=t.querySelector(".mobileSendToggle");s&&s.setAttribute("aria-checked",i?"true":"false"),so(u.__allOrders||a,u.__orderKeySet||r)})));const p=U("btnAllowSelectAll");p&&(p.onclick=()=>{const e=bn(),t=u&&Array.isArray(u.__filteredOrders)?u.__filteredOrders:m;for(const n of t)e.add(n.__k||n.stableKey||je(n));hn();const n=lo(u?.__allOrders||a,N.mobileAllowSearchTerm||"");u&&(u.__filteredOrders=n.filteredOrders),so(u?.__allOrders||a,u?.__orderKeySet||r)});const g=U("btnAllowClear");g&&(g.onclick=()=>{const e=bn(),t=u&&Array.isArray(u.__filteredOrders)?u.__filteredOrders:m;for(const n of t)e.delete(n.__k||n.stableKey||je(n));hn();const n=lo(u?.__allOrders||a,N.mobileAllowSearchTerm||"");u&&(u.__filteredOrders=n.filteredOrders),so(u?.__allOrders||a,u?.__orderKeySet||r)});const f=U("btnSaveMobileAllow");f&&(f.disabled="saving"===s,f.onclick=()=>async function(){if(!N.user||!N.user.isAdmin)return void Ve("Solo admin","Non hai i permessi per inviare ordini al mobile.");if(!N.firebase.ok)return void Ve("Connessione mancante","Firebase non disponibile.");const e=N.firebase.api,t=gn(e,N.firebase.db),n=Array.from(bn());N.mobileAllowSaveState="saving",Eo();try{await e.setDoc(t,{keys:n,updatedAt:e.serverTimestamp(),updatedBy:N.user.email||N.user.fullName||""},{merge:!0}),N.mobileAllowSaveState="idle",N.mobileAllowDirty=!1,N.mobileAllowlist.error="",N.mobileAllowlist.lastError="",N.mobileAllowlist.keys=new Set(n),N.mobileAllowSelection=new Set(n),globalThis.__allowCommitted=new Set(n),globalThis.__ALLOW_KEYS__=new Set(n),globalThis.__allowDraft=new Set(n),globalThis.__allowDraftDirty=!1,globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:""},Ve("Salvato ","Ordini inviati a mobile aggiornati.")}catch(e){console.warn("save allowlist error",e),N.mobileAllowSaveState="error";const t=e?.code||"",n=e?.message||String(e),o=t?`${t}`:n;N.mobileAllowlist.error=o,N.mobileAllowlist.lastError=o,globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:o},Ve("Salvataggio bloccato",`${o||"Errore sconosciuto"}. Controlla le regole Firestore.`)}Eo()}());const b=U("btnResetMobileAllow");if(b){const e="saving"===l.status;b.textContent=c?"Conferma reset":"Reset invio mobile",b.disabled=e,b.dataset.bound||(b.dataset.bound="1",b.onclick=()=>Ln())}const h=U("mobileAllowResetStatus");if(h){h.className="saveBadge";const e=l.status||"idle";if("success"===e)h.classList.add("live"),h.textContent="Reset completato ";else if("error"===e){h.classList.add("error");const e=l.lastError||"";h.textContent="Reset non consentito"+(e?` (${e})`:"")}else h.textContent="saving"===e?"Reset in corso":c?"Premi ancora per confermare":"Pronto al reset"}}function uo(e){let t=0,n=!1;for(const o of e||[]){const e=o?.totalDoc,i=Number.isFinite(e)?Number(e):Ae(e);Number.isFinite(i)&&(t+=i,n=!0)}return n?t:null}function mo(){const e=U("fatValue"),t=U("fatSubtitle");if(!e)return;const n=Boolean(N.user&&N.user.isAdmin),o=window.matchMedia("(min-width: 980px)").matches,i=n||o,a=function(){try{if(null!=N.fatturatoLordo&&Number.isFinite(N.fatturatoLordo))return N.fatturatoLordo;if(null==N.fatturatoLordo&&N.docs&&N.docs.length){const e=uo(N.docs);if(null!=e)return N.fatturatoLordo=e,e}const e=U("fatValue");if(e&&e.dataset&&e.dataset.value){const t=Ae(e.dataset.value);if(null!=t)return t}const t=Ae(localStorage.getItem(u));if(null!=t)return t}catch(e){}return null}(),r=Number.isFinite(a)?Number(a):Ae(a);if(N.fatturatoLordo=r,null!=r){e.dataset.value=String(r);try{localStorage.setItem(u,String(r))}catch(e){}}else delete e.dataset.value;const s=null!=r?new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(r):"Dati non disponibili";i?(e.classList.add("reveal"),e.classList.remove("blur"),e.textContent=s,t&&(t.textContent=n?"Fatturato lordo visibile agli amministratori ovunque.":"Fatturato lordo visibile su schermi larghi.")):(e.classList.add("blur"),e.classList.contains("reveal")?e.textContent=s:e.textContent=" ",t&&(t.textContent="Tocca per mettere a fuoco il fatturato lordo."))}function po(e){try{const t=localStorage.getItem("ORDER_NOTE_OVERRIDES")||"";if(t){const n=JSON.parse(t),o=e.orderNo||e.number||"";if(o&&n&&n[o])return n[o]}}catch(e){}return e.note||e.comment||e.internalNote||""}function go(e){const t=_e(e||"");if(!t)return null;const n={gennaio:0,febbraio:1,marzo:2,aprile:3,maggio:4,giugno:5,luglio:6,agosto:7,settembre:8,ottobre:9,novembre:10,dicembre:11};let o=t.match(/(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)(?:\s+(\d{4}))?/);if(o){const e=parseInt(o[1],10),t=n[o[2]],i=o[3]?parseInt(o[3],10):(new Date).getFullYear();if(!isNaN(e)&&null!=t)return new Date(i,t,e)}if(o=t.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/),o){const e=parseInt(o[1],10),t=parseInt(o[2],10)-1;let n=o[3]?parseInt(o[3],10):(new Date).getFullYear();if(n<100&&(n=2e3+n),!isNaN(e)&&t>=0)return new Date(n,t,e)}return null}function fo(e){if(!e)return null;const t=new Date,n=new Date(t.toLocaleString("en-US",{timeZone:"Europe/Rome"})),o=new Date(e.toLocaleString("en-US",{timeZone:"Europe/Rome"}));return Math.floor((o-n)/864e5)}function bo(e){const t=_e(e||"");if(!t)return{priority:"normal",visible:!0};if(/da\s*fare\s*oggi/.test(t))return{priority:"today",visible:!0,reason:"Da fare oggi"};const n=go(t);if(n){const e=fo(n);if(null!=e){const t=new Date(n.toLocaleString("en-US",{timeZone:"Europe/Rome"}));if(e>=2)return{priority:"scheduled",visible:!1,date:t};if(e>=1)return{priority:"scheduled",visible:!0,date:t,reason:"Da iniziare domani"};if(e>=0)return{priority:"scheduled",visible:!0,date:t,reason:"Da iniziare oggi"}}}return{priority:"normal",visible:!0}}function ho(e){return Wn(e)}function yo(e){const t=pt({qty:e?.qty,um:e?.um,uom:e?.uom,unitaMisura:e?.unitaMisura,unit:e?.unit,measure:e?.measure,packKg:ho(e),desc:e?.desc||""});if(Number.isFinite(t)&&t>0)return t;const n=Number(e?.lineKg);return Number.isFinite(n)&&n>0?n:0}function vo(e,t){if(!e||null==t)return null;if(e[t])return e[t];if(e[String(t)])return e[String(t)];const n=Object.keys(e||{}).find(e=>Math.abs(Number(e||0)-Number(t))<.011);return n?e[n]:null}function wo(e,t){const n=_e(e.code||"").replace(/\s+/g,""),o=Number(t);if(n&&E.byCode[n]){const e=vo(E.byCode[n].packs,t);if(e)return{bom:e,source:"code"}}const i=_e(e.desc||"").replace(/\bkg\b/g,"").replace(/\b\d+(?:[\.,]\d+)?\b/g,"").replace(/\s+/g,"").trim();if(i&&E.byName[i]){const e=vo(E.byName[i].packs,t);if(e)return{bom:e,source:"name"}}const a=vo(E.defaultByPackKg,t);return a?{bom:a,source:"default"}:Number.isFinite(o)?{bom:null,source:"pack_unsupported"}:{bom:null,source:"not_found"}}function _o(e){const t=Number(e||0);return Number.isFinite(t)?`${t.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1")} kg`:""}function So(e,t,n){if(!t)return;const o=Number(e.get(t)||0),i=Number(n||0);Number.isFinite(i)&&e.set(t,o+i)}function Ao(e){return String(null==e?"":e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))}function To(e){try{const t=Number(String(e||"").split("_")[0]);return Number.isFinite(t)?t:0}catch(e){return 0}}function Lo(){const e=U("completedList"),t=U("completedEmpty"),n=U("completedBadge");if(!e||!t||!n)return;const o=Array.isArray(N.history)?N.history.slice():[];o.sort((e,t)=>To(t.id||t.at||0)-To(e.id||e.at||0));const i=o.filter(e=>e&&(e.orderNo||e.customer||e.operator)).slice(0,10);if(n.textContent=i.length?String(i.length):"0",e.innerHTML="",!i.length)return void(t.style.display="block");t.style.display="none";const a=Boolean(N.user&&N.user.isAdmin);let r=document.getElementById("completedAdmin");if(a){r||(r=document.createElement("div"),r.id="completedAdmin",r.style.margin="10px 0",r.innerHTML='<button class="btn bad" id="btnClearCompleted" style="width:100%;">Cancella tutti conclusi</button>',e.parentElement.appendChild(r));const t=r.querySelector("#btnClearCompleted");t&&(t.onclick=()=>async function(){if(N.firebase.ok&&N.user&&N.user.isAdmin&&confirm("Eliminare tutti gli ordini conclusi?")&&confirm("Conferma finale: loperazione  irreversibile."))try{const e=N.firebase.api,t=N.firebase.db,n=await e.getDocs(e.collection(t,"powderProdHistory"));for(const t of n.docs)await e.deleteDoc(t.ref);N.history=[],N.historyReady=!0,Lo(),Mo(),Wo(),Ve("Cancellati","Ordini conclusi rimossi.")}catch(e){console.warn(e),Ve("Errore","Impossibile cancellare i conclusi.")}}()),r.style.display="block"}else r&&(r.style.display="none");let s=new Set,l=new Set;try{const{partial:e,full:t}=Kn();for(const t of e)s.add(String(t.orderNo));for(const e of t)l.add(String(e.orderNo))}catch(e){}for(const t of i){const n=t.orderNo?String(t.orderNo):"",o=t.customer||"",i=t.operator||t.operatorName||t.userName||""||"Operatore",a=t.at?ge(t.at):"",r=(()=>{try{if(Array.isArray(t.perLine)&&t.perLine.length)return Math.round(t.perLine.reduce((e,t)=>e+(Number(t.producedKg||0)||0),0))}catch(e){}return null})();let c="Produzione registrata";l.has(n)?c="Ordine concluso":s.has(n)&&(c="Ordine parzialmente concluso");const d=document.createElement("div");d.className="item completedItem rowPress",d.innerHTML=`\n      <div class="top">\n        <div>\n          <div class="name ellipsis" title="Ordine n. ${Ao(n)} ${o?` ${Ao(o)}`:""}">Ordine n. ${Ao(n)} ${o?` ${Ao(o)}`:""}</div>\n          <div class="completedMeta">\n            <div><b>${Ao(i)}</b></div>\n            ${a?`<div class="kv">${Ao(a)}</div>`:""}\n            ${null!=r?`<div class="kv"><b>${r}</b> kg</div>`:""}\n            <div>${Ao(c)}</div>\n          </div>\n        </div>\n        <div class="badge">Dettagli</div>\n      </div>\n    `,d.addEventListener("click",()=>Co(t.id)),e.appendChild(d)}}function Co(e){const t=(N.history||[]).find(t=>t&&t.id===e);if(!t)return;const n=t.orderNo?String(t.orderNo):"",o=t.customer||"",i=t.operator||t.operatorName||"Operatore";U("histTitle").textContent=`Ordine n. ${n}${o?`  ${o}`:""}`,U("histSub").textContent=`Operatore: ${i}${t.at?`  ${ge(t.at)}`:""}`;const a=U("histBody"),r=Array.isArray(t.perLine)?t.perLine:[],s=r.length?r.map(e=>`\n    <div class="item" style="margin-bottom:10px;">\n      <div class="top">\n        <div>\n          <div class="name">${Ao(e.desc||"")}</div>\n          <div class="muted">Pianificati: <b>${Ao(String(e.plannedKg??""))}</b> kg  Prodotti: <b>${Ao(String(e.producedKg??""))}</b> kg</div>\n        </div>\n        <div class="badge">${Ao(String(e.qty??""))} ${Ao(String(e.um??""))}</div>\n      </div>\n      ${e.code?`<div class="muted" style="margin-top:6px;">Codice: <b>${Ao(String(e.code))}</b></div>`:""}\n    </div>\n  `).join(""):'<div class="muted">Nessun dettaglio righe disponibile.</div>',l=t.signature?`<div style="margin-top:14px;"><div class="muted" style="margin-bottom:6px;">Firma</div><img src="${t.signature}" alt="Firma" style="width:100%; max-width:520px; border:1px solid var(--stroke); border-radius:14px; background:#fff;"></div>`:"";a.innerHTML=`\n    <div class="muted">Stato: <b>${Ao((()=>{try{const{partial:e,full:t}=Kn(),o=new Set(e.map(e=>String(e.orderNo)));if(new Set(t.map(e=>String(e.orderNo))).has(n))return"Ordine concluso";if(o.has(n))return"Ordine parzialmente concluso"}catch(e){}return"Storico"})())}</b></div>\n    <div style="height:12px"></div>\n    ${s}\n    ${l}\n  `,U("histModal").classList.add("show"),it()}function Eo(){q.firstRenderDone||ce("");let e=0,t=null,n=null;_t();try{const e=U("homeWelcome");e&&N.user&&(e.textContent=`Benvenuto, ${N.user.fullName}`)}catch(e){}const o=qn();ve(o.baseOrders),ye();const i=o.orders,a=function(e){const t=[];for(const n of e||[])for(const e of n.lines||[])t.push(e);let n=0,o=0,i=0,a=0,r=0,s=0;const l=[];for(const e of t){const t=jn(e);Number.isFinite(t)&&(n+=t);const c=Wn(e);if(Number.isFinite(t)&&t>0){const e=ut(c,{strict:!0});.5===e?o+=t:1===e?i+=t:5===e?a+=t:10===e?r+=t:s+=t}l.length<5&&l.push({rawQty:e.qty,parsedQty:Te(e.qty)})}const c=o+i,d=a+r,u=Math.round(10*c),m=Math.round(4*d),p={kg0_5:o,kg1:i,kg5:a,kg10:r,kgTotF480:c,kgTotF830:d,kgUnknown:s,filmF480Gr:u,filmF830Gr:m,bobineF480:Math.ceil(u/25e3),bobineF830:Math.ceil(m/4e4)};return{totalKg:n,lineCount:t.length,samples:l,labels:null,bobine:p}}(i);U("kPowderLines").textContent=a.lineCount?a.lineCount.toString():"0",Le(a.totalKg);const r=U("kPowderMeta");r&&(r.textContent=`Calcolato su ${a.lineCount} righe visibili`);const s=a.bobine,l=U("kBobineF480"),c=U("kBobineF830"),d=U("kBobineF480Meta"),u=U("kBobineF830Meta"),m=U("kBobineUnknown"),p=e=>Number.isFinite(e)?Math.max(0,Math.round(e)).toLocaleString("it-IT"):"0",g=e=>{const t=Number(e||0);return Number.isFinite(t)?t.toLocaleString("it-IT",{minimumFractionDigits:0,maximumFractionDigits:1}):"0"},f=e=>{const t=Number(e||0);return Number.isFinite(t)?Math.round(t).toLocaleString("it-IT"):"0"};if(l&&c)if(s){const e=Number.isFinite(s.bobineF480),t=Number.isFinite(s.bobineF830);if(l.textContent=e&&null!=s.bobineF480?p(s.bobineF480):"",c.textContent=t&&null!=s.bobineF830?p(s.bobineF830):"",d&&(d.textContent=e?"":"Stima non disponibile",e&&(d.innerHTML=`Kg 0,5: ${g(s.kg0_5)}  Kg 1: ${g(s.kg1)}<br>Tot F480: ${g(s.kgTotF480)} kg<br>Film: ${f(s.filmF480Gr)} g  Bobina: 25 kg`)),u&&(u.textContent=t?"":"Stima non disponibile",t&&(u.innerHTML=`Kg 5: ${g(s.kg5)}  Kg 10: ${g(s.kg10)}<br>Tot F830: ${g(s.kgTotF830)} kg<br>Film: ${f(s.filmF830Gr)} g  Bobina: 40 kg`)),m){const e=Number(s.kgUnknown||0);e>0?(m.style.display="block",m.textContent=`Non classificati: ${g(e)} kg`):m.style.display="none"}}else l.textContent="",c.textContent="",d&&(d.textContent="Stima non disponibile"),u&&(u.textContent="Stima non disponibile"),m&&(m.style.display="none");const b=N.powderOrders||[],h=U("badgeCounts");if(h){const e=Boolean(N.user&&N.user.isAdmin),t=(N.mobileAllowlist,Boolean(globalThis.__ALLOW_LOADED__)),n=Ee();if(!n||e||t){const t=n&&!e?i.length:b.length,o=1===t?"ordine":"ordini";h.textContent=`${t} ${o}`}else h.textContent=" ordini"}const y=b.find(e=>Array.isArray(e.alerts)&&e.alerts.length);if(y){const e=(y.alerts||[])[0]||{},t=(e.desc||e.alertInfo?.label||"").trim(),o=y.number||y.orderNo||"",i=y.customer||"",a=[o,t||i].filter(Boolean).join("|");n=a?a.slice(0,160):null}co(o.baseOrders,o.orderKeySet);const v=U("mobileAllowInfo");if(v){const e=Ee()&&N.user&&!(N.user&&N.user.isAdmin);if(v.style.display=e?"block":"none",e){const e=N.mobileAllowlist||{},t=Boolean(globalThis.__ALLOW_LOADED__),n=i.length;if(t&&!e.docExists)v.textContent="Assegnazioni non configurate";else if(t&&0===n)v.textContent="Nessun ordine assegnato dalladmin";else{v.innerHTML=`Ordini assegnati: <span id="mobileAllowCount">${n}</span><span id="mobileAllowMsg" style="margin-left:6px; color:var(--muted); font-weight:800;"></span>`;const e=U("mobileAllowCount"),o=U("mobileAllowMsg");e&&(e.textContent=String(n)),o&&(o.textContent=""),t&&0===n&&o&&(o.textContent="Assegnazioni attive: nessun ordine")}}}let w="Ordini: ";N.xmlModifiedTime?w+=`aggiornati ${N.xmlModifiedTime}`:N.lastFetchAt?w+=`aggiornati ${ge(N.lastFetchAt)}`:w+="in sincronizzazione",U("txtXmlTime").textContent=w,mo();try{const{partial:t}=Kn();e=t.length,N.partialOrders=t;const n=U("partialBanner");if(n)if(t.length){n.dataset.display="flex",n.style.display="flex",requestAnimationFrame(()=>n.classList.add("show"));const e=t.length;U("partialBannerTitle").textContent=`Ci sono ${e} ordini parzialmente conclusi in corso`,U("partialBannerSub").textContent="Apri Produzione per completare le righe rimanenti."}else n.classList.remove("show"),setTimeout(()=>{n.style.display="none"},180);U("partialModal")?.classList.contains("show")&&li()}catch(e){}try{Lo()}catch(e){}const _=N.activeProductions||[],S=U("prodStrip");if(_.length){S.style.display="block",U("prodCount").textContent=String(_.length);const e=_.slice(0,6).map(e=>`${e.operator||"Operatore"}: ${e.customer||"Cliente"}  Ordine n. ${e.orderNo||""}`).join("     ")+(_.length>6?"      ...":"");U("prodMarquee").textContent=e,t=`${_.length}|${e}`.slice(0,160);const n=_.map(e=>Rn(e)),o=n.length?Math.max(...n):0,i=Math.max(0,120-120*Math.min(1,o));S.style.background=`hsla(${i}, 80%, 45%, .22)`,S.style.borderColor=`hsla(${i}, 80%, 55%, .35)`}else S.style.display="none",t=null;try{const e=U("btnGoProd");if(e){const t=(N.user?.fullName||N.operator||"").toLowerCase(),n=t&&_.some(e=>String(e.operator||"").toLowerCase()===t);e.textContent=n?"APRI PRODUZIONE IN CORSO":"VAI IN PRODUZIONE",e.setAttribute("aria-label",e.textContent)}}catch(e){}Mo(),Wo(),Po(),ko(),Oi(),Ee()&&function({partialCount:e=0,prodKey:t=null,alertKey:n=null}={}){if(!Ee())return;const o=globalThis.__MOBILE_EVENTS__;null!==o.prevPartialCount&&e>o.prevPartialCount&&De("partial"),o.prevPartialCount=e,t?(null!==o.prevProdKey&&t!==o.prevProdKey&&De("event"),o.prevProdKey=t):o.prevProdKey=t,n?(null!==o.prevAlertKey&&n!==o.prevAlertKey&&De("event"),o.prevAlertKey=n):o.prevAlertKey=n}({partialCount:e,prodKey:t,alertKey:n}),q.firstRenderDone||ce("")}function No(){const e=U("statsList"),t=U("statsBadge");if(!t)return;const n=oe(),o=n?ie():[],i=n?{concludedCountTotal:o.length,concludedKgTotal:o.reduce((e,t)=>e+Number(t.kg||0),0),updatedAt:null,updatedBy:""}:X(),a=e=>Number.isFinite(e)?Math.max(0,Math.round(e)).toLocaleString("it-IT"):"";if(t.textContent=a(i.concludedCountTotal),!e||!e.parentElement)return;let r=document.getElementById("globalStatsSummary");r||(r=document.createElement("div"),r.id="globalStatsSummary",r.style.padding="12px",r.style.margin="0 0 12px",r.style.borderRadius="14px",r.style.border="1px solid var(--stroke)",r.style.background="rgba(0,0,0,.02)",e.parentElement.insertBefore(r,e));const s=n?"Dati storici eliminati su questo dispositivo.":"Cumulativo totale, indipendente dai record eliminati.";var l;r.innerHTML=`\n      <div class="stepTitle" style="margin:0 0 6px 0;">Statistiche globali</div>\n      <div class="muted" style="margin-bottom:8px;">${s}</div>\n      <div style="display:flex; align-items:center; justify-content:space-between; font-weight:800;">\n        <div class="muted" style="font-weight:800;">Ordini conclusi</div>\n        <div>${a(i.concludedCountTotal)}</div>\n      </div>\n      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px; font-weight:800;">\n        <div class="muted" style="font-weight:800;">Kg totali</div>\n        <div>${l=i.concludedKgTotal,Number.isFinite(l)?`${Math.round(Math.max(0,Number(l)||0)).toLocaleString("it-IT")} kg`:""}</div>\n      </div>\n    `}function xo(e,t={}){const n=U("operatorLeaderboard");if(!n)return;const o=!1!==t.canSeeStats,i=t.rangeLabel||"Questo mese",a=Array.isArray(e)?e:[];let r="kg"===(t.sortOverride||function(){try{return"kg"===localStorage.getItem(T)?"kg":"orders"}catch(e){return"orders"}}())?"kg":"orders";if(!o)return void(n.innerHTML='<div class="opLbCard"><div class="opLbEmpty">Statistiche complete riservate agli amministratori.</div></div>');n.innerHTML=`\n      <div class="opLbCard">\n        <div class="opLbHead">\n          <div>\n            <div class="opLbTitle">Classifica operatori</div>\n            <div class="opLbMeta">${Ao(i)}  Ordinata per ${"kg"===r?"kg prodotti":"ordini conclusi"}</div>\n          </div>\n          <div class="opLbToggles" role="group" aria-label="Ordina classifica operatori">\n            <button class="opLbToggleBtn" data-sort="orders" type="button">Ordini</button>\n            <button class="opLbToggleBtn" data-sort="kg" type="button">Kg</button>\n          </div>\n        </div>\n        <div class="opLbList" id="opLbList"></div>\n      </div>`;const s=n.querySelector("#opLbList"),l=n.querySelector(".opLbMeta"),c=Array.from(n.querySelectorAll(".opLbToggleBtn")),d=e=>{if(r="kg"===e?"kg":"orders",function(e){try{localStorage.setItem(T,e)}catch(e){}}(r),c.forEach(e=>{const t=e.dataset.sort===r;e.classList.toggle("active",t),t?e.setAttribute("aria-pressed","true"):e.setAttribute("aria-pressed","false")}),l&&(l.textContent=`${i}  Ordinata per ${"kg"===r?"kg prodotti":"ordini conclusi"}`),!s)return;const t=a.slice().sort((e,t)=>{if("kg"===r){const n=(t.kg||0)-(e.kg||0);return 0!==n?n:(t.orders||0)-(e.orders||0)}const n=(t.orders||0)-(e.orders||0);return 0!==n?n:(t.kg||0)-(e.kg||0)});if(!t.length)return void(s.innerHTML='<div class="opLbEmpty">Nessun dato disponibile.</div>');const n=t.map((e,t)=>{const n=t+1,o=n<=3?` top${n}`:"",i=Ao(e.operatorLabel||"Sconosciuto"),a=Ho(e.kg),r=Uo(e.orders);return`\n          <div class="opLbRow${o}">\n            <div class="opLbRank">#${n}</div>\n            <div>\n              <div class="opLbName">${i}</div>\n              <div class="opLbSub">Attivit: ${Uo(e.eventsCount)}</div>\n            </div>\n            <div class="opLbMetrics">\n              <div class="opLbMetric">\n                <div class="lbl">Kg mese</div>\n                <div class="val">${a}</div>\n              </div>\n              <div class="opLbMetric">\n                <div class="lbl">Ordini mese</div>\n                <div class="val">${r}</div>\n              </div>\n            </div>\n          </div>`}).join("");s.innerHTML=n};c.forEach(e=>{e.addEventListener("click",()=>{d("kg"===e.dataset.sort?"kg":"orders")})}),d(r)}function $o(e){switch(String(e||"")){case"open":return"Apertura app";case"start":return"Avvio ordine";case"close":return"Chiusura ordine";case"issue":return"Segnalazione problema";case"absence":return"Programmazione assenza";default:return"Evento"}}function ko(){const e=U("actionLogCard"),t=U("actionLogList"),n=U("actionLogBadge"),o=U("actionLogEmpty");if(!e)return;const i=Boolean(N.user&&N.user.isAdmin);if(e.style.display=i?"":"none",!i)return;const{entries:a=[],ready:r,error:s}=N.actionLogs||{},l=U("actionLogFilterUser"),c=U("actionLogFilterType"),d=U("actionLogClear"),u=Array.from(new Set(a.map(e=>e.actor||"").filter(Boolean))).sort((e,t)=>e.localeCompare(t,"it")),m=Array.from(new Set(a.map(e=>e.type||"").filter(Boolean))),p=l?.value||"all",g=c?.value||"all";if(l&&!l.dataset.bound&&(l.dataset.bound="1",l.addEventListener("change",ko)),c&&!c.dataset.bound&&(c.dataset.bound="1",c.addEventListener("change",ko)),d&&!d.dataset.bound&&(d.dataset.bound="1",d.addEventListener("click",()=>{l&&(l.value="all"),c&&(c.value="all"),ko()})),l){const e=l.value||"all";l.innerHTML=`<option value="all">Tutti</option>${u.map(t=>`<option value="${Ao(t)}"${e===t?" selected":""}>${Ao(t)}</option>`).join("")}`,l.value||(l.value="all")}if(c){const e=c.value||"all";c.innerHTML=`<option value="all">Tutti</option>${m.map(t=>`<option value="${Ao(t)}"${e===t?" selected":""}>${Ao($o(t))}</option>`).join("")}`,c.value||(c.value="all")}if(n){const e=r?String(a.length||0):"";n.textContent=e}if(!t)return;if(!r)return t.innerHTML='<div class="muted">Caricamento registro azioni</div>',void(o&&(o.style.display="none"));if(s)return t.innerHTML=`<div class="alertBanner"><div class="label">${Ao(s)}</div><div class="hint">Controlla permessi o rete.</div></div>`,void(o&&(o.style.display="none"));const f=a.filter(e=>{const t="all"===p||(e.actor||"")===p,n="all"===g||(e.type||"")===g;return t&&n});if(!f.length)return t.innerHTML="",void(o&&(o.style.display="block"));const b=e=>{try{e&&"function"==typeof e.toDate&&(e=e.toDate());const t=e instanceof Date?e:new Date(e);if(Number.isFinite(t.getTime()))return ge(t)}catch(e){}return""},h=document.createDocumentFragment();for(const e of f){const t=document.createElement("div");t.className="logRow";const n=[b(e.createdAt||e.at||e.ts),e.actor?`Da ${Ao(e.actor)}`:""].filter(Boolean),o=e.description||`${e.customer||""} ${e.orderNo?` Ord. ${e.orderNo}`:""}`,i=e.meta||"";t.innerHTML=`\n        <div class="logTitle">${Ao($o(e.type))}</div>\n        <div class="logMeta">${n.map(e=>`<span>${Ao(e)}</span>`).join("")}</div>\n        <div class="logDesc">${Ao(o||"")}</div>\n        ${i?`<div class="logSub">${Ao(i)}</div>`:""}\n      `,h.appendChild(t)}t.innerHTML="",t.appendChild(h),o&&(o.style.display="none")}function Mo(){const e=U("statsList"),t=Boolean(N.user&&N.user.isAdmin||window.matchMedia("(min-width: 980px)").matches),n=ie(),o=function(){const e=Array.isArray(N.history)?N.history:[],t=oe();return t?e.filter(e=>To(e.id||e.at||0)>t):e}(),{start:i,end:a,label:r}=function(){const e=new Date;return{start:new Date(e.getFullYear(),e.getMonth(),1).getTime(),end:new Date(e.getFullYear(),e.getMonth()+1,1).getTime()-1,label:"Questo mese"}}(),s=function(e,t,n){const o=Number(t)||0,i=Number(n)||0,a=new Map;for(const t of Array.isArray(e)?e:[]){const e=ae(t);if(null==e)continue;if(o&&e<o)continue;if(i&&e>i)continue;const n=re(se(t)),r=n?n.toLowerCase():"sconosciuto",s=Number(t?.kg),l=a.get(r)||{operatorLabel:n||"Sconosciuto",orders:0,kg:0,eventsCount:0};l.orders+=1,l.eventsCount+=1,Number.isFinite(s)&&(l.kg+=s),a.set(r,l)}return Array.from(a.values()).map(e=>({...e,kg:Number(e.kg)||0,orders:Number(e.orders)||0,eventsCount:Number(e.eventsCount)||0}))}(o,i,a);xo(s,{canSeeStats:t,rangeLabel:r});const l=U("statsBadge"),c=n.length?Math.max(0,Math.round(n.length||0)).toString():"0";if(l&&(l.textContent=c),!t)return void(e.innerHTML='<div class="muted">Statistiche complete riservate agli amministratori.</div>');No();try{const t="adminStatsBox";let n=document.getElementById(t);N.user&&N.user.isAdmin?n||(n=document.createElement("div"),n.id=t,n.style.marginTop="12px",n.innerHTML='\n            <div class="divider"></div>\n            <div class="stepTitle" style="font-size:14px; margin-top:0;">Admin</div>\n            <button class="btn bad" id="btnClearHistory" style="width:100%;">Elimina dati storici</button>\n            <div class="muted" id="statsClearFeedback" style="margin-top:8px;">Attenzione: operazione irreversibile.</div>\n          ',e.parentElement.appendChild(n)):n&&n.remove()}catch(e){}const d=n,u=oe();if(!d.length){const t=u?'<div class="muted" style="margin-top:6px;">Dati storici eliminati su questo dispositivo.</div>':"";return void(e.innerHTML=`<div class="muted">Nessun dato storico disponibile (in attesa delle prime produzioni).</div>${t}`)}const m=new Map;for(const e of d){const t=e.operator,n=Number(e.kg||0),o=Number(e.durationMs||0),i=m.get(t)||{kg:0,ms:0,n:0};i.kg+=n,i.ms+=o,i.n+=1,m.set(t,i)}const p=Array.from(m.entries()).map(([e,t])=>{const n=t.ms/36e5,o=n>0?t.kg/n:0;return{op:e,...t,speed:o}}).sort((e,t)=>t.kg-e.kg);e.innerHTML="";for(const t of p){const n=document.createElement("div");n.className="item",n.innerHTML=`\n        <div class="top">\n          <div>\n            <div class="name">${t.op}</div>\n            <div class="sub">${t.n} produzioni  Velocit media: ${Math.round(t.speed)} kg/h</div>\n          </div>\n          <div class="badge">${Math.round(t.kg)} kg</div>\n        </div>`,e.appendChild(n)}}function Oo(e){const t="click"===e.type,n="keydown"===e.type&&("Enter"===e.key||" "===e.key);if(!t&&!n)return;const o=(i=e.target,i?.closest?.(".whOverviewRow")?.dataset?.key||"");var i;if(o){if(n)e.preventDefault();else if(0===e.detail)return;Fo(o)}}function Do(e,t){return e?`${e}${t}`:t}function Bo(e,t){return e?e.querySelector(t):null}function Io(e,t,n,o=""){if(!e||!t)return;const{orderDetails:i,sortedDetails:a,overviewItems:r,visibleItems:s,needsSeeAll:l,filteredTotals:c,applied:d,options:u}=n;t.textContent=`${a.length||0}`,t.title=`Ordini filtrati: ${a.length} / Totale: ${i.length}`;const m=document.activeElement,p=Do(o,"magFilterOrder"),g=!(!m||!e.contains(m)||m.id!==p),f=Bo(e,`#${Do(o,"whOverview")}`),b=f?f.scrollTop:0,h=N.xmlModifiedTime||(N.lastFetchAt?ge(N.lastFetchAt):""),y=(c.warnings?.length||0)+(c.nonConfig?.length||0),v=`<div class="whKpiRow">\n        <div class="whKpi"><span class="v">${r.length||0}</span><span>Articoli monitorati</span></div>\n        <div class="whKpi"><span class="v">${y}</span><span>Criticit</span></div>\n        <div class="whKpi"><span class="v">${Ao(h)}</span><span>Aggiornato</span></div>\n      </div>`,w=s.length?s.map(e=>{const t=(ro(e.label,e)||"").trim(),n=t?`<div class="calcHint">(${Ao(t)})</div>`:"";return`\n        <button class="whOverviewRow rowPress" data-key="${Ao(e.key)}" type="button">\n          <div style="flex:1; min-width:0;">\n            <div class="whOverviewName">${Ao(e.label)}</div>\n            ${n}\n            ${e.subtitle?`<div class="whOverviewSub">${Ao(e.subtitle)}</div>`:""}\n          </div>\n          <div class="whOverviewVal">${oo(e)}</div>\n        </button>`}).join(""):`<div class="muted">${i.length?"Nessun ordine corrisponde ai filtri.":"Nessun ordine disponibile."}</div>`,_=(()=>{const e=[];return(c.warnings||[]).length&&e.push(`<div class="badge" style="background:rgba(255,159,10,.14); border-color:rgba(255,159,10,.3);">Solleciti sacchi: ${c.warnings.length}</div>`),(c.nonConfig||[]).length&&e.push(`<div class="badge" style="background:rgba(255,149,0,.12); border-color:rgba(255,149,0,.3);">Distinte mancanti: ${c.nonConfig.length}</div>`),e.join("")})(),S=Boolean(d.customer||d.order||d.item),A=Do(o,"magFilterCustomer"),T=Do(o,"magFilterOrder"),L=Do(o,"magFilterItem"),C=Do(o,"magFiltersReset"),E=Do(o,"magFilterChips"),x=Do(o,"magResultBadge"),$=Do(o,"whOverview"),k=Do(o,"whSeeAll"),M=Do(o,"whScrollTop"),O=qe(d.order),D=Array.isArray(u.orders)?u.orders.slice():[],B=d.order&&!D.some(e=>qe(e.value)===O)?[{value:d.order,label:d.order},...D]:D,I=`<div class="magFilterBar">\n      <div class="magFilterField">\n        <label class="magFilterLabel" for="${A}">Cliente</label>\n        <select id="${A}" class="magFilterInput">\n          <option value="">Tutti</option>\n          ${u.customers.map(e=>`<option value="${Ao(e)}"${qe(e)===qe(d.customer)?" selected":""}>${Ao(e)}</option>`).join("")}\n        </select>\n      </div>\n      <div class="magFilterField">\n        <label class="magFilterLabel" for="${T}">Ordine</label>\n        <select id="${T}" class="magFilterInput">\n          <option value="">Tutti</option>\n          ${B.map(e=>`<option value="${Ao(e.value||"")}"${qe(e.value)===O?" selected":""}>${Ao(e.label||e.value||"")}</option>`).join("")}\n        </select>\n      </div>\n      <div class="magFilterField">\n        <label class="magFilterLabel" for="${L}">Articolo (imballaggio)</label>\n        <select id="${L}" class="magFilterInput">\n          <option value="">Tutti</option>\n          ${u.items.map(e=>`<option value="${Ao(e)}"${qe(e)===qe(d.item)?" selected":""}>${Ao(e)}</option>`).join("")}\n        </select>\n      </div>\n      <div class="magFilterActions">\n        <div class="magResultBadge" id="${x}">Risultati: ${r.length}  Ordini: ${a.length}</div>\n        <button class="btn ghost" id="${C}" type="button"${S?"":' style="opacity:.8;"'}>Pulisci filtri</button>\n      </div>\n    </div>\n    <div class="magFilterChips" id="${E}"></div>`;e.innerHTML=`<div class="magSimple">\n      <div class="magTitle">Panoramica magazzino</div>\n      ${I}\n      ${v}\n      ${_?`<div class="whCritRow">${_}</div>`:""}\n      <div id="${$}" class="whOverview rowsScroll">${w}</div>\n      <div class="row2 whActions" style="margin-top:10px;">\n        <button class="btn ghost" id="${k}" type="button"${l?"":' style="opacity:.65;"'}>Apri elenco completo</button>\n        <button class="btn" type="button" id="${M}">Torna in cima</button>\n      </div>\n    </div>`,function(e){const t=e||U("warehouseBody");t&&"true"!==t.dataset.whDelegated&&(t.dataset.whDelegated="true",t.addEventListener("click",Oo),t.addEventListener("keydown",Oo))}(e);const P=Bo(e,`#${k}`);P&&P.addEventListener("click",()=>Fo(to));const z=Bo(e,`#${M}`);z&&z.addEventListener("click",()=>{const t=Bo(e,`#${$}`);t&&t.scrollTo({top:0,behavior:"smooth"})});const F=Bo(e,`#${A}`);F&&(F.onchange=e=>{const t=e.target.value||"",n=N.magFilters||{customer:"",order:"",item:""},o=Jn(eo(i,{...n,customer:t,order:"",item:""}).filteredOrders||[]),a=o.items||[],r=o.orders||[],s=qe(n.item||""),l=qe(n.order||""),c=!s||a.some(e=>qe(e)===s),d=!l||r.some(e=>qe(e.value)===l),u={customer:t};c||(u.item=""),d||(u.order=""),Zn(u),Po()});const R=Bo(e,`#${T}`);R&&(R.value=d.order||"",R.onchange=e=>{Zn({order:e.target.value||""}),Po()});const K=Bo(e,`#${L}`);K&&(K.onchange=e=>{Zn({item:e.target.value||""}),Po()});const H=Bo(e,`#${C}`);H&&H.addEventListener("click",()=>{N.magFilters={customer:"",order:"",item:""},Yn(N.magFilters),Po()}),function(e,t){if(!e)return;const n=[],o={customer:"",order:"",item:"",...t||{}},i=(e,t,o)=>{o&&n.push(`<button class="magChip" data-key="${e}" type="button">${Ao(t)}: ${Ao(o)} <span class="x" aria-hidden="true"></span></button>`)};i("customer","Cliente",o.customer),i("order","Ordine",o.order),i("item","Articolo",o.item),e.innerHTML=n.join(""),e.style.display=n.length?"flex":"none",n.length&&e.querySelectorAll(".magChip").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.key;t&&(Zn({[t]:""}),Po())})})}(Bo(e,`#${E}`),d);const q=Bo(e,`#${x}`);q&&(q.textContent=`Risultati: ${r.length}  Ordini: ${a.length}`);const W=Bo(e,`#${$}`);if(W&&"number"==typeof b&&(W.scrollTop=b),g){const t=Bo(e,`#${T}`);if(t)try{t.focus({preventScroll:!0})}catch(e){try{t.focus()}catch(e){}}}}function Po(e=!1){const t=U("warehouseCard"),n=U("warehouseBody"),o=U("warehouseBadge");if(!t||!n||!o)return;const i=window.matchMedia("(min-width: 1025px)").matches,a=Ee(),r=Boolean(i||a);if(t.style.display=r?"block":"none",document.body.classList.toggle("desktopV2",Boolean(i)),!r)return n.innerHTML="",void(o.textContent="");const{orderDetails:s}=function(){const{orders:e}=qn(),t={productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[],linesTotal:0,linesOk:0,linesWarn:0,linesNonConfig:0},n=[];for(const o of e){const e={productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[],linesTotal:0,linesOk:0,linesWarn:0,linesNonConfig:0},i=o.lines.some(e=>"active"===e.status)?"in_produzione":o.partialInfo?"parziale":"da_fare";for(const n of o.lines||[]){const i=yo(n),a=Number.isFinite(i)&&i>0;a&&(e.linesTotal++,t.linesTotal++),a&&(e.productKg+=i,t.productKg+=i);const r=ho(n),{bom:s,source:l}=wo(n,r)||{};if(!r||r<=0||!s){const s="pack_unsupported"===l?"Non configurato (packKg non supportato)":"",c={desc:n.desc,customer:o.customer,orderNo:o.orderNo||o.number,qtyKg:i,packKg:r,code:n.code||"",note:s};a&&(e.linesNonConfig++,t.linesNonConfig++),e.nonConfig.push(c),t.nonConfig.push(c);continue}const c=Number(r)?i/r:0;let d=!1;if(!Number.isFinite(c)||c<=0){const s={desc:n.desc,customer:o.customer,orderNo:o.orderNo||o.number,qtyKg:i,packKg:r,code:n.code||""};a&&(e.linesNonConfig++,t.linesNonConfig++),e.nonConfig.push(s),t.nonConfig.push(s);continue}if(Math.abs(c-Math.round(c))>.01){d=!0,a&&(e.linesWarn++,t.linesWarn++);const o=`${n.desc}  ${c.toFixed(2)} sacchi da ${r} kg`;e.warnings.push(o),t.warnings.push(o)}if(a&&!d&&(e.linesOk++,t.linesOk++),s.bobine)for(const[n,o]of Object.entries(s.bobine)){const i=Number(o&&null!=o.perBag?o.perBag:o)||0,a="kg"===(o&&o.unit||"g")?1e3*i:i;So(e.bobine,n,a*c),So(t.bobine,n,a*c)}if(Number(s.etichettePerBag)){const n=Number(s.etichettePerBag||0)*c;e.etichette+=n,t.etichette+=n}if(s.scatole)for(const[n,o]of Object.entries(s.scatole)){const i=Number(o||0)*c;So(e.scatole,n,i),So(t.scatole,n,i)}if(s.divisori)for(const[n,o]of Object.entries(s.divisori)){const i=Number(o||0)*c;So(e.divisori,n,i),So(t.divisori,n,i)}if(s.altri)for(const[n,o]of Object.entries(s.altri)){const i=Number(o||0)*c;So(e.altri,n,i),So(t.altri,n,i)}}n.push({order:o,comp:e,status:i})}return{totals:t,orderDetails:n}}(),l=N.xmlModifiedTime||(N.lastFetchAt?ge(N.lastFetchAt):""),c=eo(s,{customer:"",order:"",item:""});!function(e,t,n){if(!e||!t)return;const{orderDetails:o,sortedDetails:i,filteredTotals:a,updatedTxt:r,overviewItems:s}=n||{},l=(o||[]).length,c=(i||[]).length;t.textContent=`${c||0}`,t.title=`Ordini: ${c} / Totale: ${l}`;const d=Number(null!=(a&&a.linesWarn)?a.linesWarn:a?.warnings?.length||0)||0,u=Number(null!=(a&&a.linesNonConfig)?a.linesNonConfig:a?.nonConfig?.length||0)||0,m=Number(null!=(a&&a.linesTotal)?a.linesTotal:d+u)||0,p=Number(null!=(a&&a.linesOk)?a.linesOk:Math.max(0,m-d-u))||0,g=Number(a?.productKg||0)||0,f=Number(a?.etichette||0)||0,b=Number.isFinite(g)&&g>0,h=Number.isFinite(f)&&f>0,y=Math.max(1,p+d+u),v=Math.round(p/y*360),w=Math.round(d/y*360),_=`conic-gradient(var(--whOk) 0deg ${v}deg, var(--whWarn) ${v}deg ${v+w}deg, var(--whNon) ${v+w}deg 360deg)`,S=e=>Number.isFinite(e)?Math.round(e).toLocaleString("it-IT"):"",A=[{v:S(m),l:"Totali"},{v:S(p),l:"OK",tone:"ok"},{v:S(d),l:"Warning",tone:"warn"},{v:S(u),l:"Non configurati",tone:"non"},...b?[{v:(T=g,Number.isFinite(T)?T.toLocaleString("it-IT",{maximumFractionDigits:0}):""),l:"Kg residui"}]:[],...h?[{v:S(f),l:"Etichette"}]:[]];var T;const L=[];(a?.warnings||[]).length&&L.push({tone:"warn",label:`Solleciti sacchi  ${a.warnings.length}`}),(a?.nonConfig||[]).length&&L.push({tone:"non",label:`Distinte mancanti  ${a.nonConfig.length}`});const C=L.length?L.map(e=>`<span class="whChipPill" data-tone="${e.tone||""}">${Ao(e.label)}</span>`).join(""):'<span class="whChipPill">Nessuna criticit</span>',E=A.map(e=>`<div class="whMiniCard"${e.tone?` data-tone="${e.tone}"`:""}>\n        <div class="label">${Ao(String(e.l))}</div>\n        <div class="value">${Ao(String(e.v))}</div>\n      </div>`).join(""),N=`<div class="whDonutWrap">\n        <div class="whDonut whDonutLg" style="background:${_}">\n          <div class="whDonutCenter">\n            <div class="v">${Ao(String(S(m)))}</div>\n            <div class="l">righe</div>\n          </div>\n        </div>\n        <div class="whLegend whLegendCompact">\n          <div class="whLegendItem"><span class="whDot"></span><span class="name">OK</span><span class="val">${Ao(String(S(p)))}</span></div>\n          <div class="whLegendItem"><span class="whDot warn"></span><span class="name">Warning</span><span class="val">${Ao(String(S(d)))}</span></div>\n          <div class="whLegendItem"><span class="whDot non"></span><span class="name">Non configurati</span><span class="val">${Ao(String(S(u)))}</span></div>\n        </div>\n      </div>`;e.innerHTML=`<div class="magSimple whShell">\n      <div class="whHeroGlass">\n        <div class="whHeroText">\n          <div class="whChip">Aggiornato ${Ao(String(r||""))}</div>\n          <div class="whHeroTitle">Gestione magazzino</div>\n          <div class="whHeroSub">Residui, packaging e criticit live</div>\n          <div class="whChipRow">${C}</div>\n        </div>\n        <div class="whHeroViz">\n          ${N}\n        </div>\n      </div>\n      <div class="whMiniGrid">${E}</div>\n      <div class="whListCard">\n        <div class="whListHead">\n          <div>\n            <div class="eyebrow">Gestione completa</div>\n            <div class="whListTitle">Magazzino, residui e packaging</div>\n            <div class="whHeroSub">Consulta l'elenco completo di articoli e ordini.</div>\n          </div>\n          <div class="whListBadge">${Ao(String(s?.length||0))} articoli  ${Ao(String(c))} ordini</div>\n        </div>\n        <div class="whFooterActions">\n          <button class="whGhostBtn" type="button" id="whHomeOpenFull">Apri gestione completa</button>\n        </div>\n      </div>\n    </div>`;const x=e.querySelector("#whHomeOpenFull");x&&(x.onclick=()=>{const e=U("btnWarehouseOpen");if(e){try{e.focus({preventScroll:!0})}catch(e){}e.click()}else openWarehouseModal()})}(n,o,{orderDetails:s,sortedDetails:(c.filteredOrders||[]).slice().sort((e,t)=>`${e.order.customer||""}`.localeCompare(`${t.order.customer||""}`)||`${e.order.orderNo||e.order.number||""}`.localeCompare(`${t.order.orderNo||t.order.number||""}`)),overviewItems:no(c.filteredTotals||{productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[]}),filteredTotals:c.filteredTotals||{},updatedTxt:l});const d=N.magFilters||{customer:"",order:"",item:""},{filteredOrders:u,filteredTotals:m,applied:p}=eo(s,d),g={...d||{customer:"",order:"",item:""},order:""},f=eo(s,{...d||{customer:"",order:"",item:""},item:""}).filteredOrders||[],b=eo(s,g).filteredOrders||s,h=Jn(s),y=Jn(f),v=Jn(b).orders,w={customers:h.customers,items:y.items,orders:v},_=(u||[]).slice().sort((e,t)=>`${e.order.customer||""}`.localeCompare(`${t.order.customer||""}`)||`${e.order.orderNo||e.order.number||""}`.localeCompare(`${t.order.orderNo||t.order.number||""}`)),S=function(e){const t=new Map,n=(e,n)=>{if(!e)return;const o=t.get(e)||[];o.push(n),t.set(e,o)};for(const{order:t,comp:o}of e||[]){const e=`${t.customer||"Cliente"}  Ord. ${t.orderNo||t.number||""}`,i=[t.conclusion?`Conclusione: ${t.conclusion}`:"",o?.warnings?.length?`Attenzione sacchi: ${o.warnings.length}`:""].filter(Boolean).join(" ");o.productKg&&n("productKg|Prodotti da completare",{orderLabel:e,qty:o.productKg,unit:"kg",desc:i}),o?.bobine?.forEach?.((t,o)=>{n(`bobine|${o}`,{orderLabel:e,qty:t,unit:"g",desc:i})}),Number(o?.etichette)&&n("etichette|Etichette",{orderLabel:e,qty:o.etichette,unit:"pz",desc:i}),o?.scatole?.forEach?.((t,o)=>{n(`scatole|${o}`,{orderLabel:e,qty:t,unit:"pz",desc:i})}),o?.divisori?.forEach?.((t,o)=>{n(`divisori|${o}`,{orderLabel:e,qty:t,unit:"pz",desc:i})}),o?.altri?.forEach?.((t,o)=>{n(`altri|${o}`,{orderLabel:e,qty:t,unit:"pz",desc:i})});for(const t of o?.nonConfig||[]){const o=`${t.desc||"Prodotto"}${t.packKg?`  ${t.packKg} kg`:""}${t.note?`  ${t.note}`:""}`;n("nonconfig|Non configurati",{orderLabel:e,qty:t.qtyKg||0,unit:"kg",desc:o})}}return t}(_),A=no(m);N.magazzinoDetailLookup=S,N.magazzinoOverview=A;const T=A.slice(0,12),L={orderDetails:s,sortedDetails:_,overviewItems:A,visibleItems:T,needsSeeAll:A.length>T.length,filteredTotals:m,applied:p,options:w},C=U("warehouseModal");if(!(!C||!C.classList.contains("show")&&!e)){const e=U("warehouseModalBody"),t=U("warehouseBadgeModal");e&&t&&Io(e,t,L,"m_")}}function zo(e){const t=U("whModalTitle"),n=U("whModalSub"),o=U("whModalCalc"),i=U("whModalBody");if(!(t&&n&&i&&o))return;const a=(e,t)=>{const n=(ro(e,t)||"").trim();n?(o.textContent=`(${n})`,o.style.display=""):(o.textContent="",o.style.display="none")},r=Array.isArray(N.magazzinoOverview)?N.magazzinoOverview:[],s=N.magazzinoDetailLookup instanceof Map?N.magazzinoDetailLookup:new Map,l=e=>{const t=s.get(e.key)||[],n=t.length?t.map(e=>{return`\n        <div class="whModalRow">\n          <div style="flex:1; min-width:0;">\n            <div class="whModalName">${Ao(e.orderLabel||"Ordine")}</div>\n            ${e.desc?`<div class="whModalSub">${Ao(e.desc)}</div>`:""}\n          </div>\n          <div class="whModalVal">${t=e.unit,n=e.qty,oo({unit:t||"",qty:n})}</div>\n        </div>`;var t,n}).join(""):'<div class="muted">Nessun dettaglio disponibile.</div>';return`<div class="whModalSection">\n        <div class="tit">${Ao(e.label)}</div>\n        ${n}\n      </div>`};if(e===to)return t.textContent="Dettaglio magazzino",n.textContent="Elenco completo articoli e ordini",a(t.textContent),void(i.innerHTML=r.length?r.map(l).join(""):'<div class="muted">Nessun dato disponibile.</div>');const c=r.find(t=>t.key===e);t.textContent=c?.label||"Dettaglio articolo",n.textContent=c?.subtitle||"Ripartizione per cliente/ordine",a(t.textContent,c),i.innerHTML=l(c||{key:e,label:"Articolo",subtitle:""})}function Fo(e){const t=U("whModal");t&&(zo(e||to),t.classList.remove("hidden"),requestAnimationFrame(()=>t.classList.add("show")),it())}function Ro(){const e=U("whModal");e&&e.classList.contains("show")&&(e.classList.remove("show"),setTimeout(()=>e.classList.add("hidden"),160),at())}function Ko(){const e=(N.user?.fullName||"").trim();if(e)return e;const t=N.firebase?.auth?.currentUser,n=(t?.displayName||"").trim();if(n)return n;const o=(N.user?.email||t?.email||"").trim();if(o&&o.includes("@")){const[e]=o.split("@");if(e)return e}return"Operatore"}function Ho(e){const t=Math.max(0,Number(e)||0),n=Math.round(10*t)/10,o=0!==Math.abs(Math.round(10*n)%10);return new Intl.NumberFormat("it-IT",{minimumFractionDigits:o?1:0,maximumFractionDigits:1}).format(n)}function Uo(e){return Math.max(0,Math.round(Number(e)||0)).toLocaleString("it-IT")}function qo(){const e=ie(),t=new Date,n=t.getFullYear(),o=t.getMonth(),i=_e(Ko()||""),a=N.user?.uid||"",r=e.filter(e=>{const t=e?.startedAt||e?.endedAt||e?.at;if(!t)return!1;const r=new Date(t);return!!Number.isFinite(r.getTime())&&(r.getFullYear()===n&&r.getMonth()===o&&(a&&e.operatorUid?e.operatorUid===a:!!i&&_e(e.operator||"")===i))});if(!r.length)return{kg:0,orders:0};const s=r.reduce((e,t)=>{const n=Number(t.kg);return Number.isFinite(n)?e+n:e},0);return{kg:Number.isFinite(s)?s:0,orders:r.length}}function Wo(){const e=U("hdrMonthKg"),t=U("hdrMonthOrders"),n=U("deskMonthKg"),o=U("deskMonthOrders");if(!e||!t)return;let i="0",a="0";try{const{kg:e,orders:t}=qo();i=Ho(e),a=Uo(t)}catch(e){}e.textContent=i,t.textContent=a,n&&(n.textContent=i),o&&(o.textContent=a),function(){const e=U("mobileWelcome");if(!e)return;const t=Ao(Ko()||"Operatore"),{kg:n,orders:o}=qo(),i=Ho(n),a=Uo(o);e.innerHTML=`Benvenuto operatore <span class="highlight">${t}</span>, questo mese hai prodotto <span class="kpi">${i}</span> kg e hai concluso <span class="kpi">${a}</span> ordini.`}()}let jo=null;function Vo(){if(jo instanceof Set)return jo;try{const e=localStorage.getItem(m)||"[]",t=JSON.parse(e);jo=new Set(Array.isArray(t)?t.filter(Boolean):[])}catch(e){jo=new Set}return jo}function Go(){if(g instanceof Set)return g;try{const e=localStorage.getItem(p)||"[]",t=JSON.parse(e);g=new Set(Array.isArray(t)?t.filter(Boolean):[])}catch(e){g=new Set}return g}function Yo(){const e=N.notifications&&Array.isArray(N.notifications.inbox)?N.notifications.inbox:[],t=Boolean(N.user&&N.user.isAdmin),n=Go();return e.filter(e=>!(!e||!e.id)&&(!n.has(e.id)&&!!(t||"admin"!==e.audience&&!0!==e.adminOnly)))}function Zo(e){if(!e||!e.length)return;const t=Vo();let n=!1;for(const o of e)o&&!t.has(o)&&(t.add(o),n=!0);n&&function(e){try{localStorage.setItem(m,JSON.stringify(Array.from(e||[])))}catch(e){}jo=e instanceof Set?e:new Set}(t)}function Qo(){const e=U("pillPushBadge");if(!e)return;const t=function(){const e=Vo(),t=Yo();let n=0;for(const o of t)o&&o.id&&!e.has(o.id)&&n++;return n}();t>0?(e.textContent=t>99?"99+":String(t),e.style.display="inline-flex"):e.style.display="none"}function Jo(){const e=U("notifList"),t=U("notifEmpty"),n=U("notifStatus"),o=U("notifUnavailable"),i=U("notifAdminBox"),a=U("btnTogglePush"),r=U("notifSub");i&&(i.style.display=N.user&&N.user.isAdmin?"block":"none");const s=Yo(),l=Boolean(N.notifications?.unavailable||!N.firebase.ok);if(o&&(o.style.display=l?"flex":"none"),r&&(r.textContent=l?"UI non disponibile (permessi Firebase).":"Push, messaggi interni e registro."),n&&(l?n.textContent="Centro notifiche non disponibile (permessi o connessione).":N.notifications?.ready?n.textContent=s.length?`${s.length} notifiche recenti`:"Nessuna notifica recente":n.textContent="Caricamento notifiche"),e){if(e.innerHTML="",!l&&s.length){const t=Vo(),n=document.createDocumentFragment();for(const e of s){const o=document.createElement("div"),i=e?.id&&!t.has(e.id);o.className="notifItem"+(i?" unread":"");let a="";try{const t=e?.createdAt,n=t&&"function"==typeof t.toDate?t.toDate():t?new Date(t):null;n&&Number.isFinite(n.getTime())&&(a=ge(n))}catch(e){}const r=e?.createdBy?`  Da ${Ao(e.createdBy)}`:"";o.innerHTML=`\n            <div class="notifTitle">${Ao(e?.title||"Aggiornamento")}</div>\n            <div class="notifBody">${Ao(e?.body||"")}</div>\n            <div class="notifMeta"><span>${Ao(a)}</span>${r?`<span>${r}</span>`:""}</div>`,n.appendChild(o)}e.appendChild(n)}t&&(t.style.display=l||!N.notifications?.ready||s.length?"none":"block")}if(a){const e="undefined"!=typeof Notification?Notification.permission:"unsupported";a.textContent="granted"===e?"Disattiva push":"Attiva push"}Qo()}async function Xo(e,t){if(!N.firebase.ok)throw new Error("Firebase non disponibile");const n=N.firebase.api,o=N.firebase.db,i=n.collection(o,f);await n.addDoc(i,{title:e||"Richiesta",body:t||"",line:"polveri",createdAt:n.serverTimestamp(),createdBy:N.user?.fullName||"Operatore",createdByUid:N.user?.uid||"",audience:"admin",adminOnly:!0});try{await h(`[Hub Polveri] ${e||"Notifica"}`,`${t||""}\n\n\nDa: ${N.user?.fullName||"Sistema"}\nLinea: polveri`,null)}catch(e){}}function ei(){const e=U("notifModal");e&&(e.classList.add("show"),it(),Jo(),Zo(Yo().map(e=>e.id).filter(Boolean)),Qo())}function ti(){const e=U("notifModal");e&&(e.classList.remove("show"),at(),Qo())}function ni(){const e=U("alertModal"),t=U("alertModalText");if(!e||!t)return;const n=N.operatorAlert&&N.operatorAlert.message?String(N.operatorAlert.message):"Nessun avviso attivo.";t.textContent=n,e.classList.add("show"),it()}function oi(){const e=U("alertModal");e&&(e.classList.remove("show"),at())}async function ii(){if("undefined"==typeof Notification)return void Ve("Non supportato","Questo browser non supporta le notifiche.");if("granted"===Notification.permission){confirm("Vuoi DISATTIVARE le notifiche push su questo dispositivo?")&&await async function(){try{if("granted"!==Notification.permission)return Ve("Gi disattive","Su questo dispositivo le push non risultano attive."),void _i();const e=N.firebase.msgApi,t=N.firebase.messaging,n=await Si(),o=await e.getToken(t,{vapidKey:l,serviceWorkerRegistration:n}).catch(()=>null);o&&(await e.deleteToken(t).catch(()=>{}),await async function(e){if(!N.firebase.ok)return;const t=N.firebase.api,n=N.firebase.db,o=await Ai(e);try{await t.deleteDoc(t.doc(n,"powderPushTokens",o))}catch(e){}}(o)),N.push.token="",N.push.enabled=!1,_i(),Ve("Notifiche disattivate","Ok, questo dispositivo non ricever pi push.")}catch(e){console.warn(e),Ve("Errore","Impossibile disattivare le notifiche su questo dispositivo.")}}()}else await async function(){if(!N.push.supported)return void Ve("Notifiche non supportate","Questo browser/dispositivo non supporta le push per questa app.");const e=await Notification.requestPermission();if(N.push.permission=e,"granted"!==e)return Ve("Notifiche non abilitate","Permesso negato o non concesso."),void _i();try{const e=N.firebase.msgApi,t=N.firebase.messaging,n=await Si(),o=await e.getToken(t,{vapidKey:l,serviceWorkerRegistration:n});if(!o)return Ve("Errore notifiche","Token non generato. Controlla VAPID key in Firebase Console."),void _i();N.push.token=o,N.push.enabled=!0,await async function(e){if(!N.firebase.ok)return;const t=N.firebase.api,n=N.firebase.db,o=N.user||{},i=await Ai(e),a=t.doc(n,"powderPushTokens",i);await t.setDoc(a,{token:e,uid:o.uid||"",email:o.email||"",displayName:o.fullName||o.displayName||"",role:o.isAdmin?"admin":"operator",line:"polveri",userAgent:navigator.userAgent||"",platform:wi()?"ios":/android/i.test(navigator.userAgent||"")?"android":"desktop",enabled:!0,lastSeenAt:t.serverTimestamp(),createdAt:t.serverTimestamp()},{merge:!0})}(o);try{e.onMessage(t,e=>{Ve(e?.notification?.title||"Aggiornamento",e?.notification?.body||""||"Nuova notifica");try{beep()}catch(e){}})}catch(e){}_i(),Ve("Notifiche attive","Perfetto: questo dispositivo ricever notifiche anche ad app chiusa.")}catch(e){console.warn(e),Ve("Errore notifiche",String(e?.message||e)),_i()}}();Jo(),_i()}async function ai(){if(!N.user)return void Zt("Per iniziare un ordine devi prima accedere con un account autorizzato.");N.prodModalOpenedAt=Date.now(),N.startedThisSession=!1,N.prodModalTouched=!1;const e=U("prodModal");e&&(e.classList.add("show"),it(),ye(),await di(),J(e))}function ri(e){const t=U("prodModalBody");if(!t)return{wrap:null,step:null};t.classList.add("modalStepWrap");let n=t.querySelector(`.modalStep[data-step="${e}"]`);return n||(n=document.createElement("div"),n.className="modalStep",n.dataset.step=e,t.appendChild(n)),n.classList.remove("isEnterNext","isEnterPrev","isExitNext","isExitPrev"),{wrap:t,step:n}}function si(e,t="next"){const n=U("prodModalBody");if(!n||!e)return;const o=U("prodModal");n.classList.add("modalStepWrap"),n.querySelectorAll(".modalStep").forEach(t=>{t!==e&&t.classList.remove("isActive","isEnterNext","isEnterPrev","isExitNext","isExitPrev")}),e.classList.add("isActive"),n.style.height="auto";try{const e=n.closest(".sbd")||o?.querySelector(".sbd");e&&(e.scrollTop=0)}catch(e){}J(o)}function li(){const e=U("partialBody");if(!e)return;let t=[];try{t=Kn().partial||[]}catch(e){t=[]}const n=new Set(t.map(e=>String(e.orderNo||e.number||""))),{baseOrders:o}=qn({applyRoleVisibility:!1,includeHidden:!0}),i=o.filter(e=>n.has(String(e.orderNo||e.number||"")));if(!i.length)return void(e.innerHTML='<div class="muted">Nessun ordine parzialmente concluso.</div>');e.innerHTML='<div class="list" id="partialList"></div>';const a=e.querySelector("#partialList");a.classList.add("chunkyList"),i.forEach(e=>{const t=e.partialInfo?.done||0,n=e.partialInfo?.total||t+(e.lines?.length||0)+(e.autoDone||0),o=document.createElement("div");o.className="item pressCard rowPress",o.innerHTML=`\n        <div class="top">\n          <div>\n            <div class="name ellipsis" title="${Ao(e.customer||"Cliente")}  Ordine ${Ao(e.orderNo||e.number||"")}">${Ao(e.customer||"Cliente")}  Ordine ${Ao(e.orderNo||e.number||"")}</div>\n            <div class="sub">Conclusione prevista: <b>${Ao(e.conclusion||"")}</b></div>\n            <div class="muted" style="margin-top:6px;">Righe concluse: ${t}/${n}  Kg: ${Math.round(e.totalKg||0)}</div>\n          </div>\n          <div class="badge" style="border-color:var(--warn); color:var(--warn);">Parziale</div>\n        </div>`,o.onclick=()=>{U("partialModal").classList.remove("show"),at(),ai(),setTimeout(()=>mi(e),60)},a.appendChild(o)})}async function ci(e){const{baseOrders:t}=qn({applyRoleVisibility:!1,includeHidden:!0});ve(t);const n=function(){const e=new Map;for(const t of fe().values()){const n=String(t.orderNo||t.number||""),o=String(t.customer||""),i=`${n}__${o}`;e.has(i)||e.set(i,{orderNo:n,customer:o,lines:[]}),e.get(i).lines.push(t)}return e}();if(ye(),!n.size)return void Ve("Seleziona righe","Non hai selezionato righe da avviare.");const o=N.user?.fullName||N.operator||"Operatore",i=new Map(t.map(e=>[`${e.orderNo||e.number||""}__${e.customer||""}`,e]));let a=0,r=0;for(const[e,t]of n.entries()){const n=i.get(e);if(!n)continue;const s=(n.lines||[]).filter(e=>"active"!==e.status),l=new Set((t.lines||[]).map(e=>String(e.lineKey||""))),c=s.filter(e=>l.has(String(e.lineKey||"")));if(!c.length)continue;const d=s.length>0&&s.every(e=>l.has(String(e.lineKey||""))),u=c.reduce((e,t)=>e+jn(t),0)||n.totalKg||0,m={operator:o,customer:n.customer,orderNo:n.orderNo||n.number,conclusion:n.conclusion||"",totalKg:u,selectedLineKeys:c.map(e=>e.lineKey),isFullOrderStart:d,startedAt:pe(),active:!0};await un(m);try{await pn({type:"start",action:"Avvio ordine",description:`Ordine n. ${m.orderNo}  ${m.customer}`,orderNo:m.orderNo,customer:m.customer,meta:`${c.length} righe  ${Math.round(u||0)} kg`})}catch(e){}const p="small"===ft(c)?" Utilizzare macchina piccola per fare questo ordine.":" Utilizzare macchina grande.";Fn(`Ordine: operatore ${o} ha avviato ordine ${m.orderNo} del cliente ${m.customer}.${p}`),a++,r+=c.length}if(!a)return void Ve("Selezione non valida","Seleziona righe non gi in produzione.");N.startedThisSession=!0,fe().clear(),ye(),U("prodModal").classList.remove("show"),at();Ve("Produzione avviata",`${e?`Ordine n. ${e.orderNo||e.number||""}`:"Ordini selezionati"}  ${a} ordini  ${r} righe`)}async function di(e="next"){U("prodModalTitle").textContent="Produzione  Ordini";const{step:t}=ri("orders");if(!t)return;const{orders:n,baseOrders:o}=qn();ve(o),ye(),n.sort((e,t)=>("today"===e.priorityInfo?.priority?0:"scheduled"===e.priorityInfo?.priority?1:2)-("today"===t.priorityInfo?.priority?0:"scheduled"===t.priorityInfo?.priority?1:2));const i=window.matchMedia("(min-width: 980px)").matches,a=Boolean(N.user&&N.user.isAdmin);let r="";if(i)if(a)r='<div class="planMessage"><div class="headline">Vista admin</div><div class="muted">Tutti gli ordini (anche oltre 3 giorni) sono visibili per la pianificazione.</div></div>';else{const e=o.filter(e=>null==e.daysAway||e.daysAway<=3),t=e.slice(0,8).map(e=>`<li>${Ao(e.customer||"Cliente")}  Ord. ${Ao(e.orderNo||e.number||"")}${e.conclusion?`  ${Ao(e.conclusion)}`:""}</li>`).join("")||"<li>Nessuna data pianificata disponibile.</li>";r=`<div class="planMessage"><div class="headline">Ci sono ${o.length} ordini da fare. In base alla pianificazione, puoi andare in produzione con questi ${e.length} ordini:</div><ul>${t}</ul></div>`}t.innerHTML=`\n      <div class="stepTitle">Ordini disponibili</div>\n      <div class="muted">Operatore: <b>${N.user?.fullName||""}</b>. Tocca un cliente: vedrai gli ordini separati per numero.</div>\n      ${r}\n      <div style="height:10px"></div>\n      <div class="list" id="orderList"></div>\n    `;const s=t.querySelector("#orderList");if(s.classList.add("chunkyList"),!n.length){const n=o.some(e=>null==e.daysAway||e.daysAway<=3),r=i&&!a&&o.length&&!n?"Nessun ordine pianificato entro i prossimi 3 giorni.":"Nessun ordine disponibile (attendi sincronizzazione).";return s.innerHTML=`<div class="muted">${r}</div>\n        <div style="height:10px"></div>\n        <button class="btn" id="btnRetry" style="width:100%;">Riprova sincronizzazione</button>`,t.querySelector("#btnRetry").onclick=async()=>{t.querySelector("#btnRetry").textContent="Sincronizzo",await $t(!1,"manual_retry"),di("next")},void si(t,e)}const l=new Map;for(const e of n){const t=e.customer||"Cliente";l.has(t)||l.set(t,[]),l.get(t).push(e)}const c=Array.from(l.entries());await Q(s,c,([e,t])=>{const n=document.createElement("div");return n.className="item",n.innerHTML=`<div class="top"><div><div class="name">${e}</div><div class="sub">${t.length} ordini</div></div><div class="badge">Apri</div></div>`,n.style.cursor="pointer",n.onclick=()=>{ui(e,t)},n},120),si(t,e)}async function ui(e,t,n="next"){U("prodModalTitle").textContent=`Produzione  ${e}`;const{step:o}=ri("customer");if(!o)return;o.innerHTML=`\n      <div class="stepTitle">Ordini per ${e}</div>\n      <div class="muted">Ordini separati per numero. Apri un ordine per vedere le righe.</div>\n      <div style="height:10px"></div>\n      <div class="list" id="custOrders"></div>\n      <div style="height:12px"></div>\n      <button class="btn ghost" id="btnBackOrders" style="width:100%;"> Torna alla lista clienti</button>\n    `,o.querySelector("#btnBackOrders").onclick=()=>di("prev");const i=o.querySelector("#custOrders");i.classList.add("chunkyList"),await Q(i,t,e=>{const t=document.createElement("div");t.className="item",t.style.cursor="pointer";const n=e.lines.reduce((e,t)=>e+Number(t.qty||0),0),o="today"===(e.priorityInfo?.priority||"normal")?"Priorit":e.partialInfo?"Parziale":"Apri",i=e.alerts&&e.alerts.length?`<div class="muted" style="margin-top:6px;">Avvisi: ${e.alerts.length}</div>`:"",a=we(e).length,r=a?`<div class="muted" style="margin-top:6px; color:rgba(10,58,125,.92); font-weight:900;">Righe selezionate: ${a}</div>`:"";return t.innerHTML=`\n        <div class="top">\n          <div>\n            <div class="name">Ordine n. ${e.orderNo||e.number}</div>\n            <div class="sub">Righe: ${e.lines.length}  Quantit: ${Ce(n,"kg")}  Conclusione: ${e.conclusion||""}</div>\n            ${e.partialInfo?`<div class="muted" style="margin-top:6px;">Ordine parzialmente concluso (${e.partialInfo.done}/${e.partialInfo.total}).</div>`:""}\n            ${e.priorityInfo?.reason?`<div class="muted" style="margin-top:6px;">${Ao(e.priorityInfo.reason)}</div>`:""}\n            ${i}\n            ${r}\n          </div>\n          <div class="badge">${o}</div>\n        </div>`,t.onclick=()=>mi(e),t},120),si(o,n)}function mi(e,t="next"){const n=e.orderNo||e.number;U("prodModalTitle").textContent=`Ordine n. ${n}`;const{step:o}=ri("detail");if(!o)return;const i=e.lines||[],a=e.alerts||[],r=a.length?`<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${a.map(e=>{const t=bt(e.alertInfo?.color);return`<div class="alertBanner" style="${`background:${t.bg};border-color:${t.border};color:${t.color};${t.shadow?`box-shadow:${t.shadow};`:""}`}"><div class="label">${Ao(e.desc||e.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`}).join("")}</div>`:"";o.innerHTML=`\n      <div class="stepTitle">${e.customer}</div>\n      <div class="muted">Seleziona le righe da produrre, poi avvia. (Seleziona tutto = ordine completo)</div>\n      ${e.partialInfo?`<div class="warnBanner" style="margin:10px 0 6px;">\n        <div class="icon"></div>\n        <div class="txt">\n          <div class="t">Ordine parzialmente concluso</div>\n          <div class="s">Restano ${e.partialInfo.total-e.partialInfo.done} righe da completare.</div>\n        </div>\n      </div>`:""}\n      ${r}\n      ${e.conclusion?`<div class="muted" style="margin:6px 0 8px; font-weight:800;">Conclusione prevista: <b>${Ao(e.conclusion)}</b></div>`:""}\n      <div style="height:10px"></div>\n      <div class="row2">\n        <button class="btn" id="btnSelAll">Seleziona tutto</button>\n        <button class="btn ghost" id="btnClrAll">Deseleziona</button>\n      </div>\n      <div style="height:10px"></div>\n      <div class="list" id="lineList"></div>\n      <div style="height:12px"></div>\n      <button class="btn good" id="btnStartProd" style="width:100%;">INIZIA PRODUZIONE</button>\n      <div style="height:10px"></div>\n      <button class="btn ghost" id="btnBackCust" style="width:100%;"> Torna agli ordini cliente</button>\n    `;const s=fe(),l=new Set(we(e).map(e=>String(e.lineKey))),c=o.querySelector("#lineList");async function d(){l.clear(),we(e).forEach(e=>l.add(String(e.lineKey))),await Q(c,i,t=>{const o=t.lineKey,i=be(e,t),a=document.createElement("div"),r=l.has(o)||s.has(i),c="active"===t.status,u=Boolean(c&&t.activeIsMe&&t.activeProd),m=c&&!u;a.className="item pressCard selectableLine"+(r?" selected":""),a.style.cursor=m?"not-allowed":"pointer";const p=Ce(t.qty,t.um);return a.innerHTML=`\n          <div class="top">\n            <div>\n              <div class="name">${t.desc}</div>\n              <div class="sub" style="font-size:13px; font-weight:900;">Quantit: <span style="font-size:15px;">${p}</span></div>\n              ${t.code?`<div class="muted" style="margin-top:6px;">Cod: <b>${t.code}</b></div>`:""}\n              ${t.conclusion?`<div class="muted" style="margin-top:6px;">Conclusione prevista: ${Ao(t.conclusion)}</div>`:""}\n              ${c?`<div class="muted" style="margin-top:6px; font-weight:800;">In produzione da ${Ao(u?"te":t.activeOp||"operatore")}  ${u?"tocca per riaprire.":"riapri la produzione in corso."}</div>`:""}\n            </div>\n            <div class="badge">${r?"":m?"Bloccato":"Seleziona"}</div>\n          </div>\n        `,a.onclick=c?u?()=>{try{pi(),setTimeout(()=>{try{fi(t.activeProd)}catch(e){}},60)}catch(e){}Ve("In produzione","Questa riga  gi in produzione da te. Apro la produzione in corso")}:()=>Ve("In produzione",`Riga gi avviata da ${t.activeOp||"un operatore"}.`):()=>{const a={orderNo:n,customer:e.customer,lineKey:t.lineKey,desc:t.desc,qty:t.qty,um:t.um,packKg:t.packKg,lineKg:t.lineKg,conclusion:t.conclusion||e.conclusion||"",orderConclusion:e.conclusion||"",totalKg:e.totalKg||0};l.has(o)||s.has(i)?(l.delete(o),s.delete(i)):(l.add(o),s.set(i,a)),N.prodModalTouched=!0,d(),ye()},a},100);const t=he(),a=o.querySelector("#btnStartProd");a.disabled=0===t,a.style.opacity=0===t?".6":"1",a.textContent=t>0?`INIZIA PRODUZIONE (${t})`:"INIZIA PRODUZIONE"}c.classList.add("chunkyList"),o.querySelector("#btnSelAll").onclick=()=>{i.filter(e=>"active"!==e.status).forEach(t=>{l.add(t.lineKey);const o=be(e,t);s.set(o,{orderNo:n,customer:e.customer,lineKey:t.lineKey,desc:t.desc,qty:t.qty,um:t.um,packKg:t.packKg,lineKg:t.lineKg,conclusion:t.conclusion||e.conclusion||"",orderConclusion:e.conclusion||"",totalKg:e.totalKg||0})}),N.prodModalTouched=!0,d(),ye()},o.querySelector("#btnClrAll").onclick=()=>{!function(e){const t=fe(),n=Array.from(t.keys());for(const o of n){const n=t.get(o);n&&String(n.orderNo||n.number||"")===String(e?.orderNo||e?.number||"")&&String(n.customer||"")===String(e?.customer||"")&&t.delete(o)}}(e),l.clear(),N.prodModalTouched=!0,d(),ye()},o.querySelector("#btnBackCust").onclick=()=>{const t=qn().orders.filter(t=>t.customer===e.customer);ui(e.customer,t,"prev")},o.querySelector("#btnStartProd").onclick=async()=>{0!==he()&&await ci(e)},d(),si(o,t)}function pi(){U("runningModal").classList.add("show"),it(),gi()}function gi(){const e=U("runningBody"),t=N.activeProductions||[];if(!t.length)return void(e.innerHTML='<div class="muted">Nessuna produzione attiva al momento.</div>');e.innerHTML='<div class="stepTitle">Attivit in corso</div><div class="muted">Apri per vedere dettagli e concludere la produzione.</div><div style="height:10px"></div><div class="list" id="runList"></div>';const n=e.querySelector("#runList");n.classList.add("chunkyList"),t.sort((e,t)=>new Date(e.startedAt||0)-new Date(t.startedAt||0)).forEach(e=>{const t=e.startedAt?Math.floor((Date.now()-new Date(e.startedAt).getTime())/6e4):0,o=Rn(e),i=Math.max(0,120-120*Math.min(1,o)),a=document.createElement("div");a.className="item",a.style.cursor="pointer",a.style.borderColor=`hsla(${i}, 80%, 55%, .35)`,a.style.background=`hsla(${i}, 80%, 45%, .14)`,a.innerHTML=`\n          <div class="top">\n            <div>\n              <div class="name">${e.operator||"Operatore"}  Ordine n. ${e.orderNo||""}</div>\n              <div class="sub">${e.customer||"Cliente"}  ${Math.round(Number(e.totalKg||0))} kg  In corso da ${t} min  Conclusione: ${e.conclusion||""}</div>\n            </div>\n            <div class="badge">Apri</div>\n          </div>\n        `,a.onclick=()=>fi(e),n.appendChild(a)})}function fi(e){const t=U("runningBody"),n=N.powderOrders.find(t=>t.number===e.orderNo&&t.customer===e.customer)||null,o=new Set(e.selectedLineKeys||[]),i=new Set(o),a=new Map,r=n?n.lines.filter(e=>o.has(e.lineKey)):[],s=n?.alerts||[],l=s.length?`<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${s.map(e=>{const t=bt(e.alertInfo?.color);return`<div class="alertBanner" style="${`background:${t.bg};border-color:${t.border};color:${t.color};${t.shadow?`box-shadow:${t.shadow};`:""}`}"><div class="label">${Ao(e.desc||e.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`}).join("")}</div>`:"";t.innerHTML=`\n      <div class="stepTitle">${e.operator||"Operatore"}  Ordine n. ${e.orderNo}</div>\n      <div class="muted">${e.customer}  Seleziona cosa stai concludendo, poi premi Ho concluso la produzione.</div>\n      ${l}\n      <div style="height:10px"></div>\n      <div class="row2">\n        <button class="btn" id="btnSelAllRun">Seleziona tutto</button>\n        <button class="btn ghost" id="btnClrAllRun">Deseleziona</button>\n      </div>\n      <div style="height:10px"></div>\n      <div class="list" id="runLines"></div>\n      <div style="height:12px"></div>\n      <button class="btn good" id="btnConclude" style="width:100%;">HO CONCLUSO LA PRODUZIONE</button>\n      <div style="height:10px"></div>\n      <button class="btn bad" id="btnCancelProd" style="width:100%;">Annulla produzione in corso</button>\n      <div style="height:10px"></div>\n      <button class="btn ghost" id="btnBackRun" style="width:100%;"> Torna a elenco produzioni</button>\n    `;const c=t.querySelector("#runLines");function d(){c.innerHTML="";for(const e of r){const t=i.has(e.lineKey),o=document.createElement("div");o.className="item pressCard selectableLine"+(t?" selected":"");const r=e.conclusion||n?.conclusion||"";o.style.cursor="pointer",o.style.borderColor=t?"rgba(46,123,255,.55)":"rgba(255,255,255,.12)";if(ht(e))o.innerHTML=St({selectable:!0,checked:t});else{const n=Ce(e.qty,e.um);o.innerHTML=`\n            <div class="top">\n              <div>\n                <div class="name">${e.desc}</div>\n                <div class="sub">Quantit: ${n}  Cod: ${e.code||""}${r?`  Conclusione: ${r}`:""}</div>\n                <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">\n                  <div class="muted" style="font-size:12px; font-weight:900; min-width:150px;">Quantit prodotta (kg, opzionale)</div>\n                  <input class="kgInput" data-k="${e.lineKey}" type="number" inputmode="decimal" step="0.1" placeholder="auto" style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--stroke); background: rgba(0,0,0,.02); font-weight:900;"/>\n                </div>\n              </div>\n              <div class="badge">${t?"":"Seleziona"}</div>\n            </div>`;const i=o.querySelector(".kgInput");if(i){const t=a.get(e.lineKey);null!=t&&(i.value=t),i.addEventListener("click",e=>e.stopPropagation()),i.addEventListener("touchstart",e=>e.stopPropagation(),{passive:!0}),i.addEventListener("input",()=>{a.set(e.lineKey,i.value)})}}o.onclick=()=>{i.has(e.lineKey)?i.delete(e.lineKey):i.add(e.lineKey),d()},c.appendChild(o)}U("btnConclude").disabled=0===i.size,U("btnConclude").style.opacity=0===i.size?".6":"1";const e=U("btnConclude");e&&e.classList.contains("isBusy")?(e.disabled=!0,e.setAttribute("aria-disabled","true"),e.style.opacity=".82"):e&&e.removeAttribute("aria-disabled")}t.querySelector("#btnSelAllRun").onclick=()=>{for(const e of o)i.add(e);d()},t.querySelector("#btnClrAllRun").onclick=()=>{i.clear(),d()},t.querySelector("#btnBackRun").onclick=gi;const u=n?je(n):We({orderNo:e.orderNo,number:e.orderNo,id:e.id||e.orderNo,customer:e.customer});Boolean(N.user&&N.user.isAdmin)?t.querySelector("#btnCancelProd").onclick=async()=>{confirm("Sei sicuro che vuoi annullare la produzione in corso?")&&(await mn(e.id,{cancelled:!0}),Ve("Produzione annullata",`Ordine n. ${e.orderNo}  ${e.customer}`),function(e="Lordine  stato annullato."){const t=U("cancelBanner"),n=U("cancelBannerSub");t&&n&&(n.textContent=e,t.classList.add("show"),requestAnimationFrame(()=>{Ge(t.getBoundingClientRect().height||0)}))}(`Ordine n. ${e.orderNo}  ${e.customer}`),setTimeout(()=>Ye(),6500),gi(),Eo())}:t.querySelector("#btnCancelProd").style.display="none";const m=t.querySelector("#btnConclude"),p=globalThis.__CONCLUDE_INFLIGHT__,g=globalThis.__CONCLUDE_RECENT__,f=(e,t="Conclusione")=>{m&&(m.dataset.defaultLabel||(m.dataset.defaultLabel=m.textContent||"HO CONCLUSO LA PRODUZIONE"),e?(m.classList.add("isBusy"),m.setAttribute("aria-disabled","true"),m.disabled=!0,m.innerHTML=`<span class="btnLabel"><span class="miniSpinner" aria-hidden="true"></span>${t}</span>`):(m.classList.remove("isBusy"),m.removeAttribute("aria-disabled"),m.disabled=0===i.size,m.innerHTML=m.dataset.defaultLabel,m.style.opacity=m.disabled?".6":"1"))},b=()=>{m&&(m.classList.add("isBusy"),m.disabled=!0,m.setAttribute("aria-disabled","true"),m.innerHTML='<span class="btnLabel">Concluso</span>',m.style.opacity=".92")},y=async()=>{try{if(!n)return!1;const t=(n.lines||[]).filter(e=>!yt(e)).length;if(t<=0)return!1;const o=new Set;for(const t of N.history||[]){if(!t)continue;if(!(String(t.orderNo||"")===String(e.orderNo||"")||t.orderKey&&t.orderKey===u))continue;const n=Array.isArray(t.concludedLineKeys)?t.concludedLineKeys:[];for(const e of n)e&&o.add(String(e))}return o.size>=t}catch(e){return!1}};m&&!m.__handlerBound&&(m.__handlerBound=!0,globalThis.__CONCLUDE_HANDLER_BOUND__=!0,m.addEventListener("click",async()=>{if(!i.size)return;const t=Date.now();if(!0===p.get(u))return;if(t-(g.get(u)||0)<2500)return;p.set(u,!0),g.set(u,t);let r=!1;try{if(f(!0,"Conclusione"),await y())return b(),Ve("Ordine gi concluso",`Ordine n. ${e.orderNo}  ${e.customer}`),void(r=!0);const t=i.size===o.size;if(Boolean(e.isFullOrderStart)&&t&&!confirm("Stai concludendo lintero ordine. Confermi?"))return;const s=e.startedAt?new Date(e.startedAt).getTime():Date.now(),l=Date.now()-s;let c=0;const d=[];if(n){const e=new Map(n.lines.map(e=>[e.lineKey,e]));for(const t of i){const n=e.get(t);if(!n)continue;const o=a.get(t),i=null!=o&&""!==String(o).trim()?Number(String(o).replace(",",".")):NaN,r=Number(n.qty||0),s=Number.isFinite(i)?i:Number.isFinite(r)?r:n.lineKg||0;c+=s,d.push({lineKey:t,desc:n.desc,code:n.code||"",plannedKg:Number(n.lineKg||0),producedKg:Number(s||0),qty:n.qty,um:n.um||""})}}else c=Number(e.totalKg||0);const p=`${e.customer}  Ordine n. ${e.orderNo}  ${Math.round(c)} kg`,g=await new Promise(t=>{!function(e,t,n){(function(){if(yi.canvas)return void yi.resize?.();function e(){const e=yi.canvas.getBoundingClientRect();yi.dpr=Math.max(1,window.devicePixelRatio||1),yi.canvas.width=Math.floor(e.width*yi.dpr),yi.canvas.height=Math.floor(e.height*yi.dpr),yi.ctx.setTransform(yi.dpr,0,0,yi.dpr,0,0),yi.ctx.clearRect(0,0,e.width,e.height),yi.empty=!0}function t(e){const t=yi.canvas.getBoundingClientRect(),n=e.touches&&e.touches[0]?e.touches[0]:e;return{x:n.clientX-t.left,y:n.clientY-t.top}}function n(e){e.preventDefault(),yi.drawing=!0;const n=t(e);yi.last=n}function o(e){if(!yi.drawing)return;e.preventDefault();const n=t(e);yi.ctx.beginPath(),yi.ctx.moveTo(yi.last.x,yi.last.y),yi.ctx.lineTo(n.x,n.y),yi.ctx.stroke(),yi.last=n,yi.empty=!1}function i(e){yi.drawing&&(e.preventDefault(),yi.drawing=!1)}yi.canvas=U("signCanvas"),yi.canvas.style.touchAction="none",yi.canvas.style.pointerEvents="auto",yi.ctx=yi.canvas.getContext("2d"),yi.ctx.lineCap="round",yi.ctx.lineJoin="round",yi.ctx.lineWidth=3.2,yi.ctx.strokeStyle="#000",yi.resize=e,e(),window.addEventListener("resize",e),yi.canvas.addEventListener("pointerdown",n),yi.canvas.addEventListener("pointermove",o),window.addEventListener("pointerup",i),yi.canvas.addEventListener("touchstart",n,{passive:!1}),yi.canvas.addEventListener("touchmove",o,{passive:!1}),window.addEventListener("touchend",i,{passive:!1})})(),U("signCheck").checked=!1,U("signContext").textContent=e,vi(),U("signModal").classList.add("show"),it(),requestAnimationFrame(()=>yi.resize?.());let o=!1;const i=(e=!1)=>{o||(o=!0,U("signModal").classList.remove("show"),at(),U("signOk").onclick=null,e&&"function"==typeof n&&n())};U("signClose").onclick=()=>i(!0),U("signClear").onclick=()=>vi(),U("signOk").onclick=()=>{if(!U("signCheck").checked)return void Ve("Conferma richiesta","Spunta la dichiarazione prima di concludere.");if(yi.empty)return void Ve("Firma richiesta","Inserisci la firma prima di concludere.");const e=yi.canvas.toDataURL("image/png");i(),t(e)}}(p,async n=>{await mn(e.id,{concluded:!0});const o={orderKey:u,operator:N.user?.fullName||e.operator||"Operatore",operatorUid:N.user?.uid||"",customer:e.customer,orderNo:e.orderNo,kg:c,durationMs:l,startedAt:e.startedAt||pe(),endedAt:pe(),concludedLineKeys:Array.from(i),totalKgOrder:Number(e.totalKg||0),perLine:d,signature:n,statementAccepted:!0},a=await async function(e){if(!N.firebase.ok)return;const t=N.firebase.api,n=N.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`;return await t.setDoc(t.doc(n,"powderProdHistory",o),{...e,id:o,at:pe(),concludedAt:e.endedAt||pe()}),o}(o),r={...o,id:a||`${Date.now()}_${Math.random().toString(16).slice(2)}`,at:pe()};try{const e=`[Hub Polveri] Ordine concluso ${o.orderNo||""}  ${o.customer||""}`,t=[`Ordine: ${o.orderNo||""}`,`Cliente: ${o.customer||""}`,`Operatore: ${o.operator||N.user?.fullName||""}`,`Inizio: ${o.startedAt||""}`,`Fine: ${o.endedAt||""}`,`Totale ordine (kg): ${Number(o.totalKgOrder||0).toFixed(2)}`,`Kg prodotto (questa chiusura): ${Number(o.kgProduced||0).toFixed(2)}`,"Linea: polveri","Firma: "+(o.signature?"Acquisita su hub (storico produzione)":"Non presente")].join("\n"),n=o.signature?`\n                  <div style="font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial; font-size:14px; color:#111;">\n                    <div style="font-weight:800; margin-bottom:6px;">Firma operatore</div>\n                    <img src="${o.signature}" alt="Firma" style="max-width:320px; width:100%; border:1px solid rgba(0,0,0,.12); border-radius:12px;"/>\n                  </div>`:null;await h(e,t,n)}catch(e){}try{await pn({type:"close",action:"Chiusura ordine",description:`Ordine n. ${o.orderNo}  ${o.customer}`,orderNo:o.orderNo,customer:o.customer,meta:`${i.size} righe  ${Math.round(c||0)} kg`,extra:{durationMs:l}})}catch(e){}N.history=[...N.history||[],r],N.historyReady=!0;try{await ne(1,c)}catch(e){}try{Lo()}catch(e){}N.activeProductions=(N.activeProductions||[]).filter(t=>t.id!==e.id);try{N.partialOrders=Kn().partial}catch(e){}Eo(),Wo();try{await async function(e,t,n){if(!N.firebase.ok||!e)return;const o=N.firebase.api,i=N.firebase.db,a=o.doc(i,"operatorStats",e);await o.runTransaction(i,async o=>{const i=await o.get(a),r=i.exists()&&i.data()||{},s=Number(r.totalKg||0)+Number(n||0),l=Number(r.totalRuns||0)+1;o.set(a,{uid:e,fullName:t,totalKg:s,totalRuns:l,updatedAt:pe()},{merge:!0})})}(N.user?.uid||"",N.user?.fullName||e.operator||"Operatore",c)}catch(e){}Fn(`Ordine concluso da ${N.user?.fullName||e.operator||"Operatore"}  ordine ${e.orderNo}  cliente ${e.customer}`),Ve("Produzione conclusa",`Operatore ${N.user?.fullName||e.operator||"Operatore"}  Ordine n. ${e.orderNo}  ${Math.round(c)} kg`),Ve("Ordine concluso",`Ordine n. ${e.orderNo} registrato tra i conclusi.`,2200),gi(),b(),m.blur?.(),t(!0)},()=>t(!1))});r=Boolean(g)}catch(e){console.error("Errore conclusione",e),Ve("Errore conclusione","Riprova tra poco o verifica la connessione.")}finally{p.set(u,!1),r||f(!1,m?.dataset?.defaultLabel||"HO CONCLUSO LA PRODUZIONE")}}),(async()=>{await y()&&b()})()),d()}function bi(){U("partialModal").classList.add("show"),it(),li()}function hi(){U("partialModal").classList.remove("show"),at()}const yi={canvas:null,ctx:null,drawing:!1,empty:!0,last:{x:0,y:0},dpr:1};function vi(){if(!yi.canvas)return;const e=yi.canvas.getBoundingClientRect();yi.ctx.clearRect(0,0,e.width,e.height),yi.empty=!0}function wi(){return/iphone|ipad|ipod/i.test(navigator.userAgent||"")}function _i(){const e=U("dotPush"),t=U("txtPush");if(!e||!t)return;const n="undefined"!=typeof Notification?Notification.permission:"unsupported";return N.push.permission=n,N.push.supported?"granted"!==n?(e.className="dot",void(t.textContent="Notifiche: disattive")):(e.className="dot ok",void(t.textContent="Notifiche: attive")):(e.className="dot",void(t.textContent="Notifiche: non supportate"))}async function Si(){if(!("serviceWorker"in navigator))throw new Error("Service worker non supportati");const e=new URL("firebase-messaging-sw.js",location.href).toString();return await navigator.serviceWorker.register(e,{scope:"./"})}async function Ai(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}function Ti(){return Array.from(document.querySelectorAll("style")).map(e=>e.textContent||"").join("\n")}function Li(e,t){const n=Ti?Ti():"",o=document.createElement("iframe");o.setAttribute("aria-hidden","true"),o.style.position="fixed",o.style.right="0",o.style.bottom="0",o.style.width="0",o.style.height="0",o.style.border="0";const i=`<!doctype html><html><head><meta charset="utf-8">\n      <title>${a=t||"Stampa",String(a||"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))}</title>\n      <style></style>\n    </head><body>${e.outerHTML}</body></html>`;var a;o.srcdoc=i,o.onload=()=>{try{o.contentWindow.focus(),o.contentWindow.print()}catch(e){}setTimeout(()=>o.remove(),600)},document.body.appendChild(o)}function Ci(e){const t=String(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z\s]/g," ").replace(/\s+/g," ").trim().toUpperCase().split(" ").filter(e=>e&&e.length>=2);return{normalized:t.join(" ").trim(),tokens:t}}function Ei(e){const t=String(e||""),n=t.match(/\b(20[0-9]{2})[-/.](0[1-9]|1[0-2])\b/),o=n?`${n[1]}-${n[2]}`:null,i=t.match(/(?:netto|paga|compenso)[^0-9]{0,12}([0-9]{1,3}(?:[.][0-9]{3})*(?:,[0-9]{2})?)/i)||t.match(/([0-9]{1,3}(?:[.][0-9]{3})*(?:,[0-9]{2}))\s*(?:|euro|eur)/i),a=i?i[1]:null;let r=null;if(a){const e=a.replace(/\./g,"").replace(/,/g,"."),t=parseFloat(e);Number.isFinite(t)&&(r=Math.round(100*t))}let s=null;const l=t.match(/\b([A-Z-]{2,}(?:\s+[A-Z-]{2,}){1,4})\b/);return l&&(s=l[1].replace(/\s+/g," ").trim()),{monthKey:o,netPayText:a,netPayCents:r,fullName:s}}function Ni(e,t,n){const o=Ci(e),i=Ci(t),a=Ci(n||"").normalized,r=new Set(o.tokens),s=new Set(i.tokens),l=Array.from(r).filter(e=>s.has(e)),c=r.size?l.length/r.size:0,d=o.tokens[o.tokens.length-1]||"",u=d&&s.has(d);let m=c+(u?.2:-.3)+(a.includes(o.normalized)?.25:0);return m=Math.max(0,Math.min(1,m)),{score:m,tokenOverlap:c,lastNameMatch:u,extractedTokens:i.tokens}}async function xi(e,t){const{PDFDocument:n}=await import("https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"),o=await n.load(e),i=await n.create();(await i.copyPages(o,t)).forEach(e=>i.addPage(e));return await i.save()}async function $i(e,t,n){if(!(N.firebase&&N.firebase.storage&&N.firebase.storageApi))throw new Error("Storage non disponibile");const o=N.firebase.storageApi,i=N.firebase.storage,a=`payroll/${t}/${e}.pdf`,r=o.ref(i,a),s=await o.uploadBytes(r,n,{contentType:"application/pdf"});return{path:a,url:await o.getDownloadURL(s.ref)}}async function ki(e){const t=N.firebase.api,n=N.firebase.db,o=`${e.uid}_${e.monthKey}`,i=t.doc(n,"payrollDocs",o);await t.setDoc(i,{...e,updatedAt:t.serverTimestamp(),createdAt:e.createdAt||t.serverTimestamp()},{merge:!0})}function Mi(){try{const e=document.querySelector(".desktopCol.mainCol")||document.querySelector(".mainCol")||document.querySelector(".grid");if(e&&!document.getElementById("payrollUserCard")){const t=document.createElement("div");t.className="payrollCard",t.id="payrollUserCard",t.innerHTML='\n          <div class="pcHead">\n            <div>\n              <div class="pcTitle">Busta paga</div>\n              <div class="pcSub">Consulta le tue buste paga in stile Apple.</div>\n            </div>\n            <div class="pcBadge" id="payrollUserBadge">Live</div>\n          </div>\n          <div class="pcBody">\n            <div class="pcActionRow">\n              <button class="payrollBtn primary" id="btnOpenPayrollUser" type="button">Apri buste paga</button>\n              <div class="pcHint" id="payrollUserHint">Accesso riservato al tuo profilo.</div>\n            </div>\n          </div>';const n=document.getElementById("opsCard")||document.querySelector(".heroCard");n&&n.parentElement===e?n.insertAdjacentElement("afterend",t):e.appendChild(t)}const t=document.getElementById("adminMobileStack")||document.querySelector(".adminMobileStack");if(t&&!document.getElementById("payrollAdminCard")){const e=document.createElement("div");e.className="payrollCard adminOnly",e.id="payrollAdminCard",e.innerHTML='\n          <div class="pcHead">\n            <div>\n              <div class="pcTitle">Upload buste paga</div>\n              <div class="pcSub">Carica PDF, estrai con Gemini e invia.</div>\n            </div>\n            <div class="pcBadge" id="payrollAdminStatus">IDLE</div>\n          </div>\n          <div class="pcBody">\n            <div class="pcActionRow">\n              <button class="payrollBtn primary" id="btnOpenPayrollAdmin" type="button">Apri upload</button>\n              <button class="payrollBtn secondary" id="btnPayrollReloadUsers" type="button">Ricarica utenti</button>\n              <div class="pcHint">Solo admin.</div>\n            </div>\n          </div>',t.insertBefore(e,t.firstChild)}}catch(e){}}function Oi(){const e=Boolean(N.user&&N.user.isAdmin),t=U("payrollAdminCard");t&&(t.style.display=e?"":"none");const n=U("payrollUserBadge"),o=U("payrollUserHint"),i=N.payroll?.userView||{};if(n){const e=i.months?.[0]||"";n.textContent=i.ready?`Ultimo: ${e||""}`:"Sync"}o&&(i.error?(o.textContent=i.error,o.style.color="var(--bad)"):o.textContent="Accesso riservato al tuo profilo.");const a=U("payrollAdminStatus");if(a){const e=N.payroll?.admin?.step||"idle";a.textContent=e.toUpperCase()}}function Di(e){N.payroll.admin.step=e;const t={idle:U("payrollStepIdle"),extracting:U("payrollStepExtract"),preview:U("payrollStepPreview"),match:U("payrollStepMatch"),sending:U("payrollStepSending")};Object.entries(t).forEach(([t,n])=>{n&&(n.style.display=t===e?"flex":"none")});const n=U("payrollAdminStepLabel");n&&(n.textContent=e.charAt(0).toUpperCase()+e.slice(1))}function Bi(){const e=U("payrollAdminFileLabel");if(!e)return;const t=N.payroll.admin.files?.[0];e.textContent=t?t.name:"Nessun file"}function Ii(){const e=N.payroll.admin.gemini.pages||[],t=U("payrollPreviewTable"),n=U("payrollMissingPages"),o=U("payrollMissingList");if(!t)return;const i=e.map(e=>{const t=e.fields||{},n=e.errorReason?"tone-bad":t.fullName&&t.monthKey&&t.netPayText?"tone-ok":"tone-warn",o=e.errorReason?"ERRORE":t.fullName&&t.monthKey&&t.netPayText?"OK":"CAMPI MANCANTI",i=String(e.rawText||"").slice(0,180).replace(/\s+/g," ").trim();return`<tr><td>${e.pageIndex}</td><td>${Ao(t.fullName||"")}</td><td>${Ao(t.monthKey||"")}</td><td>${Ao(t.netPayText||"")}</td><td>${null!=e.confidence?(100*e.confidence).toFixed(0)+"%":""}</td><td><div class="snippet">${Ao(i)}</div></td><td><span class="badgeTone ${n}">${o}</span></td></tr>`}).join("");t.innerHTML="<tr><th>#</th><th>Nome</th><th>Mese</th><th>Netto</th><th>Conf.</th><th>Snippet</th><th>Stato</th></tr>"+i;const a=e.filter(e=>!e.fields||!e.fields.monthKey||!e.fields.netPayText);n&&(n.style.display=a.length?"block":"none",o&&(o.textContent=a.map(e=>e.pageIndex).join(", ")));const r=U("payrollPreviewMeta");r&&(r.textContent=`${e.length} pagine dal file`);const s=U("payrollPreviewBadge");s&&(s.textContent=a.length?"Campi mancanti":"OK")}function Pi(){const e=N.payroll.admin.match||{},t=U("payrollMatchedList"),n=U("payrollUnmatchedList");if(t){const n=e.grouped||[];t.innerHTML=n.length?n.map(e=>`<div class="row"><div><div class="pcTitle" style="font-size:15px;">${Ao(e.displayName||"Utente")}</div><div class="meta">Mese ${Ao(e.monthKey||"")}  Pagine: ${e.pageIndices.join(", ")}</div></div><div class="badgeTone tone-ok">${e.matchScore?e.matchScore.toFixed(2):""}</div></div>`).join(""):'<div class="pcHint">Nessun match.</div>'}if(n){const t=e.unmatched||[];n.innerHTML=t.length?t.map(e=>`<div class="row"><div><div class="pcTitle" style="font-size:15px;">Pagina ${e.pageIndex}</div><div class="meta">${Ao(e.reasonCode||"?")}  ${Ao(e.extracted.monthKey||"")}  ${Ao(e.extracted.netPayText||"")}</div><div class="snippet">${Ao(String(e.rawText||"").slice(0,140))}</div></div><div class="badgeTone ${"ambiguous"===e.status?"tone-warn":"tone-bad"}">${e.status}</div></div>`).join(""):'<div class="pcHint">Tutte le pagine matchate.</div>'}const o=U("payrollMatchOk"),i=U("payrollMatchAmbig"),a=U("payrollMatchNo");o&&(o.textContent=e.matchedCount||0),i&&(i.textContent=e.ambiguousCount||0),a&&(a.textContent=e.unmatchedCount||0);const r=U("payrollAdminMatchLabel");r&&(r.textContent=`Matchati ${e.matchedCount||0}`);const s=U("btnPayrollSend");s&&(s.disabled=!(e.matchedCount>0)||e.ambiguousCount>0)}async function zi(){if(!(N.firebase?.ok&&N.user&&N.user.isAdmin))return;const e=N.payroll.admin;if(!(e.loadingUsers||e.users&&e.users.length)){e.loadingUsers=!0;try{const t=N.firebase.api,n=N.firebase.db,o=await t.getDocs(t.query(t.collection(n,"powderUsers"),t.where("enabled","==",!0)));e.users=o.docs.map(e=>({id:e.id,uid:e.id,...e.data()}))}catch(e){console.warn("load payroll users",e)}e.loadingUsers=!1}}async function Fi(){if(!N.firebase?.ok||!N.user)return;const e=N.payroll.userView;e.loading=!0;try{const t=N.firebase.api,n=N.firebase.db,o=(await t.getDocs(t.query(t.collection(n,"payrollDocs"),t.where("uid","==",N.user.uid),t.orderBy("monthKey","desc")))).docs.map(e=>({id:e.id,...e.data()||{}}));e.docs=o,e.months=o.map(e=>e.monthKey).filter(Boolean),e.selectedMonth=e.selectedMonth||e.months[0]||"",e.error="",e.ready=!0}catch(t){console.warn("load payroll docs error",t),e.error="Storico non disponibile"}e.loading=!1,Oi(),Ri()}function Ri(){const e=N.payroll.userView,t=U("payrollMonthSelect");t&&(t.innerHTML=e.months.map(e=>`<option value="${Ao(e)}">${Ao(e)}</option>`).join(""),e.selectedMonth&&(t.value=e.selectedMonth),t.onchange=()=>{e.selectedMonth=t.value,Ki()}),Ki()}async function Ki(){const e=N.payroll.userView,t=e.docs.find(t=>t.monthKey===e.selectedMonth)||e.docs[0];if(!t){const e=U("payrollUserNet");return void(e&&(e.textContent="Nessuna busta paga"))}e.selectedMonth=t.monthKey;const n=U("payrollUserMonthBadge");n&&(n.textContent=t.monthKey);const o=U("payrollUserAmountBadge");o&&(o.textContent=t.netPayText||"");const i=U("payrollUserNet");i&&(i.textContent=`Questo mese hai guadagnato: ${t.netPayText||""}`);const a=U("payrollUserDocMeta");a&&(a.textContent=`Documento: ${t.monthKey}`);const r=U("payrollUserDate");r&&(r.textContent=t.updatedAt?"Aggiornato":"Caricato");const s=U("payrollUserPdfFrame");if(s)try{const n=N.firebase.storageApi,o=N.firebase.storage;if(!n||!o)return s.src="",void(e.currentUrl="");if(t.storagePath){const o=await n.getDownloadURL(n.ref(N.firebase.storage,t.storagePath));s.src=o,e.currentUrl=o}else s.src="",e.currentUrl=""}catch(e){console.warn("load payroll pdf",e),s.src=""}}function Hi(){U("payrollUserModal").style.display="flex",Ri(),it()}function Ui(){U("payrollUserModal").style.display="none",at()}function qi(){U("payrollAdminModal").style.display="flex",it(),Oi()}function Wi(){U("payrollAdminModal").style.display="none",at()}function ji(){const e=N.payroll.admin;e.files=[],e.originalPdfBytes=null,e.gemini={loading:!1,error:"",pages:[]},e.match={pages:[],grouped:[],unmatched:[],matchedCount:0,ambiguousCount:0,unmatchedCount:0},e.sendSummary=null,e.sourceFileName="",e.sourceFileHash="",Di("idle"),Bi(),Ii(),Pi()}document.addEventListener("click",async e=>{const t=e.target.closest("button[data-action]");if(!t)return;e.preventDefault(),e.stopPropagation();if(!Boolean(N&&N.user&&N.user.isAdmin))return;const n=document.querySelector(t.dataset.target);if(!n)return;const o=(new Date).toLocaleString("it-IT"),i=(n.querySelector(".cardTitle, .title, h2, h3")?.innerText||"Report").trim();var a;if("print"!==t.dataset.action){if("share"===t.dataset.action){const e=(a=n)?(a.innerText||"").replace(/\s+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim():"";return void await async function({title:e,text:t}={}){const n=e||document.title||"Report",o=t||"";if(navigator.share)await navigator.share({title:n,text:o});else try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(o);else{const e=document.createElement("textarea");e.value=o,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e),e.select(),document.execCommand("copy"),e.remove()}try{Ve("Copiato","Testo condiviso copiato negli appunti.")}catch(e){alert("Copiato")}}catch(e){try{Ve("Condivisione non riuscita","Impossibile condividere il testo.")}catch(e){}}}({title:i,text:`${i}\n${o}\n\n${e}`})}}else Li(n,i)});async function Vi(){const e=N.payroll.admin,t=e.files?.[0];if(t){Di("extracting"),e.gemini={loading:!0,error:"",pages:[]};try{const n=new FormData;n.append("file",t);const o=await fetch("https://gemini-pdf-extract-537555699968.europe-west1.run.app/extract",{method:"POST",body:n});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json();e.gemini.pages=Array.isArray(i.pages)?i.pages:[],e.sourceFileName=i.sourceFileName||t.name;const a=await t.arrayBuffer();e.originalPdfBytes=a;const r=await crypto.subtle.digest("SHA-256",a);e.sourceFileHash=Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join(""),Di("preview"),Ii()}catch(t){e.gemini.error=t?.message||String(t),Ve("Estrazione fallita",e.gemini.error),Di("idle")}finally{e.gemini.loading=!1}}else Ve("Seleziona PDF","Carica prima un file.")}async function Gi(){const e=N.payroll.admin,t=e.gemini.pages||[];if(!t.length)return void Ve("Nessuna pagina","Esegui prima lestrazione.");await zi();const n=function(e,t){const n=[],o=Array.isArray(e)?e:[];for(const e of o){const o=String(e?.rawText||""),i=e?.fields||null,a=i&&i.monthKey&&i.netPayText&&i.fullName?{}:Ei(o),r=i&&i.fullName||a.fullName||"",s=i&&i.monthKey||a.monthKey||null,l=i&&i.netPayText||a.netPayText||null,c=i&&null!=i.netPayCents?i.netPayCents:a.netPayCents??null,d=Ci(r).tokens;let u="OK";(!d||d.length<2)&&(u="NO_NAME_FOUND"),s||(u="MISSING_MONTHKEY"),l||(u="OK"===u?"MISSING_NETPAY":u);let m=null,p=null;for(const e of t||[]){const t=[e.displayName,...Array.isArray(e.payrollAliases)?e.payrollAliases:[]].filter(Boolean);for(const n of t){const t=Ni(n,r||o,o);!m||t.score>m.score?(p=m,m={...t,user:e}):(!p||t.score>p.score)&&(p={...t,user:e})}}let g="unmatched",f=null;const b=m?.score||0,h=b-(p?.score||0),y=m?.lastNameMatch,v=m?(m?.extractedTokens||[]).filter(e=>Ci(m.user.displayName).tokens.includes(e)):[],w=v.length>=2||y&&v.length>=2;"OK"===u&&y&&w&&b>=.88&&h>=.08?(g="matched",f={uid:m.user.uid||m.user.id||"",displayName:m.user.displayName||"",score:b},u="OK"):"OK"===u&&b>=.8?(g="ambiguous",u="AMBIGUOUS"):"OK"===u&&(u="LOW_SCORE"),n.push({pageIndex:e?.pageIndex??n.length,extracted:{fullName:r||"",monthKey:s,netPayText:l,netPayCents:c},match:f,status:g,reasonCode:u,rawText:o,fields:i||null,confidence:e?.confidence??null})}return n}(t,e.users||[]),o=function(e){const t=new Map;for(const n of e||[]){if("matched"!==n.status||!n.match)continue;const e=`${n.match.uid||""}__${n.extracted.monthKey||""}`;t.has(e)||t.set(e,{uid:n.match.uid||"",displayName:n.match.displayName||"",monthKey:n.extracted.monthKey||"",netPayText:n.extracted.netPayText||"",netPayCents:n.extracted.netPayCents||null,matchScore:n.match.score||0,pageIndices:[]});const o=t.get(e);o.pageIndices.push(n.pageIndex),!o.netPayText&&n.extracted.netPayText&&(o.netPayText=n.extracted.netPayText),null==o.netPayCents&&null!=n.extracted.netPayCents&&(o.netPayCents=n.extracted.netPayCents),n.match.score>o.matchScore&&(o.matchScore=n.match.score)}const n=Array.from(t.values());return n.forEach(e=>e.pageIndices.sort((e,t)=>e-t)),n}(n),i=n.filter(e=>"matched"!==e.status),a=n.filter(e=>"matched"===e.status).length,r=n.filter(e=>"ambiguous"===e.status).length;e.match={pages:n,grouped:o,unmatched:i,matchedCount:a,ambiguousCount:r,unmatchedCount:i.length},Pi(),Di("match")}async function Yi(){const e=N.payroll.admin;if(!(e.match?.matchedCount>0))return void Ve("Nessun match","Devi avere almeno un match valido.");if(!e.originalPdfBytes)return Ve("PDF mancante","Riesegui lestrazione."),void Di("preview");Di("sending");const t={matched:e.match.matchedCount||0,ambiguous:e.match.ambiguousCount||0,unmatched:e.match.unmatchedCount||0},n=e.match.grouped||[];try{for(const t of n){const n=(e.users||[]).find(e=>(e.uid||e.id)===t.uid)||{},o=N.firebase.api,i=N.firebase.db,a=`${t.uid}_${t.monthKey}`,r=await o.getDoc(o.doc(i,"payrollDocs",a)),s=r.exists()?r.data()||{}:null,l=s&&s.sourceFileHash===e.sourceFileHash,c=s&&Array.isArray(s.pageIndices)&&s.pageIndices.join(",")===t.pageIndices.join(",");let d={path:s?.storagePath||`payroll/${t.monthKey}/${t.uid}.pdf`,url:s?.downloadUrl};if(!l||!c){const n=await xi(e.originalPdfBytes,t.pageIndices);d=await $i(t.uid,t.monthKey,n)}await ki({uid:t.uid,emailLower:(n.emailLower||n.email||"").toLowerCase(),fullName:t.displayName||n.displayName||"",monthKey:t.monthKey,netPayCents:t.netPayCents,netPayText:t.netPayText,storagePath:d.path,source:"gemini",sourceFileName:e.sourceFileName,sourceFileHash:e.sourceFileHash,pageIndices:t.pageIndices,matchScore:t.matchScore})}await async function(e){try{const t=N.firebase.api,n=N.firebase.db,o=t.collection(n,"payrollIngestLogs");await t.addDoc(o,e)}catch(e){}}({createdAt:N.firebase.api.serverTimestamp(),adminUid:N.user?.uid||"",sourceFileName:e.sourceFileName,sourceFileHash:e.sourceFileHash,totalPages:e.gemini.pages?.length||0,matchedCount:t.matched,ambiguousCount:t.ambiguous,unmatchedCount:t.unmatched,details:e.match.pages}),t.status="ok",Ve("Inviato","Buste paga inviate."),await Fi()}catch(e){console.warn("payroll send error",e),t.status=e?.message||String(e),Ve("Errore invio",t.status)}e.sendSummary=t;const o=U("payrollSendSummary");o&&(o.textContent=`Esito: ${t.status||""}  OK ${t.matched}  Ambigui ${t.ambiguous}  Non matchati ${t.unmatched}`)}await async function(){if(Mi(),globalThis.__HUB_BOOTED__)return;globalThis.__HUB_BOOTED__=!0,Yt(),dn();try{wt.addEventListener("change",_t)}catch(e){try{wt.addListener(_t)}catch(e){}}_t(),ze(),Me(),Ke(),Re(),window.addEventListener("resize",Re),window.addEventListener("resize",Fe),window.addEventListener("resize",He),window.addEventListener("resize",Je),window.addEventListener("orientationchange",He),window.addEventListener("orientationchange",Re),window.addEventListener("orientationchange",Je);try{vt&&vt.addEventListener("change",Re)}catch(e){try{vt&&vt.addListener(Re)}catch(e){}}globalThis.__STATS_CLEAR_HANDLER_BOUND__||(globalThis.__STATS_CLEAR_HANDLER_BOUND__=!0,document.addEventListener("click",e=>{const t=e.target?.closest("#btnClearHistory");t&&(N.user&&N.user.isAdmin?confirm("Confermi eliminazione dati storici? Questa azione non  reversibile.")&&le():Ve("Accesso limitato","Solo gli amministratori possono azzerare le statistiche."))})),U("btnGoProd").addEventListener("click",()=>function(){const e=N.activeProductions||[],t=N.user?.fullName||N.operator||"";t&&e.some(e=>Un(e.operator||e.operatorName||"",t))?pi():ai()}());try{const e=U("partialBanner");e?.addEventListener("click",()=>bi()),e?.addEventListener("keydown",e=>{"Enter"!==e.key&&""!==e.key||(e.preventDefault(),bi())})}catch(e){}try{U("partialClose").addEventListener("click",()=>hi())}catch(e){}try{U("partialModal").addEventListener("click",e=>{e.target===U("partialModal")&&hi()})}catch(e){}U("prodStrip").addEventListener("click",()=>pi());try{U("cancelBannerClose").addEventListener("click",()=>Ye())}catch(e){}U("prodModalClose").addEventListener("click",()=>(U("prodModal").classList.remove("show"),void at())),U("runningClose").addEventListener("click",()=>{U("runningModal").classList.remove("show"),at()});try{U("histClose").addEventListener("click",()=>{U("histModal").classList.remove("show"),at()}),U("histModal").addEventListener("click",e=>{e.target===U("histModal")&&(U("histModal").classList.remove("show"),at())})}catch(e){}try{U("whModalClose")?.addEventListener("click",()=>Ro()),U("whModal")?.addEventListener("click",e=>{e.target===U("whModal")&&Ro()})}catch(e){}window.addEventListener("keydown",e=>{"Escape"===e.key&&Ro()});try{U("notifClose").addEventListener("click",()=>ti()),U("notifModal").addEventListener("click",e=>{e.target===U("notifModal")&&ti()})}catch(e){}try{U("btnNotifCompleted").addEventListener("click",()=>function(){ti();const e=U("completedCard");e&&(e.scrollIntoView({behavior:"smooth",block:"start"}),e.classList.add("pressCard"),setTimeout(()=>e.classList.remove("pressCard"),1200))}())}catch(e){}try{U("btnTogglePush").addEventListener("click",()=>ii())}catch(e){}try{U("btnSendNotif").addEventListener("click",async()=>{const e=U("notifAdminFeedback");if(!N.user||!N.user.isAdmin)return Ve("Solo admin","Non hai i permessi per inviare notifiche."),void(e&&(e.textContent="Permesso mancante."));const t=(U("notifTitle")?.value||"").trim(),n=(U("notifBodyInput")?.value||"").trim();if(!t||!n)return Ve("Testo mancante","Inserisci titolo e testo della notifica."),void(e&&(e.textContent="Titolo e testo obbligatori."));e&&(e.textContent="Invio");try{await Xo(t,n),e&&(e.textContent="Notifica inviata.");const o=U("notifBodyInput");o&&(o.value="")}catch(t){console.warn("send notif error",t),e&&(e.textContent="Invio non riuscito (permessi o rete)."),Ve("Invio non riuscito","Controlla i permessi Firestore o la rete.")}})}catch(e){}U("fatValue").addEventListener("click",()=>{const e=U("fatValue"),t=Boolean(N.user&&N.user.isAdmin),n=window.matchMedia("(min-width: 980px)").matches;if(t||n)return e.classList.add("reveal"),void mo();e.classList.toggle("reveal"),mo()});const e="+393516709334";U("btnCallMatteoBig")?.addEventListener("click",()=>{window.location.href=`tel:${e}`}),U("btnCallMatteo").addEventListener("click",()=>{window.location.href=`tel:${e}`}),U("btnOpenStats").addEventListener("click",()=>{Ve("Statistiche","Sezione statistiche completa in fondo alla pagina."),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})});try{U("btnMobileStats")?.addEventListener("click",e=>{e.preventDefault(),function(){const e=document.getElementById("statsProduzione")||document.getElementById("statsProdCard")||document.getElementById("statsCardAnchor");if(e){const t=e.nextElementSibling&&e.nextElementSibling.classList?.contains("card")?e.nextElementSibling:null,n=e.closest(".card")||t||e;try{n.scrollIntoView({behavior:"smooth",block:"start"})}catch(e){const t=n.getBoundingClientRect().top+window.pageYOffset-12;window.scrollTo({top:t,behavior:"smooth"})}return}window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}()})}catch(e){}try{U("btnSendAlert")?.addEventListener("click",async()=>{const e=U("alertFeedback");if(!Boolean(N.user&&N.user.isAdmin))return Ve("Solo admin","Non hai i permessi per inviare avvisi."),void(e&&(e.textContent="Permesso mancante."));const t=U("alertMessageInput"),n=U("alertExpireInput"),o=(t?.value||"").trim(),i=Number(n?.value||0),a=Number.isFinite(i)?Math.max(0,i):0,r=a>0?Date.now()+60*a*1e3:0;if(!o)return Ve("Testo mancante","Inserisci il messaggio dellavviso."),void(e&&(e.textContent="Testo avviso obbligatorio."));if(!N.alertSaving){N.alertSaving=!0,e&&(e.textContent="Invio");try{await async function(e,t=0){if(!N.firebase.ok)throw new Error("Firebase non disponibile");const n=N.firebase.api,o=N.firebase.db,i={id:`${Date.now()}`,message:e,createdAt:Date.now(),expiresAt:Number(t||0)};return await n.setDoc(Ze(n,o),i,{merge:!0}),i}(o,r),e&&(e.textContent="Avviso inviato."),t&&(t.value="")}catch(t){console.warn("send alert error",t),e&&(e.textContent="Invio non riuscito (permessi o rete)."),Ve("Invio non riuscito","Controlla permessi Firestore o la rete.")}finally{N.alertSaving=!1}}})}catch(e){}try{U("btnCancelAlert")?.addEventListener("click",async()=>{const e=U("alertFeedback");if(!Boolean(N.user&&N.user.isAdmin))return Ve("Solo admin","Non hai i permessi per annullare avvisi."),void(e&&(e.textContent="Permesso mancante."));if(!N.alertSaving){N.alertSaving=!0,e&&(e.textContent="Annullamento");try{await async function(){if(!N.firebase.ok)throw new Error("Firebase non disponibile");const e=N.firebase.api,t=N.firebase.db,n={id:`${Date.now()}`,message:"",clearedAt:Date.now(),expiresAt:0};return await e.setDoc(Ze(e,t),n,{merge:!0}),n}(),Xe(),et(),e&&(e.textContent="Avviso annullato.")}catch(t){console.warn("cancel alert error",t),e&&(e.textContent="Annullamento non riuscito (permessi o rete)."),Ve("Annullamento non riuscito","Controlla permessi Firestore o la rete.")}finally{N.alertSaving=!1}}})}catch(e){}U("btnHeaderPayrollUser")?.addEventListener("click",async()=>{await Fi(),Hi()}),U("btnHeaderPayrollAdmin")?.addEventListener("click",async()=>{N.user&&N.user.isAdmin?(await zi(),qi()):Ve("Solo admin","Funzione riservata.")}),U("btnOpenPayrollUser")?.addEventListener("click",async()=>{await Fi(),Hi()}),U("payrollUserClose")?.addEventListener("click",()=>Ui()),U("payrollUserModal")?.addEventListener("click",e=>{e.target===U("payrollUserModal")&&Ui()}),U("btnPayrollPrint")?.addEventListener("click",()=>{const e=N.payroll.userView.currentUrl;if(!e)return void Ve("PDF non pronto","Seleziona un mese disponibile.");const t=window.open(e,"_blank");try{t?.print()}catch(e){}}),U("btnPayrollShare")?.addEventListener("click",async()=>{const e=N.payroll.userView.currentUrl;if(e)try{navigator.share?await navigator.share({title:"Busta paga",url:e}):navigator.clipboard&&(await navigator.clipboard.writeText(e),Ve("Link copiato","URL copiato negli appunti."))}catch(e){Ve("Condivisione non riuscita","Riprovare.")}else Ve("PDF non pronto","Seleziona un mese disponibile.")}),U("btnOpenPayrollAdmin")?.addEventListener("click",async()=>{N.user&&N.user.isAdmin?(await zi(),qi()):Ve("Solo admin","Funzione riservata.")}),U("payrollAdminClose")?.addEventListener("click",()=>{Wi()}),U("payrollAdminModal")?.addEventListener("click",e=>{e.target===U("payrollAdminModal")&&Wi()}),U("btnPayrollReloadUsers")?.addEventListener("click",()=>zi());const t=U("payrollDrop"),n=U("payrollFileInput"),o=e=>{N.payroll.admin.files=e&&e.length?[e[0]]:[],Bi()};t&&(["dragover","dragenter"].forEach(e=>t.addEventListener(e,e=>{e.preventDefault(),t.classList.add("drag")})),["dragleave","drop"].forEach(e=>t.addEventListener(e,e=>{e.preventDefault(),t.classList.remove("drag")})),t.addEventListener("drop",e=>{e.preventDefault(),e.dataTransfer?.files?.length&&o(e.dataTransfer.files)})),U("btnPayrollSelect")?.addEventListener("click",()=>n?.click()),n?.addEventListener("change",()=>o(n.files)),U("btnPayrollUpload")?.addEventListener("click",()=>Vi()),U("btnPayrollRetry")?.addEventListener("click",()=>Vi()),U("btnPayrollReset")?.addEventListener("click",()=>ji()),U("btnPayrollReset2")?.addEventListener("click",()=>ji()),U("btnPayrollReset3")?.addEventListener("click",()=>ji()),U("btnPayrollMatch")?.addEventListener("click",()=>Gi()),U("btnPayrollBackPreview")?.addEventListener("click",()=>Di("preview")),U("btnPayrollSend")?.addEventListener("click",()=>Yi());const i=U("btnSendIssue");i&&i.addEventListener("click",async()=>{const e=U("issueText"),t=(e?.value||"").trim();if(!t)return void Ve("Segnalazione","Scrivi il problema prima di inviare.");if(!N.user)return void Zt("Per inviare una segnalazione  necessario accedere.");const n={operator:N.user.fullName||"Operatore",operatorUid:N.user.uid,text:t,when:ge(Date.now()),kind:"problema_macchina_o_prodotto",url:location.href,ua:navigator.userAgent};await Cn(n),e&&(e.value=""),Ve("Segnalazione registrata","Ok. La segnalazione  stata salvata. Per urgenze: usa Chiama Matteo.",3200)}),document.addEventListener("visibilitychange",()=>{document.hidden||Mt("focus")}),window.addEventListener("focus",()=>Mt("focus")),window.addEventListener("pageshow",e=>{!e.persisted&&document.hidden||Mt("pageshow")});try{window.matchMedia("(min-width: 980px)").addEventListener("change",()=>mo())}catch(e){}document.documentElement.setAttribute("translate","no"),document.body.setAttribute("translate","no"),document.addEventListener("gesturestart",e=>e.preventDefault(),{passive:!1}),document.addEventListener("gesturechange",e=>e.preventDefault(),{passive:!1}),document.addEventListener("gestureend",e=>e.preventDefault(),{passive:!1}),document.addEventListener("wheel",e=>{e.ctrlKey&&e.preventDefault()},{passive:!1}),Di("idle"),Bi(),await dt();try{!function(){const e=U("pillPush");e&&e.addEventListener("click",()=>{ei()})}(),_i(),Jo(),Qo()}catch(e){}try{!function(){if(globalThis.__REFRESH_BTN_BOUND__)return;const e=U("btnHeaderRefresh");e&&(globalThis.__REFRESH_BTN_BOUND__=!0,e.addEventListener("click",async()=>{if(globalThis.__updateInFlight__||kt||W)return;Dt(!1),e.classList.add("isSpinning");let t=!1;try{await Ot("manual_btn"),t=!q.inError}catch(e){console.warn("manual refresh failed",e)}finally{setTimeout(()=>e.classList.remove("isSpinning"),850),t||Dt(!0)}}))}()}catch(e){}}();</script><script>/* UI-only: collassa il titolo header quando si scrolla (desktop), senza toccare logiche Google/Firebase */
(function(){
  function isDesk(){ return window.matchMedia && window.matchMedia("(min-width: 1024px)").matches; }
  const wrap = document.querySelector(".wrap");
  function getScrollTop(){
    if(wrap){
      const oy = getComputedStyle(wrap).overflowY;
      if(oy && oy !== "visible") return wrap.scrollTop || 0;
    }
    return window.scrollY || document.documentElement.scrollTop || 0;
  }

  // UI: onScroll (kept minimal). Serve per evitare ReferenceError e riallineare elementi top (banner/spacer).
  function onScroll(){
    try{ syncAlertSpacerHeight(); }catch(_e){}
  }
  /* UI-DESKTOP: header scroll-hide removed */
window.addEventListener("resize", onScroll, {passive:true});
  window.addEventListener("pageshow", onScroll, {passive:true});
  onScroll();
})();</script></div></body></html>