<!doctype html><html lang="it" translate="no"><head><meta charset="utf-8"/><link rel="preconnect" href="https://www.gstatic.com" crossorigin><link rel="preconnect" href="https://accounts.google.com" crossorigin><link rel="preconnect" href="https://apis.google.com" crossorigin><link rel="preconnect" href="https://script.google.com" crossorigin><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/><meta name="google" content="notranslate"/><meta http-equiv="Content-Language" content="it"/><meta name="color-scheme" content="light"/><title>Hub Linea Polveri</title><link rel="stylesheet" href="hub_linea_polveri_test_busta_FIX_OK.css"><link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2716%27 fill=%27%232e7bff%27/%3E%3Cpath d=%27M22 43c0-11 8-20 20-20h2v6h-2c-8 0-14 6-14 14v2h-6v-2z%27 fill=%27white%27/%3E%3Cpath d=%27M40 33a6 6 0 1 1 0-12h2v6h-2a0 0 0 0 0 0 0 0 0 0 0 0 0 6z%27 fill=%27white%27 opacity=%270.9%27/%3E%3C/svg%3E">
  

  
  
  
  
  
  
  
  <link rel="manifest" href="/tabellone-produzione-live/manifest.webmanifest"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#0b0f14"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="Hub Polveri"><link rel="apple-touch-icon" href="icons/apple-touch-icon.png"></head><body><div id="startup"><div class="startupCard"><div class="a">Avviso aziendale</div><div class="b">
        I dati visualizzati in questo sistema sono <b>riservati</b> e destinati esclusivamente all‚Äôuso interno.<br/>
        √à vietata qualsiasi condivisione o diffusione non autorizzata al di fuori dell‚Äôazienda.<br/>
        Eventuali violazioni potranno comportare <b>provvedimenti disciplinari</b> e <b>azioni legali</b> secondo quanto previsto dalle normative vigenti.
        <div class="bootBar"><div id="bootFill"></div></div><div id="bootMsg" class="bootMsg">BOOT: inizializzazione‚Ä¶</div></div></div></div><div id="authLoader" class="authLoader" role="status" aria-live="polite"><div class="dot" aria-hidden="true"></div><div class="txt">Verifica accesso‚Ä¶</div></div><div id="authGate" role="dialog" aria-modal="true"><div class="authCard"><div class="ah">Accesso operatore</div><div class="ab" id="authBody"></div></div></div><div id="cancelBanner" class="topBanner" role="status" aria-live="polite"><div class="icon">‚õîÔ∏è</div><div class="body"><div class="title">Produzione annullata</div><div class="sub" id="cancelBannerSub">L‚Äôordine √® stato annullato.</div></div><button class="closeBtn" id="cancelBannerClose" type="button">Chiudi</button></div><div class="wrap"><header class="headerRow"><div class="brand"><img class="brandLogo" src="./logo%20general%20copper.png" alt="General Copper" decoding="async" loading="eager"><div class="titleWrap"><div class="title" aria-label="Hub linea polveri"><span class="titleLine">Hub Linea</span><span class="titleLine accent">Polveri</span></div><div class="subtitle">Benvenuto operatore <b id="hdrUser">Ludovico</b>, questo mese hai prodotto <span id="hdrMonthKg">0</span> kg e hai concluso <span id="hdrMonthOrders">0</span> ordini.</div></div></div><div class="statusRow actions"><div class="pill" id="pillOnline"><span class="dot warn" id="dotOnline"></span><span id="txtOnline">Stato: sincronizzazione‚Ä¶</span></div><div class="pill"><span class="dot ok"></span><span id="txtXmlTime">Ordini: aggiornati 2025-12-23T16:16:18.395Z</span></div><div class="pill pillQuiet" id="pillSync" style="display: flex;"><span class="dot warn" id="dotSync"></span><span id="txtSync">Aggiornamento‚Ä¶</span></div><button id="btnHeaderRefresh" class="iconBtn" type="button" aria-label="Aggiorna" title="Aggiorna"><span class="icon" aria-hidden="true">‚ü≥</span><span class="errBadge" id="refreshErrBadge">Errore rete</span></button><button class="iconBtn" id="btnHeaderPayrollUser" title="Busta paga" aria-label="Busta paga" type="button"><span class="icon" aria-hidden="true">üíº</span></button><button class="iconBtn adminOnly" id="btnHeaderPayrollAdmin" title="Upload buste paga" aria-label="Upload buste paga" type="button"><span class="icon" aria-hidden="true">‚¨ÜÔ∏é</span></button></div></header><div class="grid homeWrapOrMainContainer desktopShell"><div class="desktopCol mainCol"><div class="card heroCard" id="opsCard"><div class="hd"><h2>Operativit√†</h2><div class="badge" id="badgeCounts">‚Äî</div></div><div class="bd"><button class="primaryBtn" id="btnGoProd">VAI IN PRODUZIONE</button><div style="height:12px"></div><div id="partialBanner" class="warnBanner pressCard fadeCard" style="display:none;" role="button" tabindex="0" aria-label="Ordini parzialmente conclusi"><div class="icon">‚ö†Ô∏è</div><div class="txt"><div class="t" id="partialBannerTitle">Ci sono ordini parzialmente conclusi in corso</div><div class="s" id="partialBannerSub">Apri per vedere solo gli ordini parziali e concludere.</div></div><div class="badge">Apri</div></div><div style="height:12px"></div><div id="prodStrip" class="bigStrip" style="display:none;"><div class="label">Produzione in corso</div><div class="marquee"><span id="prodMarquee">‚Äî</span></div><div class="meta"><div class="metaCount"><b id="prodCount">0</b> attivit√† attive</div><div class="metaHint">Tap per dettagli e conclusione</div></div></div><div style="height:12px"></div><div class="kv"><div class="k"><div class="t">Righe polveri</div><div class="v" id="kPowderLines">‚Äî</div></div><div class="k"><div class="t">Kg totali</div><div class="v" id="kPowderKg">‚Äî</div><div class="muted" id="kPowderMeta" style="margin-top:4px; font-size:12px;">Calcolato su 0 righe visibili</div></div><div class="k" id="cardF480"><div class="t">Bobine F480 (stima)</div><div class="v" id="kBobineF480">‚Äî</div><div class="muted" id="kBobineF480Meta" style="margin-top:4px; font-size:12px;">Stima non disponibile</div></div><div class="k" id="cardF830"><div class="t">Bobine F830 (stima)</div><div class="v" id="kBobineF830">‚Äî</div><div class="muted" id="kBobineF830Meta" style="margin-top:4px; font-size:12px;">Stima non disponibile</div></div></div><div class="muted" id="kBobineUnknown" style="margin-top:6px; font-size:12px; display:none;">Non classificati: ‚Äî kg</div></div></div><div class="card" id="completedCard"><div class="hd"><h2 class="cardTitle">Ordini conclusi</h2><div class="cardTopActions adminOnly"><button type="button" class="miniBtn" data-action="print" data-target="#completedCard">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#completedCard">Condividi</button></div><div class="badge" id="completedBadge">0</div></div><div class="bd"><div class="rowsScroll" id="completedBody"><div class="list" id="completedList"></div><div class="muted" id="completedEmpty" style="display:none;">Nessuna produzione conclusa registrata.</div></div></div></div><div id="warehouseAnchor" style="display:none;" aria-hidden="true"></div><div class="card operatorOnly" id="callMatteoCard"><div class="bd"><button class="primaryBtn" id="btnCallMatteoBig" aria-label="Chiama Matteo" style="width:100%; border-radius:18px; padding:18px 18px;">Chiama Matteo</button></div></div><div class="card" id="warehouseCard"><div class="hd"><h2 class="cardTitle">Gestione magazzino</h2><div class="cardTopActions adminOnly"><button type="button" class="miniBtn" data-action="print" data-target="#warehouseCard">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#warehouseCard">Condividi</button></div><div class="badge" id="warehouseBadge">‚Äî</div></div><div class="bd"><button class="btn" id="btnWarehouseOpen" style="width:100%; display:none;">Apri gestione magazzino</button><div style="height:10px"></div><div id="warehouseBody"></div></div></div><div class="payrollCard" id="payrollUserCard"><div class="pcHead"><div><div class="pcTitle">Busta paga</div><div class="pcSub">Consulta le tue buste paga in stile Apple.</div></div><div class="pcBadge" id="payrollUserBadge">Live</div></div><div class="pcBody"><div class="pcActionRow"><button class="payrollBtn primary" id="btnOpenPayrollUser" type="button">Apri buste paga</button><div class="pcHint" id="payrollUserHint">Accesso riservato al tuo profilo.</div></div></div></div><div class="desktopCol sideCol"><div class="adminMobileHeader adminOnly" id="adminMobileHeader"><div class="eyebrow">Hub admin</div><div class="adminMobileTitle">Strumenti amministratore</div><div class="adminMobileSub">Parit√† contenuti desktop anche su mobile.</div></div><div class="adminMobileStack" id="adminMobileStack"><div class="card introCard adminOnly" id="desktopSummaryCard"><div class="introTop"><div class="eyebrow">Hub admin</div><div class="introTitle">Panoramica operativa</div><div class="introLead">Vista coerente con il layout mobile, dedicata agli amministratori.</div></div><div class="summaryGrid"><div class="summaryTile"><div class="t">Fatturato lordo</div><div class="summaryValue blur" id="fatValue">‚Ç¨ ‚Äî</div><div class="muted" id="fatSubtitle">Visibile per gli amministratori su ogni dispositivo.</div></div><div class="summaryTile"><div class="t">Produzione mese</div><div class="summaryValue"><span id="deskMonthKg">‚Äî</span> kg</div><div class="muted">Ordini conclusi: <span id="deskMonthOrders">‚Äî</span></div></div><div class="summaryTile"><div class="t">Supporto rapido</div><div class="summaryActions"><button class="btn ghost" id="btnCallMatteo" style="width:100%;">Chiama Matteo</button><button class="btn ghost" id="btnOpenStats" style="width:100%;">Statistiche</button></div><div class="muted">Interventi, assistenza e apertura dashboard statistiche.</div></div></div></div><div class="payrollCard adminOnly" id="payrollAdminCard"><div class="pcHead"><div><div class="pcTitle">Upload buste paga</div><div class="pcSub">Carica PDF, estrai con Gemini e invia.</div></div><div class="pcBadge">Admin</div></div><div class="pcBody"><div class="pcActionRow"><button class="payrollBtn primary" id="btnOpenPayrollAdmin" type="button">Apri upload</button><button class="payrollBtn secondary" id="btnPayrollReloadUsers" type="button">Reload utenti</button></div><div class="pcHint">Stato: <span id="payrollAdminStatus">Idle</span></div></div></div><div class="mobileAssignInfo" id="mobileAllowInfo">Ordini assegnati: <span id="mobileAllowCount">‚Äî</span><span id="mobileAllowMsg" style="margin-left:6px; color:var(--muted); font-weight:800;"></span></div><div id="mobileSendAnchor" style="display:none;" aria-hidden="true"></div><div id="mobileSendCard" class="adminPanel adminOnly" style="display:none;"><div class="mobileSendShell"><div class="mobileSendTopbar"><div class="mobileSendHeader"><div class="mobileSendTitleCol"><div class="panelTitle">Invio ordini a mobile</div><div class="mobileStatsLine" aria-live="polite"><span class="statLabel">Totali:</span><b id="mobileAllowTotal">‚Äî</b><span class="statSep">¬∑</span><span class="statLabel">Inviati:</span><b id="mobileAllowSent">‚Äî</b><span class="statSep">¬∑</span><span class="statLabel">Match:</span><b id="mobileAllowMatch">‚Äî</b></div><div class="panelSub mobileSendSubline" id="mobileAllowUpdate">Aggiornato ‚Äî</div><div class="panelSub" id="mobileAllowUpdatedBy">‚Äî</div></div><div class="mobileSendStatus"><div class="statusBadge" id="mobileAllowStatus">Salvato</div><div class="saveBadge" id="mobileAllowFeedback">Stato: ‚Äî</div><div class="saveBadge" id="mobileAllowResetStatus">Pronto al reset</div></div></div><div class="mobileSendToolbar"><input id="mobileAllowSearch" class="adminSearch" type="search" placeholder="Cerca cliente, prodotto, numero"><div class="mobileSendToolbarBtns"><button class="btn actionPrimary" id="btnSaveMobileAllow" type="button">Invia</button><button class="btn actionGhost" id="btnResetMobileAllow" type="button">Reset</button></div><div class="microActions"><button class="textAction" id="btnAllowSelectAll" type="button">Seleziona filtrati</button><span class="statSep">¬∑</span><button class="textAction" id="btnAllowClear" type="button">Deseleziona filtrati</button></div></div></div><div class="mobileSendBody"><div class="mobileSendListPane"><div class="listHead"><div class="panelSub">Clicca una riga per inviare o rimuovere dall‚Äôapp mobile.</div></div><div class="adminList rowsScroll" id="mobileSendList"></div></div></div></div></div><div class="card adminOnly" id="actionLogCard" style="display:none;"><div class="hd"><h2>Monitoraggio azioni</h2><div class="cardTopActions"><button type="button" class="miniBtn" data-action="print" data-target="#actionLogCard">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#actionLogCard">Condividi</button></div><div class="badge" id="actionLogBadge">‚Äî</div></div><div class="bd"><div class="muted">Registro eventi operativi: avvii, chiusure, assenze e segnalazioni.</div><div class="logFilterBar"><div class="logField"><div class="logLabel">Utente</div><select id="actionLogFilterUser"></select></div><div class="logField"><div class="logLabel">Tipo</div><select id="actionLogFilterType"></select></div><button class="btn ghost" id="actionLogClear" type="button">Pulisci filtri</button></div><div class="rowsScroll logRows" id="actionLogList"></div><div class="logEmpty" id="actionLogEmpty">Nessuna azione registrata con i filtri correnti.</div></div></div><div class="card adminOnly" id="alertAdminCard" style="display:none;"><div class="hd"><h2>Avviso operatori</h2><div class="badge" id="alertAdminStatus">‚Äî</div></div><div class="bd"><div class="muted">Banner prioritario per gli operatori linea polveri.</div><div style="height:8px"></div>
              <textarea id="alertMessageInput" placeholder="Testo avviso (mostrato agli operatori)" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); min-height:90px; font-weight:800;"></textarea>
              <div style="height:8px"></div><div class="row2"><input id="alertExpireInput" type="number" min="0" step="1" inputmode="numeric" placeholder="Durata minuti (0 = nessuna scadenza)" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); font-weight:900;"><button class="btn good" id="btnSendAlert" type="button" style="width:100%;">Invia avviso</button><button class="btn bad" id="btnCancelAlert" type="button" style="width:100%; margin-top:8px;">Annulla avviso</button></div><div class="muted" id="alertFeedback" style="margin-top:6px;"></div><div id="adminLastAlert" class="lastAlertBox" style="display:none"><div class="lastAlertLabel">Ultimo avviso inviato</div><div class="lastAlertText" id="adminLastAlertText"></div></div></div></div><div id="statsCardAnchor" style="display:none;" aria-hidden="true"></div><div id="statsProduzione" style="position:relative; top:-6px;" aria-hidden="true"></div><div class="card adminOnly" miniCard id="statsProdCard"><div class="hd"><h2>Statistiche produzione</h2><div class="badge" id="statsBadge">‚Äî</div></div><div class="bd"><div class="muted">Classifica live (kg totali e velocit√† media) per gli amministratori.</div><div style="height:10px"></div><div class="rowsScroll" id="statsBody"><div id="operatorLeaderboard"></div><div id="statsList" class="list"></div></div></div></div></div><div class="card supportCard" id="supportCard"><div class="hd supportHead"><div class="supportTitleCol"><div class="eyebrow">Supporto rapido</div><h2 class="supportTitle">Segnala o pianifica</h2></div><div class="supportBadge">Live</div></div><div class="bd supportBody"><div class="supportIntro"><div class="supportLead">Due bottoni nello stesso riquadro.</div><div class="supportSub">Segnala anomalie o programma un‚Äôassenza con un tap, stile Apple/Silicon Valley.</div></div><div class="supportActions"><button class="supportBtn accent" id="btnIssueOpen" type="button"><div class="supportBtnIcon">‚ö°Ô∏è</div><div class="supportBtnText"><div class="label">Segnala un problema</div><div class="hint">Macchine, materiali, anomalie</div></div><span class="supportBtnBadge">Live</span></button><button class="supportBtn neutral" id="btnAbsenceOpen" type="button"><div class="supportBtnIcon">üóìÔ∏è</div><div class="supportBtnText"><div class="label">Programma un‚Äôassenza</div><div class="hint">Invia la richiesta in 1 tap</div></div><span class="supportBtnBadge">1 tap</span></button></div></div></div><div class="muted" style="text-align:center;">¬© General Copper SRL ¬∑ Uso interno</div></div></div></div><div id="payrollAdminModal" class="payrollOverlay" role="dialog" aria-modal="true" style="display:none;">
  <div class="payrollSheet">
    <div class="payrollTop">
      <div class="payrollTitleWrap">
        <div class="payrollTitle">Upload buste paga</div>
        <div class="payrollSub">Gemini ‚Üí Preview ‚Üí Match ‚Üí Invia. Apple style.</div>
        <div class="payrollBadgeRow"><span class="payrollPill" id="payrollAdminStepLabel">Idle</span><span class="payrollPill" id="payrollAdminFileLabel">Nessun file</span><span class="payrollPill" id="payrollAdminMatchLabel">Match non avviato</span></div>
      </div>
      <button class="payrollClose" id="payrollAdminClose" aria-label="Chiudi">√ó</button>
    </div>
    <div class="payrollSteps">
      <div class="payrollPane" id="payrollStepIdle">
        <div class="payrollGrid">
          <div>
            <div class="dropArea" id="payrollDrop">
              <div class="pcTitle" style="font-size:16px;">Trascina qui il PDF</div>
              <div class="pcHint">Supporto file singolo o multipagina. Nessun match automatico.</div>
              <input type="file" id="payrollFileInput" accept="application/pdf" style="display:none;" />
              <div class="uploadActions">
                <button class="payrollBtn secondary" id="btnPayrollSelect" type="button">Seleziona PDF</button>
                <button class="payrollBtn primary" id="btnPayrollUpload" type="button">Upload (Gemini)</button>
                <button class="payrollBtn" id="btnPayrollReset" type="button">Reset</button>
              </div>
              <div class="miniHint" id="payrollIdleHint">Stato: inattivo.</div>
            </div>
          </div>
          <div class="payrollPane" style="margin:0;">
            <div class="pcTitle" style="font-size:16px;">Regole</div>
            <div class="pcHint">Gemini estrae solo testo. Match e invio partono da bottoni manuali.</div>
            <ul class="pcHint" style="padding-left:18px; margin:10px 0 0 0; line-height:1.5;">
              <li>Preview obbligatoria prima del match.</li>
              <li>Match solo su click "Match".</li>
              <li>Invio solo su click "Invia".</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="payrollPane" id="payrollStepExtract" style="display:none; align-items:center; justify-content:center; text-align:center;">
        <div class="pcTitle" style="font-size:18px;">Estrazione in corso‚Ä¶</div>
        <div class="pcHint">Gemini sta elaborando il PDF. Attendi.</div>
      </div>
      <div class="payrollPane" id="payrollStepPreview" style="display:none;">
        <div class="pcHead" style="padding:0;">
          <div>
            <div class="pcTitle">Risultato estrazione (Gemini)</div>
            <div class="pcSub" id="payrollPreviewMeta">Pagine rilevate.</div>
          </div>
          <div class="pillGroup"><span class="payrollPill" id="payrollPreviewBadge">OK</span></div>
        </div>
        <div class="rowsScroll" style="max-height:360px; overflow:auto;">
          <table class="table" id="payrollPreviewTable"></table>
        </div>
        <div class="pcHint" id="payrollMissingPages" style="display:none;">Pagine con campi mancanti: <span id="payrollMissingList"></span></div>
        <div class="pcActionRow">
          <button class="payrollBtn primary" id="btnPayrollMatch" type="button">Match</button>
          <button class="payrollBtn secondary" id="btnPayrollRetry" type="button">Riestrai</button>
          <button class="payrollBtn" id="btnPayrollReset2" type="button">Reset</button>
        </div>
      </div>
      <div class="payrollPane" id="payrollStepMatch" style="display:none;">
        <div class="pcHead" style="padding:0;">
          <div>
            <div class="pcTitle">Match review</div>
            <div class="pcSub">Controlla matchati e non matchati prima di inviare.</div>
          </div>
          <div class="pillGroup">
            <span class="payrollPill">OK: <span id="payrollMatchOk">0</span></span>
            <span class="payrollPill">Ambigui: <span id="payrollMatchAmbig">0</span></span>
            <span class="payrollPill">Non matchati: <span id="payrollMatchNo">0</span></span>
          </div>
        </div>
        <div class="payrollGrid">
          <div>
            <div class="pcTitle" style="font-size:16px;">Matchati per utente</div>
            <div class="payrollList" id="payrollMatchedList"></div>
          </div>
          <div>
            <div class="pcTitle" style="font-size:16px;">Non matchati</div>
            <div class="payrollList" id="payrollUnmatchedList"></div>
          </div>
        </div>
        <div class="pcActionRow">
          <button class="payrollBtn primary" id="btnPayrollSend" type="button">Invia</button>
          <button class="payrollBtn secondary" id="btnPayrollBackPreview" type="button">Indietro</button>
          <button class="payrollBtn" id="btnPayrollReset3" type="button">Reset</button>
        </div>
      </div>
      <div class="payrollPane" id="payrollStepSending" style="display:none;">
        <div class="pcTitle">Invio in corso‚Ä¶</div>
        <div class="pcHint" id="payrollSendSummary">Preparazione PDF utenti e scrittura Firestore.</div>
      </div>
    </div>
  </div>
</div>
<div id="payrollUserModal" class="payrollOverlay" role="dialog" aria-modal="true" style="display:none;">
  <div class="payrollSheet">
    <div class="payrollTop">
      <div class="payrollTitleWrap">
        <div class="payrollTitle" id="payrollUserTitle">Le tue buste paga</div>
        <div class="payrollSub">Seleziona il mese e visualizza i dettagli.</div>
        <div class="payrollBadgeRow"><span class="payrollPill" id="payrollUserMonthBadge">‚Äî</span><span class="payrollPill" id="payrollUserAmountBadge">‚Äî</span></div>
      </div>
      <button class="payrollClose" id="payrollUserClose" aria-label="Chiudi">√ó</button>
    </div>
    <div class="payrollPane">
      <div class="payrollInlineField">
        <label class="pcSub" for="payrollMonthSelect">Mese</label>
        <select id="payrollMonthSelect" class="payrollSelect"></select>
      </div>
      <div class="payrollNonAdminCard">
        <div class="payrollNonAdminHeader">
          <div>
            <div class="pcTitle" id="payrollUserNet">‚Äî</div>
            <div class="pcSub" id="payrollUserDocMeta">Documento: ‚Äî</div>
          </div>
          <div class="payrollBadgeSmall" id="payrollUserDate">Aggiornato ‚Äî</div>
        </div>
        <div class="payrollNonAdminActions">
          <button class="payrollBtn primary" id="btnPayrollPrint" type="button">Stampa</button>
          <button class="payrollBtn secondary" id="btnPayrollShare" type="button">Condividi</button>
        </div>
        <div class="pcHint">Solo lettura. Nessun upload lato non-admin.</div>
      </div>
      <div style="border:1px solid var(--stroke); border-radius:18px; overflow:hidden; background:rgba(0,0,0,.02); min-height:320px;">
        <iframe id="payrollUserPdfFrame" title="Busta paga" style="width:100%; height:360px; border:0; background:white;"></iframe>
      </div>
    </div>
  </div>
</div>
<div id="whModal" class="modal hidden" role="dialog" aria-modal="true"><div class="modalCard"><div class="modalTop"><div><div class="modalTitle" id="whModalTitle">Dettaglio magazzino</div><div class="modalSub" id="whModalSub">‚Äî</div><div class="modalCalc" id="whModalCalc" style="display:none"></div></div><button class="modalClose" id="whModalClose" aria-label="Chiudi">√ó</button></div><div class="modalBody" id="whModalBody"></div></div></div><div id="notifModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h">Centro notifiche</div><div class="muted" id="notifSub">Push, messaggi interni e registro.</div></div><button class="x" id="notifClose" aria-label="Chiudi">√ó</button></div><div class="sbd" id="notifBody"><div class="stepTitle">Inbox</div><div class="muted" id="notifStatus">Caricamento notifiche‚Ä¶</div><div style="height:8px"></div><div id="notifUnavailable" class="alertBanner" style="display:none;"><div class="label">Centro notifiche non disponibile (permessi o connessione).</div><div class="hint">Nessun blocco: l‚Äôapp continua a funzionare.</div></div><div id="notifList" class="notifList"></div><div class="notifEmpty" id="notifEmpty" style="display:none;">Nessuna notifica disponibile.</div><div style="height:12px"></div><div class="row2"><button class="btn ghost" id="btnNotifCompleted" style="width:100%;">Registro conclusi</button><button class="btn" id="btnTogglePush" style="width:100%;">Gestisci push</button></div><div style="height:12px"></div><div class="row2" id="notifRowOperator" style="display:none;"><button class="btn bad" id="btnClearNotifs" style="width:100%;">Cancella notifiche</button></div><div style="height:12px"></div><div id="notifAdminBox" style="display:none;"><div class="stepTitle">Invia notifica (admin)</div><div class="muted">Messaggio a tutti gli operatori linea polveri (push o inbox). Richiede permessi Firestore.</div><div style="height:8px"></div><input type="text" id="notifTitle" placeholder="Titolo (es. Aggiornamento impianto)" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); font-weight:900;"/><div style="height:8px"></div>
          <textarea id="notifBodyInput" placeholder="Testo notifica" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); min-height:90px; font-weight:800;"></textarea>
          <div style="height:8px"></div><button class="btn good" id="btnSendNotif" style="width:100%;">Invia a tutti</button><div class="muted" id="notifAdminFeedback" style="margin-top:6px;"></div></div></div></div></div><div id="histModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet" id="histModalSheet"><div class="shd"><div class="titleCol" id="histModalHeader"><div class="h cardTitle" id="histTitle">Dettaglio produzione</div><div class="sub" id="histSub">‚Äî</div></div><div class="modalTopActions adminOnly"><button type="button" class="miniBtn" data-action="print" data-target="#histModalSheet">Stampa</button><button type="button" class="miniBtn" data-action="share" data-target="#histModalSheet">Condividi</button></div><button class="x" id="histClose" aria-label="Chiudi">√ó</button></div><div class="sbd" id="histBody"></div></div></div><div id="toast" class="toast"><div class="tt" id="toastTitle">Attenzione</div><div class="tb" id="toastBody">‚Äî</div></div><div id="prodModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h" id="prodModalTitle">Produzione</div><div class="selCounter" id="selectionCounter" style="display:none;">0 righe selezionate</div></div><button class="x" id="prodModalClose" aria-label="Chiudi">√ó</button></div><div class="sbd"><div class="modalStepWrap" id="prodModalBody"></div></div></div></div><div id="runningModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="h">Produzione in corso</div><button class="x" id="runningClose" aria-label="Chiudi">√ó</button></div><div class="sbd" id="runningBody"></div></div></div><div id="absenceModal" class="overlay absenceOverlay" role="dialog" aria-modal="true" aria-label="Programma un'assenza" style="display:none;" data-step="form"><div class="sheet absenceSheet"><div class="absenceTop"><div class="absenceTitleCol"><div class="absenceBreadcrumb" id="absenceBreadcrumb">Step 1 di 2 ¬∑ Compila</div><div class="absenceTitle">Programma un'assenza</div><div class="absenceSub">Inserisci date e motivazione, poi conferma il riepilogo prima dell'invio.</div><div class="absenceUser">üë§ <span id="absUserName">Operatore</span></div></div><div class="absenceStepperDots"><div class="absenceDot" data-step="form" aria-hidden="true"></div><div class="absenceDot" data-step="review" aria-hidden="true"></div><button class="x" id="absenceClose" aria-label="Chiudi">√ó</button></div></div><div class="absenceSteps"><div class="absenceStep isActive" data-step="form" id="absenceFormStep"><div class="absenceGrid"><div class="field" style="margin-bottom:0;"><div class="absenceLabel">Da</div><input id="absFrom" type="datetime-local" /></div><div class="field" style="margin-bottom:0;"><div class="absenceLabel">A</div><input id="absTo" type="datetime-local" /></div></div><div class="field" style="margin-top:10px;"><div class="absenceLabel">Motivazione</div><textarea id="absReason" placeholder="Es. visita medica, permesso personale, ecc."></textarea></div><div class="absenceHintBox">Rivedi i dati nel passo successivo: potrai ancora modificarli prima dell'invio.</div><div class="absenceActions"><div class="spacer"></div><button class="btn good" id="btnAbsenceNext" style="width:100%; max-width:260px;">Vai al riepilogo</button></div></div><div class="absenceStep" data-step="review" id="absenceReviewStep"><div class="absenceReviewCard"><div class="absenceReviewRow"><div class="label">Operatore</div><div class="value" id="absSummaryUser">‚Äî</div></div><div class="absenceReviewRow"><div class="label">Periodo</div><div class="value"><span id="absSummaryFrom">‚Äî</span> ‚Üí <span id="absSummaryTo">‚Äî</span></div></div><div class="absenceReviewRow"><div class="label">Motivazione</div><div class="value" id="absSummaryReason">‚Äî</div></div></div><div class="absenceActions"><button class="btn ghost" id="btnAbsenceEdit" type="button" style="flex:1;">Modifica dati</button><button class="btn good" id="btnAbsenceSend" style="flex:1;">Invia richiesta</button></div></div></div><div id="absFeedback" class="muted absenceFeedback" aria-live="polite"></div></div></div><div id="alertModal" class="overlay" role="dialog" aria-modal="true" aria-label="Avviso operatori" style="display:none;"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h">Avviso operatori</div><div class="muted">Messaggio attivo.</div></div><button class="x" id="alertClose" aria-label="Chiudi">√ó</button></div><div class="sbd"><div class="card" style="margin:0;"><div class="bd"><div id="alertModalText" style="font-weight:900; white-space:pre-wrap;"></div></div></div></div></div></div><div id="warehouseModal" class="overlay" role="dialog" aria-modal="true" aria-label="Gestione magazzino" style="display:none;"><div class="sheet whSheet"><div class="whHeader"><div class="whTitleWrap"><div class="eyebrow">Inventory cockpit</div><div class="whTitleRow"><div class="whTitle">Gestione magazzino</div><div class="badge whBadge" id="warehouseBadgeModal">‚Äî</div></div><div class="whSubtitle">Riepilogo materiali e residui aggiornati live.</div><div class="whChips"><span class="whChip accent">Live sync</span><span class="whChip ghost">Residui</span><span class="whChip good">Disponibile</span></div></div><div class="whToolbar"><button class="whBtn ghost" id="warehouseRefreshBtn" type="button"><span class="icon">‚Üª</span><span>Aggiorna</span></button><button class="x whClose" id="warehouseClose" aria-label="Chiudi">√ó</button></div></div><div class="whBody"><div class="whGlassCard"><div class="whCardHead"><div><div class="whCardLabel">Dashboard scorte</div><div class="whCardTitle">Panoramica live</div><div class="whCardHint">Filtri, residui e riepiloghi con la stessa struttura del pannello principale.</div></div><div class="whStatus"><span class="dot ok"></span><span class="whStatusText">Attivo</span></div></div><div class="whScroll" id="warehouseModalBody"></div></div></div></div></div><div id="issueModal" class="overlay" role="dialog" aria-modal="true" aria-label="Segnala un problema" style="display:none;"><div class="sheet"><div class="shd"><div class="titleCol"><div class="h">Segnala un problema</div><div class="muted">Segnalazione interna. Scrivi chiaro e diretto.</div></div><button class="x" id="issueClose" aria-label="Chiudi">√ó</button></div><div class="sbd"><div class="field"><div class="muted">Dettagli</div>
          <textarea id="issueModalText" placeholder="Es. sacchettatrice bloccata, bobina finita, ordine X in attesa‚Ä¶"></textarea>
        </div><div id="issueModalFeedback" class="muted" style="font-weight:900; margin-top:6px;"></div><div style="height:10px"></div><button class="btn good" id="btnIssueSendModal" style="width:100%;">Invia segnalazione</button></div></div></div><div id="partialModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="h">Ordini parzialmente conclusi</div><button class="x" id="partialClose" aria-label="Chiudi">√ó</button></div><div class="sbd" id="partialBody"></div></div></div><div id="signModal" class="overlay" role="dialog" aria-modal="true"><div class="sheet"><div class="shd"><div class="h">Conclusione ¬∑ Firma</div><button class="x" id="signClose" aria-label="Chiudi">√ó</button></div><div class="sbd"><div class="stepTitle">Dichiarazione e firma</div><div class="muted" id="signContext">‚Äî</div><div style="height:10px"></div><div class="muted" style="font-weight:800;">
          Dichiarazione: <b>dichiaro</b> che la produzione √® stata eseguita secondo le procedure aziendali e i controlli previsti.
        </div><div style="height:10px"></div><div style="display:flex; gap:10px; align-items:center;"><input id="signCheck" type="checkbox" style="width:20px;height:20px; accent-color: var(--good);" /><label for="signCheck" style="font-weight:900;">Confermo la dichiarazione</label></div><div style="height:12px"></div><div style="border:1px solid var(--stroke); border-radius:18px; overflow:hidden; background: rgba(0,0,0,.02);"><canvas id="signCanvas" class="signaturePad" style="width:100%; height:220px; display:block;"></canvas></div><div style="height:10px"></div><div class="row2"><button class="btn" id="signClear">Pulisci firma</button><button class="btn good" id="signOk">CONCLUDI</button></div></div></div></div>


  

<script type="module">const Ht={proxyUrl:"https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",cacheKey:"EASYFATT_XML_CACHE_V1"},nl="12345",ji="https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js",Yi="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js",Zi="https://www.gstatic.com/firebasejs/12.7.0/firebase-storage.js",Qi="https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js",Ji="https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js",Vn={apiKey:"AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",authDomain:"tabellone-produzione-liv-e313e.firebaseapp.com",projectId:"tabellone-produzione-liv-e313e",storageBucket:"tabellone-produzione-liv-e313e.firebasestorage.app",messagingSenderId:"537555699968",appId:"1:537555699968:web:4d04cb9596b67bfb0e4be5"},Gn="PASTE_PUBLIC_VAPID_KEY_HERE",Xi=10080*60*1e3,Ut="hub_auth_ok_ts_v1",jn="hub_auth_last_email_v1",es=6e3,ts=!1,Yn="matteo@generalcoppersrl.com",Zn="FATTURATO_EUR_CACHE",Qn="POLVERI_NOTIF_READ_V1",Jn="powder_notif_dismissed_v1";let Ne=null;const qt="powderNotifications",ns="email",os="matteo@generalcoppersrl.com",Xn="powderActionLogs",eo=200,is="gc_action_open_session_v1";async function ss(){try{if(!r.firebase?.ok)return;const e=r.user?.uid||r.user?.email||"";if(!e)return;const t=`${is}:${e}`;if(sessionStorage.getItem(t))return;sessionStorage.setItem(t,"1"),await nt({type:"open",action:"Apertura app",description:"Accesso Hub Linea Polveri",meta:R()?"mobile":"desktop"})}catch{}}async function Wt(e,t,n){try{if(!r.firebase.ok)return;const o=r.firebase.api,i=r.firebase.db,s=o.collection(i,ns),a={subject:e||"Hub Linea Polveri",text:t||""};n&&(a.html=n),await o.addDoc(s,{to:os,message:a,createdAt:o.serverTimestamp(),line:"polveri",createdBy:r.user?.fullName||"Sistema"})}catch(o){console.warn("enqueueMatteoEmail error",o)}}const rs=40,ut={col:"hub_config",doc:"hub_linea_polveri_mobile_allowlist"},ol=`${ut.col}/${ut.doc}`,to={col:"hub_alerts",doc:"active"},no="dismissedAlertId",oo="gc_magazzino_filters_v1",io="gc_op_rank_sort_v1",il=["Hassan","Ahmed","Muhammed","Mustapha","Youssef"],as=new Set(["mast250viri","mast500viri","codmast250viri","codmast500viri"]),so={5:{prodottoKgPerBag:5,bobine:{"Bobina blu f830":{perBag:20,unit:"g"}},etichettePerBag:1,scatole:{"Scatola americana | 20 kg":.25},divisori:{"Divisorio Z":.25},altri:{}},1:{prodottoKgPerBag:1,bobine:{"Bobina blu f480":{perBag:10,unit:"g"}},etichettePerBag:1,scatole:{"Scatola americana | 20 kg":.05},divisori:{"Divisorio Croce texo":.05},altri:{}}},Ue={defaultByPackKg:so,byCode:{},byName:{"ossicloruro di rame 50%":{packs:so}}};try{"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>e.forEach(t=>t.unregister())).catch(()=>{})}catch{}const r={lastAuthErrorMsg:"",xmlModifiedTime:null,lastFetchAt:null,docs:[],fatturatoLordo:null,powderOrders:[],activeProductions:[],history:[],historyReady:!1,globalStats:{ready:!1,data:{concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""},source:"init",error:""},user:null,operator:null,selectedLines:new Map,prodModalOpenedAt:0,startedThisSession:!1,prodModalTouched:!1,firebase:{ok:!1,db:null,api:null,storage:null,storageApi:null},magFilters:qr(),magazzinoOverview:[],magazzinoDetailLookup:new Map,mobileAllowlist:{ready:!1,keys:new Set,updatedAt:null,updatedBy:"",allowAll:!0,docExists:!1,error:"",lastError:"",lastSyncTs:null,pendingRender:!1},mobileAllowSelection:new Set,mobileAllowDirty:!1,mobileAllowSaveState:"idle",mobileAllowSearchTerm:"",mobileAllowReset:{confirm:!1,status:"idle",lastError:""},notifications:{inbox:[],ready:!1,unavailable:!1,error:""},actionLogs:{entries:[],ready:!1,error:""},payroll:{admin:{step:"idle",files:[],originalPdfBytes:null,sourceFileName:"",sourceFileHash:"",gemini:{loading:!1,error:"",pages:[]},match:{pages:[],grouped:[],unmatched:[],matchedCount:0,ambiguousCount:0,unmatchedCount:0},users:[],loadingUsers:!1,sending:!1,sendSummary:null},userView:{docs:[],ready:!1,error:"",selectedMonth:"",months:[],loading:!1}},notifUnsub:null,push:{supported:!1,permission:"default",token:"",enabled:!1},alerts:{unsub:null,data:null},alertSaving:!1};globalThis.__ALLOW_KEYS__=globalThis.__ALLOW_KEYS__ instanceof Set?globalThis.__ALLOW_KEYS__:new Set,globalThis.__ALLOW_META__=globalThis.__ALLOW_META__||{updatedAt:null,updatedBy:"",lastError:"",lastSyncTs:null},globalThis.__ALLOWLIST_LISTEN_STARTED__=!!globalThis.__ALLOWLIST_LISTEN_STARTED__,globalThis.__ALLOWLIST_CACHE_CLEANED__=!!globalThis.__ALLOWLIST_CACHE_CLEANED__,globalThis.__ALLOW_LOADED__=!!globalThis.__ALLOW_LOADED__,globalThis.__CONCLUDE_INFLIGHT__=globalThis.__CONCLUDE_INFLIGHT__ instanceof Map?globalThis.__CONCLUDE_INFLIGHT__:new Map,globalThis.__CONCLUDE_RECENT__=globalThis.__CONCLUDE_RECENT__ instanceof Map?globalThis.__CONCLUDE_RECENT__:new Map,globalThis.__CONCLUDE_HANDLER_BOUND__=!!globalThis.__CONCLUDE_HANDLER_BOUND__,globalThis.__GLOBAL_STATS__=globalThis.__GLOBAL_STATS__&&typeof globalThis.__GLOBAL_STATS__=="object"?globalThis.__GLOBAL_STATS__:{concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""},globalThis.__GLOBAL_STATS_READY__=!!globalThis.__GLOBAL_STATS_READY__,globalThis.__STATS_CLEAR_TS__=Number(globalThis.__STATS_CLEAR_TS__||0),globalThis.__RESTORE_TIMER__=globalThis.__RESTORE_TIMER__||null,globalThis.__AUTH_LISTENER_BOUND__=!!globalThis.__AUTH_LISTENER_BOUND__,globalThis.__AUTH_RESUME_BOUND__=!!globalThis.__AUTH_RESUME_BOUND__;let ro="unknown",ft=null,se=[],oe=new Set;globalThis.__allowCommitted=globalThis.__allowCommitted instanceof Set?globalThis.__allowCommitted:new Set(Array.from(globalThis.__ALLOW_KEYS__||[])),globalThis.__allowDraft=globalThis.__allowDraft instanceof Set?globalThis.__allowDraft:new Set(globalThis.__allowCommitted),globalThis.__allowDraftDirty=!!globalThis.__allowDraftDirty;const ls=["allowKeys","mobileAllowlist","hub_allowlist","mobileSendKeys","assignedOrders"];function Vt(){r.payroll={admin:{step:"idle",files:[],originalPdfBytes:null,sourceFileName:"",sourceFileHash:"",gemini:{loading:!1,error:"",pages:[]},match:{pages:[],grouped:[],unmatched:[],matchedCount:0,ambiguousCount:0,unmatchedCount:0},users:[],loadingUsers:!1,sending:!1,sendSummary:null},userView:{docs:[],ready:!1,error:"",selectedMonth:"",months:[],loading:!1}}}function ao(){if(globalThis.__ALLOWLIST_CACHE_CLEANED__)return;globalThis.__ALLOWLIST_CACHE_CLEANED__=!0;const e=[];try{typeof localStorage<"u"&&e.push(localStorage)}catch{}try{typeof sessionStorage<"u"&&e.push(sessionStorage)}catch{}for(const t of e)try{for(const n of ls)t.removeItem(n)}catch{}}ao();const Gt="hub_linea_polveri_global_stats_v1",mt={col:"hub_config",doc:"hub_linea_polveri_global_stats"},jt="hub_linea_polveri_stats_clear_ts",qe="gc_prod_history_reset_ts_v1",cs=["powderProdHistory","powderProdHistoryCache","powderProdStats","powderProdStats_v1","powder_stats_cache","powder_stats_history","powder_stats_history_v1","powder_history","prod_history","ordiniConclusi","statsHistory","statsHistoryCache","hub_linea_polveri_history"],ds=["powderStats_","powderProdHistory_","powderProdStats_","hub_prod_stats_"],c=e=>document.getElementById(e),H={indicator:c("pillSync"),indicatorText:c("txtSync"),indicatorDot:c("dotSync"),firstRenderDone:!1,inError:!1};let pt=!1,Yt=!1,xe=null,We=0,Zt=null;function Qt(){return new Promise(e=>requestAnimationFrame(()=>e()))}async function Jt(e,t,n,o=90){if(!e)return;e.innerHTML="";const i=document.createDocumentFragment();for(let s=0;s<(t?.length||0);s++)i.appendChild(n(t[s],s)),(s+1)%o===0&&(e.appendChild(i),await Qt());e.appendChild(i)}function sl(e,t,n,o){if(!e||!t||!n||t===n)return;const i=t.offsetHeight;e.style.height=i+"px",n.classList.add("isActive"),n.classList.add(o==="next"?"isEnterNext":"isEnterPrev"),n.offsetWidth,t.classList.add(o==="next"?"isExitNext":"isExitPrev"),n.classList.remove(o==="next"?"isEnterNext":"isEnterPrev");const s=n.offsetHeight;e.style.height=s+"px";const a=()=>{t.classList.remove("isActive","isExitNext","isExitPrev"),e.style.height="auto",t.removeEventListener("transitionend",a)};t.addEventListener("transitionend",a)}function lo(e){if(!e)return;const t=e.querySelector(".rowsWrap, .listWrap, .tableWrap, .linesWrap, .ordersTable, .modalRows")||e.querySelector("table")||null;t&&requestAnimationFrame(()=>{t.scrollIntoView({block:"start",inline:"nearest"})})}const Ve=()=>({concludedCountTotal:0,concludedKgTotal:0,updatedAt:null,updatedBy:""});function us(){try{if(typeof localStorage>"u")return null;const e=localStorage.getItem(Gt);if(!e)return null;const t=JSON.parse(e);if(t&&typeof t=="object")return t}catch{}return null}function fs(e){try{if(typeof localStorage>"u")return;localStorage.setItem(Gt,JSON.stringify(e))}catch{}}function Xt(){return globalThis.__GLOBAL_STATS__&&typeof globalThis.__GLOBAL_STATS__=="object"||(globalThis.__GLOBAL_STATS__=Ve()),r.globalStats||(r.globalStats={ready:!1,data:Ve(),source:"init",error:""}),globalThis.__GLOBAL_STATS__}function gt(e,t="local"){const n={...Ve(),...e||{}};return globalThis.__GLOBAL_STATS__=n,globalThis.__GLOBAL_STATS_READY__=!0,r.globalStats={...r.globalStats||{},data:n,ready:!0,source:t,error:""},fs(n),n}async function ms(){let e=Ve(),t="init";const n=us();if(n&&(e={...e,...n},t="localstorage"),r.firebase?.ok)try{const i=r.firebase.api,s=r.firebase.db,a=await i.getDoc(i.doc(s,mt.col,mt.doc));if(a.exists()){const d=a.data()||{};e={...e,concludedCountTotal:Number(d.concludedCountTotal||0),concludedKgTotal:Number(d.concludedKgTotal||0),updatedAt:d.updatedAt||d.concludedAt||d.at||null,updatedBy:d.updatedBy||d.user||""},t="firestore"}}catch(i){console.warn("load global stats failed",i),r.globalStats={...r.globalStats||{},error:String(i?.message||i||"")}}const o=gt(e,t);return xt(),o}async function ps(e){const t=gt(e,r.globalStats?.source||"local");if(r.firebase?.ok)try{const n=r.firebase.api,o=r.firebase.db;await n.setDoc(n.doc(o,mt.col,mt.doc),{concludedCountTotal:Number(t.concludedCountTotal||0),concludedKgTotal:Number(t.concludedKgTotal||0),updatedAt:n.serverTimestamp(),updatedBy:r.user?.email||r.user?.fullName||""},{merge:!0}),r.globalStats={...r.globalStats||{},source:"firestore",error:""}}catch(n){console.warn("persist global stats failed",n),r.globalStats={...r.globalStats||{},error:String(n?.message||n||"")}}return xt(),t}async function gs(e=0,t=0){const n=Xt(),o={concludedCountTotal:Number(n.concludedCountTotal||0)+Number(e||0),concludedKgTotal:Number(n.concludedKgTotal||0)+Number(t||0),updatedAt:W(),updatedBy:r.user?.email||r.user?.fullName||""};return ps(o)}function Ge(){const e=(i,s=jt)=>{try{if(i&&typeof i.getItem=="function"){const a=i.getItem(s);if(a!=null)return a}}catch{}return null},t=e(localStorage)??e(sessionStorage)??(globalThis.__STATS_CLEAR_TS__!=null?String(globalThis.__STATS_CLEAR_TS__):null),n=e(localStorage,qe)??e(sessionStorage,qe),o=Math.max(parseInt(t||"0",10),parseInt(n||"0",10));return Number.isFinite(o)?o:0}function hs(e){globalThis.__STATS_CLEAR_TS__=e;try{localStorage?.setItem(jt,String(e))}catch{}try{sessionStorage?.setItem(jt,String(e))}catch{}try{localStorage?.setItem(qe,String(e))}catch{}try{sessionStorage?.setItem(qe,String(e))}catch{}}function bs(){const e=[Gt,...cs],t=["hub_linea_polveri_global_stats_","hub_linea_polveri_stats_",...ds],n=[];try{typeof localStorage<"u"&&n.push(localStorage)}catch{}try{typeof sessionStorage<"u"&&n.push(sessionStorage)}catch{}let o=0;for(const i of n)try{const s=new Set;for(let a=0;a<i.length;a++){const d=i.key(a);d&&d!==qe&&(e.includes(d)||t.some(f=>d.startsWith(f)))&&s.add(d)}s.forEach(a=>{try{i.removeItem(a),o+=1}catch{}})}catch{}return{removedKeys:o,stores:n.length}}function en(){const e=(r.history||[]).filter(n=>n&&n.operator),t=Ge();return t?e.filter(n=>Ke(n.id||n.at||0)>t):e}function ys(){const e=Array.isArray(r.history)?r.history:[],t=Ge();return t?e.filter(n=>Ke(n.id||n.at||0)>t):e}function vs(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1).getTime(),n=new Date(e.getFullYear(),e.getMonth()+1,1).getTime()-1;return{start:t,end:n,label:"Questo mese"}}function ws(){try{return localStorage.getItem(io)==="kg"?"kg":"orders"}catch{return"orders"}}function _s(e){try{localStorage.setItem(io,e)}catch{}}function Ss(e){const t=[e?.endedAt,e?.startedAt,e?.at];for(const o of t){if(!o)continue;const i=new Date(o);if(Number.isFinite(i.getTime()))return i.getTime()}const n=Ke(e?.id||e?.at||0);return Number.isFinite(n)?n:null}function co(e){if(e==null)return"";let t=String(e||"").trim();if(!t)return"";if(t.includes("@")){const[n]=t.split("@");n&&(t=n.trim())}return t.replace(/\s+/g,"").trim()}function As(e){const t=[e?.operator,e?.operatorName,e?.user,e?.fullName,e?.displayName,e?.operatorEmail,e?.email,e?.uid,e?.operatorUid];for(const n of t){const o=co(n);if(o)return o}return"Sconosciuto"}function Ts(e,t,n){const o=Number(t)||0,i=Number(n)||0,s=new Map;for(const a of Array.isArray(e)?e:[]){const d=Ss(a);if(d==null||o&&d<o||i&&d>i)continue;const f=As(a),l=co(f),u=l?l.toLowerCase():"sconosciuto",m=Number(a?.kg),g=s.get(u)||{operatorLabel:l||"Sconosciuto",orders:0,kg:0,eventsCount:0};g.orders+=1,g.eventsCount+=1,Number.isFinite(m)&&(g.kg+=m),s.set(u,g)}return Array.from(s.values()).map(a=>({...a,kg:Number(a.kg)||0,orders:Number(a.orders)||0,eventsCount:Number(a.eventsCount)||0}))}function Ls(){const e=Date.now();hs(e);const{removedKeys:t,stores:n}=bs();r.history=[],r.historyReady=!0;const o=Ve();gt(o,"cleared"),xt(),Mt();try{Le()}catch{}try{rt()}catch{}const i=document.getElementById("statsClearFeedback");i&&(i.textContent="Dati storici eliminati");try{console.info(`[stats-reset] cleared history caches: ${t} key(s) across ${n} storage(s) @${e}`)}catch{}C("Dati storici eliminati","Statistiche azzerate su questo dispositivo.")}function Me(e="Aggiornamento\u2026",t={}){H.inError=t.kind==="error";const n=H.indicator;n&&(n.style.display="flex",H.indicatorText&&(H.indicatorText.textContent=e||"Aggiornamento\u2026"),H.indicatorDot&&(H.indicatorDot.className="dot",H.indicatorDot.classList.add(H.inError?"bad":"warn")))}function uo(){const e=H.indicator;e&&(e.style.display="none"),H.inError=!1}function fo(){H.firstRenderDone=!0,!H.inError&&setTimeout(()=>uo(),140)}function mo(e){H.inError=!0,Me(e||"Connessione instabile. Riprovo\u2026",{kind:"error"})}function Cs(){We=0,xe&&(clearTimeout(xe),xe=null)}function ks(){xe||(We=We?Math.min(We*2,2e4):2e3,xe=setTimeout(()=>{xe=null,Xe(!1,"retry")},We),mo("Connessione instabile. Riprovo\u2026"))}function W(){return new Date().toISOString()}function Es(e){const t=e instanceof Date?e:new Date(e),n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}:${o}`}function re(e){const t=e instanceof Date?e:new Date(e),n=String(t.getDate()).padStart(2,"0"),o=String(t.getMonth()+1).padStart(2,"0"),i=t.getFullYear();return`${n}/${o}/${i} ${Es(t)}`}function ye(){return r.selectedLines instanceof Map||(r.selectedLines=new Map),r.selectedLines}function tn(e,t){const n=e?.orderNo||e?.number||"",o=e?.customer||"",i=t?.lineKey||t?.lineID||t?.id||"";return`${n}__${o}__${i}`}function nn(){return ye().size}function ae(){const e=c("selectionCounter");if(!e)return;const t=nn();t>0?(e.style.display="inline-flex",e.innerHTML=`<strong>${t}</strong> righe selezionate`):e.style.display="none"}function Ns(e){const t=ye(),n=Array.from(t.keys());for(const o of n){const i=t.get(o);i&&String(i.orderNo||i.number||"")===String(e?.orderNo||e?.number||"")&&String(i.customer||"")===String(e?.customer||"")&&t.delete(o)}}function on(e){const t=ye();if(!t.size)return;const n=new Set;for(const o of e||[])for(const i of o.lines||[])!i||i.status==="active"||n.add(tn(o,i));for(const o of Array.from(t.keys()))n.has(o)||t.delete(o);ae()}function sn(e){const t=[],n=String(e?.orderNo||e?.number||""),o=String(e?.customer||"");for(const i of ye().values())String(i.orderNo||i.number||"")===n&&String(i.customer||"")===o&&t.push(i);return t}function xs(){const e=new Map;for(const t of ye().values()){const n=String(t.orderNo||t.number||""),o=String(t.customer||""),i=`${n}__${o}`;e.has(i)||e.set(i,{orderNo:n,customer:o,lines:[]}),e.get(i).lines.push(t)}return e}function U(e){return(e||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function V(e){return(e&&e.textContent?e.textContent:"").trim()}function je(e){if(Number.isFinite(e))return Number(e);const t=e==null?"":String(e).trim();if(!t)return null;const n=t.replace(/\s+/g,""),o=/^-?\d{1,3}(?:\.\d{3})*(?:,\d+)?$/,i=/^-?\d+(?:,\d+)?$/;let s=n;o.test(n)||i.test(n)?s=n.replace(/\./g,"").replace(",","."):s=n.replace(/,/g,"");const a=Number(s);return Number.isFinite(a)?a:null}function po(e){const t=(e==null?"":String(e)).replace(/\./g,"").replace(",",".").replace(/\s+/g,""),n=Number(t);return Number.isFinite(n)?n:0}function Ms(e){return Number.isFinite(e)?Math.round(e).toLocaleString("it-IT"):null}function Os(e){const t=c("kPowderKg");if(!t)return;const n=Ms(e);t.textContent=n!=null?`${n} kg`:"\u2014"}function ht(e,t="kg"){const n=`${e??0}`,o=/\bkg\b/i.test(t||""),i=(t||"").trim();return o?`${n} kg`:i?`${n} ${i} \xB7 kg`:`${n} kg`}async function rl(e){if(e)try{await navigator.clipboard.writeText(e),C("Key copiata","StableKey copiata negli appunti.")}catch{try{const n=document.createElement("textarea");n.value=e,document.body.appendChild(n),n.select(),document.execCommand("copy"),n.remove(),C("Key copiata","StableKey copiata.")}catch{}}}function R(){const e=typeof window<"u"&&window.matchMedia?window.matchMedia("(max-width: 640px)"):{matches:!1},t=(navigator.userAgent||navigator.vendor||"").toLowerCase(),n=/\b(android|iphone|ipad|ipod|mobile|iemobile|opera mini)\b/.test(t),o=typeof window<"u"?window.innerWidth<=900:!1;return!!(e&&e.matches||n||o)}function go(){const e=!!(r.user&&r.user.isAdmin);document.body.classList.toggle("role-admin",e),document.body.classList.toggle("role-operator",!e),bt()}const $s=["admin","mobilesendcard","desktopsummarycard","notifadminbox"];function ho(){if(!R()||!!(r.user&&r.user.isAdmin))return;const t=(typeof location<"u"&&location.hash||"").toLowerCase();if(!(!t||!$s.some(o=>t.includes(o)))){C("Sezione disponibile solo per admin","Sezione disponibile solo per admin");try{history.replaceState(null,document.title,location.pathname+location.search)}catch{}try{const o=document.querySelector(".wrap")||document.body;o&&typeof o.scrollIntoView=="function"?o.scrollIntoView({behavior:"smooth",block:"start"}):window.scrollTo({top:0,behavior:"smooth"})}catch{try{window.scrollTo({top:0,behavior:"smooth"})}catch{}}}}let bo=!1;function Ds(){bo||(window.addEventListener("hashchange",ho),bo=!0)}function Bs(e,t=150){let n=null;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e(...o),t)}}function yo(){const e=document.querySelector("header")||document.querySelector(".header")||null,t=e?e.getBoundingClientRect().height:64;document.documentElement.style.setProperty("--hdrH",`${t}px`)}globalThis.__MOBILE_AUDIO__=globalThis.__MOBILE_AUDIO__||{unlocked:!1,ctx:null,lastBeepAt:0,toastShown:!1},globalThis.__MOBILE_EVENTS__=globalThis.__MOBILE_EVENTS__||{prevPartialCount:null,prevProdKey:null,prevAlertKey:null};function vo(){if(!R())return;const e=globalThis.__MOBILE_AUDIO__;if(!e.unlocked)try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return;e.ctx=e.ctx||new t,e.ctx.state==="suspended"&&e.ctx.resume(),e.unlocked=!0}catch{}}window.addEventListener("pointerdown",vo,{once:!0,passive:!0}),window.addEventListener("touchstart",vo,{once:!0,passive:!0});function rn(e){if(!R())return;const t=globalThis.__MOBILE_AUDIO__,n=Date.now();if(!(n-t.lastBeepAt<6500)){if(t.lastBeepAt=n,navigator.vibrate&&navigator.vibrate(e==="partial"?[40,40,60]:[30,30,30]),!t.unlocked||!t.ctx){t.toastShown||(t.toastShown=!0,C("Audio attivo dopo il primo tap","Tocca una volta per abilitare il trillo.",2e3),setTimeout(()=>{t.toastShown=!1},4e3));return}try{const o=t.ctx,i=o.createOscillator(),s=o.createGain();i.type="sine";const a=o.currentTime,d=1e-4;s.gain.setValueAtTime(d,a),s.gain.exponentialRampToValueAtTime(.18,a+.02),s.gain.exponentialRampToValueAtTime(d,a+.18),i.frequency.setValueAtTime(e==="partial"?880:740,a),e==="partial"&&(s.gain.setValueAtTime(d,a+.2),s.gain.exponentialRampToValueAtTime(.16,a+.22),s.gain.exponentialRampToValueAtTime(d,a+.36)),i.connect(s),s.connect(o.destination),i.start(a),i.stop(a+(e==="partial"?.4:.2))}catch{}}}function Is({partialCount:e=0,prodKey:t=null,alertKey:n=null}={}){if(!R())return;const o=globalThis.__MOBILE_EVENTS__;o.prevPartialCount!==null&&e>o.prevPartialCount&&rn("partial"),o.prevPartialCount=e,t&&o.prevProdKey!==null&&t!==o.prevProdKey&&rn("event"),o.prevProdKey=t,n&&o.prevAlertKey!==null&&n!==o.prevAlertKey&&rn("event"),o.prevAlertKey=n}function Ps(){const e=typeof window<"u"?window.innerWidth>=1200:!1,t=$e?$e.matches:!1;return!!(e||t)}function wo(){const e=c("mobileSendCard"),t=c("mobileSendAnchor"),n=e?.parentElement;if(!e||!t||!n)return;if(!!(r.user&&r.user.isAdmin&&!R()&&typeof window<"u"&&window.innerWidth>=1025)){const i=n.firstElementChild;i!==e&&n.insertBefore(e,i||null)}else{const i=t.parentElement;i&&e.previousElementSibling!==t&&i.insertBefore(e,t.nextElementSibling)}}function _o(){const e=c("warehouseCard"),t=c("warehouseAnchor"),n=c("opsCard"),o=n?.parentElement;if(!e||!t||!n||!o)return;const i=typeof R=="function"?R():typeof window<"u"?window.innerWidth<=900:!1;if(document.body.classList.contains("adminDeskLayout")&&!R()&&(typeof window<"u"?window.innerWidth>=1025:!1)||i){let d=function(){const f=c("completedCard"),l=document.querySelector(".desktopCol.mainCol"),u=document.querySelector(".desktopCol.sideCol");if(!f||!l||!u)return;if(typeof window<"u"?window.innerWidth>=900:!1)(f.parentElement!==u||f!==u.firstElementChild)&&u.insertBefore(f,u.firstElementChild);else{const g=c("opsCard");g&&f.parentElement!==l&&l.insertBefore(f,g.nextElementSibling)}};const a=n.nextSibling;(e.parentElement!==o||e.previousElementSibling!==n)&&o.insertBefore(e,a)}else{const a=t.parentElement;a&&e.parentElement!==a&&a.insertBefore(e,t.nextElementSibling)}}function Fs(){const e=c("callMatteoCard"),t=document.querySelector(".desktopCol.mainCol");if(!e||!t)return;document.body.classList.contains("role-operator")&&R()&&(e.parentElement!==t||e!==t.lastElementChild)&&t.appendChild(e)}function So(){const e=c("completedCard"),t=document.querySelector(".desktopCol.mainCol"),n=document.querySelector(".desktopCol.sideCol");if(!e||!t||!n)return;r._completedHome||(r._completedHome={parent:e.parentElement,next:e.nextElementSibling});const o=!!(r.user&&r.user.isAdmin),i=typeof window<"u"?window.innerWidth>=1025:!1;if(o&&!R()&&i)(e.parentElement!==n||e!==n.firstElementChild)&&n.insertBefore(e,n.firstElementChild);else{const s=r._completedHome,a=s?.parent||t,d=s?.next||null;d&&d.parentElement===a?(e.parentElement!==a||e.nextElementSibling!==d)&&a.insertBefore(e,d):e.parentElement!==a&&a.appendChild(e)}}function Rs(){const e=!!(r.user&&r.user.isAdmin),t=typeof window<"u"?window.innerWidth>=1025:!1;if(!e||R()||!t){document.body.classList.remove("adminDeskLayout"),wo(),_o(),So();return}document.body.classList.add("adminDeskLayout"),wo(),_o(),So()}function Ao(){document.body.classList.remove("desktopAsMobile")}const zs=(()=>{let e=null;return()=>{clearTimeout(e),e=setTimeout(()=>Ao(),150)}})();function ve(){const t=!!(!!(r.user&&r.user.isAdmin)&&!R()&&Ps());document.body.classList.toggle("kioskAdmin",t),Rs()}function To(){const e=!R()&&window.innerWidth>=1025;document.body.classList.toggle("desktopV2",e)}const Lo=Bs(()=>{yo(),To()},150);function Co(e){let t=5381;for(let n=0;n<e.length;n++)t=(t<<5)+t+e.charCodeAt(n),t|=0;return Math.abs(t>>>0).toString(36)}function K(e){return(e==null?"":String(e)).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9_.\-\s]/g,"").replace(/\s+/g,"").trim()}function ko(e){if(!e)return"o_unknown";const t=e.orderNo||e.number||e.docNumber||e.id||e.orderId||e.numero;if(t){const f=K(t);return`o_${Co(f||String(t))}`}const n=Array.isArray(e.lines)&&e.lines.length?e.lines[0]:{},o=K(e.customer||e.cliente||""),i=K(n.desc||n.code||""),s=K(`${n.qty??""} ${n.um||n.uom||""}`),a=K(e.conclusion||e.date||e.deliveryDate||""),d=[o,i,s,a].filter(Boolean).join("|")||"ordine";return`o_${Co(d)}`}function we(e){if(!e)return"o_unknown";if(e.__k)return e.__k;const t=ko(e);try{Object.defineProperty(e,"__k",{value:t,writable:!1,enumerable:!1})}catch{e.__k=t}return t}async function Ks(e,t=15e3,n={}){const o=new AbortController,i=setTimeout(()=>o.abort(),t);try{return await fetch(e,{...n,signal:o.signal})}finally{clearTimeout(i)}}function C(e,t,n=3800){c("toastTitle").textContent=e,c("toastBody").textContent=t,c("toast").classList.add("show"),setTimeout(()=>c("toast").classList.remove("show"),n)}function Ye(e){document.documentElement.style.setProperty("--banner-offset",`${e||0}px`)}function Hs(e="L\u2019ordine \xE8 stato annullato."){const t=c("cancelBanner"),n=c("cancelBannerSub");!t||!n||(n.textContent=e,t.classList.add("show"),requestAnimationFrame(()=>{const o=t.getBoundingClientRect().height||0;Ye(o)}))}function Eo(){const e=c("cancelBanner");e&&(e.classList.remove("show"),Ye(0))}function an(e,t){return e.doc(t,to.col,to.doc)}function Us(e){if(!e)return 0;if(typeof e.toDate=="function")try{const o=e.toDate()?.getTime?.();return Number.isFinite(o)?o:0}catch{}if(e instanceof Date){const n=e.getTime();return Number.isFinite(n)?n:0}const t=Number(e);return Number.isFinite(t)?t:0}function qs(e){const t=e?.exists?.()?e.data()||{}:{},n=(t?.message||"").trim(),o=Us(t?.expiresAt);return{ok:!!(n&&(!o||Date.now()<o)),message:n,id:t?.id??"",expiresAt:o,raw:t}}function Ws(e){const t=String(e??"");if(!t)return!1;try{return localStorage.getItem(no)===t}catch{return!1}}function Vs(e){const t=String(e??"");if(t)try{localStorage.setItem(no,t)}catch{}}function Gs(){let e=c("topAlertBanner"),t=c("topAlertText"),n=c("topAlertClose");if(!e){e=document.createElement("div"),e.id="topAlertBanner",t=document.createElement("div"),t.className="topAlertText",t.id="topAlertText";const a=document.createElement("div");a.className="topAlertTrack",a.id="topAlertTrack";const d=document.createElement("span");d.className="topAlertMsg",d.id="topAlertMsgA";const f=document.createElement("span");f.className="topAlertMsg",f.id="topAlertMsgB",f.setAttribute("aria-hidden","true"),a.appendChild(d),a.appendChild(f),t.appendChild(a),n=document.createElement("button"),n.id="topAlertClose",n.type="button",n.className="topAlertClose",n.textContent="Chiudi";const l=document.createElement("div");l.className="topAlertOpen",l.id="topAlertOpen",l.textContent="Apri",l.addEventListener("click",u=>{u.stopPropagation(),Dt()}),e.addEventListener("click",u=>{u&&u.target&&u.target.id==="topAlertClose"||Dt()}),e.appendChild(t),e.appendChild(l),e.appendChild(n),document.body.appendChild(e)}let o=c("topAlertSpacer");o||(o=document.createElement("div"),o.id="topAlertSpacer");const i=document.querySelector(".wrap"),s=i?.querySelector("header.headerRow");return i&&s?(o.parentElement!==i||o.nextElementSibling!==s)&&i.insertBefore(o,s):o.parentElement||document.body.insertBefore(o,document.body.firstChild),{banner:e,text:t,closeBtn:n,spacer:o}}function Ze(){const e=c("topAlertBanner"),t=c("topAlertSpacer");if(t&&t.isConnected&&e){const o=e.getBoundingClientRect().height||0;t.style.height=`${o}px`,Ye(o);return}const n=c("cancelBanner");if(n&&n.classList.contains("show")){const o=n.getBoundingClientRect().height||0;Ye(o);return}Ye(0)}function Qe(){const e=c("topAlertBanner");e&&e.remove();const t=c("topAlertSpacer");t&&t.remove(),Ze()}function js(e){const t=c("adminLastAlert"),n=c("adminLastAlertText"),o=!!(r.user&&r.user.isAdmin);!t||!n||(o&&e?(t.style.display="block",n.textContent=e):(t.style.display="none",n.textContent=""))}function bt(){const e=c("alertAdminCard"),t=c("alertAdminStatus"),n=!!(r.user&&r.user.isAdmin),o=r.alerts?.data||null,i=!!(n&&o&&o.ok);e&&(e.style.display=n?"block":"none"),t&&(t.textContent=i?"Avviso attivo":"Nessun avviso"),js(i&&o?.message||"")}function Ys(e,t){const{banner:n,text:o,closeBtn:i}=Gs();n.dataset.alertId=String(t??"");const s=o?.querySelector?.("#topAlertMsgA"),a=o?.querySelector?.("#topAlertMsgB");s&&(s.textContent=e||""),a&&(a.textContent=e||"");const d=!!(r.user&&r.user.isAdmin);i&&(i.style.display=d?"":"none",i.disabled=!d,i.onclick=d?()=>Zs(t):null),n.classList.add("show"),Ze(),requestAnimationFrame(()=>Ze())}function Zs(e){Vs(e),Qe()}function Qs(e){const t=qs(e);if(r.alerts.data=t,bt(),!!(r.user&&r.user.isAdmin)){Qe();return}const o=Ws(t.id);if(!t.ok||o){Qe();return}Ys(t.message,t.id)}let ln=0;function G(){ln=window.scrollY||0,document.body.classList.add("noscroll"),document.body.style.top=`-${ln}px`,document.body.style.position="fixed",document.body.style.width="100%"}function q(){document.body.classList.remove("noscroll"),document.body.style.position="",document.body.style.top="",document.body.style.width="",window.scrollTo(0,ln)}const Js=c("bootFill"),Xs=c("bootMsg");let cn=0;function le(e,t){cn=Math.max(cn,Math.min(100,e)),Js.style.width=cn.toFixed(0)+"%",t&&(Xs.textContent=t)}async function er(){if(globalThis.__BOOT_DONE__){const n=c("startup");n&&(n.style.display="none");return}globalThis.__BOOT_DONE__=!0,le(10,"AVVIO: inizializzazione interfaccia\u2026"),await new Promise(n=>setTimeout(n,220)),le(25,"DOWNLOAD: ordini in corso\u2026");const e=Xe(!0,"boot");le(45,"SYNC: produzione in corso\u2026");const t=wr();await Promise.race([e,new Promise(n=>setTimeout(n,3200))]),le(80,"OTTIMIZZAZIONE: finalizzazione\u2026"),await Promise.race([t,new Promise(n=>setTimeout(n,1200))]),le(100,"OK: pronto"),await new Promise(n=>setTimeout(n,140)),c("startup").style.display="none",C("Operativit\xE0","Per avviare un ordine: VAI IN PRODUZIONE \u2192 scegli operatore \u2192 seleziona righe \u2192 INIZIA PRODUZIONE.")}function Oe(e,t={}){const n=Number(e);if(!Number.isFinite(n))return null;const o=[.5,1,5,10];for(const i of o)if(Math.abs(n-i)<.011)return i;return t.strict?null:n>0?n:null}function _e(e){const t=U(e||"").replace(/,/g,".");if(!t)return null;const n=[{kg:10,re:/\b10\s?kg\b|\bsacco\s?10\b|\bsacchi\s?da\s?10\b/},{kg:5,re:/\b5\s?kg\b|\bsacco\s?5\b|\bsacchi\s?da\s?5\b/},{kg:1,re:/\b1\s?kg\b|\bsacchetto\s?1\b|\bsacchetti\s?da\s?1\b/},{kg:.5,re:/\b0[.,]5\s?kg\b|\b500\s?g\b|\b0[.,]5kg\b|\bsacchetto\s?500\b/}];for(const{kg:d,re:f}of n)if(f.test(t))return d;const o=t.match(/(\d+(?:\.\d+)?)[x\-\s]*kg\b/);if(o){const d=Oe(parseFloat(o[1]));if(d!=null)return d}const i=t.match(/\bkg[x\-\s]*(\d+(?:\.\d+)?)/);if(i){const d=Oe(parseFloat(i[1]));if(d!=null)return d}const s=t.match(/(\d+(?:\.\d+)?)[x\-\s]*(?:gr|g|grammi)\b/);if(s){const d=Oe(parseFloat(s[1])/1e3);if(d!=null)return d}const a=t.match(/\b(sacchi|sacchetti|sacco|sacchetto)\s*(?:da\s*)?(\d+(?:\.\d+)?)/);if(a){const d=Oe(parseFloat(a[2]));if(d!=null)return d}return null}function yt(e={}){const t=po(e.qty??e.quantity);if(!Number.isFinite(t)||t<=0)return 0;const o=[e.um,e.uom,e.unitaMisura,e.unit,e.measure].find(g=>g!=null&&String(g).trim()!=="")||"",i=o.toString().toUpperCase().replace(/\./g,""),s=/\b(PZ|PZS|PCS?|PCE|PEZ|PEZZ[IO]?|NR|SAC|SACCO|SACCHI|SACCHETTO|SACCHETTI|SACCH)\b/.test(i),d=/\bKG\b/.test(i)&&!s,f=s;let l=e.packKg;if(!(Number.isFinite(l)&&l>0)){const g=e.desc||e.description||"",p=_e(g);if(Number.isFinite(p)&&p>0)l=p;else if(o||g){const y=_e(`${g} ${o}`.trim());Number.isFinite(y)&&y>0&&(l=y)}}const u=Number(l),m=Number.isFinite(u)&&u>0;return d?t:f&&m?t*u:t}window.__resolveQtyKg=yt,window.__detectPackKg=_e;function tr(e){const t=e||"";if((t||"").toUpperCase().includes("SACCHETTO BIANCO"))return{label:"SACCHETTO BIANCO",color:"white"};const o=U(t);if(!o||!/\b(sacco|sacchetto|bobina)\b/.test(o))return null;const i=o.match(/\b(blu|azzur\w+|ross\w+|bianc\w+|ner\w+|verd\w+|giall\w+)\b/);if(!i||/\b(rame|zolfo|caolino|ossicloruro|poltiglia|zeolite)\b/.test(o))return null;const s=i[1],a=s.includes("azzur")||s.includes("blu")?"blue":s.includes("ross")?"red":s.includes("bianc")?"white":s.includes("ner")?"black":s.includes("verd")?"green":s.includes("giall")?"yellow":"other";return{label:(e||"").trim()||"Avviso",color:a}}function nr(e){const t=[];for(const o of e||[]){if(o.alertInfo)continue;const i=Number(o.packKg),s=_e(o.desc||""),a=Number.isFinite(i)&&i>0?i:Number.isFinite(s)&&s>0?s:null;a!=null&&t.push(a)}if(!t.length)return"large";const n=Math.max(...t);return n>=5?"large":n>0?"small":"large"}function No(e){switch(e){case"blue":return{bg:"rgba(46,123,255,.12)",border:"rgba(46,123,255,.35)",color:"#0a3a7d"};case"red":return{bg:"rgba(255,59,48,.14)",border:"rgba(255,59,48,.4)",color:"#8a1f1a"};case"white":return{bg:"rgba(255,255,255,.92)",border:"rgba(255,255,255,.35)",color:"#1c1c1e",shadow:"0 1px 0 rgba(0,0,0,.04), 0 10px 22px rgba(0,0,0,.08)"};case"black":return{bg:"#1c1c1e",border:"rgba(0,0,0,.6)",color:"#f5f5f7"};case"green":return{bg:"rgba(52,199,89,.14)",border:"rgba(52,199,89,.38)",color:"#0b5d2a"};case"yellow":return{bg:"rgba(255,214,10,.32)",border:"rgba(255,184,0,.68)",color:"#4d2d00",shadow:"0 12px 26px rgba(255,193,7,.22)"};default:return{bg:"rgba(0,0,0,.05)",border:"rgba(0,0,0,.12)",color:"#1c1c1e"}}}function xo(e){if(!e||typeof e!="object")return!1;for(const t of Object.values(e)){if(typeof t!="string")continue;const n=t.toUpperCase();if(n.includes("**")||n.includes("SACCHETTO BIANCO"))return!0}return!1}function dn(e){return xo(e)}const $e=typeof window<"u"&&window.matchMedia?window.matchMedia("(min-aspect-ratio: 16/10)"):null,Mo=window.matchMedia("(min-width: 1024px)");function Je(){const e=c("statsProdCard"),t=c("statsCardAnchor"),n=c("opsCard");if(!e||!t||!n)return;const o=t.parentElement;o&&e.parentElement!==o&&o.insertBefore(e,t.nextElementSibling)}Je(),Fs();function or(e={}){const{selectable:t=!0,checked:n=!1,badgeText:o=""}=e;return`
      <div class="whiteBagBanner" role="note" aria-label="\u26A0\uFE0F SACCHETTO BIANCO \u2014 Devi usare il sacchetto bianco">
        <div class="icon">\u26A0\uFE0F</div>
        <div class="txt">
          <div class="t">SACCHETTO BIANCO</div>
          <div class="s">\u2014 Devi usare il sacchetto bianco</div>
        </div>
        ${t?`<div class="badge">${o||(n?"\u2713":"Seleziona")}</div>`:""}
      </div>
    `}function ir(e,t,n){const o=U(e).replace(/\s+/g,"");if(o&&as.has(o))return!1;const i=U(t),s=U(n);if(/\b(mastice)\b/.test(i)||/\b(secchio|tanica|flacone|bottiglia|spray|trigger|pompa|nebul|olio|shampoo|deterg|repel|bio)\b/.test(i)||/\b\d+(?:[\.,]\d+)?\s*(ml|l|lt)\b/.test(i)||s==="l"||s==="lt"||s==="ml")return!1;const a=_e(t),d=/\b(big\s*bag|bigbag)\b/.test(i);return a!=null&&a>10.0001&&!d?!1:!!(d&&a!=null&&a>=100||/\b(sacco|sacchetto|busta|bustina|barattolo)\b/.test(i)||s==="kg"||s==="g"||/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/.test(i)||/\b(ossicloruro|poltiglia|caolino|zeolite|zolfo|rame|solfato|idrossido|tribasico|diatomite|agroblumagic|corrobor)\b/.test(i))}function sr(e,t=""){const n=U(e),o=U(t),i=s=>s.test(n)||s.test(o);return i(/\b(rame|copper|cupr|cu)\b/)||n.includes("bordolese")||n.includes("poltiglia")?"rame":i(/\b(zolfo|sulfur|sulf)\b/)?"zolfo":i(/\b(caolino|kaolin|caol)\b/)?"caolino":i(/\b(zeolite|zeolit)\b/)?"zeolite":i(/\b(diatomite|agroblumagic|corrobor)\b/)?"corroborante":"altro"}function rr(e){return(e||"").toString().replace(/\|\s*CONCIME.*$/i,"").replace(/\|\s*CONSENTITO.*$/i,"").replace(/\|\s*AMMESSO.*$/i,"").replace(/\s{2,}/g,"").trim()}function ar(e){if(!e)return null;const t=["Total","TotalDoc","TotalDocument","TotalAmount","Amount","DocTotal","TotalWithTax","GrossTotal"];for(const n of t){const o=V(e.getElementsByTagName(n)[0]),i=je(o);if(i!=null)return i}return null}async function Oo(e){const t=[],o=new DOMParser().parseFromString(e,"text/xml"),i=Array.from(o.getElementsByTagName("Document"));for(let s=0;s<i.length;s++){const a=i[s],d=V(a.getElementsByTagName("CustomerName")[0])||"Cliente",f=V(a.getElementsByTagName("Number")[0])||"",l=V(a.getElementsByTagName("Date")[0])||"";let u=V(a.getElementsByTagName("ExpectedConclusion")[0])||V(a.getElementsByTagName("ExpectedDeliveryDate")[0])||V(a.getElementsByTagName("DeliveryDate")[0])||"";const m=ar(a),g=[],p=Array.from(a.getElementsByTagName("Row"));for(let y=0;y<p.length;y++){y&&y%90===0&&await Qt();const b=p[y],v=V(b.getElementsByTagName("Code")[0])||"",S=V(b.getElementsByTagName("Description")[0])||V(b.getElementsByTagName("Name")[0])||"",w=V(b.getElementsByTagName("UM")[0])||V(b.getElementsByTagName("Unit")[0])||"";let h=V(b.getElementsByTagName("Qty")[0])||V(b.getElementsByTagName("Quantity")[0])||"0";h=parseFloat(h.replace(",",".")),Number.isFinite(h)||(h=0);const A=tr(S),L=A?!1:ir(v,S,w),k=_e(S),T=L?sr(S,v):"altro",E=!L||A?0:yt({qty:h,um:w,packKg:k,desc:S}),N=`${f}|${y}|${U(v)||U(S).slice(0,24)}`;g.push({lineKey:N,code:v,desc:rr(S),um:w,qty:h,powder:L,packKg:k,lineKg:E,material:T,alertInfo:A})}t.push({customer:d,number:f,date:l,conclusion:u,totalDoc:m,lines:g}),s&&s%12===0&&await Qt()}return t}async function lr(e=!1,t="manual"){try{un("warn","Stato: sincronizzazione\u2026");const n=!H.firstRenderDone;Me(n?"Connessione\u2026":"Aggiornamento\u2026"),e&&le(40,"DOWNLOAD: ordini in corso\u2026");const o=await Ks(Ht.proxyUrl,16e3,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json();if(i&&i.ok===!1)throw new Error(i.error||"Proxy: errore");const s=i?.xml;if(!s||typeof s!="string")throw new Error("XML mancante");r.xmlModifiedTime=i?.modifiedTime||null,r.lastFetchAt=Date.now(),localStorage.setItem(Ht.cacheKey,JSON.stringify({at:r.lastFetchAt,xml:s,modifiedTime:r.xmlModifiedTime})),Me(n?"Parsing\u2026":"Aggiornamento\u2026"),r.docs=await Oo(s),r.fatturatoLordo=En(r.docs);const a=[];for(const d of r.docs){const f=d.lines.filter(m=>m.powder);if(!f.length)continue;const l=f.reduce((m,g)=>m+(g.lineKg||0),0),u=d.lines.filter(m=>m.alertInfo);a.push({customer:d.customer,number:d.number,orderNo:d.number,conclusion:d.conclusion,lines:f,alerts:u,totalKg:l})}r.powderOrders=a,Go(),Me("Aggiornamento\u2026"),Y(),un("ok","Stato: online"),e&&le(62,"OK: ordini aggiornati"),H.inError=!1,H.firstRenderDone?uo():requestAnimationFrame(()=>fo()),Cs()}catch(n){console.warn("syncOrders failed",n),mo("Connessione instabile. Riprovo\u2026");const o=localStorage.getItem(Ht.cacheKey);if(o)try{const i=JSON.parse(o);r.lastFetchAt=i.at||null,r.xmlModifiedTime=i.modifiedTime||null,r.docs=await Oo(i.xml||""),r.fatturatoLordo=En(r.docs);const s=[];for(const a of r.docs){const d=a.lines.filter(u=>u.powder);if(!d.length)continue;const f=d.reduce((u,m)=>u+(m.lineKg||0),0),l=a.lines.filter(u=>u.alertInfo);s.push({customer:a.customer,number:a.number,orderNo:a.number,conclusion:a.conclusion,lines:d,alerts:l,totalKg:f})}r.powderOrders=s,Go()}catch{}Y(),un("bad","Stato: offline (cache)"),e&&le(55,"Connessione lenta\u2026 uso cache locale"),H.firstRenderDone||requestAnimationFrame(()=>fo()),ks()}}function un(e,t){const n=c("dotOnline");n.className="dot",e==="ok"&&n.classList.add("ok"),e==="warn"&&n.classList.add("warn"),e==="bad"&&n.classList.add("bad"),c("txtOnline").textContent=t}async function Xe(e=!1,t="manual"){return pt?(Yt=!0,Zt):(pt=!0,Zt=(async()=>{try{await lr(e,t)}finally{if(pt=!1,Yt)return Yt=!1,Xe(!1,"queued")}})(),Zt)}let vt=!1;const fn=(()=>{let e=null;return t=>{clearTimeout(e),e=setTimeout(()=>$o(t),180)}})();async function $o(e="manual"){if(!vt){vt=!0;try{await Xe(!1,e),Y(),(e==="focus"||e==="pageshow")&&C("Aggiornato","Dati ricaricati (riapertura).",1800)}finally{vt=!1}}}function Do(e){const t=c("btnHeaderRefresh"),n=c("refreshErrBadge");t&&t.classList.toggle("hasError",!!e),n&&(n.style.display=e?"inline-flex":"none")}function cr(){if(globalThis.__REFRESH_BTN_BOUND__)return;const e=c("btnHeaderRefresh");e&&(globalThis.__REFRESH_BTN_BOUND__=!0,e.addEventListener("click",async()=>{if(globalThis.__updateInFlight__||vt||pt)return;Do(!1),e.classList.add("isSpinning");let t=!1;try{await $o("manual_btn"),t=!H.inError}catch(n){console.warn("manual refresh failed",n)}finally{setTimeout(()=>e.classList.remove("isSpinning"),850),t||Do(!0)}}))}function mn(e){const t=(e&&(e.code||e.message||"")).toString(),n={"auth/unauthorized-domain":"Dominio non autorizzato. Verifica in Firebase: Authentication \u2192 Settings \u2192 Domini autorizzati.","auth/operation-not-allowed":"Provider Google non abilitato. Verifica in Firebase: Authentication \u2192 Sign-in method.","auth/popup-blocked":"Popup bloccato dal browser. Riprovo con reindirizzamento\u2026","auth/popup-closed-by-user":"Popup chiuso. Riprova.","auth/cancelled-popup-request":"Richiesta annullata. Riprova.","auth/network-request-failed":"Connessione instabile. Riprova tra qualche secondo.","auth/invalid-api-key":"Config Firebase non valida (apiKey).","auth/invalid-oauth-client-id":"Client OAuth non valido (Google). Controlla la configurazione Web SDK.","auth/redirect-cancelled-by-user":"Accesso annullato. Riprova.","auth/redirect-operation-pending":"Accesso gi\xE0 in corso. Attendi e riprova."};for(const o in n)if(t.includes(o))return n[o];return"Errore accesso. Controlla rete e riprova."}const pn="powderUsers";function Bo(){de(),c("authGate").classList.add("show"),G()}function Io(){c("authGate").classList.remove("show"),q()}function gn(){try{const e=parseInt(localStorage.getItem(Ut)||"0",10);return!Number.isFinite(e)||e<=0?!1:Date.now()-e<Xi}catch{return!1}}function dr(e=""){try{localStorage.setItem(Ut,String(Date.now())),e&&localStorage.setItem(jn,String(e))}catch{}}function Po(){try{localStorage.removeItem(Ut)}catch{}try{localStorage.removeItem(jn)}catch{}}function ce(e){ro=e}function hn(){const e=document.querySelector(".wrap");let t=!1,n=!1;e&&(e.style.visibility="visible",e.style.pointerEvents="auto")}function ur(){hn(),wt(),de()}function Fo(e="Verifica accesso\u2026"){const t=c("authLoader");if(!t)return;const n=t.querySelector(".txt");n&&(n.textContent=e),t.classList.add("show")}function de(){const e=c("authLoader");e&&e.classList.remove("show")}function wt(){Io()}function al(e=""){ce("signed_out"),de(),Se(e)}function Ro(){globalThis.__RESTORE_TIMER__&&(clearTimeout(globalThis.__RESTORE_TIMER__),globalThis.__RESTORE_TIMER__=null),ft=null}function zo(e){typeof e=="function"&&(ft=e),!globalThis.__RESTORE_TIMER__&&(globalThis.__RESTORE_TIMER__=setTimeout(()=>{globalThis.__RESTORE_TIMER__=null;const t=r.firebase?.auth;if(t&&t.currentUser){ce("signed_in"),de(),wt();return}typeof ft=="function"&&ft()},es))}function bn(e="Ripristino sessione\u2026"){ce("restoring"),hn(),wt(),Fo(e)}function Ko(){if(R()&&gn()){bn("Ripristino sessione\u2026");return}ce("unknown"),hn(),wt(),Fo("Verifica accesso\u2026")}async function fr(e){const t=String(e||"").trim().toLowerCase();if(!t||!r.firebase.ok)return null;const n=r.firebase.api,o=r.firebase.db,i=n.doc(o,pn,t),s=await n.getDoc(i);return s.exists()&&s.data()||null}function mr(e,t=""){ce("signed_out"),de(),Bo();const n=c("authBody");n.innerHTML=`
      <div class="stepTitle">Accesso non abilitato</div>
      <div class="muted">Questa email non risulta autorizzata ad accedere all\u2019hub.</div>
      <div style="height:10px"></div>
      <div class="pill" style="display:inline-block;background:#fff3f2;color:#8a1f1a;border:1px solid #ffd1cd;">${_(e||"")}</div>
      ${t?`<div style="height:10px"></div><div class="muted">${_(t)}</div>`:""}
      <div style="height:14px"></div>
      <button id="btnLogout" class="btn bad" type="button">Esci</button>
      <div style="height:8px"></div>
      <div class="muted">Se serve, chiedi all\u2019amministrazione di abilitare la tua email.</div>
    `,c("btnLogout").onclick=async()=>{try{await r.firebase.authApi.signOut(r.firebase.auth)}catch{}Se("")}}function Se(e=""){ce("signed_out"),de(),Bo();const t=c("authBody");t.innerHTML=`
      <div class="stepTitle">Accesso richiesto</div>
      <div class="muted">${e||"Accedi per iniziare. Se la tua email non \xE8 autorizzata, contatta un amministratore."}</div>
      <div style="height:12px"></div>

      <button class="btn good" id="btnGoogle" style="width:100%;">Accedi con Google</button>
      <div style="height:10px"></div>

      <div class="divider"></div>
      <div class="stepTitle" style="font-size:16px; margin-top:0;">Oppure con email</div>

      <div class="authRow">
        <div class="field">
          <label>Nome</label>
          <input id="authName" autocomplete="given-name" placeholder="Nome" />
        </div>
        <div class="field">
          <label>Cognome</label>
          <input id="authSurname" autocomplete="family-name" placeholder="Cognome" />
        </div>
      </div>
      <div class="field">
        <label>Email</label>
        <input id="authEmail" type="email" autocomplete="email" placeholder="nome@azienda.it" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="authPass" type="password" autocomplete="current-password" placeholder="Password" />
      </div>

      <div class="row2">
        <button class="btn" id="btnEmailLogin">Accedi</button>
        <button class="btn ghost" id="btnEmailSignup">Crea account</button>
      </div>

      <div style="height:12px"></div>
      <div class="muted">Nota: la pagina resta sempre in italiano.</div>
    `,t.querySelector("#btnGoogle").onclick=async()=>{const n=r.firebase.authApi,o=r.firebase.auth,i=new n.GoogleAuthProvider;r.lastAuthErrorMsg="";try{await n.signInWithPopup(o,i)}catch(s){console.warn("Google popup error",s);const a=mn(s);if(s&&s.code==="auth/popup-blocked"||s&&s.code==="auth/operation-not-supported-in-this-environment"){C("Accesso",a);try{await n.signInWithRedirect(o,i);return}catch(d){console.warn("Google redirect error",d),r.lastAuthErrorMsg=mn(d),Se(r.lastAuthErrorMsg);return}}r.lastAuthErrorMsg=a,C("Accesso",a)}},t.querySelector("#btnEmailLogin").onclick=async()=>{const n=t.querySelector("#authEmail").value.trim(),o=t.querySelector("#authPass").value;if(!n||!o){C("Accesso","Inserisci email e password.");return}try{await r.firebase.authApi.signInWithEmailAndPassword(r.firebase.auth,n,o)}catch(i){console.warn(i),C("Accesso","Credenziali non valide o account inesistente.")}},t.querySelector("#btnEmailSignup").onclick=async()=>{const n=t.querySelector("#authName").value.trim(),o=t.querySelector("#authSurname").value.trim(),i=t.querySelector("#authEmail").value.trim(),s=t.querySelector("#authPass").value;if(!n||!o||!i||!s){C("Registrazione","Compila nome, cognome, email e password.");return}try{const d=await r.firebase.authApi.createUserWithEmailAndPassword(r.firebase.auth,i,s);await yn(d.user,{fullName:`${n} ${o}`,name:n,surname:o,email:i})}catch(a){console.warn(a),C("Registrazione","Impossibile creare l\u2019account (email gi\xE0 usata o password debole).")}}}async function yn(e,t){if(!r.firebase.ok)return;const n=r.firebase.api,o=r.firebase.db,i=n.doc(o,pn,e.uid);await n.setDoc(i,{uid:e.uid,...t,updatedAt:W(),createdAt:W()},{merge:!0})}async function pr(e){if(!r.firebase.ok)return null;const t=r.firebase.api,n=r.firebase.db,o=t.doc(n,pn,e),i=await t.getDoc(o);return i.exists()?i.data()||{}:null}let De=null,ue=null,Be=1500;const gr=6e4;let Ie=0,_t=null,Ho=!1;function et(){if(De){try{De()}catch{}De=null}ue&&(clearTimeout(ue),ue=null)}function tt(){if(De||(ue&&(clearTimeout(ue),ue=null),!r.firebase.ok||!r.user))return;const e=r.firebase.api,t=r.firebase.db;if(!(!e||!t))try{const n=e.collection(t,"powderProductions"),o=e.collection(t,"powderProdHistory"),i=an(e,t),s=[],a=l=>{const u=Date.now();if((!Ie||u-Ie>1e4)&&(console.warn("onSnapshot error",l),Ie=u),et(),navigator.onLine===!1)return;Be=Math.min(gr,Be*2);const m=Math.floor(Math.random()*251);ue=setTimeout(()=>{ue=null,tt()},Be+m)},d=l=>{const u=[];l.forEach(m=>u.push({id:m.id,...m.data()})),r.activeProductions=u.filter(m=>m&&m.active),Y(),Be=1500},f=l=>{const u=[];l.forEach(p=>u.push({id:p.id,...p.data()}));const m=Ge(),g=m?u.filter(p=>Ke(p.id||p.at||0)>m):u;r.history=g,r.historyReady=!0,Mt(),Le();try{rt()}catch{}try{renderPartialBanner&&renderPartialBanner()}catch{}Be=1500};s.push(e.onSnapshot(n,d,a));try{s.push(e.onSnapshot(o,f,a))}catch{}try{const l=e.onSnapshot(i,Qs,a);s.push(l),r.alerts.unsub=l}catch{r.alerts.unsub=null}De=()=>{for(const l of s)try{l&&l()}catch{}r.alerts.unsub=null,De=null}}catch(n){const o=Date.now();(!Ie||o-Ie>1e4)&&(console.warn("snapshot start failed",n),Ie=o)}}function hr(){if(Ho)return;Ho=!0;function e(l){const u=c("absenceModal");u&&u.setAttribute("data-step",l),document.querySelectorAll("#absenceModal .absenceStep").forEach(g=>{const p=g.dataset.step===l;g.classList.toggle("isActive",p)});const m=c("absenceBreadcrumb");m&&(m.textContent=l==="form"?"Step 1 di 2 \xB7 Compila":"Step 2 di 2 \xB7 Conferma")}function t(){const l=r.user?.fullName||r.user?.email||"Operatore",u=(c("absFrom")?.value||"").trim()||"\u2014",m=(c("absTo")?.value||"").trim()||"\u2014",g=(c("absReason")?.value||"").trim()||"\u2014";try{c("absSummaryUser").textContent=l}catch{}try{c("absSummaryFrom").textContent=u}catch{}try{c("absSummaryTo").textContent=m}catch{}try{c("absSummaryReason").textContent=g}catch{}try{c("absUserName").textContent=l}catch{}}function n(){const l=c("absFeedback"),u=(c("absFrom")?.value||"").trim(),m=(c("absTo")?.value||"").trim(),g=(c("absReason")?.value||"").trim();return l&&(l.textContent=""),!u||!m?(l&&(l.textContent="Seleziona sia 'Da' che 'A'."),null):u>m?(l&&(l.textContent="Le date non tornano: 'Da' deve essere prima o uguale ad 'A'."),null):!g||g.length<3?(l&&(l.textContent="Inserisci una motivazione (minimo 3 caratteri)."),null):{from:u,to:m,reason:g,fb:l}}function o(){const l=c("absenceModal");if(!l||!!(r.user&&r.user.isAdmin)||!R())return;e("form"),l.style.display="block",l.classList.add("show"),G();try{const g=new Date,p=S=>String(S).padStart(2,"0"),y=`${g.getFullYear()}-${p(g.getMonth()+1)}-${p(g.getDate())}`,b=c("absFrom"),v=c("absTo");b&&!b.value&&(b.value=y),v&&!v.value&&(v.value=y)}catch{}t();const m=c("absFeedback");m&&(m.textContent="")}function i(){const l=c("absenceModal");l&&(l.classList.remove("show"),l.style.display="none",q(),e("form"))}try{c("btnAbsenceOpen")?.addEventListener("click",o),c("absenceClose")?.addEventListener("click",i),c("absenceModal")?.addEventListener("click",l=>{l.target&&l.target.id==="absenceModal"&&i()}),c("btnAbsenceNext")?.addEventListener("click",()=>{const l=n();if(l){t(),e("review"),l.fb&&(l.fb.textContent="Controlla il riepilogo e premi \xABInvia richiesta\xBB.");try{c("btnAbsenceSend")?.focus()}catch{}}}),c("btnAbsenceEdit")?.addEventListener("click",()=>{e("form");const l=c("absFeedback");l&&(l.textContent="Puoi modificare i dati prima di inviare.")}),c("btnAbsenceSend")?.addEventListener("click",async()=>{const l=n();if(!l)return;const{from:u,to:m,reason:g,fb:p}=l;t(),e("review");try{c("btnAbsenceSend").disabled=!0,p&&(p.textContent="Invio richiesta\u2026"),await Ta({type:"absence_request",line:"polveri",from:u,to:m,reason:g});try{await nt({type:"absence",action:"Programmazione assenza",description:`Da ${u} a ${m}`,meta:g})}catch{}try{const b=`Richiesta assenza \xB7 ${r.user?.fullName||"Operatore"}`,v=`Da: ${u}  A: ${m}
Motivo: ${g}`;await wi(b,v)}catch(b){console.warn("absence notif failed (permissions?)",b);try{await Sn({customer:"ASSENZA",orderNo:"",text:`Richiesta assenza \xB7 ${r.user?.fullName||""}
Da: ${u}  A: ${m}
Motivo: ${g}`})}catch{}}p&&(p.textContent="Richiesta inviata \u2705"),C("Richiesta inviata","Ok \u2014 l\u2019amministrazione la vedr\xE0 nelle notifiche.");try{c("absReason").value=""}catch{}setTimeout(()=>i(),450)}catch(y){console.warn("absence send error",y),p&&(p.textContent="Invio non riuscito (connessione o permessi)."),C("Invio non riuscito","Controlla connessione o permessi Firebase.")}finally{try{c("btnAbsenceSend").disabled=!1}catch{}}})}catch{}function s(){const l=!!(r.user&&r.user.isAdmin),u=c("issueModal");if(u){u.style.display="block",u.classList.add("show"),G();try{c("issueModalFeedback").textContent=""}catch{}try{c("issueModalText").focus()}catch{}}}function a(){const l=c("issueModal");l&&(l.classList.remove("show"),l.style.display="none",q())}function d(){const l=c("warehouseModal"),u=c("warehouseModalBody"),m=c("warehouseBadgeModal");if(!(!l||!u||!m)){try{ge(!0)}catch{}l.style.display="flex",l.classList.add("show"),G()}}function f(){const l=c("warehouseModal");l&&(l.classList.remove("show"),l.style.display="none",q())}try{c("btnIssueOpen")?.addEventListener("click",s),c("issueClose")?.addEventListener("click",a),c("issueModal")?.addEventListener("click",l=>{l.target===c("issueModal")&&a()}),c("btnIssueSendModal")?.addEventListener("click",async()=>{const l=c("issueModalFeedback"),u=(c("issueModalText")?.value||"").trim();if(l&&(l.textContent=""),!u||u.length<3){l&&(l.textContent="Scrivi almeno 3 caratteri.");return}try{c("btnIssueSendModal").disabled=!0,l&&(l.textContent="Invio\u2026"),await Sn({text:u,message:u,line:"polveri"}),C("Segnalazione inviata","Grazie. La segnalazione \xE8 stata registrata.");try{c("issueModalText").value=""}catch{}l&&(l.textContent="Inviata \u2705"),setTimeout(()=>a(),420)}catch(m){console.warn("issue send modal error",m),l&&(l.textContent="Invio non riuscito (connessione o permessi)."),C("Invio non riuscito","Controlla connessione o permessi Firebase.")}finally{try{c("btnIssueSendModal").disabled=!1}catch{}}})}catch{}try{c("btnWarehouseOpen")?.addEventListener("click",d),c("warehouseClose")?.addEventListener("click",f),c("warehouseModal")?.addEventListener("click",l=>{l.target===c("warehouseModal")&&f()})}catch{}try{c("warehouseRefreshBtn")?.addEventListener("click",()=>{const l=c("warehouseRefreshBtn");l&&(l.classList.add("isBusy"),l.disabled=!0);try{ge(!0)}catch{}setTimeout(()=>{l&&(l.classList.remove("isBusy"),l.disabled=!1)},480)})}catch{}try{c("btnClearNotifs")?.addEventListener("click",()=>{_a(),C("Notifiche cancellate","Pulite solo su questo dispositivo.")})}catch{}try{c("alertClose")?.addEventListener("click",_i),c("alertModal")?.addEventListener("click",l=>{l.target===c("alertModal")&&_i()}),c("topAlertBanner")?.addEventListener("click",l=>{l&&l.target?.id==="topAlertClose"||Dt()}),c("topAlertOpen")?.addEventListener("click",l=>{l?.stopPropagation?.(),Dt()})}catch{}document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?et():(_t&&clearTimeout(_t),_t=setTimeout(()=>{_t=null,tt()},300))}),window.addEventListener("online",()=>{Be=1500,tt()}),window.addEventListener("offline",()=>{et()})}function Uo(){if(et(),r.alerts={unsub:null,data:null},r.alertSaving=!1,Qe(),bt(),r.historyReady=!1,r.history=[],jo(),r.actionLogs={entries:[],ready:!1,error:""},Vt(),r.notifUnsub){try{r.notifUnsub()}catch{}r.notifUnsub=null}r.notifications={inbox:[],ready:!1,unavailable:!1,error:""},he(),te(),Le();try{c("payrollAdminModal").style.display="none",c("payrollUserModal").style.display="none"}catch{}Vt();try{ne("idle"),ct()}catch{}r.user=null,r.operator=null,go(),ve(),c("hdrUser").textContent="\u2014"}function vn(e=""){Ro(),Po(),ce("signed_out"),de(),Uo(),Se(e)}async function br(){const e=r.firebase.authApi,t=r.firebase.auth;Ko();try{await e.getRedirectResult(t)}catch(n){console.warn("getRedirectResult error",n),r.lastAuthErrorMsg=mn(n)}globalThis.__AUTH_LISTENER_BOUND__||(globalThis.__AUTH_LISTENER_BOUND__=!0,e.onAuthStateChanged(t,async n=>{if(Ro(),n||et(),!n){const s=r.lastAuthErrorMsg||"";if(r.lastAuthErrorMsg="",R()&&gn()){bn("Ripristino sessione\u2026"),zo(()=>vn(s));return}vn(s);return}ce("signed_in"),ur(),dr(n.email||"");let o=await pr(n.uid);if(!o)o={fullName:(n.displayName||"").trim()||n.email||"",email:n.email||""},await yn(n,o);else if(!o.fullName){const s=(n.displayName||"").trim();o.fullName=s||n.email||"",await yn(n,{fullName:o.fullName,email:n.email||""})}const i=await fr(n.email||"");if(!i||i.enabled===!1){Po(),Uo(),mr(n.email||"",i&&i.enabled===!1?"Accesso disabilitato.":"Email non presente in elenco autorizzati.");return}i&&i.displayName&&(o.fullName=i.displayName),r.user={uid:n.uid,fullName:o.fullName,email:n.email||o.email||"",isAdmin:!!(i&&i.isAdmin)},r.operator=r.user.fullName,c("hdrUser").textContent=r.user.fullName;try{await ss()}catch{}go(),ho(),Ds();try{await ms()}catch{gt(Xt(),r.globalStats?.source||"local")}Le(),ve();try{await La()}catch{r.notifications.unavailable=!0,te()}te(),$i();try{await el()}catch{lt()}Io(),de(),Y(),kr(),Er(),tt()}))}function yr(){R()&&ro!=="signed_out"&&gn()&&r.firebase?.auth&&(bn("Ripristino sessione\u2026"),zo(()=>vn("")))}function vr(){if(globalThis.__AUTH_RESUME_BOUND__)return;globalThis.__AUTH_RESUME_BOUND__=!0;const e=()=>yr();window.addEventListener("pageshow",e),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&e()}),window.addEventListener("focus",e)}async function wr(){try{const t=new Promise((o,i)=>setTimeout(()=>i(new Error("firebase timeout")),5500)),n=(async()=>{const{initializeApp:o}=await import(ji),i=await import(Yi),s=await import(Zi),a=await import(Qi),d=await import(Ji);try{i.setLogLevel&&i.setLogLevel("error")}catch{}const f=o(Vn),l=i.initializeFirestore(f,{experimentalAutoDetectLongPolling:!0,useFetchStreams:!1}),u=s.getStorage(f,Vn.storageBucket),m=a.getAuth(f);let g=null;try{await a.setPersistence(m,a.browserLocalPersistence)}catch{}r.firebase.ok=!0,r.firebase.db=l,r.firebase.api=i,r.firebase.storage=u,r.firebase.storageApi=s,r.firebase.authApi=a,r.firebase.auth=m,r.firebase.msgApi=d;try{r.push.supported=await d.isSupported()}catch{r.push.supported=!1}if(r.push.supported)try{g=d.getMessaging(f)}catch{g=null}r.firebase.messaging=g})();await Promise.race([n,t]),await br(),hr(),tt()}catch(e){console.warn("Firebase init failed:",e),r.firebase.ok=!1,r.notifications.unavailable=!0,te(),he(),Y(),Se("Connessione Firebase non disponibile. Verifica rete o contatta il responsabile.")}}async function _r(e){if(!r.firebase.ok)return null;const t=r.firebase.api,n=r.firebase.db,o=e.id||`${Date.now()}_${Math.random().toString(16).slice(2)}`;return await t.setDoc(t.doc(n,"powderProductions",o),{...e,id:o,active:!0},{merge:!0}),o}async function qo(e,t={}){if(!r.firebase.ok)return;const n=r.firebase.api,o=r.firebase.db;await n.setDoc(n.doc(o,"powderProductions",e),{active:!1,closedAt:W(),...t},{merge:!0})}async function Sr(e){if(!r.firebase.ok)return;const t=r.firebase.api,n=r.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`;return await t.setDoc(t.doc(n,"powderProdHistory",o),{...e,id:o,at:W(),concludedAt:e.endedAt||W()}),o}async function nt(e){if(r.firebase.ok)try{const t=r.firebase.api,n=r.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`,i={id:o,actor:e.actor||r.user?.fullName||r.operator||"Operatore",actorUid:e.actorUid||r.user?.uid||"",actorEmail:e.actorEmail||r.user?.email||"",type:e.type||"altro",action:e.action||"Evento",description:e.description||"",meta:e.meta||"",customer:e.customer||"",orderNo:e.orderNo||"",actorIsAdmin:!!r.user?.isAdmin,ts:Date.now(),createdAt:t.serverTimestamp?t.serverTimestamp():W(),at:W(),extra:e.extra||{}};if(await t.setDoc(t.doc(n,Xn,o),i),r.actionLogs&&Array.isArray(r.actionLogs.entries)){const s=Date.now(),a={...i,ts:s};r.actionLogs.entries=[a,...r.actionLogs.entries].slice(0,eo),pe()}return i}catch(t){console.warn("addActionLog error",t)}}async function Ar(e,t=0){if(!r.firebase.ok)throw new Error("Firebase non disponibile");const n=r.firebase.api,o=r.firebase.db,s={id:`${Date.now()}`,message:e,createdAt:Date.now(),expiresAt:Number(t||0)};return await n.setDoc(an(n,o),s,{merge:!0}),s}async function Tr(){if(!r.firebase.ok)throw new Error("Firebase non disponibile");const e=r.firebase.api,t=r.firebase.db,o={id:`${Date.now()}`,message:"",clearedAt:Date.now(),expiresAt:0};return await e.setDoc(an(e,t),o,{merge:!0}),o}function wn(e,t){return e.doc(t,ut.col,ut.doc)}function Lr(e){try{const t=e&&typeof e.toDate=="function"?e.toDate():e?new Date(e):null;if(t&&Number.isFinite(t.getTime()))return re(t)}catch{}return"\u2014"}function _n(){if(!(globalThis.__allowCommitted instanceof Set)){const e=globalThis.__ALLOW_KEYS__ instanceof Set?globalThis.__ALLOW_KEYS__:new Set;globalThis.__allowCommitted=new Set(Array.from(e))}return globalThis.__allowCommitted}function Ae(){if(!(globalThis.__allowDraft instanceof Set)){const e=_n();globalThis.__allowDraft=new Set(Array.from(e))}return globalThis.__allowDraft}function Pe(){const e=Ae(),t=_n();let n=e.size!==t.size;if(!n){for(const o of e)if(!t.has(o)){n=!0;break}if(!n){for(const o of t)if(!e.has(o)){n=!0;break}}}r.mobileAllowDirty=n,globalThis.__allowDraftDirty=n}let Wo=null,Fe=null,fe=null;function Vo(){if(!r.powderOrders||!r.powderOrders.length){r.mobileAllowlist.pendingRender=!0;return}r.mobileAllowlist.pendingRender=!1,clearTimeout(Wo),Wo=setTimeout(()=>{Y()},100)}function Go(){r.mobileAllowlist?.pendingRender&&r.powderOrders&&r.powderOrders.length&&Vo()}let Cr=null;async function kr(){if(globalThis.__ALLOWLIST_LISTEN_STARTED__||!r.firebase.ok)return;const e=r.firebase.api,t=r.firebase.db;if(!(!e||!t)){globalThis.__ALLOWLIST_LISTEN_STARTED__=!0;try{const n=wn(e,t);Cr=e.onSnapshot(n,o=>{const i=o.exists()?o.data()||{}:{},s=Array.isArray(i.keys)?i.keys.filter(Boolean).map(String):[],a=new Set(s);globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set(s),globalThis.__allowCommitted=new Set(s),globalThis.__allowDraftDirty||(globalThis.__allowDraft=new Set(a)),globalThis.__ALLOW_META__={updatedAt:i.updatedAt||null,updatedBy:i.updatedBy||"",lastError:"",lastSyncTs:Date.now()},r.mobileAllowlist={ready:!0,keys:a,updatedAt:i.updatedAt||null,updatedBy:i.updatedBy||"",allowAll:!!i.allowAll&&o.exists(),docExists:o.exists(),error:"",lastError:"",lastSyncTs:Date.now(),pendingRender:!1},r.mobileAllowSelection=new Set(globalThis.__allowDraft),Pe(),r.mobileAllowSaveState="idle",Vo()},o=>{console.warn("allowlist snapshot error",o);const i=o?.code||"",s=o?.message||String(o);globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set,globalThis.__allowCommitted=new Set,globalThis.__allowDraftDirty||(globalThis.__allowDraft=new Set),globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:i?`${i}: ${s}`:s,lastSyncTs:Date.now()},r.mobileAllowlist.error=i||s,r.mobileAllowlist.lastError=i||s,r.mobileAllowlist.lastSyncTs=Date.now(),r.mobileAllowlist.ready=!0,r.mobileAllowlist.keys=new Set,r.mobileAllowlist.docExists=!1,r.mobileAllowlist.allowAll=!1,r.mobileAllowSelection=new Set,r.mobileAllowDirty=!1,r.mobileAllowSaveState="error",Y()})}catch(n){console.warn("allowlist listen failed",n);const o=n?.code||"",i=n?.message||String(n);globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set,globalThis.__allowCommitted=new Set,globalThis.__allowDraftDirty||(globalThis.__allowDraft=new Set),globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:o?`${o}: ${i}`:i,lastSyncTs:Date.now()},r.mobileAllowlist.error=o||i,r.mobileAllowlist.lastError=o||i,r.mobileAllowlist.lastSyncTs=Date.now(),r.mobileAllowlist.ready=!0,r.mobileAllowlist.keys=new Set,r.mobileAllowlist.docExists=!1,r.mobileAllowlist.allowAll=!1,r.mobileAllowSelection=new Set,r.mobileAllowDirty=!1,r.mobileAllowSaveState="error"}}}function jo(){if(fe){try{fe()}catch{}fe=null}r.actionLogs={entries:[],ready:!1,error:""}}function Er(){if(!r.firebase.ok||!(r.user&&r.user.isAdmin)){jo();return}if(fe)return;const e=r.firebase.api,t=r.firebase.db;if(!e||!t)return;const n=(o,i=!1)=>{try{const s=e.query(e.collection(t,Xn),e.orderBy(o,"desc"),e.limit(eo));r.actionLogs.ready=!1,r.actionLogs.error="",fe=e.onSnapshot(s,a=>{const d=[];a.forEach(f=>{const l=f.data()||{};let u=0;if(typeof l.ts=="number"&&Number.isFinite(l.ts)&&(u=l.ts),!u){const m=l.createdAt||l.at;try{const g=m&&typeof m.toDate=="function"?m.toDate():m?new Date(m):null;g&&Number.isFinite(g.getTime())&&(u=g.getTime())}catch{}u||(u=Date.now())}d.push({id:f.id,...l,ts:u})}),d.sort((f,l)=>(l.ts||0)-(f.ts||0)),r.actionLogs.entries=d,r.actionLogs.ready=!0,r.actionLogs.error="",pe()},a=>{if(console.warn("action log snapshot err",a),!i&&o!=="createdAt"){try{fe&&fe()}catch{}fe=null,n("createdAt",!0);return}r.actionLogs.error="Registro non disponibile",r.actionLogs.ready=!0,pe()})}catch(s){console.warn("ensureActionLogListener error",s),r.actionLogs.error="Registro non disponibile",r.actionLogs.ready=!0,pe()}};n("ts",!1)}function Nr(e={}){globalThis.__ALLOW_LOADED__=!0,globalThis.__ALLOW_KEYS__=new Set,globalThis.__allowCommitted=new Set,globalThis.__allowDraft=new Set,globalThis.__allowDraftDirty=!1,r.mobileAllowlist={...r.mobileAllowlist||{},ready:!0,keys:new Set,updatedAt:e.updatedAt||null,updatedBy:e.updatedBy||"",allowAll:!1,docExists:e.docExists!==!1,error:"",lastError:"",lastSyncTs:Date.now(),pendingRender:!1},r.mobileAllowSelection=new Set,r.mobileAllowDirty=!1,r.mobileAllowSaveState="idle",globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},updatedBy:e.updatedBy||"",lastError:"",lastSyncTs:Date.now()}}function xr(){if(r.mobileAllowReset?.status!=="saving"){if(r.mobileAllowReset?.confirm){Mr();return}r.mobileAllowReset={...r.mobileAllowReset||{},confirm:!0},Fe&&clearTimeout(Fe),me(se,oe),Fe=setTimeout(()=>{r.mobileAllowReset={...r.mobileAllowReset||{},confirm:!1},me(se,oe)},3e3)}}async function Mr(){if(!(r.user&&r.user.isAdmin)){r.mobileAllowReset={confirm:!1,status:"error",lastError:"permission-denied"},me(se,oe);return}if(!r.firebase.ok){r.mobileAllowReset={confirm:!1,status:"error",lastError:"firebase-offline"},me(se,oe);return}const e=r.firebase.api,t=r.firebase.db,n=wn(e,t);ao(),r.mobileAllowReset={confirm:!1,status:"saving",lastError:""},me(se,oe);try{await e.setDoc(n,{keys:[],updatedAt:e.serverTimestamp(),updatedBy:r.user.email||r.user.fullName||""},{merge:!0}),Nr({updatedBy:r.user.email||r.user.fullName||"",docExists:!0}),r.mobileAllowReset={confirm:!1,status:"success",lastError:""},Pe(),setTimeout(()=>Y(),100)}catch(o){console.warn("reset allowlist error",o);const i=o?.code||"",s=o?.message||String(o),a=i||s;r.mobileAllowReset={confirm:!1,status:"error",lastError:a||"errore"}}Fe&&(clearTimeout(Fe),Fe=null),me(se,oe)}async function Or(){if(!(r.user&&r.user.isAdmin)){C("Solo admin","Non hai i permessi per inviare ordini al mobile.");return}if(!r.firebase.ok){C("Connessione mancante","Firebase non disponibile.");return}const e=r.firebase.api,t=r.firebase.db,n=wn(e,t),o=Array.from(Ae());r.mobileAllowSaveState="saving",Y();try{await e.setDoc(n,{keys:o,updatedAt:e.serverTimestamp(),updatedBy:r.user.email||r.user.fullName||""},{merge:!0}),r.mobileAllowSaveState="idle",r.mobileAllowDirty=!1,r.mobileAllowlist.error="",r.mobileAllowlist.lastError="",r.mobileAllowlist.keys=new Set(o),r.mobileAllowSelection=new Set(o),globalThis.__allowCommitted=new Set(o),globalThis.__ALLOW_KEYS__=new Set(o),globalThis.__allowDraft=new Set(o),globalThis.__allowDraftDirty=!1,globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:""},C("Salvato \u2705","Ordini inviati a mobile aggiornati.")}catch(i){console.warn("save allowlist error",i),r.mobileAllowSaveState="error";const s=i?.code||"",a=i?.message||String(i),d=s?`${s}`:a;r.mobileAllowlist.error=d,r.mobileAllowlist.lastError=d,globalThis.__ALLOW_META__={...globalThis.__ALLOW_META__||{},lastError:d},C("Salvataggio bloccato",`${d||"Errore sconosciuto"}. Controlla le regole Firestore.`)}Y()}async function $r(){if(!(!r.firebase.ok||!(r.user&&r.user.isAdmin))&&confirm("Eliminare tutti gli ordini conclusi?")&&confirm("Conferma finale: l\u2019operazione \xE8 irreversibile."))try{const e=r.firebase.api,t=r.firebase.db,n=await e.getDocs(e.collection(t,"powderProdHistory"));for(const o of n.docs)await e.deleteDoc(o.ref);r.history=[],r.historyReady=!0,rt(),Mt(),Le(),C("Cancellati","Ordini conclusi rimossi.")}catch(e){console.warn(e),C("Errore","Impossibile cancellare i conclusi.")}}async function ll(e){if(!r.firebase.ok)return;const t=r.firebase.api,n=r.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`;await t.setDoc(t.doc(n,"powderProdAborts",o),{...e,id:o,at:W()})}async function Sn(e){if(!r.firebase.ok)return;const t=r.firebase.api,n=r.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`;await t.setDoc(t.doc(n,"powderProdIssues",o),{...e,id:o,at:W()});try{await nt({type:"issue",action:"Segnalazione problema",description:e?.text||e?.message||"Segnalazione registrata",customer:e?.customer||"",orderNo:e?.orderNo||"",meta:e?.kind||""})}catch{}if(ts&&Yn)try{const i=`Segnalazione Hub Polveri \xB7 Ordine ${e?.orderNo||""}`.trim(),s=["Nuova segnalazione dal Hub Linea Polveri",`Cliente: ${e?.customer||""}`,`Ordine: ${e?.orderNo||""}`,`Operatore: ${r.user?.fullName||""}`,`Dettagli: ${e?.text||e?.message||""}`].join(`
`);await t.setDoc(t.doc(n,"email",o),{to:Yn,message:{subject:i,text:s}})}catch(i){console.warn("email issue failed",i)}}const Yo=!0,St="https://geminitts-zxiqbo2osa-ew.a.run.app",Zo="Kore",At="it-IT";let Te=null;globalThis.__ttsLastMode="none",globalThis.__ttsLastError="";async function ot(){}let j=null,Tt=null,An=null;function Dr(){try{Tt&&Tt.abort()}catch{}Tt=null;try{j&&(j.pause(),j.src="",j.load())}catch{}}function Qo(e){An||(An=setTimeout(()=>{An=null;try{Lt(e)}catch{}},360))}function Br(){try{const e=s=>window.matchMedia&&window.matchMedia(s).matches,t=e("(pointer: fine)")&&e("(hover: hover)"),n=Math.max(window.innerWidth||0,document.documentElement.clientWidth||0)>=900,o=(navigator.userAgent||"").toLowerCase(),i=/android|iphone|ipod|ipad|iemobile|mobile|tablet/.test(o);return t&&n&&!i}catch{return!1}}function it(){try{if(!("speechSynthesis"in window))return null;const e=window.speechSynthesis.getVoices()||[];if(!e.length)return null;const t=i=>String(i||"").toLowerCase(),n=i=>t(i.lang).startsWith("it"),o=i=>t(i.name).includes("google");return e.find(i=>n(i)&&o(i))||e.find(i=>n(i))||e.find(i=>o(i))||e[0]}catch{return null}}function Ir(){Te||(Te=it())}if("speechSynthesis"in window){try{Te=it()}catch{}try{window.speechSynthesis.onvoiceschanged=()=>{try{Te=it()}catch{}}}catch{}setTimeout(()=>{try{Te=it()}catch{}},0)}function Pr(){return Yo&&typeof St=="string"&&St.trim().length>0}function Fr(e){const t=atob(String(e||"")),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o)&255;return n}async function Rr(e){j||(j=new Audio,j.preload="auto");const t=new Blob([e],{type:"audio/wav"}),n=URL.createObjectURL(t);return j.src=n,new Promise((o,i)=>{const s=()=>{try{URL.revokeObjectURL(n)}catch{}try{j.onended=null,j.onerror=null}catch{}};j.onended=()=>{s(),o()},j.onerror=()=>{s(),i(new Error("Audio playback error"))};try{const a=j.play();a&&typeof a.then=="function"&&a.then(()=>{}).catch(d=>{s(),i(d)})}catch(a){s(),i(a)}})}async function zr(e){const t=new AbortController;Tt=t;const n={text:String(e||""),lang:At,voice:Zo,style:"chiaro, professionale, tono aziendale"},o=await fetch(St.trim(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),signal:t.signal,mode:"cors",cache:"no-store",credentials:"omit"});if(!o.ok){const a=await o.text().catch(()=>"");throw new Error(`Proxy TTS HTTP ${o.status}${a?` \xB7 ${a.slice(0,180)}`:""}`)}const i=(o.headers.get("content-type")||"").toLowerCase();let s=null;if(i.includes("application/json")){const a=await o.json(),d=a.audioB64||a.audio||a.data||"";if(!d)throw new Error("Proxy TTS: audio mancante (JSON).");s=Fr(d).buffer}else s=await o.arrayBuffer();await Rr(s)}async function Lt(e){if(!Br()){globalThis.__ttsLastMode="disabled",globalThis.__ttsLastError="";return}const t=String(e||"").trim();if(!t){globalThis.__ttsLastMode="none",globalThis.__ttsLastError="";return}const n=t.length>520?t.slice(0,520).trim()+"\u2026":t;globalThis.__ttsLastError="";try{await ot("start")}catch{}try{Dr()}catch{}try{"speechSynthesis"in window&&window.speechSynthesis.cancel()}catch{}if(Pr()){globalThis.__ttsLastMode="gemini";try{const o=`Leggi ESATTAMENTE (senza cambiare parole) in italiano (${At}), tono chiaro e professionale, il seguente testo:
${n}`;await zr(o);try{await ot("end")}catch{}return}catch(o){globalThis.__ttsLastError=o&&o.message?String(o.message):String(o||""),console.log("TTS (Gemini proxy) error:",o);const i=globalThis.__ttsLastError||"";if(/notallowed|not-allowed|gesture|autoplay/i.test(i)){Qo(n);return}}}try{if(!("speechSynthesis"in window)){globalThis.__ttsLastMode="none";return}Ir(),globalThis.__ttsLastMode="webspeech";const o=new SpeechSynthesisUtterance(n);o.lang=At,o.rate=.92,o.pitch=.9,Te&&(o.voice=Te),o.onend=()=>{try{ot("end")}catch{}},o.onerror=i=>{try{ot("end")}catch{}const s=i&&i.error?String(i.error):"";/not-allowed|gesture|autoplay/i.test(s)&&Qo(n)},window.speechSynthesis.speak(o)}catch(o){globalThis.__ttsLastMode=globalThis.__ttsLastMode||"webspeech",globalThis.__ttsLastError=o&&o.message?String(o.message):String(o||""),console.log("TTS (WebSpeech) error:",o);try{ot("end")}catch{}}}globalThis.speak=Lt,globalThis._pickGoogleVoice=it,globalThis.__geminiTts={enabled:Yo,proxyUrl:St,voice:Zo,lang:At};function Jo(e){const t=e.startedAt?new Date(e.startedAt).getTime():null;if(!t)return 0;const n=Date.now()-t,o=Number(e.totalKg||0),i=Math.max(1,o/500*3600*1e3);return n/i}function Re(){const e=r.powderOrders||[],t=r.history||[],n=new Map;for(const s of t){if(!s||!s.orderNo)continue;const a=String(s.orderNo),d=Array.isArray(s.concludedLineKeys)?s.concludedLineKeys:[];n.has(a)||n.set(a,new Set);const f=n.get(a);for(const l of d)l&&f.add(String(l))}const o=[],i=[];for(const s of e){const a=String(s.orderNo||s.number||"");if(!a)continue;let d=0;const f=[];for(const b of s.lines||[]){if(dn(b)){d++;continue}const v=String(b.lineKey||"");v&&f.push(v)}const l=f.length+d;if(l<=0)continue;const u=n.get(a)||new Set;let m=0;for(const b of f)u.has(b)&&m++;const g=m+d,p=l-g;m>0&&p>0?o.push({orderNo:a,customer:s.customer||"",done:g,total:l}):g>0&&p<=0&&i.push({orderNo:a,customer:s.customer||"",done:g,total:l})}return{partial:o,full:i}}function Xo(e){try{return U(String(e||"")).replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"").trim()}catch{return String(e||"").toLowerCase().trim().replace(/\s+/g,"")}}function ei(e,t){const n=Xo(e),o=Xo(t);if(!n||!o)return!1;if(n===o||n.startsWith(o)||o.startsWith(n))return!0;const i=n.split("").filter(Boolean),s=o.split("").filter(Boolean),a=i.length<=s.length?i:s,d=i.length<=s.length?s:i,f=new Set(d);for(const l of a)if(l&&!f.has(l))return!1;return a.length>0}function Kr(){const e=r.activeProductions||[],t=r.user?.fullName||r.operator||"";t&&e.some(o=>ei(o.operator||o.operatorName||"",t))?Bn():Si()}function ze(e={}){const t=e.applyRoleVisibility!==!1,n=e.includeHidden===!0,o=new Set;for(const h of r.history||[])if(!(!h||!Array.isArray(h.concludedLineKeys)))for(const A of h.concludedLineKeys)A&&o.add(String(A));const i=new Map;for(const h of r.activeProductions||[]){const A=Array.isArray(h.selectedLineKeys)?h.selectedLineKeys:[];for(const L of A)L&&i.set(String(L),h)}const s=new Map,a=new Map;try{const{partial:h,full:A}=Re();h.forEach(L=>s.set(String(L.orderNo),L)),A.forEach(L=>a.set(String(L.orderNo),L))}catch{}const d=window.matchMedia("(min-width: 980px)").matches,f=!!(r.user&&r.user.isAdmin),l=R(),u=r.mobileAllowlist||{},m=globalThis.__ALLOW_KEYS__ instanceof Set?globalThis.__ALLOW_KEYS__:new Set,g=!!globalThis.__ALLOW_LOADED__,p=!!(!f&&l&&g),y=!!(!f&&l&&!g),b=r.user?.fullName||r.operator||"",v=[],S=[],w=new Set;for(const h of r.powderOrders||[]){const A=h.orderNo||h.number||"",L=ta(h),k=na(L);let T=0;const E=(h.lines||[]).map(M=>{if(dn(M))return T++,null;const Z=String(M.lineKey||""),F=i.get(Z)||null,I=o.has(Z)?"done":F?"active":"idle",ie=F?.operator||F?.operatorName||"",Ce=!!(F&&ei(ie,b));return{...M,status:I,activeProd:F,activeOp:ie,activeIsMe:Ce,conclusion:M.conclusion||h.conclusion||""}}).filter(Boolean).filter(M=>M.status!=="done"),N=Array.isArray(h.alerts)?h.alerts:[];if(!E.length&&(T>0||!N.length))continue;const O=k.date||ci(L),P=O?di(O):null,B=we(h),z={...h,orderNo:A,lines:E,alerts:N,autoDone:T,totalLines:E.length+T,partialInfo:s.get(String(A))||null,isCompleted:a.has(String(A)),note:L,priorityInfo:k,planDate:O,daysAway:P};z.__k=B,z.stableKey=B,S.push(z),w.add(B);let $=!0;t&&(d?f?$=!0:$=!!!(O&&P!=null&&P>3):$=k.visible!==!1),$&&p?$=m.has(B):y&&($=!1),!(!$&&!n)&&v.push(z)}return{orders:v,baseOrders:S,concluded:o,activeMap:i,partialMap:s,fullMap:a,orderKeySet:w,allowKeySet:m}}function Tn(e){const t=i=>{if(i==null)return null;const s=String(i).replace(/,/g,".").trim();if(!s)return null;const a=parseFloat(s);return Oe(a)},n=[e?.packKg,e?.packkg,e?.formatoKg,e?.formato,e?.sizeKg,e?.size,e?.pack,e?.packaging,e?.packSize,e?.formatoConfezione];for(const i of n){const s=t(i);if(s!=null)return s}const o=[e?.packKgLabel,e?.formatoLabel,e?.desc,e?.prodotto,e?.product,e?.note,e?.variant,e?.variante,`${e?.desc||""} ${e?.um||""}`];for(const i of o){const s=_e(i||"");if(s!=null)return s}return null}function cl(e){const t=U(e||"");return t==="kg"||/\bkg\b/.test(t)}function dl(e){const t=U(e||"");return/\b(sac|sacco|sacchi|sacchetto|sacchetti)\b/.test(t)||/\b(pz|pez|pezzi|pezzo)\b/.test(t)}function ti(e){if(!e)return 0;const t=Tn(e),n=yt({qty:e.qty,um:e.um,uom:e.uom,unitaMisura:e.unitaMisura,unit:e.unit,measure:e.measure,packKg:t,desc:e.desc||""});if(Number.isFinite(n)&&n>0)return n;const o=Number(e.lineKg);return Number.isFinite(o)&&o>0?o:0}function Hr(e){const t=[];for(const v of e||[])for(const S of v.lines||[])t.push(S);let n=0,o=0,i=0,s=0,a=0,d=0;const f=[];for(const v of t){const S=ti(v);Number.isFinite(S)&&(n+=S);const w=Tn(v);if(Number.isFinite(S)&&S>0){const h=Oe(w,{strict:!0});h===.5?o+=S:h===1?i+=S:h===5?s+=S:h===10?a+=S:d+=S}f.length<5&&f.push({rawQty:v.qty,parsedQty:po(v.qty)})}const l=o+i,u=s+a,m=Math.round(l*10),g=Math.round(u*4),p=Math.ceil(m/25e3),y=Math.ceil(g/4e4),b={kg0_5:o,kg1:i,kg5:s,kg10:a,kgTotF480:l,kgTotF830:u,kgUnknown:d,filmF480Gr:m,filmF830Gr:g,bobineF480:p,bobineF830:y};return{totalKg:n,lineCount:t.length,samples:f,labels:null,bobine:b}}function Q(){return{customer:"",order:"",item:""}}function Ln(e){const t=e||{},n=t.orderNo||t.number||t.docNumber||t.codiceOrdine||t.id||t.orderId||t.numero||"";return String(n||"").trim()}function ni(e){return K(Ln(e))}function Ur(e){const t=Ln(e)||"Ordine senza numero",n=e?.customer||e?.cliente||e?.customerName||e?.ragioneSociale||"";return n?`${t} \xB7 ${n}`:t}function qr(){try{const e=localStorage.getItem(oo),t=e?JSON.parse(e):{},n=t&&typeof t=="object"&&t.orderQuery&&!t.order?{order:t.orderQuery}:{};return{...Q(),...t&&typeof t=="object"?t:{},...n}}catch{return Q()}}function oi(e){try{localStorage.setItem(oo,JSON.stringify(e||Q()))}catch{}}function Ct(e){r.magFilters={...Q(),...r.magFilters||{},...e||{}},oi(r.magFilters)}function Wr(){r.magFilters=Q(),oi(r.magFilters)}function ii(e){const t=[],n=s=>{if(s==null)return;const a=String(s).trim();a&&t.push(a)},o=e?.order||{};for(const s of o.lines||[])n(s.imballaggio),n(s.imballo),n(s.articolo),n(s.item),n(s.imballaggi),n(s.desc),n(s.code);const i=e?.comp||{};return Number(i.productKg)&&n("Prodotto da completare"),i?.bobine?.forEach?.((s,a)=>n(a)),Number(i.etichette)&&n("Etichette"),i?.scatole?.forEach?.((s,a)=>n(a)),i?.divisori?.forEach?.((s,a)=>n(a)),i?.altri?.forEach?.((s,a)=>n(a)),(i.nonConfig||[]).length&&n("Non configurati"),t}function kt(e){const t=new Map,n=new Map,o=new Map,i=(f,l)=>{const u=K(l);!u||f.has(u)||f.set(u,String(l).trim())},s=f=>{const l=ni(f);if(!l||o.has(l))return;const u=Ln(f),m=Ur(f);o.set(l,{value:u,label:m})};for(const f of e||[]){const l=f?.order||{},u=l.customer||l.cliente||l.customerName||l.ragioneSociale||"";i(t,u),s(l);const m=ii(f);for(const g of m)i(n,g)}const a=f=>Array.from(f.values()).sort((l,u)=>l.localeCompare(u,"it",{sensitivity:"base"})),d=Array.from(o.values()).sort((f,l)=>String(f.value||"").localeCompare(String(l.value||""),"it",{numeric:!0,sensitivity:"base"}));return{customers:a(t),items:a(n),orders:d}}function Vr(e){const t=new Set;for(const n of ii(e)){const o=K(n);o&&t.add(o)}return t}function Gr(e){const t={productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[]};t.linesTotal=0,t.linesOk=0,t.linesWarn=0,t.linesNonConfig=0;for(const{comp:n}of e||[]){const o=n||{};t.linesTotal+=Number(o.linesTotal||0),t.linesOk+=Number(o.linesOk||0),t.linesWarn+=Number(o.linesWarn||0),t.linesNonConfig+=Number(o.linesNonConfig||0),t.productKg+=Number(o.productKg||0),o?.bobine?.forEach?.((i,s)=>J(t.bobine,s,i)),t.etichette+=Number(o.etichette||0),o?.scatole?.forEach?.((i,s)=>J(t.scatole,s,i)),o?.divisori?.forEach?.((i,s)=>J(t.divisori,s,i)),o?.altri?.forEach?.((i,s)=>J(t.altri,s,i)),Array.isArray(o.nonConfig)&&t.nonConfig.push(...o.nonConfig),Array.isArray(o.warnings)&&t.warnings.push(...o.warnings)}return t}function st(e,t){const n=Array.isArray(e)?e:[],o={...Q(),...t||{}},i=K(o.customer),s=K(o.order),a=K(o.item),d=[];for(const l of n){const u=l?.order||{},m=u.customer||u.cliente||u.customerName||u.ragioneSociale||"",g=K(m);if(!(i&&g!==i&&!g.includes(i))){if(s){const p=ni(u);if(!p||p!==s)continue}if(a){const p=Vr(l);let y=!1;for(const b of p)if(b===a||b.includes(a)){y=!0;break}if(!y)continue}d.push(l)}}const f=Gr(d);return{filteredOrders:d,filteredTotals:f,applied:o}}function jr(e,t){if(!e)return;const n=[],o={...Q(),...t||{}},i=(s,a,d)=>{d&&n.push(`<button class="magChip" data-key="${s}" type="button">${_(a)}: ${_(d)} <span class="x" aria-hidden="true">\xD7</span></button>`)};i("customer","Cliente",o.customer),i("order","Ordine",o.order),i("item","Articolo",o.item),e.innerHTML=n.join(""),e.style.display=n.length?"flex":"none",n.length&&e.querySelectorAll(".magChip").forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.key;a&&(Ct({[a]:""}),ge())})})}function Yr(){const{orders:e}=ze(),t={productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[]};t.linesTotal=0,t.linesOk=0,t.linesWarn=0,t.linesNonConfig=0;const n=[];for(const o of e){const i={productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[]};i.linesTotal=0,i.linesOk=0,i.linesWarn=0,i.linesNonConfig=0;const s=o.lines.some(a=>a.status==="active")?"in_produzione":o.partialInfo?"parziale":"da_fare";for(const a of o.lines||[]){const d=ia(a),f=Number.isFinite(d)&&d>0;f&&(i.linesTotal++,t.linesTotal++),f&&(i.productKg+=d,t.productKg+=d);const l=ui(a),{bom:u,source:m}=sa(a,l)||{},g=m==="pack_unsupported";if(!l||l<=0||!u){const b=g?"Non configurato (packKg non supportato)":"",v={desc:a.desc,customer:o.customer,orderNo:o.orderNo||o.number,qtyKg:d,packKg:l,code:a.code||"",note:b};f&&(i.linesNonConfig++,t.linesNonConfig++),i.nonConfig.push(v),t.nonConfig.push(v);continue}const p=Number(l)?d/l:0;let y=!1;if(!Number.isFinite(p)||p<=0){const b={desc:a.desc,customer:o.customer,orderNo:o.orderNo||o.number,qtyKg:d,packKg:l,code:a.code||""};f&&(i.linesNonConfig++,t.linesNonConfig++),i.nonConfig.push(b),t.nonConfig.push(b);continue}if(Math.abs(p-Math.round(p))>.01){y=!0,f&&(i.linesWarn++,t.linesWarn++);const b=`${a.desc} \xB7 ${p.toFixed(2)} sacchi da ${l} kg`;i.warnings.push(b),t.warnings.push(b)}if(f&&!y&&(i.linesOk++,t.linesOk++),u.bobine)for(const[b,v]of Object.entries(u.bobine)){const S=Number(v&&v.perBag!=null?v.perBag:v)||0,h=(v&&v.unit||"g")==="kg"?S*1e3:S;J(i.bobine,b,h*p),J(t.bobine,b,h*p)}if(Number(u.etichettePerBag)){const b=Number(u.etichettePerBag||0)*p;i.etichette+=b,t.etichette+=b}if(u.scatole)for(const[b,v]of Object.entries(u.scatole)){const S=Number(v||0)*p;J(i.scatole,b,S),J(t.scatole,b,S)}if(u.divisori)for(const[b,v]of Object.entries(u.divisori)){const S=Number(v||0)*p;J(i.divisori,b,S),J(t.divisori,b,S)}if(u.altri)for(const[b,v]of Object.entries(u.altri)){const S=Number(v||0)*p;J(i.altri,b,S),J(t.altri,b,S)}}n.push({order:o,comp:i,status:s})}return{totals:t,orderDetails:n}}const Cn="__wh_all__";function Zr(e){const t=new Map,n=(o,i)=>{if(!o)return;const s=t.get(o)||[];s.push(i),t.set(o,s)};for(const{order:o,comp:i}of e||[]){const s=`${o.customer||"Cliente"} \xB7 Ord. ${o.orderNo||o.number||"\u2014"}`,a=o.conclusion?`Conclusione: ${o.conclusion}`:"",d=i?.warnings?.length?`Attenzione sacchi: ${i.warnings.length}`:"",f=[a,d].filter(Boolean).join(" \xB7");i.productKg&&n("productKg|Prodotti da completare",{orderLabel:s,qty:i.productKg,unit:"kg",desc:f}),i?.bobine?.forEach?.((l,u)=>{n(`bobine|${u}`,{orderLabel:s,qty:l,unit:"g",desc:f})}),Number(i?.etichette)&&n("etichette|Etichette",{orderLabel:s,qty:i.etichette,unit:"pz",desc:f}),i?.scatole?.forEach?.((l,u)=>{n(`scatole|${u}`,{orderLabel:s,qty:l,unit:"pz",desc:f})}),i?.divisori?.forEach?.((l,u)=>{n(`divisori|${u}`,{orderLabel:s,qty:l,unit:"pz",desc:f})}),i?.altri?.forEach?.((l,u)=>{n(`altri|${u}`,{orderLabel:s,qty:l,unit:"pz",desc:f})});for(const l of i?.nonConfig||[]){const u=`${l.desc||"Prodotto"}${l.packKg?` \xB7 ${l.packKg} kg`:""}${l.note?` \xB7 ${l.note}`:""}`;n("nonconfig|Non configurati",{orderLabel:s,qty:l.qtyKg||0,unit:"kg",desc:u})}}return t}function si(e){const t=[],n=(o,i,s,a,d={})=>{const f=Number(s||0);if(!Number.isFinite(f)||f<=0)return;const l=a==="g"?f/1e3:f;t.push({key:o,label:i,qty:f,unit:a||"",type:d.type||"",subtitle:d.subtitle||"",sortVal:l})};return n("productKg|Prodotti da completare","Prodotto da completare",e.productKg,"kg",{type:"product",subtitle:"Kg totali residui"}),e.bobine.forEach((o,i)=>n(`bobine|${i}`,i,o,"g",{type:"bobine",subtitle:"Bobine"})),n("etichette|Etichette","Etichette",e.etichette,"pz",{type:"etichette",subtitle:"Etichette totali"}),e.scatole.forEach((o,i)=>n(`scatole|${i}`,i,o,"pz",{type:"scatole",subtitle:"Scatole"})),e.divisori.forEach((o,i)=>n(`divisori|${i}`,i,o,"pz",{type:"divisori",subtitle:"Divisori"})),e.altri.forEach((o,i)=>n(`altri|${i}`,i,o,"pz",{type:"altri",subtitle:"Altri componenti"})),e.nonConfig.length&&n("nonconfig|Non configurati","Non configurati",e.nonConfig.length,"pz",{type:"warning",subtitle:"Distinte non configurate"}),t.sort((o,i)=>(i.sortVal||0)-(o.sortVal||0))}function ri(e){if(!e)return"\u2014";if(e.unit==="kg")return fi(e.qty);if(e.unit==="g"){const n=e.qty/1e3;return n>=1?fi(n):ra(e.qty)}const t=aa(e.qty);return e.unit?`${t} ${e.unit}`:t}function Qr(e,t){return ri({unit:e||"",qty:t})}const ai={"prodotto da completare":"Somma kg di tutti gli ordini non conclusi","kg totali residui":"Kg residui = kg da produrre \u2212 kg gi\xE0 prodotti","etichette totali":"Pezzi stimati = numero sacchi totali (1 etichetta per sacco)","scatola americana":"Pezzi stimati = kg \xF7 20","divisorio croce texo":"Pezzi stimati = sacchi per scatola (1 divisorio per scatola)","divisorio z":"Pezzi stimati = sacchi per scatola (1 divisorio per scatola)","bobina blu f480":"Stima bobine = etichette \xF7 resa bobina (F480)","bobina f830":"Stima bobine = etichette \xF7 resa bobina (F830)"};function Jr(e){return String(e||"").toLowerCase().replace(/\s+/g,"").trim()}function Xr(e){const n=String(e||"").split("|")[0];return Jr(n)}function li(e,t){if(t&&t.calcHint)return String(t.calcHint);const n=Xr(e);return ai[n]?ai[n]:""}function Et(e,t){const n=r.mobileAllowlist||{},o=_n(),i=Ae(),s=t instanceof Set?t:new Set((e||[]).map(T=>T?.__k||we(T)));let a=0;for(const T of o)s.has(T)&&a++;const d=Array.isArray(e)?e.length:0,f=o.size,l=Lr(n.updatedAt),u=o.size,m=n.ready&&!n.docExists,g=n.ready?m?"Nessuna assegnazione salvata: filtro vuoto.":n.allowAll?"Filtro disattivo: salva per limitare gli ordini.":`Aggiornato ${l}${n.updatedBy?` \xB7 ${n.updatedBy}`:""} \xB7 ${u} ordini live`:"Sincronizzazione in corso\u2026",p=n.lastError||n.error||(globalThis.__ALLOW_META__||{}).lastError||"",y=c("mobileAllowUpdatedBy");y&&(y.textContent=n.updatedBy?`Ultimo invio: ${n.updatedBy}`:"In attesa di primo invio");const b=c("mobileAllowUpdate");b&&(b.textContent=g);const v=c("mobileAllowTotal");v&&(v.textContent=String(d));const S=c("mobileAllowSent");S&&(S.textContent=String(f));const w=c("mobileAllowMatch");w&&(w.textContent=String(a)),Pe();const h=c("mobileAllowStatus"),A=c("mobileAllowFeedback"),L=r.mobileAllowSaveState,k=!!p;if(h&&(h.className="statusBadge",n.ready?L==="saving"?(h.textContent="Salvataggio\u2026",h.classList.add("live")):L==="error"||k?(h.textContent="Errore",h.classList.add("error")):m?h.textContent="Vuoto":n.allowAll?h.textContent="Filtro off":r.mobileAllowDirty?h.textContent="Da salvare":(h.textContent="Salvato",h.classList.add("live")):h.textContent="Sync\u2026"),A)if(A.className="saveBadge",!n.ready)A.textContent="Stato: caricamento allowlist\u2026";else if(L==="saving")A.textContent="Salvataggio in corso\u2026";else if(L==="error"||k)A.classList.add("error"),A.textContent=`Salvataggio non consentito${p?` \xB7 ${p}`:""}`;else if(r.mobileAllowDirty)A.textContent="Modifiche locali non salvate.";else if(m)A.textContent="Assegnazioni vuote: nessun ordine inviato.";else{A.classList.add("live");const T=n.allowAll?"Filtro disattivo.":"Filtro attivo.";A.textContent=`${T} Match: ${a}/${d}`}}function kn(e,t){const n=c("mobileSendList"),o=Array.isArray(e)?e:[],i=U(t||""),s=i?o.filter(f=>{const l=`${f.customer||""} ${f.orderNo||f.number||""} ${f.conclusion||""} ${f.lines&&f.lines[0]?.desc||""}`;return U(l).includes(i)}):o;if(!n)return{filteredOrders:s,total:o.length};if(n.innerHTML="",!s.length)return n.innerHTML='<div class="muted">Nessun ordine trovato.</div>',{filteredOrders:[],total:o.length};const a=Ae(),d=document.createDocumentFragment();for(const f of s){const l=f.__k||f.stableKey||we(f),u=a.has(l),m=f.lines&&f.lines[0]||{},g=ht(m.qty,m.um),p=document.createElement("div");p.className="mobileSendRow",u&&p.classList.add("selected"),p.dataset.k=l,p.innerHTML=`
        <div class="info">
          <div class="name">${_(f.customer||"Cliente")} \xB7 Ord. ${_(f.orderNo||f.number||"\u2014")}</div>
          <div class="meta">${_(m.desc||"Prodotto")} \xB7 ${_(g)}${f.conclusion?` \xB7 Consegna: ${_(f.conclusion)}`:""}</div>
        </div>
        <div class="mobileSendToggle" role="switch" aria-checked="${u?"true":"false"}">
          <div class="knob"></div>
        </div>`,d.appendChild(p)}return n.appendChild(d),{filteredOrders:s,total:o.length}}function me(e=se,t=oe){const n=c("mobileSendCard"),o=!!(r.user&&r.user.isAdmin),i=R();if(!n||(n.style.display=o?"block":"none",n.classList.toggle("isMobileAdmin",!!(o&&i)),n.classList.toggle("isDesktopAdmin",!!(o&&!i)),!o))return;const s=Array.isArray(e)?e:se||[],a=t instanceof Set?t:oe instanceof Set?oe:new Set((s||[]).map(w=>w?.__k||we(w)));se=Array.isArray(s)?[...s]:[],oe=new Set(a),Et(s,a);const d=r.mobileAllowSaveState,f=r.mobileAllowReset||{},l=!!f.confirm,u=c("mobileAllowSearch");u&&(u.value!==(r.mobileAllowSearchTerm||"")&&(u.value=r.mobileAllowSearchTerm||""),u.oninput=w=>{r.mobileAllowSearchTerm=w.target.value||"",me(s,a)});const m=c("mobileSendList"),{filteredOrders:g}=kn(s,r.mobileAllowSearchTerm||"");m&&(m.__filteredOrders=g,m.__allOrders=s,m.__orderKeySet=a),m&&(m.dataset.bound||(m.dataset.bound="1",m.addEventListener("click",w=>{if(w.target.closest("#mobileSendCard")&&(w.preventDefault(),w.stopPropagation()),w.target.closest("input")||w.target.closest("button")||w.target.closest("textarea"))return;const h=w.target.closest(".mobileSendRow");if(!h)return;const A=h.dataset.k;if(!A)return;w.preventDefault(),w.stopPropagation();const L=Ae(),k=!L.has(A);k?L.add(A):L.delete(A),Pe(),h.classList.toggle("selected",k);const T=h.querySelector(".mobileSendToggle");T&&T.setAttribute("aria-checked",k?"true":"false"),Et(m.__allOrders||s,m.__orderKeySet||a)})));const p=c("btnAllowSelectAll");p&&(p.onclick=()=>{const w=Ae(),h=m&&Array.isArray(m.__filteredOrders)?m.__filteredOrders:g;for(const L of h)w.add(L.__k||L.stableKey||we(L));Pe();const A=kn(m?.__allOrders||s,r.mobileAllowSearchTerm||"");m&&(m.__filteredOrders=A.filteredOrders),Et(m?.__allOrders||s,m?.__orderKeySet||a)});const y=c("btnAllowClear");y&&(y.onclick=()=>{const w=Ae(),h=m&&Array.isArray(m.__filteredOrders)?m.__filteredOrders:g;for(const L of h)w.delete(L.__k||L.stableKey||we(L));Pe();const A=kn(m?.__allOrders||s,r.mobileAllowSearchTerm||"");m&&(m.__filteredOrders=A.filteredOrders),Et(m?.__allOrders||s,m?.__orderKeySet||a)});const b=c("btnSaveMobileAllow");b&&(b.disabled=d==="saving",b.onclick=()=>Or());const v=c("btnResetMobileAllow");if(v){const w=f.status==="saving";v.textContent=l?"Conferma reset":"Reset invio mobile",v.disabled=w,v.dataset.bound||(v.dataset.bound="1",v.onclick=()=>xr())}const S=c("mobileAllowResetStatus");if(S){S.className="saveBadge";const w=f.status||"idle";if(w==="success")S.classList.add("live"),S.textContent="Reset completato \u2705";else if(w==="error"){S.classList.add("error");const h=f.lastError||"";S.textContent=`Reset non consentito${h?` (${h})`:""}`}else w==="saving"?S.textContent="Reset in corso\u2026":S.textContent=l?"Premi ancora per confermare":"Pronto al reset"}}function En(e){let t=0,n=!1;for(const o of e||[]){const i=o?.totalDoc,s=Number.isFinite(i)?Number(i):je(i);Number.isFinite(s)&&(t+=s,n=!0)}return n?t:null}function ea(){try{if(r.fatturatoLordo!=null&&Number.isFinite(r.fatturatoLordo))return r.fatturatoLordo;if(r.fatturatoLordo==null&&r.docs&&r.docs.length){const n=En(r.docs);if(n!=null)return r.fatturatoLordo=n,n}const e=c("fatValue");if(e&&e.dataset&&e.dataset.value){const n=je(e.dataset.value);if(n!=null)return n}const t=je(localStorage.getItem(Zn));if(t!=null)return t}catch{}return null}function Nt(){const e=c("fatValue"),t=c("fatSubtitle");if(!e)return;const n=!!(r.user&&r.user.isAdmin),o=window.matchMedia("(min-width: 980px)").matches,i=n||o,s=ea(),a=Number.isFinite(s)?Number(s):je(s);if(r.fatturatoLordo=a,a!=null){e.dataset.value=String(a);try{localStorage.setItem(Zn,String(a))}catch{}}else delete e.dataset.value;const d=a!=null?new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(a):"Dati non disponibili";i?(e.classList.add("reveal"),e.classList.remove("blur"),e.textContent=d,t&&(t.textContent=n?"Fatturato lordo visibile agli amministratori ovunque.":"Fatturato lordo visibile su schermi larghi.")):(e.classList.add("blur"),e.classList.contains("reveal")?e.textContent=d:e.textContent="\u20AC \u2014",t&&(t.textContent="Tocca per mettere a fuoco il fatturato lordo."))}function ta(e){try{const t=localStorage.getItem("ORDER_NOTE_OVERRIDES")||"";if(t){const n=JSON.parse(t),o=e.orderNo||e.number||"";if(o&&n&&n[o])return n[o]}}catch{}return e.note||e.comment||e.internalNote||""}function ci(e){const t=U(e||"");if(!t)return null;const n={gennaio:0,febbraio:1,marzo:2,aprile:3,maggio:4,giugno:5,luglio:6,agosto:7,settembre:8,ottobre:9,novembre:10,dicembre:11};let o=t.match(/(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)(?:\s+(\d{4}))?/);if(o){const i=parseInt(o[1],10),s=n[o[2]],a=o[3]?parseInt(o[3],10):new Date().getFullYear();if(!isNaN(i)&&s!=null)return new Date(a,s,i)}if(o=t.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/),o){const i=parseInt(o[1],10),s=parseInt(o[2],10)-1;let a=o[3]?parseInt(o[3],10):new Date().getFullYear();if(a<100&&(a=2e3+a),!isNaN(i)&&s>=0)return new Date(a,s,i)}return null}function di(e){if(!e)return null;const t=new Date,n=new Date(t.toLocaleString("en-US",{timeZone:"Europe/Rome"})),o=new Date(e.toLocaleString("en-US",{timeZone:"Europe/Rome"}));return Math.floor((o-n)/(24*3600*1e3))}function na(e){const t=U(e||"");if(!t)return{priority:"normal",visible:!0};if(/da\s*fare\s*oggi/.test(t))return{priority:"today",visible:!0,reason:"Da fare oggi"};const n=ci(t);if(n){const o=di(n);if(o!=null){const i=new Date(n.toLocaleString("en-US",{timeZone:"Europe/Rome"}));if(o>=2)return{priority:"scheduled",visible:!1,date:i};if(o>=1)return{priority:"scheduled",visible:!0,date:i,reason:"Da iniziare domani"};if(o>=0)return{priority:"scheduled",visible:!0,date:i,reason:"Da iniziare oggi"}}}return{priority:"normal",visible:!0}}function oa(e){return U(e).replace(/\bkg\b/g,"").replace(/\b\d+(?:[\.,]\d+)?\b/g,"").replace(/\s+/g,"").trim()}function ui(e){return Tn(e)}function ia(e){const t=yt({qty:e?.qty,um:e?.um,uom:e?.uom,unitaMisura:e?.unitaMisura,unit:e?.unit,measure:e?.measure,packKg:ui(e),desc:e?.desc||""});if(Number.isFinite(t)&&t>0)return t;const n=Number(e?.lineKg);return Number.isFinite(n)&&n>0?n:0}function Nn(e,t){if(!e||t==null)return null;if(e[t])return e[t];if(e[String(t)])return e[String(t)];const n=Object.keys(e||{}).find(o=>Math.abs(Number(o||0)-Number(t))<.011);return n?e[n]:null}function sa(e,t){const n=U(e.code||"").replace(/\s+/g,""),o=Number(t);if(n&&Ue.byCode[n]){const a=Nn(Ue.byCode[n].packs,t);if(a)return{bom:a,source:"code"}}const i=oa(e.desc||"");if(i&&Ue.byName[i]){const a=Nn(Ue.byName[i].packs,t);if(a)return{bom:a,source:"name"}}const s=Nn(Ue.defaultByPackKg,t);return s?{bom:s,source:"default"}:Number.isFinite(o)?{bom:null,source:"pack_unsupported"}:{bom:null,source:"not_found"}}function fi(e){const t=Number(e||0);return Number.isFinite(t)?`${t.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1")} kg`:"\u2014"}function ra(e){const t=Number(e||0);return Number.isFinite(t)?`${(t%1===0?t.toFixed(0):t.toFixed(1)).replace(/\.0$/,"")} g`:"\u2014"}function aa(e){const t=Number(e||0);return Number.isFinite(t)?t.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1"):"\u2014"}function J(e,t,n){if(!t)return;const o=Number(e.get(t)||0),i=Number(n||0);Number.isFinite(i)&&e.set(t,o+i)}function _(e){return String(e??"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Ke(e){try{const t=Number(String(e||"").split("_")[0]);return Number.isFinite(t)?t:0}catch{return 0}}function rt(){const e=c("completedList"),t=c("completedEmpty"),n=c("completedBadge");if(!e||!t||!n)return;const o=Array.isArray(r.history)?r.history.slice():[];o.sort((l,u)=>Ke(u.id||u.at||0)-Ke(l.id||l.at||0));const i=o.filter(l=>l&&(l.orderNo||l.customer||l.operator)).slice(0,10);if(n.textContent=i.length?String(i.length):"0",e.innerHTML="",!i.length){t.style.display="block";return}t.style.display="none";const s=!!(r.user&&r.user.isAdmin);let a=document.getElementById("completedAdmin");if(s){a||(a=document.createElement("div"),a.id="completedAdmin",a.style.margin="10px 0",a.innerHTML='<button class="btn bad" id="btnClearCompleted" style="width:100%;">Cancella tutti conclusi</button>',e.parentElement.appendChild(a));const l=a.querySelector("#btnClearCompleted");l&&(l.onclick=()=>$r()),a.style.display="block"}else a&&(a.style.display="none");let d=new Set,f=new Set;try{const{partial:l,full:u}=Re();for(const m of l)d.add(String(m.orderNo));for(const m of u)f.add(String(m.orderNo))}catch{}for(const l of i){const u=l.orderNo?String(l.orderNo):"\u2014",m=l.customer||"",g=l.operator||l.operatorName||l.userName||""||"Operatore",p=l.at?re(l.at):"",y=(()=>{try{if(Array.isArray(l.perLine)&&l.perLine.length)return Math.round(l.perLine.reduce((S,w)=>S+(Number(w.producedKg||0)||0),0))}catch{}return null})();let b="Produzione registrata";f.has(u)?b="Ordine concluso":d.has(u)&&(b="Ordine parzialmente concluso");const v=document.createElement("div");v.className="item completedItem rowPress",v.innerHTML=`
      <div class="top">
        <div>
          <div class="name ellipsis" title="Ordine n. ${_(u)} ${m?`\xB7 ${_(m)}`:""}">Ordine n. ${_(u)} ${m?`\xB7 ${_(m)}`:""}</div>
          <div class="completedMeta">
            <div><b>${_(g)}</b></div>
            ${p?`<div class="kv">${_(p)}</div>`:""}
            ${y!=null?`<div class="kv"><b>${y}</b> kg</div>`:""}
            <div>${_(b)}</div>
          </div>
        </div>
        <div class="badge">Dettagli</div>
      </div>
    `,v.addEventListener("click",()=>la(l.id)),e.appendChild(v)}}function la(e){const t=(r.history||[]).find(l=>l&&l.id===e);if(!t)return;const n=t.orderNo?String(t.orderNo):"\u2014",o=t.customer||"",i=t.operator||t.operatorName||"Operatore";c("histTitle").textContent=`Ordine n. ${n}${o?` \xB7 ${o}`:""}`,c("histSub").textContent=`Operatore: ${i}${t.at?` \xB7 ${re(t.at)}`:""}`;const s=c("histBody"),a=Array.isArray(t.perLine)?t.perLine:[],d=a.length?a.map(l=>`
    <div class="item" style="margin-bottom:10px;">
      <div class="top">
        <div>
          <div class="name">${_(l.desc||"")}</div>
          <div class="muted">Pianificati: <b>${_(String(l.plannedKg??"\u2014"))}</b> kg \xB7 Prodotti: <b>${_(String(l.producedKg??"\u2014"))}</b> kg</div>
        </div>
        <div class="badge">${_(String(l.qty??""))} ${_(String(l.um??""))}</div>
      </div>
      ${l.code?`<div class="muted" style="margin-top:6px;">Codice: <b>${_(String(l.code))}</b></div>`:""}
    </div>
  `).join(""):'<div class="muted">Nessun dettaglio righe disponibile.</div>',f=t.signature?`<div style="margin-top:14px;"><div class="muted" style="margin-bottom:6px;">Firma</div><img src="${t.signature}" alt="Firma" style="width:100%; max-width:520px; border:1px solid var(--stroke); border-radius:14px; background:#fff;"></div>`:"";s.innerHTML=`
    <div class="muted">Stato: <b>${_((()=>{try{const{partial:l,full:u}=Re(),m=new Set(l.map(p=>String(p.orderNo)));if(new Set(u.map(p=>String(p.orderNo))).has(n))return"Ordine concluso";if(m.has(n))return"Ordine parzialmente concluso"}catch{}return"Storico"})())}</b></div>
    <div style="height:12px"></div>
    ${d}
    ${f}
  `,c("histModal").classList.add("show"),G()}function Y(){H.firstRenderDone||Me("");let e=0,t=null,n=null;Je();try{const T=c("homeWelcome");T&&r.user&&(T.textContent=`Benvenuto, ${r.user.fullName}`)}catch{}const o=ze();on(o.baseOrders),ae();const i=o.orders,s=Hr(i);c("kPowderLines").textContent=s.lineCount?s.lineCount.toString():"0",Os(s.totalKg);const a=c("kPowderMeta");a&&(a.textContent=`Calcolato su ${s.lineCount} righe visibili`);const d=s.bobine,f=c("kBobineF480"),l=c("kBobineF830"),u=c("kBobineF480Meta"),m=c("kBobineF830Meta"),g=c("kBobineUnknown"),p=T=>Number.isFinite(T)?Math.max(0,Math.round(T)).toLocaleString("it-IT"):"0",y=T=>{const E=Number(T||0);return Number.isFinite(E)?E.toLocaleString("it-IT",{minimumFractionDigits:0,maximumFractionDigits:1}):"0"},b=T=>{const E=Number(T||0);return Number.isFinite(E)?Math.round(E).toLocaleString("it-IT"):"0"};if(f&&l)if(d){const T=Number.isFinite(d.bobineF480),E=Number.isFinite(d.bobineF830);if(f.textContent=T&&d.bobineF480!=null?p(d.bobineF480):"\u2014",l.textContent=E&&d.bobineF830!=null?p(d.bobineF830):"\u2014",u&&(u.textContent=T?"":"Stima non disponibile",T&&(u.innerHTML=`Kg 0,5: ${y(d.kg0_5)} \u2022 Kg 1: ${y(d.kg1)}<br>Tot F480: ${y(d.kgTotF480)} kg<br>Film: ${b(d.filmF480Gr)} g \u2022 Bobina: 25 kg`)),m&&(m.textContent=E?"":"Stima non disponibile",E&&(m.innerHTML=`Kg 5: ${y(d.kg5)} \u2022 Kg 10: ${y(d.kg10)}<br>Tot F830: ${y(d.kgTotF830)} kg<br>Film: ${b(d.filmF830Gr)} g \u2022 Bobina: 40 kg`)),g){const N=Number(d.kgUnknown||0);N>0?(g.style.display="block",g.textContent=`Non classificati: ${y(N)} kg`):g.style.display="none"}}else f.textContent="\u2014",l.textContent="\u2014",u&&(u.textContent="Stima non disponibile"),m&&(m.textContent="Stima non disponibile"),g&&(g.style.display="none");const v=r.powderOrders||[],S=c("badgeCounts");if(S){const T=!!(r.user&&r.user.isAdmin),E=r.mobileAllowlist||{},N=!!globalThis.__ALLOW_LOADED__,O=R();if(O&&!T&&!N)S.textContent="\u2014 ordini";else{const P=O&&!T?i.length:v.length,B=P===1?"ordine":"ordini";S.textContent=`${P} ${B}`}}const w=v.find(T=>Array.isArray(T.alerts)&&T.alerts.length);if(w){const T=(w.alerts||[])[0]||{},E=(T.desc||T.alertInfo?.label||"").trim(),N=w.number||w.orderNo||"",O=w.customer||"",P=[N,E||O].filter(Boolean).join("|");n=P?P.slice(0,160):null}me(o.baseOrders,o.orderKeySet);const h=c("mobileAllowInfo");if(h){const T=R()&&r.user&&!(r.user&&r.user.isAdmin);if(h.style.display=T?"block":"none",T){const E=r.mobileAllowlist||{},N=!!globalThis.__ALLOW_LOADED__,O=i.length;if(N&&!E.docExists)h.textContent="Assegnazioni non configurate";else if(N&&O===0)h.textContent="Nessun ordine assegnato dall\u2019admin";else{h.innerHTML=`Ordini assegnati: <span id="mobileAllowCount">${O}</span><span id="mobileAllowMsg" style="margin-left:6px; color:var(--muted); font-weight:800;"></span>`;const B=c("mobileAllowCount"),z=c("mobileAllowMsg");B&&(B.textContent=String(O)),z&&(z.textContent=""),N&&O===0&&z&&(z.textContent="Assegnazioni attive: nessun ordine")}}}let A="Ordini: ";r.xmlModifiedTime?A+=`aggiornati ${r.xmlModifiedTime}`:r.lastFetchAt?A+=`aggiornati ${re(r.lastFetchAt)}`:A+="in sincronizzazione\u2026",c("txtXmlTime").textContent=A,Nt();try{const{partial:T}=Re();e=T.length,r.partialOrders=T;const E=c("partialBanner");if(E)if(T.length){E.dataset.display="flex",E.style.display="flex",requestAnimationFrame(()=>E.classList.add("show"));const N=T.length;c("partialBannerTitle").textContent=`Ci sono ${N} ordini parzialmente conclusi in corso`,c("partialBannerSub").textContent="Apri Produzione per completare le righe rimanenti."}else E.classList.remove("show"),setTimeout(()=>{E.style.display="none"},180);c("partialModal")?.classList.contains("show")&&Ai()}catch{}try{rt()}catch{}const L=r.activeProductions||[],k=c("prodStrip");if(L.length){k.style.display="block",c("prodCount").textContent=String(L.length);const E=L.slice(0,6).map(B=>`${B.operator||"Operatore"}: ${B.customer||"Cliente"} \xB7 Ordine n. ${B.orderNo||"\u2014"}`).join("   \u2022  ")+(L.length>6?"   \u2022   ...":"");c("prodMarquee").textContent=E,t=`${L.length}|${E}`.slice(0,160);const N=L.map(B=>Jo(B)),O=N.length?Math.max(...N):0,P=Math.max(0,120-120*Math.min(1,O));k.style.background=`hsla(${P}, 80%, 45%, .22)`,k.style.borderColor=`hsla(${P}, 80%, 55%, .35)`}else k.style.display="none",t=null;try{const T=c("btnGoProd");if(T){const E=(r.user?.fullName||r.operator||"").toLowerCase(),N=E&&L.some(O=>String(O.operator||"").toLowerCase()===E);T.textContent=N?"APRI PRODUZIONE IN CORSO":"VAI IN PRODUZIONE",T.setAttribute("aria-label",T.textContent)}}catch{}Mt(),Le(),ge(),pe(),lt(),R()&&Is({partialCount:e,prodKey:t,alertKey:n}),H.firstRenderDone||Me("")}async function ca(e,t,n){if(!r.firebase.ok||!e)return;const o=r.firebase.api,i=r.firebase.db,s=o.doc(i,"operatorStats",e);await o.runTransaction(i,async a=>{const d=await a.get(s),f=d.exists()?d.data()||{}:{},l=Number(f.totalKg||0)+Number(n||0),u=Number(f.totalRuns||0)+1;a.set(s,{uid:e,fullName:t,totalKg:l,totalRuns:u,updatedAt:W()},{merge:!0})})}function xt(){const e=c("statsList"),t=c("statsBadge");if(!t)return;const n=Ge(),o=n?en():[],i=n?{concludedCountTotal:o.length,concludedKgTotal:o.reduce((l,u)=>l+Number(u.kg||0),0),updatedAt:null,updatedBy:""}:Xt(),s=l=>Number.isFinite(l)?Math.max(0,Math.round(l)).toLocaleString("it-IT"):"\u2014",a=l=>Number.isFinite(l)?`${Math.round(Math.max(0,Number(l)||0)).toLocaleString("it-IT")} kg`:"\u2014";if(t.textContent=s(i.concludedCountTotal),!e||!e.parentElement)return;let d=document.getElementById("globalStatsSummary");d||(d=document.createElement("div"),d.id="globalStatsSummary",d.style.padding="12px",d.style.margin="0 0 12px",d.style.borderRadius="14px",d.style.border="1px solid var(--stroke)",d.style.background="rgba(0,0,0,.02)",e.parentElement.insertBefore(d,e));const f=n?"Dati storici eliminati su questo dispositivo.":"Cumulativo totale, indipendente dai record eliminati.";d.innerHTML=`
      <div class="stepTitle" style="margin:0 0 6px 0;">Statistiche globali</div>
      <div class="muted" style="margin-bottom:8px;">${f}</div>
      <div style="display:flex; align-items:center; justify-content:space-between; font-weight:800;">
        <div class="muted" style="font-weight:800;">Ordini conclusi</div>
        <div>${s(i.concludedCountTotal)}</div>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-top:8px; font-weight:800;">
        <div class="muted" style="font-weight:800;">Kg totali</div>
        <div>${a(i.concludedKgTotal)}</div>
      </div>
    `}function da(e,t={}){const n=c("operatorLeaderboard");if(!n)return;const o=t.canSeeStats!==!1,i=t.rangeLabel||"Questo mese",s=Array.isArray(e)?e:[];let a=(t.sortOverride||ws())==="kg"?"kg":"orders";if(!o){n.innerHTML='<div class="opLbCard"><div class="opLbEmpty">Statistiche complete riservate agli amministratori.</div></div>';return}n.innerHTML=`
      <div class="opLbCard">
        <div class="opLbHead">
          <div>
            <div class="opLbTitle">Classifica operatori</div>
            <div class="opLbMeta">${_(i)} \xB7 Ordinata per ${a==="kg"?"kg prodotti":"ordini conclusi"}</div>
          </div>
          <div class="opLbToggles" role="group" aria-label="Ordina classifica operatori">
            <button class="opLbToggleBtn" data-sort="orders" type="button">Ordini</button>
            <button class="opLbToggleBtn" data-sort="kg" type="button">Kg</button>
          </div>
        </div>
        <div class="opLbList" id="opLbList"></div>
      </div>`;const d=n.querySelector("#opLbList"),f=n.querySelector(".opLbMeta"),l=Array.from(n.querySelectorAll(".opLbToggleBtn")),u=m=>{if(a=m==="kg"?"kg":"orders",_s(a),l.forEach(y=>{const b=y.dataset.sort===a;y.classList.toggle("active",b),b?y.setAttribute("aria-pressed","true"):y.setAttribute("aria-pressed","false")}),f&&(f.textContent=`${i} \xB7 Ordinata per ${a==="kg"?"kg prodotti":"ordini conclusi"}`),!d)return;const g=s.slice().sort((y,b)=>{if(a==="kg"){const S=(b.kg||0)-(y.kg||0);return S!==0?S:(b.orders||0)-(y.orders||0)}const v=(b.orders||0)-(y.orders||0);return v!==0?v:(b.kg||0)-(y.kg||0)});if(!g.length){d.innerHTML='<div class="opLbEmpty">Nessun dato disponibile.</div>';return}const p=g.map((y,b)=>{const v=b+1,S=v<=3?` top${v}`:"",w=_(y.operatorLabel||"Sconosciuto"),h=Mn(y.kg),A=Ot(y.orders),L=Ot(y.eventsCount);return`
          <div class="opLbRow${S}">
            <div class="opLbRank">#${v}</div>
            <div>
              <div class="opLbName">${w}</div>
              <div class="opLbSub">Attivit\xE0: ${L}</div>
            </div>
            <div class="opLbMetrics">
              <div class="opLbMetric">
                <div class="lbl">Kg mese</div>
                <div class="val">${h}</div>
              </div>
              <div class="opLbMetric">
                <div class="lbl">Ordini mese</div>
                <div class="val">${A}</div>
              </div>
            </div>
          </div>`}).join("");d.innerHTML=p};l.forEach(m=>{m.addEventListener("click",()=>{u(m.dataset.sort==="kg"?"kg":"orders")})}),u(a)}function mi(e){switch(String(e||"")){case"open":return"Apertura app";case"start":return"Avvio ordine";case"close":return"Chiusura ordine";case"issue":return"Segnalazione problema";case"absence":return"Programmazione assenza";default:return"Evento"}}function pe(){const e=c("actionLogCard"),t=c("actionLogList"),n=c("actionLogBadge"),o=c("actionLogEmpty");if(!e)return;const i=!!(r.user&&r.user.isAdmin);if(e.style.display=i?"":"none",!i)return;const{entries:s=[],ready:a,error:d}=r.actionLogs||{},f=c("actionLogFilterUser"),l=c("actionLogFilterType"),u=c("actionLogClear"),m=Array.from(new Set(s.map(w=>w.actor||"").filter(Boolean))).sort((w,h)=>w.localeCompare(h,"it")),g=Array.from(new Set(s.map(w=>w.type||"").filter(Boolean))),p=f?.value||"all",y=l?.value||"all";if(f&&!f.dataset.bound&&(f.dataset.bound="1",f.addEventListener("change",pe)),l&&!l.dataset.bound&&(l.dataset.bound="1",l.addEventListener("change",pe)),u&&!u.dataset.bound&&(u.dataset.bound="1",u.addEventListener("click",()=>{f&&(f.value="all"),l&&(l.value="all"),pe()})),f){const w=f.value||"all";f.innerHTML=`<option value="all">Tutti</option>${m.map(h=>`<option value="${_(h)}"${w===h?" selected":""}>${_(h)}</option>`).join("")}`,f.value||(f.value="all")}if(l){const w=l.value||"all";l.innerHTML=`<option value="all">Tutti</option>${g.map(h=>`<option value="${_(h)}"${w===h?" selected":""}>${_(mi(h))}</option>`).join("")}`,l.value||(l.value="all")}if(n){const w=a?String(s.length||0):"\u2014";n.textContent=w}if(!t)return;if(!a){t.innerHTML='<div class="muted">Caricamento registro azioni\u2026</div>',o&&(o.style.display="none");return}if(d){t.innerHTML=`<div class="alertBanner"><div class="label">${_(d)}</div><div class="hint">Controlla permessi o rete.</div></div>`,o&&(o.style.display="none");return}const b=s.filter(w=>{const h=p==="all"||(w.actor||"")===p,A=y==="all"||(w.type||"")===y;return h&&A});if(!b.length){t.innerHTML="",o&&(o.style.display="block");return}const v=w=>{try{w&&typeof w.toDate=="function"&&(w=w.toDate());const h=w instanceof Date?w:new Date(w);if(Number.isFinite(h.getTime()))return re(h)}catch{}return"\u2014"},S=document.createDocumentFragment();for(const w of b){const h=document.createElement("div");h.className="logRow";const A=[v(w.createdAt||w.at||w.ts),w.actor?`Da ${_(w.actor)}`:""].filter(Boolean),L=w.description||`${w.customer||""} ${w.orderNo?`\xB7 Ord. ${w.orderNo}`:""}`,k=w.meta||"";h.innerHTML=`
        <div class="logTitle">${_(mi(w.type))}</div>
        <div class="logMeta">${A.map(T=>`<span>${_(T)}</span>`).join("")}</div>
        <div class="logDesc">${_(L||"\u2014")}</div>
        ${k?`<div class="logSub">${_(k)}</div>`:""}
      `,S.appendChild(h)}t.innerHTML="",t.appendChild(S),o&&(o.style.display="none")}function Mt(){const e=c("statsList"),t=!!(r.user&&r.user.isAdmin||window.matchMedia("(min-width: 980px)").matches),n=en(),o=ys(),{start:i,end:s,label:a}=vs(),d=Ts(o,i,s);da(d,{canSeeStats:t,rangeLabel:a});const f=c("statsBadge"),l=n.length?Math.max(0,Math.round(n.length||0)).toString():"0";if(f&&(f.textContent=l),!t){e.innerHTML='<div class="muted">Statistiche complete riservate agli amministratori.</div>';return}xt();try{const y="adminStatsBox";let b=document.getElementById(y);r.user&&r.user.isAdmin?b||(b=document.createElement("div"),b.id=y,b.style.marginTop="12px",b.innerHTML=`
            <div class="divider"></div>
            <div class="stepTitle" style="font-size:14px; margin-top:0;">Admin</div>
            <button class="btn bad" id="btnClearHistory" style="width:100%;">Elimina dati storici</button>
            <div class="muted" id="statsClearFeedback" style="margin-top:8px;">Attenzione: operazione irreversibile.</div>
          `,e.parentElement.appendChild(b)):b&&b.remove()}catch{}const u=n,m=Ge();if(!u.length){const y=m?'<div class="muted" style="margin-top:6px;">Dati storici eliminati su questo dispositivo.</div>':"";e.innerHTML=`<div class="muted">Nessun dato storico disponibile (in attesa delle prime produzioni).</div>${y}`;return}const g=new Map;for(const y of u){const b=y.operator,v=Number(y.kg||0),S=Number(y.durationMs||0),w=g.get(b)||{kg:0,ms:0,n:0};w.kg+=v,w.ms+=S,w.n+=1,g.set(b,w)}const p=Array.from(g.entries()).map(([y,b])=>{const v=b.ms/36e5,S=v>0?b.kg/v:0;return{op:y,...b,speed:S}}).sort((y,b)=>b.kg-y.kg);e.innerHTML="";for(const y of p){const b=document.createElement("div");b.className="item",b.innerHTML=`
        <div class="top">
          <div>
            <div class="name">${y.op}</div>
            <div class="sub">${y.n} produzioni \xB7 Velocit\xE0 media: ${Math.round(y.speed)} kg/h</div>
          </div>
          <div class="badge">${Math.round(y.kg)} kg</div>
        </div>`,e.appendChild(b)}}function ua(){globalThis.__STATS_CLEAR_HANDLER_BOUND__||(globalThis.__STATS_CLEAR_HANDLER_BOUND__=!0,document.addEventListener("click",e=>{if(!e.target?.closest("#btnClearHistory"))return;if(!(r.user&&r.user.isAdmin)){C("Accesso limitato","Solo gli amministratori possono azzerare le statistiche.");return}confirm("Confermi eliminazione dati storici? Questa azione non \xE8 reversibile.")&&Ls()}))}function fa(e){return e?.closest?.(".whOverviewRow")?.dataset?.key||""}function pi(e){const t=e.type==="click",n=e.type==="keydown"&&(e.key==="Enter"||e.key===" ");if(!t&&!n)return;const o=fa(e.target);if(o){if(n)e.preventDefault();else if(e.detail===0)return;gi(o)}}function ma(e){const t=e||c("warehouseBody");!t||t.dataset.whDelegated==="true"||(t.dataset.whDelegated="true",t.addEventListener("click",pi),t.addEventListener("keydown",pi))}function ee(e,t){return e?`${e}${t}`:t}function X(e,t){return e?e.querySelector(t):null}function pa(e,t,n,o=""){if(!e||!t)return;const{orderDetails:i,sortedDetails:s,overviewItems:a,visibleItems:d,needsSeeAll:f,filteredTotals:l,applied:u,options:m}=n;t.textContent=`${s.length||0}`,t.title=`Ordini filtrati: ${s.length} / Totale: ${i.length}`;const g=document.activeElement,p=ee(o,"magFilterOrder"),y=!!(g&&e.contains(g)&&g.id===p),b=X(e,`#${ee(o,"whOverview")}`),v=b?b.scrollTop:0,S=r.xmlModifiedTime||(r.lastFetchAt?re(r.lastFetchAt):"\u2014"),w=(l.warnings?.length||0)+(l.nonConfig?.length||0),h=`<div class="whKpiRow">
        <div class="whKpi"><span class="v">${a.length||0}</span><span>Articoli monitorati</span></div>
        <div class="whKpi"><span class="v">${w}</span><span>Criticit\xE0</span></div>
        <div class="whKpi"><span class="v">${_(S)}</span><span>Aggiornato</span></div>
      </div>`,A=d.length?d.map(D=>{const ke=(li(D.label,D)||"").trim(),Ee=ke?`<div class="calcHint">(${_(ke)})</div>`:"";return`
        <button class="whOverviewRow rowPress" data-key="${_(D.key)}" type="button">
          <div style="flex:1; min-width:0;">
            <div class="whOverviewName">${_(D.label)}</div>
            ${Ee}
            ${D.subtitle?`<div class="whOverviewSub">${_(D.subtitle)}</div>`:""}
          </div>
          <div class="whOverviewVal">${ri(D)}</div>
        </button>`}).join(""):`<div class="muted">${i.length?"Nessun ordine corrisponde ai filtri.":"Nessun ordine disponibile."}</div>`,L=(()=>{const D=[];return(l.warnings||[]).length&&D.push(`<div class="badge" style="background:rgba(255,159,10,.14); border-color:rgba(255,159,10,.3);">Solleciti sacchi: ${l.warnings.length}</div>`),(l.nonConfig||[]).length&&D.push(`<div class="badge" style="background:rgba(255,149,0,.12); border-color:rgba(255,149,0,.3);">Distinte mancanti: ${l.nonConfig.length}</div>`),D.join("")})(),k=!!(u.customer||u.order||u.item),T=ee(o,"magFilterCustomer"),E=ee(o,"magFilterOrder"),N=ee(o,"magFilterItem"),O=ee(o,"magFiltersReset"),P=ee(o,"magFilterChips"),B=ee(o,"magResultBadge"),z=ee(o,"whOverview"),$=ee(o,"whSeeAll"),M=ee(o,"whScrollTop"),Z=K(u.order),F=Array.isArray(m.orders)?m.orders.slice():[],I=u.order&&!F.some(D=>K(D.value)===Z)?[{value:u.order,label:u.order},...F]:F,ie=`<div class="magFilterBar">
      <div class="magFilterField">
        <label class="magFilterLabel" for="${T}">Cliente</label>
        <select id="${T}" class="magFilterInput">
          <option value="">Tutti</option>
          ${m.customers.map(D=>`<option value="${_(D)}"${K(D)===K(u.customer)?" selected":""}>${_(D)}</option>`).join("")}
        </select>
      </div>
      <div class="magFilterField">
        <label class="magFilterLabel" for="${E}">Ordine</label>
        <select id="${E}" class="magFilterInput">
          <option value="">Tutti</option>
          ${I.map(D=>`<option value="${_(D.value||"")}"${K(D.value)===Z?" selected":""}>${_(D.label||D.value||"")}</option>`).join("")}
        </select>
      </div>
      <div class="magFilterField">
        <label class="magFilterLabel" for="${N}">Articolo (imballaggio)</label>
        <select id="${N}" class="magFilterInput">
          <option value="">Tutti</option>
          ${m.items.map(D=>`<option value="${_(D)}"${K(D)===K(u.item)?" selected":""}>${_(D)}</option>`).join("")}
        </select>
      </div>
      <div class="magFilterActions">
        <div class="magResultBadge" id="${B}">Risultati: ${a.length} \xB7 Ordini: ${s.length}</div>
        <button class="btn ghost" id="${O}" type="button"${k?"":' style="opacity:.8;"'}>Pulisci filtri</button>
      </div>
    </div>
    <div class="magFilterChips" id="${P}"></div>`;e.innerHTML=`<div class="magSimple">
      <div class="magTitle">Panoramica magazzino</div>
      ${ie}
      ${h}
      ${L?`<div class="whCritRow">${L}</div>`:""}
      <div id="${z}" class="whOverview rowsScroll">${A}</div>
      <div class="row2 whActions" style="margin-top:10px;">
        <button class="btn ghost" id="${$}" type="button"${f?"":' style="opacity:.65;"'}>Apri elenco completo</button>
        <button class="btn" type="button" id="${M}">Torna in cima</button>
      </div>
    </div>`,ma(e);const Ce=X(e,`#${$}`);Ce&&Ce.addEventListener("click",()=>gi(Cn));const Pn=X(e,`#${M}`);Pn&&Pn.addEventListener("click",()=>{const D=X(e,`#${z}`);D&&D.scrollTo({top:0,behavior:"smooth"})});const Fn=X(e,`#${T}`);Fn&&(Fn.onchange=D=>{const ke=D.target.value||"",Ee=r.magFilters||Q(),Ui=st(i,{...Ee,customer:ke,order:"",item:""}).filteredOrders||[],Un=kt(Ui),qi=Un.items||[],Wi=Un.orders||[],qn=K(Ee.item||""),Wn=K(Ee.order||""),Vi=!qn||qi.some(Kt=>K(Kt)===qn),Gi=!Wn||Wi.some(Kt=>K(Kt.value)===Wn),zt={customer:ke};Vi||(zt.item=""),Gi||(zt.order=""),Ct(zt),ge()});const Rt=X(e,`#${E}`);Rt&&(Rt.value=u.order||"",Rt.onchange=D=>{Ct({order:D.target.value||""}),ge()});const Rn=X(e,`#${N}`);Rn&&(Rn.onchange=D=>{Ct({item:D.target.value||""}),ge()});const zn=X(e,`#${O}`);zn&&zn.addEventListener("click",()=>{Wr(),ge()}),jr(X(e,`#${P}`),u);const Kn=X(e,`#${B}`);Kn&&(Kn.textContent=`Risultati: ${a.length} \xB7 Ordini: ${s.length}`);const Hn=X(e,`#${z}`);if(Hn&&typeof v=="number"&&(Hn.scrollTop=v),y){const D=X(e,`#${E}`);if(D)try{D.focus({preventScroll:!0})}catch{try{D.focus()}catch{}}}}function ga(e,t,n){if(!e||!t)return;const{orderDetails:o,sortedDetails:i,filteredTotals:s,updatedTxt:a,overviewItems:d}=n||{},f=(o||[]).length,l=(i||[]).length;t.textContent=`${l||0}`,t.title=`Ordini: ${l} / Totale: ${f}`;const u=Number((s&&s.linesWarn)!=null?s.linesWarn:s?.warnings?.length||0)||0,m=Number((s&&s.linesNonConfig)!=null?s.linesNonConfig:s?.nonConfig?.length||0)||0,g=Number((s&&s.linesTotal)!=null?s.linesTotal:u+m)||0,p=Number((s&&s.linesOk)!=null?s.linesOk:Math.max(0,g-u-m))||0,y=Number(s?.productKg||0)||0,b=Number(s?.etichette||0)||0,v=Number.isFinite(y)&&y>0,S=Number.isFinite(b)&&b>0,w=Math.max(1,p+u+m),h=Math.round(p/w*360),A=Math.round(u/w*360),L=`conic-gradient(var(--whOk) 0deg ${h}deg, var(--whWarn) ${h}deg ${h+A}deg, var(--whNon) ${h+A}deg 360deg)`,k=$=>Number.isFinite($)?Math.round($).toLocaleString("it-IT"):"\u2014",T=$=>Number.isFinite($)?$.toLocaleString("it-IT",{maximumFractionDigits:0}):"\u2014",E=[{v:k(g),l:"Totali"},{v:k(p),l:"OK",tone:"ok"},{v:k(u),l:"Warning",tone:"warn"},{v:k(m),l:"Non configurati",tone:"non"},...v?[{v:T(y),l:"Kg residui"}]:[],...S?[{v:k(b),l:"Etichette"}]:[]],N=[];(s?.warnings||[]).length&&N.push({tone:"warn",label:`Solleciti sacchi \xB7 ${s.warnings.length}`}),(s?.nonConfig||[]).length&&N.push({tone:"non",label:`Distinte mancanti \xB7 ${s.nonConfig.length}`});const O=N.length?N.map($=>`<span class="whChipPill" data-tone="${$.tone||""}">${_($.label)}</span>`).join(""):'<span class="whChipPill">Nessuna criticit\xE0</span>',P=E.map($=>`<div class="whMiniCard"${$.tone?` data-tone="${$.tone}"`:""}>
        <div class="label">${_(String($.l))}</div>
        <div class="value">${_(String($.v))}</div>
      </div>`).join(""),B=`<div class="whDonutWrap">
        <div class="whDonut whDonutLg" style="background:${L}">
          <div class="whDonutCenter">
            <div class="v">${_(String(k(g)))}</div>
            <div class="l">righe</div>
          </div>
        </div>
        <div class="whLegend whLegendCompact">
          <div class="whLegendItem"><span class="whDot"></span><span class="name">OK</span><span class="val">${_(String(k(p)))}</span></div>
          <div class="whLegendItem"><span class="whDot warn"></span><span class="name">Warning</span><span class="val">${_(String(k(u)))}</span></div>
          <div class="whLegendItem"><span class="whDot non"></span><span class="name">Non configurati</span><span class="val">${_(String(k(m)))}</span></div>
        </div>
      </div>`;e.innerHTML=`<div class="magSimple whShell">
      <div class="whHeroGlass">
        <div class="whHeroText">
          <div class="whChip">Aggiornato ${_(String(a||"\u2014"))}</div>
          <div class="whHeroTitle">Gestione magazzino</div>
          <div class="whHeroSub">Residui, packaging e criticit\xE0 live</div>
          <div class="whChipRow">${O}</div>
        </div>
        <div class="whHeroViz">
          ${B}
        </div>
      </div>
      <div class="whMiniGrid">${P}</div>
      <div class="whListCard">
        <div class="whListHead">
          <div>
            <div class="eyebrow">Gestione completa</div>
            <div class="whListTitle">Magazzino, residui e packaging</div>
            <div class="whHeroSub">Consulta l'elenco completo di articoli e ordini.</div>
          </div>
          <div class="whListBadge">${_(String(d?.length||0))} articoli \xB7 ${_(String(l))} ordini</div>
        </div>
        <div class="whFooterActions">
          <button class="whGhostBtn" type="button" id="whHomeOpenFull">Apri gestione completa</button>
        </div>
      </div>
    </div>`;const z=e.querySelector("#whHomeOpenFull");z&&(z.onclick=()=>{const $=c("btnWarehouseOpen");if($){try{$.focus({preventScroll:!0})}catch{}$.click();return}openWarehouseModal()})}function ge(e=!1){const t=c("warehouseCard"),n=c("warehouseBody"),o=c("warehouseBadge");if(!t||!n||!o)return;const i=window.matchMedia("(min-width: 1025px)").matches,s=typeof R=="function"?R():window.matchMedia("(max-width: 900px)").matches,a=!!(i||s);if(t.style.display=a?"block":"none",document.body.classList.toggle("desktopV2",!!i),!a){n.innerHTML="",o.textContent="\u2014";return}const{orderDetails:d}=Yr(),f=r.xmlModifiedTime||(r.lastFetchAt?re(r.lastFetchAt):"\u2014"),l=st(d,Q()),u=(l.filteredOrders||[]).slice().sort((F,I)=>`${F.order.customer||""}`.localeCompare(`${I.order.customer||""}`)||`${F.order.orderNo||F.order.number||""}`.localeCompare(`${I.order.orderNo||I.order.number||""}`)),m=si(l.filteredTotals||{productKg:0,bobine:new Map,etichette:0,scatole:new Map,divisori:new Map,altri:new Map,nonConfig:[],warnings:[]});ga(n,o,{orderDetails:d,sortedDetails:u,overviewItems:m,filteredTotals:l.filteredTotals||{},updatedTxt:f});const g=r.magFilters||Q(),{filteredOrders:p,filteredTotals:y,applied:b}=st(d,g),v={...g||Q(),item:""},S={...g||Q(),order:""},w=st(d,v).filteredOrders||[],h=st(d,S).filteredOrders||d,A=kt(d),L=kt(w),k=kt(h).orders,T={customers:A.customers,items:L.items,orders:k},E=(p||[]).slice().sort((F,I)=>`${F.order.customer||""}`.localeCompare(`${I.order.customer||""}`)||`${F.order.orderNo||F.order.number||""}`.localeCompare(`${I.order.orderNo||I.order.number||""}`)),N=Zr(E),O=si(y);r.magazzinoDetailLookup=N,r.magazzinoOverview=O;const B=O.slice(0,12),z=O.length>B.length,$={orderDetails:d,sortedDetails:E,overviewItems:O,visibleItems:B,needsSeeAll:z,filteredTotals:y,applied:b,options:T},M=c("warehouseModal");if(!!(M&&(M.classList.contains("show")||e))){const F=c("warehouseModalBody"),I=c("warehouseBadgeModal");F&&I&&pa(F,I,$,"m_")}}function ha(e){const t=c("whModalTitle"),n=c("whModalSub"),o=c("whModalCalc"),i=c("whModalBody");if(!t||!n||!i||!o)return;const s=(u,m)=>{const g=(li(u,m)||"").trim();g?(o.textContent=`(${g})`,o.style.display=""):(o.textContent="",o.style.display="none")},a=Array.isArray(r.magazzinoOverview)?r.magazzinoOverview:[],d=r.magazzinoDetailLookup instanceof Map?r.magazzinoDetailLookup:new Map,f=u=>{const m=d.get(u.key)||[],g=m.length?m.map(p=>`
        <div class="whModalRow">
          <div style="flex:1; min-width:0;">
            <div class="whModalName">${_(p.orderLabel||"Ordine")}</div>
            ${p.desc?`<div class="whModalSub">${_(p.desc)}</div>`:""}
          </div>
          <div class="whModalVal">${Qr(p.unit,p.qty)}</div>
        </div>`).join(""):'<div class="muted">Nessun dettaglio disponibile.</div>';return`<div class="whModalSection">
        <div class="tit">${_(u.label)}</div>
        ${g}
      </div>`};if(e===Cn){t.textContent="Dettaglio magazzino",n.textContent="Elenco completo articoli e ordini",s(t.textContent),i.innerHTML=a.length?a.map(f).join(""):'<div class="muted">Nessun dato disponibile.</div>';return}const l=a.find(u=>u.key===e);t.textContent=l?.label||"Dettaglio articolo",n.textContent=l?.subtitle||"Ripartizione per cliente/ordine",s(t.textContent,l),i.innerHTML=f(l||{key:e,label:"Articolo",subtitle:""})}function gi(e){const t=c("whModal");t&&(ha(e||Cn),t.classList.remove("hidden"),requestAnimationFrame(()=>t.classList.add("show")),G())}function xn(){const e=c("whModal");!e||!e.classList.contains("show")||(e.classList.remove("show"),setTimeout(()=>e.classList.add("hidden"),160),q())}function hi(){const e=(r.user?.fullName||"").trim();if(e)return e;const t=r.firebase?.auth?.currentUser,n=(t?.displayName||"").trim();if(n)return n;const o=(r.user?.email||t?.email||"").trim();if(o&&o.includes("@")){const[i]=o.split("@");if(i)return i}return"Operatore"}function Mn(e){const t=Math.max(0,Number(e)||0),n=Math.round(t*10)/10,o=Math.abs(Math.round(n*10)%10)!==0;return new Intl.NumberFormat("it-IT",{minimumFractionDigits:o?1:0,maximumFractionDigits:1}).format(n)}function Ot(e){return Math.max(0,Math.round(Number(e)||0)).toLocaleString("it-IT")}function bi(){const e=en(),t=new Date,n=t.getFullYear(),o=t.getMonth(),i=U(hi()||""),s=r.user?.uid||"",a=e.filter(f=>{const l=f?.startedAt||f?.endedAt||f?.at;if(!l)return!1;const u=new Date(l);return!Number.isFinite(u.getTime())||u.getFullYear()!==n||u.getMonth()!==o?!1:s&&f.operatorUid?f.operatorUid===s:i?U(f.operator||"")===i:!1});if(!a.length)return{kg:0,orders:0};const d=a.reduce((f,l)=>{const u=Number(l.kg);return Number.isFinite(u)?f+u:f},0);return{kg:Number.isFinite(d)?d:0,orders:a.length}}function ba(){const e=c("mobileWelcome");if(!e)return;const t=_(hi()||"Operatore"),{kg:n,orders:o}=bi(),i=Mn(n),s=Ot(o);e.innerHTML=`Benvenuto operatore <span class="highlight">${t}</span>, questo mese hai prodotto <span class="kpi">${i}</span> kg e hai concluso <span class="kpi">${s}</span> ordini.`}function ya(){const e=document.getElementById("statsProduzione")||document.getElementById("statsProdCard")||document.getElementById("statsCardAnchor");if(e){const t=e.nextElementSibling&&e.nextElementSibling.classList?.contains("card")?e.nextElementSibling:null,n=e.closest(".card")||t||e;try{n.scrollIntoView({behavior:"smooth",block:"start"})}catch{const s=n.getBoundingClientRect().top+window.pageYOffset-12;window.scrollTo({top:s,behavior:"smooth"})}return}window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}function Le(){const e=c("hdrMonthKg"),t=c("hdrMonthOrders"),n=c("deskMonthKg"),o=c("deskMonthOrders");if(!e||!t)return;let i="0",s="0";try{const{kg:a,orders:d}=bi();i=Mn(a),s=Ot(d)}catch{}e.textContent=i,t.textContent=s,n&&(n.textContent=i),o&&(o.textContent=s),ba()}let He=null;function On(){if(He instanceof Set)return He;try{const e=localStorage.getItem(Qn)||"[]",t=JSON.parse(e);He=new Set(Array.isArray(t)?t.filter(Boolean):[])}catch{He=new Set}return He}function va(e){try{localStorage.setItem(Qn,JSON.stringify(Array.from(e||[])))}catch{}He=e instanceof Set?e:new Set}function yi(){if(Ne instanceof Set)return Ne;try{const e=localStorage.getItem(Jn)||"[]",t=JSON.parse(e);Ne=new Set(Array.isArray(t)?t.filter(Boolean):[])}catch{Ne=new Set}return Ne}function wa(e){try{localStorage.setItem(Jn,JSON.stringify(Array.from(e||[])))}catch{}Ne=e instanceof Set?e:new Set}function $t(){const e=r.notifications&&Array.isArray(r.notifications.inbox)?r.notifications.inbox:[],t=!!(r.user&&r.user.isAdmin),n=yi();return e.filter(o=>!(!o||!o.id||n.has(o.id)||!t&&(o.audience==="admin"||o.adminOnly===!0)))}function _a(){const e=yi(),t=$t().map(o=>o.id).filter(Boolean);let n=!1;for(const o of t)o&&!e.has(o)&&(e.add(o),n=!0);n&&wa(e),vi(t),he(),te()}function vi(e){if(!e||!e.length)return;const t=On();let n=!1;for(const o of e)o&&!t.has(o)&&(t.add(o),n=!0);n&&va(t)}function Sa(){const e=$t().map(t=>t.id).filter(Boolean);vi(e),he()}function Aa(){const e=On(),t=$t();let n=0;for(const o of t)o&&o.id&&!e.has(o.id)&&n++;return n}function he(){const e=c("pillPushBadge");if(!e)return;const t=Aa();t>0?(e.textContent=t>99?"99+":String(t),e.style.display="inline-flex"):e.style.display="none"}function te(){const e=c("notifList"),t=c("notifEmpty"),n=c("notifStatus"),o=c("notifUnavailable"),i=c("notifAdminBox"),s=c("btnTogglePush"),a=c("notifSub");i&&(i.style.display=r.user&&r.user.isAdmin?"block":"none");const d=$t(),f=!!(r.notifications?.unavailable||!r.firebase.ok);if(o&&(o.style.display=f?"flex":"none"),a&&(a.textContent=f?"UI non disponibile (permessi Firebase).":"Push, messaggi interni e registro."),n&&(f?n.textContent="Centro notifiche non disponibile (permessi o connessione).":r.notifications?.ready?n.textContent=d.length?`${d.length} notifiche recenti`:"Nessuna notifica recente":n.textContent="Caricamento notifiche\u2026"),e){if(e.innerHTML="",!f&&d.length){const l=On(),u=document.createDocumentFragment();for(const m of d){const g=document.createElement("div"),p=m?.id&&!l.has(m.id);g.className=`notifItem${p?" unread":""}`;let y="\u2014";try{const v=m?.createdAt,S=v&&typeof v.toDate=="function"?v.toDate():v?new Date(v):null;S&&Number.isFinite(S.getTime())&&(y=re(S))}catch{}const b=m?.createdBy?` \xB7 Da ${_(m.createdBy)}`:"";g.innerHTML=`
            <div class="notifTitle">${_(m?.title||"Aggiornamento")}</div>
            <div class="notifBody">${_(m?.body||"")}</div>
            <div class="notifMeta"><span>${_(y)}</span>${b?`<span>${b}</span>`:""}</div>`,u.appendChild(g)}e.appendChild(u)}t&&(t.style.display=!f&&r.notifications?.ready&&!d.length?"block":"none")}if(s){const l=typeof Notification<"u"?Notification.permission:"unsupported";s.textContent=l==="granted"?"Disattiva push":"Attiva push"}he()}async function Ta(e){if(!r.firebase.ok)throw new Error("Firebase non disponibile");const t=r.firebase.api,n=r.firebase.db,o=`${Date.now()}_${Math.random().toString(16).slice(2)}`,i={...e,id:o,at:W(),createdAt:t.serverTimestamp(),createdBy:r.user?.fullName||"",createdByUid:r.user?.uid||"",createdByEmail:r.user?.email||""};return await t.setDoc(t.doc(n,"powderAbsenceRequests",o),i),i}async function La(){if(!r.firebase.ok)return;const e=r.firebase.api,t=r.firebase.db;if(r.notifUnsub){try{r.notifUnsub()}catch{}r.notifUnsub=null}try{const n=e.query(e.collection(t,qt),e.orderBy("createdAt","desc"),e.limit(rs));r.notifications.ready=!1,r.notifications.unavailable=!1,r.notifUnsub=e.onSnapshot(n,o=>{const i=[];o.forEach(s=>i.push({id:s.id,...s.data()})),r.notifications.inbox=i,r.notifications.ready=!0,r.notifications.unavailable=!1,te(),he()},o=>{console.warn("notif snapshot err",o),r.notifications.unavailable=!0,r.notifications.ready=!0,r.notifications.error=o?.code||String(o),te()})}catch(n){console.warn("init notifications failed",n),r.notifications.unavailable=!0,r.notifications.ready=!0,r.notifications.error=n?.code||String(n),te()}}async function ul(e,t){if(!r.firebase.ok)throw new Error("Firebase non disponibile");const n=r.firebase.api,o=r.firebase.db,i=n.collection(o,qt);await n.addDoc(i,{title:e||"Aggiornamento",body:t||"",line:"polveri",createdAt:n.serverTimestamp(),createdBy:r.user?.fullName||"Admin",createdByUid:r.user?.uid||"",audience:"all"});try{await Wt(`[Hub Polveri] ${e||"Notifica"}`,`${t||""}

\u2014
Da: ${r.user?.fullName||"Sistema"}
Linea: polveri`,null)}catch{}}async function wi(e,t){if(!r.firebase.ok)throw new Error("Firebase non disponibile");const n=r.firebase.api,o=r.firebase.db,i=n.collection(o,qt);await n.addDoc(i,{title:e||"Richiesta",body:t||"",line:"polveri",createdAt:n.serverTimestamp(),createdBy:r.user?.fullName||"Operatore",createdByUid:r.user?.uid||"",audience:"admin",adminOnly:!0});try{await Wt(`[Hub Polveri] ${e||"Notifica"}`,`${t||""}

\u2014
Da: ${r.user?.fullName||"Sistema"}
Linea: polveri`,null)}catch{}}function Ca(){const e=c("notifModal");e&&(e.classList.add("show"),G(),te(),Sa())}function $n(){const e=c("notifModal");e&&(e.classList.remove("show"),q(),he())}function Dt(){const e=c("alertModal"),t=c("alertModalText");if(!e||!t)return;const n=r.operatorAlert&&r.operatorAlert.message?String(r.operatorAlert.message):"Nessun avviso attivo.";t.textContent=n,e.classList.add("show"),G()}function _i(){const e=c("alertModal");e&&(e.classList.remove("show"),q())}function ka(){$n();const e=c("completedCard");e&&(e.scrollIntoView({behavior:"smooth",block:"start"}),e.classList.add("pressCard"),setTimeout(()=>e.classList.remove("pressCard"),1200))}async function Ea(){if(typeof Notification>"u"){C("Non supportato","Questo browser non supporta le notifiche.");return}Notification.permission==="granted"?confirm("Vuoi DISATTIVARE le notifiche push su questo dispositivo?")&&await Pa():await Ia(),te(),be()}async function Si(){if(!r.user){Se("Per iniziare un ordine devi prima accedere con un account autorizzato.");return}r.prodModalOpenedAt=Date.now(),r.startedThisSession=!1,r.prodModalTouched=!1;const e=c("prodModal");e&&(e.classList.add("show"),G(),ae(),await It(),lo(e))}function Na(){c("prodModal").classList.remove("show"),q()}function Dn(e){const t=c("prodModalBody");if(!t)return{wrap:null,step:null};t.classList.add("modalStepWrap");let n=t.querySelector(`.modalStep[data-step="${e}"]`);return n||(n=document.createElement("div"),n.className="modalStep",n.dataset.step=e,t.appendChild(n)),n.classList.remove("isEnterNext","isEnterPrev","isExitNext","isExitPrev"),{wrap:t,step:n}}function Bt(e,t="next"){const n=c("prodModalBody");if(!n||!e)return;const o=c("prodModal");n.classList.add("modalStepWrap"),n.querySelectorAll(".modalStep").forEach(i=>{i!==e&&i.classList.remove("isActive","isEnterNext","isEnterPrev","isExitNext","isExitPrev")}),e.classList.add("isActive"),n.style.height="auto";try{const i=n.closest(".sbd")||o?.querySelector(".sbd");i&&(i.scrollTop=0)}catch{}lo(o)}function Ai(){const e=c("partialBody");if(!e)return;let t=[];try{t=Re().partial||[]}catch{t=[]}const n=new Set(t.map(a=>String(a.orderNo||a.number||""))),{baseOrders:o}=ze({applyRoleVisibility:!1,includeHidden:!0}),i=o.filter(a=>n.has(String(a.orderNo||a.number||"")));if(!i.length){e.innerHTML='<div class="muted">Nessun ordine parzialmente concluso.</div>';return}e.innerHTML='<div class="list" id="partialList"></div>';const s=e.querySelector("#partialList");s.classList.add("chunkyList"),i.forEach(a=>{const d=a.partialInfo?.done||0,f=a.partialInfo?.total||d+(a.lines?.length||0)+(a.autoDone||0),l=document.createElement("div");l.className="item pressCard rowPress",l.innerHTML=`
        <div class="top">
          <div>
            <div class="name ellipsis" title="${_(a.customer||"Cliente")} \xB7 Ordine ${_(a.orderNo||a.number||"")}">${_(a.customer||"Cliente")} \xB7 Ordine ${_(a.orderNo||a.number||"")}</div>
            <div class="sub">Conclusione prevista: <b>${_(a.conclusion||"\u2014")}</b></div>
            <div class="muted" style="margin-top:6px;">Righe concluse: ${d}/${f} \xB7 Kg: ${Math.round(a.totalKg||0)}</div>
          </div>
          <div class="badge" style="border-color:var(--warn); color:var(--warn);">Parziale</div>
        </div>`,l.onclick=()=>{c("partialModal").classList.remove("show"),q(),Si(),setTimeout(()=>Li(a),60)},s.appendChild(l)})}async function xa(e){const{baseOrders:t}=ze({applyRoleVisibility:!1,includeHidden:!0});on(t);const n=xs();if(ae(),!n.size){C("Seleziona righe","Non hai selezionato righe da avviare.");return}const o=r.user?.fullName||r.operator||"Operatore",i=new Map(t.map(f=>[`${f.orderNo||f.number||""}__${f.customer||""}`,f]));let s=0,a=0;for(const[f,l]of n.entries()){const u=i.get(f);if(!u)continue;const m=(u.lines||[]).filter(h=>h.status!=="active"),g=new Set((l.lines||[]).map(h=>String(h.lineKey||""))),p=m.filter(h=>g.has(String(h.lineKey||"")));if(!p.length)continue;const y=m.length>0&&m.every(h=>g.has(String(h.lineKey||""))),b=p.reduce((h,A)=>h+ti(A),0)||u.totalKg||0,v={operator:o,customer:u.customer,orderNo:u.orderNo||u.number,conclusion:u.conclusion||"",totalKg:b,selectedLineKeys:p.map(h=>h.lineKey),isFullOrderStart:y,startedAt:W(),active:!0};await _r(v);try{await nt({type:"start",action:"Avvio ordine",description:`Ordine n. ${v.orderNo} \xB7 ${v.customer}`,orderNo:v.orderNo,customer:v.customer,meta:`${p.length} righe \xB7 ${Math.round(b||0)} kg`})}catch{}const w=nr(p)==="small"?" Utilizzare macchina piccola per fare questo ordine.":" Utilizzare macchina grande.";Lt(`Ordine: operatore ${o} ha avviato ordine ${v.orderNo} del cliente ${v.customer}.${w}`),s++,a+=p.length}if(!s){C("Selezione non valida","Seleziona righe non gi\xE0 in produzione.");return}r.startedThisSession=!0,ye().clear(),ae(),c("prodModal").classList.remove("show"),q();const d=e?`Ordine n. ${e.orderNo||e.number||""}`:"Ordini selezionati";C("Produzione avviata",`${d} \xB7 ${s} ordini \xB7 ${a} righe`)}function fl(){It()}async function It(e="next"){c("prodModalTitle").textContent="Produzione \xB7 Ordini";const{step:t}=Dn("orders");if(!t)return;const{orders:n,baseOrders:o}=ze();on(o),ae(),n.sort((u,m)=>{const g=u.priorityInfo?.priority==="today"?0:u.priorityInfo?.priority==="scheduled"?1:2,p=m.priorityInfo?.priority==="today"?0:m.priorityInfo?.priority==="scheduled"?1:2;return g-p});const i=window.matchMedia("(min-width: 980px)").matches,s=!!(r.user&&r.user.isAdmin);let a="";if(i)if(s)a='<div class="planMessage"><div class="headline">Vista admin</div><div class="muted">Tutti gli ordini (anche oltre 3 giorni) sono visibili per la pianificazione.</div></div>';else{const u=o.filter(g=>g.daysAway==null||g.daysAway<=3),m=u.slice(0,8).map(g=>`<li>${_(g.customer||"Cliente")} \xB7 Ord. ${_(g.orderNo||g.number||"\u2014")}${g.conclusion?` \xB7 ${_(g.conclusion)}`:""}</li>`).join("")||"<li>Nessuna data pianificata disponibile.</li>";a=`<div class="planMessage"><div class="headline">Ci sono ${o.length} ordini da fare. In base alla pianificazione, puoi andare in produzione con questi ${u.length} ordini:</div><ul>${m}</ul></div>`}t.innerHTML=`
      <div class="stepTitle">Ordini disponibili</div>
      <div class="muted">Operatore: <b>${r.user?.fullName||"\u2014"}</b>. Tocca un cliente: vedrai gli ordini separati per numero.</div>
      ${a}
      <div style="height:10px"></div>
      <div class="list" id="orderList"></div>
    `;const d=t.querySelector("#orderList");if(d.classList.add("chunkyList"),!n.length){const u=o.some(g=>g.daysAway==null||g.daysAway<=3),m=i&&!s&&o.length&&!u?"Nessun ordine pianificato entro i prossimi 3 giorni.":"Nessun ordine disponibile (attendi sincronizzazione).";d.innerHTML=`<div class="muted">${m}</div>
        <div style="height:10px"></div>
        <button class="btn" id="btnRetry" style="width:100%;">Riprova sincronizzazione</button>`,t.querySelector("#btnRetry").onclick=async()=>{t.querySelector("#btnRetry").textContent="Sincronizzo\u2026",await Xe(!1,"manual_retry"),It("next")},Bt(t,e);return}const f=new Map;for(const u of n){const m=u.customer||"Cliente";f.has(m)||f.set(m,[]),f.get(m).push(u)}const l=Array.from(f.entries());await Jt(d,l,([u,m])=>{const g=document.createElement("div");return g.className="item",g.innerHTML=`<div class="top"><div><div class="name">${u}</div><div class="sub">${m.length} ordini</div></div><div class="badge">Apri</div></div>`,g.style.cursor="pointer",g.onclick=()=>{Ti(u,m)},g},120),Bt(t,e)}async function Ti(e,t,n="next"){c("prodModalTitle").textContent=`Produzione \xB7 ${e}`;const{step:o}=Dn("customer");if(!o)return;o.innerHTML=`
      <div class="stepTitle">Ordini per ${e}</div>
      <div class="muted">Ordini separati per numero. Apri un ordine per vedere le righe.</div>
      <div style="height:10px"></div>
      <div class="list" id="custOrders"></div>
      <div style="height:12px"></div>
      <button class="btn ghost" id="btnBackOrders" style="width:100%;">\u2190 Torna alla lista clienti</button>
    `,o.querySelector("#btnBackOrders").onclick=()=>It("prev");const i=o.querySelector("#custOrders");i.classList.add("chunkyList"),await Jt(i,t,s=>{const a=document.createElement("div");a.className="item",a.style.cursor="pointer";const d=s.lines.reduce((p,y)=>p+Number(y.qty||0),0),l=(s.priorityInfo?.priority||"normal")==="today"?"Priorit\xE0":s.partialInfo?"Parziale":"Apri",u=s.alerts&&s.alerts.length?`<div class="muted" style="margin-top:6px;">Avvisi: ${s.alerts.length}</div>`:"",m=sn(s).length,g=m?`<div class="muted" style="margin-top:6px; color:rgba(10,58,125,.92); font-weight:900;">Righe selezionate: ${m}</div>`:"";return a.innerHTML=`
        <div class="top">
          <div>
            <div class="name">Ordine n. ${s.orderNo||s.number}</div>
            <div class="sub">Righe: ${s.lines.length} \xB7 Quantit\xE0: ${ht(d,"kg")} \xB7 Conclusione: ${s.conclusion||"\u2014"}</div>
            ${s.partialInfo?`<div class="muted" style="margin-top:6px;">Ordine parzialmente concluso (${s.partialInfo.done}/${s.partialInfo.total}).</div>`:""}
            ${s.priorityInfo?.reason?`<div class="muted" style="margin-top:6px;">${_(s.priorityInfo.reason)}</div>`:""}
            ${u}
            ${g}
          </div>
          <div class="badge">${l}</div>
        </div>`,a.onclick=()=>Li(s),a},120),Bt(o,n)}function Li(e,t="next"){const n=e.orderNo||e.number;c("prodModalTitle").textContent=`Ordine n. ${n}`;const{step:o}=Dn("detail");if(!o)return;const i=e.lines||[],s=e.alerts||[],a=s.length?`<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${s.map(m=>{const g=No(m.alertInfo?.color);return`<div class="alertBanner" style="${`background:${g.bg};border-color:${g.border};color:${g.color};${g.shadow?`box-shadow:${g.shadow};`:""}`}"><div class="label">${_(m.desc||m.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`}).join("")}</div>`:"";o.innerHTML=`
      <div class="stepTitle">${e.customer}</div>
      <div class="muted">Seleziona le righe da produrre, poi avvia. (Seleziona tutto = ordine completo)</div>
      ${e.partialInfo?`<div class="warnBanner" style="margin:10px 0 6px;">
        <div class="icon">\u2139\uFE0F</div>
        <div class="txt">
          <div class="t">Ordine parzialmente concluso</div>
          <div class="s">Restano ${e.partialInfo.total-e.partialInfo.done} righe da completare.</div>
        </div>
      </div>`:""}
      ${a}
      ${e.conclusion?`<div class="muted" style="margin:6px 0 8px; font-weight:800;">Conclusione prevista: <b>${_(e.conclusion)}</b></div>`:""}
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAll">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAll">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="lineList"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnStartProd" style="width:100%;">INIZIA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackCust" style="width:100%;">\u2190 Torna agli ordini cliente</button>
    `;const d=ye(),f=new Set(sn(e).map(m=>String(m.lineKey))),l=o.querySelector("#lineList");l.classList.add("chunkyList");async function u(){f.clear(),sn(e).forEach(p=>f.add(String(p.lineKey))),await Jt(l,i,p=>{const y=p.lineKey,b=tn(e,p),v=document.createElement("div"),S=f.has(y)||d.has(b),w=p.status==="active",h=!!(w&&p.activeIsMe&&p.activeProd),A=w&&!h;v.className=`item pressCard selectableLine${S?" selected":""}`,v.style.cursor=A?"not-allowed":"pointer";const L=ht(p.qty,p.um);return v.innerHTML=`
          <div class="top">
            <div>
              <div class="name">${p.desc}</div>
              <div class="sub" style="font-size:13px; font-weight:900;">Quantit\xE0: <span style="font-size:15px;">${L}</span></div>
              ${p.code?`<div class="muted" style="margin-top:6px;">Cod: <b>${p.code}</b></div>`:""}
              ${p.conclusion?`<div class="muted" style="margin-top:6px;">Conclusione prevista: ${_(p.conclusion)}</div>`:""}
              ${w?`<div class="muted" style="margin-top:6px; font-weight:800;">In produzione da ${_(h?"te":p.activeOp||"operatore")} \xB7 ${h?"tocca per riaprire.":"riapri la produzione in corso."}</div>`:""}
            </div>
            <div class="badge">${S?"\u2713":A?"Bloccato":"Seleziona"}</div>
          </div>
        `,w?h?v.onclick=()=>{try{Bn(),setTimeout(()=>{try{Ci(p.activeProd)}catch{}},60)}catch{}C("In produzione","Questa riga \xE8 gi\xE0 in produzione da te. Apro la produzione in corso\u2026")}:v.onclick=()=>C("In produzione",`Riga gi\xE0 avviata da ${p.activeOp||"un operatore"}.`):v.onclick=()=>{const k={orderNo:n,customer:e.customer,lineKey:p.lineKey,desc:p.desc,qty:p.qty,um:p.um,packKg:p.packKg,lineKg:p.lineKg,conclusion:p.conclusion||e.conclusion||"",orderConclusion:e.conclusion||"",totalKg:e.totalKg||0};f.has(y)||d.has(b)?(f.delete(y),d.delete(b)):(f.add(y),d.set(b,k)),r.prodModalTouched=!0,u(),ae()},v},100);const m=nn(),g=o.querySelector("#btnStartProd");g.disabled=m===0,g.style.opacity=m===0?".6":"1",g.textContent=m>0?`INIZIA PRODUZIONE (${m})`:"INIZIA PRODUZIONE"}o.querySelector("#btnSelAll").onclick=()=>{i.filter(m=>m.status!=="active").forEach(m=>{f.add(m.lineKey);const g=tn(e,m);d.set(g,{orderNo:n,customer:e.customer,lineKey:m.lineKey,desc:m.desc,qty:m.qty,um:m.um,packKg:m.packKg,lineKg:m.lineKg,conclusion:m.conclusion||e.conclusion||"",orderConclusion:e.conclusion||"",totalKg:e.totalKg||0})}),r.prodModalTouched=!0,u(),ae()},o.querySelector("#btnClrAll").onclick=()=>{Ns(e),f.clear(),r.prodModalTouched=!0,u(),ae()},o.querySelector("#btnBackCust").onclick=()=>{const m=ze().orders.filter(g=>g.customer===e.customer);Ti(e.customer,m,"prev")},o.querySelector("#btnStartProd").onclick=async()=>{nn()!==0&&await xa(e)},u(),Bt(o,t)}function Bn(){c("runningModal").classList.add("show"),G(),Pt()}function Pt(){const e=c("runningBody"),t=r.activeProductions||[];if(!t.length){e.innerHTML='<div class="muted">Nessuna produzione attiva al momento.</div>';return}e.innerHTML='<div class="stepTitle">Attivit\xE0 in corso</div><div class="muted">Apri per vedere dettagli e concludere la produzione.</div><div style="height:10px"></div><div class="list" id="runList"></div>';const n=e.querySelector("#runList");n.classList.add("chunkyList"),t.sort((o,i)=>new Date(o.startedAt||0)-new Date(i.startedAt||0)).forEach(o=>{const i=o.startedAt?Math.floor((Date.now()-new Date(o.startedAt).getTime())/6e4):0,s=Jo(o),a=Math.max(0,120-120*Math.min(1,s)),d=document.createElement("div");d.className="item",d.style.cursor="pointer",d.style.borderColor=`hsla(${a}, 80%, 55%, .35)`,d.style.background=`hsla(${a}, 80%, 45%, .14)`,d.innerHTML=`
          <div class="top">
            <div>
              <div class="name">${o.operator||"Operatore"} \xB7 Ordine n. ${o.orderNo||"\u2014"}</div>
              <div class="sub">${o.customer||"Cliente"} \xB7 ${Math.round(Number(o.totalKg||0))} kg \xB7 In corso da ${i} min \xB7 Conclusione: ${o.conclusion||"\u2014"}</div>
            </div>
            <div class="badge">Apri</div>
          </div>
        `,d.onclick=()=>Ci(o),n.appendChild(d)})}function Ci(e){const t=c("runningBody"),n=r.powderOrders.find(h=>h.number===e.orderNo&&h.customer===e.customer)||null,o=new Set(e.selectedLineKeys||[]),i=new Set(o),s=new Map,a=n?n.lines.filter(h=>o.has(h.lineKey)):[],d=n?.alerts||[],f=d.length?`<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${d.map(h=>{const A=No(h.alertInfo?.color);return`<div class="alertBanner" style="${`background:${A.bg};border-color:${A.border};color:${A.color};${A.shadow?`box-shadow:${A.shadow};`:""}`}"><div class="label">${_(h.desc||h.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`}).join("")}</div>`:"";t.innerHTML=`
      <div class="stepTitle">${e.operator||"Operatore"} \xB7 Ordine n. ${e.orderNo}</div>
      <div class="muted">${e.customer} \xB7 Seleziona cosa stai concludendo, poi premi \u201CHo concluso la produzione\u201D.</div>
      ${f}
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAllRun">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAllRun">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="runLines"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnConclude" style="width:100%;">HO CONCLUSO LA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn bad" id="btnCancelProd" style="width:100%;">Annulla produzione in corso</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackRun" style="width:100%;">\u2190 Torna a elenco produzioni</button>
    `;const l=t.querySelector("#runLines");function u(){l.innerHTML="";for(const A of a){const L=i.has(A.lineKey),k=document.createElement("div");k.className=`item pressCard selectableLine${L?" selected":""}`;const T=A.conclusion||n?.conclusion||"";if(k.style.cursor="pointer",k.style.borderColor=L?"rgba(46,123,255,.55)":"rgba(255,255,255,.12)",xo(A))k.innerHTML=or({selectable:!0,checked:L});else{const N=ht(A.qty,A.um);k.innerHTML=`
            <div class="top">
              <div>
                <div class="name">${A.desc}</div>
                <div class="sub">Quantit\xE0: ${N} \xB7 Cod: ${A.code||"\u2014"}${T?` \xB7 Conclusione: ${T}`:""}</div>
                <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
                  <div class="muted" style="font-size:12px; font-weight:900; min-width:150px;">Quantit\xE0 prodotta (kg, opzionale)</div>
                  <input class="kgInput" data-k="${A.lineKey}" type="number" inputmode="decimal" step="0.1" placeholder="auto" style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--stroke); background: rgba(0,0,0,.02); font-weight:900;"/>
                </div>
              </div>
              <div class="badge">${L?"\u2713":"Seleziona"}</div>
            </div>`;const O=k.querySelector(".kgInput");if(O){const P=s.get(A.lineKey);P!=null&&(O.value=P),O.addEventListener("click",B=>B.stopPropagation()),O.addEventListener("touchstart",B=>B.stopPropagation(),{passive:!0}),O.addEventListener("input",()=>{s.set(A.lineKey,O.value)})}}k.onclick=()=>{i.has(A.lineKey)?i.delete(A.lineKey):i.add(A.lineKey),u()},l.appendChild(k)}c("btnConclude").disabled=i.size===0,c("btnConclude").style.opacity=i.size===0?".6":"1";const h=c("btnConclude");h&&h.classList.contains("isBusy")?(h.disabled=!0,h.setAttribute("aria-disabled","true"),h.style.opacity=".82"):h&&h.removeAttribute("aria-disabled")}t.querySelector("#btnSelAllRun").onclick=()=>{for(const h of o)i.add(h);u()},t.querySelector("#btnClrAllRun").onclick=()=>{i.clear(),u()},t.querySelector("#btnBackRun").onclick=Pt;const m=n?we(n):ko({orderNo:e.orderNo,number:e.orderNo,id:e.id||e.orderNo,customer:e.customer});!!(r.user&&r.user.isAdmin)?t.querySelector("#btnCancelProd").onclick=async()=>{confirm("Sei sicuro che vuoi annullare la produzione in corso?")&&(await qo(e.id,{cancelled:!0}),C("Produzione annullata",`Ordine n. ${e.orderNo} \xB7 ${e.customer}`),Hs(`Ordine n. ${e.orderNo} \xB7 ${e.customer}`),setTimeout(()=>Eo(),6500),Pt(),Y())}:t.querySelector("#btnCancelProd").style.display="none";const p=t.querySelector("#btnConclude"),y=globalThis.__CONCLUDE_INFLIGHT__,b=globalThis.__CONCLUDE_RECENT__,v=(h,A="Conclusione\u2026")=>{p&&(p.dataset.defaultLabel||(p.dataset.defaultLabel=p.textContent||"HO CONCLUSO LA PRODUZIONE"),h?(p.classList.add("isBusy"),p.setAttribute("aria-disabled","true"),p.disabled=!0,p.innerHTML=`<span class="btnLabel"><span class="miniSpinner" aria-hidden="true"></span>${A}</span>`):(p.classList.remove("isBusy"),p.removeAttribute("aria-disabled"),p.disabled=i.size===0,p.innerHTML=p.dataset.defaultLabel,p.style.opacity=p.disabled?".6":"1"))},S=()=>{p&&(p.classList.add("isBusy"),p.disabled=!0,p.setAttribute("aria-disabled","true"),p.innerHTML='<span class="btnLabel">Concluso</span>',p.style.opacity=".92")},w=async()=>{try{if(!n)return!1;const h=(n.lines||[]).filter(L=>!dn(L)).length;if(h<=0)return!1;const A=new Set;for(const L of r.history||[]){if(!L||!(String(L.orderNo||"")===String(e.orderNo||"")||L.orderKey&&L.orderKey===m))continue;const T=Array.isArray(L.concludedLineKeys)?L.concludedLineKeys:[];for(const E of T)E&&A.add(String(E))}return A.size>=h}catch{return!1}};p&&!p.__handlerBound&&(p.__handlerBound=!0,globalThis.__CONCLUDE_HANDLER_BOUND__=!0,p.addEventListener("click",async()=>{if(!i.size)return;const h=Date.now();if(y.get(m)===!0||h-(b.get(m)||0)<2500)return;y.set(m,!0),b.set(m,h);let A=!1;try{if(v(!0,"Conclusione\u2026"),await w()){S(),C("Ordine gi\xE0 concluso",`Ordine n. ${e.orderNo} \xB7 ${e.customer}`),A=!0;return}const L=i.size===o.size;if(!!e.isFullOrderStart&&L&&!confirm("Stai concludendo l\u2019intero ordine. Confermi?"))return;const T=e.startedAt?new Date(e.startedAt).getTime():Date.now(),E=Date.now()-T;let N=0;const O=[];if(n){const z=new Map(n.lines.map($=>[$.lineKey,$]));for(const $ of i){const M=z.get($);if(!M)continue;const Z=s.get($),F=Z!=null&&String(Z).trim()!==""?Number(String(Z).replace(",",".")):NaN,I=Number(M.qty||0),ie=Number.isFinite(F)?F:Number.isFinite(I)?I:M.lineKg||0;N+=ie,O.push({lineKey:$,desc:M.desc,code:M.code||"",plannedKg:Number(M.lineKg||0),producedKg:Number(ie||0),qty:M.qty,um:M.um||""})}}else N=Number(e.totalKg||0);const P=`${e.customer} \xB7 Ordine n. ${e.orderNo} \xB7 ${Math.round(N)} kg`;A=!!await new Promise(z=>{Oa(P,async $=>{await qo(e.id,{concluded:!0});const M={orderKey:m,operator:r.user?.fullName||e.operator||"Operatore",operatorUid:r.user?.uid||"",customer:e.customer,orderNo:e.orderNo,kg:N,durationMs:E,startedAt:e.startedAt||W(),endedAt:W(),concludedLineKeys:Array.from(i),totalKgOrder:Number(e.totalKg||0),perLine:O,signature:$,statementAccepted:!0},Z=await Sr(M),F={...M,id:Z||`${Date.now()}_${Math.random().toString(16).slice(2)}`,at:W()};try{const I=`[Hub Polveri] Ordine concluso ${M.orderNo||""} \u2022 ${M.customer||""}`,ie=[`Ordine: ${M.orderNo||"\u2014"}`,`Cliente: ${M.customer||"\u2014"}`,`Operatore: ${M.operator||r.user?.fullName||"\u2014"}`,`Inizio: ${M.startedAt||"\u2014"}`,`Fine: ${M.endedAt||"\u2014"}`,`Totale ordine (kg): ${Number(M.totalKgOrder||0).toFixed(2)}`,`Kg prodotto (questa chiusura): ${Number(M.kgProduced||0).toFixed(2)}`,"Linea: polveri",`Firma: ${M.signature?"Acquisita su hub (storico produzione)":"Non presente"}`].join(`
`),Ce=M.signature?`
                  <div style="font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial; font-size:14px; color:#111;">
                    <div style="font-weight:800; margin-bottom:6px;">Firma operatore</div>
                    <img src="${M.signature}" alt="Firma" style="max-width:320px; width:100%; border:1px solid rgba(0,0,0,.12); border-radius:12px;"/>
                  </div>`:null;await Wt(I,ie,Ce)}catch{}try{await nt({type:"close",action:"Chiusura ordine",description:`Ordine n. ${M.orderNo} \xB7 ${M.customer}`,orderNo:M.orderNo,customer:M.customer,meta:`${i.size} righe \xB7 ${Math.round(N||0)} kg`,extra:{durationMs:E}})}catch{}r.history=[...r.history||[],F],r.historyReady=!0;try{await gs(1,N)}catch{}try{rt()}catch{}r.activeProductions=(r.activeProductions||[]).filter(I=>I.id!==e.id);try{r.partialOrders=Re().partial}catch{}Y(),Le();try{await ca(r.user?.uid||"",r.user?.fullName||e.operator||"Operatore",N)}catch{}Lt(`Ordine concluso da ${r.user?.fullName||e.operator||"Operatore"} \xB7 ordine ${e.orderNo} \xB7 cliente ${e.customer}`),C("Produzione conclusa",`Operatore ${r.user?.fullName||e.operator||"Operatore"} \xB7 Ordine n. ${e.orderNo} \xB7 ${Math.round(N)} kg`),C("Ordine concluso",`Ordine n. ${e.orderNo} registrato tra i conclusi.`,2200),Pt(),S(),p.blur?.(),z(!0)},()=>z(!1))})}catch(L){console.error("Errore conclusione",L),C("Errore conclusione","Riprova tra poco o verifica la connessione.")}finally{y.set(m,!1),A||v(!1,p?.dataset?.defaultLabel||"HO CONCLUSO LA PRODUZIONE")}}),(async()=>await w()&&S())()),u()}function ki(){c("partialModal").classList.add("show"),G(),Ai()}function Ei(){c("partialModal").classList.remove("show"),q()}const x={canvas:null,ctx:null,drawing:!1,empty:!0,last:{x:0,y:0},dpr:1};function Ma(){if(x.canvas){x.resize?.();return}x.canvas=c("signCanvas"),x.canvas.style.touchAction="none",x.canvas.style.pointerEvents="auto",x.ctx=x.canvas.getContext("2d"),x.ctx.lineCap="round",x.ctx.lineJoin="round",x.ctx.lineWidth=3.2,x.ctx.strokeStyle="#000";function e(){const s=x.canvas.getBoundingClientRect();x.dpr=Math.max(1,window.devicePixelRatio||1),x.canvas.width=Math.floor(s.width*x.dpr),x.canvas.height=Math.floor(s.height*x.dpr),x.ctx.setTransform(x.dpr,0,0,x.dpr,0,0),x.ctx.clearRect(0,0,s.width,s.height),x.empty=!0}x.resize=e,e(),window.addEventListener("resize",e);function t(s){const a=x.canvas.getBoundingClientRect(),d=s.touches&&s.touches[0]?s.touches[0]:s;return{x:d.clientX-a.left,y:d.clientY-a.top}}function n(s){s.preventDefault(),x.drawing=!0;const a=t(s);x.last=a}function o(s){if(!x.drawing)return;s.preventDefault();const a=t(s);x.ctx.beginPath(),x.ctx.moveTo(x.last.x,x.last.y),x.ctx.lineTo(a.x,a.y),x.ctx.stroke(),x.last=a,x.empty=!1}function i(s){x.drawing&&(s.preventDefault(),x.drawing=!1)}x.canvas.addEventListener("pointerdown",n),x.canvas.addEventListener("pointermove",o),window.addEventListener("pointerup",i),x.canvas.addEventListener("touchstart",n,{passive:!1}),x.canvas.addEventListener("touchmove",o,{passive:!1}),window.addEventListener("touchend",i,{passive:!1})}function Ni(){if(!x.canvas)return;const e=x.canvas.getBoundingClientRect();x.ctx.clearRect(0,0,e.width,e.height),x.empty=!0}function Oa(e,t,n){Ma(),c("signCheck").checked=!1,c("signContext").textContent=e,Ni(),c("signModal").classList.add("show"),G(),requestAnimationFrame(()=>x.resize?.());let o=!1;const i=(s=!1)=>{o||(o=!0,c("signModal").classList.remove("show"),q(),c("signOk").onclick=null,s&&typeof n=="function"&&n())};c("signClose").onclick=()=>i(!0),c("signClear").onclick=()=>Ni(),c("signOk").onclick=()=>{if(!c("signCheck").checked){C("Conferma richiesta","Spunta la dichiarazione prima di concludere.");return}if(x.empty){C("Firma richiesta","Inserisci la firma prima di concludere.");return}const s=x.canvas.toDataURL("image/png");i(),t(s)}}function $a(){return/iphone|ipad|ipod/i.test(navigator.userAgent||"")}function ml(){return window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches}function be(){const e=c("dotPush"),t=c("txtPush");if(!e||!t)return;const n=typeof Notification<"u"?Notification.permission:"unsupported";if(r.push.permission=n,!r.push.supported){e.className="dot",t.textContent="Notifiche: non supportate";return}if(n!=="granted"){e.className="dot",t.textContent="Notifiche: disattive";return}e.className="dot ok",t.textContent="Notifiche: attive"}async function xi(){if(!("serviceWorker"in navigator))throw new Error("Service worker non supportati");const e=new URL("firebase-messaging-sw.js",location.href).toString();return await navigator.serviceWorker.register(e,{scope:"./"})}async function Da(e){if(!r.firebase.ok)return;const t=r.firebase.api,n=r.firebase.db,o=r.user||{},i=await Mi(e),s=t.doc(n,"powderPushTokens",i);await t.setDoc(s,{token:e,uid:o.uid||"",email:o.email||"",displayName:o.fullName||o.displayName||"",role:o.isAdmin?"admin":"operator",line:"polveri",userAgent:navigator.userAgent||"",platform:$a()?"ios":/android/i.test(navigator.userAgent||"")?"android":"desktop",enabled:!0,lastSeenAt:t.serverTimestamp(),createdAt:t.serverTimestamp()},{merge:!0})}async function Ba(e){if(!r.firebase.ok)return;const t=r.firebase.api,n=r.firebase.db,o=await Mi(e);try{await t.deleteDoc(t.doc(n,"powderPushTokens",o))}catch{}}async function Mi(e){const t=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(o=>o.toString(16).padStart(2,"0")).join("")}async function Ia(){if(!r.push.supported){C("Notifiche non supportate","Questo browser/dispositivo non supporta le push per questa app.");return}const e=await Notification.requestPermission();if(r.push.permission=e,e!=="granted"){C("Notifiche non abilitate","Permesso negato o non concesso."),be();return}try{const t=r.firebase.msgApi,n=r.firebase.messaging,o=await xi(),i=await t.getToken(n,{vapidKey:Gn,serviceWorkerRegistration:o});if(!i){C("Errore notifiche","Token non generato. Controlla VAPID key in Firebase Console."),be();return}r.push.token=i,r.push.enabled=!0,await Da(i);try{t.onMessage(n,s=>{const a=s?.notification?.title||"Aggiornamento",d=s?.notification?.body||"";C(a,d||"Nuova notifica");try{beep()}catch{}})}catch{}be(),C("Notifiche attive","Perfetto: questo dispositivo ricever\xE0 notifiche anche ad app chiusa.")}catch(t){console.warn(t),C("Errore notifiche",String(t?.message||t)),be()}}async function Pa(){try{if(Notification.permission!=="granted"){C("Gi\xE0 disattive","Su questo dispositivo le push non risultano attive."),be();return}const t=r.firebase.msgApi,n=r.firebase.messaging,o=await xi(),i=await t.getToken(n,{vapidKey:Gn,serviceWorkerRegistration:o}).catch(()=>null);i&&(await t.deleteToken(n).catch(()=>{}),await Ba(i)),r.push.token="",r.push.enabled=!1,be(),C("Notifiche disattivate","Ok, questo dispositivo non ricever\xE0 pi\xF9 push.")}catch(e){console.warn(e),C("Errore","Impossibile disattivare le notifiche su questo dispositivo.")}}function Fa(){const e=c("pillPush");e&&e.addEventListener("click",()=>{Ca()})}function Ra(e){return e?(e.innerText||"").replace(/\s+\n/g,`
`).replace(/\n{3,}/g,`

`).trim():""}function Oi(){return Array.from(document.querySelectorAll("style")).map(e=>e.textContent||"").join(`
`)}function za(e){return String(e||"").replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Ka(e,t){const n=Oi?Oi():"",o=document.createElement("iframe");o.setAttribute("aria-hidden","true"),o.style.position="fixed",o.style.right="0",o.style.bottom="0",o.style.width="0",o.style.height="0",o.style.border="0";const i=`<!doctype html><html><head><meta charset="utf-8">
      <title>${za(t||"Stampa")}</title>
      
    </head><body>${e.outerHTML}</body></html>`;o.srcdoc=i,o.onload=()=>{try{o.contentWindow.focus(),o.contentWindow.print()}catch{}setTimeout(()=>o.remove(),600)},document.body.appendChild(o)}async function Ha({title:e,text:t}={}){const n=e||document.title||"Report",o=t||"";if(navigator.share){await navigator.share({title:n,text:o});return}try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(o);else{const i=document.createElement("textarea");i.value=o,i.setAttribute("readonly",""),i.style.position="absolute",i.style.left="-9999px",document.body.appendChild(i),i.select(),document.execCommand("copy"),i.remove()}try{C("Copiato","Testo condiviso copiato negli appunti.")}catch{alert("Copiato")}}catch{try{C("Condivisione non riuscita","Impossibile condividere il testo.")}catch{}}}document.addEventListener("click",async e=>{const t=e.target.closest("button[data-action]");if(!t||(e.preventDefault(),e.stopPropagation(),!!!(r&&r.user&&r.user.isAdmin)))return;const o=document.querySelector(t.dataset.target);if(!o)return;const i=new Date().toLocaleString("it-IT"),s=(o.querySelector(".cardTitle, .title, h2, h3")?.innerText||"Report").trim();if(t.dataset.action==="print"){Ka(o,s);return}if(t.dataset.action==="share"){const a=Ra(o);await Ha({title:s,text:`${s}
${i}

${a}`});return}});function at(e){const o=String(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^A-Za-z\s]/g," ").replace(/\s+/g," ").trim().toUpperCase().split(" ").filter(i=>i&&i.length>=2);return{normalized:o.join(" ").trim(),tokens:o}}function Ua(e){const t=String(e||""),n=t.match(/\b(20[0-9]{2})[-/.](0[1-9]|1[0-2])\b/),o=n?`${n[1]}-${n[2]}`:null,i=t.match(/(?:netto|paga|compenso)[^0-9]{0,12}([0-9]{1,3}(?:[.][0-9]{3})*(?:,[0-9]{2})?)/i)||t.match(/([0-9]{1,3}(?:[.][0-9]{3})*(?:,[0-9]{2}))\s*(?:‚Ç¨|euro|eur)/i),s=i?i[1]:null;let a=null;if(s){const l=s.replace(/\./g,"").replace(/,/g,"."),u=parseFloat(l);Number.isFinite(u)&&(a=Math.round(u*100))}let d=null;const f=t.match(/\b([A-Z√Ä-√ú]{2,}(?:\s+[A-Z√Ä-√ú]{2,}){1,4})\b/);return f&&(d=f[1].replace(/\s+/g," ").trim()),{monthKey:o,netPayText:s,netPayCents:a,fullName:d}}function qa(e,t,n){const o=at(e),i=at(t),s=at(n||"").normalized,a=new Set(o.tokens),d=new Set(i.tokens),f=Array.from(a).filter(y=>d.has(y)),l=a.size?f.length/a.size:0,u=o.tokens[o.tokens.length-1]||"",m=u&&d.has(u),g=s.includes(o.normalized)?.25:0;let p=l+(m?.2:-.3)+g;return p=Math.max(0,Math.min(1,p)),{score:p,tokenOverlap:l,lastNameMatch:m,extractedTokens:i.tokens}}function Wa(e,t){const n=[],o=Array.isArray(e)?e:[];for(const i of o){const s=String(i?.rawText||""),a=i?.fields||null,d=!a||!a.monthKey||!a.netPayText||!a.fullName?Ua(s):{},f=a&&a.fullName||d.fullName||"",l=a&&a.monthKey||d.monthKey||null,u=a&&a.netPayText||d.netPayText||null,m=a&&a.netPayCents!=null?a.netPayCents:d.netPayCents??null,g=at(f).tokens;let p="OK";(!g||g.length<2)&&(p="NO_NAME_FOUND"),l||(p="MISSING_MONTHKEY"),u||(p=p==="OK"?"MISSING_NETPAY":p);let y=null,b=null;for(const N of t||[]){const O=[N.displayName,...Array.isArray(N.payrollAliases)?N.payrollAliases:[]].filter(Boolean);for(const P of O){const B=qa(P,f||s,s);!y||B.score>y.score?(b=y,y={...B,user:N}):(!b||B.score>b.score)&&(b={...B,user:N})}}let v="unmatched",S=null;const w=y?.score||0,h=b?.score||0,A=w-h,L=y?.lastNameMatch,k=y?.extractedTokens||[],T=y?k.filter(N=>at(y.user.displayName).tokens.includes(N)):[],E=T.length>=2||L&&T.length>=2;p==="OK"&&L&&E&&w>=.88&&A>=.08?(v="matched",S={uid:y.user.uid||y.user.id||"",displayName:y.user.displayName||"",score:w},p="OK"):p==="OK"&&w>=.8?(v="ambiguous",p="AMBIGUOUS"):p==="OK"&&(p="LOW_SCORE"),n.push({pageIndex:i?.pageIndex??n.length,extracted:{fullName:f||"",monthKey:l,netPayText:u,netPayCents:m},match:S,status:v,reasonCode:p,rawText:s,fields:a||null,confidence:i?.confidence??null})}return n}function Va(e){const t=new Map;for(const o of e||[]){if(o.status!=="matched"||!o.match)continue;const i=`${o.match.uid||""}__${o.extracted.monthKey||""}`;t.has(i)||t.set(i,{uid:o.match.uid||"",displayName:o.match.displayName||"",monthKey:o.extracted.monthKey||"",netPayText:o.extracted.netPayText||"",netPayCents:o.extracted.netPayCents||null,matchScore:o.match.score||0,pageIndices:[]});const s=t.get(i);s.pageIndices.push(o.pageIndex),!s.netPayText&&o.extracted.netPayText&&(s.netPayText=o.extracted.netPayText),s.netPayCents==null&&o.extracted.netPayCents!=null&&(s.netPayCents=o.extracted.netPayCents),o.match.score>s.matchScore&&(s.matchScore=o.match.score)}const n=Array.from(t.values());return n.forEach(o=>o.pageIndices.sort((i,s)=>i-s)),n}async function Ga(e,t){const{PDFDocument:n}=await import("https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"),o=await n.load(e),i=await n.create();return(await i.copyPages(o,t)).forEach(d=>i.addPage(d)),await i.save()}async function ja(e,t,n){if(!(r.firebase&&r.firebase.storage&&r.firebase.storageApi))throw new Error("Storage non disponibile");const o=r.firebase.storageApi,i=r.firebase.storage,s=`payroll/${t}/${e}.pdf`,a=o.ref(i,s),d=await o.uploadBytes(a,n,{contentType:"application/pdf"}),f=await o.getDownloadURL(d.ref);return{path:s,url:f}}async function Ya(e){const t=r.firebase.api,n=r.firebase.db,o=`${e.uid}_${e.monthKey}`,i=t.doc(n,"payrollDocs",o);await t.setDoc(i,{...e,updatedAt:t.serverTimestamp(),createdAt:e.createdAt||t.serverTimestamp()},{merge:!0})}async function Za(e){try{const t=r.firebase.api,n=r.firebase.db,o=t.collection(n,"payrollIngestLogs");await t.addDoc(o,e)}catch{}}function $i(){try{const e=document.querySelector(".desktopCol.mainCol")||document.querySelector(".mainCol")||document.querySelector(".grid");if(e&&!document.getElementById("payrollUserCard")){const n=document.createElement("div");n.className="payrollCard",n.id="payrollUserCard",n.innerHTML=`
          <div class="pcHead">
            <div>
              <div class="pcTitle">Busta paga</div>
              <div class="pcSub">Consulta le tue buste paga in stile Apple.</div>
            </div>
            <div class="pcBadge" id="payrollUserBadge">Live</div>
          </div>
          <div class="pcBody">
            <div class="pcActionRow">
              <button class="payrollBtn primary" id="btnOpenPayrollUser" type="button">Apri buste paga</button>
              <div class="pcHint" id="payrollUserHint">Accesso riservato al tuo profilo.</div>
            </div>
          </div>`;const o=document.getElementById("opsCard")||document.querySelector(".heroCard");o&&o.parentElement===e?o.insertAdjacentElement("afterend",n):e.appendChild(n)}const t=document.getElementById("adminMobileStack")||document.querySelector(".adminMobileStack");if(t&&!document.getElementById("payrollAdminCard")){const n=document.createElement("div");n.className="payrollCard adminOnly",n.id="payrollAdminCard",n.innerHTML=`
          <div class="pcHead">
            <div>
              <div class="pcTitle">Upload buste paga</div>
              <div class="pcSub">Carica PDF, estrai con Gemini e invia.</div>
            </div>
            <div class="pcBadge" id="payrollAdminStatus">IDLE</div>
          </div>
          <div class="pcBody">
            <div class="pcActionRow">
              <button class="payrollBtn primary" id="btnOpenPayrollAdmin" type="button">Apri upload</button>
              <button class="payrollBtn secondary" id="btnPayrollReloadUsers" type="button">Ricarica utenti</button>
              <div class="pcHint">Solo admin.</div>
            </div>
          </div>`,t.insertBefore(n,t.firstChild)}}catch{}}function lt(){const e=!!(r.user&&r.user.isAdmin),t=c("payrollAdminCard");t&&(t.style.display=e?"":"none");const n=c("payrollUserBadge"),o=c("payrollUserHint"),i=r.payroll?.userView||{};if(n){const a=i.months?.[0]||"\u2014";n.textContent=i.ready?`Ultimo: ${a||"\u2014"}`:"Sync"}o&&(i.error?(o.textContent=i.error,o.style.color="var(--bad)"):o.textContent="Accesso riservato al tuo profilo.");const s=c("payrollAdminStatus");if(s){const a=r.payroll?.admin?.step||"idle";s.textContent=a.toUpperCase()}}function ne(e){const t=r.payroll.admin;t.step=e;const n={idle:c("payrollStepIdle"),extracting:c("payrollStepExtract"),preview:c("payrollStepPreview"),match:c("payrollStepMatch"),sending:c("payrollStepSending")};Object.entries(n).forEach(([i,s])=>{s&&(s.style.display=i===e?"flex":"none")});const o=c("payrollAdminStepLabel");o&&(o.textContent=e.charAt(0).toUpperCase()+e.slice(1))}function ct(){const e=c("payrollAdminFileLabel");if(!e)return;const t=r.payroll.admin.files?.[0];e.textContent=t?t.name:"Nessun file"}function Di(){const e=r.payroll.admin.gemini.pages||[],t=c("payrollPreviewTable"),n=c("payrollMissingPages"),o=c("payrollMissingList");if(!t)return;const i="<tr><th>#</th><th>Nome</th><th>Mese</th><th>Netto</th><th>Conf.</th><th>Snippet</th><th>Stato</th></tr>",s=e.map(l=>{const u=l.fields||{},m=l.errorReason?"tone-bad":!u.fullName||!u.monthKey||!u.netPayText?"tone-warn":"tone-ok",g=l.errorReason?"ERRORE":!u.fullName||!u.monthKey||!u.netPayText?"CAMPI MANCANTI":"OK",p=String(l.rawText||"").slice(0,180).replace(/\s+/g," ").trim();return`<tr><td>${l.pageIndex}</td><td>${_(u.fullName||"\u2014")}</td><td>${_(u.monthKey||"\u2014")}</td><td>${_(u.netPayText||"\u2014")}</td><td>${l.confidence!=null?(l.confidence*100).toFixed(0)+"%":"\u2014"}</td><td><div class="snippet">${_(p)}</div></td><td><span class="badgeTone ${m}">${g}</span></td></tr>`}).join("");t.innerHTML=i+s;const a=e.filter(l=>!l.fields||!l.fields.monthKey||!l.fields.netPayText);n&&(n.style.display=a.length?"block":"none",o&&(o.textContent=a.map(l=>l.pageIndex).join(", ")));const d=c("payrollPreviewMeta");d&&(d.textContent=`${e.length} pagine dal file`);const f=c("payrollPreviewBadge");f&&(f.textContent=a.length?"Campi mancanti":"OK")}function Bi(){const e=r.payroll.admin.match||{},t=c("payrollMatchedList"),n=c("payrollUnmatchedList");if(t){const f=e.grouped||[];t.innerHTML=f.length?f.map(l=>`<div class="row"><div><div class="pcTitle" style="font-size:15px;">${_(l.displayName||"Utente")}</div><div class="meta">Mese ${_(l.monthKey||"\u2014")} \xB7 Pagine: ${l.pageIndices.join(", ")}</div></div><div class="badgeTone tone-ok">${l.matchScore?l.matchScore.toFixed(2):""}</div></div>`).join(""):'<div class="pcHint">Nessun match.</div>'}if(n){const f=e.unmatched||[];n.innerHTML=f.length?f.map(l=>`<div class="row"><div><div class="pcTitle" style="font-size:15px;">Pagina ${l.pageIndex}</div><div class="meta">${_(l.reasonCode||"?")} \xB7 ${_(l.extracted.monthKey||"\u2014")} \xB7 ${_(l.extracted.netPayText||"\u2014")}</div><div class="snippet">${_(String(l.rawText||"").slice(0,140))}</div></div><div class="badgeTone ${l.status==="ambiguous"?"tone-warn":"tone-bad"}">${l.status}</div></div>`).join(""):'<div class="pcHint">Tutte le pagine matchate.</div>'}const o=c("payrollMatchOk"),i=c("payrollMatchAmbig"),s=c("payrollMatchNo");o&&(o.textContent=e.matchedCount||0),i&&(i.textContent=e.ambiguousCount||0),s&&(s.textContent=e.unmatchedCount||0);const a=c("payrollAdminMatchLabel");a&&(a.textContent=`Matchati ${e.matchedCount||0}`);const d=c("btnPayrollSend");d&&(d.disabled=!(e.matchedCount>0)||e.ambiguousCount>0)}async function dt(){if(!(r.firebase?.ok&&r.user&&r.user.isAdmin))return;const e=r.payroll.admin;if(!e.loadingUsers&&!(e.users&&e.users.length)){e.loadingUsers=!0;try{const t=r.firebase.api,n=r.firebase.db,o=await t.getDocs(t.query(t.collection(n,"powderUsers"),t.where("enabled","==",!0)));e.users=o.docs.map(i=>({id:i.id,uid:i.id,...i.data()}))}catch(t){console.warn("load payroll users",t)}e.loadingUsers=!1}}async function Ft(){if(!(r.firebase?.ok&&r.user))return;const e=r.payroll.userView;e.loading=!0;try{const t=r.firebase.api,n=r.firebase.db,i=(await t.getDocs(t.query(t.collection(n,"payrollDocs"),t.where("uid","==",r.user.uid),t.orderBy("monthKey","desc")))).docs.map(s=>({id:s.id,...s.data()||{}}));e.docs=i,e.months=i.map(s=>s.monthKey).filter(Boolean),e.selectedMonth=e.selectedMonth||e.months[0]||"",e.error="",e.ready=!0}catch(t){console.warn("load payroll docs error",t),e.error="Storico non disponibile"}e.loading=!1,lt(),Ii()}function Ii(){const e=r.payroll.userView,t=c("payrollMonthSelect");t&&(t.innerHTML=e.months.map(n=>`<option value="${_(n)}">${_(n)}</option>`).join(""),e.selectedMonth&&(t.value=e.selectedMonth),t.onchange=()=>{e.selectedMonth=t.value,Pi()}),Pi()}async function Pi(){const e=r.payroll.userView,t=e.docs.find(f=>f.monthKey===e.selectedMonth)||e.docs[0];if(!t){const f=c("payrollUserNet");f&&(f.textContent="Nessuna busta paga");return}e.selectedMonth=t.monthKey;const n=c("payrollUserMonthBadge");n&&(n.textContent=t.monthKey);const o=c("payrollUserAmountBadge");o&&(o.textContent=t.netPayText||"\u2014");const i=c("payrollUserNet");i&&(i.textContent=`Questo mese hai guadagnato: ${t.netPayText||"\u2014"}`);const s=c("payrollUserDocMeta");s&&(s.textContent=`Documento: ${t.monthKey}`);const a=c("payrollUserDate");a&&(a.textContent=t.updatedAt?"Aggiornato":"Caricato");const d=c("payrollUserPdfFrame");if(d)try{const f=r.firebase.storageApi,l=r.firebase.storage;if(!(f&&l)){d.src="",e.currentUrl="";return}if(t.storagePath){const u=await f.getDownloadURL(f.ref(r.firebase.storage,t.storagePath));d.src=u,e.currentUrl=u}else d.src="",e.currentUrl=""}catch(f){console.warn("load payroll pdf",f),d.src=""}}function Fi(){c("payrollUserModal").style.display="flex",Ii(),G()}function Ri(){c("payrollUserModal").style.display="none",q()}function zi(){c("payrollAdminModal").style.display="flex",G(),lt()}function Ki(){c("payrollAdminModal").style.display="none",q()}function In(){const e=r.payroll.admin;e.files=[],e.originalPdfBytes=null,e.gemini={loading:!1,error:"",pages:[]},e.match={pages:[],grouped:[],unmatched:[],matchedCount:0,ambiguousCount:0,unmatchedCount:0},e.sendSummary=null,e.sourceFileName="",e.sourceFileHash="",ne("idle"),ct(),Di(),Bi()}const Qa="https://gemini-pdf-extract-537555699968.europe-west1.run.app/extract";async function Hi(){const e=r.payroll.admin,t=e.files?.[0];if(!t){C("Seleziona PDF","Carica prima un file.");return}ne("extracting"),e.gemini={loading:!0,error:"",pages:[]};try{const n=new FormData;n.append("file",t);const o=await fetch(Qa,{method:"POST",body:n});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json();e.gemini.pages=Array.isArray(i.pages)?i.pages:[],e.sourceFileName=i.sourceFileName||t.name;const s=await t.arrayBuffer();e.originalPdfBytes=s;const a=await crypto.subtle.digest("SHA-256",s);e.sourceFileHash=Array.from(new Uint8Array(a)).map(d=>d.toString(16).padStart(2,"0")).join(""),ne("preview"),Di()}catch(n){e.gemini.error=n?.message||String(n),C("Estrazione fallita",e.gemini.error),ne("idle")}finally{e.gemini.loading=!1}}async function Ja(){const e=r.payroll.admin,t=e.gemini.pages||[];if(!t.length){C("Nessuna pagina","Esegui prima l\u2019estrazione.");return}await dt();const n=Wa(t,e.users||[]),o=Va(n),i=n.filter(d=>d.status!=="matched"),s=n.filter(d=>d.status==="matched").length,a=n.filter(d=>d.status==="ambiguous").length;e.match={pages:n,grouped:o,unmatched:i,matchedCount:s,ambiguousCount:a,unmatchedCount:i.length},Bi(),ne("match")}async function Xa(){const e=r.payroll.admin;if(!(e.match?.matchedCount>0)){C("Nessun match","Devi avere almeno un match valido.");return}if(!e.originalPdfBytes){C("PDF mancante","Riesegui l\u2019estrazione."),ne("preview");return}ne("sending");const t={matched:e.match.matchedCount||0,ambiguous:e.match.ambiguousCount||0,unmatched:e.match.unmatchedCount||0},n=e.match.grouped||[];try{for(const i of n){const s=(e.users||[]).find(y=>(y.uid||y.id)===i.uid)||{},a=r.firebase.api,d=r.firebase.db,f=`${i.uid}_${i.monthKey}`,l=await a.getDoc(a.doc(d,"payrollDocs",f)),u=l.exists()?l.data()||{}:null,m=u&&u.sourceFileHash===e.sourceFileHash,g=u&&Array.isArray(u.pageIndices)&&u.pageIndices.join(",")===i.pageIndices.join(",");let p={path:u?.storagePath||`payroll/${i.monthKey}/${i.uid}.pdf`,url:u?.downloadUrl};if(!m||!g){const y=await Ga(e.originalPdfBytes,i.pageIndices);p=await ja(i.uid,i.monthKey,y)}await Ya({uid:i.uid,emailLower:(s.emailLower||s.email||"").toLowerCase(),fullName:i.displayName||s.displayName||"",monthKey:i.monthKey,netPayCents:i.netPayCents,netPayText:i.netPayText,storagePath:p.path,source:"gemini",sourceFileName:e.sourceFileName,sourceFileHash:e.sourceFileHash,pageIndices:i.pageIndices,matchScore:i.matchScore})}await Za({createdAt:r.firebase.api.serverTimestamp(),adminUid:r.user?.uid||"",sourceFileName:e.sourceFileName,sourceFileHash:e.sourceFileHash,totalPages:e.gemini.pages?.length||0,matchedCount:t.matched,ambiguousCount:t.ambiguous,unmatchedCount:t.unmatched,details:e.match.pages}),t.status="ok",C("Inviato","Buste paga inviate."),await Ft()}catch(i){console.warn("payroll send error",i),t.status=i?.message||String(i),C("Errore invio",t.status)}e.sendSummary=t;const o=c("payrollSendSummary");o&&(o.textContent=`Esito: ${t.status||"\u2014"} \xB7 OK ${t.matched} \xB7 Ambigui ${t.ambiguous} \xB7 Non matchati ${t.unmatched}`)}async function el(){Vt(),ne("idle"),ct(),lt(),await Ft(),r.user?.isAdmin&&await dt()}async function tl(){if($i(),globalThis.__HUB_BOOTED__)return;globalThis.__HUB_BOOTED__=!0,Ko(),vr();try{Mo.addEventListener("change",Je)}catch{try{Mo.addListener(Je)}catch{}}Je(),Ao(),yo(),To(),ve(),window.addEventListener("resize",ve),window.addEventListener("resize",zs),window.addEventListener("resize",Lo),window.addEventListener("resize",Ze),window.addEventListener("orientationchange",Lo),window.addEventListener("orientationchange",ve),window.addEventListener("orientationchange",Ze);try{$e&&$e.addEventListener("change",ve)}catch{try{$e&&$e.addListener(ve)}catch{}}ua(),c("btnGoProd").addEventListener("click",()=>Kr());try{const s=c("partialBanner");s?.addEventListener("click",()=>ki()),s?.addEventListener("keydown",a=>{(a.key==="Enter"||a.key==="")&&(a.preventDefault(),ki())})}catch{}try{c("partialClose").addEventListener("click",()=>Ei())}catch{}try{c("partialModal").addEventListener("click",s=>{s.target===c("partialModal")&&Ei()})}catch{}c("prodStrip").addEventListener("click",()=>Bn());try{c("cancelBannerClose").addEventListener("click",()=>Eo())}catch{}c("prodModalClose").addEventListener("click",()=>Na()),c("runningClose").addEventListener("click",()=>{c("runningModal").classList.remove("show"),q()});try{c("histClose").addEventListener("click",()=>{c("histModal").classList.remove("show"),q()}),c("histModal").addEventListener("click",s=>{s.target===c("histModal")&&(c("histModal").classList.remove("show"),q())})}catch{}try{c("whModalClose")?.addEventListener("click",()=>xn()),c("whModal")?.addEventListener("click",s=>{s.target===c("whModal")&&xn()})}catch{}window.addEventListener("keydown",s=>{s.key==="Escape"&&xn()});try{c("notifClose").addEventListener("click",()=>$n()),c("notifModal").addEventListener("click",s=>{s.target===c("notifModal")&&$n()})}catch{}try{c("btnNotifCompleted").addEventListener("click",()=>ka())}catch{}try{c("btnTogglePush").addEventListener("click",()=>Ea())}catch{}try{c("btnSendNotif").addEventListener("click",async()=>{const s=c("notifAdminFeedback");if(!(r.user&&r.user.isAdmin)){C("Solo admin","Non hai i permessi per inviare notifiche."),s&&(s.textContent="Permesso mancante.");return}const a=(c("notifTitle")?.value||"").trim(),d=(c("notifBodyInput")?.value||"").trim();if(!a||!d){C("Testo mancante","Inserisci titolo e testo della notifica."),s&&(s.textContent="Titolo e testo obbligatori.");return}s&&(s.textContent="Invio\u2026");try{await wi(a,d),s&&(s.textContent="Notifica inviata.");const f=c("notifBodyInput");f&&(f.value="")}catch(f){console.warn("send notif error",f),s&&(s.textContent="Invio non riuscito (permessi o rete)."),C("Invio non riuscito","Controlla i permessi Firestore o la rete.")}})}catch{}c("fatValue").addEventListener("click",()=>{const s=c("fatValue"),a=!!(r.user&&r.user.isAdmin),d=window.matchMedia("(min-width: 980px)").matches;if(a||d){s.classList.add("reveal"),Nt();return}s.classList.toggle("reveal"),Nt()});const e="+393516709334";c("btnCallMatteoBig")?.addEventListener("click",()=>{window.location.href=`tel:${e}`}),c("btnCallMatteo").addEventListener("click",()=>{window.location.href=`tel:${e}`}),c("btnOpenStats").addEventListener("click",()=>{C("Statistiche","Sezione statistiche completa in fondo alla pagina."),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})});try{c("btnMobileStats")?.addEventListener("click",s=>{s.preventDefault(),ya()})}catch{}try{c("btnSendAlert")?.addEventListener("click",async()=>{const s=c("alertFeedback");if(!!!(r.user&&r.user.isAdmin)){C("Solo admin","Non hai i permessi per inviare avvisi."),s&&(s.textContent="Permesso mancante.");return}const d=c("alertMessageInput"),f=c("alertExpireInput"),l=(d?.value||"").trim(),u=Number(f?.value||0),m=Number.isFinite(u)?Math.max(0,u):0,g=m>0?Date.now()+m*60*1e3:0;if(!l){C("Testo mancante","Inserisci il messaggio dell\u2019avviso."),s&&(s.textContent="Testo avviso obbligatorio.");return}if(!r.alertSaving){r.alertSaving=!0,s&&(s.textContent="Invio\u2026");try{await Ar(l,g),s&&(s.textContent="Avviso inviato."),d&&(d.value="")}catch(p){console.warn("send alert error",p),s&&(s.textContent="Invio non riuscito (permessi o rete)."),C("Invio non riuscito","Controlla permessi Firestore o la rete.")}finally{r.alertSaving=!1}}})}catch{}try{c("btnCancelAlert")?.addEventListener("click",async()=>{const s=c("alertFeedback");if(!!!(r.user&&r.user.isAdmin)){C("Solo admin","Non hai i permessi per annullare avvisi."),s&&(s.textContent="Permesso mancante.");return}if(!r.alertSaving){r.alertSaving=!0,s&&(s.textContent="Annullamento\u2026");try{await Tr(),Qe(),bt(),s&&(s.textContent="Avviso annullato.")}catch(d){console.warn("cancel alert error",d),s&&(s.textContent="Annullamento non riuscito (permessi o rete)."),C("Annullamento non riuscito","Controlla permessi Firestore o la rete.")}finally{r.alertSaving=!1}}})}catch{}c("btnHeaderPayrollUser")?.addEventListener("click",async()=>{await Ft(),Fi()}),c("btnHeaderPayrollAdmin")?.addEventListener("click",async()=>{if(!(r.user&&r.user.isAdmin)){C("Solo admin","Funzione riservata.");return}await dt(),zi()}),c("btnOpenPayrollUser")?.addEventListener("click",async()=>{await Ft(),Fi()}),c("payrollUserClose")?.addEventListener("click",()=>Ri()),c("payrollUserModal")?.addEventListener("click",s=>{s.target===c("payrollUserModal")&&Ri()}),c("btnPayrollPrint")?.addEventListener("click",()=>{const s=r.payroll.userView.currentUrl;if(!s){C("PDF non pronto","Seleziona un mese disponibile.");return}const a=window.open(s,"_blank");try{a?.print()}catch{}}),c("btnPayrollShare")?.addEventListener("click",async()=>{const s=r.payroll.userView.currentUrl;if(!s){C("PDF non pronto","Seleziona un mese disponibile.");return}try{navigator.share?await navigator.share({title:"Busta paga",url:s}):navigator.clipboard&&(await navigator.clipboard.writeText(s),C("Link copiato","URL copiato negli appunti."))}catch{C("Condivisione non riuscita","Riprovare.")}}),c("btnOpenPayrollAdmin")?.addEventListener("click",async()=>{if(!(r.user&&r.user.isAdmin)){C("Solo admin","Funzione riservata.");return}await dt(),zi()}),c("payrollAdminClose")?.addEventListener("click",()=>{Ki()}),c("payrollAdminModal")?.addEventListener("click",s=>{s.target===c("payrollAdminModal")&&Ki()}),c("btnPayrollReloadUsers")?.addEventListener("click",()=>dt());const t=c("payrollDrop"),n=c("payrollFileInput"),o=s=>{r.payroll.admin.files=s&&s.length?[s[0]]:[],ct()};t&&(["dragover","dragenter"].forEach(s=>t.addEventListener(s,a=>{a.preventDefault(),t.classList.add("drag")})),["dragleave","drop"].forEach(s=>t.addEventListener(s,a=>{a.preventDefault(),t.classList.remove("drag")})),t.addEventListener("drop",s=>{s.preventDefault(),s.dataTransfer?.files?.length&&o(s.dataTransfer.files)})),c("btnPayrollSelect")?.addEventListener("click",()=>n?.click()),n?.addEventListener("change",()=>o(n.files)),c("btnPayrollUpload")?.addEventListener("click",()=>Hi()),c("btnPayrollRetry")?.addEventListener("click",()=>Hi()),c("btnPayrollReset")?.addEventListener("click",()=>In()),c("btnPayrollReset2")?.addEventListener("click",()=>In()),c("btnPayrollReset3")?.addEventListener("click",()=>In()),c("btnPayrollMatch")?.addEventListener("click",()=>Ja()),c("btnPayrollBackPreview")?.addEventListener("click",()=>ne("preview")),c("btnPayrollSend")?.addEventListener("click",()=>Xa());const i=c("btnSendIssue");i&&i.addEventListener("click",async()=>{const s=c("issueText"),a=(s?.value||"").trim();if(!a){C("Segnalazione","Scrivi il problema prima di inviare.");return}if(!r.user){Se("Per inviare una segnalazione \xE8 necessario accedere.");return}const f={operator:r.user.fullName||"Operatore",operatorUid:r.user.uid,text:a,when:re(Date.now()),kind:"problema_macchina_o_prodotto",url:location.href,ua:navigator.userAgent};await Sn(f),s&&(s.value=""),C("Segnalazione registrata","Ok. La segnalazione \xE8 stata salvata. Per urgenze: usa \u201CChiama Matteo\u201D.",3200)}),document.addEventListener("visibilitychange",()=>{document.hidden||fn("focus")}),window.addEventListener("focus",()=>fn("focus")),window.addEventListener("pageshow",s=>{(s.persisted||!document.hidden)&&fn("pageshow")});try{window.matchMedia("(min-width: 980px)").addEventListener("change",()=>Nt())}catch{}document.documentElement.setAttribute("translate","no"),document.body.setAttribute("translate","no"),document.addEventListener("gesturestart",s=>s.preventDefault(),{passive:!1}),document.addEventListener("gesturechange",s=>s.preventDefault(),{passive:!1}),document.addEventListener("gestureend",s=>s.preventDefault(),{passive:!1}),document.addEventListener("wheel",s=>{s.ctrlKey&&s.preventDefault()},{passive:!1}),ne("idle"),ct(),await er();try{Fa(),be(),te(),he()}catch{}try{cr()}catch{}}await tl();
</script>

<script>(function(){function isDesk(){return window.matchMedia&&window.matchMedia("(min-width: 1024px)").matches;}
const wrap=document.querySelector(".wrap");function getScrollTop(){if(wrap){const oy=getComputedStyle(wrap).overflowY;if(oy&&oy!=="visible")return wrap.scrollTop||0;}
return window.scrollY||document.documentElement.scrollTop||0;}
function onScroll(){try{syncAlertSpacerHeight();}catch(_e){}}
window.addEventListener("resize",onScroll,{passive:true});window.addEventListener("pageshow",onScroll,{passive:true});onScroll();})();</script>

</body></html>
