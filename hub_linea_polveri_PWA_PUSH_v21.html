<!doctype html>
<html lang="it" translate="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="google" content="notranslate"/>
  <meta http-equiv="Content-Language" content="it"/>
  <meta name="color-scheme" content="light"/>
  <title>Hub Linea Polveri</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2716%27 fill=%27%232e7bff%27/%3E%3Cpath d=%27M22 43c0-11 8-20 20-20h2v6h-2c-8 0-14 6-14 14v2h-6v-2z%27 fill=%27white%27/%3E%3Cpath d=%27M40 33a6 6 0 1 1 0-12h2v6h-2a0 0 0 0 0 0 0 0 0 0 0 0 0 6z%27 fill=%27white%27 opacity=%270.9%27/%3E%3C/svg%3E">
  <style>
    :root {
      --bg: #f5f5f7;
      --bg2: #ffffff;
      --card: #ffffff;
      --card2: #ffffff;
      --stroke: rgba(0,0,0,.10);
      --text: rgba(0,0,0,.90);
      --muted: rgba(0,0,0,.62);
      --accent:#0a84ff;
      --good:#34c759;
      --warn:#ff9f0a;
      --bad:#ff3b30;
      --shadow: 0 10px 26px rgba(0,0,0,.10);
      --radius: 18px;
      --radius2: 22px;
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Avenir Next", Avenir, "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color: var(--text);
      overflow-y: auto;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: calc(18px + var(--safe-top)) 16px calc(26px + var(--safe-bot));
    }

    header {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .title {
      font-size: 36px;
      line-height: 1.05;
      font-weight: 800;
      letter-spacing: -0.02em;
      text-transform: none;
    }
    .subtitle {
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }

    .statusRow {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
    }
    .pill {
      padding: 8px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .dot {
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
    }
    .dot.ok { background: var(--good); }
    .dot.warn { background: var(--warn); }
    .dot.bad { background: var(--bad); }

    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 980px){
      .grid {
        grid-template-columns: 1.25fr .75fr;
        align-items:start;
      }
      .title { font-size: 46px; }
    }

    .card {
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd {
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .card .hd h2 {
      margin:0;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .02em;
      color: rgba(0,0,0,.88);
      text-transform: uppercase;
    }
    .card .bd {
      padding: 14px;
    }

    .primaryBtn {
      width:100%;
      border: none;
      border-radius: 18px;
      padding: 16px 16px;
      background: linear-gradient(180deg, rgba(46,123,255,1), rgba(46,123,255,.78));
      color: white;
      font-weight: 900;
      font-size: 18px;
      letter-spacing: .02em;
      box-shadow: 0 16px 28px rgba(46,123,255,.25);
      cursor:pointer;
    }
    .primaryBtn:active { transform: translateY(1px); }
    .warnBanner{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(255,149,0,.12);
      border:1px solid rgba(255,149,0,.28);
    }
    .warnBanner .icon{ font-size:20px; line-height:1; }
    .warnBanner .txt{ flex:1; min-width:0; }
    .warnBanner .txt .t{ font-weight: 900; color: rgba(0,0,0,.88); }
    .warnBanner .txt .s{ margin-top:2px; font-size:12px; color: rgba(0,0,0,.62); }
    .miniBtn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,149,0,.88);
      color:white;
      font-weight: 900;
      letter-spacing:.01em;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(255,149,0,.22);
      white-space:nowrap;
    }
    .miniBtn:active{ transform: translateY(1px); }


    .row2 {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btn {
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.88);
      padding: 12px 12px;
      border-radius: 16px;
      font-weight: 800;
      cursor:pointer;
    }
    .btn:active { transform: translateY(1px); }
    .btn.good { background: rgba(32,201,151,.16); border-color: rgba(32,201,151,.35); }
    .btn.bad { background: rgba(255,77,79,.14); border-color: rgba(255,77,79,.35); }
    .btn.ghost { background: transparent; }

    .bigStrip {
      border-radius: 18px;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(32,201,151,.18);
      position: relative;
      overflow:hidden;
      cursor:pointer;
          color: white;
    }
    .bigStrip .label {
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .06em;
      opacity:.95;
    }
    .bigStrip .marquee {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
      padding-bottom: 2px;
    }
    .bigStrip .marquee span {
      display:inline-block;
      padding-left: 100%;
      animation: marquee 16s linear infinite;
    }
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .bigStrip .meta {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.88);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .kv {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .k {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .k .t { font-size: 12px; color: var(--muted); font-weight:700; }
    .k .v { margin-top: 4px; font-size: 18px; font-weight: 900; }

    .list {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 12px;
    }
    .item .top {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .item .name {
      font-weight: 900;
      font-size: 16px;
      line-height:1.1;
    }
    .item .sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .badge {
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
    }

    .blur {
      filter: blur(10px);
      opacity: .85;
      transition: filter .12s ease, opacity .12s ease;
    }
    .blur.reveal {
      filter: blur(0px);
      opacity: 1;
    }

    /* Modals */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      padding-bottom: calc(14px + var(--safe-bot));
    }
    .overlay.show { display:flex; }
    .sheet {
      width: min(980px, 100%);
      max-height: 88vh;
      background: #ffffff;
      border: 1px solid var(--stroke);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sheet .shd {
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .sheet .shd .h {
      font-weight: 1000;
      letter-spacing: .02em;
      font-size: 14px;
      text-transform: uppercase;
      opacity: .9;
    }
    .sheet .shd .x {
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.86);
      font-size: 18px;
      font-weight: 900;
      cursor:pointer;
    }
    .sheet .sbd {
      padding: 14px;
      overflow:auto;
    }
    .stepTitle {
      font-size: 18px;
      font-weight: 950;
      margin: 0 0 10px;
    }
    .muted {
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .radioRow {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .radio {
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.03);
      cursor:pointer;
      font-weight: 900;
    }
    .radio input { accent-color: var(--accent); width:18px; height:18px; }
    .divider {
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bot));
      z-index: 10050;
      width: min(520px, calc(100% - 28px));
      border: 1px solid var(--stroke);
      background: #ffffff;
      color: rgba(0,0,0,.90);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      display:none;
    }
    .toast.show { display:block; }
    .toast .tt { font-weight: 950; }
    .toast .tb { margin-top: 6px; color: var(--muted); font-weight: 700; font-size: 13px; }

    /* Startup legal screen */
    #startup {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
      background: radial-gradient(1000px 700px at 50% -20%, rgba(46,123,255,.35), rgba(46,123,255,0) 55%),
                  linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.45));
      backdrop-filter: blur(14px);
    }
    .startupCard {
      width: min(780px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .startupCard .a {
      padding: 18px 18px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: rgba(0,0,0,.90);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .startupCard .b {
      padding: 18px;
      color: rgba(0,0,0,.88);
      font-weight: 750;
      line-height: 1.35;
    }
    .bootBar {
      height: 10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 14px;
    }
    .bootBar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(46,123,255,1), rgba(32,201,151,1));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .bootMsg {
      margin-top: 10px;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }

    /* Prevent accidental iOS text zoom */
    input, textarea, select, button { font-size: 16px; }

    textarea {
      width:100%;
      min-height: 120px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.90);
      padding: 12px;
      font-weight: 700;
      resize: vertical;
    }
  
    /* Auth gate */
    #authGate{
      position: fixed;
      inset: 0;
      z-index: 10020;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
    }
    #authGate.show{ display:flex; }
    .authCard{
      width: min(720px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 24px 70px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .authCard .ah{
      padding: 16px 16px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .authCard .ab{
      padding: 16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(0,0,0,.62);
      text-transform: uppercase;
      letter-spacing:.06em;
    }
    .field input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.02);
      font-size: 16px;
      font-weight: 800;
      outline: none;
    }
    .authRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .linkBtn{
      border:none;
      background: transparent;
      color: var(--accent);
      font-weight: 900;
      cursor:pointer;
      padding: 0;
    }
    body.noscroll{ overflow:hidden; }

  
    /* Completed orders */
    .completedItem{ cursor:pointer; }
    .completedItem:hover{ background: rgba(0,0,0,.05); }
    .completedMeta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; color: var(--muted); font-size:12px; }
    .kv{ font-variant-numeric: tabular-nums; }


  /* --- Push pill + iOS install banner --- */
  .pillBtn{cursor:pointer;border:none}
  .pillBtn:active{transform:scale(.98)}
  .pillBtn:focus{outline:2px solid rgba(255,255,255,.18); outline-offset:2px}
  .iosBanner{
    position: sticky; top: 10px; z-index: 50;
    margin: 10px auto 0; max-width: 1100px;
    padding: 12px 12px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    border-radius: 14px;
    background: rgba(11,18,32,.92);
    border: 1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 25px rgba(0,0,0,.25);
    backdrop-filter: blur(10px);
  }
  .iosBannerInner{display:flex; flex-direction:column; gap:4px}
  .iosBannerTitle{font-weight:800; letter-spacing:.2px}
  .iosBannerText{opacity:.88; font-size: .92rem}
  .iosBannerBtn{
    border:none; padding:10px 14px; border-radius: 12px;
    background: rgba(255,255,255,.14);
    color: var(--text, #fff);
    font-weight:800; cursor:pointer;
  }
  .iosBannerBtn:active{transform:scale(.98)}

</style>

  <link rel="manifest" href="hub_linea_polveri.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Hub Polveri">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
</head>
<body>
  <!-- Startup legal + boot -->
  <div id="startup">
    <div class="startupCard">
      <div class="a">Avviso aziendale</div>
      <div class="b">
        I dati visualizzati in questo sistema sono <b>riservati</b> e destinati esclusivamente all’uso interno.<br/>
        È vietata qualsiasi condivisione o diffusione non autorizzata al di fuori dell’azienda.<br/>
        Eventuali violazioni potranno comportare <b>provvedimenti disciplinari</b> e <b>azioni legali</b> secondo quanto previsto dalle normative vigenti.
        <div class="bootBar"><div id="bootFill"></div></div>
        <div id="bootMsg" class="bootMsg">BOOT: inizializzazione…</div>
      </div>
    </div>
  </div>

  
  <!-- Auth gate -->
  <div id="authGate" role="dialog" aria-modal="true">
    <div class="authCard">
      <div class="ah">Accesso operatore</div>
      <div class="ab" id="authBody"></div>
    </div>
  </div>


  <div class="wrap">
    <header>
      <div>
        <div class="title">Hub linea polveri</div>
        <div class="subtitle">Benvenuto <b id="hdrUser">—</b> · Sistema operativo interno</div>
      </div>
      <div class="statusRow">
        <div class="pill" id="pillOnline"><span class="dot" id="dotOnline"></span><span id="txtOnline">Stato: avvio</span></div>
        <div class="pill"><span class="dot ok"></span><span id="txtXmlTime">Ordini: in sincronizzazione…</span></div>
      
        <button class="pill pillBtn" id="pillPush" type="button" title="Attiva/Disattiva notifiche push"><span class="dot" id="dotPush"></span><span id="txtPush">Notifiche: —</span></button>
      </div>
    </header>
    <div id="iosInstallBanner" class="iosBanner" hidden>
      <div class="iosBannerInner">
        <div class="iosBannerTitle">Per ricevere le notifiche su iPhone/iPad</div>
        <div class="iosBannerText">Apri in Safari → Condividi → <b>Aggiungi alla schermata Home</b>. Poi apri l’app dall’icona e attiva le notifiche.</div>
      </div>
      <button class="iosBannerBtn" id="btnIosBannerClose" type="button">OK</button>
    </div>


    <div class="grid">
      <!-- Left column -->
      <div class="card">
        <div class="hd">
          <h2>Operatività</h2>
          <div class="badge" id="badgeCounts">—</div>
        </div>
        <div class="bd">
          <button class="primaryBtn" id="btnGoProd">VAI IN PRODUZIONE</button>

          <div style="height:12px"></div>

          <div id="partialBanner" class="warnBanner" style="display:none;">
            <div class="icon">⚠️</div>
            <div class="txt">
              <div class="t" id="partialBannerTitle">Ci sono ordini parzialmente conclusi in corso</div>
              <div class="s" id="partialBannerSub">Apri Produzione per completare le righe rimanenti.</div>
            </div>
            <button class="miniBtn" id="btnPartialOpen">Apri</button>
          </div>

          <div style="height:12px"></div>

          <div id="prodStrip" class="bigStrip" style="display:none;">
            <div class="label">Produzione in corso</div>
            <div class="marquee"><span id="prodMarquee">—</span></div>
            <div class="meta">
              <div><b id="prodCount">0</b> attività attive</div>
              <div>Tap per dettagli e conclusione</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="kv">
            <div class="k">
              <div class="t">Righe polveri</div>
              <div class="v" id="kPowderLines">—</div>
            </div>
            <div class="k">
              <div class="t">Kg totali</div>
              <div class="v" id="kPowderKg">—</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="box-shadow:none; background: rgba(0,0,0,.02); border-radius: 18px;">
            <div class="hd" style="border-bottom-color: rgba(255,255,255,.06);">
              <h2>Riepilogo materie prime</h2>
              <div class="badge">kg</div>
            </div>
            <div class="bd">
              <div class="list" id="matList"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="card">
        <div class="hd">
          <h2>Home</h2>
          <div class="badge">scroll</div>
        </div>
        <div class="bd">
          <div class="k" style="margin-bottom:12px;">
            <div class="t">Fatturato (totale)</div>
            <div class="v blur" id="fatValue">€ —</div>
            <div class="muted" style="margin-top:6px;">Tocca per mettere a fuoco (password)</div>
          </div>

          <div class="row2" style="margin-bottom:12px;">
            <button class="btn ghost" id="btnCallMatteo">Chiama Matteo</button>
            <button class="btn ghost" id="btnOpenStats">Statistiche</button>
          </div>

          <div class="card" style="box-shadow:none; background: rgba(0,0,0,.02); border-radius: 18px;">
            <div class="hd">
              <h2>Statistiche produzione</h2>
              <div class="badge" id="statsBadge">—</div>
            </div>
            <div class="bd">
              <div class="muted">Classifica live (kg totali e velocità media). Disponibile su desktop.</div>
              <div style="height:10px"></div>
              <div id="statsList" class="list"></div>
            </div>
          </div>

          <div style="height:12px"></div>

          
          <div style="height:12px"></div>

          <div class="card" id="completedCard">
            <div class="hd">
              <h2>Ordini conclusi</h2>
              <div class="badge" id="completedBadge">0</div>
            </div>
            <div class="bd">
              <div class="list" id="completedList"></div>
              <div class="muted" id="completedEmpty" style="display:none;">Nessuna produzione conclusa registrata.</div>
            </div>
          </div>

<div class="card" style="box-shadow:none; background: rgba(0,0,0,.02); border-radius: 18px;">
            <div class="hd">
              <h2>Segnala un problema</h2>
              <div class="badge">home</div>
            </div>
            <div class="bd">
              <div class="muted">Usa questo riquadro per segnalare: macchina non funzionante, materiale/prodotto non disponibile, o anomalie in linea. La segnalazione viene registrata internamente.</div>
              <div style="height:10px"></div>
              <textarea id="issueText" placeholder="Esempio: 'Macchina dosatrice non parte' oppure 'Prodotto non disponibile in magazzino'. Aggiungi ordine/cliente se utile…"></textarea>
              <div style="height:10px"></div>
              <button class="btn good" id="btnSendIssue" style="width:100%;">Invia segnalazione</button>
            </div>
          </div>

          <div style="height:8px"></div>
          <div class="muted" style="text-align:center;">© General Copper SRL · Uso interno</div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- History detail modal -->
  <div id="histModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div>
          <div class="h" id="histTitle">Dettaglio produzione</div>
          <div class="sub" id="histSub">—</div>
        </div>
        <button class="x" id="histClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="histBody"></div>
    </div>
  </div>

<!-- Toast overlay -->
  <div id="toast" class="toast">
    <div class="tt" id="toastTitle">Attenzione</div>
    <div class="tb" id="toastBody">—</div>
  </div>

  <!-- Production modal -->
  <div id="prodModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h" id="prodModalTitle">Produzione</div>
        <button class="x" id="prodModalClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="prodModalBody"></div>
    </div>
  </div>

  <!-- Running productions modal -->
  <div id="runningModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Produzione in corso</div>
        <button class="x" id="runningClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="runningBody"></div>
    </div>
  </div>

  
  <!-- Signature modal -->
  <div id="signModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Conclusione · Firma</div>
        <button class="x" id="signClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd">
        <div class="stepTitle">Dichiarazione e firma</div>
        <div class="muted" id="signContext">—</div>
        <div style="height:10px"></div>
        <div class="muted" style="font-weight:800;">
          Dichiarazione: <b>dichiaro</b> che la produzione è stata eseguita secondo le procedure aziendali e i controlli previsti.
        </div>
        <div style="height:10px"></div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="signCheck" type="checkbox" style="width:20px;height:20px; accent-color: var(--good);" />
          <label for="signCheck" style="font-weight:900;">Confermo la dichiarazione</label>
        </div>
        <div style="height:12px"></div>
        <div style="border:1px solid var(--stroke); border-radius:18px; overflow:hidden; background: rgba(0,0,0,.02);">
          <canvas id="signCanvas" style="width:100%; height:220px; display:block;"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="row2">
          <button class="btn" id="signClear">Pulisci firma</button>
          <button class="btn good" id="signOk">CONCLUDI</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Reason modal -->
  <div id="reasonModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Motivazione richiesta</div>
        <button class="x" id="reasonClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd">
        <div class="stepTitle">Perché non sei entrato in produzione?</div>
        <div class="muted">Prima di uscire, inserisci una breve motivazione (obbligatoria).</div>
        <div style="height:10px"></div>
        <textarea id="reasonText" placeholder="Scrivi qui le motivazioni…"></textarea>
        <div style="height:10px"></div>
        <button class="btn good" id="reasonSend" style="width:100%;">Conferma e chiudi</button>
      </div>
    </div>
  </div>

<script type="module">
  // ===============================
  // CONFIG
  // ===============================
  const XML_PROXY_CFG = {
      proxyUrl: "https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",
      cacheKey: "EASYFATT_XML_CACHE_V1"
    };
  const ADMIN_PW = "12345";
  const FIREBASE_IMPORT_APP = "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  const FIREBASE_IMPORT_FS  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  const FIREBASE_IMPORT_AUTH = "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  const FIREBASE_IMPORT_MSG  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };
  // Web Push (FCM): incolla qui la *Public key* (VAPID) da Firebase Console → Project settings → Cloud Messaging → Web Push certificates
  const FCM_VAPID_KEY = "PASTE_PUBLIC_VAPID_KEY_HERE";

  // Email su segnalazione problemi (richiede Firebase Extension: firestore-send-email)
  const ISSUE_EMAIL_ENABLED = false; // metti true quando l'estensione è installata
  const ISSUE_EMAIL_TO = "matteo@generalcoppersrl.com";


  const OPERATORS = ["Hassan","Ahmed","Muhammed","Mustapha","Youssef"];
  const NON_PERTINENT_CODES = new Set(["mast250viri","mast500viri","codmast250viri","codmast500viri"]);

  // ===============================
  // STATE
  // ===============================
  const state = {
    lastAuthErrorMsg: "",

    xmlModifiedTime: null,
    lastFetchAt: null,
    docs: [],
    powderOrders: [],
    activeProductions: [],
    history: [],
    user: null,
    operator: null,
    prodModalOpenedAt: 0,
    startedThisSession: false,
    prodModalTouched: false,
    firebase: {
      ok: false,
      db: null,
      api: null,
    },
    push: { supported:false, permission:'default', token:'', enabled:false },
  };

  // ===============================
  // UTILS
  // ===============================
  const $ = (id)=>document.getElementById(id);

  function nowIso(){ return new Date().toISOString(); }
  function fmtTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function fmtDateTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,"0");
    const mo = String(dt.getMonth()+1).padStart(2,"0");
    const yy = dt.getFullYear();
    return `${dd}/${mo}/${yy} ${fmtTime(dt)}`;
  }
  function norm(s){
    return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
  }
  function safeText(node){
    return (node && node.textContent ? node.textContent : "").trim();
  }
  function fetchWithTimeout(url, ms, opts={}){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    return fetch(url, {...opts, signal: ctrl.signal}).finally(()=>clearTimeout(t));
  }
  function showToast(title, body, ms=3800){
    $("toastTitle").textContent = title;
    $("toastBody").textContent = body;
    $("toast").classList.add("show");
    setTimeout(()=>$("toast").classList.remove("show"), ms);
  }

  // ===============================
  // BODY LOCK (no background scroll)
  // ===============================
  let _scrollY = 0;
  function lockBody(){
    _scrollY = window.scrollY || 0;
    document.body.classList.add("noscroll");
    document.body.style.top = `-${_scrollY}px`;
    document.body.style.position = "fixed";
    document.body.style.width = "100%";
  }
  function unlockBody(){
    document.body.classList.remove("noscroll");
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.width = "";
    window.scrollTo(0, _scrollY);
  }

  // ===============================
  // BOOT (smooth + fast)
  // ===============================
  const bootFill = $("bootFill");
  const bootMsg = $("bootMsg");
  let bootP = 0;
  function bootSet(p, msg){
    bootP = Math.max(bootP, Math.min(100, p));
    bootFill.style.width = bootP.toFixed(0)+"%";
    if(msg) bootMsg.textContent = msg;
  }
  async function boot(){
    // Boot super smooth: UI sempre pronta, sync in parallelo (mai blocco al 90%)
    bootSet(10, "AVVIO: inizializzazione interfaccia…");
    await new Promise(r=>setTimeout(r, 220));

    bootSet(25, "DOWNLOAD: ordini in corso…");
    const ordersPromise = syncOrders(true);

    bootSet(45, "SYNC: produzione in corso…");
    const livePromise = initLiveSync();

    // Non restare appeso: dopo 3.2s entri comunque nell’hub (sync continua)
    await Promise.race([ordersPromise, new Promise(r=>setTimeout(r, 3200))]);

    bootSet(80, "OTTIMIZZAZIONE: finalizzazione…");
    await Promise.race([livePromise, new Promise(r=>setTimeout(r, 1200))]);

    bootSet(100, "OK: pronto");
    await new Promise(r=>setTimeout(r, 140));
    $("startup").style.display = "none";

    showToast(
      "Operatività",
      "Per avviare un ordine: VAI IN PRODUZIONE → scegli operatore → seleziona righe → INIZIA PRODUZIONE."
    );
  }

  // ===============================
  // XML -> Orders (snello)
  // ===============================
  function detectPackKg(desc){
    const s = norm(desc).replace(/,/g,".");
    let m = s.match(/(\d+(?:\.\d+)?)\s*kg\b/);
    if(m) return parseFloat(m[1]);
    m = s.match(/\bkg\s*(\d+(?:\.\d+)?)\b/);
    if(m) return parseFloat(m[1]);
    m = s.match(/(\d+(?:\.\d+)?)\s*(?:gr|g)\b/);
    if(m) return parseFloat(m[1]) / 1000;
    return null;
  }

  function isPowderLine(code, desc, um){
    const c = norm(code).replace(/\s+/g,"");
    if(c && NON_PERTINENT_CODES.has(c)) return false;

    const s = norm(desc);
    const u = norm(um);

    if(/\b(mastice)\b/.test(s)) return false;
    if(/\b(secchio|tanica|flacone|bottiglia|spray|trigger|pompa|nebul|olio|shampoo|deterg|repel|bio)\b/.test(s)) return false;
    if(/\b\d+(?:[\.,]\d+)?\s*(ml|l|lt)\b/.test(s)) return false;
    if(u === "l" || u === "lt" || u === "ml") return false;

    const packKg = detectPackKg(desc);
    const isBigBag = /\b(big\s*bag|bigbag)\b/.test(s);
    if(packKg != null && packKg > 10.0001 && !isBigBag) return false;
    if(isBigBag && packKg != null && packKg >= 100) return true;

    if(/\b(sacco|sacchetto|busta|bustina|barattolo)\b/.test(s)) return true;
    if(u === "kg" || u === "g") return true;
    if(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/.test(s)) return true;

    if(/\b(ossicloruro|poltiglia|caolino|zeolite|zolfo|rame|solfato|idrossido|tribasico|diatomite|agroblumagic|corrobor)\b/.test(s)) return true;

    return false;
  }

  function materialOf(desc, code=""){
    const s = norm(desc);
    const c = norm(code);
    const has = (re) => re.test(s) || re.test(c);

    if(has(/\b(rame|copper|cupr|cu)\b/) || s.includes("bordolese") || s.includes("poltiglia")) return "rame";
    if(has(/\b(zolfo|sulfur|sulf)\b/)) return "zolfo";
    if(has(/\b(caolino|kaolin|caol)\b/)) return "caolino";
    if(has(/\b(zeolite|zeolit)\b/)) return "zeolite";
    if(has(/\b(diatomite|agroblumagic|corrobor)\b/)) return "corroborante";
    return "altro";
  }

  function cleanShort(desc){
    const s = (desc||"").toString();
    return s
      .replace(/\|\s*CONCIME.*$/i,"")
      .replace(/\|\s*CONSENTITO.*$/i,"")
      .replace(/\|\s*AMMESSO.*$/i,"")
      .replace(/\s{2,}/g," ")
      .trim();
  }

  function parseEasyfattXml(xmlText){
    const outDocs = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlText, "text/xml");
    const docs = Array.from(doc.getElementsByTagName("Document"));
    for(const d of docs){
      const customer = safeText(d.getElementsByTagName("CustomerName")[0]) || "Cliente";
      const number = safeText(d.getElementsByTagName("Number")[0]) || "";
      const date = safeText(d.getElementsByTagName("Date")[0]) || "";
      let conclusion = safeText(d.getElementsByTagName("ExpectedConclusion")[0])
        || safeText(d.getElementsByTagName("ExpectedDeliveryDate")[0])
        || safeText(d.getElementsByTagName("DeliveryDate")[0])
        || "";

      const lines = [];
      const rows = Array.from(d.getElementsByTagName("Row"));
      for(let i=0;i<rows.length;i++){
        const r = rows[i];
        const code = safeText(r.getElementsByTagName("Code")[0]) || "";
        const desc = safeText(r.getElementsByTagName("Description")[0]) || safeText(r.getElementsByTagName("Name")[0]) || "";
        const um = safeText(r.getElementsByTagName("UM")[0]) || safeText(r.getElementsByTagName("Unit")[0]) || "";
        let qty = safeText(r.getElementsByTagName("Qty")[0]) || safeText(r.getElementsByTagName("Quantity")[0]) || "0";
        qty = parseFloat(qty.replace(",","."));
        if(!Number.isFinite(qty)) qty = 0;

        const powder = isPowderLine(code, desc, um);
        const packKg = detectPackKg(desc);
        const material = powder ? materialOf(desc, code) : "altro";

        const lineKg = (() => {
          if(!powder) return 0;
          if(norm(um)==="kg" || /\bkg\b/.test(norm(um))) return qty;
          if(packKg!=null && qty>0) return qty * packKg;
          if(packKg!=null) return qty*packKg;
          return 0;
        })();

        const lineKey = `${number}|${i}|${(norm(code)||norm(desc).slice(0,24))}`;

        lines.push({
          lineKey,
          code,
          desc: cleanShort(desc),
          um,
          qty,
          powder,
          packKg,
          lineKg,
          material,
        });
      }

      outDocs.push({ customer, number, date, conclusion, lines });
    }
    return outDocs;
  }

  async function syncOrders(isBoot=false){
    try {
      setOnlinePill("warn", "Stato: sincronizzazione…");
      if(isBoot) bootSet(40, "DOWNLOAD: ordini in corso…");

      const res = await fetchWithTimeout(XML_PROXY_CFG.proxyUrl, 12000, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if(j && j.ok === false) throw new Error(j.error || "Proxy: errore");
      const xmlText = j?.xml;
      if(!xmlText || typeof xmlText !== "string") throw new Error("XML mancante");

      state.xmlModifiedTime = j?.modifiedTime || null;
      state.lastFetchAt = Date.now();
      localStorage.setItem(XML_PROXY_CFG.cacheKey, JSON.stringify({ at: state.lastFetchAt, xml: xmlText, modifiedTime: state.xmlModifiedTime }));

      state.docs = parseEasyfattXml(xmlText);

      const powderDocs = [];
      for(const d of state.docs){
        const pLines = d.lines.filter(x=>x.powder);
        if(!pLines.length) continue;
        const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
        powderDocs.push({ customer: d.customer, number: d.number, conclusion: d.conclusion, lines: pLines, totalKg });
      }
      state.powderOrders = powderDocs;

      renderHome();
      setOnlinePill("ok", "Stato: online");
      if(isBoot) bootSet(62, "OK: ordini aggiornati");

    } catch(err) {
      console.warn("syncOrders failed", err);
      const cached = localStorage.getItem(XML_PROXY_CFG.cacheKey);
      if(cached){
        try {
          const c = JSON.parse(cached);
          state.lastFetchAt = c.at || null;
          state.xmlModifiedTime = c.modifiedTime || null;
          state.docs = parseEasyfattXml(c.xml||"");
          const powderDocs = [];
          for(const d of state.docs){
            const pLines = d.lines.filter(x=>x.powder);
            if(!pLines.length) continue;
            const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
            powderDocs.push({ customer: d.customer, number: d.number, conclusion: d.conclusion, lines: pLines, totalKg });
          }
          state.powderOrders = powderDocs;
        } catch(_e) {}
      }
      renderHome();
      setOnlinePill("bad", "Stato: offline (cache)");
      if(isBoot) bootSet(55, "Connessione lenta… uso cache locale");
    }
  }

  function setOnlinePill(kind, text){
    const dot = $("dotOnline");
    dot.className = "dot";
    if(kind==="ok") dot.classList.add("ok");
    if(kind==="warn") dot.classList.add("warn");
    if(kind==="bad") dot.classList.add("bad");
    $("txtOnline").textContent = text;
  }

  
  
  function humanAuthErr(err){
    const code = (err && (err.code||err.message||"")).toString();
    const map = {
      "auth/unauthorized-domain": "Dominio non autorizzato. Verifica in Firebase: Authentication → Settings → Domini autorizzati.",
      "auth/operation-not-allowed": "Provider Google non abilitato. Verifica in Firebase: Authentication → Sign-in method.",
      "auth/popup-blocked": "Popup bloccato dal browser. Riprovo con reindirizzamento…",
      "auth/popup-closed-by-user": "Popup chiuso. Riprova.",
      "auth/cancelled-popup-request": "Richiesta annullata. Riprova.",
      "auth/network-request-failed": "Connessione instabile. Riprova tra qualche secondo.",
      "auth/invalid-api-key": "Config Firebase non valida (apiKey).",
      "auth/invalid-oauth-client-id": "Client OAuth non valido (Google). Controlla la configurazione Web SDK.",
      "auth/redirect-cancelled-by-user": "Accesso annullato. Riprova.",
      "auth/redirect-operation-pending": "Accesso già in corso. Attendi e riprova."
    };
    for (const k in map){ if(code.includes(k)) return map[k]; }
    return "Errore accesso. Controlla rete e riprova.";
  }

// ===============================
  // AUTH (Google / Email + allowlist email)
  // ===============================
  const USERS_COL = "powderUsers";
  // const ACCESS_COL removed (using USERS_COL allowlist)
function showAuthGate(){
    $("authGate").classList.add("show");
    lockBody();
  }
  function hideAuthGate(){
    $("authGate").classList.remove("show");
    unlockBody();
  }
  async function getAccessByEmail(email){
    const e = String(email||"").trim().toLowerCase();
    if(!e) return null;
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, e);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||null) : null;
  }

  function renderAuthDenied(email, reason=""){
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso non abilitato</div>
      <div class="muted">Questa email non risulta autorizzata ad accedere all’hub.</div>
      <div style="height:10px"></div>
      <div class="pill" style="display:inline-block;background:#fff3f2;color:#8a1f1a;border:1px solid #ffd1cd;">${escapeHtml(email||"")}</div>
      ${reason ? `<div style="height:10px"></div><div class="muted">${escapeHtml(reason)}</div>` : ``}
      <div style="height:14px"></div>
      <button id="btnLogout" class="btn bad" type="button">Esci</button>
      <div style="height:8px"></div>
      <div class="muted">Se serve, chiedi all’amministrazione di abilitare la tua email.</div>
    `;
    $("btnLogout").onclick = async () => {
      try{ await state.firebase.authApi.signOut(state.firebase.auth); }catch(e){}
      renderAuthLogin("");
    };
  }



  function renderAuthLogin(msg=""){
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso richiesto</div>
      <div class="muted">${msg || "Accedi per iniziare. Se la tua email non è autorizzata, contatta un amministratore."}</div>
      <div style="height:12px"></div>

      <button class="btn good" id="btnGoogle" style="width:100%;">Accedi con Google</button>
      <div style="height:10px"></div>

      <div class="divider"></div>
      <div class="stepTitle" style="font-size:16px; margin-top:0;">Oppure con email</div>

      <div class="authRow">
        <div class="field">
          <label>Nome</label>
          <input id="authName" autocomplete="given-name" placeholder="Nome" />
        </div>
        <div class="field">
          <label>Cognome</label>
          <input id="authSurname" autocomplete="family-name" placeholder="Cognome" />
        </div>
      </div>
      <div class="field">
        <label>Email</label>
        <input id="authEmail" type="email" autocomplete="email" placeholder="nome@azienda.it" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="authPass" type="password" autocomplete="current-password" placeholder="Password" />
      </div>

      <div class="row2">
        <button class="btn" id="btnEmailLogin">Accedi</button>
        <button class="btn ghost" id="btnEmailSignup">Crea account</button>
      </div>

      <div style="height:12px"></div>
      <div class="muted">Nota: la pagina resta sempre in italiano.</div>
    `;

    b.querySelector("#btnGoogle").onclick = async()=>{
      const authApi = state.firebase.authApi;
      const auth = state.firebase.auth;
      const prov = new authApi.GoogleAuthProvider();
      state.lastAuthErrorMsg = "";
      // Provo popup (più veloce). Se bloccato, fallback su redirect (più stabile su mobile).
      try{
        await authApi.signInWithPopup(auth, prov);
      }catch(err){
        console.warn("Google popup error", err);
        const msg = humanAuthErr(err);
        if((err && err.code==="auth/popup-blocked") || (err && err.code==="auth/operation-not-supported-in-this-environment")){
          showToast("Accesso", msg);
          try{
            await authApi.signInWithRedirect(auth, prov);
            return;
          }catch(err2){
            console.warn("Google redirect error", err2);
            state.lastAuthErrorMsg = humanAuthErr(err2);
            renderAuthLogin(state.lastAuthErrorMsg);
            return;
          }
        }
        state.lastAuthErrorMsg = msg;
        showToast("Accesso", msg);
      }
    };

    b.querySelector("#btnEmailLogin").onclick = async()=>{
      const email = b.querySelector("#authEmail").value.trim();
      const pass  = b.querySelector("#authPass").value;
      if(!email || !pass){
        showToast("Accesso", "Inserisci email e password.");
        return;
      }
      try{
        const authApi = state.firebase.authApi;
        await authApi.signInWithEmailAndPassword(state.firebase.auth, email, pass);
      }catch(err){
        console.warn(err);
        showToast("Accesso", "Credenziali non valide o account inesistente.");
      }
    };

    b.querySelector("#btnEmailSignup").onclick = async()=>{
      const name = b.querySelector("#authName").value.trim();
      const sur  = b.querySelector("#authSurname").value.trim();
      const email = b.querySelector("#authEmail").value.trim();
      const pass  = b.querySelector("#authPass").value;
      if(!name || !sur || !email || !pass){
        showToast("Registrazione", "Compila nome, cognome, email e password.");
        return;
      }
      try{
        const authApi = state.firebase.authApi;
        const cred = await authApi.createUserWithEmailAndPassword(state.firebase.auth, email, pass);
        await upsertUserProfile(cred.user, { fullName: `${name} ${sur}`, name, surname: sur, email });
      }catch(err){
        console.warn(err);
        showToast("Registrazione", "Impossibile creare l’account (email già usata o password debole).");
      }
    };
  }

  async function upsertUserProfile(user, fields){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, user.uid);
    await fs.setDoc(ref, { uid:user.uid, ...fields, updatedAt: nowIso(), createdAt: nowIso() }, { merge:true });
  }

  async function loadUserProfile(uid){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, uid);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||{}) : null;
  }

  async function ensureAuthFlow(){
    // chiamata dopo init firebase
    const authApi = state.firebase.authApi;
    const auth = state.firebase.auth;

    // Gestisci redirect result (mostra errori)
    try{
      await authApi.getRedirectResult(auth);
    }catch(e){
      console.warn("getRedirectResult error", e);
      state.lastAuthErrorMsg = humanAuthErr(e);
    }
authApi.onAuthStateChanged(auth, async(user)=>{
      if(!user){
        state.user = null;
        state.operator = null;
        $("hdrUser").textContent = "—";
        const msg = state.lastAuthErrorMsg || "";
        state.lastAuthErrorMsg = "";
        renderAuthLogin(msg);
        return;
      }

      // Sessione valida 7 giorni per dispositivo (dopo scade e richiede nuovo accesso)
      try{
        const MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000;
        const KEY_TS = "GC_AUTH_TS";
        const KEY_EMAIL = "GC_AUTH_EMAIL";
        const email = (user.email || "").toLowerCase();
        const prevEmail = (localStorage.getItem(KEY_EMAIL) || "").toLowerCase();
        const ts = parseInt(localStorage.getItem(KEY_TS) || "0", 10);
        const now = Date.now();

        if(prevEmail && prevEmail !== email){
          // utente diverso: reset finestra
          localStorage.setItem(KEY_EMAIL, email);
          localStorage.setItem(KEY_TS, String(now));
        }else if(ts && (now - ts) > MAX_AGE_MS){
          // scaduta
          localStorage.removeItem(KEY_TS);
          localStorage.removeItem(KEY_EMAIL);
          state.lastAuthErrorMsg = "Sessione scaduta (7 giorni). Accedi di nuovo.";
          await authApi.signOut(auth);
          return;
        }else if(!ts){
          // prima volta
          localStorage.setItem(KEY_EMAIL, email);
          localStorage.setItem(KEY_TS, String(now));
        }
      }catch(_e){}

      // profilo
      let profile = await loadUserProfile(user.uid);
      if(!profile){
        const dn = (user.displayName||"").trim();
        profile = { fullName: dn || user.email || "" , email: user.email||"" };
        await upsertUserProfile(user, profile);
      } else {
        // assicurati fullName
        if(!profile.fullName){
          const dn = (user.displayName||"").trim();
          profile.fullName = dn || user.email || "";
          await upsertUserProfile(user, { fullName: profile.fullName, email: user.email||"" });
        }
      }
      // allowlist email
      const access = await getAccessByEmail(user.email||"");
      if(!access || access.enabled === false){
        renderAuthDenied(user.email||"", access && access.enabled===false ? "Accesso disabilitato." : "Email non presente in elenco autorizzati.");
        return;
      }


      // usa displayName da allowlist se presente (coerente per reparto)
      if(access && access.displayName){ profile.fullName = access.displayName; }

      state.user = { uid: user.uid, fullName: profile.fullName, email: (user.email||profile.email||""), isAdmin: Boolean(access && access.isAdmin) };
      state.operator = state.user.fullName;
      $("hdrUser").textContent = state.user.fullName;
      hideAuthGate();
      renderHome();
    });
  }


  // ===============================
  // LIVE SYNC (Firestore) - lazy import
  // ===============================
  async function initLiveSync(){
    try {
      const timeoutMs = 5500;
      const t = new Promise((_,rej)=>setTimeout(()=>rej(new Error("firebase timeout")), timeoutMs));

      const apiPromise = (async()=>{
        const { initializeApp } = await import(FIREBASE_IMPORT_APP);
        const fs = await import(FIREBASE_IMPORT_FS);
        const fa = await import(FIREBASE_IMPORT_AUTH);
        const fm = await import(FIREBASE_IMPORT_MSG);

        const app = initializeApp(firebaseConfig);
        const db = fs.getFirestore(app);
        const auth = fa.getAuth(app);
        let messaging = null;

        try { await fa.setPersistence(auth, fa.browserLocalPersistence); } catch(_e){}

        state.firebase.ok = true;
        state.firebase.db = db;
        state.firebase.api = fs;
        state.firebase.authApi = fa;
        state.firebase.auth = auth;
        state.firebase.msgApi = fm;
        try{ state.push.supported = await fm.isSupported(); }catch(_e){ state.push.supported = false; }
        if(state.push.supported){
          try{ messaging = fm.getMessaging(app); }catch(_e){ messaging = null; }
        }
        state.firebase.messaging = messaging;
      })();

      await Promise.race([apiPromise, t]);

      // Auth flow gate
      await ensureAuthFlow();

      const fs = state.firebase.api;
      const db = state.firebase.db;

      // Live productions
      const col = fs.collection(db, "powderProductions");
      fs.onSnapshot(col, (snap)=>{
        const arr = [];
        snap.forEach(doc=>arr.push({ id: doc.id, ...doc.data() }));
        state.activeProductions = arr.filter(x=>x && x.active);
        renderHome();
      }, (err)=>{
        console.warn("onSnapshot error", err);
        state.firebase.ok = false;
        renderHome();
      });

      // History for stats + "ordini conclusi"
      try {
        const hcol = fs.collection(db, "powderProdHistory");
        fs.onSnapshot(hcol, (snap)=>{
          const hist = [];
          snap.forEach(doc=>hist.push({ id: doc.id, ...doc.data() }));
          state.history = hist;
          renderStats();
          try{ renderCompletedSection(); }catch(_e){}
          try{ renderPartialBanner && renderPartialBanner(); }catch(_e){}
        });
      } catch(_e) {}

    } catch(err) {
      console.warn("Firebase init failed:", err);
      state.firebase.ok = false;
      renderHome();
      renderAuthLogin("Connessione Firebase non disponibile. Verifica rete o contatta il responsabile.");
    }
  }

  async function upsertActiveProduction(prod){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = prod.id || `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { ...prod, id, active:true }, { merge:true });
    return id;
  }

  async function closeActiveProduction(id, payload={}){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { active:false, closedAt: nowIso(), ...payload }, { merge:true });
  }

  async function addHistory(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdHistory", id), { ...entry, id, at: nowIso() });
  }

  async function addAbort(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdAborts", id), { ...entry, id, at: nowIso() });
  }

  async function addIssue(entry){
  if(!state.firebase.ok) return;
  const fs = state.firebase.api;
  const db = state.firebase.db;
  const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;

  await fs.setDoc(fs.doc(db, "powderProdIssues", id), { ...entry, id, at: nowIso() });

  // (opzionale) invio email via Firestore "Trigger Email" extension
  // Collezione default: "email"
  if(ISSUE_EMAIL_ENABLED && ISSUE_EMAIL_TO){
    try{
      const subject = `Segnalazione Hub Polveri · Ordine ${entry?.orderNo || ""}`.trim();
      const text = [
        "Nuova segnalazione dal Hub Linea Polveri",
        `Cliente: ${entry?.customer || ""}`,
        `Ordine: ${entry?.orderNo || ""}`,
        `Operatore: ${state.user?.fullName || ""}`,
        `Dettagli: ${entry?.text || entry?.message || ""}`
      ].join("\n");

      await fs.setDoc(fs.doc(db, "email", id), {
        to: ISSUE_EMAIL_TO,
        message: { subject, text }
      });
    }catch(err){
      console.warn("email issue failed", err);
    }
  }
}

// VOICE (Google voice only)
  // ===============================
  const GEMINI_TTS_ENDPOINT = localStorage.getItem("GEMINI_TTS_ENDPOINT") || "";
  async function speak(text){
    try{
      if(!text) return;

      // 1) Se configurato un endpoint TTS (Gemini/Google) uso audio reale
      if(GEMINI_TTS_ENDPOINT){
        const res = await fetch(GEMINI_TTS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ text, lang: "it-IT" })
        });

        if(res.ok){
          const ct = (res.headers.get("content-type")||"").toLowerCase();

          let blob;
          if(ct.includes("audio/")){
            blob = await res.blob();
          } else {
            // fallback: json { audioBase64, mime }
            const j = await res.json().catch(()=>null);
            if(j && j.audioBase64){
              const bin = atob(j.audioBase64);
              const arr = new Uint8Array(bin.length);
              for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
              blob = new Blob([arr], { type: j.mime || "audio/mpeg" });
            }
          }
          if(blob){
            const url = URL.createObjectURL(blob);
            const a = new Audio(url);
            a.onended = ()=>URL.revokeObjectURL(url);
            await a.play().catch(()=>{});
            return;
          }
        }
      }

      // 2) Fallback: Web Speech (dipende dal device)
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "it-IT";
      const voices = window.speechSynthesis.getVoices();
      const v = voices.find(x=>/Google/i.test(x.name) && /it/i.test(x.lang)) || voices.find(x=>/it/i.test(x.lang)) || null;
      if(v) u.voice = v;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(err){
      console.warn("speak error", err);
    }
  }
  window.speechSynthesis?.addEventListener?.("voiceschanged", ()=>{});

  // ===============================
  // RENDER
  // ===============================
  function prodRatio(p){
    const startedAt = p.startedAt ? new Date(p.startedAt).getTime() : null;
    if(!startedAt) return 0;
    const elapsed = Date.now() - startedAt;
    const kg = Number(p.totalKg||0);
    const expectedMs = Math.max(1, (kg/500) * 3600 * 1000);
    return elapsed / expectedMs;
  }

  
  function computePartialOrders(){
    const orders = state.powderOrders || [];
    const hist = state.history || [];
    const completedByOrder = new Map();
    for(const h of hist){
      if(!h || !h.orderNo) continue;
      const on = String(h.orderNo);
      const arr = Array.isArray(h.concludedLineKeys) ? h.concludedLineKeys : [];
      if(!completedByOrder.has(on)) completedByOrder.set(on, new Set());
      const set = completedByOrder.get(on);
      for(const k of arr){ if(k) set.add(String(k)); }
    }
    const partial = [];
    const full = [];
    for(const o of orders){
      const on = String(o.orderNo || "");
      if(!on) continue;
      const keys = (o.lines||[]).map(l=>l.lineKey).filter(Boolean).map(String);
      if(!keys.length) continue;
      const doneSet = completedByOrder.get(on) || new Set();
      let doneCount = 0;
      for(const k of keys){ if(doneSet.has(k)) doneCount++; }
      const remaining = keys.length - doneCount;
      if(doneCount>0 && remaining>0) partial.push({ orderNo:on, customer:o.customer||"", done:doneCount, total:keys.length });
      else if(doneCount>0 && remaining<=0) full.push({ orderNo:on, customer:o.customer||"", done:doneCount, total:keys.length });
    }
    return { partial, full };
  }


function escapeHtml(s){
  return String(s==null?"":s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}

function tsFromId(id){
  try{
    const n = Number(String(id||"").split("_")[0]);
    return Number.isFinite(n) ? n : 0;
  }catch(_e){ return 0; }
}

function renderCompletedSection(){
  const list = $("completedList");
  const empty = $("completedEmpty");
  const badge = $("completedBadge");
  if(!list || !empty || !badge) return;

  const hist = Array.isArray(state.history) ? state.history.slice() : [];
  hist.sort((a,b)=> tsFromId(b.id||b.at||0) - tsFromId(a.id||a.at||0));

  const entries = hist.filter(h=>h && (h.orderNo || h.customer || h.operator)).slice(0, 10);
  badge.textContent = entries.length ? String(entries.length) : "0";

  list.innerHTML = "";
  if(!entries.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  // status maps (in base all'XML corrente)
  let partialSet = new Set(), fullSet = new Set();
  try{
    const { partial, full } = computePartialOrders();
    for(const p of partial) partialSet.add(String(p.orderNo));
    for(const f of full) fullSet.add(String(f.orderNo));
  }catch(_e){}

  for(const h of entries){
    const orderNo = h.orderNo ? String(h.orderNo) : "—";
    const customer = h.customer || "";
    const operator = h.operator || h.operatorName || (h.userName||"") || "Operatore";
    const at = h.at ? fmtDateTime(h.at) : "";
    const kg = (()=>{
      try{
        if(Array.isArray(h.perLine) && h.perLine.length){
          return Math.round(h.perLine.reduce((a,x)=>a + (Number(x.producedKg||0)||0), 0));
        }
      }catch(_e){}
      return null;
    })();

    let status = "Produzione registrata";
    if(fullSet.has(orderNo)) status = "Ordine concluso";
    else if(partialSet.has(orderNo)) status = "Ordine parzialmente concluso";

    const div = document.createElement("div");
    div.className = "item completedItem";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">Ordine n. ${escapeHtml(orderNo)} ${customer?`· ${escapeHtml(customer)}`:""}</div>
          <div class="completedMeta">
            <div><b>${escapeHtml(operator)}</b></div>
            ${at?`<div class="kv">${escapeHtml(at)}</div>`:""}
            ${kg!=null?`<div class="kv"><b>${kg}</b> kg</div>`:""}
            <div>${escapeHtml(status)}</div>
          </div>
        </div>
        <div class="badge">Dettagli</div>
      </div>
    `;
    div.addEventListener("click", ()=> openHistModal(h.id));
    list.appendChild(div);
  }
}

function openHistModal(id){
  const h = (state.history||[]).find(x=>x && x.id===id);
  if(!h) return;

  const orderNo = h.orderNo ? String(h.orderNo) : "—";
  const customer = h.customer || "";
  const operator = h.operator || h.operatorName || "Operatore";
  $("histTitle").textContent = `Ordine n. ${orderNo}${customer?` · ${customer}`:""}`;
  $("histSub").textContent = `Operatore: ${operator}${h.at?` · ${fmtDateTime(h.at)}`:""}`;

  const body = $("histBody");
  const lines = Array.isArray(h.perLine) ? h.perLine : [];
  const lineHtml = lines.length ? lines.map(l=>`
    <div class="item" style="margin-bottom:10px;">
      <div class="top">
        <div>
          <div class="name">${escapeHtml(l.desc||"")}</div>
          <div class="muted">Pianificati: <b>${escapeHtml(String(l.plannedKg??"—"))}</b> kg · Prodotti: <b>${escapeHtml(String(l.producedKg??"—"))}</b> kg</div>
        </div>
        <div class="badge">${escapeHtml(String(l.qty??""))} ${escapeHtml(String(l.um??""))}</div>
      </div>
      ${l.code?`<div class="muted" style="margin-top:6px;">Codice: <b>${escapeHtml(String(l.code))}</b></div>`:""}
    </div>
  `).join("") : `<div class="muted">Nessun dettaglio righe disponibile.</div>`;

  const sig = h.signature ? `<div style="margin-top:14px;"><div class="muted" style="margin-bottom:6px;">Firma</div><img src="${h.signature}" alt="Firma" style="width:100%; max-width:520px; border:1px solid var(--stroke); border-radius:14px; background:#fff;"></div>` : "";

  body.innerHTML = `
    <div class="muted">Stato: <b>${escapeHtml((()=>{ try{ const {partial,full}=computePartialOrders(); const ps=new Set(partial.map(x=>String(x.orderNo))); const fs=new Set(full.map(x=>String(x.orderNo))); if(fs.has(orderNo)) return "Ordine concluso"; if(ps.has(orderNo)) return "Ordine parzialmente concluso"; }catch(_e){} return "Storico"; })())}</b></div>
    <div style="height:12px"></div>
    ${lineHtml}
    ${sig}
  `;

  $("histModal").classList.add("show");
  lockBody();
}

function renderHome(){
    try{ const el=$('homeWelcome'); if(el && state.user){ el.textContent = `Benvenuto, ${state.user.fullName}`; } }catch(e){}

    const pOrders = state.powderOrders || [];
    const pLines = pOrders.reduce((a,o)=>a + (o.lines?.length||0), 0);
    const pKg = pOrders.reduce((a,o)=>a + (o.totalKg||0), 0);
    $("kPowderLines").textContent = pLines ? pLines.toString() : "0";
    $("kPowderKg").textContent = pKg ? `${Math.round(pKg)}` : "0";
    $("badgeCounts").textContent = `${pOrders.length} ordini`;

    let txt = "Ordini: ";
    if(state.xmlModifiedTime) txt += `aggiornati ${state.xmlModifiedTime}`;
    else if(state.lastFetchAt) txt += `aggiornati ${fmtDateTime(state.lastFetchAt)}`;
    else txt += "in sincronizzazione…";
    $("txtXmlTime").textContent = txt;

    // Banner ordini parzialmente conclusi (globale)
    try{
      const { partial } = computePartialOrders();
      state.partialOrders = partial;
      const b = $("partialBanner");
      if(b){
        if(partial.length){
          b.style.display = "flex";
          const n = partial.length;
          $("partialBannerTitle").textContent = `Ci sono ${n} ordini parzialmente conclusi in corso`;
          $("partialBannerSub").textContent = `Apri Produzione per completare le righe rimanenti.`;
        } else {
          b.style.display = "none";
        }
      }
    }catch(_e){}

    // Ordini conclusi (sezione Home)
    try{ renderCompletedSection(); }catch(_e){}

    const mats = { rame:0, zolfo:0, caolino:0, zeolite:0, corroborante_only:0 };
    for(const o of pOrders){
      for(const l of (o.lines||[])){
        const kg = l.lineKg||0;
        if(l.material==="rame") mats.rame += kg;
        else if(l.material==="zolfo") mats.zolfo += kg;
        else if(l.material==="caolino") mats.caolino += kg;
        else if(l.material==="zeolite") mats.zeolite += kg;
        else if(l.material==="corroborante") mats.corroborante_only += kg;
      }
    }
    const corroTot = mats.caolino + mats.zeolite + mats.corroborante_only;
    const matRows = [
      ["Rame", mats.rame],
      ["Zolfo", mats.zolfo],
      ["Caolino", mats.caolino],
      ["Zeolite", mats.zeolite],
      ["Corroboranti (totale)", corroTot],
    ];
    const matList = $("matList");
    matList.innerHTML = "";
    for(const [label, v] of matRows){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<div class="top"><div><div class="name">${label}</div><div class="sub">Quantità stimata da ordini in coda</div></div><div class="badge">${Math.round(v)} kg</div></div>`;
      matList.appendChild(div);
    }

    const active = state.activeProductions || [];
    const strip = $("prodStrip");
    if(active.length){
      strip.style.display = "block";
      $("prodCount").textContent = String(active.length);
      const parts = active.slice(0,6).map(p=>`${p.operator||"Operatore"}: ${p.customer||"Cliente"} · Ordine n. ${p.orderNo||"—"}`);
      $("prodMarquee").textContent = parts.join("   •   ") + (active.length>6 ? "   •   ..." : "");
      const ratios = active.map(p=>prodRatio(p));
      const r = ratios.length ? Math.max(...ratios) : 0;
      const hue = Math.max(0, 120 - (120 * Math.min(1,r)));
      strip.style.background = `hsla(${hue}, 80%, 45%, .22)`;
      strip.style.borderColor = `hsla(${hue}, 80%, 55%, .35)`;
    } else {
      strip.style.display = "none";
    }

    renderStats();
  }

  
  async function bumpOperatorKg(uid, fullName, kg){
    if(!state.firebase.ok || !uid) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, "operatorStats", uid);
    await fs.runTransaction(db, async(tx)=>{
      const snap = await tx.get(ref);
      const cur = snap.exists() ? (snap.data()||{}) : {};
      const totalKg = Number(cur.totalKg||0) + Number(kg||0);
      const totalRuns = Number(cur.totalRuns||0) + 1;
      tx.set(ref, { uid, fullName, totalKg, totalRuns, updatedAt: nowIso() }, { merge:true });
    });
  }

  function renderStats(){
    const list = $("statsList");
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    if(!isDesktop){
      list.innerHTML = `<div class="muted">Apri da desktop per vedere le statistiche.</div>`;
      $("statsBadge").textContent = "—";
      return;

    // Admin (solo desktop): reset storico
    try{
      const adminBoxId = "adminStatsBox";
      let box = document.getElementById(adminBoxId);
      if(state.user && state.user.isAdmin && !isMobile()){
        if(!box){
          box = document.createElement("div");
          box.id = adminBoxId;
          box.style.marginTop = "12px";
          box.innerHTML = `
            <div class="divider"></div>
            <div class="stepTitle" style="font-size:14px; margin-top:0;">Admin</div>
            <button class="btn bad" id="btnClearHistory" style="width:100%;">Elimina dati storici</button>
            <div class="muted" style="margin-top:8px;">Attenzione: operazione irreversibile.</div>
          `;
          list.parentElement.appendChild(box);
          box.querySelector("#btnClearHistory").onclick = async()=>{
            if(!confirm("Eliminare TUTTI i dati storici di produzione?")) return;
            if(!confirm("Conferma finale: questa operazione è irreversibile.")) return;
            try{
              const fs = state.firebase.api;
              const db = state.firebase.db;
              const cols = ["powderProdHistory","operatorStats"];
              for(const c of cols){
                const snap = await fs.getDocs(fs.collection(db, c));
                for(const d of snap.docs){
                  await fs.deleteDoc(d.ref);
                }
              }
              showToast("Storico eliminato", "Dati storici rimossi.");
            }catch(err){
              console.warn(err);
              showToast("Errore", "Impossibile eliminare lo storico.");
            }
          };
        }
      } else {
        if(box) box.remove();
      }
    }catch(_e){}
    }
    const hist = (state.history||[]).filter(x=>x && x.operator);
    if(!hist.length){
      list.innerHTML = `<div class="muted">Nessun dato storico disponibile (in attesa delle prime produzioni).</div>`;
      $("statsBadge").textContent = "0";
      return;
    }
    const agg = new Map();
    for(const h of hist){
      const op = h.operator;
      const kg = Number(h.kg||0);
      const ms = Number(h.durationMs||0);
      const a = agg.get(op) || { kg:0, ms:0, n:0 };
      a.kg += kg; a.ms += ms; a.n += 1;
      agg.set(op, a);
    }
    const rows = Array.from(agg.entries()).map(([op,a])=>{
      const hours = a.ms/3600000;
      const speed = hours>0 ? (a.kg/hours) : 0;
      return { op, ...a, speed };
    }).sort((x,y)=>y.kg-x.kg);

    $("statsBadge").textContent = String(rows.length);
    list.innerHTML = "";
    for(const r of rows){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${r.op}</div>
            <div class="sub">${r.n} produzioni · Velocità media: ${Math.round(r.speed)} kg/h</div>
          </div>
          <div class="badge">${Math.round(r.kg)} kg</div>
        </div>`;
      list.appendChild(div);
    }
  }

  // ===============================
  // PRODUCTION MODAL FLOW
  // ===============================
  function openProdModal(){
    if(!state.user){
      renderAuthLogin("Per iniziare un ordine devi prima accedere con un account autorizzato.");
      return;
    }
    state.prodModalOpenedAt = Date.now();
    state.startedThisSession = false;
    state.prodModalTouched = false;
    $("prodModal").classList.add("show");
    lockBody();
    renderProdStepOrders();
  }

  function closeProdModalRequest(){
    const elapsed = Date.now() - state.prodModalOpenedAt;
    if(elapsed >= 2000 && !state.startedThisSession){
      $("reasonModal").classList.add("show");
      $("prodModal").classList.remove("show");
      unlockBody();
      // resta bloccato (un'altra overlay è aperta)
      return;
    }
    $("prodModal").classList.remove("show");
    unlockBody();
  }

  function renderProdStepOperator(){
    // (disattivato) operatore già identificato da accesso
    renderProdStepOrders();
  }

  function renderProdStepOrders(){
    $("prodModalTitle").textContent = "Produzione · Ordini";
    const body = $("prodModalBody");
    const orders = state.powderOrders || [];
    body.innerHTML = `
      <div class="stepTitle">Ordini disponibili</div>
      <div class="muted">Operatore: <b>${state.user?.fullName || "—"}</b>. Tocca un cliente: vedrai gli ordini separati per numero.</div>
      <div style="height:10px"></div>
      <div class="list" id="orderList"></div>
    `;

    const list = body.querySelector("#orderList");
    if(!orders.length){
      list.innerHTML = `<div class="muted">Nessun ordine disponibile (attendi sincronizzazione).</div>
        <div style="height:10px"></div>
        <button class="btn" id="btnRetry" style="width:100%;">Riprova sincronizzazione</button>`;
      body.querySelector("#btnRetry").onclick = async()=>{
        body.querySelector("#btnRetry").textContent = "Sincronizzo…";
        await syncOrders(false);
        renderProdStepOrders();
      };
      return;
    }

    const byCust = new Map();
    for(const o of orders){
      const key = o.customer || "Cliente";
      if(!byCust.has(key)) byCust.set(key, []);
      byCust.get(key).push(o);
    }

    for(const [cust, arr] of byCust.entries()){
      const sec = document.createElement("div");
      sec.className = "item";
      sec.innerHTML = `<div class="top"><div><div class="name">${cust}</div><div class="sub">${arr.length} ordini</div></div><div class="badge">Apri</div></div>`;
      sec.style.cursor = "pointer";
      sec.onclick = ()=>{ renderCustomerOrders(cust, arr); };
      list.appendChild(sec);
    }
  }

  function renderCustomerOrders(cust, orders){
    $("prodModalTitle").textContent = `Produzione · ${cust}`;
    const body = $("prodModalBody");
    body.innerHTML = `
      <div class="stepTitle">Ordini per ${cust}</div>
      <div class="muted">Ordini separati per numero. Apri un ordine per vedere le righe.</div>
      <div style="height:10px"></div>
      <div class="list" id="custOrders"></div>
      <div style="height:12px"></div>
      <button class="btn ghost" id="btnBackOrders" style="width:100%;">← Torna alla lista clienti</button>
    `;
    body.querySelector("#btnBackOrders").onclick = renderProdStepOrders;

    const list = body.querySelector("#custOrders");
    for(const o of orders){
      const div = document.createElement("div");
      div.className = "item";
      div.style.cursor = "pointer";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">Ordine n. ${o.number}</div>
            <div class="sub">Righe: ${o.lines.length} · Kg: ${Math.round(o.totalKg)} · Conclusione: ${o.conclusion||"—"}</div>
          </div>
          <div class="badge">Apri</div>
        </div>`;
      div.onclick = ()=>renderOrderDetail(o);
      list.appendChild(div);
    }
  }

  function renderOrderDetail(order){
    $("prodModalTitle").textContent = `Ordine n. ${order.number}`;
    const body = $("prodModalBody");
    const lines = order.lines || [];
    body.innerHTML = `
      <div class="stepTitle">${order.customer}</div>
      <div class="muted">Seleziona le righe da produrre, poi avvia. (Seleziona tutto = ordine completo)</div>
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAll">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAll">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="lineList"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnStartProd" style="width:100%;">INIZIA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackCust" style="width:100%;">← Torna agli ordini cliente</button>
    `;

    const selected = new Set();
    const lineList = body.querySelector("#lineList");

    function rerenderLines(){
      lineList.innerHTML = "";
      lines.forEach((l)=>{
        const id = l.lineKey;
        const div = document.createElement("div");
        div.className = "item";
        div.style.cursor = "pointer";
        const checked = selected.has(id);
        div.style.borderColor = checked ? "rgba(46,123,255,.55)" : "rgba(255,255,255,.08)";
        div.style.background = checked ? "rgba(46,123,255,.16)" : "rgba(0,0,0,.16)";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${l.desc}</div>
              <div class="sub">Cod: ${l.code||"—"} · Quantità: ${l.qty} ${l.um||""} · Kg stimati: ${Math.round(l.lineKg||0)}</div>
            </div>
            <div class="badge">${checked ? "✓" : "Seleziona"}</div>
          </div>
        `;
        div.onclick = ()=>{
          if(selected.has(id)) selected.delete(id); else selected.add(id);
          state.prodModalTouched = true;
          rerenderLines();
        };
        lineList.appendChild(div);
      });
      body.querySelector("#btnStartProd").disabled = selected.size===0;
      body.querySelector("#btnStartProd").style.opacity = selected.size===0 ? ".6" : "1";
    }

    body.querySelector("#btnSelAll").onclick = ()=>{
      lines.forEach(l=>selected.add(l.lineKey));
      state.prodModalTouched = true;
      rerenderLines();
    };
    body.querySelector("#btnClrAll").onclick = ()=>{
      selected.clear();
      state.prodModalTouched = true;
      rerenderLines();
    };
    body.querySelector("#btnBackCust").onclick = ()=>{
      const custOrders = state.powderOrders.filter(o=>o.customer===order.customer);
      renderCustomerOrders(order.customer, custOrders);
    };

    body.querySelector("#btnStartProd").onclick = async()=>{
      if(!selected.size) return;
      const isFullOrderStart = (selected.size === lines.length);
      const prod = {
        operator: (state.user?.fullName || state.operator || 'Operatore'),
        customer: order.customer,
        orderNo: order.number,
        conclusion: order.conclusion || "",
        totalKg: order.totalKg || 0,
        selectedLineKeys: Array.from(selected),
        isFullOrderStart,
        startedAt: nowIso(),
        active: true
      };
      await upsertActiveProduction(prod);
      state.startedThisSession = true;

      speak(`Ordine: operatore ${(state.user?.fullName||state.operator||'Operatore')} ha avviato ordine ${order.number} del cliente ${order.customer}`);

      $("prodModal").classList.remove("show");
      unlockBody();
      showToast("Produzione avviata", `Operatore ${state.operator} · Ordine n. ${order.number} · ${Math.round(order.totalKg)} kg`);
    };

    rerenderLines();
  }

  // ===============================
  // RUNNING MODAL
  // ===============================
  function openRunningModal(){
    $("runningModal").classList.add("show");
    lockBody();
    renderRunning();
  }

  function renderRunning(){
    const body = $("runningBody");
    const active = state.activeProductions || [];
    if(!active.length){
      body.innerHTML = `<div class="muted">Nessuna produzione attiva al momento.</div>`;
      return;
    }
    body.innerHTML = `<div class="stepTitle">Attività in corso</div><div class="muted">Apri per vedere dettagli e concludere la produzione.</div><div style="height:10px"></div><div class="list" id="runList"></div>`;
    const list = body.querySelector("#runList");

    active
      .sort((a,b)=> (new Date(a.startedAt||0)) - (new Date(b.startedAt||0)))
      .forEach(p=>{
        const elapsedMin = p.startedAt ? Math.floor((Date.now() - new Date(p.startedAt).getTime())/60000) : 0;
        const ratio = prodRatio(p);
        const hue = Math.max(0, 120 - (120 * Math.min(1,ratio)));
        const div = document.createElement("div");
        div.className = "item";
        div.style.cursor = "pointer";
        div.style.borderColor = `hsla(${hue}, 80%, 55%, .35)`;
        div.style.background = `hsla(${hue}, 80%, 45%, .14)`;
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${p.operator||"Operatore"} · Ordine n. ${p.orderNo||"—"}</div>
              <div class="sub">${p.customer||"Cliente"} · ${Math.round(Number(p.totalKg||0))} kg · In corso da ${elapsedMin} min · Conclusione: ${p.conclusion||"—"}</div>
            </div>
            <div class="badge">Apri</div>
          </div>
        `;
        div.onclick = ()=>renderRunningDetail(p);
        list.appendChild(div);
      });
  }

  function renderRunningDetail(p){
    const body = $("runningBody");
    const order = state.powderOrders.find(o=>o.number===p.orderNo && o.customer===p.customer) || null;
    const selected = new Set(p.selectedLineKeys || []);
    const toConclude = new Set(selected);
    const producedKg = new Map();

    const availableLines = order ? order.lines.filter(l=>selected.has(l.lineKey)) : [];
    body.innerHTML = `
      <div class="stepTitle">${p.operator||"Operatore"} · Ordine n. ${p.orderNo}</div>
      <div class="muted">${p.customer} · Seleziona cosa stai concludendo, poi premi “Ho concluso la produzione”.</div>
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAllRun">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAllRun">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="runLines"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnConclude" style="width:100%;">HO CONCLUSO LA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn bad" id="btnCancelProd" style="width:100%;">Annulla produzione in corso</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackRun" style="width:100%;">← Torna a elenco produzioni</button>
    `;

    const runLines = body.querySelector("#runLines");
    function rerender(){
      runLines.innerHTML = "";
      for(const l of availableLines){
        const checked = toConclude.has(l.lineKey);
        const div = document.createElement("div");
        div.className = "item";
        div.style.cursor = "pointer";
        div.style.borderColor = checked ? "rgba(46,123,255,.55)" : "rgba(255,255,255,.08)";
        div.style.background = checked ? "rgba(46,123,255,.16)" : "rgba(0,0,0,.16)";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${l.desc}</div>
              <div class="sub">Kg stimati: ${Math.round(l.lineKg||0)} · Cod: ${l.code||"—"}</div>
              <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
                <div class="muted" style="font-size:12px; font-weight:900; min-width:150px;">Kg prodotti (opzionale)</div>
                <input class="kgInput" data-k="${l.lineKey}" type="number" inputmode="decimal" step="0.1" placeholder="auto" style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--stroke); background: rgba(0,0,0,.02); font-weight:900;"/>
              </div>
            </div>
            <div class="badge">${checked ? "✓" : "Seleziona"}</div>
          </div>`;
        const inp = div.querySelector(".kgInput");
        if(inp){
          const prev = producedKg.get(l.lineKey);
          if(prev!=null) inp.value = prev;
          inp.addEventListener("click", (e)=>e.stopPropagation());
          inp.addEventListener("touchstart", (e)=>e.stopPropagation(), {passive:true});
          inp.addEventListener("input", ()=>{ producedKg.set(l.lineKey, inp.value); });
        }

        div.onclick = ()=>{
          if(toConclude.has(l.lineKey)) toConclude.delete(l.lineKey); else toConclude.add(l.lineKey);
          rerender();
        };
        runLines.appendChild(div);
      }
      $("btnConclude").disabled = toConclude.size===0;
      $("btnConclude").style.opacity = toConclude.size===0 ? ".6" : "1";
    }

    body.querySelector("#btnSelAllRun").onclick = ()=>{
      for(const k of selected) toConclude.add(k);
      rerender();
    };
    body.querySelector("#btnClrAllRun").onclick = ()=>{
      toConclude.clear();
      rerender();
    };
    body.querySelector("#btnBackRun").onclick = renderRunning;

    const canCancel = Boolean(state.user && state.user.isAdmin);
    if(!canCancel){
      body.querySelector("#btnCancelProd").style.display = "none";
    } else {
      body.querySelector("#btnCancelProd").onclick = async()=>{
        if(!confirm("Sei sicuro che vuoi annullare la produzione in corso?")) return;
        await closeActiveProduction(p.id, { cancelled:true });
        showToast("Produzione annullata", `Ordine n. ${p.orderNo} · ${p.customer}`);
        renderRunning();
      };
    }

    body.querySelector("#btnConclude").onclick = async()=>{
      if(!toConclude.size) return;

      const allStarted = toConclude.size === selected.size;
      const askConfirm = Boolean(p.isFullOrderStart) && allStarted;
      if(askConfirm && !confirm("Stai concludendo l’intero ordine. Confermi?")) return;

      const startedAtMs = p.startedAt ? new Date(p.startedAt).getTime() : Date.now();
      const durationMs = Date.now() - startedAtMs;

      // calcolo kg + dettagli righe
      let kg = 0;
      const perLine = [];
      if(order){
        const m = new Map(order.lines.map(l=>[l.lineKey,l]));
        for(const k of toConclude){
          const l = m.get(k);
          if(!l) continue;
          const raw = producedKg.get(k);
          const val = raw!=null && String(raw).trim()!=="" ? Number(String(raw).replace(",", ".")) : NaN;
          const prodVal = Number.isFinite(val) ? val : (l.lineKg||0);
          kg += prodVal;
          perLine.push({
            lineKey: k,
            desc: l.desc,
            code: l.code || "",
            plannedKg: Number(l.lineKg||0),
            producedKg: Number(prodVal||0),
            qty: l.qty,
            um: l.um || ""
          });
        }
      } else {
        kg = Number(p.totalKg||0);
      }

      const ctx = `${p.customer} · Ordine n. ${p.orderNo} · ${Math.round(kg)} kg`;
      openSignModal(ctx, async(signatureDataUrl)=>{
        await closeActiveProduction(p.id, { concluded:true });

        await addHistory({
          operator: (state.user?.fullName || p.operator || "Operatore"),
          operatorUid: state.user?.uid || "",
          customer: p.customer,
          orderNo: p.orderNo,
          kg,
          durationMs,
          startedAt: p.startedAt || nowIso(),
          endedAt: nowIso(),
          concludedLineKeys: Array.from(toConclude),
          totalKgOrder: Number(p.totalKg||0),
          perLine,
          signature: signatureDataUrl,
          statementAccepted: true
        });

        // aggiorna classifica kg (aggregato)
        try{
          await bumpOperatorKg(state.user?.uid || "", state.user?.fullName || p.operator || "Operatore", kg);
        }catch(_e){}

        speak(`Ordine concluso da ${(state.user?.fullName||p.operator||"Operatore")} · ordine ${p.orderNo} · cliente ${p.customer}`);

        showToast("Produzione conclusa", `Operatore ${(state.user?.fullName||p.operator||"Operatore")} · Ordine n. ${p.orderNo} · ${Math.round(kg)} kg`);
        renderRunning();
      });
    };

    rerender();
  }

  
  // ===============================
  // SIGNATURE PAD
  // ===============================
  const sig = { canvas:null, ctx:null, drawing:false, empty:true, last:{x:0,y:0}, dpr:1 };
  function sigInit(){
    if(sig.canvas) return;
    sig.canvas = $("signCanvas");
    sig.ctx = sig.canvas.getContext("2d");
    sig.ctx.lineCap = "round";
    sig.ctx.lineJoin = "round";
    sig.ctx.lineWidth = 3.2;
    sig.ctx.strokeStyle = "#000";

    function resize(){
      const rect = sig.canvas.getBoundingClientRect();
      sig.dpr = Math.max(1, window.devicePixelRatio || 1);
      sig.canvas.width = Math.floor(rect.width * sig.dpr);
      sig.canvas.height = Math.floor(rect.height * sig.dpr);
      sig.ctx.setTransform(sig.dpr,0,0,sig.dpr,0,0);
      sig.ctx.clearRect(0,0,rect.width,rect.height);
      sig.empty = true;
    }
    resize();
    window.addEventListener("resize", resize);

    function pos(e){
      const rect = sig.canvas.getBoundingClientRect();
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      return { x: p.clientX - rect.left, y: p.clientY - rect.top };
    }
    function down(e){
      e.preventDefault();
      sig.drawing = true;
      const p = pos(e);
      sig.last = p;
    }
    function move(e){
      if(!sig.drawing) return;
      e.preventDefault();
      const p = pos(e);
      sig.ctx.beginPath();
      sig.ctx.moveTo(sig.last.x, sig.last.y);
      sig.ctx.lineTo(p.x, p.y);
      sig.ctx.stroke();
      sig.last = p;
      sig.empty = false;
    }
    function up(e){
      if(!sig.drawing) return;
      e.preventDefault();
      sig.drawing = false;
    }

    sig.canvas.addEventListener("pointerdown", down);
    sig.canvas.addEventListener("pointermove", move);
    window.addEventListener("pointerup", up);
    sig.canvas.addEventListener("touchstart", down, {passive:false});
    sig.canvas.addEventListener("touchmove", move, {passive:false});
    window.addEventListener("touchend", up, {passive:false});
  }

  function sigClear(){
    if(!sig.canvas) return;
    const rect = sig.canvas.getBoundingClientRect();
    sig.ctx.clearRect(0,0,rect.width,rect.height);
    sig.empty = true;
  }

  function openSignModal(contextText, onOk){
    sigInit();
    $("signCheck").checked = false;
    $("signContext").textContent = contextText;
    sigClear();
    $("signModal").classList.add("show");
    lockBody();

    const close = ()=>{
      $("signModal").classList.remove("show");
      unlockBody();
      $("signOk").onclick = null;
    };

    $("signClose").onclick = close;
    $("signClear").onclick = ()=>sigClear();
    $("signOk").onclick = ()=>{
      if(!$("signCheck").checked){
        showToast("Conferma richiesta", "Spunta la dichiarazione prima di concludere.");
        return;
      }
      if(sig.empty){
        showToast("Firma richiesta", "Inserisci la firma prima di concludere.");
        return;
      }
      const dataUrl = sig.canvas.toDataURL("image/png");
      close();
      onOk(dataUrl);
    };
  }


  // ===============================
  // HOME interactions
  // ===============================
  $("btnGoProd").addEventListener("click", ()=> openProdModal());
  try{ $("btnPartialOpen").addEventListener("click", ()=> openProdModal()); }catch(_e){}
  $("prodStrip").addEventListener("click", ()=> openRunningModal());

  $("prodModalClose").addEventListener("click", ()=> closeProdModalRequest());
  $("runningClose").addEventListener("click", ()=> { $("runningModal").classList.remove("show"); unlockBody(); });

  // History modal
  try{
    $("histClose").addEventListener("click", ()=>{ $("histModal").classList.remove("show"); unlockBody(); });
    $("histModal").addEventListener("click", (e)=>{ if(e.target===$("histModal")){ $("histModal").classList.remove("show"); unlockBody(); } });
  }catch(_e){}


  // Reason modal: no close without reason
  $("reasonClose").addEventListener("click", ()=>{ $("reasonModal").classList.remove("show"); unlockBody(); });
  $("reasonSend").addEventListener("click", async()=>{
    const txt = $("reasonText").value.trim();
    if(!txt){
      showToast("Motivazione", "Inserisci una motivazione per uscire.");
      return;
    }
    const elapsed = Date.now() - state.prodModalOpenedAt;
    await addAbort({ operator: state.operator || null, reason: txt, elapsedMs: elapsed, device: navigator.userAgent });
    $("reasonText").value = "";
    $("reasonModal").classList.remove("show");
    unlockBody();
    showToast("Operazione non avviata", "Per iniziare un ordine entra in Produzione, seleziona le righe e premi INIZIA PRODUZIONE.");
  });

  // Fatturato reveal
  $("fatValue").addEventListener("click", ()=>{
    const el = $("fatValue");
    if(el.classList.contains("reveal")){
      el.classList.remove("reveal");
      return;
    }
    const pw = prompt("Password per visualizzare il fatturato:");
    if(pw !== ADMIN_PW){
      showToast("Accesso negato", "Password non corretta.");
      return;
    }
    el.classList.add("reveal");
  });

  // Call Matteo (numero fisso)
  const MATTEO_TEL = "+393516709334";
  $("btnCallMatteo").addEventListener("click", ()=>{
    window.location.href = `tel:${MATTEO_TEL}`;
  });

  // Stats helper
  $("btnOpenStats").addEventListener("click", ()=>{
    showToast("Statistiche", "Apri da desktop per vedere la classifica completa.");
    window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
  });

  // Issues (registrazione interna)
  $("btnSendIssue").addEventListener("click", async()=>{
    const txt = $("issueText").value.trim();
    if(!txt){
      showToast("Segnalazione", "Scrivi il problema prima di inviare.");
      return;
    }
    if(!state.user){
      renderAuthLogin("Per inviare una segnalazione è necessario accedere.");
      return;
    }
    const op = state.user.fullName || "Operatore";
    const payload = {
      operator: op,
      operatorUid: state.user.uid,
      text: txt,
      when: fmtDateTime(Date.now()),
      kind: "problema_macchina_o_prodotto",
      url: location.href,
      ua: navigator.userAgent
    };
    await addIssue(payload);
    $("issueText").value = "";
    showToast("Segnalazione registrata", "Ok. La segnalazione è stata salvata. Per urgenze: usa “Chiama Matteo”.", 3200);
  });

  // Periodic updates + strip repaint
  setInterval(()=>{
    syncOrders(false);
    renderHome();
  }, 60000);

  document.addEventListener("visibilitychange", ()=>{
    if(!document.hidden) syncOrders(false);
  });

  document.documentElement.setAttribute("translate","no");
  document.body.setAttribute("translate","no");


  // Blocca zoom (mobile/Android)
  document.addEventListener("gesturestart", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("gesturechange", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("gestureend", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("wheel", (e)=>{ if(e.ctrlKey) e.preventDefault(); }, {passive:false});

  // ===============================
  // PUSH (PWA + FCM Web Push)
  // ===============================
  function isIOS(){
    return /iphone|ipad|ipod/i.test(navigator.userAgent || "");
  }
  function isStandalone(){
    // iOS: navigator.standalone; others: display-mode
    return (window.navigator.standalone === true) || window.matchMedia("(display-mode: standalone)").matches;
  }

  function updatePushPill(){
    const dot = $("#dotPush");
    const txt = $("#txtPush");
    if(!dot || !txt) return;

    const perm = (typeof Notification !== "undefined") ? Notification.permission : "unsupported";
    state.push.permission = perm;

    if(!state.push.supported){
      dot.className = "dot";
      txt.textContent = "Notifiche: non supportate";
      return;
    }
    if(perm !== "granted"){
      dot.className = "dot";
      txt.textContent = "Notifiche: disattive";
      return;
    }
    dot.className = "dot ok";
    txt.textContent = "Notifiche: attive";
  }

  async function registerPushSW(){
    if(!("serviceWorker" in navigator)) throw new Error("Service worker non supportati");
    // Scope: cartella attuale (/tabellone-produzione-live/)
    const swUrl = new URL("firebase-messaging-sw.js", location.href).toString();
    const reg = await navigator.serviceWorker.register(swUrl, { scope: "./" });
    return reg;
  }

  async function savePushToken(token){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const u = state.user || {};
    const id = await tokenDocId(token);
    const ref = fs.doc(db, "powderPushTokens", id);
    await fs.setDoc(ref, {
      token,
      uid: u.uid || "",
      email: u.email || "",
      displayName: u.fullName || u.displayName || "",
      role: (u.isAdmin ? "admin" : "operator"),
      line: "polveri",
      userAgent: navigator.userAgent || "",
      platform: isIOS() ? "ios" : /android/i.test(navigator.userAgent||"") ? "android" : "desktop",
      enabled: true,
      lastSeenAt: fs.serverTimestamp(),
      createdAt: fs.serverTimestamp()
    }, { merge:true });
  }

  async function deletePushToken(token){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = await tokenDocId(token);
    try{ await fs.deleteDoc(fs.doc(db, "powderPushTokens", id)); }catch(_e){}
  }

  async function tokenDocId(token){
    // doc id robusto e corto (sha256)
    const enc = new TextEncoder().encode(token);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  async function pushEnableFlow(){
    if(!state.push.supported){
      showToast("Notifiche non supportate", "Questo browser/dispositivo non supporta le push per questa app.");
      return;
    }

    // iOS: serve installazione
    if(isIOS() && !isStandalone()){
      // mostra banner guida
      const b = $("#iosInstallBanner");
      if(b) b.hidden = false;
      showToast("iPhone/iPad", "Per le push: aggiungi l’app alla schermata Home e aprila dall’icona.");
      return;
    }

    const perm = await Notification.requestPermission();
    state.push.permission = perm;

    if(perm !== "granted"){
      showToast("Notifiche non abilitate", "Permesso negato o non concesso.");
      updatePushPill();
      return;
    }

    try{
      const fm = state.firebase.msgApi;
      const messaging = state.firebase.messaging;
      const swReg = await registerPushSW();

      const token = await fm.getToken(messaging, {
        vapidKey: FCM_VAPID_KEY,
        serviceWorkerRegistration: swReg
      });

      if(!token){
        showToast("Errore notifiche", "Token non generato. Controlla VAPID key in Firebase Console.");
        updatePushPill();
        return;
      }

      state.push.token = token;
      state.push.enabled = true;

      await savePushToken(token);

      // Foreground messages → toast
      try{
        fm.onMessage(messaging, (payload)=>{
          const title = payload?.notification?.title || "Aggiornamento";
          const body = payload?.notification?.body || "";
          showToast(title, body || "Nuova notifica");
          try{ beep(); }catch(_e){}
        });
      }catch(_e){}

      updatePushPill();
      showToast("Notifiche attive", "Perfetto: questo dispositivo riceverà notifiche anche ad app chiusa.");
    }catch(err){
      console.warn(err);
      showToast("Errore notifiche", String(err?.message || err));
      updatePushPill();
    }
  }

  async function pushDisableFlow(){
    try{
      const perm = Notification.permission;
      if(perm !== "granted"){
        showToast("Già disattive", "Su questo dispositivo le push non risultano attive.");
        updatePushPill();
        return;
      }

      const fm = state.firebase.msgApi;
      const messaging = state.firebase.messaging;

      // Recupera token corrente (serve per delete lato client)
      const swReg = await registerPushSW();
      const token = await fm.getToken(messaging, { vapidKey: FCM_VAPID_KEY, serviceWorkerRegistration: swReg }).catch(()=>null);

      if(token){
        await fm.deleteToken(messaging).catch(()=>{});
        await deletePushToken(token);
      }

      state.push.token = "";
      state.push.enabled = false;

      updatePushPill();
      showToast("Notifiche disattivate", "Ok, questo dispositivo non riceverà più push.");
    }catch(err){
      console.warn(err);
      showToast("Errore", "Impossibile disattivare le notifiche su questo dispositivo.");
    }
  }

  function wirePushUI(){
    const btn = $("#pillPush");
    if(btn){
      btn.addEventListener("click", async()=>{
        // toggle
        if(typeof Notification === "undefined"){
          showToast("Non supportato", "Questo browser non supporta le notifiche.");
          return;
        }
        const perm = Notification.permission;
        if(perm === "granted"){
          const ok = confirm("Vuoi DISATTIVARE le notifiche push su questo dispositivo?");
          if(ok) await pushDisableFlow();
        } else {
          await pushEnableFlow();
        }
      });
    }

    const closeBtn = $("#btnIosBannerClose");
    if(closeBtn){
      closeBtn.addEventListener("click", ()=>{
        const b = $("#iosInstallBanner");
        if(b) b.hidden = true;
        localStorage.setItem("IOS_INSTALL_BANNER_HIDE", "1");
      });
    }

    // Mostra banner iOS se necessario
    try{
      if(isIOS() && !isStandalone() && localStorage.getItem("IOS_INSTALL_BANNER_HIDE")!=="1"){
        const b = $("#iosInstallBanner");
        if(b) b.hidden = false;
      }
    }catch(_e){}
  }




// start
  await boot();
  try{ wirePushUI(); updatePushPill(); }catch(_e){}

  </script>
</body>
</html>