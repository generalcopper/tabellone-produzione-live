<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabellone Produzione • Kiosk</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Cyberpunk font (fallback to system if offline) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#05060a; --bg1:#070b12;
      --panel: rgba(10,14,24,.78);
      --panel2: rgba(8,10,18,.70);
      --line: rgba(120,255,255,.22);
      --line2: rgba(255,43,214,.20);
      --text:#eaf7ff;
      --muted: rgba(200,230,255,.72);
      --neonCyan:#35f2ff; --neonMag:#ff2bd6; --neonYel:#ffe66d; --neonGreen:#2bff88;
      --danger:#ff4d4d;

      --r: 18px;
      --pad: 16px;
      --gap: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: Orbitron, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1400px 1100px at 10% 10%, rgba(53,242,255,.10), transparent 55%),
        radial-gradient(1400px 1100px at 85% 15%, rgba(255,43,214,.09), transparent 55%),
        radial-gradient(1200px 900px at 70% 90%, rgba(255,230,109,.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(to bottom,
        rgba(255,255,255,.016), rgba(255,255,255,.016) 1px,
        transparent 1px, transparent 7px);
      opacity:.18; pointer-events:none; mix-blend-mode:overlay;
      z-index:1;
    }

    .wrap{height:100%;display:grid;grid-template-rows:auto 1fr;gap:var(--gap);padding:18px;position:relative;z-index:2;}

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow:
        0 0 0 1px rgba(53,242,255,0.10),
        0 14px 34px rgba(0,0,0,0.50),
        0 0 46px rgba(53,242,255,0.05),
        0 0 56px rgba(255,43,214,0.03);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }
    .card:after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(53,242,255,0.00), rgba(53,242,255,0.10), rgba(255,43,214,0.08), rgba(53,242,255,0.00));
      opacity:.35; pointer-events:none;
      transform: translate3d(-55%,0,0);
      animation: sweep 7s linear infinite;
    }
    @keyframes sweep{0%{transform: translate3d(-55%,0,0)}100%{transform: translate3d(55%,0,0)}}

    /* TOP BAR */
    .top{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:var(--gap);
      align-items:stretch;
    }

    .titleBox{padding:18px 20px;display:flex;flex-direction:column;gap:10px;justify-content:center;}
    .title{margin:0;font-size:54px;font-weight:900;letter-spacing:1.4px;text-transform:uppercase;text-shadow:0 0 26px rgba(53,242,255,0.18);}
    .subrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);font-weight:900;letter-spacing:0.7px;text-transform:uppercase;font-size:14px;}
    .chip.live{border-color:rgba(53,242,255,0.24);box-shadow:0 0 16px rgba(53,242,255,0.10)}
    .liveDot{width:10px;height:10px;border-radius:999px;background:var(--neonCyan);
      box-shadow:0 0 0 6px rgba(53,242,255,0.12),0 0 18px rgba(53,242,255,0.22);
      animation: livePulse 1.6s ease-in-out infinite;}
    @keyframes livePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.55)}}

    .clockBox{padding:16px 18px;display:grid;grid-template-rows:auto 1fr;}
    .dateLine{margin:0;font-size:26px;font-weight:900;color:rgba(200,230,255,.80);text-transform:capitalize;letter-spacing:0.8px;}
    .timeGrid{display:grid;grid-template-columns: 140px 1fr;align-items:baseline;gap:10px 14px;margin-top:8px;font-variant-numeric:tabular-nums;}
    .timeLabel{text-align:right;font-size:18px;font-weight:900;color:rgba(200,230,255,.72);letter-spacing:1px;text-transform:uppercase;}
    .timeVal{font-size:76px;font-weight:900;line-height:.95;text-shadow:0 0 24px rgba(255,43,214,0.12),0 0 20px rgba(53,242,255,0.10);}

    /* MAIN LAYOUT */
    .main{
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:var(--gap);
      min-height:0;
    }

    /* LEFT STACK */
    .left{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap:var(--gap);
      min-height:0;
    }

    .panel{
      padding: var(--pad);
      display:grid;
      grid-template-rows:auto 1fr;
      gap:12px;
      min-height:0;
    }
    .panelHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .panelTitle{font-size:18px;font-weight:900;letter-spacing:1.2px;text-transform:uppercase;color:rgba(200,230,255,.86);display:flex;align-items:center;gap:10px;}
    .panelTitle .pDot{width:10px;height:10px;border-radius:999px;background:var(--neonMag);box-shadow:0 0 0 6px rgba(255,43,214,0.10)}
    .panelTitle.next .pDot{background:rgba(53,242,255,.95);box-shadow:0 0 0 6px rgba(53,242,255,0.10)}

    .panelMeta{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.04);border-radius:999px;padding:8px 12px;font-weight:900;font-size:14px;letter-spacing:0.6px;text-transform:uppercase;color:rgba(200,230,255,.78)}

    .bigProduct{
      display:grid;
      grid-template-rows:auto auto auto;
      gap:10px;
      min-height:0;
    }
    .pName{font-size:56px;font-weight:900;letter-spacing:0.6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 18px rgba(53,242,255,0.12)}
    .pRow{display:flex;gap:14px;flex-wrap:wrap;align-items:center;}
    .pQty{font-size:52px;font-weight:900;font-variant-numeric:tabular-nums;text-shadow:0 0 16px rgba(255,230,109,0.10)}
    .pFmt{font-size:28px;font-weight:900;color:rgba(200,230,255,.74);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}

    .badge{
      display:inline-flex;align-items:center;gap:12px;
      padding:12px 16px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      font-size:22px;font-weight:900;text-transform:uppercase;letter-spacing:0.8px;
      box-shadow:0 0 20px rgba(53,242,255,0.07);
      white-space:nowrap;
    }
    .dot{width:12px;height:12px;border-radius:999px;background:var(--neonCyan);box-shadow:0 0 0 6px rgba(53,242,255,.14);}
    .badge.todo{border-color:rgba(53,242,255,.28)}
    .badge.todo .dot{background:var(--neonCyan)}
    .badge.done{border-color:rgba(43,255,136,.28)}
    .badge.done .dot{background:var(--neonGreen);box-shadow:0 0 0 6px rgba(43,255,136,.14)}
    .badge.alert{border-color:rgba(255,77,77,.35)}
    .badge.alert .dot{background:var(--danger);box-shadow:0 0 0 6px rgba(255,77,77,.14)}

    .pulse{
      animation: softPulse 1.6s ease-in-out infinite;
    }
    @keyframes softPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.22)}}

    /* RIGHT TABLE */
    .tableWrap{display:grid;grid-template-rows:auto 1fr;min-height:0;}
    .tHeader{
      height:64px;
      display:grid;
      grid-template-columns: 2.2fr 0.9fr 1.1fr 1fr;
      gap:12px;
      align-items:center;
      padding:0 16px;
      border-bottom:1px solid rgba(120,255,255,.16);
      background:rgba(255,255,255,0.03);
      font-size:16px;font-weight:900;text-transform:uppercase;color:rgba(200,230,255,.82);
      letter-spacing:1px;
    }
    .tRows{overflow:auto;min-height:0;}
    .tRow{
      height:78px;
      display:grid;
      grid-template-columns: 2.2fr 0.9fr 1.1fr 1fr;
      gap:12px;
      align-items:center;
      padding:0 16px;
      border-bottom:1px solid rgba(120,255,255,.11);
    }
    .cProd{font-size:24px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cPz{font-size:24px;font-weight:900;text-align:right;font-variant-numeric:tabular-nums;}
    .cTaglia{font-size:18px;font-weight:900;color:rgba(200,230,255,.74);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .cStato{justify-self:end;}

    .miniBadge{display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);font-size:16px;font-weight:900;text-transform:uppercase;letter-spacing:0.7px;}
    .miniDot{width:10px;height:10px;border-radius:999px;background:var(--neonCyan);box-shadow:0 0 0 5px rgba(53,242,255,.12);}
    .miniBadge.todo{border-color:rgba(53,242,255,.24)}
    .miniBadge.todo .miniDot{background:var(--neonCyan)}
    .miniBadge.done{border-color:rgba(43,255,136,.26)}
    .miniBadge.done .miniDot{background:var(--neonGreen);box-shadow:0 0 0 5px rgba(43,255,136,.12)}
    .miniBadge.alert{border-color:rgba(255,77,77,.32)}
    .miniBadge.alert .miniDot{background:var(--danger);box-shadow:0 0 0 5px rgba(255,77,77,.12)}

    /* kiosk-friendly scrollbars */
    .tRows::-webkit-scrollbar, .rowsAny::-webkit-scrollbar{width:18px}
    .tRows::-webkit-scrollbar-thumb, .rowsAny::-webkit-scrollbar-thumb{background:rgba(53,242,255,.20);border:4px solid rgba(0,0,0,.25);border-radius:999px}
    .tRows::-webkit-scrollbar-track, .rowsAny::-webkit-scrollbar-track{background:rgba(255,255,255,.03)}

    /* LOADING OVERLAY */
    .boot{
      position:fixed; inset:0; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(1000px 800px at 30% 20%, rgba(53,242,255,.18), transparent 60%),
        radial-gradient(1000px 800px at 80% 35%, rgba(255,43,214,.14), transparent 60%),
        linear-gradient(180deg, #04050a, #060812);
    }
    .bootCard{
      width:min(1100px, 92vw);
      border-radius: 26px;
      border:1px solid rgba(120,255,255,.22);
      background: rgba(10,14,24,.72);
      box-shadow: 0 20px 60px rgba(0,0,0,.55), 0 0 80px rgba(53,242,255,.08);
      padding: 26px 28px;
    }
    .bootTop{display:flex;align-items:center;justify-content:space-between;gap:18px;}
    .bootTitle{margin:0;font-size:44px;font-weight:900;letter-spacing:1.4px;text-transform:uppercase;}
    .bootHint{color:rgba(200,230,255,.72);font-size:16px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;}
    .barOuter{margin-top:18px;border-radius:999px;border:1px solid rgba(120,255,255,.20);background:rgba(255,255,255,.04);padding:6px;}
    .barInner{height:34px;border-radius:999px;background:linear-gradient(90deg, rgba(53,242,255,.95), rgba(255,43,214,.78), rgba(255,230,109,.55));width:0%;box-shadow:0 0 22px rgba(53,242,255,.14);}
    .bootRow{margin-top:14px;display:flex;align-items:center;justify-content:space-between;gap:14px;}
    .bootText{font-size:18px;font-weight:800;color:rgba(200,230,255,.78);letter-spacing:0.6px;text-transform:uppercase;}
    .bootPct{font-size:22px;font-weight:900;font-variant-numeric:tabular-nums;}

    .debug{position:fixed;left:12px;bottom:10px;z-index:3;color:rgba(200,230,255,0.55);font-size:12px;letter-spacing:0.4px;user-select:none;max-width:85vw;}

    /* responsive tweak */
    @media (max-width: 1400px){
      .title{font-size:44px}
      .timeVal{font-size:60px}
      .pName{font-size:46px}
      .pQty{font-size:44px}
      .tRow{height:70px}
    }
  </style>
</head>

<body>
  <!-- BOOT / LOADING -->
  <div class="boot" id="boot">
    <div class="bootCard">
      <div class="bootTop">
        <p class="bootTitle">AVVIO SISTEMA</p>
        <div class="bootHint">kiosk • 27" • produzione</div>
      </div>
      <div class="barOuter"><div class="barInner" id="bootBar"></div></div>
      <div class="bootRow">
        <div class="bootText" id="bootMsg">Avvio sistema in corso…</div>
        <div class="bootPct" id="bootPct">0%</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="top">
      <div class="card titleBox">
        <p class="title">TABELLONE PRODUZIONE</p>
        <div class="subrow">
          <span class="chip live"><span class="liveDot"></span>LIVE</span>
          <span class="chip">Aggiornamento: <span id="refreshLabel">20s</span></span>
          <span class="chip">Sheet: <span id="sheetState">OK</span></span>
        </div>
      </div>

      <div class="card clockBox">
        <p class="dateLine" id="dateLine">----</p>
        <div class="timeGrid">
          <div class="timeLabel">ITALIA</div><div class="timeVal" id="timeIT">--:--</div>
          <div class="timeLabel">CINA</div><div class="timeVal" id="timeCN">--:--</div>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="left">
        <div class="card panel" id="panelNow">
          <div class="panelHeader">
            <div class="panelTitle"><span class="pDot"></span>PRODOTTO IN CORSO</div>
            <div class="panelMeta">
              <div class="pill" id="nowWhen">—</div>
              <div class="pill" id="nowIdx">#—</div>
            </div>
          </div>
          <div class="bigProduct" id="nowBox">
            <div class="pName" id="nowName">—</div>
            <div class="pRow">
              <div class="pQty" id="nowQty">—</div>
              <div class="pFmt" id="nowFmt">—</div>
            </div>
            <div class="pRow">
              <span class="badge" id="nowBadge"><span class="dot"></span><span id="nowStatus">—</span></span>
            </div>
          </div>
        </div>

        <div class="card panel" id="panelNext">
          <div class="panelHeader">
            <div class="panelTitle next"><span class="pDot"></span>PROSSIMO PRODOTTO</div>
            <div class="panelMeta">
              <div class="pill" id="nextWhen">—</div>
              <div class="pill" id="nextIdx">#—</div>
            </div>
          </div>
          <div class="bigProduct" id="nextBox">
            <div class="pName" id="nextName">—</div>
            <div class="pRow">
              <div class="pQty" id="nextQty">—</div>
              <div class="pFmt" id="nextFmt">—</div>
            </div>
            <div class="pRow">
              <span class="badge" id="nextBadge"><span class="dot"></span><span id="nextStatus">—</span></span>
            </div>
          </div>
        </div>
      </div>

      <div class="card tableWrap">
        <div class="tHeader">
          <div>Prodotto</div>
          <div style="text-align:right">Pz</div>
          <div>Taglia</div>
          <div style="justify-self:end">Stato</div>
        </div>
        <div class="tRows rowsAny" id="tRows"></div>
      </div>
    </div>
  </div>

  <div class="debug" id="debug"></div>

<script>
  // ============== CONFIG (stesso link di prima) ==============
  const REFRESH_MS = 20000;
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbRcMc9ZdrJ0o7jCJZfyCeGuGD3pgxurwbxO6NO_2kizrkg0czCQYR3g0YmUyWffgyBkmBdNe9fiB/pub?output=csv";

  document.getElementById('refreshLabel').textContent = Math.round(REFRESH_MS/1000) + 's';

  // ============== BOOT LOADING + VOICE ==============
  const bootEl = document.getElementById('boot');
  const bootBar = document.getElementById('bootBar');
  const bootPct = document.getElementById('bootPct');
  const bootMsg = document.getElementById('bootMsg');

  function setBoot(p){
    const v = Math.max(0, Math.min(100, Math.round(p)));
    bootBar.style.width = v + '%';
    bootPct.textContent = v + '%';
  }

  async function tryPlayBootVoice(){
    // 1) If a local boot.mp3 exists, use it (ElevenLabs export).
    // 2) Otherwise, fallback to speechSynthesis.
    // Note: autoplay audio can be blocked unless Chrome kiosk allows it.
    try{
      const audio = new Audio('boot.mp3');
      audio.volume = 1.0;
      await audio.play();
      return;
    }catch(_){/* ignore */}

    try{
      const u = new SpeechSynthesisUtterance('Avvio sistema in corso');
      u.lang = 'it-IT';
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(_){/* ignore */}
  }

  function bootSequence(){
    tryPlayBootVoice();
    let p = 0;
    setBoot(0);
    bootMsg.textContent = 'Avvio sistema in corso…';
    // Watchdog: in kiosk capita che l’audio o il fetch restino bloccati.
    // Dopo 10s chiudiamo comunque il boot e mostriamo lo stato "ERRORE" dentro la UI.
    window.__bootWatchdog && clearTimeout(window.__bootWatchdog);
    window.__bootWatchdog = setTimeout(() => {
      if(!firstOk){
        bootMsg.textContent = 'Connessione lenta / offline';
        bootDone();
      }
    }, 10000);
    const t = setInterval(() => {
      // go fast to 90, then wait for first data load to reach 100
      if(p < 90) p += 3 + Math.random()*3;
      else p = 90;
      setBoot(p);
      if(p >= 90) clearInterval(t);
    }, 90);
  }

  function bootDone(){
    setBoot(100);
    bootMsg.textContent = 'Sistema pronto';
    setTimeout(() => { bootEl.style.display = 'none'; }, 350);
  }

  // ============== CLOCK ==============
  function tickClock(){
    const now = new Date();
    document.getElementById("timeIT").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("timeCN").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Asia/Shanghai",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("dateLine").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(now);
  }

  // ============== CSV PARSE (uguale al vecchio) ==============
  function parseCSV(text){
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;

    for(let i=0;i<text.length;i++) {
      const ch = text[i];
      if(ch === '"') {
        if(inQ && text[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if(ch === "," && !inQ) {
        row.push(cur); cur="";
      } else if(ch === "\n" && !inQ) {
        row.push(cur); rows.push(row);
        row = []; cur="";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    rows.push(row);
    return rows;
  }

  // ============== LOAD JOBS (compatibile con header IT/EN) ==============
  function fetchWithTimeout(url, ms){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    return fetch(url, { cache:"no-store", signal: ctrl.signal })
      .finally(() => clearTimeout(t));
  }

  async function loadJobsCSV(){
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetchWithTimeout(url, 7000);
    if(!res.ok) throw new Error("HTTP " + res.status + " leggendo CSV");
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(v => (v||"").trim() !== ""));
    if(rows.length <= 1) return [];

    const header = rows[0].map(x => (x||"").trim().toLowerCase());
    const pick = (...names) => {
      for(const n of names){
        const idx = header.indexOf(n);
        if(idx !== -1) return idx;
      }
      return -1;
    };

    // supporto colonne: prodotto/stato/pz/taglia (IT) oppure product/status/qty/format/unit (EN)
    const idx = {
      product: pick('prodotto','product') !== -1 ? pick('prodotto','product') : 0,
      qty: pick('pz','qty','quantità','quantita','qta') !== -1 ? pick('pz','qty','quantità','quantita','qta') : 1,
      unit: pick('unit','u.m.','um','misura') !== -1 ? pick('unit','u.m.','um','misura') : -1,
      format: pick('taglia','format','formato') !== -1 ? pick('taglia','format','formato') : 3,
      status: pick('stato','status') !== -1 ? pick('stato','status') : 4,
    };

    const jobs = [];
    for(let i=1;i<rows.length;i++) {
      const r = rows[i];
      const job = {
        product: (r[idx.product] ?? "").trim(),
        qty: (r[idx.qty] ?? "").trim(),
        unit: (idx.unit >= 0 ? (r[idx.unit] ?? "").trim() : ""),
        format: (r[idx.format] ?? "").trim(),
        status: (r[idx.status] ?? "").trim(),
      };
      if(!(job.product || job.qty || job.format || job.status)) continue;
      jobs.push(job);
    }
    return jobs;
  }

  // ============== RENDER HELPERS ==============
  const debugEl = document.getElementById('debug');
  function dbg(msg){ debugEl.textContent = msg; }

  function classifyStatus(st){
    const s = (st||"").toUpperCase();
    if(s.includes('CORSO') || s.includes('IN CORSO') || s.includes('RUN')) return 'inprogress';
    if(s.includes('DONE') || s.includes('FATTO') || s.includes('COMPLET')) return 'done';
    if(s.includes('STOP') || s.includes('ERRO') || s.includes('ALLAR')) return 'alert';
    return 'todo';
  }

  function setBadge(elBadge, elText, status, pulse){
    const kind = classifyStatus(status);
    elBadge.classList.remove('todo','done','alert','pulse');
    if(kind === 'done') elBadge.classList.add('done');
    else if(kind === 'alert') elBadge.classList.add('alert');
    else elBadge.classList.add('todo');
    if(pulse) elBadge.classList.add('pulse');
    elText.textContent = status || '—';
  }

  function formatQty(qty, unit){
    const q = (qty||'').trim();
    const u = (unit||'').trim();
    return (q + (u ? ' ' + u : '')).trim() || '—';
  }

  function findNowNext(jobs){
    // PRODOTTO IN CORSO: prima riga con "CORSO" nel testo, altrimenti prima riga
    let nowIdx = jobs.findIndex(j => classifyStatus(j.status) === 'inprogress');
    if(nowIdx < 0) nowIdx = 0;
    const now = jobs[nowIdx] || null;

    // PROSSIMO: riga successiva, altrimenti null
    const next = (jobs.length > nowIdx+1) ? jobs[nowIdx+1] : null;

    return { now, next, nowIdx, nextIdx: (next ? nowIdx+2 : null) };
  }

  function renderPanels(jobs){
    const { now, next, nowIdx, nextIdx } = findNowNext(jobs);

    const nowName = document.getElementById('nowName');
    const nowQty  = document.getElementById('nowQty');
    const nowFmt  = document.getElementById('nowFmt');
    const nowBadge= document.getElementById('nowBadge');
    const nowStatus= document.getElementById('nowStatus');

    if(now){
      nowName.textContent = now.product || '—';
      nowQty.textContent  = formatQty(now.qty, now.unit);
      nowFmt.textContent  = now.format || '—';
      setBadge(nowBadge, nowStatus, now.status, true); // pulsazione sul prodotto in corso
      document.getElementById('nowIdx').textContent = '#' + (nowIdx+1);
      document.getElementById('nowWhen').textContent = 'LIVE';
    } else {
      nowName.textContent = 'Nessun dato';
      nowQty.textContent  = '—';
      nowFmt.textContent  = '—';
      setBadge(nowBadge, nowStatus, 'CONTROLLA SHEET', true);
      document.getElementById('nowIdx').textContent = '#—';
      document.getElementById('nowWhen').textContent = '—';
    }

    const nextName = document.getElementById('nextName');
    const nextQty  = document.getElementById('nextQty');
    const nextFmt  = document.getElementById('nextFmt');
    const nextBadge= document.getElementById('nextBadge');
    const nextStatus= document.getElementById('nextStatus');

    if(next){
      nextName.textContent = next.product || '—';
      nextQty.textContent  = formatQty(next.qty, next.unit);
      nextFmt.textContent  = next.format || '—';
      setBadge(nextBadge, nextStatus, next.status || 'IN ATTESA', false);
      document.getElementById('nextIdx').textContent = '#' + (nowIdx+2);
      document.getElementById('nextWhen').textContent = 'NEXT';
    } else {
      nextName.textContent = '—';
      nextQty.textContent  = '—';
      nextFmt.textContent  = '—';
      setBadge(nextBadge, nextStatus, '—', false);
      document.getElementById('nextIdx').textContent = '#—';
      document.getElementById('nextWhen').textContent = '—';
    }
  }

  function renderTable(jobs){
    const tRows = document.getElementById('tRows');
    tRows.innerHTML = '';

    if(!jobs.length){
      const tr = document.createElement('div');
      tr.className = 'tRow';
      tr.innerHTML = `<div class="cProd">Nessun dato</div><div class="cPz">—</div><div class="cTaglia">—</div><div class="cStato"><span class="miniBadge todo"><span class="miniDot"></span>CONTROLLA SHEET</span></div>`;
      tRows.appendChild(tr);
      return;
    }

    jobs.forEach((j, i) => {
      const tr = document.createElement('div');
      tr.className = 'tRow';

      const kind = classifyStatus(j.status);
      const badgeClass = (kind==='done') ? 'done' : (kind==='alert' ? 'alert' : 'todo');
      const statoTxt = (j.status || '').toUpperCase() || '—';

      tr.innerHTML = `
        <div class="cProd" title="${escapeHtml(j.product||'')}">${escapeHtml(j.product||'—')}</div>
        <div class="cPz">${escapeHtml(j.qty||'—')}</div>
        <div class="cTaglia" title="${escapeHtml(j.format||'')}">${escapeHtml(j.format||'—')}</div>
        <div class="cStato"><span class="miniBadge ${badgeClass}"><span class="miniDot"></span>${escapeHtml(statoTxt)}</span></div>
      `;
      tRows.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  // ============== REFRESH LOOP ==============
  let inFlight = false;
  let firstOk = false;

  async function refreshJobs(){
    if(inFlight) return;
    inFlight = true;
    try{
      document.getElementById('sheetState').textContent = 'CARICO…';
      const jobs = await loadJobsCSV();

      renderPanels(jobs);
      renderTable(jobs);

      document.getElementById('sheetState').textContent = 'OK';
      dbg('OK • aggiornato ' + new Date().toLocaleTimeString('it-IT'));

      if(!firstOk){
        firstOk = true;
        bootDone();
      }
    }catch(e){
      document.getElementById('sheetState').textContent = 'ERRORE';
      const msg = (e && e.message) ? e.message : String(e);
      dbg('ERRORE • ' + msg);

      // Se il primo caricamento fallisce, non restare bloccato al boot.
      if(!firstOk){
        firstOk = true;
        bootMsg.textContent = 'Offline / errore sheet';
        bootDone();
      }

      renderPanels([{product:'Errore lettura sheet', qty:'—', unit:'', format: msg, status:'ERRORE'}]);
      renderTable([{product:'Errore lettura sheet', qty:'—', unit:'', format: msg, status:'ERRORE'}]);
    }finally{
      inFlight = false;
    }
  }

  // START
  bootSequence();
  tickClock();
  setInterval(tickClock, 1000);

  refreshJobs();
  setInterval(refreshJobs, REFRESH_MS);
</script>
</body>
</html>
