<!doctype html>
<html lang="it" translate="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="google" content="notranslate"/>
  <meta http-equiv="Content-Language" content="it"/>
  <meta name="color-scheme" content="light"/>
  <!-- PWA / Standalone -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0f14">
  <link rel="manifest" href="/tabellone-produzione-live/manifest.webmanifest">
  <!-- // UI-FIX: anticache --><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <!-- // UI-FIX: anticache --><meta http-equiv="Pragma" content="no-cache" />
  <!-- // UI-FIX: anticache --><meta http-equiv="Expires" content="0" />
  <title>Hub Linea Polveri</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2716%27 fill=%27%232e7bff%27/%3E%3Cpath d=%27M22 43c0-11 8-20 20-20h2v6h-2c-8 0-14 6-14 14v2h-6v-2z%27 fill=%27white%27/%3E%3Cpath d=%27M40 33a6 6 0 1 1 0-12h2v6h-2a0 0 0 0 0 0 0 0 0 0 0 0 0 6z%27 fill=%27white%27 opacity=%270.9%27/%3E%3C/svg%3E">
  <style>
    :root {
      --bg: #f5f5f7;
      --bg2: #ffffff;
      --card: #ffffff;
      --card2: #ffffff;
      --stroke: rgba(0,0,0,.10);
      --text: rgba(0,0,0,.90);
      --muted: rgba(0,0,0,.62);
      --accent:#0a84ff;
      --good:#34c759;
      --warn:#ff9f0a;
      --bad:#ff3b30;
      --shadow: 0 10px 26px rgba(0,0,0,.10);
      --radius: 18px;
      --radius2: 22px;
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
      --banner-offset: 0px;
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Avenir Next", Avenir, "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color: var(--text);
      overflow-y: auto;
      overflow-x: hidden;
      max-width: 100vw;
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: calc(18px + var(--safe-top) + var(--banner-offset)) 16px calc(26px + var(--safe-bot));
    }
    @media (min-width: 1500px){
      .wrap{ max-width: 1400px; }
    }

    header {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .titleWrap{ display:flex; flex-direction:column; gap:4px; }
    .title {
      font-size: 36px;
      line-height: 1.05;
      font-weight: 800;
      letter-spacing: -0.02em;
      text-transform: none;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      word-break: break-word;
    }
    .title .titleLine{ display:block; }
    .title .titleLine.accent{ color: #0a84ff; }
    .subtitle {
      margin-top: 2px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    @media (max-width: 720px){
      header { flex-direction: column; align-items:flex-start; }
      .statusRow { justify-content:flex-start; }
      .title { flex-direction:column; align-items:flex-start; text-align:left; width:100%; }
      .titleWrap{ width:100%; text-align:left; align-items:flex-start; }
      .subtitle{ text-align:left; }
    }

    .statusRow {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      width:100%;
    }
    .pill {
      padding: 8px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .dot {
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
    }
    .dot.ok { background: var(--good); }
    .dot.warn { background: var(--warn); }
    .dot.bad { background: var(--bad); }

    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 980px){
      .grid {
        grid-template-columns: 1.05fr .95fr;
        align-items:start;
      }
      .title { font-size: 46px; }
      /* UI-FIX: show-completed-desktop */
      #completedCard{ display:block !important; }
    }
    @media (min-width: 1280px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card {
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      box-sizing: border-box;
    }
    .card .hd {
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .card .hd h2 {
      margin:0;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .02em;
      color: rgba(0,0,0,.88);
      text-transform: uppercase;
    }
    .card .bd {
      padding: 14px;
    }

    .primaryBtn {
      width:100%;
      border: none;
      border-radius: 20px;
      padding: 18px 18px;
      background: linear-gradient(180deg, rgba(46,123,255,1), rgba(18,105,245,.9));
      color: white;
      font-weight: 900;
      font-size: 19px;
      letter-spacing: .02em;
      box-shadow: 0 18px 36px rgba(46,123,255,.28);
      cursor:pointer;
      min-height: 56px;
      transition: transform .15s cubic-bezier(.22,.61,.36,1), box-shadow .18s ease, filter .18s ease;
    }
    .primaryBtn:active { transform: translateY(1.5px) scale(.995); box-shadow: 0 12px 22px rgba(46,123,255,.2); }
    .primaryBtn:focus-visible{ outline: 2px solid rgba(46,123,255,.35); outline-offset: 2px; }
    .warnBanner{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(255,149,0,.12);
      border:1px solid rgba(255,149,0,.28);
      transition: opacity .18s ease, transform .2s cubic-bezier(.22,.61,.36,1);
    }
    .warnBanner .icon{ font-size:20px; line-height:1; }
    .warnBanner .txt{ flex:1; min-width:0; }
    .warnBanner .txt .t{ font-weight: 900; color: rgba(0,0,0,.88); }
    .warnBanner .txt .s{ margin-top:2px; font-size:12px; color: rgba(0,0,0,.62); }
    .alertBanner{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.04);
      font-weight: 900;
      letter-spacing: .01em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
      transition: opacity .2s ease, transform .2s cubic-bezier(.22,.61,.36,1);
    }
    .alertBanner .label{ flex:1; min-width:0; word-break: break-word; }
    .alertBanner .hint{ font-size: 12px; color: rgba(0,0,0,.7); font-weight:800; }
    /* CODEX: banner sacchetto bianco */
    .whiteBagBanner{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:14px;
      flex-wrap:wrap;
      width:100%;
      padding:16px 16px;
      margin: 0;
      border-radius:18px;
      background: linear-gradient(180deg, #ffffff 0%, #f6f8ff 100%);
      border:1px solid rgba(10,132,255,.18);
      color:#0a3a7d;
      font-weight: 900;
      letter-spacing: .01em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 12px 26px rgba(0,0,0,.06);
      line-height: 1.25;
      pointer-events: auto; /* CODEX: il banner resta cliccabile per la selezione */
      word-break: break-word;
    }
    .whiteBagBanner .icon{ font-size:22px; }
    .whiteBagBanner .txt{ display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; }
    .whiteBagBanner .txt .t{ font-size:15px; letter-spacing:.02em; }
    .whiteBagBanner .txt .s{ font-size:13px; font-weight:800; opacity:.9; }
    .fadeCard{ opacity:0; transform: translateY(6px); }
    .fadeCard.show{ opacity:1; transform: translateY(0); }
    .planMessage{
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
      margin-bottom: 10px;
    }
    .planMessage .headline{ font-weight: 950; letter-spacing:.01em; }
    .planMessage ul{ margin: 10px 0 0 18px; color: var(--muted); font-weight:800; padding-left: 12px; }
    .planMessage li{ margin-bottom: 6px; }
    .miniBtn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,149,0,.88);
      color:white;
      font-weight: 900;
      letter-spacing:.01em;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(255,149,0,.22);
      white-space:nowrap;
    }
    .miniBtn:active{ transform: translateY(1px); }


    .row2 {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap:10px;
    }
    .btn {
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.88);
      padding: 14px 12px;
      border-radius: 16px;
      font-weight: 800;
      cursor:pointer;
      min-height: 44px;
    }
    .btn:active { transform: translateY(1px); }
    .btn.good { background: rgba(32,201,151,.16); border-color: rgba(32,201,151,.35); }
    /* UI-FIX: btnConclude-green */
    button#btnConclude.btn.good{
      background: linear-gradient(135deg, #00d26a, #00be5c 52%, #009f4b);
      border-color: rgba(0,168,83,.55);
      color: #fff;
      box-shadow: 0 12px 26px rgba(0,171,77,.34);
    }
    button#btnConclude.btn.good:active{
      transform: translateY(1px);
      box-shadow: 0 8px 18px rgba(0,171,77,.24);
    }
    .btn.bad { background: rgba(255,77,79,.14); border-color: rgba(255,77,79,.35); }
    .btn.ghost { background: transparent; }

    .bigStrip {
      border-radius: 18px;
      padding: 14px 14px;
      border: 1px solid rgba(0,168,83,.2);
      background: linear-gradient(135deg, #00d26a, #00be5c 52%, #009f4b);
      position: relative;
      overflow:hidden;
      cursor:pointer;
      color: white;
      box-shadow: 0 16px 34px rgba(0,171,77,.34);
      transition: transform .12s ease, box-shadow .18s ease;
    }
    .bigStrip:active{ transform: translateY(1px); box-shadow: 0 12px 24px rgba(0,171,77,.26); }
    .bigStrip .label {
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .06em;
      opacity:.95;
    }
    .bigStrip .marquee {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
      padding-bottom: 2px;
    }
    .bigStrip .marquee span {
      display:inline-block;
      padding-left: 100%;
      animation: marquee 16s linear infinite;
    }
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .bigStrip .meta {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.88);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .kv {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .k {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .k .t { font-size: 12px; color: var(--muted); font-weight:700; }
    .k .v { margin-top: 4px; font-size: 18px; font-weight: 900; }

    .list {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 12px;
      overflow-wrap:anywhere;
    }
    .item .top {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .item .name {
      font-weight: 900;
      font-size: 16px;
      line-height:1.1;
      word-break:break-word;
    }
    .item .sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      word-break: break-word;
    }
    .badge {
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      max-width:100%;
    }
    .pressCard{
      cursor:pointer;
      transition: transform .16s cubic-bezier(.18,.69,.25,1), box-shadow .18s ease, background .18s ease, opacity .18s ease;
      will-change: transform, opacity;
    }
    .pressCard:active{
      transform: scale(.99);
      box-shadow: 0 12px 32px rgba(0,0,0,.14);
    }
    .magGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 1100px){
      .magGrid{ grid-template-columns: repeat(auto-fit, minmax(440px, 1fr)); align-items:start; }
    }
    .magBox{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.02);
    }
    .magTitle{
      font-weight: 900;
      font-size: 15px;
      margin: 0 0 8px;
      letter-spacing: .02em;
    }
    .magList{ display:flex; flex-direction:column; gap:8px; }
    .magRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.05);
    }
    .magRow .l{ font-weight:900; font-size:13px; color:rgba(0,0,0,.9); flex:1; min-width:0; }
    .magRow .s{ color:var(--muted); font-size:12px; margin-top:4px; }
    .magRow .v{ font-weight:1000; letter-spacing:.01em; white-space:nowrap; }
    .magDetailGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      align-items:stretch;
    }
    @media (min-width: 980px){
      .magDetailGrid{ grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); }
    }
    .magDetailGrid .item{
      height:100%;
      display:flex;
      flex-direction:column;
    }
    .magPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      font-size:12px;
      font-weight:900;
      color:rgba(0,0,0,.82);
    }
    .magBadge{ background: rgba(0,0,0,.06); border-radius:12px; padding:3px 8px; font-size:11px; font-weight:900; }
    .signaturePad{ touch-action: none; background:#fff; }

    .blur {
      filter: blur(10px);
      opacity: .85;
      transition: filter .12s ease, opacity .12s ease;
    }
    .blur.reveal {
      filter: blur(0px);
      opacity: 1;
    }

    /* Modals */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      padding-bottom: calc(14px + var(--safe-bot));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .18s cubic-bezier(.22,.61,.36,1), visibility 0s linear .18s;
    }
    .overlay.show { opacity:1; visibility:visible; pointer-events:auto; transition-delay: 0s; }
    .sheet {
      width: min(980px, 100%);
      max-width: 100vw;
      max-height: 88vh;
      background: #ffffff;
      border: 1px solid var(--stroke);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-sizing: border-box;
      transform: translateY(10px) scale(.995);
      opacity: 0;
      transition: transform .22s cubic-bezier(.22,.61,.36,1), opacity .2s ease;
    }
    .overlay.show .sheet{
      transform: translateY(0) scale(1);
      opacity:1;
    }
    @media (prefers-reduced-motion: reduce){
      .overlay{ transition:none; }
      .sheet{ transition:none; transform:none !important; }
      .pressCard, .warnBanner, .alertBanner{ transition:none; }
    }
    .sheet .shd {
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
    }
    .sheet .shd .h {
      font-weight: 1000;
      letter-spacing: .02em;
      font-size: 14px;
      text-transform: uppercase;
      opacity: .9;
    }
    .sheet .shd .x {
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.86);
      font-size: 18px;
      font-weight: 900;
      cursor:pointer;
    }
    .sheet .sbd {
      padding: 14px;
      overflow:auto;
    }
    @media (max-width: 720px){
      .sheet{border-radius: 18px; max-height: 90vh;}
      .sheet .sbd{padding-bottom: calc(18px + var(--safe-bot));}
    }
    .stepTitle {
      font-size: 18px;
      font-weight: 950;
      margin: 0 0 10px;
    }
    .muted {
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .radioRow {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .radio {
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.03);
      cursor:pointer;
      font-weight: 900;
    }
    .radio input { accent-color: var(--accent); width:18px; height:18px; }
    .divider {
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bot));
      z-index: 10050;
      width: min(520px, calc(100% - 28px));
      border: 1px solid var(--stroke);
      background: #ffffff;
      color: rgba(0,0,0,.90);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      display:none;
    }
    .toast.show { display:block; }
    .toast .tt { font-weight: 950; }
    .toast .tb { margin-top: 6px; color: var(--muted); font-weight: 700; font-size: 13px; }

    /* Startup legal screen */
    #startup {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
      background: radial-gradient(1000px 700px at 50% -20%, rgba(46,123,255,.35), rgba(46,123,255,0) 55%),
                  linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.45));
      backdrop-filter: blur(14px);
    }
    .startupCard {
      width: min(780px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .startupCard .a {
      padding: 18px 18px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: rgba(0,0,0,.90);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .startupCard .b {
      padding: 18px;
      color: rgba(0,0,0,.88);
      font-weight: 750;
      line-height: 1.35;
    }
    .bootBar {
      height: 10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 14px;
    }
    .bootBar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(46,123,255,1), rgba(32,201,151,1));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .bootMsg {
      margin-top: 10px;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }

    /* Prevent accidental iOS text zoom */
    input, textarea, select, button { font-size: 16px; }

    textarea {
      width:100%;
      min-height: 120px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.90);
      padding: 12px;
      font-weight: 700;
      resize: vertical;
    }
  
    /* Auth gate */
    #authGate{
      position: fixed;
      inset: 0;
      z-index: 10020;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
    }
    #authGate.show{ display:flex; }
    .authCard{
      width: min(720px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 24px 70px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .authCard .ah{
      padding: 16px 16px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .authCard .ab{
      padding: 16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(0,0,0,.62);
      text-transform: uppercase;
      letter-spacing:.06em;
    }
    .field input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.02);
      font-size: 16px;
      font-weight: 800;
      outline: none;
    }
    .authRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .linkBtn{
      border:none;
      background: transparent;
      color: var(--accent);
      font-weight: 900;
      cursor:pointer;
      padding: 0;
    }
    body.noscroll{ overflow:hidden; }

  
    /* Completed orders */
    .completedItem{ cursor:pointer; }
    .completedItem:hover{ background: rgba(0,0,0,.05); }
    .completedMeta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; color: var(--muted); font-size:12px; }
    .kv{ font-variant-numeric: tabular-nums; }


  /* --- Push pill --- */
  .pillBtn{cursor:pointer;border:none}
  .pillBtn:active{transform:scale(.98)}
  .pillBtn:focus{outline:2px solid rgba(255,255,255,.18); outline-offset:2px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Top system banners */
  .topBanner{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 80;
    display:none;
    align-items:center;
    gap:10px;
    padding: calc(10px + var(--safe-top)) 14px 12px;
    background: linear-gradient(180deg, rgba(255, 59, 48, .18), rgba(255, 59, 48, .08));
    border-bottom: 1px solid rgba(255,59,48,.28);
    box-shadow: 0 16px 30px rgba(0,0,0,.18);
  }
  .topBanner.show{ display:flex; }
  .topBanner .icon{ font-size: 20px; }
  .topBanner .body{ flex:1; min-width:0; }
  .topBanner .title{ font-weight: 900; font-size: 16px; }
  .topBanner .sub{ font-size: 13px; color: var(--muted); font-weight: 800; }
  .topBanner .closeBtn{
    border:none;
    border-radius: 14px;
    padding: 10px 12px;
    background: rgba(0,0,0,.06);
    font-weight: 900;
    cursor:pointer;
  }

</style>

  <link rel="manifest" href="hub_linea_polveri.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Hub Polveri">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
</head>
<body>
  <!-- Startup legal + boot -->
  <div id="startup">
    <div class="startupCard">
      <div class="a">Avviso aziendale</div>
      <div class="b">
        I dati visualizzati in questo sistema sono <b>riservati</b> e destinati esclusivamente all’uso interno.<br/>
        È vietata qualsiasi condivisione o diffusione non autorizzata al di fuori dell’azienda.<br/>
        Eventuali violazioni potranno comportare <b>provvedimenti disciplinari</b> e <b>azioni legali</b> secondo quanto previsto dalle normative vigenti.
        <div class="bootBar"><div id="bootFill"></div></div>
        <div id="bootMsg" class="bootMsg">BOOT: inizializzazione…</div>
      </div>
    </div>
  </div>

  
  <!-- Auth gate -->
  <div id="authGate" role="dialog" aria-modal="true">
    <div class="authCard">
      <div class="ah">Accesso operatore</div>
      <div class="ab" id="authBody"></div>
    </div>
  </div>


  <!-- Banner annullamento -->
  <div id="cancelBanner" class="topBanner" role="status" aria-live="polite">
    <div class="icon">⛔️</div>
    <div class="body">
      <div class="title">Produzione annullata</div>
      <div class="sub" id="cancelBannerSub">L’ordine è stato annullato.</div>
    </div>
    <button class="closeBtn" id="cancelBannerClose" type="button">Chiudi</button>
  </div>

  <div class="wrap">
    <header>
      <div class="titleWrap">
        <div class="title" aria-label="Hub linea polveri">
          <span class="titleLine">Hub linea</span>
          <span class="titleLine accent">polveri</span>
        </div>
        <div class="subtitle">Benvenuto <b id="hdrUser">—</b> · Sistema operativo interno</div>
      </div>
      <div class="statusRow">
        <div class="pill" id="pillOnline"><span class="dot" id="dotOnline"></span><span id="txtOnline">Stato: avvio</span></div>
        <div class="pill"><span class="dot ok"></span><span id="txtXmlTime">Ordini: in sincronizzazione…</span></div>
      
        <button class="pill pillBtn" id="pillPush" type="button" title="Attiva/Disattiva notifiche push"><span class="dot" id="dotPush"></span><span id="txtPush">Notifiche: —</span></button>
        <button class="pill pillBtn" id="pillNotif" type="button" title="Registro ordini conclusi">
          <span class="dot ok"></span><span id="txtNotif">Conclusi: 0</span>
        </button>
      </div>
    </header>
    <div class="grid">
      <!-- Left column -->
      <div class="card" id="opsCard">
        <div class="hd">
          <h2>Operatività</h2>
          <div class="badge" id="badgeCounts">—</div>
        </div>
        <div class="bd">
          <button class="primaryBtn" id="btnGoProd">VAI IN PRODUZIONE</button>

          <div style="height:12px"></div>

          <div id="partialBanner" class="warnBanner pressCard fadeCard" style="display:none;" role="button" tabindex="0" aria-label="Ordini parzialmente conclusi">
            <div class="icon">⚠️</div>
            <div class="txt">
              <div class="t" id="partialBannerTitle">Ci sono ordini parzialmente conclusi in corso</div>
              <div class="s" id="partialBannerSub">Apri per vedere solo gli ordini parziali e concludere.</div>
            </div>
            <div class="badge">Apri</div>
          </div>

          <div style="height:12px"></div>

          <div id="prodStrip" class="bigStrip" style="display:none;">
            <div class="label">Produzione in corso</div>
            <div class="marquee"><span id="prodMarquee">—</span></div>
            <div class="meta">
              <div><b id="prodCount">0</b> attività attive</div>
              <div>Tap per dettagli e conclusione</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="kv">
            <div class="k">
              <div class="t">Righe polveri</div>
              <div class="v" id="kPowderLines">—</div>
            </div>
            <div class="k">
              <div class="t">Kg totali</div>
              <div class="v" id="kPowderKg">—</div>
              <div class="muted" id="kPowderMeta" style="margin-top:4px; font-size:12px;">Calcolato su 0 righe visibili</div> <!-- // UI-FIX: kg-totali -->
            </div>
          </div>

          <div style="height:12px"></div>

        </div>
      </div>

      <!-- Right column -->
      <div class="card">
        <div class="hd">
          <h2>Home</h2>
          <div class="badge">scroll</div>
        </div>
        <div class="bd">
          <div class="k" style="margin-bottom:12px;">
            <div class="t">Fatturato lordo</div>
            <div class="v blur" id="fatValue">€ —</div>
            <div class="muted" id="fatSubtitle" style="margin-top:6px;">Desktop: visibile. Mobile: tocca per vedere.</div>
          </div>

          <div class="row2" style="margin-bottom:12px;">
            <button class="btn ghost" id="btnCallMatteo">Chiama Matteo</button>
            <button class="btn ghost" id="btnOpenStats">Statistiche</button>
          </div>

          <div class="card" id="completedCard">
            <div class="hd">
              <h2>Ordini conclusi</h2>
              <div class="badge" id="completedBadge">0</div>
            </div>
            <div class="bd">
              <div class="list" id="completedList"></div>
              <div class="muted" id="completedEmpty" style="display:none;">Nessuna produzione conclusa registrata.</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div id="statsCardAnchor" style="display:none;" aria-hidden="true"></div>
          <div class="card" id="statsCard" style="box-shadow:none; background: rgba(0,0,0,.02); border-radius: 18px;">
            <div class="hd">
              <h2>Statistiche produzione</h2>
              <div class="badge" id="statsBadge">—</div>
            </div>
            <div class="bd">
              <div class="muted">Classifica live (kg totali e velocità media). Disponibile su desktop.</div>
              <div style="height:10px"></div>
              <div id="statsList" class="list"></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" id="warehouseCard" style="display:none;">
            <div class="hd">
              <h2>Gestione magazzino</h2>
              <div class="badge" id="warehouseBadge">—</div>
            </div>
            <div class="bd" id="warehouseBody"></div>
          </div>

<div class="card" style="box-shadow:none; background: rgba(0,0,0,.02); border-radius: 18px;">
            <div class="hd">
              <h2>Segnala un problema</h2>
              <div class="badge">home</div>
            </div>
            <div class="bd">
              <div class="muted">Usa questo riquadro per segnalare: macchina non funzionante, materiale/prodotto non disponibile, o anomalie in linea. La segnalazione viene registrata internamente.</div>
              <div style="height:10px"></div>
              <textarea id="issueText" placeholder="Esempio: 'Macchina dosatrice non parte' oppure 'Prodotto non disponibile in magazzino'. Aggiungi ordine/cliente se utile…"></textarea>
              <div style="height:10px"></div>
              <button class="btn good" id="btnSendIssue" style="width:100%;">Invia segnalazione</button>
            </div>
          </div>

          <div style="height:8px"></div>
          <div class="muted" style="text-align:center;">© General Copper SRL · Uso interno</div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- History detail modal -->
  <div id="histModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div>
          <div class="h" id="histTitle">Dettaglio produzione</div>
          <div class="sub" id="histSub">—</div>
        </div>
        <button class="x" id="histClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="histBody"></div>
    </div>
  </div>

  <!-- Notifications modal -->
  <div id="notifModal" class="overlay" role="dialog" aria-modal="true" aria-label="Notifiche ordini conclusi">
    <div class="sheet">
      <div class="shd">
        <div class="h">Notifiche · Ordini conclusi</div>
        <button class="x" id="notifClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="notifBody"></div>
    </div>
  </div>

<!-- Toast overlay -->
  <div id="toast" class="toast">
    <div class="tt" id="toastTitle">Attenzione</div>
    <div class="tb" id="toastBody">—</div>
  </div>

  <!-- Production modal -->
  <div id="prodModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h" id="prodModalTitle">Produzione</div>
        <button class="x" id="prodModalClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="prodModalBody"></div>
    </div>
  </div>

  <!-- Running productions modal -->
  <div id="runningModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Produzione in corso</div>
        <button class="x" id="runningClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="runningBody"></div>
    </div>
  </div>

  <!-- Partial orders modal -->
  <div id="partialModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Ordini parzialmente conclusi</div>
        <button class="x" id="partialClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="partialBody"></div>
    </div>
  </div>

  
  <!-- Signature modal -->
  <div id="signModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Conclusione · Firma</div>
        <button class="x" id="signClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd">
        <div class="stepTitle">Dichiarazione e firma</div>
        <div class="muted" id="signContext">—</div>
        <div style="height:10px"></div>
        <div class="muted" style="font-weight:800;">
          Dichiarazione: <b>dichiaro</b> che la produzione è stata eseguita secondo le procedure aziendali e i controlli previsti.
        </div>
        <div style="height:10px"></div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="signCheck" type="checkbox" style="width:20px;height:20px; accent-color: var(--good);" />
          <label for="signCheck" style="font-weight:900;">Confermo la dichiarazione</label>
        </div>
        <div style="height:12px"></div>
        <div style="border:1px solid var(--stroke); border-radius:18px; overflow:hidden; background: rgba(0,0,0,.02);">
          <canvas id="signCanvas" class="signaturePad" style="width:100%; height:220px; display:block;"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="row2">
          <button class="btn" id="signClear">Pulisci firma</button>
          <button class="btn good" id="signOk">CONCLUDI</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Reason modal -->

<script type="module">
  // ===============================
  // CONFIG
  // ===============================
  const XML_PROXY_CFG = {
      proxyUrl: "https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",
      cacheKey: "EASYFATT_XML_CACHE_V1"
    };
  const ADMIN_PW = "12345";
  const FIREBASE_IMPORT_APP = "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  const FIREBASE_IMPORT_FS  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  const FIREBASE_IMPORT_AUTH = "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  const FIREBASE_IMPORT_MSG  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };
  // Web Push (FCM): incolla qui la *Public key* (VAPID) da Firebase Console → Project settings → Cloud Messaging → Web Push certificates
  const FCM_VAPID_KEY = "PASTE_PUBLIC_VAPID_KEY_HERE";

  // Email su segnalazione problemi (richiede Firebase Extension: firestore-send-email)
  const ISSUE_EMAIL_ENABLED = false; // metti true quando l'estensione è installata
  const ISSUE_EMAIL_TO = "matteo@generalcoppersrl.com";
  const FAT_VALUE_KEY = "FATTURATO_EUR_CACHE";


  const OPERATORS = ["Hassan","Ahmed","Muhammed","Mustapha","Youssef"];
  const NON_PERTINENT_CODES = new Set(["mast250viri","mast500viri","codmast250viri","codmast500viri"]);
  // CODEX: Distinta base magazzino (default per sacchi 5kg/1kg, valida per tutti i prodotti)
  const MAGAZZINO_DEFAULT_PACKS = {
    5: {
      prodottoKgPerBag: 5,
      bobine: { "Bobina blu f830": { perBag: 20, unit:"g" } },
      etichettePerBag: 1,
      scatole: { "Scatola americana | 20 kg": 0.25 },
      divisori: { "Divisorio Z": 0.25 },
      altri: {}
    },
    1: {
      prodottoKgPerBag: 1,
      bobine: { "Bobina blu f480": { perBag: 10, unit:"g" } },
      etichettePerBag: 1,
      scatole: { "Scatola americana | 20 kg": 0.05 },
      divisori: { "Divisorio Croce texo": 0.05 },
      altri: {}
    }
  };
  const MAGAZZINO_BOM = { // CODEX: Distinta base estendibile per calcolo magazzino (desktop)
    defaultByPackKg: MAGAZZINO_DEFAULT_PACKS, // CODEX: fallback per qualsiasi prodotto (match per formato sacco)
    byCode: {
      // Esempio: "CODICE": { packs: { 5: { prodottoKgPerBag:5, bobine:{ "tipo":{perBag:20, unit:"g"} }, etichettePerBag:1, scatole:{ "model":0.2 }, divisori:{ "tipo":0.1 }, altri:{ "nome":0.1 } } } }
    },
    byName: {
      // Nome normalizzato senza peso → packKg → componenti per singolo sacco/confezione
      "ossicloruro di rame 50%": { packs: MAGAZZINO_DEFAULT_PACKS }
    }
  };

  // UI-FIX: anticache
  try{
    if("serviceWorker" in navigator){
      navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())).catch(()=>{});
    }
  }catch(_e){}

  // ===============================
  // STATE
  // ===============================
  const state = {
    lastAuthErrorMsg: "",

    xmlModifiedTime: null,
    lastFetchAt: null,
    docs: [],
    fatturatoLordo: null, // CODEX: cache fatturato lordo lato client
    powderOrders: [],
    activeProductions: [],
    history: [],
    user: null,
    operator: null,
    prodModalOpenedAt: 0,
    startedThisSession: false,
    prodModalTouched: false,
    firebase: {
      ok: false,
      db: null,
      api: null,
    },
    push: { supported:false, permission:'default', token:'', enabled:false },
  };

  // ===============================
  // UTILS
  // ===============================
  const $ = (id)=>document.getElementById(id);

  function nowIso(){ return new Date().toISOString(); }
  function fmtTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function fmtDateTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,"0");
    const mo = String(dt.getMonth()+1).padStart(2,"0");
    const yy = dt.getFullYear();
    return `${dd}/${mo}/${yy} ${fmtTime(dt)}`;
  }
  function norm(s){
    return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
  }
  function safeText(node){
    return (node && node.textContent ? node.textContent : "").trim();
  }
  function parseCurrencyValue(raw){
    const s = (raw==null?"":String(raw)).replace(/\s+/g,"").replace(/\./g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }
  function parseItNumber(raw){ // UI-FIX: kg-totali
    const s = (raw==null ? "" : String(raw)).replace(/\./g,"").replace(",",".").replace(/\s+/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function formatQtyWithKg(qty, um="kg"){
    const qtyTxt = `${qty ?? 0}`;
    const hasKg = /\bkg\b/i.test(um||"");
    const cleanUm = (um||"").trim();
    if(hasKg) return `${qtyTxt} kg`;
    return cleanUm ? `${qtyTxt} ${cleanUm} · kg` : `${qtyTxt} kg`;
  }
  function isMobile(){
    return window.matchMedia("(max-width: 900px)").matches;
  }
  function fetchWithTimeout(url, ms, opts={}){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    return fetch(url, {...opts, signal: ctrl.signal}).finally(()=>clearTimeout(t));
  }
  function showToast(title, body, ms=3800){
    $("toastTitle").textContent = title;
    $("toastBody").textContent = body;
    $("toast").classList.add("show");
    setTimeout(()=>$("toast").classList.remove("show"), ms);
  }
  function setBannerOffset(px){
    document.documentElement.style.setProperty("--banner-offset", `${px || 0}px`);
  }
  // Banner annullamento: aggiorna offset per safe-area + padding contenuti
  function showCancelBanner(sub="L’ordine è stato annullato."){
    const b = $("cancelBanner");
    const txt = $("cancelBannerSub");
    if(!b || !txt) return;
    txt.textContent = sub;
    b.classList.add("show");
    requestAnimationFrame(()=>{
      const h = b.getBoundingClientRect().height || 0;
      setBannerOffset(h);
    });
  }
  function hideCancelBanner(){
    const b = $("cancelBanner");
    if(!b) return;
    b.classList.remove("show");
    setBannerOffset(0);
  }

  // ===============================
  // BODY LOCK (no background scroll)
  // ===============================
  let _scrollY = 0;
  function lockBody(){
    _scrollY = window.scrollY || 0;
    document.body.classList.add("noscroll");
    document.body.style.top = `-${_scrollY}px`;
    document.body.style.position = "fixed";
    document.body.style.width = "100%";
  }
  function unlockBody(){
    document.body.classList.remove("noscroll");
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.width = "";
    window.scrollTo(0, _scrollY);
  }

  // ===============================
  // BOOT (smooth + fast)
  // ===============================
  const bootFill = $("bootFill");
  const bootMsg = $("bootMsg");
  let bootP = 0;
  function bootSet(p, msg){
    bootP = Math.max(bootP, Math.min(100, p));
    bootFill.style.width = bootP.toFixed(0)+"%";
    if(msg) bootMsg.textContent = msg;
  }
  async function boot(){
    // Boot super smooth: UI sempre pronta, sync in parallelo (mai blocco al 90%)
    bootSet(10, "AVVIO: inizializzazione interfaccia…");
    await new Promise(r=>setTimeout(r, 220));

    bootSet(25, "DOWNLOAD: ordini in corso…");
    const ordersPromise = syncOrders(true);

    bootSet(45, "SYNC: produzione in corso…");
    const livePromise = initLiveSync();

    // Non restare appeso: dopo 3.2s entri comunque nell’hub (sync continua)
    await Promise.race([ordersPromise, new Promise(r=>setTimeout(r, 3200))]);

    bootSet(80, "OTTIMIZZAZIONE: finalizzazione…");
    await Promise.race([livePromise, new Promise(r=>setTimeout(r, 1200))]);

    bootSet(100, "OK: pronto");
    await new Promise(r=>setTimeout(r, 140));
    $("startup").style.display = "none";

    showToast(
      "Operatività",
      "Per avviare un ordine: VAI IN PRODUZIONE → scegli operatore → seleziona righe → INIZIA PRODUZIONE."
    );
  }

  // ===============================
  // XML -> Orders (snello)
  // ===============================
  function detectPackKg(desc){
    const s = norm(desc).replace(/,/g,".");
    let m = s.match(/(\d+(?:\.\d+)?)\s*kg\b/);
    if(m) return parseFloat(m[1]);
    m = s.match(/\bkg\s*(\d+(?:\.\d+)?)\b/);
    if(m) return parseFloat(m[1]);
    m = s.match(/(\d+(?:\.\d+)?)\s*(?:gr|g)\b/);
    if(m) return parseFloat(m[1]) / 1000;
    return null;
  }
  function detectAlertLine(desc){
    const s = norm(desc);
    if(!s) return null;
    if(!/\b(sacco|bobina)\b/.test(s)) return null;
    const colorMatch = s.match(/\b(blu|azzur\w+|ross\w+|bianc\w+|ner\w+|verd\w+|giall\w+)\b/);
    if(!colorMatch) return null;
    if(/\b(rame|zolfo|caolino|ossicloruro|poltiglia|zeolite)\b/.test(s)) return null;
    const rawColor = colorMatch[1];
    const color = rawColor.includes("azzur")||rawColor.includes("blu") ? "blue"
      : rawColor.includes("ross") ? "red"
      : rawColor.includes("bianc") ? "white"
      : rawColor.includes("ner") ? "black"
      : rawColor.includes("verd") ? "green"
      : rawColor.includes("giall") ? "yellow"
      : "other";
    return { label: (desc||"").trim() || "Avviso", color };
  }
  function machineHintFromLines(lines){
    const packs = [];
    for(const l of (lines||[])){
      if(l.alertInfo) continue;
      const direct = Number(l.packKg);
      const fallback = detectPackKg(l.desc || "");
      const val =
        (Number.isFinite(direct) && direct>0) ? direct :
        ((Number.isFinite(fallback) && fallback>0) ? fallback : null);
      if(val!=null) packs.push(val);
    }
    if(!packs.length) return "large";
    const minPack = Math.min(...packs);
    const maxPack = Math.max(...packs);

    // UI-FIX: voice-machine-both
    if(maxPack >= 5 && minPack > 0 && minPack < 5) return "both";
    if(maxPack >= 5) return "large";
    return "small";
  }
  function alertPalette(kind){
    switch(kind){
      case "blue": return { bg:"rgba(46,123,255,.12)", border:"rgba(46,123,255,.35)", color:"#0a3a7d" };
      case "red": return { bg:"rgba(255,59,48,.14)", border:"rgba(255,59,48,.4)", color:"#8a1f1a" };
      case "white": return { bg:"#ffffff", border:"rgba(0,0,0,.12)", color:"#1c1c1e", shadow:"0 1px 0 rgba(0,0,0,.04)" };
      case "black": return { bg:"#1c1c1e", border:"rgba(0,0,0,.6)", color:"#f5f5f7" };
      case "green": return { bg:"rgba(52,199,89,.14)", border:"rgba(52,199,89,.38)", color:"#0b5d2a" };
      case "yellow": return { bg:"rgba(255,204,0,.18)", border:"rgba(255,204,0,.36)", color:"#5c3b00" };
      default: return { bg:"rgba(0,0,0,.05)", border:"rgba(0,0,0,.12)", color:"#1c1c1e" };
    }
  }
  // CODEX: helper locale per banner sacchetto bianco
  function isWhiteBagRow(row){
    if(!row || typeof row !== "object") return false;
    for(const v of Object.values(row)){
      if(typeof v === "string" && v.includes("**")) return true;
    }
    return false;
  }
  // CODEX: riposizionamento Statistiche su desktop (colonna sinistra)
  const statsDesktopMq = window.matchMedia("(min-width: 1024px)");
  function relocateStatsCard(){
    const statsCard = $("statsCard");
    const anchor = $("statsCardAnchor");
    const opsCard = $("opsCard");
    if(!statsCard || !anchor || !opsCard) return;
    const wantsDesktopPlacement = statsDesktopMq.matches;
    const leftParent = opsCard.parentElement;
    if(wantsDesktopPlacement && leftParent){
      if(statsCard.parentElement !== leftParent){
        leftParent.insertBefore(statsCard, opsCard.nextSibling);
      }
    } else {
      const anchorParent = anchor.parentElement;
      if(anchorParent && statsCard.parentElement !== anchorParent){
        anchorParent.insertBefore(statsCard, anchor.nextSibling);
      }
    }
  }
  try{ statsDesktopMq.addEventListener("change", relocateStatsCard); }catch(_e){ try{ statsDesktopMq.addListener(relocateStatsCard); }catch(_e2){} }
  relocateStatsCard();
  // CODEX: render helper per banner sacchetto bianco
  function renderWhiteBagBanner(opts={}){
    const { selectable=true, checked=false, badgeText="" } = opts;
    const badgeLabel = badgeText || (checked ? "✓" : "Seleziona");
    const badgeHtml = selectable ? `<div class="badge">${badgeLabel}</div>` : "";
    return `
      <div class="whiteBagBanner" role="note" aria-label="⚠️ SACCHETTO BIANCO — Devi usare il sacchetto bianco">
        <div class="icon">⚠️</div>
        <div class="txt">
          <div class="t">SACCHETTO BIANCO</div>
          <div class="s">— Devi usare il sacchetto bianco</div>
        </div>
        ${badgeHtml}
      </div>
    `;
  }

  function isPowderLine(code, desc, um){
    const c = norm(code).replace(/\s+/g,"");
    if(c && NON_PERTINENT_CODES.has(c)) return false;

    const s = norm(desc);
    const u = norm(um);

    if(/\b(mastice)\b/.test(s)) return false;
    if(/\b(secchio|tanica|flacone|bottiglia|spray|trigger|pompa|nebul|olio|shampoo|deterg|repel|bio)\b/.test(s)) return false;
    if(/\b\d+(?:[\.,]\d+)?\s*(ml|l|lt)\b/.test(s)) return false;
    if(u === "l" || u === "lt" || u === "ml") return false;

    const packKg = detectPackKg(desc);
    const isBigBag = /\b(big\s*bag|bigbag)\b/.test(s);
    if(packKg != null && packKg > 10.0001 && !isBigBag) return false;
    if(isBigBag && packKg != null && packKg >= 100) return true;

    if(/\b(sacco|sacchetto|busta|bustina|barattolo)\b/.test(s)) return true;
    if(u === "kg" || u === "g") return true;
    if(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/.test(s)) return true;

    if(/\b(ossicloruro|poltiglia|caolino|zeolite|zolfo|rame|solfato|idrossido|tribasico|diatomite|agroblumagic|corrobor)\b/.test(s)) return true;

    return false;
  }

  function materialOf(desc, code=""){
    const s = norm(desc);
    const c = norm(code);
    const has = (re) => re.test(s) || re.test(c);

    if(has(/\b(rame|copper|cupr|cu)\b/) || s.includes("bordolese") || s.includes("poltiglia")) return "rame";
    if(has(/\b(zolfo|sulfur|sulf)\b/)) return "zolfo";
    if(has(/\b(caolino|kaolin|caol)\b/)) return "caolino";
    if(has(/\b(zeolite|zeolit)\b/)) return "zeolite";
    if(has(/\b(diatomite|agroblumagic|corrobor)\b/)) return "corroborante";
    return "altro";
  }

  function cleanShort(desc){
    const s = (desc||"").toString();
    return s
      .replace(/\|\s*CONCIME.*$/i,"")
      .replace(/\|\s*CONSENTITO.*$/i,"")
      .replace(/\|\s*AMMESSO.*$/i,"")
      .replace(/\s{2,}/g," ")
      .trim();
  }
  function extractDocTotal(docNode){
    if(!docNode) return null;
    const tags = ["Total","TotalDoc","TotalDocument","TotalAmount","Amount","DocTotal","TotalWithTax","GrossTotal"];
    for(const tag of tags){
      const val = safeText(docNode.getElementsByTagName(tag)[0]);
      const num = parseCurrencyValue(val);
      if(num!=null) return num;
    }
    return null;
  }

  function parseEasyfattXml(xmlText){
    const outDocs = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlText, "text/xml");
    const docs = Array.from(doc.getElementsByTagName("Document"));
    for(const d of docs){
      const customer = safeText(d.getElementsByTagName("CustomerName")[0]) || "Cliente";
      const number = safeText(d.getElementsByTagName("Number")[0]) || "";
      const date = safeText(d.getElementsByTagName("Date")[0]) || "";
      let conclusion = safeText(d.getElementsByTagName("ExpectedConclusion")[0])
        || safeText(d.getElementsByTagName("ExpectedDeliveryDate")[0])
        || safeText(d.getElementsByTagName("DeliveryDate")[0])
        || "";
      const totalDoc = extractDocTotal(d);

      const lines = [];
      const rows = Array.from(d.getElementsByTagName("Row"));
      for(let i=0;i<rows.length;i++){
        const r = rows[i];
        const code = safeText(r.getElementsByTagName("Code")[0]) || "";
        const desc = safeText(r.getElementsByTagName("Description")[0]) || safeText(r.getElementsByTagName("Name")[0]) || "";
        const um = safeText(r.getElementsByTagName("UM")[0]) || safeText(r.getElementsByTagName("Unit")[0]) || "";
        let qty = safeText(r.getElementsByTagName("Qty")[0]) || safeText(r.getElementsByTagName("Quantity")[0]) || "0";
        qty = parseFloat(qty.replace(",","."));
        if(!Number.isFinite(qty)) qty = 0;

        const alertInfo = detectAlertLine(desc); // CODEX: banner operativi sacchi/bobine
        const powder = alertInfo ? false : isPowderLine(code, desc, um);
        const packKg = detectPackKg(desc);
        const material = powder ? materialOf(desc, code) : "altro";

        const lineKg = (() => {
          if(!powder || alertInfo) return 0;
          if(norm(um)==="kg" || /\bkg\b/.test(norm(um))) return qty;
          if(packKg!=null && qty>0) return qty * packKg;
          if(packKg!=null) return qty*packKg;
          return 0;
        })();

        const lineKey = `${number}|${i}|${(norm(code)||norm(desc).slice(0,24))}`;

        lines.push({
          lineKey,
          code,
          desc: cleanShort(desc),
          um,
          qty,
          powder,
          packKg,
          lineKg,
          material,
          alertInfo,
        });
      }

      outDocs.push({ customer, number, date, conclusion, totalDoc, lines });
    }
    return outDocs;
  }

  async function syncOrders(isBoot=false){
    try {
      setOnlinePill("warn", "Stato: sincronizzazione…");
      if(isBoot) bootSet(40, "DOWNLOAD: ordini in corso…");

      const res = await fetchWithTimeout(XML_PROXY_CFG.proxyUrl, 12000, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if(j && j.ok === false) throw new Error(j.error || "Proxy: errore");
      const xmlText = j?.xml;
      if(!xmlText || typeof xmlText !== "string") throw new Error("XML mancante");

      state.xmlModifiedTime = j?.modifiedTime || null;
      state.lastFetchAt = Date.now();
      localStorage.setItem(XML_PROXY_CFG.cacheKey, JSON.stringify({ at: state.lastFetchAt, xml: xmlText, modifiedTime: state.xmlModifiedTime }));

      state.docs = parseEasyfattXml(xmlText);
      state.fatturatoLordo = computeFatturatoLordo(state.docs); // CODEX: calcolo fatturato lordo da XML

      const powderDocs = [];
      for(const d of state.docs){
        const pLines = d.lines.filter(x=>x.powder);
        if(!pLines.length) continue;
        const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
        const alertLines = d.lines.filter(x=>x.alertInfo);
        powderDocs.push({ customer: d.customer, number: d.number, orderNo: d.number, conclusion: d.conclusion, lines: pLines, alerts: alertLines, totalKg });
      }
      state.powderOrders = powderDocs;

      renderHome();
      setOnlinePill("ok", "Stato: online");
      if(isBoot) bootSet(62, "OK: ordini aggiornati");

    } catch(err) {
      console.warn("syncOrders failed", err);
      const cached = localStorage.getItem(XML_PROXY_CFG.cacheKey);
      if(cached){
        try {
          const c = JSON.parse(cached);
          state.lastFetchAt = c.at || null;
          state.xmlModifiedTime = c.modifiedTime || null;
          state.docs = parseEasyfattXml(c.xml||"");
          state.fatturatoLordo = computeFatturatoLordo(state.docs); // CODEX: calcolo fatturato da cache
          const powderDocs = [];
          for(const d of state.docs){
            const pLines = d.lines.filter(x=>x.powder);
            if(!pLines.length) continue;
            const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
            const alertLines = d.lines.filter(x=>x.alertInfo);
            powderDocs.push({ customer: d.customer, number: d.number, orderNo: d.number, conclusion: d.conclusion, lines: pLines, alerts: alertLines, totalKg });
          }
          state.powderOrders = powderDocs;
        } catch(_e) {}
      }
      renderHome();
      setOnlinePill("bad", "Stato: offline (cache)");
      if(isBoot) bootSet(55, "Connessione lenta… uso cache locale");
    }
  }

  function setOnlinePill(kind, text){
    const dot = $("dotOnline");
    dot.className = "dot";
    if(kind==="ok") dot.classList.add("ok");
    if(kind==="warn") dot.classList.add("warn");
    if(kind==="bad") dot.classList.add("bad");
    $("txtOnline").textContent = text;
  }
  let refreshInFlight = false;
  const debounceRefresh = (()=>{ let t=null; return (reason)=>{ clearTimeout(t); t=setTimeout(()=>triggerRefresh(reason), 180); }; })(); // CODEX: debounce auto-refresh (focus/visibility/pageshow)
  async function triggerRefresh(reason="manual"){
    // Refresh leggero per mobile (focus/pageshow/cta)
    if(refreshInFlight) return;
    refreshInFlight = true;
    try{
      await syncOrders(false);
      renderHome();
      if(reason==="focus" || reason==="pageshow") showToast("Aggiornato", "Dati ricaricati (riapertura).", 1800);
    }finally{
      refreshInFlight = false;
    }
  }

  
  
  function humanAuthErr(err){
    const code = (err && (err.code||err.message||"")).toString();
    const map = {
      "auth/unauthorized-domain": "Dominio non autorizzato. Verifica in Firebase: Authentication → Settings → Domini autorizzati.",
      "auth/operation-not-allowed": "Provider Google non abilitato. Verifica in Firebase: Authentication → Sign-in method.",
      "auth/popup-blocked": "Popup bloccato dal browser. Riprovo con reindirizzamento…",
      "auth/popup-closed-by-user": "Popup chiuso. Riprova.",
      "auth/cancelled-popup-request": "Richiesta annullata. Riprova.",
      "auth/network-request-failed": "Connessione instabile. Riprova tra qualche secondo.",
      "auth/invalid-api-key": "Config Firebase non valida (apiKey).",
      "auth/invalid-oauth-client-id": "Client OAuth non valido (Google). Controlla la configurazione Web SDK.",
      "auth/redirect-cancelled-by-user": "Accesso annullato. Riprova.",
      "auth/redirect-operation-pending": "Accesso già in corso. Attendi e riprova."
    };
    for (const k in map){ if(code.includes(k)) return map[k]; }
    return "Errore accesso. Controlla rete e riprova.";
  }

// ===============================
  // AUTH (Google / Email + allowlist email)
  // ===============================
  const USERS_COL = "powderUsers";
  // const ACCESS_COL removed (using USERS_COL allowlist)
function showAuthGate(){
    $("authGate").classList.add("show");
    lockBody();
  }
  function hideAuthGate(){
    $("authGate").classList.remove("show");
    unlockBody();
  }
  async function getAccessByEmail(email){
    const e = String(email||"").trim().toLowerCase();
    if(!e) return null;
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, e);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||null) : null;
  }

  function renderAuthDenied(email, reason=""){
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso non abilitato</div>
      <div class="muted">Questa email non risulta autorizzata ad accedere all’hub.</div>
      <div style="height:10px"></div>
      <div class="pill" style="display:inline-block;background:#fff3f2;color:#8a1f1a;border:1px solid #ffd1cd;">${escapeHtml(email||"")}</div>
      ${reason ? `<div style="height:10px"></div><div class="muted">${escapeHtml(reason)}</div>` : ``}
      <div style="height:14px"></div>
      <button id="btnLogout" class="btn bad" type="button">Esci</button>
      <div style="height:8px"></div>
      <div class="muted">Se serve, chiedi all’amministrazione di abilitare la tua email.</div>
    `;
    $("btnLogout").onclick = async () => {
      try{ await state.firebase.authApi.signOut(state.firebase.auth); }catch(e){}
      renderAuthLogin("");
    };
  }



  function renderAuthLogin(msg=""){
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso richiesto</div>
      <div class="muted">${msg || "Accedi con il tuo account Google aziendale autorizzato."}</div>
      <div style="height:12px"></div>

      <button class="btn good" id="btnGoogle" style="width:100%;">Accedi con Google</button>

      <div style="height:14px"></div>
      <div class="muted">L’accesso via email/password è disattivato: usa solo Google.</div>
    `;

    const googleBtn = b.querySelector("#btnGoogle");
    googleBtn.onclick = async()=>{
      const authApi = state.firebase.authApi;
      const auth = state.firebase.auth;
      const prov = new authApi.GoogleAuthProvider();
      state.lastAuthErrorMsg = "";
      // Provo popup (più veloce). Se bloccato, fallback su redirect (più stabile su mobile).
      try{
        await authApi.signInWithPopup(auth, prov);
      }catch(err){
        console.warn("Google popup error", err);
        const msg = humanAuthErr(err);
        if((err && err.code==="auth/popup-blocked") || (err && err.code==="auth/operation-not-supported-in-this-environment")){
          showToast("Accesso", msg);
          try{
            await authApi.signInWithRedirect(auth, prov);
            return;
          }catch(err2){
            console.warn("Google redirect error", err2);
            state.lastAuthErrorMsg = humanAuthErr(err2);
            renderAuthLogin(state.lastAuthErrorMsg);
            return;
          }
        }
        state.lastAuthErrorMsg = msg;
        showToast("Accesso", msg);
      }
    };
  }

  async function upsertUserProfile(user, fields){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, user.uid);
    await fs.setDoc(ref, { uid:user.uid, ...fields, updatedAt: nowIso(), createdAt: nowIso() }, { merge:true });
  }

  async function loadUserProfile(uid){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, uid);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||{}) : null;
  }

  async function ensureAuthFlow(){
    // chiamata dopo init firebase
    const authApi = state.firebase.authApi;
    const auth = state.firebase.auth;

    // Gestisci redirect result (mostra errori)
    try{
      await authApi.getRedirectResult(auth);
    }catch(e){
      console.warn("getRedirectResult error", e);
      state.lastAuthErrorMsg = humanAuthErr(e);
    }
authApi.onAuthStateChanged(auth, async(user)=>{
      if(!user){
        state.user = null;
        state.operator = null;
        $("hdrUser").textContent = "—";
        const msg = state.lastAuthErrorMsg || "";
        state.lastAuthErrorMsg = "";
        renderAuthLogin(msg);
        return;
      }

      // Sessione valida 7 giorni per dispositivo (dopo scade e richiede nuovo accesso)
      try{
        const MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000;
        const KEY_TS = "GC_AUTH_TS";
        const KEY_EMAIL = "GC_AUTH_EMAIL";
        const email = (user.email || "").toLowerCase();
        const prevEmail = (localStorage.getItem(KEY_EMAIL) || "").toLowerCase();
        const ts = parseInt(localStorage.getItem(KEY_TS) || "0", 10);
        const now = Date.now();

        if(prevEmail && prevEmail !== email){
          // utente diverso: reset finestra
          localStorage.setItem(KEY_EMAIL, email);
          localStorage.setItem(KEY_TS, String(now));
        }else if(ts && (now - ts) > MAX_AGE_MS){
          // scaduta
          localStorage.removeItem(KEY_TS);
          localStorage.removeItem(KEY_EMAIL);
          state.lastAuthErrorMsg = "Sessione scaduta (7 giorni). Accedi di nuovo.";
          await authApi.signOut(auth);
          return;
        }else if(!ts){
          // prima volta
          localStorage.setItem(KEY_EMAIL, email);
          localStorage.setItem(KEY_TS, String(now));
        }
      }catch(_e){}

      // profilo
      let profile = await loadUserProfile(user.uid);
      if(!profile){
        const dn = (user.displayName||"").trim();
        profile = { fullName: dn || user.email || "" , email: user.email||"" };
        await upsertUserProfile(user, profile);
      } else {
        // assicurati fullName
        if(!profile.fullName){
          const dn = (user.displayName||"").trim();
          profile.fullName = dn || user.email || "";
          await upsertUserProfile(user, { fullName: profile.fullName, email: user.email||"" });
        }
      }
      // allowlist email
      const access = await getAccessByEmail(user.email||"");
      if(!access || access.enabled === false){
        renderAuthDenied(user.email||"", access && access.enabled===false ? "Accesso disabilitato." : "Email non presente in elenco autorizzati.");
        return;
      }


      // usa displayName da allowlist se presente (coerente per reparto)
      if(access && access.displayName){ profile.fullName = access.displayName; }

      state.user = { uid: user.uid, fullName: profile.fullName, email: (user.email||profile.email||""), isAdmin: Boolean(access && access.isAdmin) };
      state.operator = state.user.fullName;
      $("hdrUser").textContent = state.user.fullName;
      hideAuthGate();
      renderHome();
    });
  }


  // ===============================
  // LIVE SYNC (Firestore) - lazy import
  // ===============================
  async function initLiveSync(){
    try {
      const timeoutMs = 5500;
      const t = new Promise((_,rej)=>setTimeout(()=>rej(new Error("firebase timeout")), timeoutMs));

      const apiPromise = (async()=>{
        const { initializeApp } = await import(FIREBASE_IMPORT_APP);
        const fs = await import(FIREBASE_IMPORT_FS);
        const fa = await import(FIREBASE_IMPORT_AUTH);
        const fm = await import(FIREBASE_IMPORT_MSG);

        const app = initializeApp(firebaseConfig);
        const db = fs.getFirestore(app);
        const auth = fa.getAuth(app);
        let messaging = null;

        try { await fa.setPersistence(auth, fa.browserLocalPersistence); } catch(_e){}

        state.firebase.ok = true;
        state.firebase.db = db;
        state.firebase.api = fs;
        state.firebase.authApi = fa;
        state.firebase.auth = auth;
        state.firebase.msgApi = fm;
        try{ state.push.supported = await fm.isSupported(); }catch(_e){ state.push.supported = false; }
        if(state.push.supported){
          try{ messaging = fm.getMessaging(app); }catch(_e){ messaging = null; }
        }
        state.firebase.messaging = messaging;
      })();

      await Promise.race([apiPromise, t]);

      // Auth flow gate
      await ensureAuthFlow();

      const fs = state.firebase.api;
      const db = state.firebase.db;

      // Live productions
      const col = fs.collection(db, "powderProductions");
      fs.onSnapshot(col, (snap)=>{
        const arr = [];
        snap.forEach(doc=>arr.push({ id: doc.id, ...doc.data() }));
        state.activeProductions = arr.filter(x=>x && x.active);
        renderHome();
      }, (err)=>{
        console.warn("onSnapshot error", err);
        state.firebase.ok = false;
        renderHome();
      });

      // History for stats + "ordini conclusi"
      try {
        const hcol = fs.collection(db, "powderProdHistory");
        fs.onSnapshot(hcol, (snap)=>{
          const hist = [];
          snap.forEach(doc=>hist.push({ id: doc.id, ...doc.data() }));
          state.history = hist;
          renderStats();
          try{ renderCompletedSection(); }catch(_e){}
          try{ renderPartialBanner && renderPartialBanner(); }catch(_e){}
        });
      } catch(_e) {}

    } catch(err) {
      console.warn("Firebase init failed:", err);
      state.firebase.ok = false;
      renderHome();
      renderAuthLogin("Connessione Firebase non disponibile. Verifica rete o contatta il responsabile.");
    }
  }

  async function upsertActiveProduction(prod){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = prod.id || `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { ...prod, id, active:true }, { merge:true });
    return id;
  }

  async function closeActiveProduction(id, payload={}){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { active:false, closedAt: nowIso(), ...payload }, { merge:true });
  }

  async function addHistory(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdHistory", id), { ...entry, id, at: nowIso() });
    return id;
  }

  async function addAbort(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdAborts", id), { ...entry, id, at: nowIso() });
  }

  async function addIssue(entry){
  if(!state.firebase.ok) return;
  const fs = state.firebase.api;
  const db = state.firebase.db;
  const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;

  await fs.setDoc(fs.doc(db, "powderProdIssues", id), { ...entry, id, at: nowIso() });

  // (opzionale) invio email via Firestore "Trigger Email" extension
  // Collezione default: "email"
  if(ISSUE_EMAIL_ENABLED && ISSUE_EMAIL_TO){
    try{
      const subject = `Segnalazione Hub Polveri · Ordine ${entry?.orderNo || ""}`.trim();
      const text = [
        "Nuova segnalazione dal Hub Linea Polveri",
        `Cliente: ${entry?.customer || ""}`,
        `Ordine: ${entry?.orderNo || ""}`,
        `Operatore: ${state.user?.fullName || ""}`,
        `Dettagli: ${entry?.text || entry?.message || ""}`
      ].join("\n");

      await fs.setDoc(fs.doc(db, "email", id), {
        to: ISSUE_EMAIL_TO,
        message: { subject, text }
      });
    }catch(err){
      console.warn("email issue failed", err);
    }
  }
}

// VOICE (Google voice only)
  // ===============================
  const GEMINI_TTS_ENDPOINT = localStorage.getItem("GEMINI_TTS_ENDPOINT") || "";
  async function speak(text){
    try{
      if(!text) return;

      // 1) Se configurato un endpoint TTS (Gemini/Google) uso audio reale
      if(GEMINI_TTS_ENDPOINT){
        const res = await fetch(GEMINI_TTS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ text, lang: "it-IT" })
        });

        if(res.ok){
          const ct = (res.headers.get("content-type")||"").toLowerCase();

          let blob;
          if(ct.includes("audio/")){
            blob = await res.blob();
          } else {
            // fallback: json { audioBase64, mime }
            const j = await res.json().catch(()=>null);
            if(j && j.audioBase64){
              const bin = atob(j.audioBase64);
              const arr = new Uint8Array(bin.length);
              for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
              blob = new Blob([arr], { type: j.mime || "audio/mpeg" });
            }
          }
          if(blob){
            const url = URL.createObjectURL(blob);
            const a = new Audio(url);
            a.onended = ()=>URL.revokeObjectURL(url);
            await a.play().catch(()=>{});
            return;
          }
        }
      }

      // 2) Fallback: Web Speech (dipende dal device)
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "it-IT";
      const voices = window.speechSynthesis.getVoices();
      const v = voices.find(x=>/Google/i.test(x.name) && /it/i.test(x.lang)) || voices.find(x=>/it/i.test(x.lang)) || null;
      if(v) u.voice = v;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(err){
      console.warn("speak error", err);
    }
  }
  window.speechSynthesis?.addEventListener?.("voiceschanged", ()=>{});

  // ===============================
  // RENDER
  // ===============================
  function prodRatio(p){
    const startedAt = p.startedAt ? new Date(p.startedAt).getTime() : null;
    if(!startedAt) return 0;
    const elapsed = Date.now() - startedAt;
    const kg = Number(p.totalKg||0);
    const expectedMs = Math.max(1, (kg/500) * 3600 * 1000);
    return elapsed / expectedMs;
  }

  
  function computePartialOrders(){
    const orders = state.powderOrders || [];
    const hist = state.history || [];
    const completedByOrder = new Map();
    for(const h of hist){
      if(!h || !h.orderNo) continue;
      const on = String(h.orderNo);
      const arr = Array.isArray(h.concludedLineKeys) ? h.concludedLineKeys : [];
      if(!completedByOrder.has(on)) completedByOrder.set(on, new Set());
      const set = completedByOrder.get(on);
      for(const k of arr){ if(k) set.add(String(k)); }
    }
    const partial = [];
    const full = [];
    for(const o of orders){
      const on = String(o.orderNo || o.number || "");
      if(!on) continue;
      const keys = (o.lines||[]).map(l=>l.lineKey).filter(Boolean).map(String);
      if(!keys.length) continue;
      const doneSet = completedByOrder.get(on) || new Set();
      let doneCount = 0;
      for(const k of keys){ if(doneSet.has(k)) doneCount++; }
      const remaining = keys.length - doneCount;
      if(doneCount>0 && remaining>0) partial.push({ orderNo:on, customer:o.customer||"", done:doneCount, total:keys.length });
      else if(doneCount>0 && remaining<=0) full.push({ orderNo:on, customer:o.customer||"", done:doneCount, total:keys.length });
    }
    return { partial, full };
  }

  function handlePrimaryCta(){
    const active = state.activeProductions || [];
    const me = (state.user?.fullName || state.operator || "").toLowerCase();
    const ownActive = me && active.some(p=>String(p.operator||"").toLowerCase() === me);
    if(ownActive) openRunningModal(); else openProdModal();
  }

  function buildOrderViews(options={}){
    // Filtra righe già concluse e applica priorità/visibilità lato UI (no backend)
    const applyRoleVisibility = options.applyRoleVisibility !== false;
    const includeHidden = options.includeHidden === true;
    const concluded = new Set();
    for(const h of (state.history||[])){
      if(!h || !Array.isArray(h.concludedLineKeys)) continue;
      for(const k of h.concludedLineKeys){ if(k) concluded.add(String(k)); }
    }
    const activeMap = new Map();
    for(const p of (state.activeProductions||[])){
      const keys = Array.isArray(p.selectedLineKeys) ? p.selectedLineKeys : [];
      for(const k of keys){ if(k) activeMap.set(String(k), p); }
    }
    const partialMap = new Map();
    const fullMap = new Map();
    try{
      const { partial, full } = computePartialOrders();
      partial.forEach(p=>partialMap.set(String(p.orderNo), p));
      full.forEach(p=>fullMap.set(String(p.orderNo), p));
    }catch(_e){}

    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    const isAdmin = Boolean(state.user && state.user.isAdmin);

    const orders = [];
    const baseOrders = [];
    for(const o of (state.powderOrders || [])){
      const orderNo = o.orderNo || o.number || "";
      const note = getOrderNote(o);
      const priorityInfo = computePriorityFromNote(note);
      const lines = (o.lines||[]).map(l=>{
        const key = String(l.lineKey||"");
        const activeProd = activeMap.get(key) || null;
        const status = concluded.has(key) ? "done" : activeProd ? "active" : "idle";
        return { ...l, status, activeProd, activeOp: activeProd?.operator || activeProd?.operatorName || "", conclusion: l.conclusion || o.conclusion || "" };
      }).filter(l=>l.status !== "done");
      const alerts = Array.isArray(o.alerts) ? o.alerts : [];
      if(!lines.length && !alerts.length) continue;

      const planDate = priorityInfo.date || extractDateFromText(note);
      const daysAway = planDate ? diffDaysFromNow(planDate) : null;
      const baseOrder = { ...o, orderNo, lines, alerts, partialInfo: partialMap.get(String(orderNo)) || null, isCompleted: fullMap.has(String(orderNo)), note, priorityInfo, planDate, daysAway };
      baseOrders.push(baseOrder);

      let visible = true;
      if(applyRoleVisibility){
        if(isDesktop){
          const beyondWindow = Boolean(planDate && daysAway!=null && daysAway>3);
          visible = !beyondWindow;
        } else {
          visible = priorityInfo.visible !== false;
        }
      }
      if(!visible && !includeHidden) continue;
      orders.push(baseOrder);
    }

    return { orders, baseOrders, concluded, activeMap, partialMap, fullMap };
  }

  function computeVisiblePowderSummary(orders){ // UI-FIX: kg-totali
    const lines = [];
    for(const o of (orders||[])){
      for(const l of (o.lines||[])) lines.push(l);
    }

    let totalKg = 0;
    const samples = [];

    for(const l of lines){
      // UI-FIX: kg-totali (qty è già KG reali → NON moltiplicare per packKg)
      const qtyParsed = parseItNumber(l.qtyKgRimanenti ?? l.qtyKg ?? l.qty);

      let lineKg = 0;
      if(Number.isFinite(qtyParsed) && qtyParsed > 0){
        lineKg = qtyParsed;
      } else if(Number.isFinite(Number(l.lineKg)) && Number(l.lineKg) > 0){
        lineKg = Number(l.lineKg);
      }

      if(!Number.isFinite(lineKg)) lineKg = 0;
      totalKg += lineKg;

      if(samples.length < 5) samples.push({ rawQty: l.qty, parsedQty: qtyParsed });
    }

    return { totalKg, lineCount: lines.length, samples };
  }

  function buildMagazzinoData(){
    const { orders } = buildOrderViews();
    const totals = { productKg:0, bobine:new Map(), etichette:0, scatole:new Map(), divisori:new Map(), altri:new Map(), nonConfig:[], warnings:[] };
    const orderDetails = [];
    for(const o of orders){
      const comp = { productKg:0, bobine:new Map(), etichette:0, scatole:new Map(), divisori:new Map(), altri:new Map(), nonConfig:[], warnings:[] };
      const status = o.lines.some(l=>l.status==="active") ? "in_produzione" : (o.partialInfo ? "parziale" : "da_fare");
      for(const l of (o.lines||[])){
        if(isWhiteBagRow(l)) continue; // CODEX: righe con ** (sacchetto bianco) non rilevanti per magazzino
        const qtyKgRimanenti = magResolveQtyKg(l); // CODEX: kg residui per Statistiche/Magazzino
        if(Number.isFinite(qtyKgRimanenti) && qtyKgRimanenti>0){
          comp.productKg += qtyKgRimanenti;
          totals.productKg += qtyKgRimanenti;
        }
        const packKg = magDetectPackKg(l);
        const { bom, source } = magMatchBom(l, packKg) || {};
        const unsupportedPack = (source==="pack_unsupported");
        if(!packKg || packKg<=0 || !bom){
          const note = unsupportedPack ? "Non configurato (packKg non supportato)" : "";
          const nc = { desc:l.desc, customer:o.customer, orderNo:o.orderNo||o.number, qtyKg:qtyKgRimanenti, packKg, code:l.code||"", note };
          comp.nonConfig.push(nc);
          totals.nonConfig.push(nc);
          continue;
        }
        const bags = Number(packKg) ? (qtyKgRimanenti/packKg) : 0;
        if(!Number.isFinite(bags) || bags<=0){
          const nc = { desc:l.desc, customer:o.customer, orderNo:o.orderNo||o.number, qtyKg:qtyKgRimanenti, packKg, code:l.code||"" };
          comp.nonConfig.push(nc);
          totals.nonConfig.push(nc);
          continue;
        }
        if(Math.abs(bags - Math.round(bags)) > 0.01){
          const warn = `${l.desc} · ${bags.toFixed(2)} sacchi da ${packKg} kg`;
          comp.warnings.push(warn);
          totals.warnings.push(warn);
        }
        // CODEX: per i kg totali uso qtyKg (già in kg reali). packKg serve solo per calcolare i sacchi → componenti.
        if(bom.bobine){
          for(const [label,cfg] of Object.entries(bom.bobine)){
            const perBag = Number((cfg && cfg.perBag!=null) ? cfg.perBag : cfg) || 0;
            const unit = (cfg && cfg.unit) || "g";
            const grams = unit==="kg" ? perBag*1000 : perBag;
            magAddToMap(comp.bobine, label, grams * bags);
            magAddToMap(totals.bobine, label, grams * bags);
          }
        }
        if(Number(bom.etichettePerBag)){
          const tot = Number(bom.etichettePerBag||0) * bags;
          comp.etichette += tot;
          totals.etichette += tot;
        }
        if(bom.scatole){
          for(const [label,val] of Object.entries(bom.scatole)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.scatole, label, tot);
            magAddToMap(totals.scatole, label, tot);
          }
        }
        if(bom.divisori){
          for(const [label,val] of Object.entries(bom.divisori)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.divisori, label, tot);
            magAddToMap(totals.divisori, label, tot);
          }
        }
        if(bom.altri){
          for(const [label,val] of Object.entries(bom.altri)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.altri, label, tot);
            magAddToMap(totals.altri, label, tot);
          }
        }
      }
      orderDetails.push({ order:o, comp, status });
    }
    return { totals, orderDetails };
  }

  function computeFatturatoLordo(docs){
    let tot = 0;
    let found = false;
    for(const d of (docs||[])){
      const num = parseCurrencyValue(d?.totalDoc);
      if(num!=null){
        tot += num;
        found = true;
      }
    }
    return found ? tot : null;
  }

  function resolveFatturatoValue(){
    try{
      if(state.fatturatoLordo!=null && Number.isFinite(state.fatturatoLordo)) return state.fatturatoLordo;
      if((state.fatturatoLordo==null) && (state.docs && state.docs.length)){
        const computed = computeFatturatoLordo(state.docs); // CODEX: calcolo on-demand da XML già in memoria
        if(computed!=null){
          state.fatturatoLordo = computed;
          return computed;
        }
      }
      const el = $("fatValue");
      if(el && el.dataset && el.dataset.value){
        const n = Number(el.dataset.value);
        if(Number.isFinite(n)) return n;
      }
      const saved = Number(localStorage.getItem(FAT_VALUE_KEY) || "");
      if(Number.isFinite(saved)) return saved;
    }catch(_e){}
    return null;
  }
  function updateFatturatoUI(){
    const el = $("fatValue");
    const sub = $("fatSubtitle");
    if(!el) return;
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    const val = resolveFatturatoValue();
    state.fatturatoLordo = val;
    if(val!=null){
      el.dataset.value = String(val);
      try{ localStorage.setItem(FAT_VALUE_KEY, String(val)); }catch(_e){}
    } else {
      delete el.dataset.value;
    }
    const formatted = val!=null ? new Intl.NumberFormat("it-IT", { style:"currency", currency:"EUR" }).format(val) : "Dati non disponibili";
    if(isDesktop){
      el.classList.add("reveal");
      el.classList.remove("blur");
      el.textContent = formatted;
      if(sub) sub.textContent = "Fatturato lordo aggregato (desktop).";
    } else {
      el.classList.add("blur");
      if(el.classList.contains("reveal")){
        el.textContent = formatted;
      } else {
        el.textContent = "€ —";
      }
      if(sub) sub.textContent = "Mobile: tocca per mettere a fuoco il fatturato lordo.";
    }
  }

  function getOrderNote(order){
    try{
      const overridesRaw = localStorage.getItem("ORDER_NOTE_OVERRIDES") || "";
      if(overridesRaw){
        const map = JSON.parse(overridesRaw);
        const key = order.orderNo || order.number || "";
        if(key && map && map[key]) return map[key];
      }
    }catch(_e){}
    return order.note || order.comment || order.internalNote || "";
  }

  function extractDateFromText(text){
    const t = norm(text||"");
    if(!t) return null;
    const monthMap = { "gennaio":0,"febbraio":1,"marzo":2,"aprile":3,"maggio":4,"giugno":5,"luglio":6,"agosto":7,"settembre":8,"ottobre":9,"novembre":10,"dicembre":11 };
    let m = t.match(/(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)(?:\s+(\d{4}))?/);
    if(m){
      const d = parseInt(m[1],10);
      const mo = monthMap[m[2]];
      const y = m[3] ? parseInt(m[3],10) : (new Date()).getFullYear();
      if(!isNaN(d) && mo!=null) return new Date(y, mo, d);
    }
    m = t.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
    if(m){
      const d = parseInt(m[1],10);
      const mo = parseInt(m[2],10)-1;
      let y = m[3] ? parseInt(m[3],10) : (new Date()).getFullYear();
      if(y<100) y = 2000 + y;
      if(!isNaN(d) && mo>=0) return new Date(y, mo, d);
    }
    return null;
  }

  function diffDaysFromNow(date){
    if(!date) return null;
    const now = new Date();
    const tzNow = new Date(now.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
    const tzTarget = new Date(date.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
    return Math.floor((tzTarget - tzNow)/(24*3600*1000));
  }

  function computePriorityFromNote(note){
    // Parsing leggero per note di priorità (giorno prima/giorno stesso)
    const n = norm(note||"");
    if(!n) return { priority:"normal", visible:true };
    if(/da\s*fare\s*oggi/.test(n)){
      return { priority:"today", visible:true, reason:"Da fare oggi" };
    }
    const target = extractDateFromText(n);
    if(target){
      const diffDays = diffDaysFromNow(target);
      if(diffDays != null){
        const tzTarget = new Date(target.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
        if(diffDays >= 2) return { priority:"scheduled", visible:false, date: tzTarget };
        if(diffDays >= 1) return { priority:"scheduled", visible:true, date: tzTarget, reason:"Da iniziare domani" };
        if(diffDays >= 0) return { priority:"scheduled", visible:true, date: tzTarget, reason:"Da iniziare oggi" };
      }
    }
    return { priority:"normal", visible:true };
  }

  // CODEX: helper magazzino (match robusto su nome/codice + pack)
  function magNormalizeName(name){
    return norm(name).replace(/\bkg\b/g," ").replace(/\b\d+(?:[\.,]\d+)?\b/g," ").replace(/\s+/g," ").trim();
  }
  function magDetectPackKg(line){
    const direct = Number(line.packKg);
    if(Number.isFinite(direct) && direct>0) return direct;
    const fromDesc = detectPackKg(line.desc || "");
    if(Number.isFinite(fromDesc) && fromDesc>0) return fromDesc;
    const fromCombo = detectPackKg(`${line.desc||""} ${line.um||""}`);
    if(Number.isFinite(fromCombo) && fromCombo>0) return fromCombo;
    return null;
  }
  function magResolveQtyKg(line){ // CODEX: kg rimanenti realistici per Statistiche/Magazzino
    // UI-FIX: kg-totali (qty è già KG reali → NON moltiplicare per packKg)
    const qty = parseItNumber(line.qtyKgRimanenti ?? line.qtyKg ?? line.qty);
    const lineKg = parseItNumber(line.lineKg);

    if(Number.isFinite(qty) && qty > 0) return qty;
    if(Number.isFinite(lineKg) && lineKg > 0) return lineKg;
    return 0;
  }
  function magFindPackEntry(packs, packKg){
    if(!packs || packKg==null) return null;
    if(packs[packKg]) return packs[packKg];
    if(packs[String(packKg)]) return packs[String(packKg)];
    const nearKey = Object.keys(packs||{}).find(k=>Math.abs(Number(k||0)-Number(packKg))<0.011);
    return nearKey ? packs[nearKey] : null;
  }
  function magMatchBom(line, packKg){
    const codeKey = norm(line.code||"").replace(/\s+/g,"");
    const normalizedPack = Number(packKg);
    if(codeKey && MAGAZZINO_BOM.byCode[codeKey]){
      const entry = magFindPackEntry(MAGAZZINO_BOM.byCode[codeKey].packs, packKg);
      if(entry) return { bom: entry, source:"code" };
    }
    const nameKey = magNormalizeName(line.desc||"");
    if(nameKey && MAGAZZINO_BOM.byName[nameKey]){
      const entry = magFindPackEntry(MAGAZZINO_BOM.byName[nameKey].packs, packKg);
      if(entry) return { bom: entry, source:"name" };
    }
    const defaultEntry = magFindPackEntry(MAGAZZINO_BOM.defaultByPackKg, packKg);
    if(defaultEntry) return { bom: defaultEntry, source:"default" };
    if(Number.isFinite(normalizedPack)) return { bom:null, source:"pack_unsupported" };
    return { bom:null, source:"not_found" };
  }
  function magFmtKg(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "—";
    return `${n.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1")} kg`;
  }
  function magFmtGram(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "—";
    const g = n%1===0 ? n.toFixed(0) : n.toFixed(1); // CODEX: bobine in grammi con max 1 decimale
    return `${g.replace(/\.0$/,"")} g`;
  }
  function magFmtFraction(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "—";
    return n.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1");
  }
  function magAddToMap(map, key, delta){
    if(!key) return;
    const cur = Number(map.get(key)||0);
    const add = Number(delta||0);
    if(!Number.isFinite(add)) return;
    map.set(key, cur + add);
  }


function escapeHtml(s){
  return String(s==null?"":s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}

function tsFromId(x){
  try{
    if(!x) return 0;
    const s = String(x);
    const leading = Number(s.split("_")[0]);
    if(Number.isFinite(leading)) return leading;
    const n = Date.parse(s);
    return Number.isFinite(n) ? n : 0;
  }catch(_e){ return 0; }
}

// UI-FIX: conclusi-dedupe + notifiche
function buildUniqueCompletedHistory(){
  const hist = Array.isArray(state.history) ? state.history.slice() : [];
  hist.sort((a,b)=> tsFromId(b.id||b.at||0) - tsFromId(a.id||a.at||0));

  const map = new Map(); // key => ultimo record (hist già ordinato dal più recente)
  for(const h of hist){
    if(!h) continue;
    const orderNo = String(h.orderNo ?? "").trim();
    const customer = String(h.customer ?? "").trim();
    if(!orderNo && !customer) continue;

    const key = `${orderNo}|${customer}`.toLowerCase();
    if(!map.has(key)) map.set(key, h);
  }
  return Array.from(map.values());
}

function renderNotifModal(){
  const body = $("notifBody");
  if(!body) return;

  const entries = buildUniqueCompletedHistory();
  if(!entries.length){
    body.innerHTML = `<div class="muted">Nessun ordine concluso registrato.</div>`;
    return;
  }

  body.innerHTML = `
    <div class="stepTitle">Registro</div>
    <div class="muted">Tocca un elemento per aprire i dettagli.</div>
    <div style="height:10px"></div>
    <div class="list" id="notifList"></div>
  `;

  const list = body.querySelector("#notifList");
  for(const h of entries){
    const orderNo = h.orderNo ? String(h.orderNo) : "—";
    const customer = h.customer || "";
    const operator = h.operator || h.operatorName || (h.userName||"") || "Operatore";
    const at = h.at ? fmtDateTime(h.at) : "";

    const div = document.createElement("div");
    div.className = "item pressCard";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">Ordine n. ${escapeHtml(orderNo)} ${customer?`· ${escapeHtml(customer)}`:""}</div>
          <div class="sub">${escapeHtml(operator)}${at?` · ${escapeHtml(at)}`:""}</div>
        </div>
        <div class="badge">Apri</div>
      </div>
    `;
    div.onclick = ()=> openHistModal(h.id);
    list.appendChild(div);
  }
}

function openNotifModal(){
  $("notifModal").classList.add("show");
  lockBody();
  renderNotifModal();
}
function closeNotifModal(){
  $("notifModal").classList.remove("show");
  unlockBody();
}

function renderCompletedSection(){
  const list = $("completedList");
  const empty = $("completedEmpty");
  const badge = $("completedBadge");
  if(!list || !empty || !badge) return;

  // UI-FIX: conclusi-dedupe
  const unique = buildUniqueCompletedHistory();
  const entries = unique.slice(0, 10);
  badge.textContent = unique.length ? String(unique.length) : "0";

  // UI-FIX: notifiche (contatore sul tasto)
  try{
    const t = $("txtNotif");
    if(t) t.textContent = `Conclusi: ${unique.length || 0}`;
  }catch(_e){}

  list.innerHTML = "";
  if(!entries.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";
  const isAdmin = Boolean(state.user && state.user.isAdmin);
  let adminBox = document.getElementById("completedAdmin");
  if(isAdmin){
    if(!adminBox){
      adminBox = document.createElement("div");
      adminBox.id = "completedAdmin";
      adminBox.style.margin = "10px 0";
      adminBox.innerHTML = `<button class="btn bad" id="btnClearCompleted" style="width:100%;">Cancella tutti conclusi</button>`;
      list.parentElement.appendChild(adminBox);
    }
    const btn = adminBox.querySelector("#btnClearCompleted");
    if(btn) btn.onclick = ()=> clearCompletedHistory();
    adminBox.style.display = "block";
  } else if(adminBox){
    adminBox.style.display = "none";
  }

  // status maps (in base all'XML corrente)
  let partialSet = new Set(), fullSet = new Set();
  try{
    const { partial, full } = computePartialOrders();
    for(const p of partial) partialSet.add(String(p.orderNo));
    for(const f of full) fullSet.add(String(f.orderNo));
  }catch(_e){}

  for(const h of entries){
    const orderNo = h.orderNo ? String(h.orderNo) : "—";
    const customer = h.customer || "";
    const operator = h.operator || h.operatorName || (h.userName||"") || "Operatore";
    const at = h.at ? fmtDateTime(h.at) : "";
    const kg = (()=>{
      try{
        if(Array.isArray(h.perLine) && h.perLine.length){
          return Math.round(h.perLine.reduce((a,x)=>a + (Number(x.producedKg||0)||0), 0));
        }
      }catch(_e){}
      return null;
    })();

    let status = "Produzione registrata";
    if(fullSet.has(orderNo)) status = "Ordine concluso";
    else if(partialSet.has(orderNo)) status = "Ordine parzialmente concluso";

    const div = document.createElement("div");
    div.className = "item completedItem";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">Ordine n. ${escapeHtml(orderNo)} ${customer?`· ${escapeHtml(customer)}`:""}</div>
          <div class="completedMeta">
            <div><b>${escapeHtml(operator)}</b></div>
            ${at?`<div class="kv">${escapeHtml(at)}</div>`:""}
            ${kg!=null?`<div class="kv"><b>${kg}</b> kg</div>`:""}
            <div>${escapeHtml(status)}</div>
          </div>
        </div>
        <div class="badge">Dettagli</div>
      </div>
    `;
    div.addEventListener("click", ()=> openHistModal(h.id));
    list.appendChild(div);
  }
}

function openHistModal(id){
  const h = (state.history||[]).find(x=>x && x.id===id);
  if(!h) return;

  const orderNo = h.orderNo ? String(h.orderNo) : "—";
  const customer = h.customer || "";
  const operator = h.operator || h.operatorName || "Operatore";
  $("histTitle").textContent = `Ordine n. ${orderNo}${customer?` · ${customer}`:""}`;
  $("histSub").textContent = `Operatore: ${operator}${h.at?` · ${fmtDateTime(h.at)}`:""}`;

  const body = $("histBody");
  const lines = Array.isArray(h.perLine) ? h.perLine : [];
  const lineHtml = lines.length ? lines.map(l=>`
    <div class="item" style="margin-bottom:10px;">
      <div class="top">
        <div>
          <div class="name">${escapeHtml(l.desc||"")}</div>
          <div class="muted">Pianificati: <b>${escapeHtml(String(l.plannedKg??"—"))}</b> kg · Prodotti: <b>${escapeHtml(String(l.producedKg??"—"))}</b> kg</div>
        </div>
        <div class="badge">${escapeHtml(String(l.qty??""))} ${escapeHtml(String(l.um??""))}</div>
      </div>
      ${l.code?`<div class="muted" style="margin-top:6px;">Codice: <b>${escapeHtml(String(l.code))}</b></div>`:""}
    </div>
  `).join("") : `<div class="muted">Nessun dettaglio righe disponibile.</div>`;

  const sig = h.signature ? `<div style="margin-top:14px;"><div class="muted" style="margin-bottom:6px;">Firma</div><img src="${h.signature}" alt="Firma" style="width:100%; max-width:520px; border:1px solid var(--stroke); border-radius:14px; background:#fff;"></div>` : "";

  body.innerHTML = `
    <div class="muted">Stato: <b>${escapeHtml((()=>{ try{ const {partial,full}=computePartialOrders(); const ps=new Set(partial.map(x=>String(x.orderNo))); const fs=new Set(full.map(x=>String(x.orderNo))); if(fs.has(orderNo)) return "Ordine concluso"; if(ps.has(orderNo)) return "Ordine parzialmente concluso"; }catch(_e){} return "Storico"; })())}</b></div>
    <div style="height:12px"></div>
    ${lineHtml}
    ${sig}
  `;

  $("histModal").classList.add("show");
  lockBody();
}

function renderHome(){
    relocateStatsCard(); // CODEX: forza Statistiche sotto Operatività su desktop
    try{ const el=$('homeWelcome'); if(el && state.user){ el.textContent = `Benvenuto, ${state.user.fullName}`; } }catch(e){}

    const visibleOrders = buildOrderViews().orders; // UI-FIX: kg-totali
    const kgSummary = computeVisiblePowderSummary(visibleOrders); // UI-FIX: kg-totali
    $("kPowderLines").textContent = kgSummary.lineCount ? kgSummary.lineCount.toString() : "0"; // UI-FIX: kg-totali
    const kPowderKgEl = $("kPowderKg");
    if(!Number.isFinite(kgSummary.totalKg) || kgSummary.totalKg>50000){
      kPowderKgEl.textContent = "Dati non disponibili"; // UI-FIX: kg-totali
      console.log("UI-FIX: kg-totali debug", { lineCount: kgSummary.lineCount, samples: kgSummary.samples, totalKg: kgSummary.totalKg }); // UI-FIX: kg-totali
    } else {
      kPowderKgEl.textContent = Math.round(kgSummary.totalKg).toLocaleString("it-IT"); // UI-FIX: kg-totali
    }
    const kPowderMeta = $("kPowderMeta"); // UI-FIX: kg-totali
    if(kPowderMeta) kPowderMeta.textContent = `Calcolato su ${kgSummary.lineCount} righe visibili`; // UI-FIX: kg-totali
    const pOrders = state.powderOrders || [];
    $("badgeCounts").textContent = `${pOrders.length} ordini`;

    let txt = "Ordini: ";
    if(state.xmlModifiedTime) txt += `aggiornati ${state.xmlModifiedTime}`;
    else if(state.lastFetchAt) txt += `aggiornati ${fmtDateTime(state.lastFetchAt)}`;
    else txt += "in sincronizzazione…";
    $("txtXmlTime").textContent = txt;
    updateFatturatoUI(); // CODEX: aggiornamento UI fatturato lordo

    // Banner ordini parzialmente conclusi (globale)
    try{
      const { partial } = computePartialOrders();
      state.partialOrders = partial;
      const b = $("partialBanner");
      if(b){
        if(partial.length){
          b.dataset.display = "flex";
          b.style.display = "flex";
          requestAnimationFrame(()=> b.classList.add("show"));
          const n = partial.length;
          $("partialBannerTitle").textContent = `Ci sono ${n} ordini parzialmente conclusi in corso`;
          $("partialBannerSub").textContent = `Apri Produzione per completare le righe rimanenti.`;
        } else {
          b.classList.remove("show");
          setTimeout(()=>{ b.style.display = "none"; }, 180);
        }
      }
      if($("partialModal")?.classList.contains("show")) renderPartialOrdersList(); // CODEX: re-render immediato elenco parziali
    }catch(_e){}

    // Ordini conclusi (sezione Home)
    try{ renderCompletedSection(); }catch(_e){}

    const active = state.activeProductions || [];
    const strip = $("prodStrip");
    if(active.length){
      strip.style.display = "block";
      $("prodCount").textContent = String(active.length);
      const parts = active.slice(0,6).map(p=>`${p.operator||"Operatore"}: ${p.customer||"Cliente"} · Ordine n. ${p.orderNo||"—"}`);
      $("prodMarquee").textContent = parts.join("   •   ") + (active.length>6 ? "   •   ..." : "");
      const ratios = active.map(p=>prodRatio(p));
      const r = ratios.length ? Math.max(...ratios) : 0;
      const hue = Math.max(0, 120 - (120 * Math.min(1,r)));
      // UI-FIX: prodstrip-green (rimuove override inline → lascia valere .bigStrip)
      strip.style.removeProperty("background");
      strip.style.removeProperty("border-color");
    } else {
      strip.style.display = "none";
    }
    try{
      const btn = $("btnGoProd");
      if(btn){
        const me = (state.user?.fullName || state.operator || "").toLowerCase();
        const ownActive = me && active.some(p=>String(p.operator||"").toLowerCase()===me);
        btn.textContent = ownActive ? "APRI PRODUZIONE IN CORSO" : "VAI IN PRODUZIONE";
        btn.setAttribute("aria-label", btn.textContent);
      }
    }catch(_e){}

    renderStats();
    renderMagazzino(); // CODEX: re-render magazzino dopo gli stessi filtri degli ordini
  }

  
  async function bumpOperatorKg(uid, fullName, kg){
    if(!state.firebase.ok || !uid) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, "operatorStats", uid);
    await fs.runTransaction(db, async(tx)=>{
      const snap = await tx.get(ref);
      const cur = snap.exists() ? (snap.data()||{}) : {};
      const totalKg = Number(cur.totalKg||0) + Number(kg||0);
      const totalRuns = Number(cur.totalRuns||0) + 1;
      tx.set(ref, { uid, fullName, totalKg, totalRuns, updatedAt: nowIso() }, { merge:true });
    });
  }

  function renderStats(){
    const list = $("statsList");
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    if(!isDesktop){
      list.innerHTML = `<div class="muted">Apri da desktop per vedere le statistiche.</div>`;
      $("statsBadge").textContent = "—";
      return;
    }

    // Admin (solo desktop): reset storico
    try{
      const adminBoxId = "adminStatsBox";
      let box = document.getElementById(adminBoxId);
      if(state.user && state.user.isAdmin && !isMobile()){
        if(!box){
          box = document.createElement("div");
          box.id = adminBoxId;
          box.style.marginTop = "12px";
          box.innerHTML = `
            <div class="divider"></div>
            <div class="stepTitle" style="font-size:14px; margin-top:0;">Admin</div>
            <button class="btn bad" id="btnClearHistory" style="width:100%;">Elimina dati storici</button>
            <div class="muted" style="margin-top:8px;">Attenzione: operazione irreversibile.</div>
          `;
          list.parentElement.appendChild(box);
          box.querySelector("#btnClearHistory").onclick = async()=>{
            if(!confirm("Eliminare TUTTI i dati storici di produzione?")) return;
            if(!confirm("Conferma finale: questa operazione è irreversibile.")) return;
            try{
              const fs = state.firebase.api;
              const db = state.firebase.db;
              const cols = ["powderProdHistory","operatorStats"];
              for(const c of cols){
                const snap = await fs.getDocs(fs.collection(db, c));
                for(const d of snap.docs){
                  await fs.deleteDoc(d.ref);
                }
              }
              showToast("Storico eliminato", "Dati storici rimossi.");
            }catch(err){
              console.warn(err);
              showToast("Errore", "Impossibile eliminare lo storico.");
            }
          };
        }
      } else {
        if(box) box.remove();
      }
    }catch(_e){}
    const hist = (state.history||[]).filter(x=>x && x.operator);
    if(!hist.length){
      list.innerHTML = `<div class="muted">Nessun dato storico disponibile (in attesa delle prime produzioni).</div>`;
      $("statsBadge").textContent = "0";
      return;
    }
    const agg = new Map();
    for(const h of hist){
      const op = h.operator;
      const kg = Number(h.kg||0);
      const ms = Number(h.durationMs||0);
      const a = agg.get(op) || { kg:0, ms:0, n:0 };
      a.kg += kg; a.ms += ms; a.n += 1;
      agg.set(op, a);
    }
    const rows = Array.from(agg.entries()).map(([op,a])=>{
      const hours = a.ms/3600000;
      const speed = hours>0 ? (a.kg/hours) : 0;
      return { op, ...a, speed };
    }).sort((x,y)=>y.kg-x.kg);

    $("statsBadge").textContent = String(rows.length);
    list.innerHTML = "";
    for(const r of rows){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${r.op}</div>
            <div class="sub">${r.n} produzioni · Velocità media: ${Math.round(r.speed)} kg/h</div>
          </div>
          <div class="badge">${Math.round(r.kg)} kg</div>
        </div>`;
      list.appendChild(div);
    }
  }

  function renderMagazzino(){
    // Distinta base lato client (desktop only) - usa dati già filtrati dall'UI ordini
    const card = $("warehouseCard");
    const body = $("warehouseBody");
    const badge = $("warehouseBadge");
    if(!card || !body || !badge) return;
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    card.style.display = isDesktop ? "block" : "none";
    if(!isDesktop){
      body.innerHTML = "";
      badge.textContent = "—";
      return;
    }

    const { totals, orderDetails } = buildMagazzinoData();
    orderDetails.sort((a,b)=>`${a.order.customer||""}`.localeCompare(`${b.order.customer||""}`) || `${a.order.orderNo||a.order.number||""}`.localeCompare(`${b.order.orderNo||b.order.number||""}`));
    badge.textContent = `${orderDetails.length || 0}`;
    if(!orderDetails.length){
      body.innerHTML = `<div class="muted">Nessun ordine disponibile.</div>`;
      return;
    }

    const renderMap = (map, fmtFn)=>{
      if(!map || !map.size) return `<div class="muted">—</div>`;
      return Array.from(map.entries()).map(([k,v])=>`
        <div class="magRow">
          <div class="l">${escapeHtml(k)}</div>
          <div class="v">${fmtFn(v)}</div>
        </div>
      `).join("");
    };

    const nonCfgList = totals.nonConfig.slice(0,6).map(nc=>`
      <div class="magRow">
        <div class="l">${escapeHtml(nc.customer||"Cliente")} · Ord. ${escapeHtml(nc.orderNo||"—")}<div class="s">${escapeHtml(nc.desc||"Prodotto")}${nc.note?` · ${escapeHtml(nc.note)}`:""}</div></div>
        <div class="v">${magFmtKg(nc.qtyKg||0)}${nc.packKg?` · ${nc.packKg} kg`:``}</div>
      </div>
    `).join("");

    const panoHtml = `
      <div class="magBox">
        <div class="magTitle">Panoramica magazzino</div>
        <div class="magList">
          <div class="magRow"><div class="l">Prodotti (kg)</div><div class="v">${magFmtKg(totals.productKg)}</div></div>
          <div class="magRow"><div class="l">Bobine</div><div class="v">${totals.bobine.size?`${totals.bobine.size} tipologie`: "—"}</div></div>
          <div class="magRow"><div class="l">Etichette</div><div class="v">${magFmtFraction(totals.etichette)} pz</div></div>
          <div class="magRow"><div class="l">Scatole</div><div class="v">${magFmtFraction(Array.from(totals.scatole.values()).reduce((a,x)=>a+x,0))} pz</div></div>
          <div class="magRow"><div class="l">Divisori</div><div class="v">${magFmtFraction(Array.from(totals.divisori.values()).reduce((a,x)=>a+x,0))} pz</div></div>
          <div class="magRow"><div class="l">Altri componenti</div><div class="v">${magFmtFraction(Array.from(totals.altri.values()).reduce((a,x)=>a+x,0))} pz</div></div>
          <div class="magRow"><div class="l">Non configurati (N)</div><div class="v">${totals.nonConfig.length || 0}</div></div>
        </div>
        ${totals.bobine.size ? `<div style="margin-top:10px;"><div class="magPill">Bobine</div>${renderMap(totals.bobine, magFmtGram)}</div>`:""}
        ${totals.scatole.size ? `<div style="margin-top:10px;"><div class="magPill">Scatole</div>${renderMap(totals.scatole, (v)=>`${magFmtFraction(v)} pz`)}</div>`:""}
        ${totals.divisori.size ? `<div style="margin-top:10px;"><div class="magPill">Divisori</div>${renderMap(totals.divisori, (v)=>`${magFmtFraction(v)} pz`)}</div>`:""}
        ${totals.altri.size ? `<div style="margin-top:10px;"><div class="magPill">Altri</div>${renderMap(totals.altri, (v)=>`${magFmtFraction(v)} pz`)}</div>`:""}
        ${totals.nonConfig.length ? `<div style="margin-top:12px;" class="magBox"><div class="magTitle" style="margin-bottom:6px;">Non configurati</div><div class="muted" style="margin-bottom:6px;">Distinta non configurata o formato non riconosciuto.</div>${nonCfgList}</div>`:""}
      </div>`;

    const detailHtml = orderDetails.map(({order, comp, status})=>{
      const stTxt = status==="in_produzione" ? "In produzione" : status==="parziale" ? "Parziale" : "Da fare";
      const stCol = status==="in_produzione" ? "var(--good)" : status==="parziale" ? "var(--warn)" : "var(--muted)";
      const compBlocks = [];
      compBlocks.push(`<div class="magRow"><div class="l">Prodotto</div><div class="v">${magFmtKg(comp.productKg)}</div></div>`);
      if(comp.bobine.size) compBlocks.push(`<div class="magRow"><div class="l">Bobine</div><div class="v">${comp.bobine.size} tipi</div></div>${renderMap(comp.bobine, magFmtGram)}`);
      if(comp.etichette) compBlocks.push(`<div class="magRow"><div class="l">Etichette</div><div class="v">${magFmtFraction(comp.etichette)} pz</div></div>`);
      if(comp.scatole.size) compBlocks.push(`<div class="magRow"><div class="l">Scatole</div><div class="v">${magFmtFraction(Array.from(comp.scatole.values()).reduce((a,x)=>a+x,0))} pz</div></div>${renderMap(comp.scatole, (v)=>`${magFmtFraction(v)} pz`)}`);
      if(comp.divisori.size) compBlocks.push(`<div class="magRow"><div class="l">Divisori</div><div class="v">${magFmtFraction(Array.from(comp.divisori.values()).reduce((a,x)=>a+x,0))} pz</div></div>${renderMap(comp.divisori, (v)=>`${magFmtFraction(v)} pz`)}`);
      if(comp.altri.size) compBlocks.push(`<div class="magRow"><div class="l">Altri</div><div class="v">${magFmtFraction(Array.from(comp.altri.values()).reduce((a,x)=>a+x,0))} pz</div></div>${renderMap(comp.altri, (v)=>`${magFmtFraction(v)} pz`)}`);
      const ncHtml = comp.nonConfig.length ? `<div class="magRow"><div class="l">Distinta non configurata per:</div><div class="v">${comp.nonConfig.length}</div></div>` +
        comp.nonConfig.map(nc=>`<div class="magRow"><div class="l">${escapeHtml(nc.desc||"Prodotto")}<div class="s">Ord. ${escapeHtml(nc.orderNo||"—")} ${nc.packKg?`· ${nc.packKg} kg`:``}${nc.note?` · ${escapeHtml(nc.note)}`:""}</div></div><div class="v">${magFmtKg(nc.qtyKg||0)}</div></div>`).join("") : "";
      const warnHtml = comp.warnings.length ? `<div class="magRow" style="border-style:dashed;"><div class="l">Attenzione sacchi</div><div class="v" style="color:var(--warn);">${comp.warnings.length}</div></div><div class="muted" style="margin-top:6px;">${comp.warnings.map(w=>`• ${escapeHtml(w)}`).join("<br/>")}</div>` : "";
      return `<div class="item pressCard" style="background:#fff; border-color:rgba(0,0,0,.06);">
        <div class="top" style="gap:12px;">
          <div>
            <div class="name">${escapeHtml(order.customer||"Cliente")} · Ordine ${escapeHtml(order.orderNo||order.number||"")}</div>
            <div class="sub" style="margin-top:6px;">Conclusione prevista: <b>${escapeHtml(order.conclusion||"—")}</b></div>
          </div>
          <div class="badge" style="border-color:${stCol}; color:${stCol};">${stTxt}</div>
        </div>
        <div class="magBox" style="margin-top:10px;">${compBlocks.join("")||`<div class="muted">Nessun componente configurato.</div>`}</div>
        ${ncHtml?`<div class="magBox" style="margin-top:10px; background:rgba(255,243,224,.7);">${ncHtml}</div>`:""}
        ${warnHtml?`<div class="magBox" style="margin-top:10px; background:rgba(255,243,224,.7);">${warnHtml}</div>`:""}
      </div>`;
    }).join("");

    // UI-FIX: magazzino-home-panoramica
    const showDetails = Boolean(state.magShowDetails);

    if(!showDetails){
      body.innerHTML = `
        <div class="magGrid">
          ${panoHtml}
          <div class="magBox">
            <div class="magTitle">Dettaglio per cliente/ordine</div>
            <div class="muted">Per i dettagli completi, apri la vista per cliente.</div>
            <div style="height:10px"></div>
            <button class="btn" id="btnMagShowDetails" style="width:100%;">Vedi per cliente</button>
          </div>
        </div>
      `;
      const b = body.querySelector("#btnMagShowDetails");
      if(b) b.onclick = ()=>{ state.magShowDetails = true; renderMagazzino(); };
      return;
    }

    body.innerHTML = `
      <div class="magGrid">
        ${panoHtml}
        <div class="magBox">
          <div class="magTitle" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <span>Dettaglio per cliente/ordine</span>
            <button class="btn ghost" id="btnMagHideDetails">Nascondi</button>
          </div>
          <div class="magDetailGrid">${detailHtml}</div>
        </div>
      </div>
    `;
    const bh = body.querySelector("#btnMagHideDetails");
    if(bh) bh.onclick = ()=>{ state.magShowDetails = false; renderMagazzino(); };
  }

  // ===============================
  // PRODUCTION MODAL FLOW
  // ===============================
// ==============================
// EURO / IT MONEY PARSER (fix fatturato)
// ==============================
function parseItMoney(v){
  if(v==null) return 0;
  let s = String(v).trim();
  if(!s) return 0;
  // keep digits, dot, comma, minus
  s = s.replace(/[^\d,.\-]/g, "");
  if(!s) return 0;
  const hasComma = s.includes(",");
  const hasDot = s.includes(".");
  if(hasComma && hasDot){
    // assume dots are thousand sep and comma is decimal
    s = s.replace(/\./g, "").replace(",", ".");
  }else if(hasComma && !hasDot){
    // comma decimal
    s = s.replace(",", ".");
  }else{
    // dot decimal or integer -> keep
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

// FIX: se esiste extractDocTotal, forza parsing robusto (senza cambiare logiche fetch)
// (override safe: stessa firma, solo parsing)
function extractDocTotal(xmlOrRow){
  try{
    // support: string XML, object row, number
    if(typeof xmlOrRow === "number") return xmlOrRow;
    if(typeof xmlOrRow === "string"){
      // prova a trovare un totale in XML (tag comuni)
      const s = xmlOrRow;
      const m =
        s.match(/<TotaleDocumento>([^<]+)<\/TotaleDocumento>/i) ||
        s.match(/<Totale>([^<]+)<\/Totale>/i) ||
        s.match(/<ImportoTotale>([^<]+)<\/ImportoTotale>/i) ||
        s.match(/<DocTotal>([^<]+)<\/DocTotal>/i);
      if(m && m[1]!=null) return parseItMoney(m[1]);
      return parseItMoney(s);
    }
    if(typeof xmlOrRow === "object" && xmlOrRow){
      const cand =
        xmlOrRow.totaleDocumento ?? xmlOrRow.totale ?? xmlOrRow.importoTotale ?? xmlOrRow.docTotal ?? xmlOrRow.total;
      return parseItMoney(cand);
    }
  }catch(_e){}
  return 0;
}

  function openProdModal(){
    if(!state.user){
      renderAuthLogin("Per iniziare un ordine devi prima accedere con un account autorizzato.");
      return;
    }
    state.prodModalOpenedAt = Date.now();
    state.startedThisSession = false;
    state.prodModalTouched = false;
    $("prodModal").classList.add("show");
    lockBody();
    renderProdStepOrders();
  }

  function closeProdModalRequest(){
    // UI-FIX: remove-motivazione
    $("prodModal").classList.remove("show");
    unlockBody();
  }

  function renderPartialOrdersList(){
  const body = $("partialBody");
  if(!body) return;

  let partial = [];
  try{ partial = computePartialOrders().partial || []; }catch(_e){ partial = []; }

  if(!partial.length){
    body.innerHTML = `<div class="muted">Nessun ordine parzialmente concluso.</div>`;
    return;
  }

  const isAdmin = Boolean(state.user && state.user.isAdmin);

  // Admin può vedere anche quelli “fuori finestra”, operatori solo quelli visibili
  const views = buildOrderViews({ applyRoleVisibility: !isAdmin, includeHidden: isAdmin });
  const allOrders = isAdmin ? views.baseOrders : views.orders;

  const map = new Map();
  for(const o of allOrders){
    const k = String(o.orderNo || o.number || "").trim();
    if(k) map.set(k, o);
  }

  const rows = partial
    .map(p => ({ p, o: map.get(String(p.orderNo||"").trim()) }))
    .filter(x => x.o);

  body.innerHTML = `
    <div class="stepTitle">Ordini parziali (${rows.length})</div>
    <div class="muted">Tocca un ordine per aprirlo in Produzione e chiudere le righe rimanenti.</div>
    <div style="height:10px"></div>
    <div class="list" id="partialList"></div>
  `;

  const list = body.querySelector("#partialList");
  for(const {p,o} of rows){
    const div = document.createElement("div");
    div.className = "item pressCard";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">Ordine n. ${escapeHtml(o.orderNo)} · ${escapeHtml(o.customer||"Cliente")}</div>
          <div class="sub">${escapeHtml(String(p.done))} su ${escapeHtml(String(p.total))} righe concluse · Conclusione: <b>${escapeHtml(o.conclusion||"—")}</b></div>
        </div>
        <div class="badge">Apri</div>
      </div>
    `;
    div.onclick = ()=>{
      state.forceOrderNo = o.orderNo;
      closePartialModal();
      openProdModal();
    };
    list.appendChild(div);
  }
}

function openPartialModal(){
  $("partialModal").classList.add("show");
  lockBody();
  renderPartialOrdersList();
}
function closePartialModal(){
  $("partialModal").classList.remove("show");
  unlockBody();
}

// =======================================
// ACTION SHEET (Conclusi) stile Apple
// =======================================
function ensureActionSheet(){
  if(document.getElementById("actionSheet")) return;
  const wrap = document.createElement("div");
  wrap.id = "actionSheet";
  wrap.className = "overlay";
  wrap.setAttribute("role","dialog");
  wrap.setAttribute("aria-modal","true");
  wrap.innerHTML = `
    <div class="sheet" style="max-height:70vh;">
      <div class="shd">
        <div class="h">Conclusi</div>
        <button class="x" id="asClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="asBody"></div>
    </div>
  `;
  document.body.appendChild(wrap);

  wrap.addEventListener("click",(e)=>{
    if(e.target === wrap) closeActionSheet();
  });
  wrap.querySelector("#asClose").onclick = closeActionSheet;
}

function openActionSheet(){
  ensureActionSheet();
  const modal = document.getElementById("actionSheet");
  const body = document.getElementById("asBody");
  const isAdmin = Boolean(state.user && state.user.isAdmin);

  body.innerHTML = `
    <div class="list">
      <div class="item pressCard" id="asOpenReg">
        <div class="top">
          <div>
            <div class="name">Apri registro conclusi</div>
            <div class="sub">Elenco con dettagli produzioni concluse (mese corrente).</div>
          </div>
          <div class="badge">Apri</div>
        </div>
      </div>

      ${isAdmin ? `
      <div class="item pressCard" id="asClearAll" style="border-color: rgba(255,59,48,.22); background: rgba(255,59,48,.06);">
        <div class="top">
          <div>
            <div class="name" style="color:#8a1f1a;">Cancella tutti conclusi</div>
            <div class="sub">Solo admin. Doppia conferma.</div>
          </div>
          <div class="badge" style="border-color: rgba(255,59,48,.4); color:#8a1f1a;">Admin</div>
        </div>
      </div>` : ``}

      <div class="item pressCard" id="asCloseBtn">
        <div class="top">
          <div>
            <div class="name">Chiudi</div>
            <div class="sub">Torna all’hub.</div>
          </div>
          <div class="badge">OK</div>
        </div>
      </div>
    </div>
  `;

  body.querySelector("#asOpenReg").onclick = ()=>{ closeActionSheet(); openHistModalSafe(); };
  body.querySelector("#asCloseBtn").onclick = closeActionSheet;
  if(isAdmin){
    body.querySelector("#asClearAll").onclick = async()=>{ closeActionSheet(); await clearCompletedHistory(); };
  }

  modal.classList.add("show");
  lockBody();
}
function closeActionSheet(){
  const modal = document.getElementById("actionSheet");
  if(!modal) return;
  modal.classList.remove("show");
  unlockBody();
}

// =======================================
// CONCLUSI: apri modal storico (safe)
// =======================================
function openHistModalSafe(){
  // preferisci eventuale funzione già presente
  try{
    if(typeof openHistModal === "function"){ openHistModal(); return; }
  }catch(_e){}

  const m = $("histModal");
  if(!m){ showToast("Conclusi", "Modale storico non trovata."); return; }
  m.classList.add("show");
  lockBody();

  // prova a renderizzare con funzioni già presenti (non tocco fetch)
  try{
    if(typeof renderHistoryModal === "function") renderHistoryModal();
    else if(typeof renderHistory === "function") renderHistory();
    else if(typeof renderCompletedSection === "function") renderCompletedSection();
  }catch(_e){}
}

// =======================================
// CONCLUSI: clear mese corrente (admin + doppia conferma)
// =======================================
async function clearCompletedHistory(){
  const isAdmin = Boolean(state.user && state.user.isAdmin);
  if(!isAdmin){ showToast("Permessi", "Solo admin."); return; }
  const ok1 = confirm("Cancellare TUTTI gli ordini conclusi del mese corrente?");
  if(!ok1) return;
  const ok2 = confirm("Conferma finale: questa azione è IRREVERSIBILE.");
  if(!ok2) return;

  if(!state.firebase || !state.firebase.ok){
    showToast("Offline", "Firebase non disponibile.");
    return;
  }

  const mk = (typeof monthKeyRome==="function") ? monthKeyRome() : "";
  const fs = state.firebase.api;
  const db = state.firebase.db;

  // prova a capire la collection da funzioni già presenti
  const colName =
    (typeof HISTORY_COL!=="undefined" && HISTORY_COL) ? HISTORY_COL :
    (typeof COMPLETED_COL!=="undefined" && COMPLETED_COL) ? COMPLETED_COL :
    "powderHistory";

  try{
    // query per monthKey se disponibile, altrimenti elimina local-only
    if(mk){
      const q = fs.query(fs.collection(db, colName), fs.where("monthKey","==", mk));
      const snap = await fs.getDocs(q);
      const batch = fs.writeBatch(db);
      let n = 0;
      snap.forEach(doc=>{
        batch.delete(doc.ref);
        n++;
      });
      if(n){
        await batch.commit();
      }
    }
  }catch(err){
    console.warn("clearCompletedHistory err", err);
    // fallback: niente delete remoto se query non supportata
  }

  // local state (mese corrente)
  try{
    if(Array.isArray(state.history) && typeof historyMonthOf==="function"){
      const mk2 = (typeof monthKeyRome==="function") ? monthKeyRome() : "";
      state.history = state.history.filter(h => historyMonthOf(h) !== mk2);
    }
  }catch(_e){}

  try{ if(typeof renderCompletedSection==="function") renderCompletedSection(); }catch(_e){}
  try{ if(typeof renderStats==="function") renderStats(); }catch(_e){}
  try{ if(typeof updateHeaderMonthStats==="function") updateHeaderMonthStats(); }catch(_e){}

  showToast("Conclusi", "Cancellati (mese corrente).");
}

// =======================================
// MENSILE: helper + filtro conclusi/statistiche
// =======================================
function monthKeyRome(d=new Date()){
  const dt = new Date(d.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function historyMonthOf(h){
  if(!h) return "";
  if(h.monthKey) return String(h.monthKey);
  const at = h.at || h.createdAt || h.id || "";
  try{
    const dt = at ? new Date(at) : new Date();
    if(String(dt) !== "Invalid Date") return monthKeyRome(dt);
  }catch(_e){}
  return monthKeyRome(new Date());
}
function historyForCurrentMonth(){
  const mk = monthKeyRome();
  return (state.history||[]).filter(h => historyMonthOf(h) === mk);
}

// Override: buildUniqueCompletedHistory (mese corrente)
function buildUniqueCompletedHistory(){
  const hist = historyForCurrentMonth().slice();
  hist.sort((a,b)=> tsFromId(b.id||b.at||0) - tsFromId(a.id||a.at||0));

  const map = new Map();
  for(const h of hist){
    if(!h) continue;
    const orderNo = String(h.orderNo ?? "").trim();
    const customer = String(h.customer ?? "").trim();
    if(!orderNo && !customer) continue;

    const key = `${orderNo}|${customer}`.toLowerCase();
    if(!map.has(key)) map.set(key, h);
  }
  return Array.from(map.values());
}

// Patch: renderStats (mese corrente)
function renderStats(){
  const list = $("statsList");
  const isDesktop = window.matchMedia("(min-width: 980px)").matches;
  if(!isDesktop){
    list.innerHTML = `<div class="muted">Apri da desktop per vedere le statistiche.</div>`;
    $("statsBadge").textContent = "—";
    return;
  }

  const hist = historyForCurrentMonth().filter(x=>x && x.operator);
  if(!hist.length){
    list.innerHTML = `<div class="muted">Nessun dato storico disponibile per il mese corrente.</div>`;
    $("statsBadge").textContent = "0";
    return;
  }

  const agg = new Map();
  for(const h of hist){
    const op = h.operator;
    const kg = Number(h.kg||0);
    const ms = Number(h.durationMs||0);
    const a = agg.get(op) || { kg:0, ms:0, n:0 };
    a.kg += kg; a.ms += ms; a.n += 1;
    agg.set(op, a);
  }

  const rows = Array.from(agg.entries()).map(([op,a])=>{
    const hours = a.ms/3600000;
    const speed = hours>0 ? (a.kg/hours) : 0;
    return { op, ...a, speed };
  }).sort((x,y)=>y.kg-x.kg);

  $("statsBadge").textContent = String(rows.length);
  list.innerHTML = "";
  for(const r of rows){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">${escapeHtml(r.op)}</div>
          <div class="sub">${r.n} produzioni · Velocità media: ${Math.round(r.speed)} kg/h</div>
        </div>
        <div class="badge">${Math.round(r.kg)} kg</div>
      </div>`;
    list.appendChild(div);
  }

  // Box admin: lascia com’è già (se esiste sopra), non duplicare qui
}

// =======================================
// HEADER: “Questo mese: X kg · Y ordini”
// =======================================
function ensureHeaderMonthEl(){
  const sub = document.querySelector(".subtitle");
  if(!sub) return null;
  // costruisci una riga unica: "Benvenuto <operatore> · Questo mese: X kg · Y ordini"
  let wrap = document.getElementById("hdrSubWrap");
  if(!wrap){
    sub.textContent = "";
    wrap = document.createElement("span");
    wrap.id = "hdrSubWrap";
    wrap.style.display = "inline-flex";
    wrap.style.flexWrap = "wrap";
    wrap.style.gap = "6px";
    wrap.style.alignItems = "baseline";
    sub.appendChild(wrap);

    const a = document.createElement("span");
    a.id = "hdrWelcome";
    a.style.fontWeight = "800";
    a.textContent = "Benvenuto";
    wrap.appendChild(a);

    const b = document.createElement("span");
    b.id = "hdrOpName";
    b.style.fontWeight = "900";
    b.textContent = "Operatore";
    wrap.appendChild(b);

    const c = document.createElement("span");
    c.id = "hdrMonthStats";
    c.style.fontWeight = "800";
    c.style.color = "rgba(0,0,0,.62)";
    c.textContent = "· Questo mese: —";
    wrap.appendChild(c);
  }
  return document.getElementById("hdrMonthStats");
}
function updateHeaderMonthStats(){
  const el = ensureHeaderMonthEl();
  if(!el) return;
  const opNameEl = document.getElementById("hdrOpName");
  const opName = (state.operator || state.user?.fullName || "Operatore").trim();
  if(opNameEl) opNameEl.textContent = opName || "Operatore";

  const me = String(opName || "").toLowerCase();
  if(!me){
    el.textContent = "· Questo mese: —";
    return;
  }
  const hist = historyForCurrentMonth().filter(h => String(h.operator||"").toLowerCase() === me);
  const kg = Math.round(hist.reduce((a,h)=>a + (Number(h.kg||0)||0), 0));
  const orders = hist.length;
  el.textContent = `· Questo mese: ${kg.toLocaleString("it-IT")} kg · ${orders} ordini`;
}

// =======================================
// ALERT BANNERS (righe ** / sacchi / bobine)
// =======================================
function parseStarBanner(desc){
  const raw = String(desc||"").replace(/\*/g,"").trim();
  if(!raw) return null;
  const info = detectAlertLine(raw);
  if(info) return { label: raw, kind: info.color };
  // fallback colore “neutro”
  return { label: raw, kind: "other" };
}

function renderAlertBannerHtml(label, kind){
  const p = alertPalette(kind);
  const bg = p.bg || "rgba(0,0,0,.05)";
  const bd = p.border || "rgba(0,0,0,.12)";
  const col = p.color || "#1c1c1e";
  const sh = p.shadow || "0 12px 26px rgba(0,0,0,.06)";
  return `
    <div class="alertBanner pressCard" style="background:${bg}; border-color:${bd}; color:${col}; box-shadow:${sh};">
      <div class="label">${escapeHtml(label)}</div>
      <div class="hint">Avviso</div>
    </div>
  `;
}

// =======================================
// PRODUZIONE: flow completo (ordini → righe → start)
// =======================================
function isLineStarred(line){
  const d = String(line?.desc||"");
  return d.includes("**");
}
function lineKgReal(line){
  // qty è già KG reali (richiesta Ludovico): non moltiplicare per packKg
  return magResolveQtyKg(line);
}

function renderProdStepOrders(){
  const body = $("prodModalBody");
  if(!body) return;

  const isAdmin = Boolean(state.user && state.user.isAdmin);
  state.adminOrderView = state.adminOrderView || "window"; // window=3 giorni, all=tutti

  const viewAll = isAdmin && state.adminOrderView === "all";
  const views = buildOrderViews({
    applyRoleVisibility: !(isAdmin && viewAll),
    includeHidden: (isAdmin && viewAll)
  });

  const orders = (isAdmin && viewAll) ? views.baseOrders : views.orders;

  // Pre-open ordine se arrivo dai parziali
  if(state.forceOrderNo){
    const target = orders.find(o => String(o.orderNo||"") === String(state.forceOrderNo));
    if(target){
      state.forceOrderNo = null;
      state.selectedOrder = target;
      renderProdStepLines(target);
      return;
    }
    // se non presente nella vista corrente, admin forza vista “all”
    if(isAdmin && !viewAll){
      state.adminOrderView = "all";
      renderProdStepOrders();
      return;
    }
  }

  const me = state.user?.fullName || state.operator || "Operatore";
  if(!state.operator) state.operator = me;

  // ordering: prima in produzione, poi parziali, poi per data/conclusione
  const active = state.activeProductions || [];
  const activeOrders = new Set(active.map(p=>String(p.orderNo||"").trim()).filter(Boolean));

  let partialSet = new Set();
  try{ partialSet = new Set((computePartialOrders().partial||[]).map(p=>String(p.orderNo))); }catch(_e){}

  const sortKey = (o)=>{
    const on = String(o.orderNo||"");
    const inProd = activeOrders.has(on) ? 0 : 1;
    const isPar = partialSet.has(on) ? 0 : 1;
    const days = (o.daysAway==null ? 99 : o.daysAway);
    return `${inProd}${isPar}${String(days).padStart(3,"0")}|${norm(o.customer||"")}|${on}`;
  };

  const ord = orders.slice().sort((a,b)=>sortKey(a).localeCompare(sortKey(b)));

  body.innerHTML = `
    <div class="stepTitle">Produzione</div>
    <div class="muted">Operatore: <b>${escapeHtml(state.operator)}</b></div>
    <div style="height:10px"></div>

    <div class="row2" style="margin-bottom:10px;">
      <button class="btn" id="btnOpChange">Cambia operatore</button>
      ${isAdmin ? `<button class="btn" id="btnAdminToggle">${state.adminOrderView==="all" ? "Vista: Tutti" : "Vista: 3 giorni"}</button>` : `<button class="btn ghost" id="btnAdminToggle" disabled style="opacity:.5;">Vista: reparto</button>`}
    </div>

    <div class="planMessage">
      <div class="headline">Seleziona un ordine</div>
      <ul>
        <li>Tap sull’ordine → selezione righe → avvio produzione.</li>
        <li>Righe con <b>**</b> diventano banner (non selezionabili).</li>
        <li>KG = quantità reale da produrre.</li>
      </ul>
    </div>

    <div class="list" id="orderList"></div>
    <div class="muted" style="margin-top:10px;">Ordini visibili: <b>${ord.length}</b>${isAdmin?` · Totali (XML): <b>${views.baseOrders.length}</b>`:""}</div>
  `;

  body.querySelector("#btnOpChange").onclick = ()=> renderOperatorPicker();

  const toggle = body.querySelector("#btnAdminToggle");
  if(isAdmin && toggle){
    toggle.onclick = ()=>{
      state.adminOrderView = (state.adminOrderView==="all") ? "window" : "all";
      renderProdStepOrders();
    };
  }

  const list = body.querySelector("#orderList");
  if(!ord.length){
    list.innerHTML = `<div class="muted">Nessun ordine disponibile.</div>`;
    return;
  }

  for(const o of ord){
    const on = String(o.orderNo||"");
    const inProd = activeOrders.has(on);
    const isPar = partialSet.has(on);

    const badge = inProd ? "In produzione" : (isPar ? "Parziale" : "Da fare");
    const badgeStyle = inProd
      ? `border-color: rgba(52,199,89,.5); color: var(--good);`
      : (isPar ? `border-color: rgba(255,159,10,.55); color: var(--warn);` : ``);

    const meta = [];
    if(o.conclusion) meta.push(`Conclusione: <b>${escapeHtml(o.conclusion)}</b>`);
    if(o.totalKg!=null) meta.push(`Totale: <b>${Math.round(o.totalKg).toLocaleString("it-IT")}</b> kg`);
    if(o.daysAway!=null && o.daysAway!==99) meta.push(`Giorni: <b>${escapeHtml(String(o.daysAway))}</b>`);

    const div = document.createElement("div");
    div.className = "item pressCard";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">${escapeHtml(o.customer||"Cliente")} · Ordine n. ${escapeHtml(on)}</div>
          <div class="sub">${meta.join(" · ") || "—"}</div>
        </div>
        <div class="badge" style="${badgeStyle}">${badge}</div>
      </div>
    `;
    div.onclick = ()=>{
      state.selectedOrder = o;
      renderProdStepLines(o);
    };
    list.appendChild(div);
  }
}

function renderOperatorPicker(){
  const body = $("prodModalBody");
  const current = state.operator || (state.user?.fullName || "Operatore");

  const ops = Array.from(new Set([current, ...(OPERATORS||[]), (state.user?.fullName||"")].filter(Boolean)));
  body.innerHTML = `
    <div class="stepTitle">Seleziona operatore</div>
    <div class="muted">Serve per registrare statistiche e conclusioni.</div>
    <div class="radioRow" id="opList"></div>
    <div style="height:12px"></div>
    <button class="btn" id="opBack" style="width:100%;">Indietro</button>
  `;

  const list = body.querySelector("#opList");
  for(const name of ops){
    const id = `op_${norm(name).replace(/\s+/g,"_")}`;
    const row = document.createElement("label");
    row.className = "radio pressCard";
    row.setAttribute("for", id);
    row.innerHTML = `
      <input type="radio" name="opSel" id="${id}" ${name===current ? "checked":""}/>
      <span>${escapeHtml(name)}</span>
    `;
    row.onclick = ()=>{
      state.operator = name;
      renderProdStepOrders();
    };
    list.appendChild(row);
  }

  body.querySelector("#opBack").onclick = renderProdStepOrders;
}

function renderProdStepLines(order){
  const body = $("prodModalBody");
  const isAdmin = Boolean(state.user && state.user.isAdmin);

  const allLines = Array.isArray(order.lines) ? order.lines.slice() : [];
  const starred = allLines.filter(isLineStarred);
  const normalLines = allLines.filter(l => !isLineStarred(l));

  state.selectedLineKeys = state.selectedLineKeys || new Set();
  state.selectedLineKeys.clear();

  const titleMeta = [];
  if(order.conclusion) titleMeta.push(`Conclusione: <b>${escapeHtml(order.conclusion)}</b>`);
  titleMeta.push(`Righe: <b>${normalLines.length}</b>`);

  body.innerHTML = `
    <div class="row2" style="margin-bottom:10px;">
      <button class="btn" id="btnBackOrders">← Ordini</button>
      <button class="btn" id="btnSelectAll">Seleziona tutto</button>
    </div>

    <div class="stepTitle">Ordine n. ${escapeHtml(order.orderNo||"—")} · ${escapeHtml(order.customer||"Cliente")}</div>
    <div class="muted">${titleMeta.join(" · ")}</div>

    <div style="height:10px"></div>

    ${order.alerts && order.alerts.length ? `
      <div class="muted" style="margin-bottom:8px;">Avvisi operativi</div>
      <div class="list" id="alertList">${order.alerts.map(a=>renderAlertBannerHtml(a.alertInfo?.label || a.desc || "Avviso", a.alertInfo?.color || "other")).join("")}</div>
      <div style="height:10px"></div>
    ` : ``}

    ${starred.length ? `
      <div class="muted" style="margin-bottom:8px;">Avvisi (da righe **)</div>
      <div class="list" id="starList">${starred.map(l=>{ const b=parseStarBanner(l.desc); return b?renderAlertBannerHtml(b.label, b.kind):""; }).join("")}</div>
      <div style="height:10px"></div>
    ` : ``}

    <div class="muted" style="margin-bottom:8px;">Seleziona righe da produrre</div>
    <div class="list" id="lineList"></div>

    <div style="height:12px"></div>

    <div class="k" style="border-radius:18px;">
      <div class="t">Totale selezionato (kg)</div>
      <div class="v" id="selKg">0</div>
      <div class="muted" style="margin-top:6px;">I kg sono reali (non moltiplicati per sacchi).</div>
    </div>

    <div style="height:12px"></div>
    <button class="btn good" id="btnStartProd" style="width:100%; font-size:16px; padding:16px; border-radius:18px;">INIZIA PRODUZIONE</button>
    <div style="height:8px"></div>
    <div class="muted">Solo admin può annullare una produzione già avviata.</div>
  `;

  body.querySelector("#btnBackOrders").onclick = renderProdStepOrders;

  const list = body.querySelector("#lineList");
  const selKgEl = body.querySelector("#selKg");

  const updateSel = ()=>{
    let kg = 0;
    for(const l of normalLines){
      if(state.selectedLineKeys.has(String(l.lineKey))){
        kg += lineKgReal(l);
      }
    }
    selKgEl.textContent = Math.round(kg).toLocaleString("it-IT");
  };

  const toggleLine = (l)=>{
    const k = String(l.lineKey||"");
    if(!k) return;
    if(state.selectedLineKeys.has(k)) state.selectedLineKeys.delete(k);
    else state.selectedLineKeys.add(k);
    updateSel();
    renderLineChecks();
  };

  const renderLineChecks = ()=>{
    // aggiorna badge selezione
    for(const el of list.querySelectorAll("[data-linekey]")){
      const k = el.getAttribute("data-linekey");
      const checked = state.selectedLineKeys.has(k);
      const badge = el.querySelector(".badge");
      if(badge) badge.textContent = checked ? "✓" : "Seleziona";
      if(checked) el.style.background = "rgba(10,132,255,.06)";
      else el.style.background = "rgba(0,0,0,.03)";
    }
  };

  for(const l of normalLines){
    const kg = lineKgReal(l);
    const div = document.createElement("div");
    div.className = "item pressCard";
    div.setAttribute("data-linekey", String(l.lineKey||""));
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">${escapeHtml(l.desc||"")}</div>
          <div class="sub">Codice: <b>${escapeHtml(l.code||"—")}</b> · ${escapeHtml(formatQtyWithKg(l.qty, l.um||"kg"))}</div>
        </div>
        <div class="badge"><b style="font-variant-numeric: tabular-nums;">${Math.round(kg)}</b> kg</div>
      </div>
      <div class="muted" style="margin-top:8px; font-size:12px;">Tap per selezionare</div>
    `;
    div.onclick = ()=> toggleLine(l);
    list.appendChild(div);
  }

  body.querySelector("#btnSelectAll").onclick = ()=>{
    const allSelected = normalLines.every(l=>state.selectedLineKeys.has(String(l.lineKey||"")));
    state.selectedLineKeys.clear();
    if(!allSelected){
      for(const l of normalLines){
        if(l.lineKey) state.selectedLineKeys.add(String(l.lineKey));
      }
    }
    updateSel();
    renderLineChecks();
  };

  body.querySelector("#btnStartProd").onclick = async()=>{
    const keys = Array.from(state.selectedLineKeys || []);
    if(!keys.length){
      showToast("Selezione", "Seleziona almeno una riga.");
      return;
    }
    const operator = state.operator || state.user?.fullName || "Operatore";
    await startProduction(order, operator, keys);
  };

  updateSel();
  renderLineChecks();
}

async function startProduction(order, operator, selectedKeys){
  try{
    if(!state.firebase.ok){
      showToast("Produzione", "Firebase non disponibile (offline).");
      return;
    }
    const selectedLines = (order.lines||[]).filter(l=>selectedKeys.includes(String(l.lineKey)));
    const perLine = selectedLines.map(l=>({
      lineKey: String(l.lineKey||""),
      code: l.code||"",
      desc: l.desc||"",
      qty: l.qty,
      um: l.um||"",
      plannedKg: lineKgReal(l),
      producedKg: null
    }));
    const totalKg = perLine.reduce((a,x)=>a + (Number(x.plannedKg)||0), 0);

    const prod = {
      orderNo: order.orderNo || order.number || "",
      customer: order.customer || "",
      operator,
      operatorUid: state.user?.uid || "",
      selectedLineKeys: selectedKeys,
      perLine,
      totalKg,
      startedAt: nowIso(),
      active: true,
      monthKey: monthKeyRome()
    };

    const id = await upsertActiveProduction(prod);
    showToast("Produzione avviata", `Ordine ${prod.orderNo} · ${Math.round(totalKg)} kg`);
    speak(`Produzione avviata. Ordine ${prod.orderNo}.`);

    closeProdModalRequest();
    openRunningModal(id);
  }catch(err){
    console.warn(err);
    showToast("Errore", "Impossibile avviare la produzione.");
  }
}

// =======================================
// RUNNING MODAL (dettagli + conclude/annulla)
// =======================================
function openRunningModal(focusProdId=null){
  $("runningModal").classList.add("show");
  lockBody();
  state.focusProdId = focusProdId || null;
  renderRunningModal();
}
function closeRunningModal(){
  $("runningModal").classList.remove("show");
  unlockBody();
  state.focusProdId = null;
}

function renderRunningModal(){
  const body = $("runningBody");
  if(!body) return;

  const active = (state.activeProductions||[]).filter(p=>p && p.active);
  const isAdmin = Boolean(state.user && state.user.isAdmin);
  const me = (state.user?.fullName || state.operator || "").toLowerCase();

  if(!active.length){
    body.innerHTML = `<div class="muted">Nessuna produzione attiva.</div>`;
    return;
  }

  // ordina: prima quella in focus, poi le mie, poi le altre
  const score = (p)=>{
    const id = String(p.id||"");
    const op = String(p.operator||"").toLowerCase();
    if(state.focusProdId && id===String(state.focusProdId)) return 0;
    if(me && op===me) return 1;
    return 2;
  };
  const rows = active.slice().sort((a,b)=>score(a)-score(b));

  body.innerHTML = `
    <div class="stepTitle">Produzioni attive (${rows.length})</div>
    <div class="muted">Apri una produzione per concludere (solo la tua o admin).</div>
    <div style="height:10px"></div>
    <div class="list" id="runList"></div>
  `;

  const list = body.querySelector("#runList");

  for(const p of rows){
    const id = String(p.id||"");
    const op = p.operator || "Operatore";
    const orderNo = p.orderNo || "—";
    const customer = p.customer || "";
    const started = p.startedAt ? fmtDateTime(p.startedAt) : "—";
    const totalKg = Math.round(Number(p.totalKg||0)||0);

    const mine = me && String(op).toLowerCase()===me;
    const canEdit = mine || isAdmin;

    const div = document.createElement("div");
    div.className = "item pressCard";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">Ordine n. ${escapeHtml(orderNo)} ${customer?`· ${escapeHtml(customer)}`:""}</div>
          <div class="sub">${escapeHtml(op)} · Avviata: <b>${escapeHtml(started)}</b> · Totale: <b>${totalKg}</b> kg</div>
        </div>
        <div class="badge">${canEdit ? "Apri" : "Solo lettura"}</div>
      </div>
    `;
    div.onclick = ()=> openRunningDetail(id);
    list.appendChild(div);
  }
}

function openRunningDetail(prodId){
  const body = $("runningBody");
  const p = (state.activeProductions||[]).find(x=>String(x.id||"")===String(prodId));
  if(!p){
    renderRunningModal();
    return;
  }

  const isAdmin = Boolean(state.user && state.user.isAdmin);
  const me = (state.user?.fullName || state.operator || "").toLowerCase();
  const mine = me && String(p.operator||"").toLowerCase()===me;
  const canEdit = mine || isAdmin;

  const perLine = Array.isArray(p.perLine) ? p.perLine.slice() : [];
  state._prodDraft = state._prodDraft || {};
  state._prodDraft[prodId] = state._prodDraft[prodId] || {};
  const draft = state._prodDraft[prodId];

  // init draft with plannedKg
  for(const l of perLine){
    const k = String(l.lineKey||"");
    if(!k) continue;
    if(draft[k]==null){
      const v = (l.producedKg!=null) ? Number(l.producedKg) : Number(l.plannedKg||0);
      draft[k] = Number.isFinite(v) ? v : 0;
    }
  }

  body.innerHTML = `
    <div class="row2" style="margin-bottom:10px;">
      <button class="btn" id="runBack">← Elenco</button>
      <button class="btn ghost" id="runClose">Chiudi</button>
    </div>

    <div class="stepTitle">Ordine n. ${escapeHtml(p.orderNo||"—")} ${p.customer?`· ${escapeHtml(p.customer)}`:""}</div>
    <div class="muted">Operatore: <b>${escapeHtml(p.operator||"—")}</b> · Avviata: <b>${escapeHtml(p.startedAt?fmtDateTime(p.startedAt):"—")}</b></div>

    <div style="height:12px"></div>

    <div class="muted" style="margin-bottom:8px;">Inserisci i kg prodotti per riga</div>
    <div class="list" id="runLines"></div>

    <div style="height:12px"></div>
    <div class="k" style="border-radius:18px;">
      <div class="t">Totale prodotti (kg)</div>
      <div class="v" id="runTotKg">—</div>
      <div class="muted" style="margin-top:6px;">Questo valore finisce nelle statistiche mensili.</div>
    </div>

    <div style="height:12px"></div>

    <div class="row2">
      <button class="btn good" id="btnConcludeNow" ${canEdit ? "" : "disabled"} style="opacity:${canEdit?1:.55};">Concludi</button>
      <button class="btn bad" id="btnAbortNow" ${isAdmin ? "" : "disabled"} style="opacity:${isAdmin?1:.45};">Annulla</button>
    </div>

    <div style="height:10px"></div>
    <div class="muted">${canEdit ? "Concludi → firma e registrazione." : "Solo l’operatore o un admin può concludere."}</div>
  `;

  body.querySelector("#runBack").onclick = renderRunningModal;
  body.querySelector("#runClose").onclick = closeRunningModal;

  const runLines = body.querySelector("#runLines");

  for(const l of perLine){
    const k = String(l.lineKey||"");
    const planned = Number(l.plannedKg||0)||0;

    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="top">
        <div>
          <div class="name">${escapeHtml(l.desc||"")}</div>
          <div class="sub">Pianificati: <b>${Math.round(planned)}</b> kg</div>
        </div>
        <div class="badge">${escapeHtml(l.code||"—")}</div>
      </div>
      <div style="height:10px"></div>
      <div class="field" style="margin:0;">
        <label>Kg prodotti</label>
        <input ${canEdit ? "" : "disabled"} data-linekey="${escapeHtml(k)}" type="number" inputmode="decimal" step="0.01" min="0"
               value="${escapeHtml(String(draft[k]??planned))}" style="font-weight:900;"/>
      </div>
    `;
    runLines.appendChild(row);
  }

  const calcTot = ()=>{
    let tot = 0;
    for(const [k,v] of Object.entries(draft)){
      const n = Number(v);
      if(Number.isFinite(n)) tot += n;
    }
    body.querySelector("#runTotKg").textContent = Math.round(tot).toLocaleString("it-IT");
    return tot;
  };

  runLines.querySelectorAll("input[data-linekey]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const k = inp.getAttribute("data-linekey");
      const n = Number(String(inp.value).replace(",","."));
      draft[k] = Number.isFinite(n) ? n : 0;
      calcTot();
    });
  });

  calcTot();

  body.querySelector("#btnConcludeNow").onclick = ()=>{
    if(!canEdit) return;
    const tot = calcTot();
    if(tot <= 0){
      showToast("Concludi", "Inserisci almeno 1 kg prodotto.");
      return;
    }
    openSignForProduction(p, draft, tot);
  };

  body.querySelector("#btnAbortNow").onclick = async()=>{
    if(!isAdmin) return;
    const ok = confirm("Annullare questa produzione?");
    if(!ok) return;
    await abortProduction(p);
  };
}

async function abortProduction(p){
  try{
    await closeActiveProduction(p.id, { aborted:true, abortedBy: state.user?.fullName || "admin" });
    await addAbort({
      monthKey: monthKeyRome(),
      orderNo: p.orderNo||"",
      customer: p.customer||"",
      operator: p.operator||"",
      reason: "Annullata da admin"
    });
    showCancelBanner(`Ordine ${p.orderNo||""} annullato da admin.`);
    speak("Produzione annullata.");
    showToast("Annullata", `Produzione annullata (Ordine ${p.orderNo||""}).`);
    closeRunningModal();
  }catch(err){
    console.warn(err);
    showToast("Errore", "Impossibile annullare la produzione.");
  }
}

// =======================================
// FIRMA: nome operatore + checkbox + canvas
// =======================================
let _sig = { drawing:false, empty:true, last:null };

function initSignaturePad(){
  const canvas = $("signCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  const resize = ()=>{
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.lineWidth = 2.2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#111";
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,rect.width,rect.height);
    _sig.empty = true;
  };

  resize();
  window.addEventListener("resize", ()=>{ if($("signModal").classList.contains("show")) resize(); }, { passive:true });

  const pos = (e)=>{
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX ?? (e.touches && e.touches[0]?.clientX) ?? 0) - r.left;
    const y = (e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? 0) - r.top;
    return { x, y };
  };

  const start = (e)=>{
    e.preventDefault();
    _sig.drawing = true;
    const p = pos(e);
    _sig.last = p;
  };
  const move = (e)=>{
    if(!_sig.drawing) return;
    e.preventDefault();
    const p = pos(e);
    const last = _sig.last || p;
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    _sig.last = p;
    _sig.empty = false;
  };
  const end = (e)=>{
    if(!_sig.drawing) return;
    e.preventDefault();
    _sig.drawing = false;
    _sig.last = null;
  };

  canvas.onpointerdown = start;
  canvas.onpointermove = move;
  canvas.onpointerup = end;
  canvas.onpointercancel = end;

  // iOS fallback
  canvas.ontouchstart = start;
  canvas.ontouchmove = move;
  canvas.ontouchend = end;
}

function clearSignature(){
  const canvas = $("signCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const r = canvas.getBoundingClientRect();
  ctx.clearRect(0,0,r.width,r.height);
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,r.width,r.height);
  _sig.empty = true;
}

function openSignForProduction(prod, draftMap, totalKg){
  state._pendingSign = { prod, draftMap, totalKg };

  // inject nome operatore field (se non c’è già)
  const modal = $("signModal");
  const sbd = modal.querySelector(".sbd");
  if(!document.getElementById("signNameField")){
    const box = document.createElement("div");
    box.id = "signNameField";
    box.innerHTML = `
      <div style="height:10px"></div>
      <div class="field">
        <label>Nome operatore</label>
        <input id="signOperatorName" placeholder="Nome operatore" style="font-weight:900;" />
      </div>
    `;
    // inseriscilo sopra checkbox
    const check = document.getElementById("signCheck")?.parentElement;
    if(check) sbd.insertBefore(box, check);
  }

  $("signOperatorName").value = (state.operator || state.user?.fullName || prod.operator || "").trim();

  $("signContext").innerHTML = `
    Ordine <b>${escapeHtml(prod.orderNo||"—")}</b> · ${escapeHtml(prod.customer||"Cliente")}<br/>
    Totale prodotti: <b>${Math.round(totalKg).toLocaleString("it-IT")}</b> kg
  `;

  $("signCheck").checked = false;
  clearSignature();

  $("signModal").classList.add("show");
  lockBody();
  requestAnimationFrame(()=> initSignaturePad());
}

function closeSignModal(){
  $("signModal").classList.remove("show");
  unlockBody();
  state._pendingSign = null;
}

async function finalizeProduction(){
  try{
    const pending = state._pendingSign;
    if(!pending) return;

    const operatorName = String($("signOperatorName")?.value || "").trim();
    if(!operatorName){
      showToast("Firma", "Inserisci il nome operatore.");
      return;
    }
    if(!$("signCheck").checked){
      showToast("Firma", "Conferma la dichiarazione.");
      return;
    }
    if(_sig.empty){
      showToast("Firma", "Firma mancante.");
      return;
    }

    const canvas = $("signCanvas");
    const signature = canvas.toDataURL("image/png");

    const { prod, draftMap, totalKg } = pending;

    const perLine = (Array.isArray(prod.perLine) ? prod.perLine : []).map(l=>{
      const k = String(l.lineKey||"");
      const produced = Number(draftMap[k] ?? l.plannedKg ?? 0);
      return {
        ...l,
        producedKg: Number.isFinite(produced) ? produced : 0,
        operator: operatorName
      };
    });

    const startedAt = prod.startedAt ? new Date(prod.startedAt).getTime() : Date.now();
    const durationMs = Math.max(1, Date.now() - startedAt);

    // chiudi attiva
    await closeActiveProduction(prod.id, { active:false, concludedAt: nowIso(), concludedBy: operatorName });

    // storico (mensile)
    const entry = {
      monthKey: monthKeyRome(),
      orderNo: prod.orderNo||"",
      customer: prod.customer||"",
      operator: operatorName,
      kg: totalKg,
      durationMs,
      perLine,
      concludedLineKeys: Array.isArray(prod.selectedLineKeys) ? prod.selectedLineKeys : [],
      signature
    };
    const hid = await addHistory(entry);

    // stats operatore (mensili: usiamo collection operatorStats ma la UI filtra mese; ok)
    await bumpOperatorKg(state.user?.uid || prod.operatorUid || "", operatorName, totalKg);

    // notifica locale (se permesso)
    try{
      if("Notification" in window && Notification.permission === "granted"){
        new Notification("Produzione conclusa", { body: `Ordine ${prod.orderNo||""} · ${Math.round(totalKg)} kg`, silent:false });
      }
    }catch(_e){}

    showToast("Conclusa", `Ordine ${prod.orderNo||""} registrato.`);
    speak("Produzione conclusa.");

    // update UI immediato (oltre a snapshot)
    state.history = Array.isArray(state.history) ? [ { id: hid, ...entry, at: nowIso() }, ...state.history ] : state.history;
    try{ renderCompletedSection(); }catch(_e){}
    try{ updateHeaderMonthStats(); }catch(_e){}

    closeSignModal();
    closeRunningModal();
  }catch(err){
    console.warn(err);
    showToast("Errore", "Impossibile concludere la produzione.");
  }
}

// =======================================
// EVENTI UI / AUTO REFRESH / HOME actions
// =======================================
function hookUI(){
  // Close buttons
  $("cancelBannerClose")?.addEventListener("click", hideCancelBanner);
  $("histClose")?.addEventListener("click", ()=>{ $("histModal").classList.remove("show"); unlockBody(); });
  $("notifClose")?.addEventListener("click", closeNotifModal);
  $("prodModalClose")?.addEventListener("click", closeProdModalRequest);
  $("runningClose")?.addEventListener("click", closeRunningModal);
  $("partialClose")?.addEventListener("click", closePartialModal);
  $("signClose")?.addEventListener("click", closeSignModal);
  $("signClear")?.addEventListener("click", clearSignature);
  $("signOk")?.addEventListener("click", finalizeProduction);

  // overlay click outside
  ["histModal","notifModal","prodModal","runningModal","partialModal","signModal"].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("click",(e)=>{
      if(e.target !== el) return;
      if(id==="prodModal") closeProdModalRequest();
      else if(id==="runningModal") closeRunningModal();
      else if(id==="partialModal") closePartialModal();
      else if(id==="signModal") closeSignModal();
      else if(id==="notifModal") closeNotifModal();
      else if(id==="histModal"){ el.classList.remove("show"); unlockBody(); }
    });
  });

  // CTA principali
  $("btnGoProd")?.addEventListener("click", handlePrimaryCta);
  $("prodStrip")?.addEventListener("click", ()=> openRunningModal());

  // Parziali banner click
  $("partialBanner")?.addEventListener("click", ()=> openPartialModal());
  $("partialBanner")?.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openPartialModal(); } });

  // Statistiche: scroll to card
  $("btnOpenStats")?.addEventListener("click", ()=>{
    const c = $("statsCard");
    if(c) c.scrollIntoView({ behavior:"smooth", block:"start" });
  });

  // Chiama Matteo (placeholder: modifica numero se vuoi)
  $("btnCallMatteo")?.addEventListener("click", ()=>{
    const tel = localStorage.getItem("MATTEO_TEL") || "";
    if(tel){
      window.location.href = `tel:${tel}`;
    } else {
      showToast("Chiama Matteo", "Imposta MATTEO_TEL in localStorage (es: +39333...).");
    }
  });

  // Conclusi pill → action sheet
  $("pillNotif")?.addEventListener("click", openActionSheet);

  // Fatturato: tap mobile per reveal
  $("fatValue")?.addEventListener("click", ()=>{
    const isDesk = window.matchMedia("(min-width: 980px)").matches;
    if(isDesk) return;
    const el = $("fatValue");
    el.classList.add("reveal");
    el.classList.remove("blur");
    updateFatturatoUI();
    setTimeout(()=>{ el.classList.remove("reveal"); el.classList.add("blur"); updateFatturatoUI(); }, 12000);
  });

  // Segnala problema
  $("btnSendIssue")?.addEventListener("click", async()=>{
    const t = String($("issueText")?.value || "").trim();
    if(!t){ showToast("Segnalazione", "Scrivi un messaggio."); return; }
    const me = state.user?.fullName || state.operator || "Operatore";
    // contesto: se ho una produzione attiva mia, aggancio ordine
    const active = (state.activeProductions||[]).find(p=>String(p.operator||"").toLowerCase()===String(me).toLowerCase());
    const entry = {
      monthKey: monthKeyRome(),
      text: t,
      operator: me,
      orderNo: active?.orderNo || "",
      customer: active?.customer || ""
    };
    await addIssue(entry);
    $("issueText").value = "";
    showToast("Inviata", "Segnalazione registrata.");
  });

  // Auto refresh su mobile (no pulsante in home)
  window.addEventListener("focus", ()=>debounceRefresh("focus"), { passive:true });
  document.addEventListener("visibilitychange", ()=>{
    if(!document.hidden) debounceRefresh("focus");
  }, { passive:true });
  window.addEventListener("pageshow", ()=>debounceRefresh("pageshow"), { passive:true });

  // Aggiorna header mensile quando arriva storico
  updateHeaderMonthStats();
}

// =======================================
// FIX CSS mobile header a sinistra (fallback)
// (Codex deve comunque sistemare nel CSS, ma metto anche un fallback JS)
// =======================================
function forceMobileHeaderLeft(){
  if(!window.matchMedia("(max-width: 720px)").matches) return;
  try{
    const tw = document.querySelector(".titleWrap");
    const t = document.querySelector(".title");
    const s = document.querySelector(".subtitle");
    if(tw){ tw.style.alignItems = "flex-start"; tw.style.textAlign = "left"; }
    if(t){ t.style.alignItems = "flex-start"; t.style.textAlign = "left"; }
    if(s){ s.style.textAlign = "left"; }
  }catch(_e){}
}

// =======================================
// STARTUP
// =======================================
document.addEventListener("DOMContentLoaded", ()=>{
  hookUI();
  forceMobileHeaderLeft();
  try{ ensureHeaderMonthEl(); }catch(_e){}
  boot();
});

</script>
</body>
</html>
