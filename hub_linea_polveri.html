<!doctype html>
<html lang="it" translate="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="google" content="notranslate"/>
  <meta http-equiv="Content-Language" content="it"/>
  <meta name="color-scheme" content="light"/>
  <!-- // UI-FIX: anticache --><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <!-- // UI-FIX: anticache --><meta http-equiv="Pragma" content="no-cache" />
  <!-- // UI-FIX: anticache --><meta http-equiv="Expires" content="0" />
  <title>Hub Linea Polveri</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Crect width=%2764%27 height=%2764%27 rx=%2716%27 fill=%27%232e7bff%27/%3E%3Cpath d=%27M22 43c0-11 8-20 20-20h2v6h-2c-8 0-14 6-14 14v2h-6v-2z%27 fill=%27white%27/%3E%3Cpath d=%27M40 33a6 6 0 1 1 0-12h2v6h-2a0 0 0 0 0 0 0 0 0 0 0 0 0 6z%27 fill=%27white%27 opacity=%270.9%27/%3E%3C/svg%3E">
  <style>
    :root {
      --bg: #f5f5f7;
      --bg2: #ffffff;
      --card: #ffffff;
      --card2: #ffffff;
      --stroke: rgba(0,0,0,.10);
      --text: rgba(0,0,0,.90);
      --muted: rgba(0,0,0,.62);
      --accent:#0a84ff;
      --good:#34c759;
      --warn:#ff9f0a;
      --bad:#ff3b30;
      --shadow: 0 10px 26px rgba(0,0,0,.10);
      --radius: 18px;
      --radius2: 22px;
      --safe-top: env(safe-area-inset-top);
      --safe-bot: env(safe-area-inset-bottom);
      --banner-offset: 0px;
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Avenir Next", Avenir, "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color: var(--text);
      overflow-y: auto;
      overflow-x: hidden;
      max-width: 100vw;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: calc(18px + var(--safe-top) + var(--banner-offset)) 16px calc(26px + var(--safe-bot));
    }

    header {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .titleWrap{ display:flex; flex-direction:column; gap:4px; }
    .title {
      font-size: 40px;
      line-height: 0.70;
      font-weight: 800;
      letter-spacing: -0.02em;
      text-transform: none;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      word-break: break-word;
    }
    .title .titleLine{ display:block; }
    .title .titleLine.accent{ color: #0a84ff; }
    .subtitle {
      margin-top: 2px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    @media (max-width: 720px){
      header { flex-direction: column; align-items:flex-start; }
      .statusRow { justify-content:flex-start; }
      .title { flex-direction:column; align-items:flex-start; text-align:left; width:100%; }
      .titleWrap{ width:100%; text-align:left; align-items:flex-start; }
      .subtitle{ text-align:left; }
    }

    .statusRow {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
      width:100%;
    }
    .pill {
      padding: 8px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(0,0,0,.04);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
    }
    .pillBadge{
      display:none;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: 999px;
      background: var(--bad);
      color: #fff;
      font-weight: 900;
      font-size: 11px;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    .dot {
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
    }
    .dot.ok { background: var(--good); }
    .dot.warn { background: var(--warn); }
    .dot.bad { background: var(--bad); }

    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 980px){
      .grid {
        grid-template-columns: 1.25fr .75fr;
        align-items:start;
      }
      .title { font-size: 46px; }
    }

    .card {
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      box-sizing: border-box;
    }
    .card .hd {
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .card .hd h2 {
      margin:0;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .02em;
      color: rgba(0,0,0,.88);
      text-transform: uppercase;
    }
    .card .bd {
      padding: 14px;
    }

    .primaryBtn {
      width:100%;
      border: none;
      border-radius: 20px;
      padding: 18px 18px;
      background: linear-gradient(180deg, rgba(46,123,255,1), rgba(18,105,245,.9));
      color: white;
      font-weight: 900;
      font-size: 19px;
      letter-spacing: .02em;
      box-shadow: 0 18px 36px rgba(46,123,255,.28);
      cursor:pointer;
      min-height: 56px;
      transition: transform .15s cubic-bezier(.22,.61,.36,1), box-shadow .18s ease, filter .18s ease;
    }
    .primaryBtn:active { transform: translateY(1.5px) scale(.995); box-shadow: 0 12px 22px rgba(46,123,255,.2); }
    .primaryBtn:focus-visible{ outline: 2px solid rgba(46,123,255,.35); outline-offset: 2px; }
    .warnBanner{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(255,149,0,.12);
      border:1px solid rgba(255,149,0,.28);
      transition: opacity .18s ease, transform .2s cubic-bezier(.22,.61,.36,1);
    }
    .warnBanner .icon{ font-size:20px; line-height:1; }
    .warnBanner .txt{ flex:1; min-width:0; }
    .warnBanner .txt .t{ font-weight: 900; color: rgba(0,0,0,.88); }
    .warnBanner .txt .s{ margin-top:2px; font-size:12px; color: rgba(0,0,0,.62); }
    .alertBanner{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.04);
      font-weight: 900;
      letter-spacing: .01em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
      transition: opacity .2s ease, transform .2s cubic-bezier(.22,.61,.36,1);
    }
    .alertBanner .label{ flex:1; min-width:0; word-break: break-word; }
    .alertBanner .hint{ font-size: 12px; color: rgba(0,0,0,.7); font-weight:800; }
    /* CODEX: banner sacchetto bianco */
    .whiteBagBanner{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:14px;
      flex-wrap:wrap;
      width:100%;
      padding:16px 16px;
      margin: 0;
      border-radius:18px;
      background: linear-gradient(180deg, #ffffff 0%, #f6f8ff 100%);
      border:1px solid rgba(10,132,255,.18);
      color:#0a3a7d;
      font-weight: 900;
      letter-spacing: .01em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.9), 0 12px 26px rgba(0,0,0,.06);
      line-height: 1.25;
      pointer-events: auto; /* CODEX: il banner resta cliccabile per la selezione */
      word-break: break-word;
    }
    .whiteBagBanner .icon{ font-size:22px; }
    .whiteBagBanner .txt{ display:flex; flex-direction:column; gap:4px; flex:1; min-width:0; }
    .whiteBagBanner .txt .t{ font-size:15px; letter-spacing:.02em; }
    .whiteBagBanner .txt .s{ font-size:13px; font-weight:800; opacity:.9; }
    .fadeCard{ opacity:0; transform: translateY(6px); }
    .fadeCard.show{ opacity:1; transform: translateY(0); }
    .planMessage{
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
      box-shadow: 0 12px 30px rgba(0,0,0,.08);
      margin-bottom: 10px;
    }
    .planMessage .headline{ font-weight: 950; letter-spacing:.01em; }
    .planMessage ul{ margin: 10px 0 0 18px; color: var(--muted); font-weight:800; padding-left: 12px; }
    .planMessage li{ margin-bottom: 6px; }
    .miniBtn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,149,0,.88);
      color:white;
      font-weight: 900;
      letter-spacing:.01em;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(255,149,0,.22);
      white-space:nowrap;
    }
    .miniBtn:active{ transform: translateY(1px); }


    .row2 {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap:10px;
    }
    .btn {
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.88);
      padding: 14px 12px;
      border-radius: 16px;
      font-weight: 800;
      cursor:pointer;
      min-height: 44px;
    }
    .btn:active { transform: translateY(1px); }
    .btn.good { background: rgba(32,201,151,.16); border-color: rgba(32,201,151,.35); }
    .btn.bad { background: rgba(255,77,79,.14); border-color: rgba(255,77,79,.35); }
    .btn.ghost { background: transparent; }

    .bigStrip {
      border-radius: 18px;
      padding: 14px 14px;
      border: 1px solid rgba(0,0,0,.05);
      background: linear-gradient(120deg, #0d8d3a, #0b7c32 55%, #0a6f2c);
      position: relative;
      overflow:hidden;
      cursor:pointer;
      color: white;
      box-shadow: 0 14px 32px rgba(13,141,58,.32);
      transition: transform .12s ease, box-shadow .18s ease;
    }
    .bigStrip:active{ transform: translateY(1px); box-shadow: 0 10px 20px rgba(13,141,58,.25); }
    .bigStrip .label {
      font-weight: 900;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .06em;
      opacity:.95;
    }
    .bigStrip .marquee {
      margin-top: 10px;
      font-size: 18px;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
      padding-bottom: 2px;
    }
    .bigStrip .marquee span {
      display:inline-block;
      padding-left: 100%;
      animation: marquee 16s linear infinite;
    }
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .bigStrip .meta {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.88);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .kv {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .k {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .k .t { font-size: 12px; color: var(--muted); font-weight:700; }
    .k .v { margin-top: 4px; font-size: 18px; font-weight: 900; }

    .list {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item {
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.03);
      border-radius: 16px;
      padding: 12px;
      overflow-wrap:anywhere;
    }
    .item .top {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .item .name {
      font-weight: 900;
      font-size: 16px;
      line-height:1.1;
      word-break:break-word;
    }
    .item .sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      word-break: break-word;
    }
    .notifList{ display:flex; flex-direction:column; gap:8px; }
    .notifItem{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
    }
    .notifItem.unread{ border-color: rgba(46,123,255,.38); box-shadow: 0 8px 18px rgba(46,123,255,.12); }
    .notifTitle{ font-weight: 950; font-size: 14px; letter-spacing:.01em; }
    .notifBody{ margin-top:6px; color: var(--muted); font-weight:800; font-size:13px; }
    .notifMeta{ margin-top:8px; font-size:11px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
    .notifEmpty{ color: var(--muted); font-weight:800; }
    .badge {
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
      max-width:100%;
    }
    .pressCard{
      cursor:pointer;
      transition: transform .16s cubic-bezier(.18,.69,.25,1), box-shadow .18s ease, background .18s ease, opacity .18s ease;
      will-change: transform, opacity;
    }
    .pressCard:active{
      transform: scale(.99);
      box-shadow: 0 12px 32px rgba(0,0,0,.14);
    }
    .selectableLine{
      position: relative;
      overflow:hidden;
    }
    .selectableLine::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(46,123,255,.08), rgba(46,123,255,.02));
      opacity:0;
      transition: opacity .16s ease, transform .16s ease;
      z-index:0;
    }
    .selectableLine.selected{
      border-color: rgba(46,123,255,.55);
      box-shadow: 0 14px 30px rgba(46,123,255,.18);
      background: rgba(46,123,255,.10);
    }
    .selectableLine.selected::after{
      opacity:1;
    }
    .selectableLine .top,
    .selectableLine .whiteBagBanner{ position:relative; z-index:1; }
    .magGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 1180px){
      .magGrid{ grid-template-columns: 0.85fr 1.15fr; align-items:start; }
    }
    .magBox{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.02);
    }
    .magTitle{
      font-weight: 900;
      font-size: 15px;
      margin: 0 0 8px;
      letter-spacing: .02em;
    }
    .magList{ display:flex; flex-direction:column; gap:8px; }
    .magRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding:8px 10px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.05);
    }
    .magRow .l{ font-weight:900; font-size:13px; color:rgba(0,0,0,.9); flex:1; min-width:0; }
    .magRow .s{ color:var(--muted); font-size:12px; margin-top:4px; }
    .magRow .v{ font-weight:1000; letter-spacing:.01em; white-space:nowrap; }
    .magPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      font-size:12px;
      font-weight:900;
      color:rgba(0,0,0,.82);
    }
    .magBadge{ background: rgba(0,0,0,.06); border-radius:12px; padding:3px 8px; font-size:11px; font-weight:900; }
    .signaturePad{ touch-action: none; background:#fff; }

    .blur {
      filter: blur(10px);
      opacity: .85;
      transition: filter .12s ease, opacity .12s ease;
    }
    .blur.reveal {
      filter: blur(0px);
      opacity: 1;
    }

    /* Modals */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      padding-bottom: calc(14px + var(--safe-bot));
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .18s cubic-bezier(.22,.61,.36,1), visibility 0s linear .18s;
    }
    .overlay.show { opacity:1; visibility:visible; pointer-events:auto; transition-delay: 0s; }
    .sheet {
      width: min(980px, 100%);
      max-width: 100vw;
      max-height: 88vh;
      background: #ffffff;
      border: 1px solid var(--stroke);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-sizing: border-box;
      transform: translateY(10px) scale(.995);
      opacity: 0;
      transition: transform .22s cubic-bezier(.22,.61,.36,1), opacity .2s ease;
    }
    .overlay.show .sheet{
      transform: translateY(0) scale(1);
      opacity:1;
    }
    @media (prefers-reduced-motion: reduce){
      .overlay{ transition:none; }
      .sheet{ transition:none; transform:none !important; }
      .pressCard, .warnBanner, .alertBanner{ transition:none; }
    }
    .sheet .shd {
      padding: 14px 14px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
    }
    .sheet .shd .h {
      font-weight: 1000;
      letter-spacing: .02em;
      font-size: 14px;
      text-transform: uppercase;
      opacity: .9;
    }
    .sheet .shd .titleCol{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
      min-width:0;
      flex:1;
    }
    .selCounter{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(46,123,255,.28);
      background: rgba(46,123,255,.08);
      color:#0a3a7d;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    .selCounter strong{ font-size:13px; }
    .sheet .shd .x {
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.86);
      font-size: 18px;
      font-weight: 900;
      cursor:pointer;
    }
    .sheet .sbd {
      padding: 14px;
      overflow:auto;
    }
    @media (max-width: 720px){
      .sheet{border-radius: 18px; max-height: 90vh;}
      .sheet .sbd{padding-bottom: calc(18px + var(--safe-bot));}
    }
    .stepTitle {
      font-size: 18px;
      font-weight: 950;
      margin: 0 0 10px;
    }
    .muted {
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .radioRow {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .radio {
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.03);
      cursor:pointer;
      font-weight: 900;
    }
    .radio input { accent-color: var(--accent); width:18px; height:18px; }
    .divider {
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bot));
      z-index: 10050;
      width: min(520px, calc(100% - 24px - env(safe-area-inset-left) - env(safe-area-inset-right)));
      max-width: calc(100% - 24px - env(safe-area-inset-left) - env(safe-area-inset-right));
      border: 1px solid var(--stroke);
      background: #ffffff;
      color: rgba(0,0,0,.90);
      border-radius: 18px;
      padding: 12px 14px;
      padding-left: max(14px, env(safe-area-inset-left));
      padding-right: max(14px, env(safe-area-inset-right));
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      display:none;
    }
    .toast.show { display:block; }
    .toast .tt { font-weight: 950; }
    .toast .tb { margin-top: 6px; color: var(--muted); font-weight: 700; font-size: 13px; }
    #toastTitle {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Startup legal screen */
    #startup {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
      background: radial-gradient(1000px 700px at 50% -20%, rgba(46,123,255,.35), rgba(46,123,255,0) 55%),
                  linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.45));
      backdrop-filter: blur(14px);
    }
    .startupCard {
      width: min(780px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .startupCard .a {
      padding: 18px 18px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: rgba(0,0,0,.90);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .startupCard .b {
      padding: 18px;
      color: rgba(0,0,0,.88);
      font-weight: 750;
      line-height: 1.35;
    }
    .bootBar {
      height: 10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      margin-top: 14px;
    }
    .bootBar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(46,123,255,1), rgba(32,201,151,1));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .bootMsg {
      margin-top: 10px;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }

    /* Prevent accidental iOS text zoom */
    input, textarea, select, button { font-size: 16px; }

    textarea {
      width:100%;
      min-height: 120px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.04);
      color: rgba(0,0,0,.90);
      padding: 12px;
      font-weight: 700;
      resize: vertical;
    }
  
    /* Auth gate */
    #authGate{
      position: fixed;
      inset: 0;
      z-index: 10020;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
    }
    #authGate.show{ display:flex; }
    .authCard{
      width: min(720px, 100%);
      border-radius: 26px;
      border: 1px solid var(--stroke);
      background: #ffffff;
      box-shadow: 0 24px 70px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .authCard .ah{
      padding: 16px 16px 12px;
      font-weight: 1000;
      letter-spacing: .02em;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .authCard .ab{
      padding: 16px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(0,0,0,.62);
      text-transform: uppercase;
      letter-spacing:.06em;
    }
    .field input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.02);
      font-size: 16px;
      font-weight: 800;
      outline: none;
    }
    .authRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .linkBtn{
      border:none;
      background: transparent;
      color: var(--accent);
      font-weight: 900;
      cursor:pointer;
      padding: 0;
    }
    body.noscroll{ overflow:hidden; }

  
    /* Completed orders */
    .completedItem{ cursor:pointer; }
    .completedItem:hover{ background: rgba(0,0,0,.05); }
    .completedMeta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; color: var(--muted); font-size:12px; }
    .kv{ font-variant-numeric: tabular-nums; }


  /* --- Push pill --- */
  .pillBtn{cursor:pointer;border:none}
  .pillBtn:active{transform:scale(.98)}
  .pillBtn:focus{outline:2px solid rgba(255,255,255,.18); outline-offset:2px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Top system banners */
  .topBanner{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 80;
    display:none;
    align-items:center;
    gap:10px;
    padding: calc(10px + var(--safe-top)) 14px 12px;
    background: linear-gradient(180deg, rgba(255, 59, 48, .18), rgba(255, 59, 48, .08));
    border-bottom: 1px solid rgba(255,59,48,.28);
    box-shadow: 0 16px 30px rgba(0,0,0,.18);
  }
  .topBanner.show{ display:flex; }
  .topBanner .icon{ font-size: 20px; }
  .topBanner .body{ flex:1; min-width:0; }
  .topBanner .title{ font-weight: 900; font-size: 16px; }
  .topBanner .sub{ font-size: 13px; color: var(--muted); font-weight: 800; }
  .topBanner .closeBtn{
    border:none;
    border-radius: 14px;
    padding: 10px 12px;
    background: rgba(0,0,0,.06);
    font-weight: 900;
    cursor:pointer;
  }

</style>

  <link rel="manifest" href="/tabellone-produzione-live/manifest.webmanifest">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Hub Polveri">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
</head>
<body>
  <!-- Startup legal + boot -->
  <div id="startup">
    <div class="startupCard">
      <div class="a">Avviso aziendale</div>
      <div class="b">
        I dati visualizzati in questo sistema sono <b>riservati</b> e destinati esclusivamente all’uso interno.<br/>
        È vietata qualsiasi condivisione o diffusione non autorizzata al di fuori dell’azienda.<br/>
        Eventuali violazioni potranno comportare <b>provvedimenti disciplinari</b> e <b>azioni legali</b> secondo quanto previsto dalle normative vigenti.
        <div class="bootBar"><div id="bootFill"></div></div>
        <div id="bootMsg" class="bootMsg">BOOT: inizializzazione…</div>
      </div>
    </div>
  </div>

  
  <!-- Auth gate -->
  <div id="authGate" role="dialog" aria-modal="true">
    <div class="authCard">
      <div class="ah">Accesso operatore</div>
      <div class="ab" id="authBody"></div>
    </div>
  </div>


  <!-- Banner annullamento -->
  <div id="cancelBanner" class="topBanner" role="status" aria-live="polite">
    <div class="icon">⛔️</div>
    <div class="body">
      <div class="title">Produzione annullata</div>
      <div class="sub" id="cancelBannerSub">L’ordine è stato annullato.</div>
    </div>
    <button class="closeBtn" id="cancelBannerClose" type="button">Chiudi</button>
  </div>

  <div class="wrap">
    <header>
      <div class="titleWrap">
        <div class="title" aria-label="Hub linea polveri">
          <span class="titleLine">Hub linea</span>
          <span class="titleLine accent">polveri</span>
        </div>
        <div class="subtitle">Benvenuto operatore <b id="hdrUser">—</b>, questo mese hai prodotto <span id="hdrMonthKg">—</span> kg e hai concluso <span id="hdrMonthOrders">—</span> ordini.</div>
      </div>
      <div class="statusRow">
        <div class="pill" id="pillOnline"><span class="dot" id="dotOnline"></span><span id="txtOnline">Stato: avvio</span></div>
        <div class="pill"><span class="dot ok"></span><span id="txtXmlTime">Ordini: in sincronizzazione…</span></div>
      
        <button class="pill pillBtn" id="pillPush" type="button" title="Centro notifiche e push">
          <span class="dot" id="dotPush"></span>
          <span id="txtPush">Notifiche</span>
          <span class="pillBadge" id="pillPushBadge">0</span>
        </button>
      </div>
    </header>
    <div class="grid">
      <!-- Left column -->
      <div class="card" id="opsCard">
        <div class="hd">
          <h2>Operatività</h2>
          <div class="badge" id="badgeCounts">—</div>
        </div>
        <div class="bd">
          <button class="primaryBtn" id="btnGoProd">VAI IN PRODUZIONE</button>

          <div style="height:12px"></div>

          <div id="partialBanner" class="warnBanner pressCard fadeCard" style="display:none;" role="button" tabindex="0" aria-label="Ordini parzialmente conclusi">
            <div class="icon">⚠️</div>
            <div class="txt">
              <div class="t" id="partialBannerTitle">Ci sono ordini parzialmente conclusi in corso</div>
              <div class="s" id="partialBannerSub">Apri per vedere solo gli ordini parziali e concludere.</div>
            </div>
            <div class="badge">Apri</div>
          </div>

          <div style="height:12px"></div>

          <div id="prodStrip" class="bigStrip" style="display:none;">
            <div class="label">Produzione in corso</div>
            <div class="marquee"><span id="prodMarquee">—</span></div>
            <div class="meta">
              <div><b id="prodCount">0</b> attività attive</div>
              <div>Tap per dettagli e conclusione</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="kv">
            <div class="k">
              <div class="t">Righe polveri</div>
              <div class="v" id="kPowderLines">—</div>
            </div>
            <div class="k">
              <div class="t">Kg totali</div>
              <div class="v" id="kPowderKg">—</div>
              <div class="muted" id="kPowderMeta" style="margin-top:4px; font-size:12px;">Calcolato su 0 righe visibili</div> <!-- // UI-FIX: kg-totali -->
            </div>
            <div class="k">
              <div class="t">Etichette (stima)</div>
              <div class="v" id="kPowderLabels">—</div>
              <div class="muted" id="kPowderLabelsMeta" style="margin-top:4px; font-size:12px;">Pack riconosciuto: nessuno</div>
            </div>
          </div>

          <div style="height:12px"></div>

        </div>
      </div>

      <!-- Right column -->
      <div class="card">
        <div class="hd">
          <h2>Home</h2>
        </div>
        <div class="bd">
          <div class="k" style="margin-bottom:12px;">
            <div class="t">Fatturato lordo</div>
            <div class="v blur" id="fatValue">€ —</div>
            <div class="muted" id="fatSubtitle" style="margin-top:6px;">Desktop: visibile. Mobile: tocca per vedere.</div>
          </div>

          <div class="row2" style="margin-bottom:12px;">
            <button class="btn ghost" id="btnCallMatteo">Chiama Matteo</button>
            <button class="btn ghost" id="btnOpenStats">Statistiche</button>
          </div>

          <div class="card" id="completedCard">
            <div class="hd">
              <h2>Ordini conclusi</h2>
              <div class="badge" id="completedBadge">0</div>
            </div>
            <div class="bd">
              <div class="list" id="completedList"></div>
              <div class="muted" id="completedEmpty" style="display:none;">Nessuna produzione conclusa registrata.</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div id="statsCardAnchor" style="display:none;" aria-hidden="true"></div>
          <div class="card" id="statsCard" style="box-shadow:none; background: rgba(0,0,0,.02); border-radius: 18px;">
            <div class="hd">
              <h2>Statistiche produzione</h2>
              <div class="badge" id="statsBadge">—</div>
            </div>
            <div class="bd">
              <div class="muted">Classifica live (kg totali e velocità media). Disponibile su desktop.</div>
              <div style="height:10px"></div>
              <div id="statsList" class="list"></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" id="warehouseCard" style="display:none;">
            <div class="hd">
              <h2>Gestione magazzino</h2>
              <div class="badge" id="warehouseBadge">—</div>
            </div>
            <div class="bd" id="warehouseBody"></div>
          </div>

<div class="card" style="box-shadow:none; background: rgba(0,0,0,.02); border-radius: 18px;">
            <div class="hd">
              <h2>Segnala un problema</h2>
            </div>
            <div class="bd">
              <div class="muted">Usa questo riquadro per segnalare: macchina non funzionante, materiale/prodotto non disponibile, o anomalie in linea. La segnalazione viene registrata internamente.</div>
              <div style="height:10px"></div>
              <textarea id="issueText" placeholder="Esempio: 'Macchina dosatrice non parte' oppure 'Prodotto non disponibile in magazzino'. Aggiungi ordine/cliente se utile…"></textarea>
              <div style="height:10px"></div>
              <button class="btn good" id="btnSendIssue" style="width:100%;">Invia segnalazione</button>
            </div>
          </div>

          <div style="height:8px"></div>
          <div class="muted" style="text-align:center;">© General Copper SRL · Uso interno</div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Notifications modal -->
  <div id="notifModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="titleCol">
          <div class="h">Centro notifiche</div>
          <div class="muted" id="notifSub">Push, messaggi interni e registro.</div>
        </div>
        <button class="x" id="notifClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="notifBody">
        <div class="stepTitle">Inbox</div>
        <div class="muted" id="notifStatus">Caricamento notifiche…</div>
        <div style="height:8px"></div>
        <div id="notifUnavailable" class="alertBanner" style="display:none;">
          <div class="label">Centro notifiche non disponibile (permessi o connessione).</div>
          <div class="hint">Nessun blocco: l’app continua a funzionare.</div>
        </div>
        <div id="notifList" class="notifList"></div>
        <div class="notifEmpty" id="notifEmpty" style="display:none;">Nessuna notifica disponibile.</div>
        <div style="height:12px"></div>
        <div class="row2">
          <button class="btn ghost" id="btnNotifCompleted" style="width:100%;">Registro conclusi</button>
          <button class="btn" id="btnTogglePush" style="width:100%;">Gestisci push</button>
        </div>
        <div style="height:12px"></div>
        <div id="notifAdminBox" style="display:none;">
          <div class="stepTitle">Invia notifica (admin)</div>
          <div class="muted">Messaggio a tutti gli operatori linea polveri (push o inbox). Richiede permessi Firestore.</div>
          <div style="height:8px"></div>
          <input type="text" id="notifTitle" placeholder="Titolo (es. Aggiornamento impianto)" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); font-weight:900;"/>
          <div style="height:8px"></div>
          <textarea id="notifBodyInput" placeholder="Testo notifica" style="width:100%; padding:12px; border-radius:14px; border:1px solid var(--stroke); min-height:90px; font-weight:800;"></textarea>
          <div style="height:8px"></div>
          <button class="btn good" id="btnSendNotif" style="width:100%;">Invia a tutti</button>
          <div class="muted" id="notifAdminFeedback" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- History detail modal -->
  <div id="histModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div>
          <div class="h" id="histTitle">Dettaglio produzione</div>
          <div class="sub" id="histSub">—</div>
        </div>
        <button class="x" id="histClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="histBody"></div>
    </div>
  </div>

<!-- Toast overlay -->
  <div id="toast" class="toast">
    <div class="tt" id="toastTitle">Attenzione</div>
    <div class="tb" id="toastBody">—</div>
  </div>

  <!-- Production modal -->
  <div id="prodModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="titleCol">
          <div class="h" id="prodModalTitle">Produzione</div>
          <div class="selCounter" id="selectionCounter" style="display:none;">0 righe selezionate</div>
        </div>
        <button class="x" id="prodModalClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="prodModalBody"></div>
    </div>
  </div>

  <!-- Running productions modal -->
  <div id="runningModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Produzione in corso</div>
        <button class="x" id="runningClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="runningBody"></div>
    </div>
  </div>

  <!-- Partial orders modal -->
  <div id="partialModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Ordini parzialmente conclusi</div>
        <button class="x" id="partialClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd" id="partialBody"></div>
    </div>
  </div>

  
  <!-- Signature modal -->
  <div id="signModal" class="overlay" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="shd">
        <div class="h">Conclusione · Firma</div>
        <button class="x" id="signClose" aria-label="Chiudi">×</button>
      </div>
      <div class="sbd">
        <div class="stepTitle">Dichiarazione e firma</div>
        <div class="muted" id="signContext">—</div>
        <div style="height:10px"></div>
        <div class="muted" style="font-weight:800;">
          Dichiarazione: <b>dichiaro</b> che la produzione è stata eseguita secondo le procedure aziendali e i controlli previsti.
        </div>
        <div style="height:10px"></div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input id="signCheck" type="checkbox" style="width:20px;height:20px; accent-color: var(--good);" />
          <label for="signCheck" style="font-weight:900;">Confermo la dichiarazione</label>
        </div>
        <div style="height:12px"></div>
        <div style="border:1px solid var(--stroke); border-radius:18px; overflow:hidden; background: rgba(0,0,0,.02);">
          <canvas id="signCanvas" class="signaturePad" style="width:100%; height:220px; display:block;"></canvas>
        </div>
        <div style="height:10px"></div>
        <div class="row2">
          <button class="btn" id="signClear">Pulisci firma</button>
          <button class="btn good" id="signOk">CONCLUDI</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Reason modal -->

<script type="module">
  // ===============================
  // CONFIG
  // ===============================
  const XML_PROXY_CFG = {
      proxyUrl: "https://script.google.com/macros/s/AKfycbzQEYEOPDlhVx6bS-Se8-L21AUtW1RbjsJyjIMvm_7nNoCj0R2DBa7LcsAE8xccxdcz/exec",
      cacheKey: "EASYFATT_XML_CACHE_V1"
    };
  const ADMIN_PW = "12345";
  const FIREBASE_IMPORT_APP = "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  const FIREBASE_IMPORT_FS  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  const FIREBASE_IMPORT_AUTH = "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  const FIREBASE_IMPORT_MSG  = "https://www.gstatic.com/firebasejs/12.7.0/firebase-messaging.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };
  // Web Push (FCM): incolla qui la *Public key* (VAPID) da Firebase Console → Project settings → Cloud Messaging → Web Push certificates
  const FCM_VAPID_KEY = "PASTE_PUBLIC_VAPID_KEY_HERE";

  // Email su segnalazione problemi (richiede Firebase Extension: firestore-send-email)
  const ISSUE_EMAIL_ENABLED = false; // metti true quando l'estensione è installata
  const ISSUE_EMAIL_TO = "matteo@generalcoppersrl.com";
  const FAT_VALUE_KEY = "FATTURATO_EUR_CACHE";
  const NOTIF_READ_KEY = "POLVERI_NOTIF_READ_V1";
  const NOTIF_COLLECTION = "powderNotifications";
  const NOTIF_LIMIT = 40;


  const OPERATORS = ["Hassan","Ahmed","Muhammed","Mustapha","Youssef"];
  const NON_PERTINENT_CODES = new Set(["mast250viri","mast500viri","codmast250viri","codmast500viri"]);
  // CODEX: Distinta base magazzino (default per sacchi 5kg/1kg, valida per tutti i prodotti)
  const MAGAZZINO_DEFAULT_PACKS = {
    5: {
      prodottoKgPerBag: 5,
      bobine: { "Bobina blu f830": { perBag: 20, unit:"g" } },
      etichettePerBag: 1,
      scatole: { "Scatola americana | 20 kg": 0.25 },
      divisori: { "Divisorio Z": 0.25 },
      altri: {}
    },
    1: {
      prodottoKgPerBag: 1,
      bobine: { "Bobina blu f480": { perBag: 10, unit:"g" } },
      etichettePerBag: 1,
      scatole: { "Scatola americana | 20 kg": 0.05 },
      divisori: { "Divisorio Croce texo": 0.05 },
      altri: {}
    }
  };
  const MAGAZZINO_BOM = { // CODEX: Distinta base estendibile per calcolo magazzino (desktop)
    defaultByPackKg: MAGAZZINO_DEFAULT_PACKS, // CODEX: fallback per qualsiasi prodotto (match per formato sacco)
    byCode: {
      // Esempio: "CODICE": { packs: { 5: { prodottoKgPerBag:5, bobine:{ "tipo":{perBag:20, unit:"g"} }, etichettePerBag:1, scatole:{ "model":0.2 }, divisori:{ "tipo":0.1 }, altri:{ "nome":0.1 } } } }
    },
    byName: {
      // Nome normalizzato senza peso → packKg → componenti per singolo sacco/confezione
      "ossicloruro di rame 50%": { packs: MAGAZZINO_DEFAULT_PACKS }
    }
  };

  // UI-FIX: anticache
  try{
    if("serviceWorker" in navigator){
      navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())).catch(()=>{});
    }
  }catch(_e){}

  // ===============================
  // STATE
  // ===============================
  const state = {
    lastAuthErrorMsg: "",

    xmlModifiedTime: null,
    lastFetchAt: null,
    docs: [],
    fatturatoLordo: null, // CODEX: cache fatturato lordo lato client
    powderOrders: [],
    activeProductions: [],
    history: [],
    historyReady: false,
    user: null,
    operator: null,
    selectedLines: new Map(), // CODEX: selezione multi-ordine persistente
    prodModalOpenedAt: 0,
    startedThisSession: false,
    prodModalTouched: false,
    firebase: {
      ok: false,
      db: null,
      api: null,
    },
    notifications: { inbox: [], ready:false, unavailable:false, error:"" },
    notifUnsub: null,
    push: { supported:false, permission:'default', token:'', enabled:false },
  };

  // ===============================
  // UTILS
  // ===============================
  const $ = (id)=>document.getElementById(id);

  function nowIso(){ return new Date().toISOString(); }
  function fmtTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  function fmtDateTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    const dd = String(dt.getDate()).padStart(2,"0");
    const mo = String(dt.getMonth()+1).padStart(2,"0");
    const yy = dt.getFullYear();
    return `${dd}/${mo}/${yy} ${fmtTime(dt)}`;
  }
  function ensureSelectionState(){
    if(!(state.selectedLines instanceof Map)) state.selectedLines = new Map();
    return state.selectedLines;
  }
  function makeSelectionKey(order, line){
    const on = order?.orderNo || order?.number || "";
    const cust = order?.customer || "";
    const lk = line?.lineKey || line?.lineID || line?.id || "";
    return `${on}__${cust}__${lk}`;
  }
  function selectionCount(){
    return ensureSelectionState().size;
  }
  function updateSelectionCounter(){
    const counter = $("selectionCounter");
    if(!counter) return;
    const n = selectionCount();
    if(n>0){
      counter.style.display = "inline-flex";
      counter.innerHTML = `<strong>${n}</strong> righe selezionate`;
    } else {
      counter.style.display = "none";
    }
  }
  function clearSelectionForOrder(order){
    const sel = ensureSelectionState();
    const keys = Array.from(sel.keys());
    for(const k of keys){
      const v = sel.get(k);
      if(v && String(v.orderNo||v.number||"") === String(order?.orderNo||order?.number||"") && String(v.customer||"") === String(order?.customer||"")){
        sel.delete(k);
      }
    }
  }
  function pruneSelectionAgainstOrders(baseOrders){
    const sel = ensureSelectionState();
    if(!sel.size) return;
    const allowed = new Set();
    for(const o of (baseOrders||[])){
      for(const l of (o.lines||[])){
        if(!l || l.status==="active") continue;
        allowed.add(makeSelectionKey(o, l));
      }
    }
    for(const k of Array.from(sel.keys())){
      if(!allowed.has(k)) sel.delete(k);
    }
    updateSelectionCounter();
  }
  function selectedEntriesForOrder(order){
    const out = [];
    const on = String(order?.orderNo||order?.number||"");
    const cust = String(order?.customer||"");
    for(const v of ensureSelectionState().values()){
      if(String(v.orderNo||v.number||"")===on && String(v.customer||"")===cust) out.push(v);
    }
    return out;
  }
  function groupSelectionByOrder(){
    const groups = new Map();
    for(const v of ensureSelectionState().values()){
      const on = String(v.orderNo||v.number||"");
      const cust = String(v.customer||"");
      const key = `${on}__${cust}`;
      if(!groups.has(key)) groups.set(key, { orderNo:on, customer:cust, lines:[] });
      groups.get(key).lines.push(v);
    }
    return groups;
  }
  function norm(s){
    return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
  }
  function safeText(node){
    return (node && node.textContent ? node.textContent : "").trim();
  }
  function parseCurrencyValue(raw){
    if(Number.isFinite(raw)) return Number(raw);
    const strRaw = raw==null ? "" : String(raw).trim();
    if(!strRaw) return null;
    const compact = strRaw.replace(/\s+/g,"");
    const itPattern = /^-?\d{1,3}(?:\.\d{3})*(?:,\d+)?$/;
    const commaDecimal = /^-?\d+(?:,\d+)?$/;
    let normalized = compact;
    if(itPattern.test(compact) || commaDecimal.test(compact)){
      normalized = compact.replace(/\./g,"").replace(",", ".");
    } else {
      normalized = compact.replace(/,/g,"");
    }
    const n = Number(normalized);
    return Number.isFinite(n) ? n : null;
  }
  function parseItNumber(raw){ // UI-FIX: kg-totali
    const s = (raw==null ? "" : String(raw)).replace(/\./g,"").replace(",",".").replace(/\s+/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function formatQtyWithKg(qty, um="kg"){
    const qtyTxt = `${qty ?? 0}`;
    const hasKg = /\bkg\b/i.test(um||"");
    const cleanUm = (um||"").trim();
    if(hasKg) return `${qtyTxt} kg`;
    return cleanUm ? `${qtyTxt} ${cleanUm} · kg` : `${qtyTxt} kg`;
  }
  function isMobile(){
    return window.matchMedia("(max-width: 900px)").matches;
  }
  function fetchWithTimeout(url, ms, opts={}){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), ms);
    return fetch(url, {...opts, signal: ctrl.signal}).finally(()=>clearTimeout(t));
  }
  function showToast(title, body, ms=3800){
    $("toastTitle").textContent = title;
    $("toastBody").textContent = body;
    $("toast").classList.add("show");
    setTimeout(()=>$("toast").classList.remove("show"), ms);
  }
  function setBannerOffset(px){
    document.documentElement.style.setProperty("--banner-offset", `${px || 0}px`);
  }
  // Banner annullamento: aggiorna offset per safe-area + padding contenuti
  function showCancelBanner(sub="L’ordine è stato annullato."){
    const b = $("cancelBanner");
    const txt = $("cancelBannerSub");
    if(!b || !txt) return;
    txt.textContent = sub;
    b.classList.add("show");
    requestAnimationFrame(()=>{
      const h = b.getBoundingClientRect().height || 0;
      setBannerOffset(h);
    });
  }
  function hideCancelBanner(){
    const b = $("cancelBanner");
    if(!b) return;
    b.classList.remove("show");
    setBannerOffset(0);
  }

  // ===============================
  // BODY LOCK (no background scroll)
  // ===============================
  let _scrollY = 0;
  function lockBody(){
    _scrollY = window.scrollY || 0;
    document.body.classList.add("noscroll");
    document.body.style.top = `-${_scrollY}px`;
    document.body.style.position = "fixed";
    document.body.style.width = "100%";
  }
  function unlockBody(){
    document.body.classList.remove("noscroll");
    document.body.style.position = "";
    document.body.style.top = "";
    document.body.style.width = "";
    window.scrollTo(0, _scrollY);
  }

  // ===============================
  // BOOT (smooth + fast)
  // ===============================
  const bootFill = $("bootFill");
  const bootMsg = $("bootMsg");
  let bootP = 0;
  function bootSet(p, msg){
    bootP = Math.max(bootP, Math.min(100, p));
    bootFill.style.width = bootP.toFixed(0)+"%";
    if(msg) bootMsg.textContent = msg;
  }
  async function boot(){
    // Boot super smooth: UI sempre pronta, sync in parallelo (mai blocco al 90%)
    bootSet(10, "AVVIO: inizializzazione interfaccia…");
    await new Promise(r=>setTimeout(r, 220));

    bootSet(25, "DOWNLOAD: ordini in corso…");
    const ordersPromise = syncOrders(true);

    bootSet(45, "SYNC: produzione in corso…");
    const livePromise = initLiveSync();

    // Non restare appeso: dopo 3.2s entri comunque nell’hub (sync continua)
    await Promise.race([ordersPromise, new Promise(r=>setTimeout(r, 3200))]);

    bootSet(80, "OTTIMIZZAZIONE: finalizzazione…");
    await Promise.race([livePromise, new Promise(r=>setTimeout(r, 1200))]);

    bootSet(100, "OK: pronto");
    await new Promise(r=>setTimeout(r, 140));
    $("startup").style.display = "none";

    showToast(
      "Operatività",
      "Per avviare un ordine: VAI IN PRODUZIONE → scegli operatore → seleziona righe → INIZIA PRODUZIONE."
    );
  }

  // ===============================
  // XML -> Orders (snello)
  // ===============================
  function detectPackKg(desc){
    const s = norm(desc||"").replace(/,/g,".");
    if(!s) return null;
    const kgAhead = s.match(/(\d+(?:\.\d+)?)[x\-\s]*kg\b/);
    if(kgAhead){
      const v = parseFloat(kgAhead[1]);
      if(Number.isFinite(v) && v>0) return v;
    }
    const kgAfter = s.match(/\bkg[x\-\s]*(\d+(?:\.\d+)?)/);
    if(kgAfter){
      const v = parseFloat(kgAfter[1]);
      if(Number.isFinite(v) && v>0) return v;
    }
    const kgNear = s.match(/(\d+(?:\.\d+)?)[\s]*(?:kg|chilogrammi)\b/);
    if(kgNear){
      const v = parseFloat(kgNear[1]);
      if(Number.isFinite(v) && v>0) return v;
    }
    const gMatch = s.match(/(\d+(?:\.\d+)?)[x\-\s]*(?:gr|g|grammi)\b/);
    if(gMatch){
      const v = parseFloat(gMatch[1]);
      if(Number.isFinite(v) && v>0) return v/1000;
    }
    return null;
  }
  function resolveQtyKg(ctx={}){ // CODEX: sorgente di verità qty -> kg
    const qty = parseItNumber(ctx.qty ?? ctx.quantity);
    if(!Number.isFinite(qty) || qty<=0) return 0;

    const umCandidates = [ctx.um, ctx.uom, ctx.unitaMisura, ctx.unit, ctx.measure];
    const rawUm = umCandidates.find(u => u!=null && String(u).trim()!=="") || "";
    const upperUm = rawUm.toString().toUpperCase().replace(/\./g,"");
    const hasPieces = /\b(PZ|PZS|PCS?|PCE|PEZ|PEZZ[IO]?|NR|SAC|SACCO|SACCHI|SACCHETTO|SACCHETTI|SACCH)\b/.test(upperUm);
    const hasKg = /\bKG\b/.test(upperUm);
    const isKg = hasKg && !hasPieces;
    const isPieces = hasPieces;

    let packKg = ctx.packKg;
    if(!(Number.isFinite(packKg) && packKg>0)){
      const descTxt = ctx.desc || ctx.description || "";
      const detected = detectPackKg(descTxt);
      if(Number.isFinite(detected) && detected>0){
        packKg = detected;
      } else if(rawUm || descTxt){
        const combo = detectPackKg(`${descTxt} ${rawUm}`.trim());
        if(Number.isFinite(combo) && combo>0) packKg = combo;
      }
    }
    const packVal = Number(packKg);
    const hasPack = Number.isFinite(packVal) && packVal>0;

    if(isKg) return qty;
    if(isPieces){
      if(hasPack) return qty * packVal;
      return qty;
    }
    // Anti-inflazione: se ambiguo non moltiplicare
    return qty;
  }
  window.__resolveQtyKg = resolveQtyKg;
  window.__detectPackKg = detectPackKg;
  function detectAlertLine(desc){
    const s = norm(desc);
    if(!s) return null;
    if(!/\b(sacco|bobina)\b/.test(s)) return null;
    const colorMatch = s.match(/\b(blu|azzur\w+|ross\w+|bianc\w+|ner\w+|verd\w+|giall\w+)\b/);
    if(!colorMatch) return null;
    if(/\b(rame|zolfo|caolino|ossicloruro|poltiglia|zeolite)\b/.test(s)) return null;
    const rawColor = colorMatch[1];
    const color = rawColor.includes("azzur")||rawColor.includes("blu") ? "blue"
      : rawColor.includes("ross") ? "red"
      : rawColor.includes("bianc") ? "white"
      : rawColor.includes("ner") ? "black"
      : rawColor.includes("verd") ? "green"
      : rawColor.includes("giall") ? "yellow"
      : "other";
    return { label: (desc||"").trim() || "Avviso", color };
  }
  function machineHintFromLines(lines){
    const packs = [];
    for(const l of (lines||[])){
      if(l.alertInfo) continue;
      const direct = Number(l.packKg);
      const fallback = detectPackKg(l.desc || "");
      const val = Number.isFinite(direct) && direct>0 ? direct : (Number.isFinite(fallback) && fallback>0 ? fallback : null);
      if(val!=null) packs.push(val);
    }
    if(!packs.length) return "large";
    const maxPack = Math.max(...packs);
    if(maxPack >= 5) return "large";
    if(maxPack > 0) return "small";
    return "large";
  }
  function alertPalette(kind){
    switch(kind){
      case "blue": return { bg:"rgba(46,123,255,.12)", border:"rgba(46,123,255,.35)", color:"#0a3a7d" };
      case "red": return { bg:"rgba(255,59,48,.14)", border:"rgba(255,59,48,.4)", color:"#8a1f1a" };
      case "white": return { bg:"#ffffff", border:"rgba(0,0,0,.12)", color:"#1c1c1e", shadow:"0 1px 0 rgba(0,0,0,.04)" };
      case "black": return { bg:"#1c1c1e", border:"rgba(0,0,0,.6)", color:"#f5f5f7" };
      case "green": return { bg:"rgba(52,199,89,.14)", border:"rgba(52,199,89,.38)", color:"#0b5d2a" };
      case "yellow": return { bg:"rgba(255,204,0,.18)", border:"rgba(255,204,0,.36)", color:"#5c3b00" };
      default: return { bg:"rgba(0,0,0,.05)", border:"rgba(0,0,0,.12)", color:"#1c1c1e" };
    }
  }
  // CODEX: helper locale per banner sacchetto bianco
  function isWhiteBagRow(row){
    if(!row || typeof row !== "object") return false;
    for(const v of Object.values(row)){
      if(typeof v === "string" && v.includes("**")) return true;
    }
    return false;
  }
  function isNonProductionLine(row){
    return isWhiteBagRow(row);
  }
  // CODEX: riposizionamento Statistiche su desktop (colonna sinistra)
  const statsDesktopMq = window.matchMedia("(min-width: 1024px)");
  function relocateStatsCard(){
    const statsCard = $("statsCard");
    const anchor = $("statsCardAnchor");
    const opsCard = $("opsCard");
    if(!statsCard || !anchor || !opsCard) return;
    const wantsDesktopPlacement = statsDesktopMq.matches;
    const leftParent = opsCard.parentElement;
    if(wantsDesktopPlacement && leftParent){
      if(statsCard.parentElement !== leftParent){
        leftParent.insertBefore(statsCard, opsCard.nextSibling);
      }
    } else {
      const anchorParent = anchor.parentElement;
      if(anchorParent && statsCard.parentElement !== anchorParent){
        anchorParent.insertBefore(statsCard, anchor.nextSibling);
      }
    }
  }
  try{ statsDesktopMq.addEventListener("change", relocateStatsCard); }catch(_e){ try{ statsDesktopMq.addListener(relocateStatsCard); }catch(_e2){} }
  relocateStatsCard();
  // CODEX: render helper per banner sacchetto bianco
  function renderWhiteBagBanner(opts={}){
    const { selectable=true, checked=false, badgeText="" } = opts;
    const badgeLabel = badgeText || (checked ? "✓" : "Seleziona");
    const badgeHtml = selectable ? `<div class="badge">${badgeLabel}</div>` : "";
    return `
      <div class="whiteBagBanner" role="note" aria-label="⚠️ SACCHETTO BIANCO — Devi usare il sacchetto bianco">
        <div class="icon">⚠️</div>
        <div class="txt">
          <div class="t">SACCHETTO BIANCO</div>
          <div class="s">— Devi usare il sacchetto bianco</div>
        </div>
        ${badgeHtml}
      </div>
    `;
  }

  function isPowderLine(code, desc, um){
    const c = norm(code).replace(/\s+/g,"");
    if(c && NON_PERTINENT_CODES.has(c)) return false;

    const s = norm(desc);
    const u = norm(um);

    if(/\b(mastice)\b/.test(s)) return false;
    if(/\b(secchio|tanica|flacone|bottiglia|spray|trigger|pompa|nebul|olio|shampoo|deterg|repel|bio)\b/.test(s)) return false;
    if(/\b\d+(?:[\.,]\d+)?\s*(ml|l|lt)\b/.test(s)) return false;
    if(u === "l" || u === "lt" || u === "ml") return false;

    const packKg = detectPackKg(desc);
    const isBigBag = /\b(big\s*bag|bigbag)\b/.test(s);
    if(packKg != null && packKg > 10.0001 && !isBigBag) return false;
    if(isBigBag && packKg != null && packKg >= 100) return true;

    if(/\b(sacco|sacchetto|busta|bustina|barattolo)\b/.test(s)) return true;
    if(u === "kg" || u === "g") return true;
    if(/\b\d+(?:[\.,]\d+)?\s*(kg|g)\b/.test(s)) return true;

    if(/\b(ossicloruro|poltiglia|caolino|zeolite|zolfo|rame|solfato|idrossido|tribasico|diatomite|agroblumagic|corrobor)\b/.test(s)) return true;

    return false;
  }

  function materialOf(desc, code=""){
    const s = norm(desc);
    const c = norm(code);
    const has = (re) => re.test(s) || re.test(c);

    if(has(/\b(rame|copper|cupr|cu)\b/) || s.includes("bordolese") || s.includes("poltiglia")) return "rame";
    if(has(/\b(zolfo|sulfur|sulf)\b/)) return "zolfo";
    if(has(/\b(caolino|kaolin|caol)\b/)) return "caolino";
    if(has(/\b(zeolite|zeolit)\b/)) return "zeolite";
    if(has(/\b(diatomite|agroblumagic|corrobor)\b/)) return "corroborante";
    return "altro";
  }

  function cleanShort(desc){
    const s = (desc||"").toString();
    return s
      .replace(/\|\s*CONCIME.*$/i,"")
      .replace(/\|\s*CONSENTITO.*$/i,"")
      .replace(/\|\s*AMMESSO.*$/i,"")
      .replace(/\s{2,}/g," ")
      .trim();
  }
  function extractDocTotal(docNode){
    if(!docNode) return null;
    const tags = ["Total","TotalDoc","TotalDocument","TotalAmount","Amount","DocTotal","TotalWithTax","GrossTotal"];
    for(const tag of tags){
      const val = safeText(docNode.getElementsByTagName(tag)[0]);
      const num = parseCurrencyValue(val);
      if(num!=null) return num;
    }
    return null;
  }

  function parseEasyfattXml(xmlText){
    const outDocs = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(xmlText, "text/xml");
    const docs = Array.from(doc.getElementsByTagName("Document"));
    for(const d of docs){
      const customer = safeText(d.getElementsByTagName("CustomerName")[0]) || "Cliente";
      const number = safeText(d.getElementsByTagName("Number")[0]) || "";
      const date = safeText(d.getElementsByTagName("Date")[0]) || "";
      let conclusion = safeText(d.getElementsByTagName("ExpectedConclusion")[0])
        || safeText(d.getElementsByTagName("ExpectedDeliveryDate")[0])
        || safeText(d.getElementsByTagName("DeliveryDate")[0])
        || "";
      const totalDoc = extractDocTotal(d);

      const lines = [];
      const rows = Array.from(d.getElementsByTagName("Row"));
      for(let i=0;i<rows.length;i++){
        const r = rows[i];
        const code = safeText(r.getElementsByTagName("Code")[0]) || "";
        const desc = safeText(r.getElementsByTagName("Description")[0]) || safeText(r.getElementsByTagName("Name")[0]) || "";
        const um = safeText(r.getElementsByTagName("UM")[0]) || safeText(r.getElementsByTagName("Unit")[0]) || "";
        let qty = safeText(r.getElementsByTagName("Qty")[0]) || safeText(r.getElementsByTagName("Quantity")[0]) || "0";
        qty = parseFloat(qty.replace(",","."));
        if(!Number.isFinite(qty)) qty = 0;

        const alertInfo = detectAlertLine(desc); // CODEX: banner operativi sacchi/bobine
        const powder = alertInfo ? false : isPowderLine(code, desc, um);
        const packKg = detectPackKg(desc);
        const material = powder ? materialOf(desc, code) : "altro";

        const lineKg = (!powder || alertInfo) ? 0 : resolveQtyKg({ qty, um, packKg, desc });

        const lineKey = `${number}|${i}|${(norm(code)||norm(desc).slice(0,24))}`;

        lines.push({
          lineKey,
          code,
          desc: cleanShort(desc),
          um,
          qty,
          powder,
          packKg,
          lineKg,
          material,
          alertInfo,
        });
      }

      outDocs.push({ customer, number, date, conclusion, totalDoc, lines });
    }
    return outDocs;
  }

  async function syncOrders(isBoot=false){
    try {
      setOnlinePill("warn", "Stato: sincronizzazione…");
      if(isBoot) bootSet(40, "DOWNLOAD: ordini in corso…");

      const res = await fetchWithTimeout(XML_PROXY_CFG.proxyUrl, 12000, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if(j && j.ok === false) throw new Error(j.error || "Proxy: errore");
      const xmlText = j?.xml;
      if(!xmlText || typeof xmlText !== "string") throw new Error("XML mancante");

      state.xmlModifiedTime = j?.modifiedTime || null;
      state.lastFetchAt = Date.now();
      localStorage.setItem(XML_PROXY_CFG.cacheKey, JSON.stringify({ at: state.lastFetchAt, xml: xmlText, modifiedTime: state.xmlModifiedTime }));

      state.docs = parseEasyfattXml(xmlText);
      state.fatturatoLordo = computeFatturatoLordo(state.docs); // CODEX: calcolo fatturato lordo da XML

      const powderDocs = [];
      for(const d of state.docs){
        const pLines = d.lines.filter(x=>x.powder);
        if(!pLines.length) continue;
        const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
        const alertLines = d.lines.filter(x=>x.alertInfo);
        powderDocs.push({ customer: d.customer, number: d.number, orderNo: d.number, conclusion: d.conclusion, lines: pLines, alerts: alertLines, totalKg });
      }
      state.powderOrders = powderDocs;

      renderHome();
      setOnlinePill("ok", "Stato: online");
      if(isBoot) bootSet(62, "OK: ordini aggiornati");

    } catch(err) {
      console.warn("syncOrders failed", err);
      const cached = localStorage.getItem(XML_PROXY_CFG.cacheKey);
      if(cached){
        try {
          const c = JSON.parse(cached);
          state.lastFetchAt = c.at || null;
          state.xmlModifiedTime = c.modifiedTime || null;
          state.docs = parseEasyfattXml(c.xml||"");
          state.fatturatoLordo = computeFatturatoLordo(state.docs); // CODEX: calcolo fatturato da cache
          const powderDocs = [];
          for(const d of state.docs){
            const pLines = d.lines.filter(x=>x.powder);
            if(!pLines.length) continue;
            const totalKg = pLines.reduce((a,x)=>a+(x.lineKg||0),0);
            const alertLines = d.lines.filter(x=>x.alertInfo);
            powderDocs.push({ customer: d.customer, number: d.number, orderNo: d.number, conclusion: d.conclusion, lines: pLines, alerts: alertLines, totalKg });
          }
          state.powderOrders = powderDocs;
        } catch(_e) {}
      }
      renderHome();
      setOnlinePill("bad", "Stato: offline (cache)");
      if(isBoot) bootSet(55, "Connessione lenta… uso cache locale");
    }
  }

  function setOnlinePill(kind, text){
    const dot = $("dotOnline");
    dot.className = "dot";
    if(kind==="ok") dot.classList.add("ok");
    if(kind==="warn") dot.classList.add("warn");
    if(kind==="bad") dot.classList.add("bad");
    $("txtOnline").textContent = text;
  }
  let refreshInFlight = false;
  const debounceRefresh = (()=>{ let t=null; return (reason)=>{ clearTimeout(t); t=setTimeout(()=>triggerRefresh(reason), 180); }; })(); // CODEX: debounce auto-refresh (focus/visibility/pageshow)
  async function triggerRefresh(reason="manual"){
    // Refresh leggero per mobile (focus/pageshow/cta)
    if(refreshInFlight) return;
    refreshInFlight = true;
    try{
      await syncOrders(false);
      renderHome();
      if(reason==="focus" || reason==="pageshow") showToast("Aggiornato", "Dati ricaricati (riapertura).", 1800);
    }finally{
      refreshInFlight = false;
    }
  }

  
  
  function humanAuthErr(err){
    const code = (err && (err.code||err.message||"")).toString();
    const map = {
      "auth/unauthorized-domain": "Dominio non autorizzato. Verifica in Firebase: Authentication → Settings → Domini autorizzati.",
      "auth/operation-not-allowed": "Provider Google non abilitato. Verifica in Firebase: Authentication → Sign-in method.",
      "auth/popup-blocked": "Popup bloccato dal browser. Riprovo con reindirizzamento…",
      "auth/popup-closed-by-user": "Popup chiuso. Riprova.",
      "auth/cancelled-popup-request": "Richiesta annullata. Riprova.",
      "auth/network-request-failed": "Connessione instabile. Riprova tra qualche secondo.",
      "auth/invalid-api-key": "Config Firebase non valida (apiKey).",
      "auth/invalid-oauth-client-id": "Client OAuth non valido (Google). Controlla la configurazione Web SDK.",
      "auth/redirect-cancelled-by-user": "Accesso annullato. Riprova.",
      "auth/redirect-operation-pending": "Accesso già in corso. Attendi e riprova."
    };
    for (const k in map){ if(code.includes(k)) return map[k]; }
    return "Errore accesso. Controlla rete e riprova.";
  }

// ===============================
  // AUTH (Google / Email + allowlist email)
  // ===============================
  const USERS_COL = "powderUsers";
  // const ACCESS_COL removed (using USERS_COL allowlist)
function showAuthGate(){
    $("authGate").classList.add("show");
    lockBody();
  }
  function hideAuthGate(){
    $("authGate").classList.remove("show");
    unlockBody();
  }
  async function getAccessByEmail(email){
    const e = String(email||"").trim().toLowerCase();
    if(!e) return null;
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, e);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||null) : null;
  }

  function renderAuthDenied(email, reason=""){
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso non abilitato</div>
      <div class="muted">Questa email non risulta autorizzata ad accedere all’hub.</div>
      <div style="height:10px"></div>
      <div class="pill" style="display:inline-block;background:#fff3f2;color:#8a1f1a;border:1px solid #ffd1cd;">${escapeHtml(email||"")}</div>
      ${reason ? `<div style="height:10px"></div><div class="muted">${escapeHtml(reason)}</div>` : ``}
      <div style="height:14px"></div>
      <button id="btnLogout" class="btn bad" type="button">Esci</button>
      <div style="height:8px"></div>
      <div class="muted">Se serve, chiedi all’amministrazione di abilitare la tua email.</div>
    `;
    $("btnLogout").onclick = async () => {
      try{ await state.firebase.authApi.signOut(state.firebase.auth); }catch(e){}
      renderAuthLogin("");
    };
  }



  function renderAuthLogin(msg=""){
    showAuthGate();
    const b = $("authBody");
    b.innerHTML = `
      <div class="stepTitle">Accesso richiesto</div>
      <div class="muted">${msg || "Accedi per iniziare. Se la tua email non è autorizzata, contatta un amministratore."}</div>
      <div style="height:12px"></div>

      <button class="btn good" id="btnGoogle" style="width:100%;">Accedi con Google</button>
      <div style="height:10px"></div>

      <div class="divider"></div>
      <div class="stepTitle" style="font-size:16px; margin-top:0;">Oppure con email</div>

      <div class="authRow">
        <div class="field">
          <label>Nome</label>
          <input id="authName" autocomplete="given-name" placeholder="Nome" />
        </div>
        <div class="field">
          <label>Cognome</label>
          <input id="authSurname" autocomplete="family-name" placeholder="Cognome" />
        </div>
      </div>
      <div class="field">
        <label>Email</label>
        <input id="authEmail" type="email" autocomplete="email" placeholder="nome@azienda.it" />
      </div>
      <div class="field">
        <label>Password</label>
        <input id="authPass" type="password" autocomplete="current-password" placeholder="Password" />
      </div>

      <div class="row2">
        <button class="btn" id="btnEmailLogin">Accedi</button>
        <button class="btn ghost" id="btnEmailSignup">Crea account</button>
      </div>

      <div style="height:12px"></div>
      <div class="muted">Nota: la pagina resta sempre in italiano.</div>
    `;

    b.querySelector("#btnGoogle").onclick = async()=>{
      const authApi = state.firebase.authApi;
      const auth = state.firebase.auth;
      const prov = new authApi.GoogleAuthProvider();
      state.lastAuthErrorMsg = "";
      // Provo popup (più veloce). Se bloccato, fallback su redirect (più stabile su mobile).
      try{
        await authApi.signInWithPopup(auth, prov);
      }catch(err){
        console.warn("Google popup error", err);
        const msg = humanAuthErr(err);
        if((err && err.code==="auth/popup-blocked") || (err && err.code==="auth/operation-not-supported-in-this-environment")){
          showToast("Accesso", msg);
          try{
            await authApi.signInWithRedirect(auth, prov);
            return;
          }catch(err2){
            console.warn("Google redirect error", err2);
            state.lastAuthErrorMsg = humanAuthErr(err2);
            renderAuthLogin(state.lastAuthErrorMsg);
            return;
          }
        }
        state.lastAuthErrorMsg = msg;
        showToast("Accesso", msg);
      }
    };

    b.querySelector("#btnEmailLogin").onclick = async()=>{
      const email = b.querySelector("#authEmail").value.trim();
      const pass  = b.querySelector("#authPass").value;
      if(!email || !pass){
        showToast("Accesso", "Inserisci email e password.");
        return;
      }
      try{
        const authApi = state.firebase.authApi;
        await authApi.signInWithEmailAndPassword(state.firebase.auth, email, pass);
      }catch(err){
        console.warn(err);
        showToast("Accesso", "Credenziali non valide o account inesistente.");
      }
    };

    b.querySelector("#btnEmailSignup").onclick = async()=>{
      const name = b.querySelector("#authName").value.trim();
      const sur  = b.querySelector("#authSurname").value.trim();
      const email = b.querySelector("#authEmail").value.trim();
      const pass  = b.querySelector("#authPass").value;
      if(!name || !sur || !email || !pass){
        showToast("Registrazione", "Compila nome, cognome, email e password.");
        return;
      }
      try{
        const authApi = state.firebase.authApi;
        const cred = await authApi.createUserWithEmailAndPassword(state.firebase.auth, email, pass);
        await upsertUserProfile(cred.user, { fullName: `${name} ${sur}`, name, surname: sur, email });
      }catch(err){
        console.warn(err);
        showToast("Registrazione", "Impossibile creare l’account (email già usata o password debole).");
      }
    };
  }

  async function upsertUserProfile(user, fields){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, user.uid);
    await fs.setDoc(ref, { uid:user.uid, ...fields, updatedAt: nowIso(), createdAt: nowIso() }, { merge:true });
  }

  async function loadUserProfile(uid){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, USERS_COL, uid);
    const snap = await fs.getDoc(ref);
    return snap.exists() ? (snap.data()||{}) : null;
  }

  async function ensureAuthFlow(){
    // chiamata dopo init firebase
    const authApi = state.firebase.authApi;
    const auth = state.firebase.auth;

    // Gestisci redirect result (mostra errori)
    try{
      await authApi.getRedirectResult(auth);
    }catch(e){
      console.warn("getRedirectResult error", e);
      state.lastAuthErrorMsg = humanAuthErr(e);
    }
authApi.onAuthStateChanged(auth, async(user)=>{
      if(!user){
        state.historyReady = false;
        state.history = [];
        if(state.notifUnsub){
          try{ state.notifUnsub(); }catch(_e){}
          state.notifUnsub = null;
        }
        state.notifications = { inbox: [], ready:false, unavailable:false, error:"" };
        updateNotificationBadge();
        renderNotifCenter();
        renderHeaderKpis();
        state.user = null;
        state.operator = null;
        $("hdrUser").textContent = "—";
        const msg = state.lastAuthErrorMsg || "";
        state.lastAuthErrorMsg = "";
        renderAuthLogin(msg);
        return;
      }

      // Sessione valida 7 giorni per dispositivo (dopo scade e richiede nuovo accesso)
      try{
        const MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000;
        const KEY_TS = "GC_AUTH_TS";
        const KEY_EMAIL = "GC_AUTH_EMAIL";
        const email = (user.email || "").toLowerCase();
        const prevEmail = (localStorage.getItem(KEY_EMAIL) || "").toLowerCase();
        const ts = parseInt(localStorage.getItem(KEY_TS) || "0", 10);
        const now = Date.now();

        if(prevEmail && prevEmail !== email){
          // utente diverso: reset finestra
          localStorage.setItem(KEY_EMAIL, email);
          localStorage.setItem(KEY_TS, String(now));
        }else if(ts && (now - ts) > MAX_AGE_MS){
          // scaduta
          localStorage.removeItem(KEY_TS);
          localStorage.removeItem(KEY_EMAIL);
          state.lastAuthErrorMsg = "Sessione scaduta (7 giorni). Accedi di nuovo.";
          await authApi.signOut(auth);
          return;
        }else if(!ts){
          // prima volta
          localStorage.setItem(KEY_EMAIL, email);
          localStorage.setItem(KEY_TS, String(now));
        }
      }catch(_e){}

      // profilo
      let profile = await loadUserProfile(user.uid);
      if(!profile){
        const dn = (user.displayName||"").trim();
        profile = { fullName: dn || user.email || "" , email: user.email||"" };
        await upsertUserProfile(user, profile);
      } else {
        // assicurati fullName
        if(!profile.fullName){
          const dn = (user.displayName||"").trim();
          profile.fullName = dn || user.email || "";
          await upsertUserProfile(user, { fullName: profile.fullName, email: user.email||"" });
        }
      }
      // allowlist email
      const access = await getAccessByEmail(user.email||"");
      if(!access || access.enabled === false){
        renderAuthDenied(user.email||"", access && access.enabled===false ? "Accesso disabilitato." : "Email non presente in elenco autorizzati.");
        return;
      }


      // usa displayName da allowlist se presente (coerente per reparto)
      if(access && access.displayName){ profile.fullName = access.displayName; }

      state.user = { uid: user.uid, fullName: profile.fullName, email: (user.email||profile.email||""), isAdmin: Boolean(access && access.isAdmin) };
      state.operator = state.user.fullName;
      $("hdrUser").textContent = state.user.fullName;
      renderHeaderKpis();
      try{ await initNotificationsInbox(); }catch(_e){ state.notifications.unavailable = true; renderNotifCenter(); }
      renderNotifCenter();
      hideAuthGate();
      renderHome();
    });
  }


  // ===============================
  // LIVE SYNC (Firestore) - lazy import
  // ===============================
  async function initLiveSync(){
    try {
      const timeoutMs = 5500;
      const t = new Promise((_,rej)=>setTimeout(()=>rej(new Error("firebase timeout")), timeoutMs));

      const apiPromise = (async()=>{
        const { initializeApp } = await import(FIREBASE_IMPORT_APP);
        const fs = await import(FIREBASE_IMPORT_FS);
        const fa = await import(FIREBASE_IMPORT_AUTH);
        const fm = await import(FIREBASE_IMPORT_MSG);

        const app = initializeApp(firebaseConfig);
        const db = fs.getFirestore(app);
        const auth = fa.getAuth(app);
        let messaging = null;

        try { await fa.setPersistence(auth, fa.browserLocalPersistence); } catch(_e){}

        state.firebase.ok = true;
        state.firebase.db = db;
        state.firebase.api = fs;
        state.firebase.authApi = fa;
        state.firebase.auth = auth;
        state.firebase.msgApi = fm;
        try{ state.push.supported = await fm.isSupported(); }catch(_e){ state.push.supported = false; }
        if(state.push.supported){
          try{ messaging = fm.getMessaging(app); }catch(_e){ messaging = null; }
        }
        state.firebase.messaging = messaging;
      })();

      await Promise.race([apiPromise, t]);

      // Auth flow gate
      await ensureAuthFlow();

      const fs = state.firebase.api;
      const db = state.firebase.db;

      // Live productions
      const col = fs.collection(db, "powderProductions");
      fs.onSnapshot(col, (snap)=>{
        const arr = [];
        snap.forEach(doc=>arr.push({ id: doc.id, ...doc.data() }));
        state.activeProductions = arr.filter(x=>x && x.active);
        renderHome();
      }, (err)=>{
        console.warn("onSnapshot error", err);
        state.firebase.ok = false;
        renderHome();
      });

      // History for stats + "ordini conclusi"
      try {
        const hcol = fs.collection(db, "powderProdHistory");
        fs.onSnapshot(hcol, (snap)=>{
          const hist = [];
          snap.forEach(doc=>hist.push({ id: doc.id, ...doc.data() }));
          state.history = hist;
          state.historyReady = true;
          renderStats();
          renderHeaderKpis();
          try{ renderCompletedSection(); }catch(_e){}
          try{ renderPartialBanner && renderPartialBanner(); }catch(_e){}
        });
      } catch(_e) {}

    } catch(err) {
      console.warn("Firebase init failed:", err);
      state.firebase.ok = false;
      state.notifications.unavailable = true;
      renderNotifCenter();
      updateNotificationBadge();
      renderHome();
      renderAuthLogin("Connessione Firebase non disponibile. Verifica rete o contatta il responsabile.");
    }
  }

  async function upsertActiveProduction(prod){
    if(!state.firebase.ok) return null;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = prod.id || `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { ...prod, id, active:true }, { merge:true });
    return id;
  }

  async function closeActiveProduction(id, payload={}){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    await fs.setDoc(fs.doc(db, "powderProductions", id), { active:false, closedAt: nowIso(), ...payload }, { merge:true });
  }

  async function addHistory(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdHistory", id), { ...entry, id, at: nowIso() });
    return id;
  }

  async function clearCompletedHistory(){
    if(!state.firebase.ok || !(state.user && state.user.isAdmin)) return;
    if(!confirm("Eliminare tutti gli ordini conclusi?")) return;
    if(!confirm("Conferma finale: l’operazione è irreversibile.")) return;
    try{
      const fs = state.firebase.api;
      const db = state.firebase.db;
      const snap = await fs.getDocs(fs.collection(db, "powderProdHistory"));
      for(const d of snap.docs){
        await fs.deleteDoc(d.ref);
      }
      state.history = [];
      state.historyReady = true;
      renderCompletedSection();
      renderStats();
      renderHeaderKpis();
      showToast("Cancellati", "Ordini conclusi rimossi.");
    }catch(err){
      console.warn(err);
      showToast("Errore", "Impossibile cancellare i conclusi.");
    }
  }

  async function addAbort(entry){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    await fs.setDoc(fs.doc(db, "powderProdAborts", id), { ...entry, id, at: nowIso() });
  }

  async function addIssue(entry){
  if(!state.firebase.ok) return;
  const fs = state.firebase.api;
  const db = state.firebase.db;
  const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;

  await fs.setDoc(fs.doc(db, "powderProdIssues", id), { ...entry, id, at: nowIso() });

  // (opzionale) invio email via Firestore "Trigger Email" extension
  // Collezione default: "email"
  if(ISSUE_EMAIL_ENABLED && ISSUE_EMAIL_TO){
    try{
      const subject = `Segnalazione Hub Polveri · Ordine ${entry?.orderNo || ""}`.trim();
      const text = [
        "Nuova segnalazione dal Hub Linea Polveri",
        `Cliente: ${entry?.customer || ""}`,
        `Ordine: ${entry?.orderNo || ""}`,
        `Operatore: ${state.user?.fullName || ""}`,
        `Dettagli: ${entry?.text || entry?.message || ""}`
      ].join("\n");

      await fs.setDoc(fs.doc(db, "email", id), {
        to: ISSUE_EMAIL_TO,
        message: { subject, text }
      });
    }catch(err){
      console.warn("email issue failed", err);
    }
  }
}

// VOICE (Google voice only)
  // ===============================
  const GEMINI_TTS_ENDPOINT = localStorage.getItem("GEMINI_TTS_ENDPOINT") || "";
  async function speak(text){
    try{
      if(!text) return;

      // 1) Se configurato un endpoint TTS (Gemini/Google) uso audio reale
      if(GEMINI_TTS_ENDPOINT){
        const res = await fetch(GEMINI_TTS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ text, lang: "it-IT" })
        });

        if(res.ok){
          const ct = (res.headers.get("content-type")||"").toLowerCase();

          let blob;
          if(ct.includes("audio/")){
            blob = await res.blob();
          } else {
            // fallback: json { audioBase64, mime }
            const j = await res.json().catch(()=>null);
            if(j && j.audioBase64){
              const bin = atob(j.audioBase64);
              const arr = new Uint8Array(bin.length);
              for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
              blob = new Blob([arr], { type: j.mime || "audio/mpeg" });
            }
          }
          if(blob){
            const url = URL.createObjectURL(blob);
            const a = new Audio(url);
            a.onended = ()=>URL.revokeObjectURL(url);
            await a.play().catch(()=>{});
            return;
          }
        }
      }

      // 2) Fallback: Web Speech (dipende dal device)
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "it-IT";
      const voices = window.speechSynthesis.getVoices();
      const v = voices.find(x=>/Google/i.test(x.name) && /it/i.test(x.lang)) || voices.find(x=>/it/i.test(x.lang)) || null;
      if(v) u.voice = v;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(err){
      console.warn("speak error", err);
    }
  }
  window.speechSynthesis?.addEventListener?.("voiceschanged", ()=>{});

  // ===============================
  // RENDER
  // ===============================
  function prodRatio(p){
    const startedAt = p.startedAt ? new Date(p.startedAt).getTime() : null;
    if(!startedAt) return 0;
    const elapsed = Date.now() - startedAt;
    const kg = Number(p.totalKg||0);
    const expectedMs = Math.max(1, (kg/500) * 3600 * 1000);
    return elapsed / expectedMs;
  }

  
  function computePartialOrders(){
    const orders = state.powderOrders || [];
    const hist = state.history || [];
    const completedByOrder = new Map();
    for(const h of hist){
      if(!h || !h.orderNo) continue;
      const on = String(h.orderNo);
      const arr = Array.isArray(h.concludedLineKeys) ? h.concludedLineKeys : [];
      if(!completedByOrder.has(on)) completedByOrder.set(on, new Set());
      const set = completedByOrder.get(on);
      for(const k of arr){ if(k) set.add(String(k)); }
    }
    const partial = [];
    const full = [];
    for(const o of orders){
      const on = String(o.orderNo || o.number || "");
      if(!on) continue;
      let autoDone = 0;
      const keys = [];
      for(const l of (o.lines||[])){
        if(isNonProductionLine(l)){
          autoDone++;
          continue;
        }
        const lk = String(l.lineKey||"");
        if(lk) keys.push(lk);
      }
      const total = keys.length + autoDone;
      if(total<=0) continue;
      const doneSet = completedByOrder.get(on) || new Set();
      let doneReal = 0;
      for(const k of keys){ if(doneSet.has(k)) doneReal++; }
      const concludedTotal = doneReal + autoDone;
      const remaining = total - concludedTotal;
      const hasRealProgress = doneReal>0;
      if(hasRealProgress && remaining>0) partial.push({ orderNo:on, customer:o.customer||"", done:concludedTotal, total });
      else if(concludedTotal>0 && remaining<=0) full.push({ orderNo:on, customer:o.customer||"", done:concludedTotal, total });
    }
    return { partial, full };
  }

  function handlePrimaryCta(){
    const active = state.activeProductions || [];
    const me = (state.user?.fullName || state.operator || "").toLowerCase();
    const ownActive = me && active.some(p=>String(p.operator||"").toLowerCase() === me);
    if(ownActive) openRunningModal(); else openProdModal();
  }

  function buildOrderViews(options={}){
    // Filtra righe già concluse e applica priorità/visibilità lato UI (no backend)
    const applyRoleVisibility = options.applyRoleVisibility !== false;
    const includeHidden = options.includeHidden === true;
    const concluded = new Set();
    for(const h of (state.history||[])){
      if(!h || !Array.isArray(h.concludedLineKeys)) continue;
      for(const k of h.concludedLineKeys){ if(k) concluded.add(String(k)); }
    }
    const activeMap = new Map();
    for(const p of (state.activeProductions||[])){
      const keys = Array.isArray(p.selectedLineKeys) ? p.selectedLineKeys : [];
      for(const k of keys){ if(k) activeMap.set(String(k), p); }
    }
    const partialMap = new Map();
    const fullMap = new Map();
    try{
      const { partial, full } = computePartialOrders();
      partial.forEach(p=>partialMap.set(String(p.orderNo), p));
      full.forEach(p=>fullMap.set(String(p.orderNo), p));
    }catch(_e){}

    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    const isAdmin = Boolean(state.user && state.user.isAdmin);

    const orders = [];
    const baseOrders = [];
    for(const o of (state.powderOrders || [])){
      const orderNo = o.orderNo || o.number || "";
      const note = getOrderNote(o);
      const priorityInfo = computePriorityFromNote(note);
      let autoDone = 0;
      const lines = (o.lines||[]).map(l=>{
        if(isNonProductionLine(l)){
          autoDone++;
          return null;
        }
        const key = String(l.lineKey||"");
        const activeProd = activeMap.get(key) || null;
        const status = concluded.has(key) ? "done" : activeProd ? "active" : "idle";
        return { ...l, status, activeProd, activeOp: activeProd?.operator || activeProd?.operatorName || "", conclusion: l.conclusion || o.conclusion || "" };
      }).filter(Boolean).filter(l=>l.status !== "done");
      const alerts = Array.isArray(o.alerts) ? o.alerts : [];
      if(!lines.length){
        if(autoDone>0) continue;
        if(!alerts.length) continue;
      }

      const planDate = priorityInfo.date || extractDateFromText(note);
      const daysAway = planDate ? diffDaysFromNow(planDate) : null;
      const baseOrder = { ...o, orderNo, lines, alerts, autoDone, totalLines: lines.length + autoDone, partialInfo: partialMap.get(String(orderNo)) || null, isCompleted: fullMap.has(String(orderNo)), note, priorityInfo, planDate, daysAway };
      baseOrders.push(baseOrder);

      let visible = true;
      if(applyRoleVisibility){
        if(isDesktop){
          if(isAdmin){
            visible = true;
          } else {
            const beyondWindow = Boolean(planDate && daysAway!=null && daysAway>3);
            visible = !beyondWindow;
          }
        } else {
          visible = priorityInfo.visible !== false;
        }
      }
      if(!visible && !includeHidden) continue;
      orders.push(baseOrder);
    }

    return { orders, baseOrders, concluded, activeMap, partialMap, fullMap };
  }

  function resolvePackKgForLine(line){
    const direct = Number(line?.packKg);
    if(Number.isFinite(direct) && direct>0) return direct;
    const fromDesc = detectPackKg(line?.desc || "");
    if(Number.isFinite(fromDesc) && fromDesc>0) return fromDesc;
    const fromCombo = detectPackKg(`${line?.desc||""} ${line?.um||""}`);
    if(Number.isFinite(fromCombo) && fromCombo>0) return fromCombo;
    return null;
  }
  function isUnitKg(um){
    const u = norm(um||"");
    return (u==="kg") || /\bkg\b/.test(u);
  }
  function isBagOrPieceUnit(um){
    const u = norm(um||"");
    return /\b(sac|sacco|sacchi|sacchetto|sacchetti)\b/.test(u) || /\b(pz|pez|pezzi|pezzo)\b/.test(u);
  }

  function estimateLineKg(line){
    if(!line) return 0;
    const packParsed = resolvePackKgForLine(line);
    const lineKg = resolveQtyKg({
      qty: line.qty,
      um: line.um,
      uom: line.uom,
      unitaMisura: line.unitaMisura,
      unit: line.unit,
      measure: line.measure,
      packKg: packParsed,
      desc: line.desc || ""
    });
    if(Number.isFinite(lineKg) && lineKg>0) return lineKg;
    const fallback = Number(line.lineKg);
    if(Number.isFinite(fallback) && fallback>0) return fallback;
    return 0;
  }

  function computeVisiblePowderSummary(orders){ // UI-FIX: kg-totali
    const lines = [];
    for(const o of (orders||[])){
      for(const l of (o.lines||[])){ lines.push(l); }
    }
    let totalKg = 0;
    let totalLabels = 0;
    let hasLabelData = false;
    const samples = [];
    for(const l of lines){
      const lineKg = estimateLineKg(l);
      if(Number.isFinite(lineKg)) totalKg += lineKg;
      const packKg = resolvePackKgForLine(l);
      if(Number.isFinite(packKg) && packKg>0 && Number.isFinite(lineKg) && lineKg>0){
        totalLabels += (lineKg / packKg);
        hasLabelData = true;
      }
      if(samples.length < 5) samples.push({ rawQty: l.qty, parsedQty: parseItNumber(l.qty) });
    }
    return { totalKg, lineCount: lines.length, samples, labels: hasLabelData ? totalLabels : null };
  }

  function buildMagazzinoData(){
    const { orders } = buildOrderViews();
    const totals = { productKg:0, bobine:new Map(), etichette:0, scatole:new Map(), divisori:new Map(), altri:new Map(), nonConfig:[], warnings:[] };
    const orderDetails = [];
    for(const o of orders){
      const comp = { productKg:0, bobine:new Map(), etichette:0, scatole:new Map(), divisori:new Map(), altri:new Map(), nonConfig:[], warnings:[] };
      const status = o.lines.some(l=>l.status==="active") ? "in_produzione" : (o.partialInfo ? "parziale" : "da_fare");
      for(const l of (o.lines||[])){
        const qtyKgRimanenti = magResolveQtyKg(l); // CODEX: kg residui per Statistiche/Magazzino
        if(Number.isFinite(qtyKgRimanenti) && qtyKgRimanenti>0){
          comp.productKg += qtyKgRimanenti;
          totals.productKg += qtyKgRimanenti;
        }
        const packKg = magDetectPackKg(l);
        const { bom, source } = magMatchBom(l, packKg) || {};
        const unsupportedPack = (source==="pack_unsupported");
        if(!packKg || packKg<=0 || !bom){
          const note = unsupportedPack ? "Non configurato (packKg non supportato)" : "";
          const nc = { desc:l.desc, customer:o.customer, orderNo:o.orderNo||o.number, qtyKg:qtyKgRimanenti, packKg, code:l.code||"", note };
          comp.nonConfig.push(nc);
          totals.nonConfig.push(nc);
          continue;
        }
        const bags = Number(packKg) ? (qtyKgRimanenti/packKg) : 0;
        if(!Number.isFinite(bags) || bags<=0){
          const nc = { desc:l.desc, customer:o.customer, orderNo:o.orderNo||o.number, qtyKg:qtyKgRimanenti, packKg, code:l.code||"" };
          comp.nonConfig.push(nc);
          totals.nonConfig.push(nc);
          continue;
        }
        if(Math.abs(bags - Math.round(bags)) > 0.01){
          const warn = `${l.desc} · ${bags.toFixed(2)} sacchi da ${packKg} kg`;
          comp.warnings.push(warn);
          totals.warnings.push(warn);
        }
        // CODEX: per i kg totali uso qtyKg (già in kg reali). packKg serve solo per calcolare i sacchi → componenti.
        if(bom.bobine){
          for(const [label,cfg] of Object.entries(bom.bobine)){
            const perBag = Number((cfg && cfg.perBag!=null) ? cfg.perBag : cfg) || 0;
            const unit = (cfg && cfg.unit) || "g";
            const grams = unit==="kg" ? perBag*1000 : perBag;
            magAddToMap(comp.bobine, label, grams * bags);
            magAddToMap(totals.bobine, label, grams * bags);
          }
        }
        if(Number(bom.etichettePerBag)){
          const tot = Number(bom.etichettePerBag||0) * bags;
          comp.etichette += tot;
          totals.etichette += tot;
        }
        if(bom.scatole){
          for(const [label,val] of Object.entries(bom.scatole)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.scatole, label, tot);
            magAddToMap(totals.scatole, label, tot);
          }
        }
        if(bom.divisori){
          for(const [label,val] of Object.entries(bom.divisori)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.divisori, label, tot);
            magAddToMap(totals.divisori, label, tot);
          }
        }
        if(bom.altri){
          for(const [label,val] of Object.entries(bom.altri)){
            const tot = Number(val||0) * bags;
            magAddToMap(comp.altri, label, tot);
            magAddToMap(totals.altri, label, tot);
          }
        }
      }
      orderDetails.push({ order:o, comp, status });
    }
    return { totals, orderDetails };
  }

  function computeFatturatoLordo(docs){
    let tot = 0;
    let found = false;
    for(const d of (docs||[])){
      const raw = d?.totalDoc;
      const num = Number.isFinite(raw) ? Number(raw) : parseCurrencyValue(raw);
      if(Number.isFinite(num)){
        tot += num;
        found = true;
      }
    }
    return found ? tot : null;
  }

  function resolveFatturatoValue(){
    try{
      if(state.fatturatoLordo!=null && Number.isFinite(state.fatturatoLordo)) return state.fatturatoLordo;
      if((state.fatturatoLordo==null) && (state.docs && state.docs.length)){
        const computed = computeFatturatoLordo(state.docs); // CODEX: calcolo on-demand da XML già in memoria
        if(computed!=null){
          state.fatturatoLordo = computed;
          return computed;
        }
      }
      const el = $("fatValue");
      if(el && el.dataset && el.dataset.value){
        const n = parseCurrencyValue(el.dataset.value);
        if(n!=null) return n;
      }
      const saved = parseCurrencyValue(localStorage.getItem(FAT_VALUE_KEY));
      if(saved!=null) return saved;
    }catch(_e){}
    return null;
  }
  function updateFatturatoUI(){
    const el = $("fatValue");
    const sub = $("fatSubtitle");
    if(!el) return;
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    const val = resolveFatturatoValue();
    const numericVal = Number.isFinite(val) ? Number(val) : parseCurrencyValue(val);
    state.fatturatoLordo = numericVal;
    if(numericVal!=null){
      el.dataset.value = String(numericVal);
      try{ localStorage.setItem(FAT_VALUE_KEY, String(numericVal)); }catch(_e){}
    } else {
      delete el.dataset.value;
    }
    const formatted = numericVal!=null ? new Intl.NumberFormat("it-IT", { style:"currency", currency:"EUR" }).format(numericVal) : "Dati non disponibili";
    if(isDesktop){
      el.classList.add("reveal");
      el.classList.remove("blur");
      el.textContent = formatted;
      if(sub) sub.textContent = "Fatturato lordo aggregato (desktop).";
    } else {
      el.classList.add("blur");
      if(el.classList.contains("reveal")){
        el.textContent = formatted;
      } else {
        el.textContent = "€ —";
      }
      if(sub) sub.textContent = "Mobile: tocca per mettere a fuoco il fatturato lordo.";
    }
  }

  function getOrderNote(order){
    try{
      const overridesRaw = localStorage.getItem("ORDER_NOTE_OVERRIDES") || "";
      if(overridesRaw){
        const map = JSON.parse(overridesRaw);
        const key = order.orderNo || order.number || "";
        if(key && map && map[key]) return map[key];
      }
    }catch(_e){}
    return order.note || order.comment || order.internalNote || "";
  }

  function extractDateFromText(text){
    const t = norm(text||"");
    if(!t) return null;
    const monthMap = { "gennaio":0,"febbraio":1,"marzo":2,"aprile":3,"maggio":4,"giugno":5,"luglio":6,"agosto":7,"settembre":8,"ottobre":9,"novembre":10,"dicembre":11 };
    let m = t.match(/(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)(?:\s+(\d{4}))?/);
    if(m){
      const d = parseInt(m[1],10);
      const mo = monthMap[m[2]];
      const y = m[3] ? parseInt(m[3],10) : (new Date()).getFullYear();
      if(!isNaN(d) && mo!=null) return new Date(y, mo, d);
    }
    m = t.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
    if(m){
      const d = parseInt(m[1],10);
      const mo = parseInt(m[2],10)-1;
      let y = m[3] ? parseInt(m[3],10) : (new Date()).getFullYear();
      if(y<100) y = 2000 + y;
      if(!isNaN(d) && mo>=0) return new Date(y, mo, d);
    }
    return null;
  }

  function diffDaysFromNow(date){
    if(!date) return null;
    const now = new Date();
    const tzNow = new Date(now.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
    const tzTarget = new Date(date.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
    return Math.floor((tzTarget - tzNow)/(24*3600*1000));
  }

  function computePriorityFromNote(note){
    // Parsing leggero per note di priorità (giorno prima/giorno stesso)
    const n = norm(note||"");
    if(!n) return { priority:"normal", visible:true };
    if(/da\s*fare\s*oggi/.test(n)){
      return { priority:"today", visible:true, reason:"Da fare oggi" };
    }
    const target = extractDateFromText(n);
    if(target){
      const diffDays = diffDaysFromNow(target);
      if(diffDays != null){
        const tzTarget = new Date(target.toLocaleString("en-US", { timeZone:"Europe/Rome" }));
        if(diffDays >= 2) return { priority:"scheduled", visible:false, date: tzTarget };
        if(diffDays >= 1) return { priority:"scheduled", visible:true, date: tzTarget, reason:"Da iniziare domani" };
        if(diffDays >= 0) return { priority:"scheduled", visible:true, date: tzTarget, reason:"Da iniziare oggi" };
      }
    }
    return { priority:"normal", visible:true };
  }

  // CODEX: helper magazzino (match robusto su nome/codice + pack)
  function magNormalizeName(name){
    return norm(name).replace(/\bkg\b/g," ").replace(/\b\d+(?:[\.,]\d+)?\b/g," ").replace(/\s+/g," ").trim();
  }
  function magDetectPackKg(line){
    return resolvePackKgForLine(line);
  }
  function magResolveQtyKg(line){ // CODEX: kg rimanenti realistici per Statistiche/Magazzino
    const kg = resolveQtyKg({
      qty: line?.qty,
      um: line?.um,
      uom: line?.uom,
      unitaMisura: line?.unitaMisura,
      unit: line?.unit,
      measure: line?.measure,
      packKg: magDetectPackKg(line),
      desc: line?.desc || ""
    });
    if(Number.isFinite(kg) && kg>0) return kg;
    const lineKg = Number(line?.lineKg);
    if(Number.isFinite(lineKg) && lineKg>0) return lineKg;
    return 0;
  }
  function magFindPackEntry(packs, packKg){
    if(!packs || packKg==null) return null;
    if(packs[packKg]) return packs[packKg];
    if(packs[String(packKg)]) return packs[String(packKg)];
    const nearKey = Object.keys(packs||{}).find(k=>Math.abs(Number(k||0)-Number(packKg))<0.011);
    return nearKey ? packs[nearKey] : null;
  }
  function magMatchBom(line, packKg){
    const codeKey = norm(line.code||"").replace(/\s+/g,"");
    const normalizedPack = Number(packKg);
    if(codeKey && MAGAZZINO_BOM.byCode[codeKey]){
      const entry = magFindPackEntry(MAGAZZINO_BOM.byCode[codeKey].packs, packKg);
      if(entry) return { bom: entry, source:"code" };
    }
    const nameKey = magNormalizeName(line.desc||"");
    if(nameKey && MAGAZZINO_BOM.byName[nameKey]){
      const entry = magFindPackEntry(MAGAZZINO_BOM.byName[nameKey].packs, packKg);
      if(entry) return { bom: entry, source:"name" };
    }
    const defaultEntry = magFindPackEntry(MAGAZZINO_BOM.defaultByPackKg, packKg);
    if(defaultEntry) return { bom: defaultEntry, source:"default" };
    if(Number.isFinite(normalizedPack)) return { bom:null, source:"pack_unsupported" };
    return { bom:null, source:"not_found" };
  }
  function magFmtKg(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "—";
    return `${n.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1")} kg`;
  }
  function magFmtGram(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "—";
    const g = n%1===0 ? n.toFixed(0) : n.toFixed(1); // CODEX: bobine in grammi con max 1 decimale
    return `${g.replace(/\.0$/,"")} g`;
  }
  function magFmtFraction(val){
    const n = Number(val||0);
    if(!Number.isFinite(n)) return "—";
    return n.toFixed(2).replace(/\.0+$/,"").replace(/(\.\d*[1-9])0+$/,"$1");
  }
  function magAddToMap(map, key, delta){
    if(!key) return;
    const cur = Number(map.get(key)||0);
    const add = Number(delta||0);
    if(!Number.isFinite(add)) return;
    map.set(key, cur + add);
  }


function escapeHtml(s){
  return String(s==null?"":s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}

function tsFromId(id){
  try{
    const n = Number(String(id||"").split("_")[0]);
    return Number.isFinite(n) ? n : 0;
  }catch(_e){ return 0; }
}

function renderCompletedSection(){
  const list = $("completedList");
  const empty = $("completedEmpty");
  const badge = $("completedBadge");
  if(!list || !empty || !badge) return;

  const hist = Array.isArray(state.history) ? state.history.slice() : [];
  hist.sort((a,b)=> tsFromId(b.id||b.at||0) - tsFromId(a.id||a.at||0));

  const entries = hist.filter(h=>h && (h.orderNo || h.customer || h.operator)).slice(0, 10);
  badge.textContent = entries.length ? String(entries.length) : "0";

  list.innerHTML = "";
  if(!entries.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";
  const isAdmin = Boolean(state.user && state.user.isAdmin);
  let adminBox = document.getElementById("completedAdmin");
  if(isAdmin){
    if(!adminBox){
      adminBox = document.createElement("div");
      adminBox.id = "completedAdmin";
      adminBox.style.margin = "10px 0";
      adminBox.innerHTML = `<button class="btn bad" id="btnClearCompleted" style="width:100%;">Cancella tutti conclusi</button>`;
      list.parentElement.appendChild(adminBox);
    }
    const btn = adminBox.querySelector("#btnClearCompleted");
    if(btn) btn.onclick = ()=> clearCompletedHistory();
    adminBox.style.display = "block";
  } else if(adminBox){
    adminBox.style.display = "none";
  }

  // status maps (in base all'XML corrente)
  let partialSet = new Set(), fullSet = new Set();
  try{
    const { partial, full } = computePartialOrders();
    for(const p of partial) partialSet.add(String(p.orderNo));
    for(const f of full) fullSet.add(String(f.orderNo));
  }catch(_e){}

  for(const h of entries){
    const orderNo = h.orderNo ? String(h.orderNo) : "—";
    const customer = h.customer || "";
    const operator = h.operator || h.operatorName || (h.userName||"") || "Operatore";
    const at = h.at ? fmtDateTime(h.at) : "";
    const kg = (()=>{
      try{
        if(Array.isArray(h.perLine) && h.perLine.length){
          return Math.round(h.perLine.reduce((a,x)=>a + (Number(x.producedKg||0)||0), 0));
        }
      }catch(_e){}
      return null;
    })();

    let status = "Produzione registrata";
    if(fullSet.has(orderNo)) status = "Ordine concluso";
    else if(partialSet.has(orderNo)) status = "Ordine parzialmente concluso";

    const div = document.createElement("div");
    div.className = "item completedItem";
    div.innerHTML = `
      <div class="top">
        <div>
          <div class="name">Ordine n. ${escapeHtml(orderNo)} ${customer?`· ${escapeHtml(customer)}`:""}</div>
          <div class="completedMeta">
            <div><b>${escapeHtml(operator)}</b></div>
            ${at?`<div class="kv">${escapeHtml(at)}</div>`:""}
            ${kg!=null?`<div class="kv"><b>${kg}</b> kg</div>`:""}
            <div>${escapeHtml(status)}</div>
          </div>
        </div>
        <div class="badge">Dettagli</div>
      </div>
    `;
    div.addEventListener("click", ()=> openHistModal(h.id));
    list.appendChild(div);
  }
}

function openHistModal(id){
  const h = (state.history||[]).find(x=>x && x.id===id);
  if(!h) return;

  const orderNo = h.orderNo ? String(h.orderNo) : "—";
  const customer = h.customer || "";
  const operator = h.operator || h.operatorName || "Operatore";
  $("histTitle").textContent = `Ordine n. ${orderNo}${customer?` · ${customer}`:""}`;
  $("histSub").textContent = `Operatore: ${operator}${h.at?` · ${fmtDateTime(h.at)}`:""}`;

  const body = $("histBody");
  const lines = Array.isArray(h.perLine) ? h.perLine : [];
  const lineHtml = lines.length ? lines.map(l=>`
    <div class="item" style="margin-bottom:10px;">
      <div class="top">
        <div>
          <div class="name">${escapeHtml(l.desc||"")}</div>
          <div class="muted">Pianificati: <b>${escapeHtml(String(l.plannedKg??"—"))}</b> kg · Prodotti: <b>${escapeHtml(String(l.producedKg??"—"))}</b> kg</div>
        </div>
        <div class="badge">${escapeHtml(String(l.qty??""))} ${escapeHtml(String(l.um??""))}</div>
      </div>
      ${l.code?`<div class="muted" style="margin-top:6px;">Codice: <b>${escapeHtml(String(l.code))}</b></div>`:""}
    </div>
  `).join("") : `<div class="muted">Nessun dettaglio righe disponibile.</div>`;

  const sig = h.signature ? `<div style="margin-top:14px;"><div class="muted" style="margin-bottom:6px;">Firma</div><img src="${h.signature}" alt="Firma" style="width:100%; max-width:520px; border:1px solid var(--stroke); border-radius:14px; background:#fff;"></div>` : "";

  body.innerHTML = `
    <div class="muted">Stato: <b>${escapeHtml((()=>{ try{ const {partial,full}=computePartialOrders(); const ps=new Set(partial.map(x=>String(x.orderNo))); const fs=new Set(full.map(x=>String(x.orderNo))); if(fs.has(orderNo)) return "Ordine concluso"; if(ps.has(orderNo)) return "Ordine parzialmente concluso"; }catch(_e){} return "Storico"; })())}</b></div>
    <div style="height:12px"></div>
    ${lineHtml}
    ${sig}
  `;

  $("histModal").classList.add("show");
  lockBody();
}

function renderHome(){
    relocateStatsCard(); // CODEX: forza Statistiche sotto Operatività su desktop
    try{ const el=$('homeWelcome'); if(el && state.user){ el.textContent = `Benvenuto, ${state.user.fullName}`; } }catch(e){}

    const views = buildOrderViews();
    pruneSelectionAgainstOrders(views.baseOrders);
    updateSelectionCounter();
    const visibleOrders = views.orders; // UI-FIX: kg-totali
    const kgSummary = computeVisiblePowderSummary(visibleOrders); // UI-FIX: kg-totali
    $("kPowderLines").textContent = kgSummary.lineCount ? kgSummary.lineCount.toString() : "0"; // UI-FIX: kg-totali
    const kPowderKgEl = $("kPowderKg");
    if(!Number.isFinite(kgSummary.totalKg) || kgSummary.totalKg>50000){
      kPowderKgEl.textContent = "Dati non disponibili"; // UI-FIX: kg-totali
      console.log("UI-FIX: kg-totali debug", { lineCount: kgSummary.lineCount, samples: kgSummary.samples, totalKg: kgSummary.totalKg }); // UI-FIX: kg-totali
    } else {
      kPowderKgEl.textContent = Math.round(kgSummary.totalKg).toLocaleString("it-IT"); // UI-FIX: kg-totali
    }
    const kPowderMeta = $("kPowderMeta"); // UI-FIX: kg-totali
    if(kPowderMeta) kPowderMeta.textContent = `Calcolato su ${kgSummary.lineCount} righe visibili`; // UI-FIX: kg-totali
    const kPowderLabelsEl = $("kPowderLabels");
    const kPowderLabelsMeta = $("kPowderLabelsMeta");
    if(kPowderLabelsEl){
      if(Number.isFinite(kgSummary.labels)){
        kPowderLabelsEl.textContent = Math.round(kgSummary.labels).toLocaleString("it-IT");
        if(kPowderLabelsMeta) kPowderLabelsMeta.textContent = "Calcolo su formati sacco riconosciuti";
      } else {
        kPowderLabelsEl.textContent = "—";
        if(kPowderLabelsMeta) kPowderLabelsMeta.textContent = "Pack non rilevato: etichette non stimate";
      }
    }
    const pOrders = state.powderOrders || [];
    $("badgeCounts").textContent = `${pOrders.length} ordini`;

    let txt = "Ordini: ";
    if(state.xmlModifiedTime) txt += `aggiornati ${state.xmlModifiedTime}`;
    else if(state.lastFetchAt) txt += `aggiornati ${fmtDateTime(state.lastFetchAt)}`;
    else txt += "in sincronizzazione…";
    $("txtXmlTime").textContent = txt;
    updateFatturatoUI(); // CODEX: aggiornamento UI fatturato lordo

    // Banner ordini parzialmente conclusi (globale)
    try{
      const { partial } = computePartialOrders();
      state.partialOrders = partial;
      const b = $("partialBanner");
      if(b){
        if(partial.length){
          b.dataset.display = "flex";
          b.style.display = "flex";
          requestAnimationFrame(()=> b.classList.add("show"));
          const n = partial.length;
          $("partialBannerTitle").textContent = `Ci sono ${n} ordini parzialmente conclusi in corso`;
          $("partialBannerSub").textContent = `Apri Produzione per completare le righe rimanenti.`;
        } else {
          b.classList.remove("show");
          setTimeout(()=>{ b.style.display = "none"; }, 180);
        }
      }
      if($("partialModal")?.classList.contains("show")) renderPartialOrdersList(); // CODEX: re-render immediato elenco parziali
    }catch(_e){}

    // Ordini conclusi (sezione Home)
    try{ renderCompletedSection(); }catch(_e){}

    const active = state.activeProductions || [];
    const strip = $("prodStrip");
    if(active.length){
      strip.style.display = "block";
      $("prodCount").textContent = String(active.length);
      const parts = active.slice(0,6).map(p=>`${p.operator||"Operatore"}: ${p.customer||"Cliente"} · Ordine n. ${p.orderNo||"—"}`);
      $("prodMarquee").textContent = parts.join("   •   ") + (active.length>6 ? "   •   ..." : "");
      const ratios = active.map(p=>prodRatio(p));
      const r = ratios.length ? Math.max(...ratios) : 0;
      const hue = Math.max(0, 120 - (120 * Math.min(1,r)));
      strip.style.background = `hsla(${hue}, 80%, 45%, .22)`;
      strip.style.borderColor = `hsla(${hue}, 80%, 55%, .35)`;
    } else {
      strip.style.display = "none";
    }
    try{
      const btn = $("btnGoProd");
      if(btn){
        const me = (state.user?.fullName || state.operator || "").toLowerCase();
        const ownActive = me && active.some(p=>String(p.operator||"").toLowerCase()===me);
        btn.textContent = ownActive ? "APRI PRODUZIONE IN CORSO" : "VAI IN PRODUZIONE";
        btn.setAttribute("aria-label", btn.textContent);
      }
    }catch(_e){}

    renderStats();
    renderHeaderKpis();
    renderMagazzino(); // CODEX: re-render magazzino dopo gli stessi filtri degli ordini
  }

  
  async function bumpOperatorKg(uid, fullName, kg){
    if(!state.firebase.ok || !uid) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const ref = fs.doc(db, "operatorStats", uid);
    await fs.runTransaction(db, async(tx)=>{
      const snap = await tx.get(ref);
      const cur = snap.exists() ? (snap.data()||{}) : {};
      const totalKg = Number(cur.totalKg||0) + Number(kg||0);
      const totalRuns = Number(cur.totalRuns||0) + 1;
      tx.set(ref, { uid, fullName, totalKg, totalRuns, updatedAt: nowIso() }, { merge:true });
    });
  }

  function renderStats(){
    const list = $("statsList");
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    if(!isDesktop){
      list.innerHTML = `<div class="muted">Apri da desktop per vedere le statistiche.</div>`;
      $("statsBadge").textContent = "—";
      return;
    }

    // Admin (solo desktop): reset storico
    try{
      const adminBoxId = "adminStatsBox";
      let box = document.getElementById(adminBoxId);
      if(state.user && state.user.isAdmin && !isMobile()){
        if(!box){
          box = document.createElement("div");
          box.id = adminBoxId;
          box.style.marginTop = "12px";
          box.innerHTML = `
            <div class="divider"></div>
            <div class="stepTitle" style="font-size:14px; margin-top:0;">Admin</div>
            <button class="btn bad" id="btnClearHistory" style="width:100%;">Elimina dati storici</button>
            <div class="muted" style="margin-top:8px;">Attenzione: operazione irreversibile.</div>
          `;
          list.parentElement.appendChild(box);
          box.querySelector("#btnClearHistory").onclick = async()=>{
            if(!confirm("Eliminare TUTTI i dati storici di produzione?")) return;
            if(!confirm("Conferma finale: questa operazione è irreversibile.")) return;
            try{
              const fs = state.firebase.api;
              const db = state.firebase.db;
              const cols = ["powderProdHistory","operatorStats"];
              for(const c of cols){
                const snap = await fs.getDocs(fs.collection(db, c));
                for(const d of snap.docs){
                  await fs.deleteDoc(d.ref);
                }
              }
              showToast("Storico eliminato", "Dati storici rimossi.");
            }catch(err){
              console.warn(err);
              showToast("Errore", "Impossibile eliminare lo storico.");
            }
          };
        }
      } else {
        if(box) box.remove();
      }
    }catch(_e){}
    const hist = (state.history||[]).filter(x=>x && x.operator);
    if(!hist.length){
      list.innerHTML = `<div class="muted">Nessun dato storico disponibile (in attesa delle prime produzioni).</div>`;
      $("statsBadge").textContent = "0";
      return;
    }
    const agg = new Map();
    for(const h of hist){
      const op = h.operator;
      const kg = Number(h.kg||0);
      const ms = Number(h.durationMs||0);
      const a = agg.get(op) || { kg:0, ms:0, n:0 };
      a.kg += kg; a.ms += ms; a.n += 1;
      agg.set(op, a);
    }
    const rows = Array.from(agg.entries()).map(([op,a])=>{
      const hours = a.ms/3600000;
      const speed = hours>0 ? (a.kg/hours) : 0;
      return { op, ...a, speed };
    }).sort((x,y)=>y.kg-x.kg);

    $("statsBadge").textContent = String(rows.length);
    list.innerHTML = "";
    for(const r of rows){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${r.op}</div>
            <div class="sub">${r.n} produzioni · Velocità media: ${Math.round(r.speed)} kg/h</div>
          </div>
          <div class="badge">${Math.round(r.kg)} kg</div>
        </div>`;
      list.appendChild(div);
    }
  }

  function renderMagazzino(){
    // Distinta base lato client (desktop only) - usa dati già filtrati dall'UI ordini
    const card = $("warehouseCard");
    const body = $("warehouseBody");
    const badge = $("warehouseBadge");
    if(!card || !body || !badge) return;
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    card.style.display = isDesktop ? "block" : "none";
    if(!isDesktop){
      body.innerHTML = "";
      badge.textContent = "—";
      return;
    }

    const { totals, orderDetails } = buildMagazzinoData();
    orderDetails.sort((a,b)=>`${a.order.customer||""}`.localeCompare(`${b.order.customer||""}`) || `${a.order.orderNo||a.order.number||""}`.localeCompare(`${b.order.orderNo||b.order.number||""}`));
    badge.textContent = `${orderDetails.length || 0}`;
    if(!orderDetails.length){
      body.innerHTML = `<div class="muted">Nessun ordine disponibile.</div>`;
      return;
    }

    const renderMap = (map, fmtFn)=>{
      if(!map || !map.size) return `<div class="muted">—</div>`;
      return Array.from(map.entries()).map(([k,v])=>`
        <div class="magRow">
          <div class="l">${escapeHtml(k)}</div>
          <div class="v">${fmtFn(v)}</div>
        </div>
      `).join("");
    };

    const nonCfgList = totals.nonConfig.slice(0,6).map(nc=>`
      <div class="magRow">
        <div class="l">${escapeHtml(nc.customer||"Cliente")} · Ord. ${escapeHtml(nc.orderNo||"—")}<div class="s">${escapeHtml(nc.desc||"Prodotto")}${nc.note?` · ${escapeHtml(nc.note)}`:""}</div></div>
        <div class="v">${magFmtKg(nc.qtyKg||0)}${nc.packKg?` · ${nc.packKg} kg`:``}</div>
      </div>
    `).join("");

    const panoHtml = `
      <div class="magBox">
        <div class="magTitle">Panoramica magazzino</div>
        <div class="magList">
          <div class="magRow"><div class="l">Prodotti (kg)</div><div class="v">${magFmtKg(totals.productKg)}</div></div>
          <div class="magRow"><div class="l">Bobine</div><div class="v">${totals.bobine.size?`${totals.bobine.size} tipologie`: "—"}</div></div>
          <div class="magRow"><div class="l">Etichette</div><div class="v">${magFmtFraction(totals.etichette)} pz</div></div>
          <div class="magRow"><div class="l">Scatole</div><div class="v">${magFmtFraction(Array.from(totals.scatole.values()).reduce((a,x)=>a+x,0))} pz</div></div>
          <div class="magRow"><div class="l">Divisori</div><div class="v">${magFmtFraction(Array.from(totals.divisori.values()).reduce((a,x)=>a+x,0))} pz</div></div>
          <div class="magRow"><div class="l">Altri componenti</div><div class="v">${magFmtFraction(Array.from(totals.altri.values()).reduce((a,x)=>a+x,0))} pz</div></div>
          <div class="magRow"><div class="l">Non configurati (N)</div><div class="v">${totals.nonConfig.length || 0}</div></div>
        </div>
        ${totals.bobine.size ? `<div style="margin-top:10px;"><div class="magPill">Bobine</div>${renderMap(totals.bobine, magFmtGram)}</div>`:""}
        ${totals.scatole.size ? `<div style="margin-top:10px;"><div class="magPill">Scatole</div>${renderMap(totals.scatole, (v)=>`${magFmtFraction(v)} pz`)}</div>`:""}
        ${totals.divisori.size ? `<div style="margin-top:10px;"><div class="magPill">Divisori</div>${renderMap(totals.divisori, (v)=>`${magFmtFraction(v)} pz`)}</div>`:""}
        ${totals.altri.size ? `<div style="margin-top:10px;"><div class="magPill">Altri</div>${renderMap(totals.altri, (v)=>`${magFmtFraction(v)} pz`)}</div>`:""}
        ${totals.nonConfig.length ? `<div style="margin-top:12px;" class="magBox"><div class="magTitle" style="margin-bottom:6px;">Non configurati</div><div class="muted" style="margin-bottom:6px;">Distinta non configurata o formato non riconosciuto.</div>${nonCfgList}</div>`:""}
      </div>`;

    const detailHtml = orderDetails.map(({order, comp, status})=>{
      const stTxt = status==="in_produzione" ? "In produzione" : status==="parziale" ? "Parziale" : "Da fare";
      const stCol = status==="in_produzione" ? "var(--good)" : status==="parziale" ? "var(--warn)" : "var(--muted)";
      const compBlocks = [];
      compBlocks.push(`<div class="magRow"><div class="l">Prodotto</div><div class="v">${magFmtKg(comp.productKg)}</div></div>`);
      if(comp.bobine.size) compBlocks.push(`<div class="magRow"><div class="l">Bobine</div><div class="v">${comp.bobine.size} tipi</div></div>${renderMap(comp.bobine, magFmtGram)}`);
      if(comp.etichette) compBlocks.push(`<div class="magRow"><div class="l">Etichette</div><div class="v">${magFmtFraction(comp.etichette)} pz</div></div>`);
      if(comp.scatole.size) compBlocks.push(`<div class="magRow"><div class="l">Scatole</div><div class="v">${magFmtFraction(Array.from(comp.scatole.values()).reduce((a,x)=>a+x,0))} pz</div></div>${renderMap(comp.scatole, (v)=>`${magFmtFraction(v)} pz`)}`);
      if(comp.divisori.size) compBlocks.push(`<div class="magRow"><div class="l">Divisori</div><div class="v">${magFmtFraction(Array.from(comp.divisori.values()).reduce((a,x)=>a+x,0))} pz</div></div>${renderMap(comp.divisori, (v)=>`${magFmtFraction(v)} pz`)}`);
      if(comp.altri.size) compBlocks.push(`<div class="magRow"><div class="l">Altri</div><div class="v">${magFmtFraction(Array.from(comp.altri.values()).reduce((a,x)=>a+x,0))} pz</div></div>${renderMap(comp.altri, (v)=>`${magFmtFraction(v)} pz`)}`);
      const ncHtml = comp.nonConfig.length ? `<div class="magRow"><div class="l">Distinta non configurata per:</div><div class="v">${comp.nonConfig.length}</div></div>` +
        comp.nonConfig.map(nc=>`<div class="magRow"><div class="l">${escapeHtml(nc.desc||"Prodotto")}<div class="s">Ord. ${escapeHtml(nc.orderNo||"—")} ${nc.packKg?`· ${nc.packKg} kg`:``}${nc.note?` · ${escapeHtml(nc.note)}`:""}</div></div><div class="v">${magFmtKg(nc.qtyKg||0)}</div></div>`).join("") : "";
      const warnHtml = comp.warnings.length ? `<div class="magRow" style="border-style:dashed;"><div class="l">Attenzione sacchi</div><div class="v" style="color:var(--warn);">${comp.warnings.length}</div></div><div class="muted" style="margin-top:6px;">${comp.warnings.map(w=>`• ${escapeHtml(w)}`).join("<br/>")}</div>` : "";
      return `<div class="item pressCard" style="background:#fff; border-color:rgba(0,0,0,.06);">
        <div class="top" style="gap:12px;">
          <div>
            <div class="name">${escapeHtml(order.customer||"Cliente")} · Ordine ${escapeHtml(order.orderNo||order.number||"")}</div>
            <div class="sub" style="margin-top:6px;">Conclusione prevista: <b>${escapeHtml(order.conclusion||"—")}</b></div>
          </div>
          <div class="badge" style="border-color:${stCol}; color:${stCol};">${stTxt}</div>
        </div>
        <div class="magBox" style="margin-top:10px;">${compBlocks.join("")||`<div class="muted">Nessun componente configurato.</div>`}</div>
        ${ncHtml?`<div class="magBox" style="margin-top:10px; background:rgba(255,243,224,.7);">${ncHtml}</div>`:""}
        ${warnHtml?`<div class="magBox" style="margin-top:10px; background:rgba(255,243,224,.7);">${warnHtml}</div>`:""}
      </div>`;
    }).join("");

    body.innerHTML = `<div class="magGrid">${panoHtml}<div class="magBox"><div class="magTitle">Dettaglio per cliente/ordine</div>${detailHtml}</div></div>`;
  }

  function renderHeaderKpis(){
    const kgEl = $("hdrMonthKg");
    const ordEl = $("hdrMonthOrders");
    if(!kgEl || !ordEl) return;
    let kgTxt = "—";
    let ordTxt = "—";
    try{
      if(state.user && state.historyReady){
        const hist = Array.isArray(state.history) ? state.history : [];
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const nameKey = norm(state.user.fullName||"");
        const filtered = hist.filter(h=>{
          const rawDate = h?.startedAt || h?.endedAt || h?.at;
          if(!rawDate) return false;
          const dt = new Date(rawDate);
          if(!Number.isFinite(dt.getTime())) return false;
          if(dt.getFullYear()!==y || dt.getMonth()!==m) return false;
          if(h.operatorUid && state.user.uid) return h.operatorUid === state.user.uid;
          if(nameKey) return norm(h.operator||"") === nameKey;
          return false;
        });
        if(filtered.length){
          const totKg = filtered.reduce((a,h)=>{
            const v = Number(h.kg);
            return Number.isFinite(v) ? a + v : a;
          }, 0);
          kgTxt = Number.isFinite(totKg) ? Math.round(totKg).toLocaleString("it-IT") : "—";
          ordTxt = String(filtered.length);
        } else {
          kgTxt = "0";
          ordTxt = "0";
        }
      }
    }catch(_e){}
    kgEl.textContent = kgTxt;
    ordEl.textContent = ordTxt;
  }

  // ===============================
  // NOTIFICATIONS (inbox + badge)
  // ===============================
  let notifReadCache = null;
  function getNotifReadSet(){
    if(notifReadCache instanceof Set) return notifReadCache;
    try{
      const raw = localStorage.getItem(NOTIF_READ_KEY) || "[]";
      const arr = JSON.parse(raw);
      notifReadCache = new Set(Array.isArray(arr) ? arr.filter(Boolean) : []);
    }catch(_e){
      notifReadCache = new Set();
    }
    return notifReadCache;
  }
  function saveNotifReadSet(set){
    try{ localStorage.setItem(NOTIF_READ_KEY, JSON.stringify(Array.from(set||[]))); }catch(_e){}
    notifReadCache = set instanceof Set ? set : new Set();
  }
  function markNotificationsRead(ids){
    if(!ids || !ids.length) return;
    const set = getNotifReadSet();
    let changed = false;
    for(const id of ids){
      if(id && !set.has(id)){
        set.add(id);
        changed = true;
      }
    }
    if(changed) saveNotifReadSet(set);
  }
  function markAllNotificationsRead(){
    const ids = (state.notifications?.inbox || []).map(n=>n.id).filter(Boolean);
    markNotificationsRead(ids);
    updateNotificationBadge();
  }
  function notifUnreadCount(){
    const set = getNotifReadSet();
    const inbox = (state.notifications && Array.isArray(state.notifications.inbox)) ? state.notifications.inbox : [];
    let n = 0;
    for(const it of inbox){
      if(it && it.id && !set.has(it.id)) n++;
    }
    return n;
  }
  function updateNotificationBadge(){
    const badge = $("pillPushBadge");
    if(!badge) return;
    const unread = notifUnreadCount();
    if(unread>0){
      badge.textContent = unread>99 ? "99+" : String(unread);
      badge.style.display = "inline-flex";
    } else {
      badge.style.display = "none";
    }
  }
  function renderNotifCenter(){
    const list = $("notifList");
    const empty = $("notifEmpty");
    const status = $("notifStatus");
    const unavailable = $("notifUnavailable");
    const adminBox = $("notifAdminBox");
    const toggleBtn = $("btnTogglePush");
    const sub = $("notifSub");
    if(adminBox) adminBox.style.display = state.user && state.user.isAdmin ? "block" : "none";
    const notifs = (state.notifications && Array.isArray(state.notifications.inbox)) ? state.notifications.inbox : [];
    const isUnavailable = Boolean(state.notifications?.unavailable || !state.firebase.ok);
    if(unavailable) unavailable.style.display = isUnavailable ? "flex" : "none";
    if(sub) sub.textContent = isUnavailable ? "UI non disponibile (permessi Firebase)." : "Push, messaggi interni e registro.";
    if(status){
      if(isUnavailable){
        status.textContent = "Centro notifiche non disponibile (permessi o connessione).";
      } else if(state.notifications?.ready){
        status.textContent = notifs.length ? `${notifs.length} notifiche recenti` : "Nessuna notifica recente";
      } else {
        status.textContent = "Caricamento notifiche…";
      }
    }
    if(list){
      list.innerHTML = "";
      if(!isUnavailable && notifs.length){
        const readSet = getNotifReadSet();
        const frag = document.createDocumentFragment();
        for(const n of notifs){
          const div = document.createElement("div");
          const isUnread = n?.id && !readSet.has(n.id);
          div.className = `notifItem${isUnread ? " unread" : ""}`;
          let dateTxt = "—";
          try{
            const raw = n?.createdAt;
            const dt = raw && typeof raw.toDate==="function" ? raw.toDate() : raw ? new Date(raw) : null;
            if(dt && Number.isFinite(dt.getTime())) dateTxt = fmtDateTime(dt);
          }catch(_e){}
          const creator = n?.createdBy ? ` · Da ${escapeHtml(n.createdBy)}` : "";
          div.innerHTML = `
            <div class="notifTitle">${escapeHtml(n?.title || "Aggiornamento")}</div>
            <div class="notifBody">${escapeHtml(n?.body || "")}</div>
            <div class="notifMeta"><span>${escapeHtml(dateTxt)}</span>${creator?`<span>${creator}</span>`:""}</div>`;
          frag.appendChild(div);
        }
        list.appendChild(frag);
      }
      if(empty) empty.style.display = (!isUnavailable && state.notifications?.ready && !notifs.length) ? "block" : "none";
    }
    if(toggleBtn){
      const perm = (typeof Notification !== "undefined") ? Notification.permission : "unsupported";
      toggleBtn.textContent = perm === "granted" ? "Disattiva push" : "Attiva push";
    }
    updateNotificationBadge();
  }
  async function initNotificationsInbox(){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    if(state.notifUnsub){
      try{ state.notifUnsub(); }catch(_e){}
      state.notifUnsub = null;
    }
    try{
      const q = fs.query(
        fs.collection(db, NOTIF_COLLECTION),
        fs.orderBy("createdAt","desc"),
        fs.limit(NOTIF_LIMIT)
      );
      state.notifications.ready = false;
      state.notifications.unavailable = false;
      state.notifUnsub = fs.onSnapshot(q, (snap)=>{
        const arr = [];
        snap.forEach(doc=>arr.push({ id: doc.id, ...doc.data() }));
        state.notifications.inbox = arr;
        state.notifications.ready = true;
        state.notifications.unavailable = false;
        renderNotifCenter();
        updateNotificationBadge();
      }, (err)=>{
        console.warn("notif snapshot err", err);
        state.notifications.unavailable = true;
        state.notifications.ready = true;
        state.notifications.error = err?.code || String(err);
        renderNotifCenter();
      });
    }catch(err){
      console.warn("init notifications failed", err);
      state.notifications.unavailable = true;
      state.notifications.ready = true;
      state.notifications.error = err?.code || String(err);
      renderNotifCenter();
    }
  }
  async function sendAdminNotification(title, body){
    if(!state.firebase.ok) throw new Error("Firebase non disponibile");
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const col = fs.collection(db, NOTIF_COLLECTION);
    await fs.addDoc(col, {
      title: title || "Aggiornamento",
      body: body || "",
      line: "polveri",
      createdAt: fs.serverTimestamp(),
      createdBy: state.user?.fullName || "Admin",
      createdByUid: state.user?.uid || ""
    });
  }
  function openNotifModal(){
    const modal = $("notifModal");
    if(!modal) return;
    modal.classList.add("show");
    lockBody();
    renderNotifCenter();
    markAllNotificationsRead();
  }
  function closeNotifModal(){
    const modal = $("notifModal");
    if(!modal) return;
    modal.classList.remove("show");
    unlockBody();
    updateNotificationBadge();
  }
  function focusCompletedFromNotif(){
    closeNotifModal();
    const card = $("completedCard");
    if(card){
      card.scrollIntoView({ behavior:"smooth", block:"start" });
      card.classList.add("pressCard");
      setTimeout(()=>card.classList.remove("pressCard"), 1200);
    }
  }
  async function togglePushFromCenter(){
    if(typeof Notification === "undefined"){
      showToast("Non supportato", "Questo browser non supporta le notifiche.");
      return;
    }
    const perm = Notification.permission;
    if(perm === "granted"){
      const ok = confirm("Vuoi DISATTIVARE le notifiche push su questo dispositivo?");
      if(ok) await pushDisableFlow();
    } else {
      await pushEnableFlow();
    }
    renderNotifCenter();
    updatePushPill();
  }

  // ===============================
  // PRODUCTION MODAL FLOW
  // ===============================
  function openProdModal(){
    if(!state.user){
      renderAuthLogin("Per iniziare un ordine devi prima accedere con un account autorizzato.");
      return;
    }
    state.prodModalOpenedAt = Date.now();
    state.startedThisSession = false;
    state.prodModalTouched = false;
    $("prodModal").classList.add("show");
    lockBody();
    updateSelectionCounter();
    renderProdStepOrders();
  }

  function closeProdModalRequest(){
    // UI-FIX: remove-motivazione
    $("prodModal").classList.remove("show");
    unlockBody();
  }

  function renderPartialOrdersList(){
    const body = $("partialBody");
    if(!body) return;
    let partial = [];
    try{ partial = computePartialOrders().partial || []; }catch(_e){ partial = []; }
    const partialSet = new Set(partial.map(p=>String(p.orderNo||p.number||"")));
    const { baseOrders } = buildOrderViews({ applyRoleVisibility:false, includeHidden:true });
    const rows = baseOrders.filter(o=>partialSet.has(String(o.orderNo||o.number||"")));
    if(!rows.length){
      body.innerHTML = `<div class="muted">Nessun ordine parzialmente concluso.</div>`;
      return;
    }
    body.innerHTML = `<div class="list" id="partialList"></div>`;
    const list = body.querySelector("#partialList");
    rows.forEach(o=>{
      const done = o.partialInfo?.done || 0;
      const total = o.partialInfo?.total || (done + (o.lines?.length||0) + (o.autoDone||0));
      const div = document.createElement("div");
      div.className = "item pressCard";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${escapeHtml(o.customer||"Cliente")} · Ordine ${escapeHtml(o.orderNo||o.number||"")}</div>
            <div class="sub">Conclusione prevista: <b>${escapeHtml(o.conclusion||"—")}</b></div>
            <div class="muted" style="margin-top:6px;">Righe concluse: ${done}/${total} · Kg: ${Math.round(o.totalKg||0)}</div>
          </div>
          <div class="badge" style="border-color:var(--warn); color:var(--warn);">Parziale</div>
        </div>`;
      div.onclick = ()=>{
        $("partialModal").classList.remove("show");
        unlockBody();
        openProdModal();
        setTimeout(()=>renderOrderDetail(o), 60);
      };
      list.appendChild(div);
    });
  }

  async function startSelectedProductions(contextOrder){
    const { baseOrders } = buildOrderViews({ applyRoleVisibility:false, includeHidden:true });
    pruneSelectionAgainstOrders(baseOrders);
    const groups = groupSelectionByOrder();
    updateSelectionCounter();
    if(!groups.size){
      showToast("Seleziona righe", "Non hai selezionato righe da avviare.");
      return;
    }
    const opName = (state.user?.fullName || state.operator || 'Operatore');
    const baseMap = new Map(baseOrders.map(o=>[`${o.orderNo||o.number||""}__${o.customer||""}`, o]));
    let launched = 0;
    let totalLines = 0;
    for(const [key, group] of groups.entries()){
      const base = baseMap.get(key);
      if(!base) continue;
      const availableLines = (base.lines||[]).filter(l=>l.status!=="active");
      const selectedKeys = new Set((group.lines||[]).map(l=>String(l.lineKey||"")));
      const selectedLines = availableLines.filter(l=>selectedKeys.has(String(l.lineKey||"")));
      if(!selectedLines.length) continue;
      const isFullOrderStart = availableLines.length>0 && availableLines.every(l=>selectedKeys.has(String(l.lineKey||"")));
      const totalKg = selectedLines.reduce((a,l)=>a + estimateLineKg(l), 0) || base.totalKg || 0;
      const prod = {
        operator: opName,
        customer: base.customer,
        orderNo: base.orderNo || base.number,
        conclusion: base.conclusion || "",
        totalKg,
        selectedLineKeys: selectedLines.map(l=>l.lineKey),
        isFullOrderStart,
        startedAt: nowIso(),
        active: true
      };
      await upsertActiveProduction(prod);
      const machineHint = machineHintFromLines(selectedLines);
      const machineMsg = machineHint==="small" ? " Utilizzare macchina piccola per fare questo ordine." : " Utilizzare macchina grande.";
      speak(`Ordine: operatore ${opName} ha avviato ordine ${prod.orderNo} del cliente ${prod.customer}.${machineMsg}`);
      launched++;
      totalLines += selectedLines.length;
    }
    if(!launched){
      showToast("Selezione non valida", "Seleziona righe non già in produzione.");
      return;
    }
    state.startedThisSession = true;
    ensureSelectionState().clear();
    updateSelectionCounter();
    $("prodModal").classList.remove("show");
    unlockBody();
    const targetOrder = contextOrder ? `Ordine n. ${contextOrder.orderNo||contextOrder.number||""}` : "Ordini selezionati";
    showToast("Produzione avviata", `${targetOrder} · ${launched} ordini · ${totalLines} righe`);
  }

  function renderProdStepOperator(){
    // (disattivato) operatore già identificato da accesso
    renderProdStepOrders();
  }

  function renderProdStepOrders(){
    $("prodModalTitle").textContent = "Produzione · Ordini";
    const body = $("prodModalBody");
    const { orders, baseOrders } = buildOrderViews();
    pruneSelectionAgainstOrders(baseOrders);
    updateSelectionCounter();
    orders.sort((a,b)=>{
      const ra = a.priorityInfo?.priority==="today" ? 0 : a.priorityInfo?.priority==="scheduled" ? 1 : 2;
      const rb = b.priorityInfo?.priority==="today" ? 0 : b.priorityInfo?.priority==="scheduled" ? 1 : 2;
      return ra - rb;
    });
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    const isAdmin = Boolean(state.user && state.user.isAdmin);
    let planMessageHtml = "";
    if(isDesktop){
      if(isAdmin){
        planMessageHtml = `<div class="planMessage"><div class="headline">Vista admin</div><div class="muted">Tutti gli ordini (anche oltre 3 giorni) sono visibili per la pianificazione.</div></div>`; // CODEX: messaggio visibilità admin desktop
      } else {
        const windowOrders = baseOrders.filter(o=>o.daysAway==null || o.daysAway<=3);
        const listHtml = windowOrders.slice(0,8).map(o=>`<li>${escapeHtml(o.customer||"Cliente")} · Ord. ${escapeHtml(o.orderNo||o.number||"—")}${o.conclusion?` · ${escapeHtml(o.conclusion)}`:""}</li>`).join("") || `<li>Nessuna data pianificata disponibile.</li>`;
        planMessageHtml = `<div class="planMessage"><div class="headline">Ci sono ${baseOrders.length} ordini da fare. In base alla pianificazione, puoi andare in produzione con questi ${windowOrders.length} ordini:</div><ul>${listHtml}</ul></div>`; // CODEX: messaggio finestra 3 giorni per operatori desktop
      }
    }
    body.innerHTML = `
      <div class="stepTitle">Ordini disponibili</div>
      <div class="muted">Operatore: <b>${state.user?.fullName || "—"}</b>. Tocca un cliente: vedrai gli ordini separati per numero.</div>
      ${planMessageHtml}
      <div style="height:10px"></div>
      <div class="list" id="orderList"></div>
    `;

    const list = body.querySelector("#orderList");
    if(!orders.length){
      const windowHasOrders = baseOrders.some(o=>o.daysAway==null || o.daysAway<=3);
      const emptyMsg = (isDesktop && !isAdmin && baseOrders.length && !windowHasOrders)
        ? "Nessun ordine pianificato entro i prossimi 3 giorni."
        : "Nessun ordine disponibile (attendi sincronizzazione).";
      list.innerHTML = `<div class="muted">${emptyMsg}</div>
        <div style="height:10px"></div>
        <button class="btn" id="btnRetry" style="width:100%;">Riprova sincronizzazione</button>`;
      body.querySelector("#btnRetry").onclick = async()=>{
        body.querySelector("#btnRetry").textContent = "Sincronizzo…";
        await syncOrders(false);
        renderProdStepOrders();
      };
      return;
    }

    const byCust = new Map();
    for(const o of orders){
      const key = o.customer || "Cliente";
      if(!byCust.has(key)) byCust.set(key, []);
      byCust.get(key).push(o);
    }

    for(const [cust, arr] of byCust.entries()){
      const sec = document.createElement("div");
      sec.className = "item";
      sec.innerHTML = `<div class="top"><div><div class="name">${cust}</div><div class="sub">${arr.length} ordini</div></div><div class="badge">Apri</div></div>`;
      sec.style.cursor = "pointer";
      sec.onclick = ()=>{ renderCustomerOrders(cust, arr); };
      list.appendChild(sec);
    }
  }

  function renderCustomerOrders(cust, orders){
    $("prodModalTitle").textContent = `Produzione · ${cust}`;
    const body = $("prodModalBody");
    body.innerHTML = `
      <div class="stepTitle">Ordini per ${cust}</div>
      <div class="muted">Ordini separati per numero. Apri un ordine per vedere le righe.</div>
      <div style="height:10px"></div>
      <div class="list" id="custOrders"></div>
      <div style="height:12px"></div>
      <button class="btn ghost" id="btnBackOrders" style="width:100%;">← Torna alla lista clienti</button>
    `;
    body.querySelector("#btnBackOrders").onclick = renderProdStepOrders;

    const list = body.querySelector("#custOrders");
    for(const o of orders){
      const div = document.createElement("div");
      div.className = "item";
      div.style.cursor = "pointer";
      const totalQty = o.lines.reduce((a,l)=>a + Number(l.qty||0), 0);
      const priority = o.priorityInfo?.priority || "normal";
      const badgeText = priority==="today" ? "Priorità" : o.partialInfo ? "Parziale" : "Apri";
      const alertTag = (o.alerts&&o.alerts.length) ? `<div class="muted" style="margin-top:6px;">Avvisi: ${o.alerts.length}</div>` : "";
      const selectedCount = selectedEntriesForOrder(o).length;
      const selectionTag = selectedCount ? `<div class="muted" style="margin-top:6px; color:rgba(10,58,125,.92); font-weight:900;">Righe selezionate: ${selectedCount}</div>` : "";
      div.innerHTML = `
        <div class="top">
          <div>
            <div class="name">Ordine n. ${o.orderNo || o.number}</div>
            <div class="sub">Righe: ${o.lines.length} · Quantità: ${formatQtyWithKg(totalQty, "kg")} · Conclusione: ${o.conclusion||"—"}</div>
            ${o.partialInfo ? `<div class="muted" style="margin-top:6px;">Ordine parzialmente concluso (${o.partialInfo.done}/${o.partialInfo.total}).</div>`:""}
            ${o.priorityInfo?.reason ? `<div class="muted" style="margin-top:6px;">${escapeHtml(o.priorityInfo.reason)}</div>`:""}
            ${alertTag}
            ${selectionTag}
          </div>
          <div class="badge">${badgeText}</div>
        </div>`;
      div.onclick = ()=>renderOrderDetail(o);
      list.appendChild(div);
    }
  }

  function renderOrderDetail(order){
    const orderNo = order.orderNo || order.number;
    $("prodModalTitle").textContent = `Ordine n. ${orderNo}`;
    const body = $("prodModalBody");
    const lines = order.lines || [];
    const alerts = order.alerts || [];
    const alertHtml = alerts.length ? `<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${alerts.map(a=>{
      const palette = alertPalette(a.alertInfo?.color);
      const style = `background:${palette.bg};border-color:${palette.border};color:${palette.color};${palette.shadow?`box-shadow:${palette.shadow};`:``}`;
      return `<div class="alertBanner" style="${style}"><div class="label">${escapeHtml(a.desc||a.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`;
    }).join("")}</div>` : "";
    body.innerHTML = `
      <div class="stepTitle">${order.customer}</div>
      <div class="muted">Seleziona le righe da produrre, poi avvia. (Seleziona tutto = ordine completo)</div>
      ${order.partialInfo ? `<div class="warnBanner" style="margin:10px 0 6px;">
        <div class="icon">ℹ️</div>
        <div class="txt">
          <div class="t">Ordine parzialmente concluso</div>
          <div class="s">Restano ${order.partialInfo.total - order.partialInfo.done} righe da completare.</div>
        </div>
      </div>` : ``}
      ${alertHtml}
      ${order.conclusion ? `<div class="muted" style="margin:6px 0 8px; font-weight:800;">Conclusione prevista: <b>${escapeHtml(order.conclusion)}</b></div>`:""}
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAll">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAll">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="lineList"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnStartProd" style="width:100%;">INIZIA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackCust" style="width:100%;">← Torna agli ordini cliente</button>
    `;

    const globalSelection = ensureSelectionState();
    const selected = new Set(selectedEntriesForOrder(order).map(x=>String(x.lineKey)));
    const lineList = body.querySelector("#lineList");

    function rerenderLines(){
      selected.clear();
      selectedEntriesForOrder(order).forEach(x=>selected.add(String(x.lineKey)));
      lineList.innerHTML = "";
      lines.forEach((l)=>{
        const id = l.lineKey;
        const selectionKey = makeSelectionKey(order, l);
        const div = document.createElement("div");
        const checked = selected.has(id) || globalSelection.has(selectionKey);
        const isBlocked = l.status === "active";
        div.className = `item pressCard selectableLine${checked ? " selected" : ""}`;
        div.style.cursor = isBlocked ? "not-allowed" : "pointer";
        const qtyLabel = formatQtyWithKg(l.qty, l.um);
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${l.desc}</div>
              <div class="sub" style="font-size:13px; font-weight:900;">Quantità: <span style="font-size:15px;">${qtyLabel}</span></div>
              ${l.code?`<div class="muted" style="margin-top:6px;">Cod: <b>${l.code}</b></div>`:""}
              ${l.conclusion ? `<div class="muted" style="margin-top:6px;">Conclusione prevista: ${escapeHtml(l.conclusion)}</div>`:""}
              ${isBlocked ? `<div class="muted" style="margin-top:6px; font-weight:800;">In produzione da ${escapeHtml(l.activeOp||"operatore")} · riapri la produzione in corso.</div>` : ""}
            </div>
            <div class="badge">${checked ? "✓" : (isBlocked ? "Bloccato" : "Seleziona")}</div>
          </div>
        `;
        if(!isBlocked){
          div.onclick = ()=>{
            const meta = {
              orderNo,
              customer: order.customer,
              lineKey: l.lineKey,
              desc: l.desc,
              qty: l.qty,
              um: l.um,
              packKg: l.packKg,
              lineKg: l.lineKg,
              conclusion: l.conclusion || order.conclusion || "",
              orderConclusion: order.conclusion || "",
              totalKg: order.totalKg || 0
            };
            if(selected.has(id) || globalSelection.has(selectionKey)){
              selected.delete(id);
              globalSelection.delete(selectionKey);
            } else {
              selected.add(id);
              globalSelection.set(selectionKey, meta);
            }
            state.prodModalTouched = true;
            rerenderLines();
            updateSelectionCounter();
          };
        } else {
          div.onclick = ()=> showToast("In produzione", `Riga già avviata da ${l.activeOp||"un operatore"}.`);
        }
        lineList.appendChild(div);
      });
      const totalSelected = selectionCount();
      const startBtn = body.querySelector("#btnStartProd");
      startBtn.disabled = totalSelected===0;
      startBtn.style.opacity = totalSelected===0 ? ".6" : "1";
      startBtn.textContent = totalSelected>0 ? `INIZIA PRODUZIONE (${totalSelected})` : "INIZIA PRODUZIONE";
    }

    body.querySelector("#btnSelAll").onclick = ()=>{
      lines.filter(l=>l.status!=="active").forEach(l=>{
        selected.add(l.lineKey);
        const key = makeSelectionKey(order, l);
        globalSelection.set(key, {
          orderNo,
          customer: order.customer,
          lineKey: l.lineKey,
          desc: l.desc,
          qty: l.qty,
          um: l.um,
          packKg: l.packKg,
          lineKg: l.lineKg,
          conclusion: l.conclusion || order.conclusion || "",
          orderConclusion: order.conclusion || "",
          totalKg: order.totalKg || 0
        });
      });
      state.prodModalTouched = true;
      rerenderLines();
      updateSelectionCounter();
    };
    body.querySelector("#btnClrAll").onclick = ()=>{
      clearSelectionForOrder(order);
      selected.clear();
      state.prodModalTouched = true;
      rerenderLines();
      updateSelectionCounter();
    };
      body.querySelector("#btnBackCust").onclick = ()=>{
        const custOrders = buildOrderViews().orders.filter(o=>o.customer===order.customer);
        renderCustomerOrders(order.customer, custOrders);
      };

      body.querySelector("#btnStartProd").onclick = async()=>{
      if(selectionCount()===0) return;
      await startSelectedProductions(order);
      };

    rerenderLines();
  }

  // ===============================
  // RUNNING MODAL
  // ===============================
  function openRunningModal(){
    $("runningModal").classList.add("show");
    lockBody();
    renderRunning();
  }

  function renderRunning(){
    const body = $("runningBody");
    const active = state.activeProductions || [];
    if(!active.length){
      body.innerHTML = `<div class="muted">Nessuna produzione attiva al momento.</div>`;
      return;
    }
    body.innerHTML = `<div class="stepTitle">Attività in corso</div><div class="muted">Apri per vedere dettagli e concludere la produzione.</div><div style="height:10px"></div><div class="list" id="runList"></div>`;
    const list = body.querySelector("#runList");

    active
      .sort((a,b)=> (new Date(a.startedAt||0)) - (new Date(b.startedAt||0)))
      .forEach(p=>{
        const elapsedMin = p.startedAt ? Math.floor((Date.now() - new Date(p.startedAt).getTime())/60000) : 0;
        const ratio = prodRatio(p);
        const hue = Math.max(0, 120 - (120 * Math.min(1,ratio)));
        const div = document.createElement("div");
        div.className = "item";
        div.style.cursor = "pointer";
        div.style.borderColor = `hsla(${hue}, 80%, 55%, .35)`;
        div.style.background = `hsla(${hue}, 80%, 45%, .14)`;
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="name">${p.operator||"Operatore"} · Ordine n. ${p.orderNo||"—"}</div>
              <div class="sub">${p.customer||"Cliente"} · ${Math.round(Number(p.totalKg||0))} kg · In corso da ${elapsedMin} min · Conclusione: ${p.conclusion||"—"}</div>
            </div>
            <div class="badge">Apri</div>
          </div>
        `;
        div.onclick = ()=>renderRunningDetail(p);
        list.appendChild(div);
      });
  }

  function renderRunningDetail(p){
    const body = $("runningBody");
    const order = state.powderOrders.find(o=>o.number===p.orderNo && o.customer===p.customer) || null;
    const selected = new Set(p.selectedLineKeys || []);
    const toConclude = new Set(selected);
    const producedKg = new Map();

    const availableLines = order ? order.lines.filter(l=>selected.has(l.lineKey)) : [];
    const alerts = order?.alerts || [];
    const alertHtml = alerts.length ? `<div style="display:flex; flex-direction:column; gap:8px; margin:10px 0 6px;">${alerts.map(a=>{
      const palette = alertPalette(a.alertInfo?.color);
      const style = `background:${palette.bg};border-color:${palette.border};color:${palette.color};${palette.shadow?`box-shadow:${palette.shadow};`:``}`;
      return `<div class="alertBanner" style="${style}"><div class="label">${escapeHtml(a.desc||a.alertInfo?.label||"Avviso operativo")}</div><div class="hint">Avviso operativo</div></div>`;
    }).join("")}</div>` : "";
    body.innerHTML = `
      <div class="stepTitle">${p.operator||"Operatore"} · Ordine n. ${p.orderNo}</div>
      <div class="muted">${p.customer} · Seleziona cosa stai concludendo, poi premi “Ho concluso la produzione”.</div>
      ${alertHtml}
      <div style="height:10px"></div>
      <div class="row2">
        <button class="btn" id="btnSelAllRun">Seleziona tutto</button>
        <button class="btn ghost" id="btnClrAllRun">Deseleziona</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="runLines"></div>
      <div style="height:12px"></div>
      <button class="btn good" id="btnConclude" style="width:100%;">HO CONCLUSO LA PRODUZIONE</button>
      <div style="height:10px"></div>
      <button class="btn bad" id="btnCancelProd" style="width:100%;">Annulla produzione in corso</button>
      <div style="height:10px"></div>
      <button class="btn ghost" id="btnBackRun" style="width:100%;">← Torna a elenco produzioni</button>
    `;

    const runLines = body.querySelector("#runLines");
    function rerender(){
      runLines.innerHTML = "";
      for(const l of availableLines){
        const checked = toConclude.has(l.lineKey);
        const div = document.createElement("div");
        div.className = `item pressCard selectableLine${checked ? " selected" : ""}`;
        const lineConclusion = l.conclusion || (order?.conclusion || "");
        div.style.cursor = "pointer";
        div.style.borderColor = checked ? "rgba(46,123,255,.55)" : "rgba(255,255,255,.12)";
        const isWhiteBag = isWhiteBagRow(l); // CODEX: riga solo banner se sacchetto bianco
        if(isWhiteBag){
          div.innerHTML = renderWhiteBagBanner({ selectable: true, checked });
        } else {
          const qtyLabel = formatQtyWithKg(l.qty, l.um);
          div.innerHTML = `
            <div class="top">
              <div>
                <div class="name">${l.desc}</div>
                <div class="sub">Quantità: ${qtyLabel} · Cod: ${l.code||"—"}${lineConclusion?` · Conclusione: ${lineConclusion}`:""}</div>
                <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
                  <div class="muted" style="font-size:12px; font-weight:900; min-width:150px;">Quantità prodotta (kg, opzionale)</div>
                  <input class="kgInput" data-k="${l.lineKey}" type="number" inputmode="decimal" step="0.1" placeholder="auto" style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--stroke); background: rgba(0,0,0,.02); font-weight:900;"/>
                </div>
              </div>
              <div class="badge">${checked ? "✓" : "Seleziona"}</div>
            </div>`;
          const inp = div.querySelector(".kgInput");
          if(inp){
            const prev = producedKg.get(l.lineKey);
            if(prev!=null) inp.value = prev;
            inp.addEventListener("click", (e)=>e.stopPropagation());
            inp.addEventListener("touchstart", (e)=>e.stopPropagation(), {passive:true});
            inp.addEventListener("input", ()=>{ producedKg.set(l.lineKey, inp.value); });
          }
        }

        div.onclick = ()=>{
          if(toConclude.has(l.lineKey)) toConclude.delete(l.lineKey); else toConclude.add(l.lineKey);
          rerender();
        };
        runLines.appendChild(div);
      }
      $("btnConclude").disabled = toConclude.size===0;
      $("btnConclude").style.opacity = toConclude.size===0 ? ".6" : "1";
    }

    body.querySelector("#btnSelAllRun").onclick = ()=>{
      for(const k of selected) toConclude.add(k);
      rerender();
    };
    body.querySelector("#btnClrAllRun").onclick = ()=>{
      toConclude.clear();
      rerender();
    };
    body.querySelector("#btnBackRun").onclick = renderRunning;

    const canCancel = Boolean(state.user && state.user.isAdmin);
    if(!canCancel){
      body.querySelector("#btnCancelProd").style.display = "none";
    } else {
      body.querySelector("#btnCancelProd").onclick = async()=>{
        if(!confirm("Sei sicuro che vuoi annullare la produzione in corso?")) return;
        await closeActiveProduction(p.id, { cancelled:true });
        showToast("Produzione annullata", `Ordine n. ${p.orderNo} · ${p.customer}`);
        showCancelBanner(`Ordine n. ${p.orderNo} · ${p.customer}`);
        setTimeout(()=>hideCancelBanner(), 6500);
        renderRunning();
        renderHome();
      };
    }

    body.querySelector("#btnConclude").onclick = async()=>{
      if(!toConclude.size) return;

      const allStarted = toConclude.size === selected.size;
      const askConfirm = Boolean(p.isFullOrderStart) && allStarted;
      if(askConfirm && !confirm("Stai concludendo l’intero ordine. Confermi?")) return;

      const startedAtMs = p.startedAt ? new Date(p.startedAt).getTime() : Date.now();
      const durationMs = Date.now() - startedAtMs;

      // calcolo kg + dettagli righe
      let kg = 0;
      const perLine = [];
      if(order){
        const m = new Map(order.lines.map(l=>[l.lineKey,l]));
        for(const k of toConclude){
          const l = m.get(k);
          if(!l) continue;
          const raw = producedKg.get(k);
          const val = raw!=null && String(raw).trim()!=="" ? Number(String(raw).replace(",", ".")) : NaN;
          const fallback = Number(l.qty||0);
          const prodVal = Number.isFinite(val) ? val : (Number.isFinite(fallback) ? fallback : (l.lineKg||0));
          kg += prodVal;
          perLine.push({
            lineKey: k,
            desc: l.desc,
            code: l.code || "",
            plannedKg: Number(l.lineKg||0),
            producedKg: Number(prodVal||0),
            qty: l.qty,
            um: l.um || ""
          });
        }
      } else {
        kg = Number(p.totalKg||0);
      }

      const ctx = `${p.customer} · Ordine n. ${p.orderNo} · ${Math.round(kg)} kg`;
      openSignModal(ctx, async(signatureDataUrl)=>{
        await closeActiveProduction(p.id, { concluded:true });

        const entry = {
          operator: (state.user?.fullName || p.operator || "Operatore"),
          operatorUid: state.user?.uid || "",
          customer: p.customer,
          orderNo: p.orderNo,
          kg,
          durationMs,
          startedAt: p.startedAt || nowIso(),
          endedAt: nowIso(),
          concludedLineKeys: Array.from(toConclude),
          totalKgOrder: Number(p.totalKg||0),
          perLine,
          signature: signatureDataUrl,
          statementAccepted: true
        };

        const newId = await addHistory(entry);
        const withId = { ...entry, id: newId || `${Date.now()}_${Math.random().toString(16).slice(2)}`, at: nowIso() };
        state.history = [...(state.history||[]), withId];
        state.historyReady = true;
        try{ renderCompletedSection(); }catch(_e){}
        state.activeProductions = (state.activeProductions||[]).filter(x=>x.id!==p.id);
        try{ state.partialOrders = computePartialOrders().partial; }catch(_e){}
        renderHome();
        renderHeaderKpis();

        // aggiorna classifica kg (aggregato)
        try{
          await bumpOperatorKg(state.user?.uid || "", state.user?.fullName || p.operator || "Operatore", kg);
        }catch(_e){}

        speak(`Ordine concluso da ${(state.user?.fullName||p.operator||"Operatore")} · ordine ${p.orderNo} · cliente ${p.customer}`);

        showToast("Produzione conclusa", `Operatore ${(state.user?.fullName||p.operator||"Operatore")} · Ordine n. ${p.orderNo} · ${Math.round(kg)} kg`);
        showToast("Ordine concluso", `Ordine n. ${p.orderNo} registrato tra i conclusi.`, 2200);
        renderRunning();
      });
    };

    rerender();
  }

  function openPartialModal(){
    $("partialModal").classList.add("show");
    lockBody();
    renderPartialOrdersList();
  }
  function closePartialModal(){
    $("partialModal").classList.remove("show");
    unlockBody();
  }

  
  // ===============================
  // SIGNATURE PAD
  // ===============================
  const sig = { canvas:null, ctx:null, drawing:false, empty:true, last:{x:0,y:0}, dpr:1 };
  function sigInit(){
    if(sig.canvas){ sig.resize?.(); return; }
    sig.canvas = $("signCanvas");
    sig.canvas.style.touchAction = "none";
    sig.canvas.style.pointerEvents = "auto";
    sig.ctx = sig.canvas.getContext("2d");
    sig.ctx.lineCap = "round";
    sig.ctx.lineJoin = "round";
    sig.ctx.lineWidth = 3.2;
    sig.ctx.strokeStyle = "#000";

    function resize(){
      const rect = sig.canvas.getBoundingClientRect();
      sig.dpr = Math.max(1, window.devicePixelRatio || 1);
      sig.canvas.width = Math.floor(rect.width * sig.dpr);
      sig.canvas.height = Math.floor(rect.height * sig.dpr);
      sig.ctx.setTransform(sig.dpr,0,0,sig.dpr,0,0);
      sig.ctx.clearRect(0,0,rect.width,rect.height);
      sig.empty = true;
    }
    sig.resize = resize;
    resize();
    window.addEventListener("resize", resize);

    function pos(e){
      const rect = sig.canvas.getBoundingClientRect();
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      return { x: p.clientX - rect.left, y: p.clientY - rect.top };
    }
    function down(e){
      e.preventDefault();
      sig.drawing = true;
      const p = pos(e);
      sig.last = p;
    }
    function move(e){
      if(!sig.drawing) return;
      e.preventDefault();
      const p = pos(e);
      sig.ctx.beginPath();
      sig.ctx.moveTo(sig.last.x, sig.last.y);
      sig.ctx.lineTo(p.x, p.y);
      sig.ctx.stroke();
      sig.last = p;
      sig.empty = false;
    }
    function up(e){
      if(!sig.drawing) return;
      e.preventDefault();
      sig.drawing = false;
    }

    sig.canvas.addEventListener("pointerdown", down);
    sig.canvas.addEventListener("pointermove", move);
    window.addEventListener("pointerup", up);
    sig.canvas.addEventListener("touchstart", down, {passive:false});
    sig.canvas.addEventListener("touchmove", move, {passive:false});
    window.addEventListener("touchend", up, {passive:false});
  }

  function sigClear(){
    if(!sig.canvas) return;
    const rect = sig.canvas.getBoundingClientRect();
    sig.ctx.clearRect(0,0,rect.width,rect.height);
    sig.empty = true;
  }

  function openSignModal(contextText, onOk){
    sigInit();
    $("signCheck").checked = false;
    $("signContext").textContent = contextText;
    sigClear();
    $("signModal").classList.add("show");
    lockBody();
    requestAnimationFrame(()=> sig.resize?.()); // CODEX: forza ridimensionamento firma quando visibile

    const close = ()=>{
      $("signModal").classList.remove("show");
      unlockBody();
      $("signOk").onclick = null;
    };

    $("signClose").onclick = close;
    $("signClear").onclick = ()=>sigClear();
    $("signOk").onclick = ()=>{
      if(!$("signCheck").checked){
        showToast("Conferma richiesta", "Spunta la dichiarazione prima di concludere.");
        return;
      }
      if(sig.empty){
        showToast("Firma richiesta", "Inserisci la firma prima di concludere.");
        return;
      }
      const dataUrl = sig.canvas.toDataURL("image/png");
      close();
      onOk(dataUrl);
    };
  }


  // ===============================
  // HOME interactions
  // ===============================
  $("btnGoProd").addEventListener("click", ()=> handlePrimaryCta());
  try{
    const pb = $("partialBanner");
    pb?.addEventListener("click", ()=> openPartialModal());
    pb?.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openPartialModal(); } });
  }catch(_e){}
  try{ $("partialClose").addEventListener("click", ()=> closePartialModal()); }catch(_e){}
  try{ $("partialModal").addEventListener("click", (e)=>{ if(e.target===$("partialModal")) closePartialModal(); }); }catch(_e){}
  $("prodStrip").addEventListener("click", ()=> openRunningModal());
  try{ $("cancelBannerClose").addEventListener("click", ()=> hideCancelBanner()); }catch(_e){}

  $("prodModalClose").addEventListener("click", ()=> closeProdModalRequest());
  $("runningClose").addEventListener("click", ()=> { $("runningModal").classList.remove("show"); unlockBody(); });

  // History modal
  try{
    $("histClose").addEventListener("click", ()=>{ $("histModal").classList.remove("show"); unlockBody(); });
    $("histModal").addEventListener("click", (e)=>{ if(e.target===$("histModal")){ $("histModal").classList.remove("show"); unlockBody(); } });
  }catch(_e){}
  try{
    $("notifClose").addEventListener("click", ()=> closeNotifModal());
    $("notifModal").addEventListener("click", (e)=>{ if(e.target===$("notifModal")) closeNotifModal(); });
  }catch(_e){}
  try{ $("btnNotifCompleted").addEventListener("click", ()=> focusCompletedFromNotif()); }catch(_e){}
  try{ $("btnTogglePush").addEventListener("click", ()=> togglePushFromCenter()); }catch(_e){}
  try{
    $("btnSendNotif").addEventListener("click", async()=>{
      const fb = $("notifAdminFeedback");
      if(!(state.user && state.user.isAdmin)){
        showToast("Solo admin", "Non hai i permessi per inviare notifiche.");
        if(fb) fb.textContent = "Permesso mancante.";
        return;
      }
      const title = ($("notifTitle")?.value || "").trim();
      const body = ($("notifBodyInput")?.value || "").trim();
      if(!title || !body){
        showToast("Testo mancante", "Inserisci titolo e testo della notifica.");
        if(fb) fb.textContent = "Titolo e testo obbligatori.";
        return;
      }
      if(fb) fb.textContent = "Invio…";
      try{
        await sendAdminNotification(title, body);
        if(fb) fb.textContent = "Notifica inviata.";
        const bodyEl = $("notifBodyInput");
        if(bodyEl) bodyEl.value = "";
      }catch(err){
        console.warn("send notif error", err);
        if(fb) fb.textContent = "Invio non riuscito (permessi o rete).";
        showToast("Invio non riuscito", "Controlla i permessi Firestore o la rete.");
      }
    });
  }catch(_e){}

  // Fatturato reveal
  $("fatValue").addEventListener("click", ()=>{
    const el = $("fatValue");
    const isDesktop = window.matchMedia("(min-width: 980px)").matches;
    if(isDesktop){
      el.classList.add("reveal");
      updateFatturatoUI(); // CODEX: fatturato sempre visibile su desktop
      return;
    }
    el.classList.toggle("reveal");
    updateFatturatoUI();
  });

  // Call Matteo (numero fisso)
  const MATTEO_TEL = "+393516709334";
  $("btnCallMatteo").addEventListener("click", ()=>{
    window.location.href = `tel:${MATTEO_TEL}`;
  });

  // Stats helper
  $("btnOpenStats").addEventListener("click", ()=>{
    showToast("Statistiche", "Apri da desktop per vedere la classifica completa.");
    window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
  });

  // Issues (registrazione interna)
  $("btnSendIssue").addEventListener("click", async()=>{
    const txt = $("issueText").value.trim();
    if(!txt){
      showToast("Segnalazione", "Scrivi il problema prima di inviare.");
      return;
    }
    if(!state.user){
      renderAuthLogin("Per inviare una segnalazione è necessario accedere.");
      return;
    }
    const op = state.user.fullName || "Operatore";
    const payload = {
      operator: op,
      operatorUid: state.user.uid,
      text: txt,
      when: fmtDateTime(Date.now()),
      kind: "problema_macchina_o_prodotto",
      url: location.href,
      ua: navigator.userAgent
    };
    await addIssue(payload);
    $("issueText").value = "";
    showToast("Segnalazione registrata", "Ok. La segnalazione è stata salvata. Per urgenze: usa “Chiama Matteo”.", 3200);
  });

  document.addEventListener("visibilitychange", ()=>{
    if(!document.hidden) debounceRefresh("focus");
  });
  window.addEventListener("focus", ()=> debounceRefresh("focus"));
  window.addEventListener("pageshow", (e)=>{
    if(e.persisted || !document.hidden) debounceRefresh("pageshow");
  });
  try{ window.matchMedia("(min-width: 980px)").addEventListener("change", ()=> updateFatturatoUI()); }catch(_e){}

  document.documentElement.setAttribute("translate","no");
  document.body.setAttribute("translate","no");


  // Blocca zoom (mobile/Android)
  document.addEventListener("gesturestart", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("gesturechange", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("gestureend", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("wheel", (e)=>{ if(e.ctrlKey) e.preventDefault(); }, {passive:false});

  // ===============================
  // PUSH (PWA + FCM Web Push)
  // ===============================
  function isIOS(){
    return /iphone|ipad|ipod/i.test(navigator.userAgent || "");
  }
  function isStandalone(){
    // iOS: navigator.standalone; others: display-mode
    return (window.navigator.standalone === true) || window.matchMedia("(display-mode: standalone)").matches;
  }

  function updatePushPill(){
    const dot = $("#dotPush");
    const txt = $("#txtPush");
    if(!dot || !txt) return;

    const perm = (typeof Notification !== "undefined") ? Notification.permission : "unsupported";
    state.push.permission = perm;

    if(!state.push.supported){
      dot.className = "dot";
      txt.textContent = "Notifiche: non supportate";
      return;
    }
    if(perm !== "granted"){
      dot.className = "dot";
      txt.textContent = "Notifiche: disattive";
      return;
    }
    dot.className = "dot ok";
    txt.textContent = "Notifiche: attive";
  }

  async function registerPushSW(){
    if(!("serviceWorker" in navigator)) throw new Error("Service worker non supportati");
    // Scope: cartella attuale (/tabellone-produzione-live/)
    const swUrl = new URL("firebase-messaging-sw.js", location.href).toString();
    const reg = await navigator.serviceWorker.register(swUrl, { scope: "./" });
    return reg;
  }

  async function savePushToken(token){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const u = state.user || {};
    const id = await tokenDocId(token);
    const ref = fs.doc(db, "powderPushTokens", id);
    await fs.setDoc(ref, {
      token,
      uid: u.uid || "",
      email: u.email || "",
      displayName: u.fullName || u.displayName || "",
      role: (u.isAdmin ? "admin" : "operator"),
      line: "polveri",
      userAgent: navigator.userAgent || "",
      platform: isIOS() ? "ios" : /android/i.test(navigator.userAgent||"") ? "android" : "desktop",
      enabled: true,
      lastSeenAt: fs.serverTimestamp(),
      createdAt: fs.serverTimestamp()
    }, { merge:true });
  }

  async function deletePushToken(token){
    if(!state.firebase.ok) return;
    const fs = state.firebase.api;
    const db = state.firebase.db;
    const id = await tokenDocId(token);
    try{ await fs.deleteDoc(fs.doc(db, "powderPushTokens", id)); }catch(_e){}
  }

  async function tokenDocId(token){
    // doc id robusto e corto (sha256)
    const enc = new TextEncoder().encode(token);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  async function pushEnableFlow(){
    if(!state.push.supported){
      showToast("Notifiche non supportate", "Questo browser/dispositivo non supporta le push per questa app.");
      return;
    }

    const perm = await Notification.requestPermission();
    state.push.permission = perm;

    if(perm !== "granted"){
      showToast("Notifiche non abilitate", "Permesso negato o non concesso.");
      updatePushPill();
      return;
    }

    try{
      const fm = state.firebase.msgApi;
      const messaging = state.firebase.messaging;
      const swReg = await registerPushSW();

      const token = await fm.getToken(messaging, {
        vapidKey: FCM_VAPID_KEY,
        serviceWorkerRegistration: swReg
      });

      if(!token){
        showToast("Errore notifiche", "Token non generato. Controlla VAPID key in Firebase Console.");
        updatePushPill();
        return;
      }

      state.push.token = token;
      state.push.enabled = true;

      await savePushToken(token);

      // Foreground messages → toast
      try{
        fm.onMessage(messaging, (payload)=>{
          const title = payload?.notification?.title || "Aggiornamento";
          const body = payload?.notification?.body || "";
          showToast(title, body || "Nuova notifica");
          try{ beep(); }catch(_e){}
        });
      }catch(_e){}

      updatePushPill();
      showToast("Notifiche attive", "Perfetto: questo dispositivo riceverà notifiche anche ad app chiusa.");
    }catch(err){
      console.warn(err);
      showToast("Errore notifiche", String(err?.message || err));
      updatePushPill();
    }
  }

  async function pushDisableFlow(){
    try{
      const perm = Notification.permission;
      if(perm !== "granted"){
        showToast("Già disattive", "Su questo dispositivo le push non risultano attive.");
        updatePushPill();
        return;
      }

      const fm = state.firebase.msgApi;
      const messaging = state.firebase.messaging;

      // Recupera token corrente (serve per delete lato client)
      const swReg = await registerPushSW();
      const token = await fm.getToken(messaging, { vapidKey: FCM_VAPID_KEY, serviceWorkerRegistration: swReg }).catch(()=>null);

      if(token){
        await fm.deleteToken(messaging).catch(()=>{});
        await deletePushToken(token);
      }

      state.push.token = "";
      state.push.enabled = false;

      updatePushPill();
      showToast("Notifiche disattivate", "Ok, questo dispositivo non riceverà più push.");
    }catch(err){
      console.warn(err);
      showToast("Errore", "Impossibile disattivare le notifiche su questo dispositivo.");
    }
  }

  function wirePushUI(){
    const btn = $("#pillPush");
    if(btn){
      btn.addEventListener("click", ()=>{
        openNotifModal();
      });
    }
  }




// start
  await boot();
  try{ wirePushUI(); updatePushPill(); renderNotifCenter(); updateNotificationBadge(); }catch(_e){}

  </script>
</body>
</html>
