<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabellone Produzione</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#101826;
      --text:#e9eef6;
      --muted:#9fb0c7;
      --line:rgba(255,255,255,.10);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#60a5fa;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(96,165,250,.15), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(11,15,20,.65);
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 16px; }
    .top{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;background:var(--good);
      box-shadow:0 0 0 6px rgba(34,197,94,.10);
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.6px;
      text-transform:uppercase;
      font-weight:800;
    }
    .sub{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
    }
    .right{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      flex-wrap:wrap;
    }
    .pill{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(16,24,38,.55);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-family:var(--mono);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    .pill strong{ font-family:var(--sans); font-size:12px; letter-spacing:.4px; text-transform:uppercase; }
    .statusbar{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      color: #ffd38a;
      font-family: var(--mono);
      font-size: 12px;
    }

    main{ padding:18px 0 34px; }
    .card{
      background: rgba(16,24,38,.70);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardhead{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
    }
    .cardhead .title{
      font-weight:900; text-transform:uppercase; letter-spacing:.6px;
      font-size:14px;
    }
    .cardhead .hint{
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
    }

    table{
      width:100%;
      border-collapse:collapse;
    }
    thead th{
      text-align:left;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.7px;
      color:var(--muted);
      font-family:var(--mono);
      padding:12px 12px;
      border-bottom:1px solid var(--line);
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
      font-size:14px;
    }
    tbody tr:hover{ background: rgba(96,165,250,.05); }
    .col-small{ width:1%; white-space:nowrap; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(11,15,20,.35);
      font-weight:900;
      letter-spacing:.6px;
      text-transform:uppercase;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tag.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .tag.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .tag.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .tag .led{
      width:10px;height:10px;border-radius:999px;background:var(--warn);
      box-shadow:0 0 0 6px rgba(245,158,11,.12);
    }
    .tag.good .led{ background:var(--good); box-shadow:0 0 0 6px rgba(34,197,94,.12); }
    .tag.bad .led{ background:var(--bad); box-shadow:0 0 0 6px rgba(239,68,68,.12); }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(11,15,20,.40);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      letter-spacing:.4px;
      text-transform:uppercase;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      font-size:12px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(96,165,250,.45); background: rgba(96,165,250,.10); }
    .btn.danger{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); }
    .qty{
      font-family:var(--mono);
      font-size:13px;
      color:var(--text);
    }
    .muted{ color:var(--muted); font-family:var(--mono); font-size:12px; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:50;
    }
    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid var(--line);
      background: rgba(16,24,38,.95);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      position:unset;
      background: transparent;
      border-bottom:1px solid var(--line);
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal header .m-title{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.6px;
      font-size:14px;
    }
    .modal .body{
      padding:16px;
      display:grid;
      gap:12px;
    }
    .field{
      display:grid; gap:8px;
    }
    label{
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
    }
    input{
      width:100%;
      font-size:18px;
      font-weight:900;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(11,15,20,.45);
      color:var(--text);
      outline:none;
    }
    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding:0 16px 16px;
    }

    @media (max-width:720px){
      thead{ display:none; }
      tbody td{ display:block; padding:10px 12px; }
      tbody tr{ display:block; padding:10px 0; }
      tbody td.col-small{ width:auto; }
      tbody td[data-label]::before{
        content: attr(data-label) " ";
        display:block;
        font-family:var(--mono);
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:.7px;
        font-size:11px;
        margin-bottom:6px;
      }
      .top{ grid-template-columns: 1fr; }
      .right{ justify-content:flex-start; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot" id="liveDot" title="Online"></div>
        <div>
          <h1>Centro Produzione</h1>
          <div class="sub" id="subline">Caricamento…</div>
        </div>
      </div>
      <div class="right">
        <div class="pill"><strong>Ora</strong> <span id="clock">--:--:--</span></div>
        <div class="pill"><strong>Meteo</strong> <span id="weather">—</span></div>
        <button class="btn primary" id="refreshBtn">Aggiorna</button>
      </div>
    </div>
    <div class="statusbar" id="statusbar"></div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">
      <div class="cardhead">
        <div class="title">Produzioni</div>
        <div class="hint" id="lastUpdate">Ultimo aggiornamento: —</div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Stato</th>
              <th>Articolo</th>
              <th class="col-small">Q.tà</th>
              <th class="col-small">Azioni</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="muted" style="padding:16px;">Caricamento dati…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<!-- Modal Quantità -->
<div class="modal-backdrop" id="qtyModal">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <div class="m-title" id="qtyTitle">Quantità</div>
      <button class="btn" id="qtyClose">Chiudi</button>
    </header>
    <div class="body">
      <div class="field">
        <label for="qtyInput">Inserisci quantità prodotta</label>
        <input id="qtyInput" type="number" min="0" step="1" inputmode="numeric" placeholder="Es. 120" />
        <div class="muted" id="qtyHint">Poi premi “Conferma”.</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn danger" id="qtyCancel">Annulla</button>
      <button class="btn primary" id="qtyOk">Conferma</button>
    </div>
  </div>
</div>

<script>
/**
 * VERSIONE DEFINITIVA PER GITHUB PAGES
 * - Legge il CSV pubblicato di Google Sheets
 * - Meteo: Open-Meteo (senza API key)
 * - Stato riga 1: sempre "IN PRODUZIONE"
 * - Pulsanti funzionano e salvano in localStorage (per dispositivo)
 *
 * Se vuoi sincronizzazione multi-dispositivo: serve un backend (Firebase/DB).
 */

const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbRcMc9ZdrJ0o7jCJZfyCeGuGD3pgxurwbxO6NO_2kizrkg0czCQYR3g0YmUyWffgyBkmBdNe9fiB/pub?output=csv";

const els = {
  tbody: document.getElementById("tbody"),
  clock: document.getElementById("clock"),
  weather: document.getElementById("weather"),
  refreshBtn: document.getElementById("refreshBtn"),
  lastUpdate: document.getElementById("lastUpdate"),
  subline: document.getElementById("subline"),
  liveDot: document.getElementById("liveDot"),
  statusbar: document.getElementById("statusbar"),
  qtyModal: document.getElementById("qtyModal"),
  qtyTitle: document.getElementById("qtyTitle"),
  qtyInput: document.getElementById("qtyInput"),
  qtyHint: document.getElementById("qtyHint"),
  qtyClose: document.getElementById("qtyClose"),
  qtyCancel: document.getElementById("qtyCancel"),
  qtyOk: document.getElementById("qtyOk"),
};

let currentRowKey = null;

function showStatus(msg){
  els.statusbar.style.display = "block";
  els.statusbar.textContent = msg;
}
function clearStatus(){
  els.statusbar.style.display = "none";
  els.statusbar.textContent = "";
}

function nowStr(){
  const d = new Date();
  return d.toLocaleString("it-IT", { hour12:false });
}

function startClock(){
  const tick = () => {
    const d = new Date();
    els.clock.textContent = d.toLocaleTimeString("it-IT", { hour12:false });
  };
  tick();
  setInterval(tick, 1000);
}

function csvParse(text){
  // Small, robust CSV parser (handles quotes, commas, CRLF)
  const rows = [];
  let row = [], field = "", inQuotes = false;
  for (let i=0;i<text.length;i++){
    const c = text[i];
    if (inQuotes){
      if (c === '"'){
        if (text[i+1] === '"'){ field += '"'; i++; }
        else { inQuotes = false; }
      } else field += c;
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ','){ row.push(field); field=""; }
      else if (c === '\n'){
        row.push(field); field="";
        // trim trailing \r in last field if present
        row = row.map(v => v.endsWith('\r') ? v.slice(0,-1) : v);
        // skip fully empty last line
        if (!(row.length===1 && row[0]==="")) rows.push(row);
        row = [];
      } else field += c;
    }
  }
  // last row
  if (field.length || row.length){
    row.push(field);
    row = row.map(v => v.endsWith('\r') ? v.slice(0,-1) : v);
    if (!(row.length===1 && row[0]==="")) rows.push(row);
  }
  return rows;
}

function getLS(){
  try{
    return JSON.parse(localStorage.getItem("tabellone_state_v1") || "{}");
  }catch(e){ return {}; }
}
function setLS(obj){
  localStorage.setItem("tabellone_state_v1", JSON.stringify(obj));
}

function rowKey(idx, name){
  return `${idx}::${(name||"").trim().toLowerCase()}`;
}

function openQtyModal(key, title){
  currentRowKey = key;
  els.qtyTitle.textContent = title || "Quantità";
  els.qtyInput.value = "";
  els.qtyHint.textContent = "Poi premi “Conferma”.";
  els.qtyModal.style.display = "flex";
  setTimeout(()=>els.qtyInput.focus(), 50);
}
function closeQtyModal(){
  els.qtyModal.style.display = "none";
  currentRowKey = null;
}
function confirmCancel(){
  return window.confirm("Sei sicuro che vuoi annullare?");
}

function badgeFor(status){
  const s = (status||"").toLowerCase();
  if (s.includes("produzione") || s.includes("in produzione")) return {cls:"good", text:"IN PRODUZIONE"};
  if (s.includes("complet")) return {cls:"bad", text:"COMPLETATO"};
  return {cls:"warn", text:"DA PRODURRE"};
}

function render(dataRows){
  const state = getLS();

  // Heuristic columns: prefer headers if present
  // Expected: [stato, articolo, quantita] OR [articolo, quantita, stato] etc.
  // We'll map by header names if first row looks like headers.
  let headers = dataRows[0] || [];
  const lower = headers.map(h => (h||"").toLowerCase().trim());

  let hasHeader = lower.some(h => ["stato","status","articolo","prodotto","qty","quantità","quantita","qta","q.tà"].includes(h));
  let startIdx = hasHeader ? 1 : 0;

  const idxStato = hasHeader ? lower.findIndex(h => ["stato","status"].includes(h)) : 0;
  const idxArt   = hasHeader ? lower.findIndex(h => ["articolo","prodotto","item","nome"].includes(h)) : 1;
  const idxQty   = hasHeader ? lower.findIndex(h => ["qty","quantità","quantita","qta","q.tà"].includes(h)) : 2;

  const safeIdx = (i, fallback) => (i>=0 ? i : fallback);

  const iStato = safeIdx(idxStato, 0);
  const iArt   = safeIdx(idxArt, 1);
  const iQty   = safeIdx(idxQty, 2);

  const rows = dataRows.slice(startIdx).filter(r => r.some(x => (x||"").trim() !== ""));

  els.tbody.innerHTML = "";

  if (!rows.length){
    els.tbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:16px;">Nessun dato nel foglio.</td></tr>`;
    return;
  }

  rows.forEach((r, idx) => {
    const articolo = (r[iArt] ?? "").trim() || `Riga ${idx+1}`;
    const key = rowKey(idx, articolo);

    // First row forced "IN PRODUZIONE" (idx === 0 after slicing)
    const sheetStatus = (r[iStato] ?? "").trim();
    const forcedStatus = (idx === 0) ? "IN PRODUZIONE" : (sheetStatus || "DA PRODURRE");

    const saved = state[key] || {};
    const shownStatus = saved.status || forcedStatus;

    const qty = (saved.qty != null) ? saved.qty : ((r[iQty] ?? "").trim() || "");
    const badge = badgeFor(shownStatus);

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td data-label="Stato">
        <span class="tag ${badge.cls}" data-action="badge" data-key="${encodeURIComponent(key)}" title="Clicca per inserire quantità">
          <span class="led"></span>
          <span>${badge.text}</span>
        </span>
      </td>
      <td data-label="Articolo">
        <div style="font-weight:900; letter-spacing:.3px;">${escapeHtml(articolo)}</div>
        <div class="muted">ID: ${escapeHtml(key)}</div>
      </td>
      <td data-label="Q.tà" class="col-small">
        <div class="qty">${escapeHtml(String(qty || "—"))}</div>
      </td>
      <td data-label="Azioni" class="col-small">
        <button class="btn primary" data-action="done" data-key="${encodeURIComponent(key)}">Fatto</button>
        <button class="btn danger" data-action="undo" data-key="${encodeURIComponent(key)}">Annulla</button>
      </td>
    `;
    els.tbody.appendChild(tr);
  });
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

async function loadCSV(){
  clearStatus();
  els.liveDot.style.background = "var(--warn)";
  els.subline.textContent = "Caricamento dati dallo Sheet…";

  const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();

  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`CSV non raggiungibile (HTTP ${res.status})`);
  const text = await res.text();
  const rows = csvParse(text);

  els.liveDot.style.background = "var(--good)";
  els.subline.textContent = "Online • " + nowStr();
  els.lastUpdate.textContent = "Ultimo aggiornamento: " + nowStr();

  render(rows);
}

async function loadWeather(){
  // Use geolocation if allowed, else fallback Verona
  const fallback = { lat: 45.4384, lon: 10.9916, name: "Verona" };

  const getPos = () => new Promise((resolve) => {
    if (!navigator.geolocation) return resolve({ ok:false, ...fallback });
    navigator.geolocation.getCurrentPosition(
      (p) => resolve({ ok:true, lat:p.coords.latitude, lon:p.coords.longitude, name:"Posizione" }),
      () => resolve({ ok:false, ...fallback }),
      { enableHighAccuracy:false, timeout:3000, maximumAge: 60*60*1000 }
    );
  });

  try{
    const pos = await getPos();
    const api = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(pos.lat)}&longitude=${encodeURIComponent(pos.lon)}&current=temperature_2m,weather_code,wind_speed_10m&timezone=auto`;
    const res = await fetch(api, { cache:"no-store" });
    if (!res.ok) throw new Error(`Meteo HTTP ${res.status}`);
    const j = await res.json();
    const t = j?.current?.temperature_2m;
    const w = j?.current?.weather_code;
    const ws = j?.current?.wind_speed_10m;
    const label = weatherCodeToText(w);
    els.weather.textContent = `${Math.round(t)}° • ${label} • vento ${Math.round(ws)} km/h`;
  }catch(e){
    els.weather.textContent = "Meteo non disponibile";
  }
}

function weatherCodeToText(code){
  // Open-Meteo weather codes (simplified)
  const c = Number(code);
  if ([0].includes(c)) return "sereno";
  if ([1,2,3].includes(c)) return "nuvoloso";
  if ([45,48].includes(c)) return "nebbia";
  if ([51,53,55].includes(c)) return "pioggerella";
  if ([61,63,65].includes(c)) return "pioggia";
  if ([66,67].includes(c)) return "pioggia gelata";
  if ([71,73,75,77].includes(c)) return "neve";
  if ([80,81,82].includes(c)) return "rovesci";
  if ([95,96,99].includes(c)) return "temporale";
  return "variabile";
}

function applyDone(key){
  const state = getLS();
  state[key] = state[key] || {};
  state[key].status = "COMPLETATO";
  setLS(state);
  // Re-render by reloading quickly from DOM? simplest: reload CSV without network
  // We'll just update UI by triggering refresh.
  refreshAll(false);
}

function applyUndo(key){
  if (!confirmCancel()) return;
  const state = getLS();
  if (state[key]){
    delete state[key].status;
    delete state[key].qty;
    // If empty, remove
    if (Object.keys(state[key]).length === 0) delete state[key];
    setLS(state);
  }
  refreshAll(false);
}

function saveQty(key, qty){
  const state = getLS();
  state[key] = state[key] || {};
  state[key].qty = qty;
  // keep status if already
  setLS(state);
}

async function refreshAll(network=true){
  try{
    if (network) await loadCSV();
    else {
      // re-render based on last loaded snapshot: fallback to network if none
      await loadCSV();
    }
  }catch(e){
    showStatus("ERRORE DATI: " + (e?.message || e));
    els.subline.textContent = "Errore dati • " + nowStr();
    els.liveDot.style.background = "var(--bad)";
    els.tbody.innerHTML = `<tr><td colspan="4" class="muted" style="padding:16px;">
      Non riesco a caricare lo Sheet. Controlla che il foglio sia “Pubblicato sul web” come CSV.
    </td></tr>`;
  }
  await loadWeather();
}

document.addEventListener("click", (ev) => {
  const el = ev.target.closest("[data-action]");
  if (!el) return;

  const action = el.getAttribute("data-action");
  const key = decodeURIComponent(el.getAttribute("data-key") || "");

  if (action === "badge"){
    // Open qty modal (with confirmation on cancel inside modal)
    openQtyModal(key, "Quantità prodotta");
  }
  if (action === "done"){
    applyDone(key);
  }
  if (action === "undo"){
    applyUndo(key);
  }
});

els.refreshBtn.addEventListener("click", ()=> refreshAll(true));

els.qtyClose.addEventListener("click", ()=> closeQtyModal());
els.qtyModal.addEventListener("click", (e)=>{
  if (e.target === els.qtyModal) closeQtyModal();
});

els.qtyCancel.addEventListener("click", ()=>{
  if (!confirmCancel()) return;
  closeQtyModal();
});

els.qtyOk.addEventListener("click", ()=>{
  const v = els.qtyInput.value.trim();
  if (currentRowKey){
    saveQty(currentRowKey, v === "" ? "" : Number(v));
    closeQtyModal();
    refreshAll(false);
  }
});

window.addEventListener("keydown", (e)=>{
  if (e.key === "Escape" && els.qtyModal.style.display === "flex") closeQtyModal();
});

startClock();
refreshAll(true);

// Auto-refresh every 60s (safe)
setInterval(()=> refreshAll(true), 60000);
</script>
</body>
</html>
