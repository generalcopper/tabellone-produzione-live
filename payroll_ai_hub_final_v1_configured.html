<!doctype html>
<html lang="it" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Payroll AI Hub</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0b0f19;
      --muted:#6b7280;
      --line:#e6e8ee;
      --card:#ffffff;
      --shadow: 0 18px 45px rgba(0,0,0,.08);
      --shadow2: 0 8px 22px rgba(0,0,0,.06);
      --radius: 18px;
      --radius2: 14px;
      --blue:#0a84ff;
      --green:#22c55e;
      --orange:#f59e0b;
      --red:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 60% -10%, rgba(10,132,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 10% 0%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font: 14px/1.45 -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      letter-spacing:.1px;
    }
    a{color:inherit}
    .wrap{max-width:1080px;margin:0 auto;padding:26px 16px 48px}
    .topbar{
      position:sticky;top:0;z-index:30;
      backdrop-filter: blur(18px);
      background: rgba(255,255,255,.78);
      border-bottom:1px solid rgba(230,232,238,.75);
    }
    .topbar .inner{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--green);box-shadow:0 0 0 4px rgba(34,197,94,.14)}
    .brand h1{font-size:14px;margin:0;font-weight:700}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;box-shadow: var(--shadow2)}
    .pill small{color:var(--muted)}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, box-shadow .08s ease;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{background:var(--blue);border-color:rgba(10,132,255,.35);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.65)}
    .btn.danger{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.25);color:#b91c1c}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;margin-top:16px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{padding:16px 16px 12px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .card .head h2{margin:0;font-size:15px;font-weight:800}
    .card .head p{margin:4px 0 0;color:var(--muted);font-size:12.5px}
    .card .body{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .notice{padding:10px 12px;border-radius:14px;border:1px solid rgba(10,132,255,.25);background:rgba(10,132,255,.06);color:#0b1b3a}
    .notice.warn{border-color: rgba(245,158,11,.25);background: rgba(245,158,11,.10);}
    .notice.bad{border-color: rgba(239,68,68,.25);background: rgba(239,68,68,.08);color:#3a0b0b}
    .drop{
      border:1.6px dashed rgba(107,114,128,.35);
      border-radius:16px;
      padding:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(250,251,255,.9));
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .drop strong{font-size:13px}
    .drop small{color:var(--muted)}
    input[type="file"]{display:none}
    .toggle{display:flex;gap:10px;align-items:center}
    .switch{
      width:46px;height:28px;border-radius:999px;border:1px solid var(--line);
      position:relative;background:#f3f4f6;cursor:pointer;box-shadow: var(--shadow2);
    }
    .switch::after{
      content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:#fff;box-shadow: 0 8px 16px rgba(0,0,0,.12);
      transition: all .14s ease;
    }
    .switch.on{background:rgba(34,197,94,.20);border-color:rgba(34,197,94,.35)}
    .switch.on::after{left:21px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:520px){.kpi{grid-template-columns:1fr}}
    .kpi .box{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;box-shadow: var(--shadow2)}
    .kpi .box b{font-size:18px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;box-shadow: var(--shadow2)}
    .item .top{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .tag{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .tag.ok{border-color:rgba(34,197,94,.30);background:rgba(34,197,94,.08);color:#166534}
    .tag.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:#7c2d12}
    .tag.bad{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:#7f1d1d}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
    .footerhint{margin-top:10px;color:var(--muted);font-size:12px}
    .hide{display:none !important}
  </style>

  <!-- PDF.js (render + text extract) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js"></script>
  <!-- pdf-lib (split/copy pages into single PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="dot" id="dotOnline"></div>
        <div>
          <h1>Payroll AI Hub</h1>
          <div class="muted" style="font-size:12px" id="subTitle">Accesso</div>
        </div>
      </div>

      <div class="row">
        <div class="pill" id="userPill">
          <small id="userLabel">Non autenticato</small>
        </div>
        <button class="btn primary" id="btnLogin">Accedi</button>
        <button class="btn" id="btnLogout">Esci</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card" id="cardAdmin">
        <div class="head">
          <div>
            <h2>Busta paga (Admin)</h2>
            <p>Carica PDF multi-pagina o immagini. Il sistema estrae Nome + Mese + Netto e assegna automaticamente.</p>
          </div>
          <div class="toggle">
            <div class="muted" style="font-weight:700">AI</div>
            <div class="switch on" id="swAI" title="AI ON/OFF"></div>
          </div>
        </div>
        <div class="body">

          <div class="notice warn" id="adminHint">
            <b>Requisiti:</b> devi essere admin su <span class="mono">powderUsers</span> (uid o email) con <span class="mono">isAdmin:true</span>.
            I file finali verranno salvati in <span class="mono">/payroll/YYYY-MM/&lt;uid&gt;.pdf</span>
          </div>

          <div class="hr"></div>

          <div class="drop" id="dropzone">
            <div>
              <strong>Trascina qui PDF / immagini</strong><br/>
              <small>Formati: PDF, PNG, JPG. (PDF: split automatico pagine)</small>
            </div>
            <div class="row">
              <label class="btn" for="fileInput">Seleziona file</label>
              <input id="fileInput" type="file" accept="application/pdf,image/png,image/jpeg" multiple />
              <button class="btn danger" id="btnResetLast" title="Cancella buste inviate nell'ultimo invio">Reset ultimo invio</button>
            </div>
          </div>

          <div class="footerhint">
            Suggerimento: per test rapido usa il PDF demo (7 pagine) che ti ho generato. Ogni pagina contiene “Dipendente”, “Mese” e “Netto in busta”.
          </div>

          <div class="hr"></div>

          <div class="kpi">
            <div class="box">
              <div class="muted">Pagine processate</div>
              <b id="kProcessed">0</b>
            </div>
            <div class="box">
              <div class="muted">Assegnate</div>
              <b id="kAssigned">0</b>
            </div>
            <div class="box">
              <div class="muted">Non assegnate</div>
              <b id="kUnassigned">0</b>
            </div>
          </div>

          <div class="hr"></div>

          <div class="list" id="adminLog"></div>
        </div>
      </div>

      <div class="card" id="cardUser">
        <div class="head">
          <div>
            <h2>La tua busta paga</h2>
            <p>Vedi i mesi disponibili e scarica/stampa/condividi.</p>
          </div>
          <span class="tag" id="roleTag">—</span>
        </div>
        <div class="body">
          <div class="notice" id="userHint">
            Accedi per vedere le tue buste paga.
          </div>

          <div class="hr"></div>

          <div class="list" id="userList"></div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // =========================
  // CONFIG
  // =========================
  // 1) Incolla qui la tua config Firebase (Console → Project settings → Your apps → Firebase SDK snippet)
  const firebaseConfig = {
    apiKey: "AIzaSyBiyB4pilnPpVj8vImD4PI6LF2_RtyDnv4",
    authDomain: "tabellone-produzione-liv-e313e.firebaseapp.com",
    projectId: "tabellone-produzione-liv-e313e",
    storageBucket: "tabellone-produzione-liv-e313e.firebasestorage.app",
    messagingSenderId: "537555699968",
    appId: "1:537555699968:web:4d04cb9596b67bfb0e4be5"
  };

  const FN_REGION = "europe-west1";
  const OPENAI_FUNCTION_NAME = "payrollExtract";

  // =========================
  // IMPORTS (Firebase modular)
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, getDoc, setDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

  // =========================
  // ELEMENTS
  // =========================
  const $ = (id) => document.getElementById(id);

  const btnLogin = $("btnLogin");
  const btnLogout = $("btnLogout");
  const userLabel = $("userLabel");
  const subTitle = $("subTitle");
  const roleTag = $("roleTag");

  const cardAdmin = $("cardAdmin");
  const adminHint = $("adminHint");
  const dropzone = $("dropzone");
  const fileInput = $("fileInput");
  const swAI = $("swAI");

  const kProcessed = $("kProcessed");
  const kAssigned = $("kAssigned");
  const kUnassigned = $("kUnassigned");
  const adminLog = $("adminLog");

  const userHint = $("userHint");
  const userList = $("userList");
  const btnResetLast = $("btnResetLast");

  // =========================
  // APP INIT
  // =========================
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const functions = getFunctions(app, FN_REGION);
  const payrollExtract = httpsCallable(functions, OPENAI_FUNCTION_NAME);

  // PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.js";

  // =========================
  // STATE
  // =========================
  let me = null;
  let isAdmin = false;
  let aiEnabled = true;

  let usersCache = null; // array of {uid, emailLower, fullName, raw}
  let lastCreated = { storagePaths: [], payrollDocs: [] }; // for reset

  // =========================
  // HELPERS
  // =========================
  function toast(type, msg){
    const el = document.createElement("div");
    el.className = "notice " + (type==="bad"?"bad":type==="warn"?"warn":"");
    el.style.marginTop = "12px";
    el.innerHTML = msg;
    adminHint.parentElement.insertBefore(el, adminHint.nextSibling);
    setTimeout(()=> el.remove(), 5200);
  }

  function safeName(s){
    return String(s || "file").replace(/[^a-z0-9._-]+/gi,"_").slice(0,120);
  }

  function normalizeName(s){
    return String(s||"")
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^A-Z\s]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function tokenScore(a,b){
    const A = new Set(normalizeName(a).split(" ").filter(Boolean));
    const B = new Set(normalizeName(b).split(" ").filter(Boolean));
    if (!A.size || !B.size) return 0;
    let inter = 0;
    for (const t of A) if (B.has(t)) inter++;
    return (2*inter) / (A.size + B.size);
  }

  function parseMonthKeyFromFilename(name){
    const s = String(name||"");
    // 2025-12 or 2025_12
    let m = s.match(/(20\d{2})[-_\/.](0?[1-9]|1[0-2])/);
    if (m){
      const y=m[1], mm=String(parseInt(m[2],10)).padStart(2,"0");
      return `${y}-${mm}`;
    }
    // 12-2025
    m = s.match(/(0?[1-9]|1[0-2])[-_\/.](20\d{2})/);
    if (m){
      const mm=String(parseInt(m[1],10)).padStart(2,"0"), y=m[2];
      return `${y}-${mm}`;
    }
    return "";
  }

  function formatEURFromCents(cents){
    if (cents == null) return "—";
    const v = (Number(cents)/100);
    return v.toLocaleString("it-IT", { style:"currency", currency:"EUR" });
  }

  function netToCents(net){
    if (net == null || Number.isNaN(Number(net))) return null;
    return Math.round(Number(net) * 100);
  }

  async function isAdminPowderUsers(user){
    if (!user) return false;
    const uid = user.uid;
    const email = (user.email||"").toLowerCase();
    const tryDocs = [
      doc(db, "powderUsers", uid),
      ...(email ? [doc(db, "powderUsers", email)] : [])
    ];
    for (const d of tryDocs){
      const snap = await getDoc(d);
      if (snap.exists() && snap.data()?.isAdmin === true) return true;
    }
    return false;
  }

  async function loadUsersDirectory(){
    if (usersCache) return usersCache;

    const snaps = await getDocs(collection(db, "powderUsers"));
    const arr = [];
    snaps.forEach(s => {
      const data = s.data() || {};
      if (data.isAdmin === true) return;

      const id = s.id;
      const looksEmail = id.includes("@");
      const uid = looksEmail ? (data.uid || "") : id;
      const emailLower = (looksEmail ? id : (data.emailLower || data.email || "")).toLowerCase();
      const fullName = data.fullName || data.displayName || data.name || data.nome || "";
      if (!uid && !emailLower) return;

      arr.push({ uid, emailLower, fullName: normalizeName(fullName), raw: data, id });
    });

    usersCache = arr;
    return arr;
  }

  function findBestUserByName(extractedFullName, users){
    const target = normalizeName(extractedFullName);
    if (!target) return null;

    let best = null;
    let bestScore = 0;

    for (const u of users){
      const sc = tokenScore(target, u.fullName || "");
      if (sc > bestScore){
        bestScore = sc;
        best = u;
      }
    }

    if (best && bestScore >= 0.62) return { user: best, score: bestScore };
    return null;
  }

  function addLogCard({title, subtitle, tag, tagClass, detailsHtml, actions=[]}){
    const el = document.createElement("div");
    el.className = "item";
    const btns = actions.map(a => `<button class="btn ${a.primary?'primary':''} ${a.danger?'danger':''}" data-action="${a.id}">${a.label}</button>`).join(" ");
    el.innerHTML = `
      <div class="top">
        <div>
          <div style="font-weight:900">${title}</div>
          <div class="muted" style="font-size:12px;margin-top:2px">${subtitle||""}</div>
        </div>
        <span class="tag ${tagClass||''}">${tag||''}</span>
      </div>
      ${detailsHtml?`<div style="margin-top:10px" class="mono">${detailsHtml}</div>`:""}
      ${actions.length?`<div style="margin-top:10px" class="row">${btns}</div>`:""}
    `;
    adminLog.prepend(el);
    for (const a of actions){
      el.querySelector(`[data-action="${a.id}"]`)?.addEventListener("click", a.onClick);
    }
  }

  function setKPIs({processed=0, assigned=0, unassigned=0}){
    kProcessed.textContent = String(processed);
    kAssigned.textContent = String(assigned);
    kUnassigned.textContent = String(unassigned);
  }

  async function uploadBlob(path, blob, contentType){
    const r = sRef(storage, path);
    await uploadBytes(r, blob, { contentType });
    lastCreated.storagePaths.push(path);
    return r;
  }

  async function uploadBytesPdf(path, bytes){
    const r = sRef(storage, path);
    await uploadBytes(r, new Uint8Array(bytes), { contentType: "application/pdf" });
    lastCreated.storagePaths.push(path);
    return r;
  }

  async function writePayrollDoc(uid, emailLower, fullName, monthKey, netPayCents, netPayText, storagePath, source, confidence){
    const docId = `${uid}_${monthKey}`;
    await setDoc(doc(db, "payrollDocs", docId), {
      uid,
      emailLower: (emailLower||"").toLowerCase(),
      fullName: normalizeName(fullName),
      monthKey,
      netPayCents: netPayCents ?? null,
      netPayText: netPayText || "",
      storagePath,
      confidence: confidence ?? null,
      createdAt: serverTimestamp(),
      source: source || "ai"
    }, { merge:true });
    lastCreated.payrollDocs.push({ docId });
  }

  async function resetLast(){
    if (!isAdmin) return;
    if (!lastCreated.storagePaths.length && !lastCreated.payrollDocs.length){
      toast("warn","Niente da resettare (nessun invio in questa sessione).");
      return;
    }
    if (!confirm("Vuoi cancellare tutte le buste inviate nell'ULTIMO invio (questa sessione)?")) return;

    // Firestore docs
    for (const d of lastCreated.payrollDocs){
      try{
        // deleteDoc import not used; to keep single import list, use setDoc with delete? No.
        // We'll do dynamic import deleteDoc:
        const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
        await deleteDoc(doc(db,"payrollDocs", d.docId));
      }catch(e){}
    }

    // Storage objects
    for (const p of lastCreated.storagePaths){
      try{ await deleteObject(sRef(storage,p)); }catch(e){}
    }

    lastCreated = { storagePaths: [], payrollDocs: [] };
    toast("","Reset completato.");
  }

  // =========================
  // AUTH UI
  // =========================
  btnLogout.classList.add("hide");

  btnLogin.addEventListener("click", async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  });

  btnLogout.addEventListener("click", async () => {
    await signOut(auth);
  });

  swAI.addEventListener("click", () => {
    aiEnabled = !aiEnabled;
    swAI.classList.toggle("on", aiEnabled);
  });

  btnResetLast.addEventListener("click", resetLast);

  // =========================
  // DROPZONE
  // =========================
  function handleFiles(files){
    if (!isAdmin){
      toast("bad","Solo admin può caricare.");
      return;
    }
    if (!files || !files.length) return;
    processUpload(files).catch(err => {
      console.error(err);
      toast("bad", "Errore: " + (err?.message || String(err)));
    });
  }

  dropzone.addEventListener("dragover", (e)=>{ e.preventDefault(); dropzone.style.borderColor="rgba(10,132,255,.55)"; });
  dropzone.addEventListener("dragleave", ()=>{ dropzone.style.borderColor="rgba(107,114,128,.35)"; });
  dropzone.addEventListener("drop", (e)=>{ e.preventDefault(); dropzone.style.borderColor="rgba(107,114,128,.35)"; handleFiles(Array.from(e.dataTransfer.files||[])); });
  fileInput.addEventListener("change", (e)=>{ handleFiles(Array.from(e.target.files||[])); fileInput.value=""; });

  // =========================
  // MAIN PROCESS
  // =========================
  async function processUpload(files){
    // reset counters for this run (but keep lastCreated for reset button)
    let processed=0, assigned=0, unassigned=0;
    setKPIs({processed,assigned,unassigned});

    const users = await loadUsersDirectory();

    for (const file of files){
      const name = file.name || "upload";
      const isPdf = file.type === "application/pdf";
      const isImg = file.type.startsWith("image/");

      addLogCard({
        title: "Upload avviato",
        subtitle: `${name} • ${isPdf? "PDF" : isImg ? "Immagine" : file.type}`,
        tag: "IN CORSO",
        tagClass: "warn",
        detailsHtml: `size=${file.size} bytes`
      });

      if (isPdf){
        const bytes = new Uint8Array(await file.arrayBuffer());
        await processPdfFile(bytes, name, users, (delta) => {
          processed += delta.processed||0;
          assigned += delta.assigned||0;
          unassigned += delta.unassigned||0;
          setKPIs({processed,assigned,unassigned});
        });
      } else if (isImg){
        const bytes = new Uint8Array(await file.arrayBuffer());
        await processImageFile(bytes, file.type, name, users, (delta)=>{
          processed += delta.processed||0;
          assigned += delta.assigned||0;
          unassigned += delta.unassigned||0;
          setKPIs({processed,assigned,unassigned});
        });
      } else {
        toast("warn", `Formato non supportato: ${name}`);
      }
    }

    toast("", "Upload completato.");
    await loadUserPayrollList(); // refresh user side
  }

  async function processPdfFile(pdfBytes, fileName, users, bump){
    // Load pdf with pdf.js
    const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
    const pdf = await loadingTask.promise;
    const num = pdf.numPages;

    // Load pdf with pdf-lib for perfect page copy (no raster)
    const srcDoc = await PDFLib.PDFDocument.load(pdfBytes);

    // Determine monthKey by filename fallback
    let globalMonthKey = parseMonthKeyFromFilename(fileName);

    // stats for picking best monthKey
    const monthVotes = new Map();

    for (let i=1;i<=num;i++){
      const page = await pdf.getPage(i);

      // Try extract text quickly
      let text = "";
      try{
        const tc = await page.getTextContent();
        text = (tc.items || []).map(it=>it.str).join(" ").replace(/\s+/g," ").trim();
      }catch(e){}

      let extracted = null;
      const canUseText = aiEnabled && text && text.length >= 240;

      if (aiEnabled && canUseText){
        extracted = await callAIText(text, fileName, i);
      } else if (aiEnabled){
        // Render to PNG, upload to payroll_tmp, call AI file mode
        const png = await renderPageToPngBlob(page, 2.0);
        const tmpPath = `payroll_tmp/${Date.now()}_${safeName(fileName)}/p${String(i).padStart(3,"0")}.png`;
        await uploadBlob(tmpPath, png, "image/png");
        extracted = await callAIFile(tmpPath, "image/png", fileName, i);
      } else {
        extracted = { fullName:"", monthKey: globalMonthKey || "", net: null, confidence: 0, notes:"AI OFF" };
      }

      const fullName = extracted.fullName || extracted.full_name || "";
      const monthKey = (extracted.monthKey || extracted.month_key || extracted.month || "").trim();
      const confidence = Number(extracted.confidence ?? extracted.score ?? 0) || 0;

      // net parsing
      let netPayCents = null;
      let netPayText = "";

      if (typeof extracted.netPayCents === "number" || extracted.netPayCents === null){
        netPayCents = extracted.netPayCents;
        netPayText = extracted.netPayText || "";
      } else if (typeof extracted.net === "number"){
        netPayCents = netToCents(extracted.net);
        netPayText = (extracted.net).toLocaleString("it-IT", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }

      // month voting
      const mk = monthKey || "";
      if (mk){
        monthVotes.set(mk, (monthVotes.get(mk)||0) + 1);
        globalMonthKey = globalMonthKey || mk;
      }

      // Match user
      const match = findBestUserByName(fullName, users);
      const pageIndex0 = i-1;

      // Create single-page PDF bytes by copying page from original
      const outDoc = await PDFLib.PDFDocument.create();
      const [copied] = await outDoc.copyPages(srcDoc, [pageIndex0]);
      outDoc.addPage(copied);
      const outBytes = await outDoc.save();

      const finalMonthKey = mk || globalMonthKey || "unknown";

      if (match && match.user?.uid){
        const uid = match.user.uid;
        const outPath = `payroll/${finalMonthKey}/${uid}.pdf`;
        await uploadBytesPdf(outPath, outBytes);

        await writePayrollDoc(
          uid,
          match.user.emailLower,
          fullName || match.user.fullName || "",
          finalMonthKey,
          netPayCents,
          netPayText,
          outPath,
          "ai",
          confidence
        );

        bump({processed:1, assigned:1});
        addLogCard({
          title: `${fullName || "NOME NON TROVATO"} → ${match.user.emailLower || match.user.id}`,
          subtitle: `Pagina ${i}/${num} • mese ${finalMonthKey} • netto ${netPayCents!=null?formatEURFromCents(netPayCents):"—"} • score match ${(match.score*100).toFixed(0)}%`,
          tag: "ASSEGNATA",
          tagClass:"ok",
          detailsHtml: `storagePath=${outPath}`
        });
      } else {
        const outPath = `payroll/${finalMonthKey}/unassigned/${safeName(fileName)}_p${String(i).padStart(3,"0")}.pdf`;
        await uploadBytesPdf(outPath, outBytes);

        bump({processed:1, unassigned:1});
        addLogCard({
          title: `${fullName || "NOME NON TROVATO"} → NON ASSEGNATA`,
          subtitle: `Pagina ${i}/${num} • mese ${finalMonthKey} • netto ${netPayCents!=null?formatEURFromCents(netPayCents):"—"} • confidence ${(confidence*100).toFixed(0)}%`,
          tag: "UNASSIGNED",
          tagClass:"bad",
          detailsHtml: `storagePath=${outPath}`
        });
      }
    }

    // Choose global monthKey from votes if multiple
    if (!globalMonthKey && monthVotes.size){
      const sorted = [...monthVotes.entries()].sort((a,b)=>b[1]-a[1]);
      globalMonthKey = sorted[0][0];
    }
  }

  async function processImageFile(bytes, mimeType, fileName, users, bump){
    // Upload original image to tmp
    const tmpPath = `payroll_tmp/${Date.now()}_${safeName(fileName)}/img.png`;
    const blob = new Blob([bytes], { type: mimeType });
    await uploadBlob(tmpPath, blob, mimeType);

    let extracted = null;
    if (aiEnabled){
      extracted = await callAIFile(tmpPath, mimeType, fileName, 1);
    } else {
      extracted = { fullName:"", monthKey: parseMonthKeyFromFilename(fileName) || "", net: null, confidence:0, notes:"AI OFF" };
    }

    const fullName = extracted.fullName || "";
    const monthKey = (extracted.monthKey || "").trim() || parseMonthKeyFromFilename(fileName) || "unknown";
    const confidence = Number(extracted.confidence ?? 0) || 0;

    let netPayCents = null;
    let netPayText = "";
    if (typeof extracted.netPayCents === "number" || extracted.netPayCents === null){
      netPayCents = extracted.netPayCents;
      netPayText = extracted.netPayText || "";
    } else if (typeof extracted.net === "number"){
      netPayCents = netToCents(extracted.net);
      netPayText = (extracted.net).toLocaleString("it-IT", { minimumFractionDigits:2, maximumFractionDigits:2 });
    }

    // Build one-page PDF from image
    const outDoc = await PDFLib.PDFDocument.create();
    let embedded;
    if (mimeType.includes("png")){
      embedded = await outDoc.embedPng(bytes);
    } else {
      embedded = await outDoc.embedJpg(bytes);
    }
    const { width, height } = embedded.scale(1);
    const page = outDoc.addPage([width, height]);
    page.drawImage(embedded, { x:0, y:0, width, height });
    const outBytes = await outDoc.save();

    const match = findBestUserByName(fullName, users);

    if (match && match.user?.uid){
      const uid = match.user.uid;
      const outPath = `payroll/${monthKey}/${uid}.pdf`;
      await uploadBytesPdf(outPath, outBytes);

      await writePayrollDoc(
        uid,
        match.user.emailLower,
        fullName || match.user.fullName || "",
        monthKey,
        netPayCents,
        netPayText,
        outPath,
        "ai",
        confidence
      );

      bump({processed:1, assigned:1});
      addLogCard({
        title: `${fullName || "NOME NON TROVATO"} → ${match.user.emailLower || match.user.id}`,
        subtitle: `Immagine • mese ${monthKey} • netto ${netPayCents!=null?formatEURFromCents(netPayCents):"—"} • score match ${(match.score*100).toFixed(0)}%`,
        tag: "ASSEGNATA",
        tagClass:"ok",
        detailsHtml: `storagePath=${outPath}`
      });
    } else {
      const outPath = `payroll/${monthKey}/unassigned/${safeName(fileName)}.pdf`;
      await uploadBytesPdf(outPath, outBytes);

      bump({processed:1, unassigned:1});
      addLogCard({
        title: `${fullName || "NOME NON TROVATO"} → NON ASSEGNATA`,
        subtitle: `Immagine • mese ${monthKey} • netto ${netPayCents!=null?formatEURFromCents(netPayCents):"—"} • confidence ${(confidence*100).toFixed(0)}%`,
        tag: "UNASSIGNED",
        tagClass:"bad",
        detailsHtml: `storagePath=${outPath}`
      });
    }
  }

  async function renderPageToPngBlob(page, scale){
    const viewport = page.getViewport({ scale: scale || 2 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { alpha: false });
    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);
    await page.render({ canvasContext: ctx, viewport }).promise;
    return await new Promise((resolve) => canvas.toBlob(resolve, "image/png", 0.92));
  }

  async function callAIText(text, fileName, pageNum){
    try{
      const res = await payrollExtract({
        mode: "text",
        text,
        hints: { fileName, pageNum }
      });
      return res.data || {};
    }catch(e){
      console.warn("AI text failed, fallback to file mode", e);
      return { fullName:"", monthKey:"", net:null, confidence:0, notes:"AI text failed" };
    }
  }

  async function callAIFile(storagePath, mimeType, fileName, pageNum){
    const res = await payrollExtract({
      mode: "file",
      storagePath,
      mimeType,
      hints: { fileName, pageNum }
    });
    return res.data || {};
  }

  // =========================
  // USER VIEW
  // =========================
  async function loadUserPayrollList(){
    userList.innerHTML = "";
    if (!me){
      userHint.className = "notice";
      userHint.textContent = "Accedi per vedere le tue buste paga.";
      return;
    }

    userHint.className = "notice";
    userHint.textContent = "Caricamento…";

    const emailLower = (me.email||"").toLowerCase();
    const uid = me.uid;

    let docsArr = [];

    try{
      const q1 = query(collection(db, "payrollDocs"), where("uid","==", uid));
      const snap = await getDocs(q1);
      snap.forEach(d => docsArr.push({ id:d.id, ...d.data() }));
    }catch(e){}

    if (!docsArr.length && emailLower){
      try{
        const q2 = query(collection(db, "payrollDocs"), where("emailLower","==", emailLower));
        const snap2 = await getDocs(q2);
        snap2.forEach(d => docsArr.push({ id:d.id, ...d.data() }));
      }catch(e){}
    }

    docsArr.sort((a,b)=> String(b.monthKey||"").localeCompare(String(a.monthKey||"")));

    if (!docsArr.length){
      userHint.className = "notice warn";
      userHint.textContent = "Nessuna busta paga trovata.";
      return;
    }

    userHint.className = "notice";
    userHint.textContent = "Disponibili:";

    for (const d of docsArr){
      const mk = d.monthKey || "—";
      const net = d.netPayCents != null ? formatEURFromCents(d.netPayCents) : (d.netPayText ? `€ ${d.netPayText}` : "—");
      const storagePath = d.storagePath;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="top">
          <div>
            <div style="font-weight:900">${mk}</div>
            <div class="muted" style="font-size:12px;margin-top:2px">${normalizeName(d.fullName||"")}</div>
          </div>
          <span class="tag ok">${net}</span>
        </div>
        <div style="margin-top:10px" class="row">
          <button class="btn primary" data-act="open">Scarica</button>
          <button class="btn" data-act="print">Stampa</button>
          <button class="btn" data-act="share">Condividi</button>
        </div>
        <div class="mono muted" style="margin-top:10px">${storagePath}</div>
      `;
      userList.appendChild(el);

      async function getUrl(){
        const url = await getDownloadURL(sRef(storage, storagePath));
        return url;
      }

      el.querySelector('[data-act="open"]').addEventListener("click", async ()=>{
        const url = await getUrl();
        window.open(url, "_blank");
      });

      el.querySelector('[data-act="print"]').addEventListener("click", async ()=>{
        const url = await getUrl();
        const w = window.open(url, "_blank");
        // l'utente può stampare dal browser
        w?.focus();
      });

      el.querySelector('[data-act="share"]').addEventListener("click", async ()=>{
        const url = await getUrl();
        if (navigator.share){
          await navigator.share({ title:`Busta paga ${mk}`, text:`Busta paga ${mk}`, url });
        } else {
          await navigator.clipboard.writeText(url);
          toast("","Link copiato negli appunti.");
        }
      });
    }
  }

  // =========================
  // AUTH STATE
  // =========================
  onAuthStateChanged(auth, async (user) => {
    me = user || null;

    if (!me){
      isAdmin = false;
      userLabel.textContent = "Non autenticato";
      subTitle.textContent = "Accedi con Google";
      roleTag.textContent = "—";
      roleTag.className = "tag";

      btnLogin.classList.remove("hide");
      btnLogout.classList.add("hide");

      cardAdmin.classList.add("hide");
      await loadUserPayrollList();
      return;
    }

    btnLogin.classList.add("hide");
    btnLogout.classList.remove("hide");

    userLabel.textContent = (me.email || me.uid);
    subTitle.textContent = "Online";

    // role
    isAdmin = await isAdminPowderUsers(me);
    roleTag.textContent = isAdmin ? "ADMIN" : "USER";
    roleTag.className = "tag " + (isAdmin ? "ok" : "warn");

    cardAdmin.classList.toggle("hide", !isAdmin);

    await loadUserPayrollList();
  });

</script>
</body>
</html>
