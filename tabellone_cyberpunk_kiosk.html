<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabellone Produzione • Cyberpunk Kiosk</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Cyberpunk font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#04040a; --bg1:#070b16;
      --panel: rgba(10,14,28,.78);
      --panel2: rgba(12,18,34,.86);
      --line: rgba(120,255,255,.18);
      --text:#eaf7ff;
      --muted: rgba(200,230,255,.68);

      --cyan:#35f2ff;
      --mag:#ff2bd6;
      --yel:#ffe66d;
      --grn:#2bff88;
      --red:#ff3c68;

      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: Rajdhani, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 900px at 10% 10%, rgba(53,242,255,.10), transparent 55%),
        radial-gradient(1100px 900px at 92% 12%, rgba(255,43,214,.09), transparent 60%),
        radial-gradient(1100px 900px at 70% 95%, rgba(255,230,109,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      overflow:hidden;
    }

    /* scanlines */
    body:before{
      content:""; position:fixed; inset:0;
      background: repeating-linear-gradient(to bottom,
        rgba(255,255,255,.016), rgba(255,255,255,.016) 1px,
        transparent 1px, transparent 8px);
      opacity:.18; pointer-events:none; mix-blend-mode:overlay;
      z-index:1;
    }
    /* subtle grid */
    body:after{
      content:""; position:fixed; inset:0;
      background:
        linear-gradient(to right, rgba(53,242,255,.08) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,43,214,.06) 1px, transparent 1px);
      background-size: 140px 140px;
      opacity:.12; pointer-events:none; z-index:1;
      transform: translate3d(0,0,0);
      animation: gridPan 12s linear infinite;
    }
    @keyframes gridPan{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(280px,280px,0)}}

    .app{height:100%; display:flex; flex-direction:column; gap:16px; padding:18px; position:relative; z-index:2;}
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }

    /* Top bar */
    .top{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; align-items:stretch;}
    .brand{padding:18px 20px;}
    .brandTitle{
      font-family: Orbitron, Rajdhani, sans-serif;
      margin:0;
      font-size:46px;
      font-weight:900;
      letter-spacing: 2px;
      text-transform:uppercase;
      text-shadow: 0 0 26px rgba(53,242,255,.15);
      line-height:1.05;
    }
    .brandSub{margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:18px; font-weight:700;}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px; border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-family: Orbitron, Rajdhani, sans-serif;
      font-size:14px; font-weight:800; letter-spacing:1px; text-transform:uppercase;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--cyan);
      box-shadow:0 0 0 6px rgba(53,242,255,.12),0 0 18px rgba(53,242,255,.22);
      animation: livePulse 1.6s ease-in-out infinite;
    }
    .dot.mag{background:var(--mag); box-shadow:0 0 0 6px rgba(255,43,214,.12),0 0 18px rgba(255,43,214,.18);}
    @keyframes livePulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.6)}}

    .clocks{padding:16px 18px; display:flex; flex-direction:column; gap:10px; align-items:flex-end;}
    .dateLine{
      font-family: Orbitron, Rajdhani, sans-serif;
      font-size:26px; font-weight:800; letter-spacing:1px; margin:0; color:rgba(200,230,255,.82);
      text-transform:capitalize;
    }
    .timeGrid{display:grid; grid-template-columns: 140px 1fr; gap:10px 14px; width:100%; align-items:baseline;}
    .tLab{text-align:right; font-family: Orbitron, Rajdhani, sans-serif; font-size:16px; font-weight:800; letter-spacing:1px; text-transform:uppercase; color:rgba(200,230,255,.66);}
    .tVal{font-family: Orbitron, Rajdhani, sans-serif; font-size:76px; font-weight:900; line-height:.95;
      text-shadow: 0 0 26px rgba(255,43,214,.12), 0 0 22px rgba(53,242,255,.10);
      font-variant-numeric: tabular-nums;
    }

    /* Main split */
    .main{flex:1; min-height:0; display:grid; grid-template-columns: 1.05fr .95fr; gap:16px;}
    .left{min-height:0; display:flex; flex-direction:column; gap:16px;}
    .right{min-height:0; display:flex; flex-direction:column; gap:16px;}

    /* Current job card */
    .current{padding:18px 18px 16px; background: var(--panel2);}
    .currentHdr{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .currentTitle{
      margin:0;
      font-family: Orbitron, Rajdhani, sans-serif;
      font-size:22px; font-weight:900; letter-spacing:1.4px; text-transform:uppercase;
      color:rgba(200,230,255,.86);
      display:flex; align-items:center; gap:12px;
    }
    .currentTitle .badgeLive{display:inline-flex; align-items:center; gap:10px;}
    .currentBody{margin-top:12px; display:grid; grid-template-columns: 1fr; gap:12px;}
    .prodName{
      font-family: Orbitron, Rajdhani, sans-serif;
      font-size:64px; font-weight:900; letter-spacing:1px;
      text-transform:uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      text-shadow: 0 0 18px rgba(53,242,255,.14);
    }
    .metaRow{display:flex; gap:14px; flex-wrap:wrap; align-items:center;}
    .metaBig{display:flex; gap:18px; align-items:baseline; flex-wrap:wrap;}
    .bigNum{font-family: Orbitron, Rajdhani, sans-serif; font-size:64px; font-weight:900; letter-spacing:1px; text-shadow:0 0 18px rgba(255,230,109,.10); font-variant-numeric:tabular-nums;}
    .bigTxt{font-family: Orbitron, Rajdhani, sans-serif; font-size:30px; font-weight:800; color:rgba(200,230,255,.74);}

    .statusPill{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:12px;
      padding:14px 18px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-family: Orbitron, Rajdhani, sans-serif;
      font-size:28px; font-weight:900; letter-spacing:1px; text-transform:uppercase;
      box-shadow: 0 0 24px rgba(53,242,255,.07);
    }
    .sDot{width:14px;height:14px;border-radius:999px;background:var(--cyan); box-shadow:0 0 0 6px rgba(53,242,255,.14);}
    .sDot.done{background:var(--grn); box-shadow:0 0 0 6px rgba(43,255,136,.12);}
    .sDot.wait{background:var(--yel); box-shadow:0 0 0 6px rgba(255,230,109,.10);}
    .sDot.err{background:var(--red); box-shadow:0 0 0 6px rgba(255,60,104,.10);}

    /* Pulsing "in corso" */
    .inProgressGlow{
      border-color: rgba(53,242,255,.30) !important;
      box-shadow:
        0 0 0 1px rgba(53,242,255,.10),
        0 0 38px rgba(53,242,255,.10),
        0 0 52px rgba(255,43,214,.06),
        var(--shadow);
      animation: progPulse 1.8s ease-in-out infinite;
    }
    @keyframes progPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.15)}}

    /* Progress bar (runtime) */
    .runBarWrap{margin-top:10px; padding:14px 16px; border-radius: 18px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18);}
    .runBarTop{display:flex; justify-content:space-between; align-items:center; gap:12px; color:rgba(200,230,255,.75); font-weight:800; letter-spacing:.6px;}
    .runBarTop span{font-family: Orbitron, Rajdhani, sans-serif; font-size:14px; text-transform:uppercase;}
    .runBar{height:14px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.10);}
    .runFill{height:100%; width:0%; background: linear-gradient(90deg, rgba(53,242,255,.25), rgba(255,43,214,.22), rgba(255,230,109,.18)); box-shadow: 0 0 18px rgba(53,242,255,.10);}

    /* Right table */
    .tableCard{min-height:0; display:flex; flex-direction:column;}
    .tableHdr{padding:16px 18px; border-bottom:1px solid rgba(120,255,255,.14); background: rgba(255,255,255,.03);}
    .tableTitle{
      margin:0;
      font-family: Orbitron, Rajdhani, sans-serif;
      font-size:22px; font-weight:900; letter-spacing:1.4px; text-transform:uppercase;
      color:rgba(200,230,255,.86);
      display:flex; align-items:center; gap:10px;
    }
    .table{width:100%; border-collapse:collapse;}
    .table thead th{
      position:sticky; top:0;
      background: rgba(12,18,34,.92);
      border-bottom:1px solid rgba(120,255,255,.14);
      padding:12px 14px;
      text-align:left;
      font-family: Orbitron, Rajdhani, sans-serif;
      font-size:14px; font-weight:900; letter-spacing:1.1px; text-transform:uppercase;
      color:rgba(200,230,255,.72);
    }
    .table tbody td{
      padding:14px 14px;
      border-bottom:1px solid rgba(120,255,255,.09);
      font-size:20px;
      font-weight:700;
      color:rgba(234,247,255,.90);
      vertical-align:middle;
    }
    .table tbody tr:hover{background: rgba(255,255,255,.03);}
    .rowsWrap{flex:1; min-height:0; overflow:auto;}
    .colProd{font-family: Orbitron, Rajdhani, sans-serif; font-weight:900; letter-spacing:.6px; text-transform:uppercase;}
    .stCell{font-family: Orbitron, Rajdhani, sans-serif; font-size:14px; font-weight:900; letter-spacing:1px; text-transform:uppercase;}
    .stTodo{color: var(--cyan);}
    .stDone{color: var(--grn);}
    .stProg{color: var(--mag);}
    .stOther{color: var(--yel);}

    .rowPulse{position:relative;}
    .rowPulse:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(53,242,255,.00), rgba(53,242,255,.14), rgba(255,43,214,.12), rgba(53,242,255,.00));
      filter: blur(10px);
      opacity:.62;
      transform: translate3d(-60%,0,0);
      animation: sweep 3.4s linear infinite;
      pointer-events:none;
    }
    @keyframes sweep{0%{transform: translate3d(-60%,0,0)}100%{transform: translate3d(60%,0,0)}}

    .footer{padding:14px 18px; color:rgba(200,230,255,.60); font-weight:700; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .footer span{font-family: Orbitron, Rajdhani, sans-serif; font-size:12px; letter-spacing:.9px; text-transform:uppercase;}

    /* LOADING OVERLAY */
    .overlay{
      position:fixed; inset:0; z-index:999;
      background:
        radial-gradient(1000px 800px at 15% 15%, rgba(53,242,255,.14), transparent 55%),
        radial-gradient(1000px 800px at 85% 20%, rgba(255,43,214,.12), transparent 55%),
        linear-gradient(180deg, #04040a, #070b16);
      display:flex; align-items:center; justify-content:center;
      opacity:1; transition: opacity .55s ease;
    }
    .overlay.hidden{opacity:0; pointer-events:none;}
    .bootBox{width:min(980px, 92vw); padding:26px; border-radius: 26px;
      border:1px solid rgba(120,255,255,.20);
      background: rgba(10,14,28,.68);
      box-shadow: 0 0 0 1px rgba(53,242,255,.10), 0 20px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }
    .bootTitle{
      margin:0;
      font-family: Orbitron, Rajdhani, sans-serif;
      font-weight:900;
      font-size:42px;
      letter-spacing:2px;
      text-transform:uppercase;
      text-shadow:0 0 30px rgba(53,242,255,.16);
      display:flex; align-items:center; gap:12px;
    }
    .bootSub{margin:10px 0 18px; color:rgba(200,230,255,.70); font-size:18px; font-weight:700; letter-spacing:.4px;}
    .bootBar{height:18px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);}
    .bootFill{height:100%; width:0%;
      background: linear-gradient(90deg, rgba(53,242,255,.28), rgba(255,43,214,.22), rgba(255,230,109,.20));
      box-shadow: 0 0 18px rgba(53,242,255,.12);
      transition: width .16s linear;
    }
    .bootPct{margin-top:12px; display:flex; justify-content:space-between; align-items:center; font-variant-numeric:tabular-nums;}
    .bootPct span{font-family: Orbitron, Rajdhani, sans-serif; font-size:16px; font-weight:900; letter-spacing:1px; text-transform:uppercase; color:rgba(200,230,255,.75);}
    .bootPct strong{font-family: Orbitron, Rajdhani, sans-serif; font-size:34px; font-weight:900; letter-spacing:1px;}
    .bootHint{margin-top:12px; color:rgba(200,230,255,.55); font-weight:700; font-size:14px;}

    /* kiosk helper: no selection */
    .noSel{user-select:none; -webkit-user-select:none;}
  </style>
</head>

<body class="noSel">

  <!-- BOOT OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="bootBox">
      <div class="bootTitle"><span class="dot"></span>AVVIO SISTEMA</div>
      <div class="bootSub">Avvio sistema in corso… caricamento interfaccia e sincronizzazione dati.</div>

      <div class="bootBar"><div class="bootFill" id="bootFill"></div></div>
      <div class="bootPct">
        <span>BOOT</span>
        <strong id="bootPct">0%</strong>
      </div>
      <div class="bootHint">Suggerimento: per la voce “super qualità”, inserisci un MP3 di ElevenLabs (istruzioni in fondo pagina).</div>
    </div>
  </div>

  <!-- Optional ElevenLabs audio (drop in your own mp3) -->
  <audio id="bootAudio" preload="auto"></audio>

  <div class="app">
    <div class="top">
      <div class="card brand">
        <p class="brandTitle">PRODUZIONE • KIOSK</p>
        <div class="brandSub">
          <span class="pill"><span class="dot"></span>LIVE</span>
          <span class="pill"><span class="dot mag"></span>CYBER UI</span>
          <span class="pill">Aggiornamento: <span id="refreshEvery">20s</span></span>
          <span class="pill">Sorgente: Google Sheet</span>
        </div>
      </div>

      <div class="card clocks">
        <p class="dateLine" id="dateLine">—</p>
        <div class="timeGrid">
          <div class="tLab">ITALIA</div><div class="tVal" id="timeIT">--:--</div>
          <div class="tLab">CINA</div><div class="tVal" id="timeCN">--:--</div>
        </div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT: Current job -->
      <div class="left">
        <div class="card current" id="currentCard">
          <div class="currentHdr">
            <p class="currentTitle">
              <span class="badgeLive"><span class="dot"></span>PRODOTTO IN CORSO</span>
            </p>
            <div class="statusPill" id="statusPill"><span class="sDot wait" id="sDot"></span><span id="curStatus">—</span></div>
          </div>

          <div class="currentBody">
            <div class="prodName" id="curProduct">CARICO…</div>
            <div class="metaRow">
              <div class="metaBig">
                <div class="bigNum" id="curQty">—</div>
                <div class="bigTxt" id="curUnit">pz</div>
              </div>
              <div class="metaBig" style="margin-left:12px">
                <div class="bigTxt" style="opacity:.85">Taglia:</div>
                <div class="bigNum" style="font-size:46px" id="curSize">—</div>
              </div>
            </div>

            <div class="runBarWrap">
              <div class="runBarTop">
                <span>Stato macchina</span>
                <span id="lastUpdate">—</span>
              </div>
              <div class="runBar"><div class="runFill" id="runFill"></div></div>
            </div>
          </div>
        </div>

        <div class="card" style="padding:16px 18px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:14px;flex-wrap:wrap;">
            <div style="font-family:Orbitron, Rajdhani, sans-serif;font-weight:900;letter-spacing:1.2px;text-transform:uppercase;color:rgba(200,230,255,.78);font-size:18px;">
              NOTE RAPIDE
            </div>
            <div style="color:rgba(200,230,255,.62);font-weight:700;font-size:18px;">
              Controllo automatico ogni <span style="font-family:Orbitron, Rajdhani, sans-serif;font-weight:900">20s</span> • Schermo 27" modalità chiosco
            </div>
          </div>
          <div style="margin-top:10px;color:rgba(200,230,255,.66);font-size:18px;font-weight:700;line-height:1.35">
            Se il Wi‑Fi è debole, questa pagina continua a funzionare ma potrebbe mostrare “errore lettura sheet” finché non torna la connessione.
          </div>
        </div>
      </div>

      <!-- RIGHT: Table list -->
      <div class="right">
        <div class="card tableCard">
          <div class="tableHdr">
            <p class="tableTitle"><span class="dot mag"></span>LISTA PRODUZIONI</p>
          </div>

          <div class="rowsWrap">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:46%">Prodotto</th>
                  <th style="width:16%">Taglia</th>
                  <th style="width:14%">Pz</th>
                  <th style="width:24%">Stato</th>
                </tr>
              </thead>
              <tbody id="tbody">
              </tbody>
            </table>
          </div>

          <div class="footer">
            <span id="srcLine">CSV: —</span>
            <span id="buildLine">BUILD: 2025-12-17</span>
          </div>
        </div>

        <div class="card" style="padding:16px 18px">
          <div style="font-family:Orbitron, Rajdhani, sans-serif;font-weight:900;letter-spacing:1.2px;text-transform:uppercase;color:rgba(200,230,255,.78);font-size:18px;">
            VOCE AVVIO
          </div>
          <div style="margin-top:10px;color:rgba(200,230,255,.66);font-size:18px;font-weight:700;line-height:1.35">
            Di default usa la voce del browser (Web Speech). Se vuoi ElevenLabs: genera un MP3 con la frase
            <span style="font-family:Orbitron, Rajdhani, sans-serif;font-weight:900">“Avvio sistema in corso”</span>
            e mettilo nella stessa cartella di questo file come <span style="font-family:Orbitron, Rajdhani, sans-serif;font-weight:900">boot.mp3</span>.
            Poi l’audio partirà automaticamente.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const REFRESH_MS = 20000;
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbRcMc9ZdrJ0o7jCJZfyCeGuGD3pgxurwbxO6NO_2kizrkg0czCQYR3g0YmUyWffgyBkmBdNe9fiB/pub?output=csv"; // columns: prodotto, stato, pz, taglia

  document.getElementById("refreshEvery").textContent = Math.round(REFRESH_MS/1000) + "s";
  document.getElementById("srcLine").textContent = "CSV: " + (SHEET_CSV_URL.length > 60 ? (SHEET_CSV_URL.slice(0,60) + "…") : SHEET_CSV_URL);

  // ========= CLOCKS =========
  function tickClock(){
    const now = new Date();
    document.getElementById("timeIT").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("timeCN").textContent =
      new Intl.DateTimeFormat("zh-CN",{timeZone:"Asia/Shanghai",hour:"2-digit",minute:"2-digit"}).format(now);
    document.getElementById("dateLine").textContent =
      new Intl.DateTimeFormat("it-IT",{timeZone:"Europe/Rome",weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(now);
  }
  tickClock();
  setInterval(tickClock, 1000);

  // ========= CSV PARSER =========
  function parseCSV(text){
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;

    for (let i=0;i<text.length;i++) {
      const ch = text[i];
      if (ch === '"') {
        if (inQ && text[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === "," && !inQ) {
        row.push(cur); cur = "";
      } else if (ch === "\n" && !inQ) {
        row.push(cur); rows.push(row);
        row = []; cur = "";
      } else {
        cur += ch;
      }
    }
    row.push(cur); rows.push(row);
    return rows;
  }

  function normalizeHeader(h){
    return (h||"").trim().toLowerCase()
      .replace(/à/g,"a").replace(/è/g,"e").replace(/é/g,"e").replace(/ì/g,"i").replace(/ò/g,"o").replace(/ù/g,"u");
  }

  async function loadJobs(){
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status + " leggendo CSV");
    const text = await res.text();

    const rows = parseCSV(text).filter(r => r.some(v => (v||"").trim() !== ""));
    if(rows.length <= 1) return [];

    const header = rows[0].map(normalizeHeader);
    const idx = {
      prodotto: header.indexOf("prodotto") !== -1 ? header.indexOf("prodotto") : (header.indexOf("product") !== -1 ? header.indexOf("product") : 0),
      stato: header.indexOf("stato") !== -1 ? header.indexOf("stato") : (header.indexOf("status") !== -1 ? header.indexOf("status") : 1),
      pz: header.indexOf("pz") !== -1 ? header.indexOf("pz") : (header.indexOf("qty") !== -1 ? header.indexOf("qty") : 2),
      taglia: header.indexOf("taglia") !== -1 ? header.indexOf("taglia") : (header.indexOf("format") !== -1 ? header.indexOf("format") : 3),
    };

    const jobs = [];
    for(let i=1;i<rows.length;i++) {
      const r = rows[i];
      const job = {
        prodotto: (r[idx.prodotto] ?? "").trim(),
        stato: (r[idx.stato] ?? "").trim(),
        pz: (r[idx.pz] ?? "").trim(),
        taglia: (r[idx.taglia] ?? "").trim(),
      };
      if(!(job.prodotto || job.stato || job.pz || job.taglia)) continue;
      jobs.push(job);
    }
    return jobs;
  }

  // ========= JOB PICKING =========
  function classifyStatus(st){
    const s = (st||"").toLowerCase();
    if (s.includes("in corso") || s.includes("in_corso") || s.includes("working") || s.includes("run")) return "prog";
    if (s.includes("finito") || s.includes("complet") || s.includes("done") || s.includes("ok")) return "done";
    if (s.includes("da") || s.includes("todo") || s.includes("fare") || s.includes("prod")) return "todo";
    if (s.includes("erro") || s.includes("alarm") || s.includes("blocc")) return "err";
    return "other";
  }

  function pickCurrent(jobs){
    if(!jobs.length) return null;
    let j = jobs.find(x => classifyStatus(x.stato) === "prog");
    if(j) return j;
    j = jobs.find(x => classifyStatus(x.stato) === "todo");
    if(j) return j;
    return jobs[0];
  }

  // ========= RENDER =========
  const tbody = document.getElementById("tbody");
  const currentCard = document.getElementById("currentCard");

  function setCurrent(job){
    const prod = job?.prodotto || "Nessun dato";
    const pz = job?.pz || "—";
    const taglia = job?.taglia || "—";
    const stato = job?.stato || "CONTROLLA SHEET";
    const cls = classifyStatus(stato);

    document.getElementById("curProduct").textContent = prod;
    document.getElementById("curQty").textContent = pz;
    document.getElementById("curUnit").textContent = "pz";
    document.getElementById("curSize").textContent = taglia;
    document.getElementById("curStatus").textContent = stato;

    const sDot = document.getElementById("sDot");
    sDot.className = "sDot";
    currentCard.classList.remove("inProgressGlow");
    if(cls === "done") sDot.classList.add("done");
    else if(cls === "prog") { sDot.classList.add("wait"); currentCard.classList.add("inProgressGlow"); }
    else if(cls === "todo") sDot.classList.add("wait");
    else if(cls === "err") sDot.classList.add("err");
    else sDot.classList.add("wait");

    const fill = document.getElementById("runFill");
    fill.style.transition = "none";
    fill.style.width = "0%";
    requestAnimationFrame(() => {
      fill.style.transition = "width 18s linear";
      fill.style.width = "100%";
    });
  }

  function renderTable(jobs, current){
    tbody.innerHTML = "";
    if(!jobs.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="colProd">Nessun dato</td><td>—</td><td>—</td><td class="stCell stTodo">CONTROLLA SHEET</td>`;
      tbody.appendChild(tr);
      return;
    }

    for(const j of jobs){
      const cls = classifyStatus(j.stato);
      const tr = document.createElement("tr");
      if(current && j === current && (cls === "prog" || cls === "todo")) tr.classList.add("rowPulse");

      let stClass = "stOther";
      if(cls === "todo") stClass = "stTodo";
      else if(cls === "done") stClass = "stDone";
      else if(cls === "prog") stClass = "stProg";
      else if(cls === "err") stClass = "stOther";

      tr.innerHTML = `
        <td class="colProd">${escapeHtml(j.prodotto)}</td>
        <td>${escapeHtml(j.taglia)}</td>
        <td style="font-family:Orbitron, Rajdhani, sans-serif;font-weight:900;font-variant-numeric:tabular-nums;">${escapeHtml(j.pz)}</td>
        <td class="stCell ${stClass}">${escapeHtml(j.stato)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ========= BOOT OVERLAY + VOICE =========
  const overlay = document.getElementById("overlay");
  const bootFill = document.getElementById("bootFill");
  const bootPctEl = document.getElementById("bootPct");
  const bootAudio = document.getElementById("bootAudio");

  let dataReady = false;
  let bootPct = 0;

  async function playBootVoice(){
    try {
      bootAudio.src = "boot.mp3?t=" + Date.now();
      await bootAudio.play();
      return;
    } catch(e) {
      // fallback TTS
    }

    try {
      if(!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance("Avvio sistema in corso");
      u.lang = "it-IT";
      u.rate = 0.95;
      u.pitch = 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch(e) {}
  }

  function bootStep(){
    const target = dataReady ? 100 : 99;
    if(bootPct < target) bootPct = Math.min(target, bootPct + 1);

    bootFill.style.width = bootPct + "%";
    bootPctEl.textContent = bootPct + "%";

    if(bootPct >= 100){
      overlay.classList.add("hidden");
      setTimeout(() => overlay.remove(), 700);
      return;
    }
    setTimeout(bootStep, 55);
  }

  // ========= REFRESH LOOP =========
  let inFlight = false;
  async function refresh(){
    if(inFlight) return;
    inFlight = true;
    try {
      const jobs = await loadJobs();
      const cur = pickCurrent(jobs);
      setCurrent(cur);
      renderTable(jobs, cur);

      document.getElementById("lastUpdate").textContent =
        "Agg. " + new Date().toLocaleTimeString("it-IT", {hour:"2-digit",minute:"2-digit",second:"2-digit"});
      dataReady = true;
    } catch(e) {
      const errJob = { prodotto:"Errore lettura sheet", stato:(e && e.message ? e.message : String(e)), pz:"—", taglia:"—" };
      setCurrent(errJob);
      renderTable([errJob], errJob);

      document.getElementById("lastUpdate").textContent =
        "Errore • " + new Date().toLocaleTimeString("it-IT", {hour:"2-digit",minute:"2-digit",second:"2-digit"});
      dataReady = true;
    } finally {
      inFlight = false;
    }
  }

  // Start
  playBootVoice();
  bootStep();
  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
